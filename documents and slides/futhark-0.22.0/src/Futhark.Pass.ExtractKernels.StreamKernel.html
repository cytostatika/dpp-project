<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Pass.ExtractKernels.StreamKernel</span><span>
</span><span id="line-6"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#segThreadCapped"><span class="hs-identifier">segThreadCapped</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-7"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#streamRed"><span class="hs-identifier">streamRed</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-8"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#streamMap"><span class="hs-identifier">streamMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">where</span><span>
</span><span id="line-11"></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Writer</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html"><span class="hs-identifier">Futhark.Analysis.PrimExp</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.html"><span class="hs-identifier">Futhark.IR</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html"><span class="hs-identifier">Futhark.IR.GPU</span></a></span><span> </span><span class="hs-keyword">hiding</span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier">BasicOp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier">Body</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier">Exp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier">FParam</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier">FunDef</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier">LParam</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier">Lambda</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier">Pat</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier">PatElem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier">Prog</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#RetType"><span class="hs-identifier">RetType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier">Stm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html"><span class="hs-identifier">Futhark.MonadFreshNames</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.BlockedKernel</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.ToGPU.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.ToGPU</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Tools.html"><span class="hs-identifier">Futhark.Tools</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">quot</span></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-keyword">data</span><span> </span><span id="KernelSize"><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#KernelSize"><span class="hs-identifier hs-var">KernelSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="KernelSize"><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#KernelSize"><span class="hs-identifier hs-var">KernelSize</span></a></span></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | Int64</span><span>
</span><span id="line-39"></span><span>    </span><span id="kernelElementsPerThread"><span class="annot"><span class="annottext">KernelSize -&gt; SubExp
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#kernelElementsPerThread"><span class="hs-identifier hs-var hs-var">kernelElementsPerThread</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-comment">-- | Int32</span><span>
</span><span id="line-41"></span><span>    </span><span id="kernelNumThreads"><span class="annot"><span class="annottext">KernelSize -&gt; SubExp
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#kernelNumThreads"><span class="hs-identifier hs-var hs-var">kernelNumThreads</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684420908"><span id="local-6989586621684420913"><span class="annot"><span class="annottext">KernelSize -&gt; KernelSize -&gt; Bool
(KernelSize -&gt; KernelSize -&gt; Bool)
-&gt; (KernelSize -&gt; KernelSize -&gt; Bool) -&gt; Eq KernelSize
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: KernelSize -&gt; KernelSize -&gt; Bool
$c/= :: KernelSize -&gt; KernelSize -&gt; Bool
== :: KernelSize -&gt; KernelSize -&gt; Bool
$c== :: KernelSize -&gt; KernelSize -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420883"><span id="local-6989586621684420885"><span id="local-6989586621684420888"><span id="local-6989586621684420891"><span id="local-6989586621684420894"><span id="local-6989586621684420898"><span id="local-6989586621684420903"><span class="annot"><span class="annottext">Eq KernelSize
Eq KernelSize
-&gt; (KernelSize -&gt; KernelSize -&gt; Ordering)
-&gt; (KernelSize -&gt; KernelSize -&gt; Bool)
-&gt; (KernelSize -&gt; KernelSize -&gt; Bool)
-&gt; (KernelSize -&gt; KernelSize -&gt; Bool)
-&gt; (KernelSize -&gt; KernelSize -&gt; Bool)
-&gt; (KernelSize -&gt; KernelSize -&gt; KernelSize)
-&gt; (KernelSize -&gt; KernelSize -&gt; KernelSize)
-&gt; Ord KernelSize
KernelSize -&gt; KernelSize -&gt; Bool
KernelSize -&gt; KernelSize -&gt; Ordering
KernelSize -&gt; KernelSize -&gt; KernelSize
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: KernelSize -&gt; KernelSize -&gt; KernelSize
$cmin :: KernelSize -&gt; KernelSize -&gt; KernelSize
max :: KernelSize -&gt; KernelSize -&gt; KernelSize
$cmax :: KernelSize -&gt; KernelSize -&gt; KernelSize
&gt;= :: KernelSize -&gt; KernelSize -&gt; Bool
$c&gt;= :: KernelSize -&gt; KernelSize -&gt; Bool
&gt; :: KernelSize -&gt; KernelSize -&gt; Bool
$c&gt; :: KernelSize -&gt; KernelSize -&gt; Bool
&lt;= :: KernelSize -&gt; KernelSize -&gt; Bool
$c&lt;= :: KernelSize -&gt; KernelSize -&gt; Bool
&lt; :: KernelSize -&gt; KernelSize -&gt; Bool
$c&lt; :: KernelSize -&gt; KernelSize -&gt; Bool
compare :: KernelSize -&gt; KernelSize -&gt; Ordering
$ccompare :: KernelSize -&gt; KernelSize -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420871"><span id="local-6989586621684420873"><span id="local-6989586621684420880"><span class="annot"><span class="annottext">Int -&gt; KernelSize -&gt; ShowS
[KernelSize] -&gt; ShowS
KernelSize -&gt; String
(Int -&gt; KernelSize -&gt; ShowS)
-&gt; (KernelSize -&gt; String)
-&gt; ([KernelSize] -&gt; ShowS)
-&gt; Show KernelSize
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [KernelSize] -&gt; ShowS
$cshowList :: [KernelSize] -&gt; ShowS
show :: KernelSize -&gt; String
$cshow :: KernelSize -&gt; String
showsPrec :: Int -&gt; KernelSize -&gt; ShowS
$cshowsPrec :: Int -&gt; KernelSize -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span id="local-6989586621684421179"><span id="local-6989586621684421183"><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#numberOfGroups"><span class="hs-identifier hs-type">numberOfGroups</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421183"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421183"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#HostOp"><span class="hs-identifier hs-type">HostOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421183"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684421179"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-47"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-48"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-49"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-50"></span><span>  </span><span class="annot"><a href="#local-6989586621684421183"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-51"></span><span id="numberOfGroups"><span class="annot"><span class="annottext">numberOfGroups :: forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ HostOp (Rep m) inner) =&gt;
String -&gt; SubExp -&gt; SubExp -&gt; m (SubExp, SubExp)
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#numberOfGroups"><span class="hs-identifier hs-var hs-var">numberOfGroups</span></a></span></span><span> </span><span id="local-6989586621684420844"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684420844"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684420843"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420843"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684420842"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420842"><span class="hs-identifier hs-var">group_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-52"></span><span>  </span><span id="local-6989586621684420841"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684420841"><span class="hs-identifier hs-var">max_num_groups_key</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; (VName -&gt; String) -&gt; VName -&gt; Name
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Name) -&gt; m VName -&gt; m Name
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684420844"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_num_groups&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>  </span><span id="local-6989586621684420835"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420835"><span class="hs-identifier hs-var">num_groups</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-54"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_groups&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m SubExp) -&gt; Exp (Rep m) -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-55"></span><span>      </span><span class="annot"><span class="annottext">Op (Rep m) -&gt; Exp (Rep m)
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op (Rep m) -&gt; Exp (Rep m)) -&gt; Op (Rep m) -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SizeOp -&gt; HostOp (Rep m) inner
forall rep op. SizeOp -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SizeOp"><span class="hs-identifier hs-var">SizeOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SizeOp -&gt; HostOp (Rep m) inner) -&gt; SizeOp -&gt; HostOp (Rep m) inner
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Name -&gt; SubExp -&gt; SizeOp
</span><a href="Futhark.IR.GPU.Op.html#CalcNumGroups"><span class="hs-identifier hs-var">CalcNumGroups</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420843"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684420841"><span class="hs-identifier hs-var">max_num_groups_key</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420842"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-56"></span><span>  </span><span id="local-6989586621684420830"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420830"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_threads&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m SubExp) -&gt; Exp (Rep m) -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-58"></span><span>      </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Mul"><span class="hs-identifier hs-var">Mul</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420835"><span class="hs-identifier hs-var">num_groups</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420842"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-59"></span><span>  </span><span class="annot"><span class="annottext">(SubExp, SubExp) -&gt; m (SubExp, SubExp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420835"><span class="hs-identifier hs-var">num_groups</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420830"><span class="hs-identifier hs-var">num_threads</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span id="local-6989586621684421143"><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#blockedKernelSize"><span class="hs-identifier hs-type">blockedKernelSize</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-62"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421143"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421143"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-63"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-65"></span><span>  </span><span class="annot"><a href="#local-6989586621684421143"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#KernelSize"><span class="hs-identifier hs-type">KernelSize</span></a></span></span><span>
</span><span id="line-66"></span><span id="blockedKernelSize"><span class="annot"><span class="annottext">blockedKernelSize :: forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ GPU) =&gt;
String -&gt; SubExp -&gt; m KernelSize
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#blockedKernelSize"><span class="hs-identifier hs-var hs-var">blockedKernelSize</span></a></span></span><span> </span><span id="local-6989586621684420802"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684420802"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684420801"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420801"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-67"></span><span>  </span><span id="local-6989586621684420800"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420800"><span class="hs-identifier hs-var">group_size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; SizeClass -&gt; m SubExp
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ HostOp (Rep m) inner) =&gt;
String -&gt; SizeClass -&gt; m SubExp
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#getSize"><span class="hs-identifier hs-var">getSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684420802"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_group_size&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="Futhark.IR.GPU.Sizes.html#SizeGroup"><span class="hs-identifier hs-var">SizeGroup</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420797"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420797"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; SubExp -&gt; SubExp -&gt; m (SubExp, SubExp)
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ HostOp (Rep m) inner) =&gt;
String -&gt; SubExp -&gt; SubExp -&gt; m (SubExp, SubExp)
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#numberOfGroups"><span class="hs-identifier hs-var">numberOfGroups</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684420802"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420801"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420800"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span>  </span><span id="local-6989586621684420796"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420796"><span class="hs-identifier hs-var">per_thread_elements</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-72"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;per_thread_elements&quot;</span></span><span>
</span><span id="line-73"></span><span>      </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; m SubExp) -&gt; m (ExpT GPU) -&gt; m SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
BinOp -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eBinOp"><span class="hs-identifier hs-var">eBinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Safety -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SDivUp"><span class="hs-identifier hs-var">SDivUp</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Unsafe"><span class="hs-identifier hs-var">Unsafe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; m (Exp (Rep m))
forall (m :: * -&gt; *). MonadBuilder m =&gt; SubExp -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eSubExp"><span class="hs-identifier hs-var">eSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420801"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; m (Exp (Rep m))
forall (m :: * -&gt; *). MonadBuilder m =&gt; SubExp -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eSubExp"><span class="hs-identifier hs-var">eSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420797"><span class="hs-identifier hs-var">num_threads</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span>  </span><span class="annot"><span class="annottext">KernelSize -&gt; m KernelSize
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(KernelSize -&gt; m KernelSize) -&gt; KernelSize -&gt; m KernelSize
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; KernelSize
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#KernelSize"><span class="hs-identifier hs-var">KernelSize</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420796"><span class="hs-identifier hs-var">per_thread_elements</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420797"><span class="hs-identifier hs-var">num_threads</span></a></span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span id="local-6989586621684421130"><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#splitArrays"><span class="hs-identifier hs-type">splitArrays</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421130"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421130"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-79"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-81"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SplitOrdering"><span class="hs-identifier hs-type">SplitOrdering</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-82"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-83"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-84"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><a href="#local-6989586621684421130"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-87"></span><span id="splitArrays"><span class="annot"><span class="annottext">splitArrays :: forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ GPU) =&gt;
VName
-&gt; [VName]
-&gt; SplitOrdering
-&gt; SubExp
-&gt; SubExp
-&gt; SubExp
-&gt; [VName]
-&gt; m ()
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#splitArrays"><span class="hs-identifier hs-var hs-var">splitArrays</span></a></span></span><span> </span><span id="local-6989586621684420760"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420760"><span class="hs-identifier hs-var">chunk_size</span></a></span></span><span> </span><span id="local-6989586621684420759"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684420759"><span class="hs-identifier hs-var">split_bound</span></a></span></span><span> </span><span id="local-6989586621684420758"><span class="annot"><span class="annottext">SplitOrdering
</span><a href="#local-6989586621684420758"><span class="hs-identifier hs-var">ordering</span></a></span></span><span> </span><span id="local-6989586621684420757"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420757"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684420756"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420756"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684420755"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420755"><span class="hs-identifier hs-var">elems_per_i</span></a></span></span><span> </span><span id="local-6989586621684420754"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684420754"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-88"></span><span>  </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep m) -&gt; m ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420760"><span class="hs-identifier hs-var">chunk_size</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m ()) -&gt; Exp (Rep m) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op GPU -&gt; ExpT GPU
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op GPU -&gt; ExpT GPU) -&gt; Op GPU -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SizeOp -&gt; HostOp GPU (SOAC GPU)
forall rep op. SizeOp -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SizeOp"><span class="hs-identifier hs-var">SizeOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SizeOp -&gt; HostOp GPU (SOAC GPU))
-&gt; SizeOp -&gt; HostOp GPU (SOAC GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SplitOrdering -&gt; SubExp -&gt; SubExp -&gt; SubExp -&gt; SizeOp
</span><a href="Futhark.IR.GPU.Op.html#SplitSpace"><span class="hs-identifier hs-var">SplitSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOrdering
</span><a href="#local-6989586621684420758"><span class="hs-identifier hs-var">ordering</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420757"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420756"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420755"><span class="hs-identifier hs-var">elems_per_i</span></a></span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SplitOrdering
</span><a href="#local-6989586621684420758"><span class="hs-identifier hs-var">ordering</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><span class="annottext">SplitOrdering
</span><a href="Futhark.IR.SegOp.html#SplitContiguous"><span class="hs-identifier hs-var">SplitContiguous</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-91"></span><span>      </span><span id="local-6989586621684420750"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420750"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;slice_offset&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m SubExp) -&gt; Exp (Rep m) -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Mul"><span class="hs-identifier hs-var">Mul</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420756"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420755"><span class="hs-identifier hs-var">elems_per_i</span></a></span><span>
</span><span id="line-92"></span><span>      </span><span class="annot"><span class="annottext">(VName -&gt; VName -&gt; m ()) -&gt; [VName] -&gt; [VName] -&gt; m ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; VName -&gt; m ()
</span><a href="#local-6989586621684420748"><span class="hs-identifier hs-var">contiguousSlice</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420750"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684420759"><span class="hs-identifier hs-var">split_bound</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684420754"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="annot"><a href="Futhark.IR.SegOp.html#SplitStrided"><span class="hs-identifier hs-type">SplitStrided</span></a></span><span> </span><span id="local-6989586621684420746"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420746"><span class="hs-identifier hs-var">stride</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; VName -&gt; m ()) -&gt; [VName] -&gt; [VName] -&gt; m ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; VName -&gt; m ()
</span><a href="#local-6989586621684420745"><span class="hs-identifier hs-var">stridedSlice</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420746"><span class="hs-identifier hs-var">stride</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684420759"><span class="hs-identifier hs-var">split_bound</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684420754"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-95"></span><span>    </span><span id="local-6989586621684420748"><span class="annot"><span class="annottext">contiguousSlice :: SubExp -&gt; VName -&gt; VName -&gt; m ()
</span><a href="#local-6989586621684420748"><span class="hs-identifier hs-var hs-var">contiguousSlice</span></a></span></span><span> </span><span id="local-6989586621684420744"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420744"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span id="local-6989586621684420743"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420743"><span class="hs-identifier hs-var">slice_name</span></a></span></span><span> </span><span id="local-6989586621684420742"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420742"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-96"></span><span>      </span><span id="local-6989586621684420741"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684420741"><span class="hs-identifier hs-var">arr_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420742"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-97"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684420739"><span class="annot"><span class="annottext">slice :: Slice SubExp
</span><a href="#local-6989586621684420739"><span class="hs-identifier hs-var hs-var">slice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [DimIndex SubExp] -&gt; Slice SubExp
</span><a href="Futhark.Construct.html#fullSlice"><span class="hs-identifier hs-var">fullSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684420741"><span class="hs-identifier hs-var">arr_t</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp -&gt; DimIndex SubExp
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420744"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420760"><span class="hs-identifier hs-var">chunk_size</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64 -&gt; SubExp
forall v. IsValue v =&gt; v -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#constant"><span class="hs-identifier hs-var">constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-98"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep m) -&gt; m ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420743"><span class="hs-identifier hs-var">slice_name</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m ()) -&gt; Exp (Rep m) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420742"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684420739"><span class="hs-identifier hs-var">slice</span></a></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span>    </span><span id="local-6989586621684420745"><span class="annot"><span class="annottext">stridedSlice :: SubExp -&gt; VName -&gt; VName -&gt; m ()
</span><a href="#local-6989586621684420745"><span class="hs-identifier hs-var hs-var">stridedSlice</span></a></span></span><span> </span><span id="local-6989586621684420733"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420733"><span class="hs-identifier hs-var">stride</span></a></span></span><span> </span><span id="local-6989586621684420732"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420732"><span class="hs-identifier hs-var">slice_name</span></a></span></span><span> </span><span id="local-6989586621684420731"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420731"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-101"></span><span>      </span><span id="local-6989586621684420730"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684420730"><span class="hs-identifier hs-var">arr_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420731"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-102"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684420729"><span class="annot"><span class="annottext">slice :: Slice SubExp
</span><a href="#local-6989586621684420729"><span class="hs-identifier hs-var hs-var">slice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [DimIndex SubExp] -&gt; Slice SubExp
</span><a href="Futhark.Construct.html#fullSlice"><span class="hs-identifier hs-var">fullSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684420730"><span class="hs-identifier hs-var">arr_t</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp -&gt; DimIndex SubExp
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420756"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420760"><span class="hs-identifier hs-var">chunk_size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420733"><span class="hs-identifier hs-var">stride</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-103"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep m) -&gt; m ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420732"><span class="hs-identifier hs-var">slice_name</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m ()) -&gt; Exp (Rep m) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420731"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684420729"><span class="hs-identifier hs-var">slice</span></a></span><span>
</span><span id="line-104"></span><span>
</span><span id="line-105"></span><span id="local-6989586621684421110"><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#partitionChunkedKernelFoldParameters"><span class="hs-identifier hs-type">partitionChunkedKernelFoldParameters</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-106"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-107"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421110"><span class="hs-identifier hs-type">dec</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421110"><span class="hs-identifier hs-type">dec</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421110"><span class="hs-identifier hs-type">dec</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421110"><span class="hs-identifier hs-type">dec</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-109"></span><span id="partitionChunkedKernelFoldParameters"><span class="annot"><span class="annottext">partitionChunkedKernelFoldParameters :: forall dec.
Int -&gt; [Param dec] -&gt; (VName, Param dec, [Param dec], [Param dec])
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#partitionChunkedKernelFoldParameters"><span class="hs-identifier hs-var hs-var">partitionChunkedKernelFoldParameters</span></a></span></span><span> </span><span id="local-6989586621684420725"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684420725"><span class="hs-identifier hs-var">num_accs</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684420724"><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684420724"><span class="hs-identifier hs-var">i_param</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684420723"><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684420723"><span class="hs-identifier hs-var">chunk_param</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684420722"><span class="annot"><span class="annottext">[Param dec]
</span><a href="#local-6989586621684420722"><span class="hs-identifier hs-var">params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684420721"><span class="annot"><span class="annottext">[Param dec]
</span><a href="#local-6989586621684420721"><span class="hs-identifier hs-var">acc_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420720"><span class="annot"><span class="annottext">[Param dec]
</span><a href="#local-6989586621684420720"><span class="hs-identifier hs-var">arr_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param dec] -&gt; ([Param dec], [Param dec])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684420725"><span class="hs-identifier hs-var">num_accs</span></a></span><span> </span><span class="annot"><span class="annottext">[Param dec]
</span><a href="#local-6989586621684420722"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-111"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param dec -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684420724"><span class="hs-identifier hs-var">i_param</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684420723"><span class="hs-identifier hs-var">chunk_param</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Param dec]
</span><a href="#local-6989586621684420721"><span class="hs-identifier hs-var">acc_params</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Param dec]
</span><a href="#local-6989586621684420720"><span class="hs-identifier hs-var">arr_params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#partitionChunkedKernelFoldParameters"><span class="hs-identifier hs-var">partitionChunkedKernelFoldParameters</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Param dec]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-113"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; (VName, Param dec, [Param dec], [Param dec])
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;partitionChunkedKernelFoldParameters: lambda takes too few parameters&quot;</span></span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span id="local-6989586621684421102"><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#blockedPerThread"><span class="hs-identifier hs-type">blockedPerThread</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421102"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421102"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-117"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-118"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-119"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#KernelSize"><span class="hs-identifier hs-type">KernelSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-120"></span><span>  </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#StreamOrd"><span class="hs-identifier hs-type">StreamOrd</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-121"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421102"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-122"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-124"></span><span>  </span><span class="annot"><a href="#local-6989586621684421102"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#PatElemT"><span class="hs-identifier hs-type">PatElemT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#PatElemT"><span class="hs-identifier hs-type">PatElemT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-125"></span><span id="blockedPerThread"><span class="annot"><span class="annottext">blockedPerThread :: forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ GPU) =&gt;
VName
-&gt; SubExp
-&gt; KernelSize
-&gt; StreamOrd
-&gt; Lambda (Rep m)
-&gt; Int
-&gt; [VName]
-&gt; m ([PatElemT Type], [PatElemT Type])
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#blockedPerThread"><span class="hs-identifier hs-var hs-var">blockedPerThread</span></a></span></span><span> </span><span id="local-6989586621684420681"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420681"><span class="hs-identifier hs-var">thread_gtid</span></a></span></span><span> </span><span id="local-6989586621684420680"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420680"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684420679"><span class="annot"><span class="annottext">KernelSize
</span><a href="#local-6989586621684420679"><span class="hs-identifier hs-var">kernel_size</span></a></span></span><span> </span><span id="local-6989586621684420678"><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684420678"><span class="hs-identifier hs-var">ordering</span></a></span></span><span> </span><span id="local-6989586621684420677"><span class="annot"><span class="annottext">Lambda (Rep m)
</span><a href="#local-6989586621684420677"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684420676"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684420676"><span class="hs-identifier hs-var">num_nonconcat</span></a></span></span><span> </span><span id="local-6989586621684420675"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684420675"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420674"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684420674"><span class="hs-identifier hs-var">chunk_size</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420673"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684420673"><span class="hs-identifier hs-var">arr_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-127"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; [Param Type] -&gt; (VName, Param Type, [Param Type], [Param Type])
forall dec.
Int -&gt; [Param dec] -&gt; (VName, Param dec, [Param dec], [Param dec])
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#partitionChunkedKernelFoldParameters"><span class="hs-identifier hs-var">partitionChunkedKernelFoldParameters</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">([Param Type] -&gt; (VName, Param Type, [Param Type], [Param Type]))
-&gt; [Param Type] -&gt; (VName, Param Type, [Param Type], [Param Type])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU -&gt; [LParam GPU]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Rep m)
LambdaT GPU
</span><a href="#local-6989586621684420677"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span>      </span><span id="local-6989586621684420671"><span class="annot"><span class="annottext">ordering' :: SplitOrdering
</span><a href="#local-6989586621684420671"><span class="hs-identifier hs-var hs-var">ordering'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-130"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684420678"><span class="hs-identifier hs-var">ordering</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-131"></span><span>          </span><span class="annot"><span class="annottext">StreamOrd
</span><a href="Futhark.IR.SOACS.SOAC.html#InOrder"><span class="hs-identifier hs-var">InOrder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplitOrdering
</span><a href="Futhark.IR.SegOp.html#SplitContiguous"><span class="hs-identifier hs-var">SplitContiguous</span></a></span><span>
</span><span id="line-132"></span><span>          </span><span class="annot"><span class="annottext">StreamOrd
</span><a href="Futhark.IR.SOACS.SOAC.html#Disorder"><span class="hs-identifier hs-var">Disorder</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SplitOrdering
</span><a href="Futhark.IR.SegOp.html#SplitStrided"><span class="hs-identifier hs-var">SplitStrided</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SplitOrdering) -&gt; SubExp -&gt; SplitOrdering
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelSize -&gt; SubExp
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#kernelNumThreads"><span class="hs-identifier hs-var hs-var">kernelNumThreads</span></a></span><span> </span><span class="annot"><span class="annottext">KernelSize
</span><a href="#local-6989586621684420679"><span class="hs-identifier hs-var">kernel_size</span></a></span><span>
</span><span id="line-133"></span><span>      </span><span id="local-6989586621684420668"><span class="annot"><span class="annottext">red_ts :: [Type]
</span><a href="#local-6989586621684420668"><span class="hs-identifier hs-var hs-var">red_ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Type] -&gt; [Type]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684420676"><span class="hs-identifier hs-var">num_nonconcat</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [Type]) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Rep m)
LambdaT GPU
</span><a href="#local-6989586621684420677"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-134"></span><span>      </span><span id="local-6989586621684420665"><span class="annot"><span class="annottext">map_ts :: [Type]
</span><a href="#local-6989586621684420665"><span class="hs-identifier hs-var hs-var">map_ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall u.
TypeBase (ShapeBase SubExp) u -&gt; TypeBase (ShapeBase SubExp) u
</span><a href="Futhark.IR.Prop.Types.html#rowType"><span class="hs-identifier hs-var">rowType</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [Type]) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Type] -&gt; [Type]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684420676"><span class="hs-identifier hs-var">num_nonconcat</span></a></span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; [Type]) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Rep m)
LambdaT GPU
</span><a href="#local-6989586621684420677"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>  </span><span id="local-6989586621684420662"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420662"><span class="hs-identifier hs-var">per_thread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IntType -&gt; SubExp -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
IntType -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.Construct.html#asIntS"><span class="hs-identifier hs-var">asIntS</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; m SubExp) -&gt; SubExp -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelSize -&gt; SubExp
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#kernelElementsPerThread"><span class="hs-identifier hs-var hs-var">kernelElementsPerThread</span></a></span><span> </span><span class="annot"><span class="annottext">KernelSize
</span><a href="#local-6989586621684420679"><span class="hs-identifier hs-var">kernel_size</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; [VName]
-&gt; SplitOrdering
-&gt; SubExp
-&gt; SubExp
-&gt; SubExp
-&gt; [VName]
-&gt; m ()
forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ GPU) =&gt;
VName
-&gt; [VName]
-&gt; SplitOrdering
-&gt; SubExp
-&gt; SubExp
-&gt; SubExp
-&gt; [VName]
-&gt; m ()
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#splitArrays"><span class="hs-identifier hs-var">splitArrays</span></a></span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684420674"><span class="hs-identifier hs-var">chunk_size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Param Type -&gt; VName) -&gt; [Param Type] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684420673"><span class="hs-identifier hs-var">arr_params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><span class="annottext">SplitOrdering
</span><a href="#local-6989586621684420671"><span class="hs-identifier hs-var">ordering'</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420680"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420681"><span class="hs-identifier hs-var">thread_gtid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420662"><span class="hs-identifier hs-var">per_thread</span></a></span><span>
</span><span id="line-144"></span><span>    </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684420675"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span>  </span><span id="local-6989586621684420660"><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420660"><span class="hs-identifier hs-var">chunk_red_pes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; (Type -&gt; m (PatElemT Type)) -&gt; m [PatElemT Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684420668"><span class="hs-identifier hs-var">red_ts</span></a></span><span> </span><span class="annot"><span class="annottext">((Type -&gt; m (PatElemT Type)) -&gt; m [PatElemT Type])
-&gt; (Type -&gt; m (PatElemT Type)) -&gt; m [PatElemT Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684420658"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684420658"><span class="hs-identifier hs-var">red_t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>    </span><span id="local-6989586621684420657"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420657"><span class="hs-identifier hs-var">pe_name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;chunk_fold_red&quot;</span></span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><span class="annottext">PatElemT Type -&gt; m (PatElemT Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT Type -&gt; m (PatElemT Type))
-&gt; PatElemT Type -&gt; m (PatElemT Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; PatElemT Type
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420657"><span class="hs-identifier hs-var">pe_name</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684420658"><span class="hs-identifier hs-var">red_t</span></a></span><span>
</span><span id="line-149"></span><span>  </span><span id="local-6989586621684420656"><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420656"><span class="hs-identifier hs-var">chunk_map_pes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; (Type -&gt; m (PatElemT Type)) -&gt; m [PatElemT Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684420665"><span class="hs-identifier hs-var">map_ts</span></a></span><span> </span><span class="annot"><span class="annottext">((Type -&gt; m (PatElemT Type)) -&gt; m [PatElemT Type])
-&gt; (Type -&gt; m (PatElemT Type)) -&gt; m [PatElemT Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684420655"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684420655"><span class="hs-identifier hs-var">map_t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-150"></span><span>    </span><span id="local-6989586621684420654"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420654"><span class="hs-identifier hs-var">pe_name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;chunk_fold_map&quot;</span></span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><span class="annottext">PatElemT Type -&gt; m (PatElemT Type)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT Type -&gt; m (PatElemT Type))
-&gt; PatElemT Type -&gt; m (PatElemT Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; PatElemT Type
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420654"><span class="hs-identifier hs-var">pe_name</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; PatElemT Type) -&gt; Type -&gt; PatElemT Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684420655"><span class="hs-identifier hs-var">map_t</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SubExp -&gt; Type
forall d.
ArrayShape (ShapeBase d) =&gt;
TypeBase (ShapeBase d) NoUniqueness
-&gt; d -&gt; TypeBase (ShapeBase d) NoUniqueness
</span><a href="Futhark.IR.Prop.Types.html#arrayOfRow"><span class="hs-operator hs-var">`arrayOfRow`</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684420674"><span class="hs-identifier hs-var">chunk_size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684420652"><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684420652"><span class="hs-identifier hs-var">chunk_red_ses</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420651"><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684420651"><span class="hs-identifier hs-var">chunk_map_ses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-154"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; [SubExpRes] -&gt; ([SubExpRes], [SubExpRes])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684420676"><span class="hs-identifier hs-var">num_nonconcat</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; ([SubExpRes], [SubExpRes]))
-&gt; [SubExpRes] -&gt; ([SubExpRes], [SubExpRes])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT GPU -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT GPU -&gt; [SubExpRes]) -&gt; BodyT GPU -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU -&gt; BodyT GPU
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Rep m)
LambdaT GPU
</span><a href="#local-6989586621684420677"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><span class="annottext">Stms (Rep m) -&gt; m ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms (Rep m) -&gt; m ()) -&gt; Stms (Rep m) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-157"></span><span>    </span><span class="annot"><span class="annottext">BodyT GPU -&gt; Stms GPU
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT GPU -&gt; BodyT GPU
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Rep m)
LambdaT GPU
</span><a href="#local-6989586621684420677"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>      </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Stm GPU] -&gt; Stms GPU
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span>
</span><span id="line-159"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Stm GPU -&gt; Stm GPU
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684420644"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Stm GPU) -&gt; Stm GPU -&gt; Stm GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; StmAux (ExpDec GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; PatT Type
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT Type
</span><a href="#local-6989586621684420642"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; Stm GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420639"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-160"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684420642"><span class="annot"><span class="annottext">PatElemT Type
</span><a href="#local-6989586621684420642"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684420644"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684420644"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684420639"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420639"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; [SubExpRes] -&gt; [(PatElemT Type, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420660"><span class="hs-identifier hs-var">chunk_red_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684420652"><span class="hs-identifier hs-var">chunk_red_ses</span></a></span><span>
</span><span id="line-161"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-162"></span><span>      </span><span class="annot"><span class="annottext">Stms GPU -&gt; Stms GPU -&gt; Stms GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Stm GPU] -&gt; Stms GPU
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span>
</span><span id="line-163"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Stm GPU -&gt; Stm GPU
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684420637"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Stm GPU) -&gt; Stm GPU -&gt; Stm GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat GPU -&gt; StmAux (ExpDec GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; PatT Type
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT Type
</span><a href="#local-6989586621684420636"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; Stm GPU) -&gt; ExpT GPU -&gt; Stm GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420635"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-164"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684420636"><span class="annot"><span class="annottext">PatElemT Type
</span><a href="#local-6989586621684420636"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684420637"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684420637"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684420635"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420635"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; [SubExpRes] -&gt; [(PatElemT Type, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420656"><span class="hs-identifier hs-var">chunk_map_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684420651"><span class="hs-identifier hs-var">chunk_map_ses</span></a></span><span>
</span><span id="line-165"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>  </span><span class="annot"><span class="annottext">([PatElemT Type], [PatElemT Type])
-&gt; m ([PatElemT Type], [PatElemT Type])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420660"><span class="hs-identifier hs-var">chunk_red_pes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420656"><span class="hs-identifier hs-var">chunk_map_pes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span class="hs-comment">-- | Given a chunked fold lambda that takes its initial accumulator</span><span>
</span><span id="line-170"></span><span class="hs-comment">-- value as parameters, bind those parameters to the neutral element</span><span>
</span><span id="line-171"></span><span class="hs-comment">-- instead.</span><span>
</span><span id="line-172"></span><span id="local-6989586621684421059"><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#kerneliseLambda"><span class="hs-identifier hs-type">kerneliseLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-173"></span><span>  </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-174"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-175"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-176"></span><span>  </span><span class="annot"><a href="#local-6989586621684421059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-177"></span><span id="kerneliseLambda"><span class="annot"><span class="annottext">kerneliseLambda :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
[SubExp] -&gt; LambdaT GPU -&gt; m (LambdaT GPU)
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#kerneliseLambda"><span class="hs-identifier hs-var hs-var">kerneliseLambda</span></a></span></span><span> </span><span id="local-6989586621684420621"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420621"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span id="local-6989586621684420620"><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684420620"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-178"></span><span>  </span><span id="local-6989586621684420619"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684420619"><span class="hs-identifier hs-var">thread_index_param</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Type -&gt; m (Param Type)
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;thread_index&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; m (Param Type)) -&gt; Type -&gt; m (Param Type)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-179"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684420615"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684420615"><span class="hs-identifier hs-var">fold_chunk_param</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420614"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684420614"><span class="hs-identifier hs-var">fold_acc_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420613"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684420613"><span class="hs-identifier hs-var">fold_inp_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; [Param Type] -&gt; (Param Type, [Param Type], [Param Type])
forall dec.
Int -&gt; [Param dec] -&gt; (Param dec, [Param dec], [Param dec])
</span><a href="Futhark.Tools.html#partitionChunkedFoldParameters"><span class="hs-identifier hs-var">partitionChunkedFoldParameters</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420621"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param Type] -&gt; (Param Type, [Param Type], [Param Type]))
-&gt; [Param Type] -&gt; (Param Type, [Param Type], [Param Type])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU -&gt; [LParam GPU]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684420620"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span>      </span><span id="local-6989586621684420603"><span class="annot"><span class="annottext">mkAccInit :: Param dec -&gt; SubExp -&gt; Stm rep
</span><a href="#local-6989586621684420603"><span class="hs-identifier hs-var hs-var">mkAccInit</span></a></span></span><span> </span><span id="local-6989586621684420602"><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684420602"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684420601"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420601"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Bool) -&gt; Type -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param dec -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684420602"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-184"></span><span>          </span><span class="annot"><span class="annottext">[Ident] -&gt; Exp rep -&gt; Stm rep
forall rep. Buildable rep =&gt; [Ident] -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.Builder.Class.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param dec -&gt; Ident
forall dec. Typed dec =&gt; Param dec -&gt; Ident
</span><a href="Futhark.IR.Prop.Patterns.html#paramIdent"><span class="hs-identifier hs-var">paramIdent</span></a></span><span> </span><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684420602"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Stm rep) -&gt; Exp rep -&gt; Stm rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp rep) -&gt; BasicOp -&gt; Exp rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-var">Copy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420601"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-185"></span><span>      </span><span class="annot"><a href="#local-6989586621684420603"><span class="hs-identifier hs-var">mkAccInit</span></a></span><span> </span><span id="local-6989586621684420594"><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684420594"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684420593"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420593"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; Exp rep -&gt; Stm rep
forall rep. Buildable rep =&gt; [Ident] -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.Builder.Class.html#mkLet"><span class="hs-identifier hs-var">mkLet</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param dec -&gt; Ident
forall dec. Typed dec =&gt; Param dec -&gt; Ident
</span><a href="Futhark.IR.Prop.Patterns.html#paramIdent"><span class="hs-identifier hs-var">paramIdent</span></a></span><span> </span><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684420594"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Stm rep) -&gt; Exp rep -&gt; Stm rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp rep) -&gt; BasicOp -&gt; Exp rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420593"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-186"></span><span>      </span><span id="local-6989586621684420592"><span class="annot"><span class="annottext">acc_init_stms :: Stms GPU
</span><a href="#local-6989586621684420592"><span class="hs-identifier hs-var hs-var">acc_init_stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Stm GPU] -&gt; Stms GPU
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm GPU] -&gt; Stms GPU) -&gt; [Stm GPU] -&gt; Stms GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; SubExp -&gt; Stm GPU)
-&gt; [Param Type] -&gt; [SubExp] -&gt; [Stm GPU]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; SubExp -&gt; Stm GPU
forall {rep} {dec}.
(Buildable rep, Typed dec) =&gt;
Param dec -&gt; SubExp -&gt; Stm rep
</span><a href="#local-6989586621684420603"><span class="hs-identifier hs-var">mkAccInit</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684420614"><span class="hs-identifier hs-var">fold_acc_params</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420621"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-187"></span><span>  </span><span class="annot"><span class="annottext">LambdaT GPU -&gt; m (LambdaT GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-188"></span><span>    </span><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684420620"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-189"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lambdaBody :: BodyT GPU
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var">lambdaBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms GPU -&gt; BodyT GPU -&gt; BodyT GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Body rep -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#insertStms"><span class="hs-identifier hs-var">insertStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684420592"><span class="hs-identifier hs-var">acc_init_stms</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT GPU -&gt; BodyT GPU) -&gt; BodyT GPU -&gt; BodyT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU -&gt; BodyT GPU
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684420620"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-190"></span><span>        </span><span class="annot"><span class="annottext">lambdaParams :: [LParam GPU]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var">lambdaParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684420619"><span class="hs-identifier hs-var">thread_index_param</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; [Param Type] -&gt; [Param Type]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684420615"><span class="hs-identifier hs-var">fold_chunk_param</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; [Param Type] -&gt; [Param Type]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684420613"><span class="hs-identifier hs-var">fold_inp_params</span></a></span><span>
</span><span id="line-191"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span id="local-6989586621684421033"><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#prepareStream"><span class="hs-identifier hs-type">prepareStream</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421033"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684421033"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-195"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#KernelSize"><span class="hs-identifier hs-type">KernelSize</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-196"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-197"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Commutativity"><span class="hs-identifier hs-type">Commutativity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-200"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-201"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-202"></span><span>  </span><span class="annot"><a href="#local-6989586621684421033"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-203"></span><span id="prepareStream"><span class="annot"><span class="annottext">prepareStream :: forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ GPU) =&gt;
KernelSize
-&gt; [(VName, SubExp)]
-&gt; SubExp
-&gt; Commutativity
-&gt; LambdaT GPU
-&gt; [SubExp]
-&gt; [VName]
-&gt; m (SubExp, SegSpace, [Type], KernelBody GPU)
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#prepareStream"><span class="hs-identifier hs-var hs-var">prepareStream</span></a></span></span><span> </span><span id="local-6989586621684420533"><span class="annot"><span class="annottext">KernelSize
</span><a href="#local-6989586621684420533"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621684420532"><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684420532"><span class="hs-identifier hs-var">ispace</span></a></span></span><span> </span><span id="local-6989586621684420531"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420531"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684420530"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684420530"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684420529"><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684420529"><span class="hs-identifier hs-var">fold_lam</span></a></span></span><span> </span><span id="local-6989586621684420528"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420528"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span id="local-6989586621684420527"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684420527"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#KernelSize"><span class="hs-identifier hs-type">KernelSize</span></a></span><span> </span><span id="local-6989586621684420526"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420526"><span class="hs-identifier hs-var">elems_per_thread</span></a></span></span><span> </span><span id="local-6989586621684420525"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420525"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelSize
</span><a href="#local-6989586621684420533"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-205"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684420524"><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684420524"><span class="hs-identifier hs-var">ordering</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420523"><span class="annot"><span class="annottext">SplitOrdering
</span><a href="#local-6989586621684420523"><span class="hs-identifier hs-var">split_ordering</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-206"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684420530"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-207"></span><span>          </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamOrd
</span><a href="Futhark.IR.SOACS.SOAC.html#Disorder"><span class="hs-identifier hs-var">Disorder</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SplitOrdering
</span><a href="Futhark.IR.SegOp.html#SplitStrided"><span class="hs-identifier hs-var">SplitStrided</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420525"><span class="hs-identifier hs-var">num_threads</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-208"></span><span>          </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Noncommutative"><span class="hs-identifier hs-var">Noncommutative</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StreamOrd
</span><a href="Futhark.IR.SOACS.SOAC.html#InOrder"><span class="hs-identifier hs-var">InOrder</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SplitOrdering
</span><a href="Futhark.IR.SegOp.html#SplitContiguous"><span class="hs-identifier hs-var">SplitContiguous</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span>  </span><span id="local-6989586621684420520"><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684420520"><span class="hs-identifier hs-var">fold_lam'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; LambdaT GPU -&gt; m (LambdaT GPU)
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
[SubExp] -&gt; LambdaT GPU -&gt; m (LambdaT GPU)
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#kerneliseLambda"><span class="hs-identifier hs-var">kerneliseLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420528"><span class="hs-identifier hs-var">nes</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684420529"><span class="hs-identifier hs-var">fold_lam</span></a></span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span>  </span><span id="local-6989586621684420519"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420519"><span class="hs-identifier hs-var">gtid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;gtid&quot;</span></span><span>
</span><span id="line-213"></span><span>  </span><span id="local-6989586621684420518"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684420518"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; m SegSpace
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
[(VName, SubExp)] -&gt; m SegSpace
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#mkSegSpace"><span class="hs-identifier hs-var">mkSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; m SegSpace)
-&gt; [(VName, SubExp)] -&gt; m SegSpace
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684420532"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; [(VName, SubExp)] -&gt; [(VName, SubExp)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420519"><span class="hs-identifier hs-var">gtid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420525"><span class="hs-identifier hs-var">num_threads</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-214"></span><span>  </span><span id="local-6989586621684420516"><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684420516"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(([KernelResult], Stms GPU) -&gt; KernelBody GPU)
-&gt; m ([KernelResult], Stms GPU) -&gt; m (KernelBody GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([KernelResult] -&gt; Stms GPU -&gt; KernelBody GPU)
-&gt; ([KernelResult], Stms GPU) -&gt; KernelBody GPU
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Stms GPU -&gt; [KernelResult] -&gt; KernelBody GPU)
-&gt; [KernelResult] -&gt; Stms GPU -&gt; KernelBody GPU
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyDec GPU -&gt; Stms GPU -&gt; [KernelResult] -&gt; KernelBody GPU
forall rep.
BodyDec rep -&gt; Stms rep -&gt; [KernelResult] -&gt; KernelBody rep
</span><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-var">KernelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m ([KernelResult], Stms GPU) -&gt; m (KernelBody GPU))
-&gt; m ([KernelResult], Stms GPU) -&gt; m (KernelBody GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><span class="annottext">Builder GPU [KernelResult] -&gt; m ([KernelResult], Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilder"><span class="hs-identifier hs-var">runBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPU [KernelResult] -&gt; m ([KernelResult], Stms GPU))
-&gt; Builder GPU [KernelResult] -&gt; m ([KernelResult], Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-216"></span><span>      </span><span class="annot"><span class="annottext">Scope GPU
-&gt; Builder GPU [KernelResult] -&gt; Builder GPU [KernelResult]
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; Scope GPU
forall rep. SegSpace -&gt; Scope rep
</span><a href="Futhark.IR.SegOp.html#scopeOfSegSpace"><span class="hs-identifier hs-var">scopeOfSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684420518"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Builder GPU [KernelResult] -&gt; Builder GPU [KernelResult])
-&gt; Builder GPU [KernelResult] -&gt; Builder GPU [KernelResult]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-217"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684420509"><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420509"><span class="hs-identifier hs-var">chunk_red_pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420508"><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420508"><span class="hs-identifier hs-var">chunk_map_pes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-218"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; SubExp
-&gt; KernelSize
-&gt; StreamOrd
-&gt; Lambda (Rep (BuilderT GPU (State VNameSource)))
-&gt; Int
-&gt; [VName]
-&gt; BuilderT
     GPU (State VNameSource) ([PatElemT Type], [PatElemT Type])
forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ GPU) =&gt;
VName
-&gt; SubExp
-&gt; KernelSize
-&gt; StreamOrd
-&gt; Lambda (Rep m)
-&gt; Int
-&gt; [VName]
-&gt; m ([PatElemT Type], [PatElemT Type])
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#blockedPerThread"><span class="hs-identifier hs-var">blockedPerThread</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684420519"><span class="hs-identifier hs-var">gtid</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420531"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">KernelSize
</span><a href="#local-6989586621684420533"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">StreamOrd
</span><a href="#local-6989586621684420524"><span class="hs-identifier hs-var">ordering</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Rep (BuilderT GPU (State VNameSource)))
LambdaT GPU
</span><a href="#local-6989586621684420520"><span class="hs-identifier hs-var">fold_lam'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420528"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684420527"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-219"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684420507"><span class="annot"><span class="annottext">concatReturns :: PatElemT Type -&gt; KernelResult
</span><a href="#local-6989586621684420507"><span class="hs-identifier hs-var hs-var">concatReturns</span></a></span></span><span> </span><span id="local-6989586621684420506"><span class="annot"><span class="annottext">PatElemT Type
</span><a href="#local-6989586621684420506"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-220"></span><span>              </span><span class="annot"><span class="annottext">Certs -&gt; SplitOrdering -&gt; SubExp -&gt; SubExp -&gt; VName -&gt; KernelResult
</span><a href="Futhark.IR.SegOp.html#ConcatReturns"><span class="hs-identifier hs-var">ConcatReturns</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">SplitOrdering
</span><a href="#local-6989586621684420523"><span class="hs-identifier hs-var">split_ordering</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420531"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420526"><span class="hs-identifier hs-var">elems_per_thread</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; KernelResult) -&gt; VName -&gt; KernelResult
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT Type -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT Type
</span><a href="#local-6989586621684420506"><span class="hs-identifier hs-var">pe</span></a></span><span>
</span><span id="line-221"></span><span>        </span><span class="annot"><span class="annottext">[KernelResult] -&gt; Builder GPU [KernelResult]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-222"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(PatElemT Type -&gt; KernelResult)
-&gt; [PatElemT Type] -&gt; [KernelResult]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ResultManifest -&gt; Certs -&gt; SubExp -&gt; KernelResult
</span><a href="Futhark.IR.SegOp.html#Returns"><span class="hs-identifier hs-var">Returns</span></a></span><span> </span><span class="annot"><span class="annottext">ResultManifest
</span><a href="Futhark.IR.SegOp.html#ResultMaySimplify"><span class="hs-identifier hs-var">ResultMaySimplify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; KernelResult)
-&gt; (PatElemT Type -&gt; SubExp) -&gt; PatElemT Type -&gt; KernelResult
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp)
-&gt; (PatElemT Type -&gt; VName) -&gt; PatElemT Type -&gt; SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatElemT Type -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420509"><span class="hs-identifier hs-var">chunk_red_pes</span></a></span><span>
</span><span id="line-223"></span><span>              </span><span class="annot"><span class="annottext">[KernelResult] -&gt; [KernelResult] -&gt; [KernelResult]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT Type -&gt; KernelResult)
-&gt; [PatElemT Type] -&gt; [KernelResult]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PatElemT Type -&gt; KernelResult
</span><a href="#local-6989586621684420507"><span class="hs-identifier hs-var">concatReturns</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420508"><span class="hs-identifier hs-var">chunk_map_pes</span></a></span><span>
</span><span id="line-224"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684420501"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684420501"><span class="hs-identifier hs-var">redout_ts</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420500"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684420500"><span class="hs-identifier hs-var">mapout_ts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Type] -&gt; ([Type], [Type])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420528"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Type] -&gt; ([Type], [Type])) -&gt; [Type] -&gt; ([Type], [Type])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684420529"><span class="hs-identifier hs-var">fold_lam</span></a></span><span>
</span><span id="line-227"></span><span>      </span><span id="local-6989586621684420499"><span class="annot"><span class="annottext">ts :: [Type]
</span><a href="#local-6989586621684420499"><span class="hs-identifier hs-var hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684420501"><span class="hs-identifier hs-var">redout_ts</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; [Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Type) -&gt; [Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Type
forall u.
TypeBase (ShapeBase SubExp) u -&gt; TypeBase (ShapeBase SubExp) u
</span><a href="Futhark.IR.Prop.Types.html#rowType"><span class="hs-identifier hs-var">rowType</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684420500"><span class="hs-identifier hs-var">mapout_ts</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>  </span><span class="annot"><span class="annottext">(SubExp, SegSpace, [Type], KernelBody GPU)
-&gt; m (SubExp, SegSpace, [Type], KernelBody GPU)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420525"><span class="hs-identifier hs-var">num_threads</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684420518"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684420499"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684420516"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span id="local-6989586621684420987"><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#streamRed"><span class="hs-identifier hs-type">streamRed</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684420987"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684420987"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-233"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#MkSegLevel"><span class="hs-identifier hs-type">MkSegLevel</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684420987"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-235"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-236"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Commutativity"><span class="hs-identifier hs-type">Commutativity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-237"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><a href="#local-6989586621684420987"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-242"></span><span id="streamRed"><span class="annot"><span class="annottext">streamRed :: forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPU m) =&gt;
MkSegLevel GPU m
-&gt; Pat GPU
-&gt; SubExp
-&gt; Commutativity
-&gt; LambdaT GPU
-&gt; LambdaT GPU
-&gt; [SubExp]
-&gt; [VName]
-&gt; m (Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#streamRed"><span class="hs-identifier hs-var hs-var">streamRed</span></a></span></span><span> </span><span id="local-6989586621684420450"><span class="annot"><span class="annottext">MkSegLevel GPU m
</span><a href="#local-6989586621684420450"><span class="hs-identifier hs-var">mk_lvl</span></a></span></span><span> </span><span id="local-6989586621684420449"><span class="annot"><span class="annottext">Pat GPU
</span><a href="#local-6989586621684420449"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684420448"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420448"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684420447"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684420447"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684420446"><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684420446"><span class="hs-identifier hs-var">red_lam</span></a></span></span><span> </span><span id="local-6989586621684420445"><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684420445"><span class="hs-identifier hs-var">fold_lam</span></a></span></span><span> </span><span id="local-6989586621684420444"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420444"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span id="local-6989586621684420443"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684420443"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuilderT GPU m () -&gt; m (Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
BuilderT rep m a -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT%27_"><span class="hs-identifier hs-var">runBuilderT'_</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT GPU m () -&gt; m (Stms GPU))
-&gt; BuilderT GPU m () -&gt; m (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-comment">-- The strategy here is to rephrase the stream reduction as a</span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-comment">-- non-segmented SegRed that does explicit chunking within its body.</span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-comment">-- First, figure out how many threads to use for this.</span><span>
</span><span id="line-246"></span><span>  </span><span id="local-6989586621684420441"><span class="annot"><span class="annottext">KernelSize
</span><a href="#local-6989586621684420441"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; SubExp -&gt; BuilderT GPU m KernelSize
forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ GPU) =&gt;
String -&gt; SubExp -&gt; m KernelSize
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#blockedKernelSize"><span class="hs-identifier hs-var">blockedKernelSize</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;stream_red&quot;</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420448"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684420440"><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420440"><span class="hs-identifier hs-var">redout_pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420439"><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420439"><span class="hs-identifier hs-var">mapout_pes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [PatElemT Type] -&gt; ([PatElemT Type], [PatElemT Type])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420444"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT Type] -&gt; ([PatElemT Type], [PatElemT Type]))
-&gt; [PatElemT Type] -&gt; ([PatElemT Type], [PatElemT Type])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [PatElemT Type]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat GPU
</span><a href="#local-6989586621684420449"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684420437"><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684420437"><span class="hs-identifier hs-var">redout_pat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420436"><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684420436"><span class="hs-identifier hs-var">ispace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420435"><span class="annot"><span class="annottext">BuilderT GPU m ()
</span><a href="#local-6989586621684420435"><span class="hs-identifier hs-var">read_dummy</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT GPU m))
-&gt; BuilderT
     GPU
     m
     (Pat (Rep (BuilderT GPU m)), [(VName, SubExp)], BuilderT GPU m ())
forall (m :: * -&gt; *).
(MonadFreshNames m, MonadBuilder m, DistRep (Rep m)) =&gt;
Pat (Rep m) -&gt; m (Pat (Rep m), [(VName, SubExp)], m ())
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#dummyDim"><span class="hs-identifier hs-var">dummyDim</span></a></span><span> </span><span class="annot"><span class="annottext">(Pat (Rep (BuilderT GPU m))
 -&gt; BuilderT
      GPU
      m
      (Pat (Rep (BuilderT GPU m)), [(VName, SubExp)], BuilderT GPU m ()))
-&gt; Pat (Rep (BuilderT GPU m))
-&gt; BuilderT
     GPU
     m
     (Pat (Rep (BuilderT GPU m)), [(VName, SubExp)], BuilderT GPU m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; PatT Type
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420440"><span class="hs-identifier hs-var">redout_pes</span></a></span><span>
</span><span id="line-250"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684420433"><span class="annot"><span class="annottext">pat' :: PatT Type
</span><a href="#local-6989586621684420433"><span class="hs-identifier hs-var hs-var">pat'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; PatT Type
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT Type] -&gt; PatT Type) -&gt; [PatElemT Type] -&gt; PatT Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [PatElemT Type]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
</span><a href="#local-6989586621684420437"><span class="hs-identifier hs-var">redout_pat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; [PatElemT Type] -&gt; [PatElemT Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420439"><span class="hs-identifier hs-var">mapout_pes</span></a></span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420432"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684420432"><span class="hs-identifier hs-var">kspace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420431"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684420431"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420430"><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684420430"><span class="hs-identifier hs-var">kbody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelSize
-&gt; [(VName, SubExp)]
-&gt; SubExp
-&gt; Commutativity
-&gt; LambdaT GPU
-&gt; [SubExp]
-&gt; [VName]
-&gt; BuilderT GPU m (SubExp, SegSpace, [Type], KernelBody GPU)
forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ GPU) =&gt;
KernelSize
-&gt; [(VName, SubExp)]
-&gt; SubExp
-&gt; Commutativity
-&gt; LambdaT GPU
-&gt; [SubExp]
-&gt; [VName]
-&gt; m (SubExp, SegSpace, [Type], KernelBody GPU)
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#prepareStream"><span class="hs-identifier hs-var">prepareStream</span></a></span><span> </span><span class="annot"><span class="annottext">KernelSize
</span><a href="#local-6989586621684420441"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684420436"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420448"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684420447"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684420445"><span class="hs-identifier hs-var">fold_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420444"><span class="hs-identifier hs-var">nes</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684420443"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span>  </span><span id="local-6989586621684420429"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684420429"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MkSegLevel GPU m
</span><a href="#local-6989586621684420450"><span class="hs-identifier hs-var">mk_lvl</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420448"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;stream_red&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ThreadRecommendation -&gt; BuilderT GPU m (SegOpLevel GPU))
-&gt; ThreadRecommendation -&gt; BuilderT GPU m (SegOpLevel GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegVirt -&gt; ThreadRecommendation
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#NoRecommendation"><span class="hs-identifier hs-var">NoRecommendation</span></a></span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><a href="Futhark.IR.SegOp.html#SegNoVirt"><span class="hs-identifier hs-var">SegNoVirt</span></a></span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT GPU m))
-&gt; Exp (Rep (BuilderT GPU m)) -&gt; BuilderT GPU m ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat (Rep (BuilderT GPU m))
</span><a href="#local-6989586621684420433"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; BuilderT GPU m ())
-&gt; (SegOp SegLevel GPU -&gt; ExpT GPU)
-&gt; SegOp SegLevel GPU
-&gt; BuilderT GPU m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HostOp GPU (SOAC GPU) -&gt; ExpT GPU
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp GPU (SOAC GPU) -&gt; ExpT GPU)
-&gt; (SegOp SegLevel GPU -&gt; HostOp GPU (SOAC GPU))
-&gt; SegOp SegLevel GPU
-&gt; ExpT GPU
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPU -&gt; HostOp GPU (SOAC GPU)
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp SegLevel GPU -&gt; BuilderT GPU m ())
-&gt; SegOp SegLevel GPU -&gt; BuilderT GPU m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-256"></span><span>    </span><span class="annot"><span class="annottext">SegLevel
-&gt; SegSpace
-&gt; [SegBinOp GPU]
-&gt; [Type]
-&gt; KernelBody GPU
-&gt; SegOp SegLevel GPU
forall lvl rep.
lvl
-&gt; SegSpace
-&gt; [SegBinOp rep]
-&gt; [Type]
-&gt; KernelBody rep
-&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegRed"><span class="hs-identifier hs-var">SegRed</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684420429"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684420432"><span class="hs-identifier hs-var">kspace</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Commutativity
-&gt; LambdaT GPU -&gt; [SubExp] -&gt; ShapeBase SubExp -&gt; SegBinOp GPU
forall rep.
Commutativity
-&gt; Lambda rep -&gt; [SubExp] -&gt; ShapeBase SubExp -&gt; SegBinOp rep
</span><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-var">SegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684420447"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684420446"><span class="hs-identifier hs-var">red_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420444"><span class="hs-identifier hs-var">nes</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684420431"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684420430"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><span class="annottext">BuilderT GPU m ()
</span><a href="#local-6989586621684420435"><span class="hs-identifier hs-var">read_dummy</span></a></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span class="hs-comment">-- Similar to streamRed, but without the last reduction.</span><span>
</span><span id="line-261"></span><span id="local-6989586621684420958"><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#streamMap"><span class="hs-identifier hs-type">streamMap</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-262"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684420958"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684420958"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-263"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#MkSegLevel"><span class="hs-identifier hs-type">MkSegLevel</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684420958"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-264"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-265"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#PatElem"><span class="hs-identifier hs-type">PatElem</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-266"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-267"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Commutativity"><span class="hs-identifier hs-type">Commutativity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-268"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-271"></span><span>  </span><span class="annot"><a href="#local-6989586621684420958"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-272"></span><span id="streamMap"><span class="annot"><span class="annottext">streamMap :: forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPU m) =&gt;
MkSegLevel GPU m
-&gt; [String]
-&gt; [PatElem GPU]
-&gt; SubExp
-&gt; Commutativity
-&gt; LambdaT GPU
-&gt; [SubExp]
-&gt; [VName]
-&gt; m ((SubExp, [VName]), Stms GPU)
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#streamMap"><span class="hs-identifier hs-var hs-var">streamMap</span></a></span></span><span> </span><span id="local-6989586621684420385"><span class="annot"><span class="annottext">MkSegLevel GPU m
</span><a href="#local-6989586621684420385"><span class="hs-identifier hs-var">mk_lvl</span></a></span></span><span> </span><span id="local-6989586621684420384"><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621684420384"><span class="hs-identifier hs-var">out_desc</span></a></span></span><span> </span><span id="local-6989586621684420383"><span class="annot"><span class="annottext">[PatElem GPU]
</span><a href="#local-6989586621684420383"><span class="hs-identifier hs-var">mapout_pes</span></a></span></span><span> </span><span id="local-6989586621684420382"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420382"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684420381"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684420381"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684420380"><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684420380"><span class="hs-identifier hs-var">fold_lam</span></a></span></span><span> </span><span id="local-6989586621684420379"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420379"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span id="local-6989586621684420378"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684420378"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuilderT GPU m (SubExp, [VName]) -&gt; m ((SubExp, [VName]), Stms GPU)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
BuilderT rep m a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT%27"><span class="hs-identifier hs-var">runBuilderT'</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT GPU m (SubExp, [VName])
 -&gt; m ((SubExp, [VName]), Stms GPU))
-&gt; BuilderT GPU m (SubExp, [VName])
-&gt; m ((SubExp, [VName]), Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-273"></span><span>  </span><span id="local-6989586621684420376"><span class="annot"><span class="annottext">KernelSize
</span><a href="#local-6989586621684420376"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; SubExp -&gt; BuilderT GPU m KernelSize
forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ GPU) =&gt;
String -&gt; SubExp -&gt; m KernelSize
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#blockedKernelSize"><span class="hs-identifier hs-var">blockedKernelSize</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;stream_map&quot;</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420382"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684420375"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420375"><span class="hs-identifier hs-var">threads</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420374"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684420374"><span class="hs-identifier hs-var">kspace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420373"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684420373"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420372"><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684420372"><span class="hs-identifier hs-var">kbody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelSize
-&gt; [(VName, SubExp)]
-&gt; SubExp
-&gt; Commutativity
-&gt; LambdaT GPU
-&gt; [SubExp]
-&gt; [VName]
-&gt; BuilderT GPU m (SubExp, SegSpace, [Type], KernelBody GPU)
forall (m :: * -&gt; *).
(MonadBuilder m, Rep m ~ GPU) =&gt;
KernelSize
-&gt; [(VName, SubExp)]
-&gt; SubExp
-&gt; Commutativity
-&gt; LambdaT GPU
-&gt; [SubExp]
-&gt; [VName]
-&gt; m (SubExp, SegSpace, [Type], KernelBody GPU)
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#prepareStream"><span class="hs-identifier hs-var">prepareStream</span></a></span><span> </span><span class="annot"><span class="annottext">KernelSize
</span><a href="#local-6989586621684420376"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420382"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684420381"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPU
</span><a href="#local-6989586621684420380"><span class="hs-identifier hs-var">fold_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420379"><span class="hs-identifier hs-var">nes</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684420378"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684420371"><span class="annot"><span class="annottext">redout_ts :: [Type]
</span><a href="#local-6989586621684420371"><span class="hs-identifier hs-var hs-var">redout_ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Type] -&gt; [Type]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420379"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684420373"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span>  </span><span id="local-6989586621684420370"><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420370"><span class="hs-identifier hs-var">redout_pes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(String, Type)]
-&gt; ((String, Type) -&gt; BuilderT GPU m (PatElemT Type))
-&gt; BuilderT GPU m [PatElemT Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[String] -&gt; [Type] -&gt; [(String, Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[String]
</span><a href="#local-6989586621684420384"><span class="hs-identifier hs-var">out_desc</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684420371"><span class="hs-identifier hs-var">redout_ts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((String, Type) -&gt; BuilderT GPU m (PatElemT Type))
 -&gt; BuilderT GPU m [PatElemT Type])
-&gt; ((String, Type) -&gt; BuilderT GPU m (PatElemT Type))
-&gt; BuilderT GPU m [PatElemT Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684420369"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684420369"><span class="hs-identifier hs-var">desc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684420368"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684420368"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-280"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; PatElemT Type
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Type -&gt; PatElemT Type)
-&gt; BuilderT GPU m VName -&gt; BuilderT GPU m (Type -&gt; PatElemT Type)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; BuilderT GPU m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684420369"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">BuilderT GPU m (Type -&gt; PatElemT Type)
-&gt; BuilderT GPU m Type -&gt; BuilderT GPU m (PatElemT Type)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; BuilderT GPU m Type
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684420368"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Type -&gt; SubExp -&gt; Type
forall d.
ArrayShape (ShapeBase d) =&gt;
TypeBase (ShapeBase d) NoUniqueness
-&gt; d -&gt; TypeBase (ShapeBase d) NoUniqueness
</span><a href="Futhark.IR.Prop.Types.html#arrayOfRow"><span class="hs-operator hs-var">`arrayOfRow`</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420375"><span class="hs-identifier hs-var">threads</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684420367"><span class="annot"><span class="annottext">pat :: PatT Type
</span><a href="#local-6989586621684420367"><span class="hs-identifier hs-var hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; PatT Type
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT Type] -&gt; PatT Type) -&gt; [PatElemT Type] -&gt; PatT Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420370"><span class="hs-identifier hs-var">redout_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type] -&gt; [PatElemT Type] -&gt; [PatElemT Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
[PatElem GPU]
</span><a href="#local-6989586621684420383"><span class="hs-identifier hs-var">mapout_pes</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span id="local-6989586621684420366"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684420366"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MkSegLevel GPU m
</span><a href="#local-6989586621684420385"><span class="hs-identifier hs-var">mk_lvl</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420382"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;stream_map&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ThreadRecommendation -&gt; BuilderT GPU m (SegOpLevel GPU))
-&gt; ThreadRecommendation -&gt; BuilderT GPU m (SegOpLevel GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegVirt -&gt; ThreadRecommendation
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#NoRecommendation"><span class="hs-identifier hs-var">NoRecommendation</span></a></span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><a href="Futhark.IR.SegOp.html#SegNoVirt"><span class="hs-identifier hs-var">SegNoVirt</span></a></span><span>
</span><span id="line-284"></span><span>  </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT GPU m))
-&gt; Exp (Rep (BuilderT GPU m)) -&gt; BuilderT GPU m ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat (Rep (BuilderT GPU m))
</span><a href="#local-6989586621684420367"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT GPU m)) -&gt; BuilderT GPU m ())
-&gt; Exp (Rep (BuilderT GPU m)) -&gt; BuilderT GPU m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op GPU -&gt; ExpT GPU
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op GPU -&gt; ExpT GPU) -&gt; Op GPU -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPU -&gt; HostOp GPU (SOAC GPU)
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp SegLevel GPU -&gt; HostOp GPU (SOAC GPU))
-&gt; SegOp SegLevel GPU -&gt; HostOp GPU (SOAC GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegLevel
-&gt; SegSpace -&gt; [Type] -&gt; KernelBody GPU -&gt; SegOp SegLevel GPU
forall lvl rep.
lvl -&gt; SegSpace -&gt; [Type] -&gt; KernelBody rep -&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-var">SegMap</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684420366"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684420374"><span class="hs-identifier hs-var">kspace</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684420373"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPU
</span><a href="#local-6989586621684420372"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span>  </span><span class="annot"><span class="annottext">(SubExp, [VName]) -&gt; BuilderT GPU m (SubExp, [VName])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420375"><span class="hs-identifier hs-var">threads</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(PatElemT Type -&gt; VName) -&gt; [PatElemT Type] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PatElemT Type -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT Type]
</span><a href="#local-6989586621684420370"><span class="hs-identifier hs-var">redout_pes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span class="hs-comment">-- | Like 'segThread', but cap the thread count to the input size.</span><span>
</span><span id="line-289"></span><span class="hs-comment">-- This is more efficient for small kernels, e.g. summing a small</span><span>
</span><span id="line-290"></span><span class="hs-comment">-- array.</span><span>
</span><span id="line-291"></span><span id="local-6989586621684420948"><span class="annot"><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#segThreadCapped"><span class="hs-identifier hs-type">segThreadCapped</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684420948"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#MkSegLevel"><span class="hs-identifier hs-type">MkSegLevel</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684420948"><span class="hs-identifier hs-type">m</span></a></span></span><span>
</span><span id="line-292"></span><span id="segThreadCapped"><span class="annot"><span class="annottext">segThreadCapped :: forall (m :: * -&gt; *). MonadFreshNames m =&gt; MkSegLevel GPU m
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#segThreadCapped"><span class="hs-identifier hs-var hs-var">segThreadCapped</span></a></span></span><span> </span><span id="local-6989586621684420338"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420338"><span class="hs-identifier hs-var">ws</span></a></span></span><span> </span><span id="local-6989586621684420337"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684420337"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684420336"><span class="annot"><span class="annottext">ThreadRecommendation
</span><a href="#local-6989586621684420336"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-293"></span><span>  </span><span id="local-6989586621684420335"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420335"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-294"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (BuilderT GPU m)) -&gt; BuilderT GPU m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nest_size&quot;</span></span><span>
</span><span id="line-295"></span><span>      </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; BuilderT GPU m SubExp)
-&gt; BuilderT GPU m (ExpT GPU) -&gt; BuilderT GPU m SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">BinOp
-&gt; SubExp
-&gt; [SubExp]
-&gt; BuilderT GPU m (Exp (Rep (BuilderT GPU m)))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
BinOp -&gt; SubExp -&gt; [SubExp] -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#foldBinOp"><span class="hs-identifier hs-var">foldBinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Mul"><span class="hs-identifier hs-var">Mul</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684420338"><span class="hs-identifier hs-var">ws</span></a></span><span>
</span><span id="line-296"></span><span>  </span><span id="local-6989586621684420332"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420332"><span class="hs-identifier hs-var">group_size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; SizeClass -&gt; BuilderT GPU m SubExp
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ HostOp (Rep m) inner) =&gt;
String -&gt; SizeClass -&gt; m SubExp
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#getSize"><span class="hs-identifier hs-var">getSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684420337"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_group_size&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="Futhark.IR.GPU.Sizes.html#SizeGroup"><span class="hs-identifier hs-var">SizeGroup</span></a></span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ThreadRecommendation
</span><a href="#local-6989586621684420336"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-299"></span><span>    </span><span class="annot"><span class="annottext">ThreadRecommendation
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#ManyThreads"><span class="hs-identifier hs-var">ManyThreads</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-300"></span><span>      </span><span id="local-6989586621684420330"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420330"><span class="hs-identifier hs-var">usable_groups</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-301"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (BuilderT GPU m)) -&gt; BuilderT GPU m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segmap_usable_groups&quot;</span></span><span>
</span><span id="line-302"></span><span>          </span><span class="annot"><span class="annottext">(ExpT GPU -&gt; BuilderT GPU m SubExp)
-&gt; BuilderT GPU m (ExpT GPU) -&gt; BuilderT GPU m SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">BinOp
-&gt; BuilderT GPU m (Exp (Rep (BuilderT GPU m)))
-&gt; BuilderT GPU m (Exp (Rep (BuilderT GPU m)))
-&gt; BuilderT GPU m (Exp (Rep (BuilderT GPU m)))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
BinOp -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eBinOp"><span class="hs-identifier hs-var">eBinOp</span></a></span><span>
</span><span id="line-303"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Safety -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SDivUp"><span class="hs-identifier hs-var">SDivUp</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Unsafe"><span class="hs-identifier hs-var">Unsafe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; BuilderT GPU m (Exp (Rep (BuilderT GPU m)))
forall (m :: * -&gt; *). MonadBuilder m =&gt; SubExp -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eSubExp"><span class="hs-identifier hs-var">eSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420335"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; BuilderT GPU m (ExpT GPU)
forall (m :: * -&gt; *). MonadBuilder m =&gt; SubExp -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eSubExp"><span class="hs-identifier hs-var">eSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BuilderT GPU m (ExpT GPU))
-&gt; BuilderT GPU m SubExp -&gt; BuilderT GPU m (ExpT GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; SubExp -&gt; BuilderT GPU m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
IntType -&gt; SubExp -&gt; m SubExp
</span><a href="Futhark.Construct.html#asIntS"><span class="hs-identifier hs-var">asIntS</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420332"><span class="hs-identifier hs-var">group_size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>      </span><span class="annot"><span class="annottext">SegLevel -&gt; BuilderT GPU m SegLevel
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(SegLevel -&gt; BuilderT GPU m SegLevel)
-&gt; SegLevel -&gt; BuilderT GPU m SegLevel
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count NumGroups SubExp
-&gt; Count GroupSize SubExp -&gt; SegVirt -&gt; SegLevel
</span><a href="Futhark.IR.GPU.Op.html#SegThread"><span class="hs-identifier hs-var">SegThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Count NumGroups SubExp
forall u e. e -&gt; Count u e
</span><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-var">Count</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420330"><span class="hs-identifier hs-var">usable_groups</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Count GroupSize SubExp
forall u e. e -&gt; Count u e
</span><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-var">Count</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420332"><span class="hs-identifier hs-var">group_size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><a href="Futhark.IR.SegOp.html#SegNoVirt"><span class="hs-identifier hs-var">SegNoVirt</span></a></span><span>
</span><span id="line-307"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#NoRecommendation"><span class="hs-identifier hs-type">NoRecommendation</span></a></span><span> </span><span id="local-6989586621684420327"><span class="annot"><span class="annottext">SegVirt
</span><a href="#local-6989586621684420327"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-308"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684420326"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420326"><span class="hs-identifier hs-var">num_groups</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; SubExp -&gt; SubExp -&gt; BuilderT GPU m (SubExp, SubExp)
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ HostOp (Rep m) inner) =&gt;
String -&gt; SubExp -&gt; SubExp -&gt; m (SubExp, SubExp)
</span><a href="Futhark.Pass.ExtractKernels.StreamKernel.html#numberOfGroups"><span class="hs-identifier hs-var">numberOfGroups</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684420337"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420335"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420332"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-309"></span><span>      </span><span class="annot"><span class="annottext">SegLevel -&gt; BuilderT GPU m SegLevel
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(SegLevel -&gt; BuilderT GPU m SegLevel)
-&gt; SegLevel -&gt; BuilderT GPU m SegLevel
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count NumGroups SubExp
-&gt; Count GroupSize SubExp -&gt; SegVirt -&gt; SegLevel
</span><a href="Futhark.IR.GPU.Op.html#SegThread"><span class="hs-identifier hs-var">SegThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Count NumGroups SubExp
forall u e. e -&gt; Count u e
</span><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-var">Count</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420326"><span class="hs-identifier hs-var">num_groups</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Count GroupSize SubExp
forall u e. e -&gt; Count u e
</span><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-var">Count</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684420332"><span class="hs-identifier hs-var">group_size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><a href="#local-6989586621684420327"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-310"></span></pre></body></html>