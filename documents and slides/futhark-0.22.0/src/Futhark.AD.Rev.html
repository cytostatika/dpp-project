<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-comment">-- Naming scheme:</span><span>
</span><span id="line-8"></span><span class="hs-comment">--</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- An adjoint-related object for &quot;x&quot; is named &quot;x_adj&quot;.  This means</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- both actual adjoints and statements.</span><span>
</span><span id="line-11"></span><span class="hs-comment">--</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- Do not assume &quot;x'&quot; means anything related to derivatives.</span><span>
</span><span id="line-13"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.AD.Rev</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.AD.Rev.html#revVJP"><span class="hs-identifier">revVJP</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.AD.Derivatives.html"><span class="hs-identifier">Futhark.AD.Derivatives</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Loop.html"><span class="hs-identifier">Futhark.AD.Rev.Loop</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html"><span class="hs-identifier">Futhark.AD.Rev.Monad</span></a></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.SOAC.html"><span class="hs-identifier">Futhark.AD.Rev.SOAC</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.Convert.html"><span class="hs-identifier">Futhark.Analysis.PrimExp.Convert</span></a></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Builder.html"><span class="hs-identifier">Futhark.Builder</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html"><span class="hs-identifier">Futhark.IR.SOACS</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Tools.html"><span class="hs-identifier">Futhark.Tools</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html"><span class="hs-identifier">Futhark.Transform.Rename</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Substitute.html"><span class="hs-identifier">Futhark.Transform.Substitute</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#takeLast"><span class="hs-identifier">takeLast</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="annot"><a href="Futhark.AD.Rev.html#patName"><span class="hs-identifier hs-type">patName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-30"></span><span id="patName"><span class="annot"><span class="annottext">patName :: Pat -&gt; ADM VName
</span><a href="Futhark.AD.Rev.html#patName"><span class="hs-identifier hs-var hs-var">patName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684465387"><span class="annot"><span class="annottext">PatElemT (LetDec SOACS)
</span><a href="#local-6989586621684465387"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM VName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ADM VName) -&gt; VName -&gt; ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT Type -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT Type
PatElemT (LetDec SOACS)
</span><a href="#local-6989586621684465387"><span class="hs-identifier hs-var">pe</span></a></span><span>
</span><span id="line-31"></span><span class="annot"><a href="Futhark.AD.Rev.html#patName"><span class="hs-identifier hs-var">patName</span></a></span><span> </span><span id="local-6989586621684465385"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465385"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ADM VName
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ADM VName) -&gt; [Char] -&gt; ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Expected single-element pattern: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat
</span><a href="#local-6989586621684465385"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-comment">-- The vast majority of BasicOps require no special treatment in the</span><span>
</span><span id="line-34"></span><span class="hs-comment">-- forward pass and produce one value (and hence one adjoint).  We</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- deal with that case here.</span><span>
</span><span id="line-36"></span><span class="annot"><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-type">commonBasicOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span id="commonBasicOp"><span class="annot"><span class="annottext">commonBasicOp :: Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var hs-var">commonBasicOp</span></a></span></span><span> </span><span id="local-6989586621684465381"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465381"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684465380"><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465380"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684465379"><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465379"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621684465378"><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465378"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><span class="annottext">Stm (Rep ADM) -&gt; ADM ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStm"><span class="hs-identifier hs-var">addStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm (Rep ADM) -&gt; ADM ()) -&gt; Stm (Rep ADM) -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux (ExpDec SOACS) -&gt; Exp SOACS -&gt; Stm SOACS
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465381"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684465380"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; Stm SOACS) -&gt; Exp SOACS -&gt; Stm SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465379"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-39"></span><span>  </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465378"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-40"></span><span>  </span><span id="local-6989586621684465374"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465374"><span class="hs-identifier hs-var">pat_v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; ADM VName
</span><a href="Futhark.AD.Rev.html#patName"><span class="hs-identifier hs-var">patName</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465381"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-41"></span><span>  </span><span id="local-6989586621684465373"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465373"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM VName
</span><a href="Futhark.AD.Rev.Monad.html#lookupAdjVal"><span class="hs-identifier hs-var">lookupAdjVal</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465374"><span class="hs-identifier hs-var">pat_v</span></a></span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><span class="annottext">(VName, VName) -&gt; ADM (VName, VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465374"><span class="hs-identifier hs-var">pat_v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465373"><span class="hs-identifier hs-var">pat_adj</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="annot"><a href="Futhark.AD.Rev.html#diffBasicOp"><span class="hs-identifier hs-type">diffBasicOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span id="diffBasicOp"><span class="annot"><span class="annottext">diffBasicOp :: Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM ()
</span><a href="Futhark.AD.Rev.html#diffBasicOp"><span class="hs-identifier hs-var hs-var">diffBasicOp</span></a></span></span><span> </span><span id="local-6989586621684465370"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684465369"><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684465368"><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684465367"><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#CmpOp"><span class="hs-identifier hs-type">CmpOp</span></a></span><span> </span><span id="local-6989586621684465365"><span class="annot"><span class="annottext">CmpOp
</span><a href="#local-6989586621684465365"><span class="hs-identifier hs-var">cmp</span></a></span></span><span> </span><span id="local-6989586621684465364"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465364"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684465363"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465363"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-48"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465362"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465362"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465361"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465361"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-49"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-50"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684465359"><span class="annot"><span class="annottext">t :: PrimType
</span><a href="#local-6989586621684465359"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CmpOp -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#cmpOpType"><span class="hs-identifier hs-var">cmpOpType</span></a></span><span> </span><span class="annot"><span class="annottext">CmpOp
</span><a href="#local-6989586621684465365"><span class="hs-identifier hs-var">cmp</span></a></span><span>
</span><span id="line-51"></span><span>            </span><span id="local-6989586621684465357"><span class="annot"><span class="annottext">update :: VName -&gt; ADM ()
</span><a href="#local-6989586621684465357"><span class="hs-identifier hs-var hs-var">update</span></a></span></span><span> </span><span id="local-6989586621684465356"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465356"><span class="hs-identifier hs-var">contrib</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-52"></span><span>              </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateSubExpAdj"><span class="hs-identifier hs-var">updateSubExpAdj</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465364"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465356"><span class="hs-identifier hs-var">contrib</span></a></span><span>
</span><span id="line-53"></span><span>              </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateSubExpAdj"><span class="hs-identifier hs-var">updateSubExpAdj</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465363"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465356"><span class="hs-identifier hs-var">contrib</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465359"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-56"></span><span>          </span><span class="annot"><a href="Futhark.IR.Primitive.html#FloatType"><span class="hs-identifier hs-type">FloatType</span></a></span><span> </span><span id="local-6989586621684465352"><span class="annot"><span class="annottext">FloatType
</span><a href="#local-6989586621684465352"><span class="hs-identifier hs-var">ft</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-57"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; ADM ()
</span><a href="#local-6989586621684465357"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ADM ())
-&gt; (Exp SOACS -&gt; ADM VName) -&gt; Exp SOACS -&gt; ADM ()
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;contrib&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM ()) -&gt; Exp SOACS -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-58"></span><span>              </span><span class="annot"><span class="annottext">SubExp
-&gt; BodyT SOACS
-&gt; BodyT SOACS
-&gt; IfDec (BranchType SOACS)
-&gt; Exp SOACS
forall rep.
SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span>
</span><span id="line-59"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465361"><span class="hs-identifier hs-var">pat_adj</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-60"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; BodyT SOACS
forall rep. Buildable rep =&gt; [SubExp] -&gt; Body rep
</span><a href="Futhark.Construct.html#resultBody"><span class="hs-identifier hs-var">resultBody</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FloatValue -&gt; SubExp
forall v. IsValue v =&gt; v -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#constant"><span class="hs-identifier hs-var">constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatType -&gt; Int -&gt; FloatValue
forall num. Real num =&gt; FloatType -&gt; num -&gt; FloatValue
</span><a href="Futhark.IR.Primitive.html#floatValue"><span class="hs-identifier hs-var">floatValue</span></a></span><span> </span><span class="annot"><span class="annottext">FloatType
</span><a href="#local-6989586621684465352"><span class="hs-identifier hs-var">ft</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; BodyT SOACS
forall rep. Buildable rep =&gt; [SubExp] -&gt; Body rep
</span><a href="Futhark.Construct.html#resultBody"><span class="hs-identifier hs-var">resultBody</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">FloatValue -&gt; SubExp
forall v. IsValue v =&gt; v -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#constant"><span class="hs-identifier hs-var">constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatType -&gt; Int -&gt; FloatValue
forall num. Real num =&gt; FloatType -&gt; num -&gt; FloatValue
</span><a href="Futhark.IR.Primitive.html#floatValue"><span class="hs-identifier hs-var">floatValue</span></a></span><span> </span><span class="annot"><span class="annottext">FloatType
</span><a href="#local-6989586621684465352"><span class="hs-identifier hs-var">ft</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ExtType] -&gt; IfSort -&gt; IfDec ExtType
forall rt. [rt] -&gt; IfSort -&gt; IfDec rt
</span><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-var">IfDec</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimType -&gt; ExtType
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#FloatType"><span class="hs-identifier hs-var">FloatType</span></a></span><span> </span><span class="annot"><span class="annottext">FloatType
</span><a href="#local-6989586621684465352"><span class="hs-identifier hs-var">ft</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="Futhark.IR.Syntax.html#IfNormal"><span class="hs-identifier hs-var">IfNormal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>          </span><span class="annot"><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-type">IntType</span></a></span><span> </span><span id="local-6989586621684465340"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684465340"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-64"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; ADM ()
</span><a href="#local-6989586621684465357"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ADM ())
-&gt; (Exp SOACS -&gt; ADM VName) -&gt; Exp SOACS -&gt; ADM ()
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;contrib&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM ()) -&gt; Exp SOACS -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp SOACS) -&gt; BasicOp -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConvOp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#ConvOp"><span class="hs-identifier hs-var">ConvOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; ConvOp
</span><a href="Futhark.IR.Primitive.html#BToI"><span class="hs-identifier hs-var">BToI</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684465340"><span class="hs-identifier hs-var">it</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465361"><span class="hs-identifier hs-var">pat_adj</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>          </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Primitive.html#Bool"><span class="hs-identifier hs-var">Bool</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-66"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; ADM ()
</span><a href="#local-6989586621684465357"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465361"><span class="hs-identifier hs-var">pat_adj</span></a></span><span>
</span><span id="line-67"></span><span>          </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Primitive.html#Unit"><span class="hs-identifier hs-var">Unit</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-68"></span><span>            </span><span class="annot"><span class="annottext">() -&gt; ADM ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-70"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#ConvOp"><span class="hs-identifier hs-type">ConvOp</span></a></span><span> </span><span id="local-6989586621684465335"><span class="annot"><span class="annottext">ConvOp
</span><a href="#local-6989586621684465335"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621684465334"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465334"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-71"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465333"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465333"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465332"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465332"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-72"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-73"></span><span>        </span><span id="local-6989586621684465331"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465331"><span class="hs-identifier hs-var">contrib</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-74"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;contrib&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep ADM) -&gt; ADM VName) -&gt; Exp (Rep ADM) -&gt; ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp SOACS) -&gt; BasicOp -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConvOp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#ConvOp"><span class="hs-identifier hs-var">ConvOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ConvOp -&gt; ConvOp
</span><a href="Futhark.IR.Primitive.html#flipConvOp"><span class="hs-identifier hs-var">flipConvOp</span></a></span><span> </span><span class="annot"><span class="annottext">ConvOp
</span><a href="#local-6989586621684465335"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465332"><span class="hs-identifier hs-var">pat_adj</span></a></span><span>
</span><span id="line-75"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateSubExpAdj"><span class="hs-identifier hs-var">updateSubExpAdj</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465334"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465331"><span class="hs-identifier hs-var">contrib</span></a></span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-77"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#UnOp"><span class="hs-identifier hs-type">UnOp</span></a></span><span> </span><span id="local-6989586621684465328"><span class="annot"><span class="annottext">UnOp
</span><a href="#local-6989586621684465328"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621684465327"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465327"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-78"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465326"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465326"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465325"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465325"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-81"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684465324"><span class="annot"><span class="annottext">t :: PrimType
</span><a href="#local-6989586621684465324"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnOp -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#unOpType"><span class="hs-identifier hs-var">unOpType</span></a></span><span> </span><span class="annot"><span class="annottext">UnOp
</span><a href="#local-6989586621684465328"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-82"></span><span>        </span><span id="local-6989586621684465322"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465322"><span class="hs-identifier hs-var">contrib</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-83"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684465321"><span class="annot"><span class="annottext">x_pe :: PrimExp VName
</span><a href="#local-6989586621684465321"><span class="hs-identifier hs-var hs-var">x_pe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; PrimExp VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#primExpFromSubExp"><span class="hs-identifier hs-var">primExpFromSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465324"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465327"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-84"></span><span>              </span><span id="local-6989586621684465319"><span class="annot"><span class="annottext">pat_adj' :: PrimExp VName
</span><a href="#local-6989586621684465319"><span class="hs-identifier hs-var hs-var">pat_adj'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; PrimExp VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#primExpFromSubExp"><span class="hs-identifier hs-var">primExpFromSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465324"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465325"><span class="hs-identifier hs-var">pat_adj</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>              </span><span id="local-6989586621684465318"><span class="annot"><span class="annottext">dx :: PrimExp VName
</span><a href="#local-6989586621684465318"><span class="hs-identifier hs-var hs-var">dx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UnOp -&gt; PrimExp VName -&gt; PrimExp VName
</span><a href="Futhark.AD.Derivatives.html#pdUnOp"><span class="hs-identifier hs-var">pdUnOp</span></a></span><span> </span><span class="annot"><span class="annottext">UnOp
</span><a href="#local-6989586621684465328"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684465321"><span class="hs-identifier hs-var">x_pe</span></a></span><span>
</span><span id="line-86"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;contrib&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM VName)
-&gt; (PrimExp VName -&gt; ADM (Exp SOACS)) -&gt; PrimExp VName -&gt; ADM VName
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; ADM (Exp SOACS)
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; ADM VName) -&gt; PrimExp VName -&gt; ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684465319"><span class="hs-identifier hs-var">pat_adj'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#~%2A~"><span class="hs-operator hs-var">~*~</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684465318"><span class="hs-identifier hs-var">dx</span></a></span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateSubExpAdj"><span class="hs-identifier hs-var">updateSubExpAdj</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465327"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465322"><span class="hs-identifier hs-var">contrib</span></a></span><span>
</span><span id="line-89"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span id="local-6989586621684465313"><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684465313"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621684465312"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465312"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684465311"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465311"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-91"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465310"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465310"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465309"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465309"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-94"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684465308"><span class="annot"><span class="annottext">t :: PrimType
</span><a href="#local-6989586621684465308"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#binOpType"><span class="hs-identifier hs-var">binOpType</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684465313"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-95"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684465306"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684465306"><span class="hs-identifier hs-var">wrt_x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465305"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684465305"><span class="hs-identifier hs-var">wrt_y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-96"></span><span>              </span><span class="annot"><span class="annottext">BinOp
-&gt; PrimExp VName -&gt; PrimExp VName -&gt; (PrimExp VName, PrimExp VName)
</span><a href="Futhark.AD.Derivatives.html#pdBinOp"><span class="hs-identifier hs-var">pdBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684465313"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; PrimExp VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#primExpFromSubExp"><span class="hs-identifier hs-var">primExpFromSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465308"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465312"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; PrimExp VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#primExpFromSubExp"><span class="hs-identifier hs-var">primExpFromSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465308"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465311"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span>            </span><span id="local-6989586621684465303"><span class="annot"><span class="annottext">pat_adj' :: PrimExp VName
</span><a href="#local-6989586621684465303"><span class="hs-identifier hs-var hs-var">pat_adj'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; PrimExp VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#primExpFromSubExp"><span class="hs-identifier hs-var">primExpFromSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465308"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; PrimExp VName) -&gt; SubExp -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465309"><span class="hs-identifier hs-var">pat_adj</span></a></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span>        </span><span id="local-6989586621684465302"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465302"><span class="hs-identifier hs-var">adj_x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;binop_x_adj&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM VName)
-&gt; (PrimExp VName -&gt; ADM (Exp SOACS)) -&gt; PrimExp VName -&gt; ADM VName
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; ADM (Exp SOACS)
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; ADM VName) -&gt; PrimExp VName -&gt; ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684465303"><span class="hs-identifier hs-var">pat_adj'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#~%2A~"><span class="hs-operator hs-var">~*~</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684465306"><span class="hs-identifier hs-var">wrt_x</span></a></span><span>
</span><span id="line-101"></span><span>        </span><span id="local-6989586621684465301"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465301"><span class="hs-identifier hs-var">adj_y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;binop_y_adj&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM VName)
-&gt; (PrimExp VName -&gt; ADM (Exp SOACS)) -&gt; PrimExp VName -&gt; ADM VName
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; ADM (Exp SOACS)
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; ADM VName) -&gt; PrimExp VName -&gt; ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684465303"><span class="hs-identifier hs-var">pat_adj'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#~%2A~"><span class="hs-operator hs-var">~*~</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684465305"><span class="hs-identifier hs-var">wrt_y</span></a></span><span>
</span><span id="line-102"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateSubExpAdj"><span class="hs-identifier hs-var">updateSubExpAdj</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465312"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465302"><span class="hs-identifier hs-var">adj_x</span></a></span><span>
</span><span id="line-103"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateSubExpAdj"><span class="hs-identifier hs-var">updateSubExpAdj</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465311"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465301"><span class="hs-identifier hs-var">adj_y</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span id="local-6989586621684465299"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465299"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-106"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465298"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465298"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465297"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465297"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-107"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateSubExpAdj"><span class="hs-identifier hs-var">updateSubExpAdj</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465299"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465297"><span class="hs-identifier hs-var">pat_adj</span></a></span><span>
</span><span id="line-108"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-109"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Assert"><span class="hs-identifier hs-type">Assert</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-110"></span><span>      </span><span class="annot"><span class="annottext">ADM (VName, VName) -&gt; ADM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ADM (VName, VName) -&gt; ADM ()) -&gt; ADM (VName, VName) -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-111"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#ArrayLit"><span class="hs-identifier hs-type">ArrayLit</span></a></span><span> </span><span id="local-6989586621684465294"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684465294"><span class="hs-identifier hs-var">elems</span></a></span></span><span> </span><span id="local-6989586621684465293"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684465293"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-113"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465292"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465292"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465291"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465291"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-114"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-115"></span><span>        </span><span class="annot"><span class="annottext">[(Int64, SubExp)] -&gt; ((Int64, SubExp) -&gt; ADM ()) -&gt; ADM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int64] -&gt; [SubExp] -&gt; [(Int64, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684465294"><span class="hs-identifier hs-var">elems</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Int64, SubExp) -&gt; ADM ()) -&gt; ADM ())
-&gt; ((Int64, SubExp) -&gt; ADM ()) -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684465289"><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621684465289"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465288"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465288"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-116"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684465287"><span class="annot"><span class="annottext">slice :: Slice SubExp
</span><a href="#local-6989586621684465287"><span class="hs-identifier hs-var hs-var">slice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [DimIndex SubExp] -&gt; Slice SubExp
</span><a href="Futhark.Construct.html#fullSlice"><span class="hs-identifier hs-var">fullSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684465293"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp -&gt; DimIndex SubExp
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64 -&gt; SubExp
forall v. IsValue v =&gt; v -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#constant"><span class="hs-identifier hs-var">constant</span></a></span><span> </span><span class="annot"><span class="annottext">Int64
</span><a href="#local-6989586621684465289"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-117"></span><span>          </span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateSubExpAdj"><span class="hs-identifier hs-var">updateSubExpAdj</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465288"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ADM ())
-&gt; (Exp SOACS -&gt; ADM VName) -&gt; Exp SOACS -&gt; ADM ()
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;elem_adj&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM ()) -&gt; Exp SOACS -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp SOACS) -&gt; BasicOp -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465291"><span class="hs-identifier hs-var">pat_adj</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684465287"><span class="hs-identifier hs-var">slice</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-119"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span id="local-6989586621684465283"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465283"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684465282"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684465282"><span class="hs-identifier hs-var">slice</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-120"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465281"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465281"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465280"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465280"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-121"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-122"></span><span>        </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; VName -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateAdjSlice"><span class="hs-identifier hs-var">updateAdjSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684465282"><span class="hs-identifier hs-var">slice</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465283"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465280"><span class="hs-identifier hs-var">pat_adj</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#FlatIndex"><span class="hs-identifier hs-type">FlatIndex</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ADM ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;FlatIndex not handled by AD yet.&quot;</span></span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#FlatUpdate"><span class="hs-identifier hs-type">FlatUpdate</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ADM ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;FlatUpdate not handled by AD yet.&quot;</span></span><span>
</span><span id="line-125"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-126"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Opaque"><span class="hs-identifier hs-type">Opaque</span></a></span><span> </span><span class="annot"><span class="annottext">OpaqueOp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684465275"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465275"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-127"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465274"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465274"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465273"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465273"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-128"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateSubExpAdj"><span class="hs-identifier hs-var">updateSubExpAdj</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465275"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465273"><span class="hs-identifier hs-var">pat_adj</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-130"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Reshape"><span class="hs-identifier hs-type">Reshape</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684465271"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465271"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-131"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465270"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465270"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465269"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465269"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-132"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>        </span><span id="local-6989586621684465268"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684465268"><span class="hs-identifier hs-var">arr_dims</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase (ShapeBase SubExp) u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; [SubExp]) -&gt; ADM Type -&gt; ADM [SubExp]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465271"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-134"></span><span>        </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-135"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateAdj"><span class="hs-identifier hs-var">updateAdj</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465271"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ADM ())
-&gt; (Exp SOACS -&gt; ADM VName) -&gt; Exp SOACS -&gt; ADM ()
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;adj_reshape&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM ()) -&gt; Exp SOACS -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-136"></span><span>            </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp SOACS) -&gt; BasicOp -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Reshape"><span class="hs-identifier hs-var">Reshape</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; DimChange SubExp) -&gt; [SubExp] -&gt; ShapeChange SubExp
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; DimChange SubExp
forall d. d -&gt; DimChange d
</span><a href="Futhark.IR.Syntax.html#DimNew"><span class="hs-identifier hs-var">DimNew</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684465268"><span class="hs-identifier hs-var">arr_dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465269"><span class="hs-identifier hs-var">pat_adj</span></a></span><span>
</span><span id="line-137"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-type">Rearrange</span></a></span><span> </span><span id="local-6989586621684465261"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684465261"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684465260"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465260"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-139"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465259"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465259"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465258"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465258"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-140"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-141"></span><span>        </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-142"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateAdj"><span class="hs-identifier hs-var">updateAdj</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465260"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ADM ())
-&gt; (Exp SOACS -&gt; ADM VName) -&gt; Exp SOACS -&gt; ADM ()
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;adj_rearrange&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM ()) -&gt; Exp SOACS -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-143"></span><span>            </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp SOACS) -&gt; BasicOp -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-var">Rearrange</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; [Int]
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeInverse"><span class="hs-identifier hs-var">rearrangeInverse</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684465261"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465258"><span class="hs-identifier hs-var">pat_adj</span></a></span><span>
</span><span id="line-144"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-145"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Rotate"><span class="hs-identifier hs-type">Rotate</span></a></span><span> </span><span id="local-6989586621684465255"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684465255"><span class="hs-identifier hs-var">rots</span></a></span></span><span> </span><span id="local-6989586621684465254"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465254"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-146"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465253"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465253"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465252"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465252"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-147"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-148"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684465251"><span class="annot"><span class="annottext">neg :: SubExp -&gt; ExpT rep
</span><a href="#local-6989586621684465251"><span class="hs-identifier hs-var hs-var">neg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; (SubExp -&gt; BasicOp) -&gt; SubExp -&gt; ExpT rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Sub"><span class="hs-identifier hs-var">Sub</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowWrap"><span class="hs-identifier hs-var">OverflowWrap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>        </span><span id="local-6989586621684465245"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684465245"><span class="hs-identifier hs-var">rots'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; ADM SubExp) -&gt; [SubExp] -&gt; ADM [SubExp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;rot_neg&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM SubExp)
-&gt; (SubExp -&gt; Exp SOACS) -&gt; SubExp -&gt; ADM SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Exp SOACS
forall {rep}. SubExp -&gt; ExpT rep
</span><a href="#local-6989586621684465251"><span class="hs-identifier hs-var">neg</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684465255"><span class="hs-identifier hs-var">rots</span></a></span><span>
</span><span id="line-150"></span><span>        </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-151"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateAdj"><span class="hs-identifier hs-var">updateAdj</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465254"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ADM ())
-&gt; (Exp SOACS -&gt; ADM VName) -&gt; Exp SOACS -&gt; ADM ()
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;adj_rotate&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM ()) -&gt; Exp SOACS -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-152"></span><span>            </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp SOACS) -&gt; BasicOp -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Rotate"><span class="hs-identifier hs-var">Rotate</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684465245"><span class="hs-identifier hs-var">rots'</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465252"><span class="hs-identifier hs-var">pat_adj</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-154"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span id="local-6989586621684465240"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684465240"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684465239"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465239"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-155"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465238"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465238"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465237"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465237"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-156"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-157"></span><span>        </span><span id="local-6989586621684465236"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684465236"><span class="hs-identifier hs-var">x_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ADM Type
forall t (m :: * -&gt; *). HasScope t m =&gt; SubExp -&gt; m Type
</span><a href="Futhark.IR.Prop.TypeOf.html#subExpType"><span class="hs-identifier hs-var">subExpType</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465239"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-158"></span><span>        </span><span id="local-6989586621684465234"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684465234"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ADM Lambda
</span><a href="Futhark.AD.Rev.Monad.html#addLambda"><span class="hs-identifier hs-var">addLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684465236"><span class="hs-identifier hs-var">x_t</span></a></span><span>
</span><span id="line-159"></span><span>        </span><span id="local-6989586621684465232"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465232"><span class="hs-identifier hs-var">ne</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;zero&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep ADM) -&gt; ADM SubExp) -&gt; Exp (Rep ADM) -&gt; ADM SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Exp SOACS
forall rep. Type -&gt; ExpT rep
</span><a href="Futhark.AD.Rev.Monad.html#zeroExp"><span class="hs-identifier hs-var">zeroExp</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684465236"><span class="hs-identifier hs-var">x_t</span></a></span><span>
</span><span id="line-160"></span><span>        </span><span id="local-6989586621684465230"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465230"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;rep_size&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM SubExp) -&gt; ADM (Exp SOACS) -&gt; ADM SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; [SubExp] -&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
BinOp -&gt; SubExp -&gt; [SubExp] -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#foldBinOp"><span class="hs-identifier hs-var">foldBinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Mul"><span class="hs-identifier hs-var">Mul</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684465240"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-161"></span><span>        </span><span id="local-6989586621684465225"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465225"><span class="hs-identifier hs-var">pat_adj_flat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-162"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [Char]
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465237"><span class="hs-identifier hs-var">pat_adj</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_flat&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep ADM) -&gt; ADM VName) -&gt; Exp (Rep ADM) -&gt; ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-163"></span><span>            </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp SOACS) -&gt; BasicOp -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange SubExp -&gt; VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Reshape"><span class="hs-identifier hs-var">Reshape</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; DimChange SubExp) -&gt; [SubExp] -&gt; ShapeChange SubExp
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; DimChange SubExp
forall d. d -&gt; DimChange d
</span><a href="Futhark.IR.Syntax.html#DimNew"><span class="hs-identifier hs-var">DimNew</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; ShapeChange SubExp) -&gt; [SubExp] -&gt; ShapeChange SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465230"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [SubExp] -&gt; [SubExp]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase (ShapeBase SubExp) u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684465236"><span class="hs-identifier hs-var">x_t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465237"><span class="hs-identifier hs-var">pat_adj</span></a></span><span>
</span><span id="line-164"></span><span>        </span><span id="local-6989586621684465223"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684465223"><span class="hs-identifier hs-var">reduce</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS] -&gt; ADM (ScremaForm SOACS)
forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m) =&gt;
[Reduce rep] -&gt; m (ScremaForm rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#reduceSOAC"><span class="hs-identifier hs-var">reduceSOAC</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Commutativity -&gt; Lambda -&gt; [SubExp] -&gt; Reduce SOACS
forall rep. Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Reduce rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-var">Reduce</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684465234"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465232"><span class="hs-identifier hs-var">ne</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-165"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateSubExpAdj"><span class="hs-identifier hs-var">updateSubExpAdj</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465239"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-166"></span><span>          </span><span class="annot"><span class="annottext">(VName -&gt; ADM ()) -&gt; ADM VName -&gt; ADM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;rep_contrib&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Op SOACS -&gt; Exp SOACS
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op SOACS -&gt; Exp SOACS) -&gt; Op SOACS -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ScremaForm SOACS -&gt; SOAC SOACS
forall rep. SubExp -&gt; [VName] -&gt; ScremaForm rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-var">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465230"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465225"><span class="hs-identifier hs-var">pat_adj_flat</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684465223"><span class="hs-identifier hs-var">reduce</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-168"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Concat"><span class="hs-identifier hs-type">Concat</span></a></span><span> </span><span id="local-6989586621684465216"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684465216"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621684465215"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465215"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684465214"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465214"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-169"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465213"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465213"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465212"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465212"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-170"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684465211"><span class="annot"><span class="annottext">sliceAdj :: SubExp -&gt; [VName] -&gt; ADM [VName]
</span><a href="#local-6989586621684465211"><span class="hs-identifier hs-var hs-var">sliceAdj</span></a></span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; ADM [VName]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-172"></span><span>            </span><span class="annot"><a href="#local-6989586621684465211"><span class="hs-identifier hs-var">sliceAdj</span></a></span><span> </span><span id="local-6989586621684465210"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465210"><span class="hs-identifier hs-var">start</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684465209"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465209"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684465208"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465208"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-173"></span><span>              </span><span id="local-6989586621684465207"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684465207"><span class="hs-identifier hs-var">v_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465209"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-174"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684465206"><span class="annot"><span class="annottext">w :: SubExp
</span><a href="#local-6989586621684465206"><span class="hs-identifier hs-var hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Type -&gt; SubExp
forall u. Int -&gt; TypeBase (ShapeBase SubExp) u -&gt; SubExp
</span><a href="Futhark.IR.Prop.Types.html#arraySize"><span class="hs-identifier hs-var">arraySize</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684465207"><span class="hs-identifier hs-var">v_t</span></a></span><span>
</span><span id="line-175"></span><span>                  </span><span id="local-6989586621684465204"><span class="annot"><span class="annottext">slice :: DimIndex SubExp
</span><a href="#local-6989586621684465204"><span class="hs-identifier hs-var hs-var">slice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp -&gt; DimIndex SubExp
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465210"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465206"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>              </span><span id="local-6989586621684465202"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465202"><span class="hs-identifier hs-var">pat_adj_slice</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-177"></span><span>                </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [Char]
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465212"><span class="hs-identifier hs-var">pat_adj</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_slice&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep ADM) -&gt; ADM VName) -&gt; Exp (Rep ADM) -&gt; ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-178"></span><span>                  </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp SOACS) -&gt; BasicOp -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465212"><span class="hs-identifier hs-var">pat_adj</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Int -&gt; [DimIndex SubExp] -&gt; Slice SubExp
</span><a href="Futhark.Construct.html#sliceAt"><span class="hs-identifier hs-var">sliceAt</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684465207"><span class="hs-identifier hs-var">v_t</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684465216"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DimIndex SubExp
</span><a href="#local-6989586621684465204"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-179"></span><span>              </span><span id="local-6989586621684465200"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465200"><span class="hs-identifier hs-var">start'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;start&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep ADM) -&gt; ADM SubExp) -&gt; Exp (Rep ADM) -&gt; ADM SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp SOACS) -&gt; BasicOp -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Add"><span class="hs-identifier hs-var">Add</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465210"><span class="hs-identifier hs-var">start</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465206"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-180"></span><span>              </span><span id="local-6989586621684465198"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465198"><span class="hs-identifier hs-var">slices</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ADM [VName]
</span><a href="#local-6989586621684465211"><span class="hs-identifier hs-var">sliceAdj</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465200"><span class="hs-identifier hs-var">start'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465208"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-181"></span><span>              </span><span class="annot"><span class="annottext">[VName] -&gt; ADM [VName]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; ADM [VName]) -&gt; [VName] -&gt; ADM [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465202"><span class="hs-identifier hs-var">pat_adj_slice</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465198"><span class="hs-identifier hs-var">slices</span></a></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span>        </span><span id="local-6989586621684465197"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465197"><span class="hs-identifier hs-var">slices</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ADM [VName]
</span><a href="#local-6989586621684465211"><span class="hs-identifier hs-var">sliceAdj</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; ADM [VName]) -&gt; [VName] -&gt; ADM [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465215"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465214"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-184"></span><span>
</span><span id="line-185"></span><span>        </span><span class="annot"><span class="annottext">(VName -&gt; VName -&gt; ADM ()) -&gt; [VName] -&gt; [VName] -&gt; ADM ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateAdj"><span class="hs-identifier hs-var">updateAdj</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465215"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465214"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465197"><span class="hs-identifier hs-var">slices</span></a></span><span>
</span><span id="line-186"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-187"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-type">Copy</span></a></span><span> </span><span id="local-6989586621684465194"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465194"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-188"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465193"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465193"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465192"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465192"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-189"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateAdj"><span class="hs-identifier hs-var">updateAdj</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465194"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465192"><span class="hs-identifier hs-var">pat_adj</span></a></span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Manifest"><span class="hs-identifier hs-type">Manifest</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684465190"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465190"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-192"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465189"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465189"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465188"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465188"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-193"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateAdj"><span class="hs-identifier hs-var">updateAdj</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465190"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465188"><span class="hs-identifier hs-var">pat_adj</span></a></span><span>
</span><span id="line-194"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-195"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Scratch"><span class="hs-identifier hs-type">Scratch</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-196"></span><span>      </span><span class="annot"><span class="annottext">ADM (VName, VName) -&gt; ADM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ADM (VName, VName) -&gt; ADM ()) -&gt; ADM (VName, VName) -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-197"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-198"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Iota"><span class="hs-identifier hs-type">Iota</span></a></span><span> </span><span id="local-6989586621684465185"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465185"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684465184"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684465184"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-199"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465183"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465183"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465182"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465182"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-200"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-201"></span><span>        </span><span id="local-6989586621684465181"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465181"><span class="hs-identifier hs-var">ne</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;zero&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep ADM) -&gt; ADM SubExp) -&gt; Exp (Rep ADM) -&gt; ADM SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Exp SOACS
forall rep. Type -&gt; ExpT rep
</span><a href="Futhark.AD.Rev.Monad.html#zeroExp"><span class="hs-identifier hs-var">zeroExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Exp SOACS) -&gt; Type -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; Type) -&gt; PrimType -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684465184"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-202"></span><span>        </span><span id="local-6989586621684465180"><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684465180"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; ADM Lambda
</span><a href="Futhark.AD.Rev.Monad.html#addLambda"><span class="hs-identifier hs-var">addLambda</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; ADM Lambda) -&gt; Type -&gt; ADM Lambda
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; Type) -&gt; PrimType -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684465184"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-203"></span><span>        </span><span id="local-6989586621684465179"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684465179"><span class="hs-identifier hs-var">reduce</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS] -&gt; ADM (ScremaForm SOACS)
forall rep (m :: * -&gt; *).
(Buildable rep, MonadFreshNames m) =&gt;
[Reduce rep] -&gt; m (ScremaForm rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#reduceSOAC"><span class="hs-identifier hs-var">reduceSOAC</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Commutativity -&gt; Lambda -&gt; [SubExp] -&gt; Reduce SOACS
forall rep. Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Reduce rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-var">Reduce</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda
</span><a href="#local-6989586621684465180"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465181"><span class="hs-identifier hs-var">ne</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-204"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateSubExpAdj"><span class="hs-identifier hs-var">updateSubExpAdj</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465185"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-205"></span><span>          </span><span class="annot"><span class="annottext">(VName -&gt; ADM ()) -&gt; ADM VName -&gt; ADM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;iota_contrib&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Op SOACS -&gt; Exp SOACS
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op SOACS -&gt; Exp SOACS) -&gt; Op SOACS -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; [VName] -&gt; ScremaForm SOACS -&gt; SOAC SOACS
forall rep. SubExp -&gt; [VName] -&gt; ScremaForm rep -&gt; SOAC rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-var">Screma</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465185"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465182"><span class="hs-identifier hs-var">pat_adj</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684465179"><span class="hs-identifier hs-var">reduce</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span id="local-6989586621684465177"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684465177"><span class="hs-identifier hs-var">safety</span></a></span></span><span> </span><span id="local-6989586621684465176"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465176"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684465175"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684465175"><span class="hs-identifier hs-var">slice</span></a></span></span><span> </span><span id="local-6989586621684465174"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465174"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684465173"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465173"><span class="hs-identifier hs-var">_pat_v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465172"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465172"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM (VName, VName)
</span><a href="Futhark.AD.Rev.html#commonBasicOp"><span class="hs-identifier hs-var">commonBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465370"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
</span><a href="#local-6989586621684465369"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465368"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465367"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-209"></span><span>      </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-210"></span><span>        </span><span id="local-6989586621684465171"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465171"><span class="hs-identifier hs-var">v_adj</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;update_val_adj&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep ADM) -&gt; ADM VName) -&gt; Exp (Rep ADM) -&gt; ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp SOACS) -&gt; BasicOp -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465172"><span class="hs-identifier hs-var">pat_adj</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684465175"><span class="hs-identifier hs-var">slice</span></a></span><span>
</span><span id="line-211"></span><span>        </span><span id="local-6989586621684465170"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684465170"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465171"><span class="hs-identifier hs-var">v_adj</span></a></span><span>
</span><span id="line-212"></span><span>        </span><span id="local-6989586621684465169"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465169"><span class="hs-identifier hs-var">v_adj_copy</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-213"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684465170"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-214"></span><span>            </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;update_val_adj_copy&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep ADM) -&gt; ADM VName) -&gt; Exp (Rep ADM) -&gt; ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp SOACS) -&gt; BasicOp -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-var">Copy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465171"><span class="hs-identifier hs-var">v_adj</span></a></span><span>
</span><span id="line-215"></span><span>            </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465171"><span class="hs-identifier hs-var">v_adj</span></a></span><span>
</span><span id="line-216"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateSubExpAdj"><span class="hs-identifier hs-var">updateSubExpAdj</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465174"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465169"><span class="hs-identifier hs-var">v_adj_copy</span></a></span><span>
</span><span id="line-217"></span><span>        </span><span id="local-6989586621684465167"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465167"><span class="hs-identifier hs-var">zeroes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;update_zero&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM SubExp)
-&gt; (Type -&gt; Exp SOACS) -&gt; Type -&gt; ADM SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Exp SOACS
forall rep. Type -&gt; ExpT rep
</span><a href="Futhark.AD.Rev.Monad.html#zeroExp"><span class="hs-identifier hs-var">zeroExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; ADM SubExp) -&gt; ADM Type -&gt; ADM SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ADM Type
forall t (m :: * -&gt; *). HasScope t m =&gt; SubExp -&gt; m Type
</span><a href="Futhark.IR.Prop.TypeOf.html#subExpType"><span class="hs-identifier hs-var">subExpType</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465174"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-218"></span><span>        </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-219"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateAdj"><span class="hs-identifier hs-var">updateAdj</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465176"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-220"></span><span>            </span><span class="annot"><span class="annottext">(VName -&gt; ADM ()) -&gt; ADM VName -&gt; ADM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;update_src_adj&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BasicOp -&gt; Exp SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp SOACS) -&gt; BasicOp -&gt; Exp SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Safety -&gt; VName -&gt; Slice SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-var">Update</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684465177"><span class="hs-identifier hs-var">safety</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465172"><span class="hs-identifier hs-var">pat_adj</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684465175"><span class="hs-identifier hs-var">slice</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465167"><span class="hs-identifier hs-var">zeroes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#UpdateAcc"><span class="hs-identifier hs-type">UpdateAcc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ADM ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Reverse-mode UpdateAcc not handled yet.&quot;</span></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span class="annot"><a href="Futhark.AD.Rev.html#vjpOps"><span class="hs-identifier hs-type">vjpOps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#VjpOps"><span class="hs-identifier hs-type">VjpOps</span></a></span><span>
</span><span id="line-224"></span><span id="vjpOps"><span class="annot"><span class="annottext">vjpOps :: VjpOps
</span><a href="Futhark.AD.Rev.html#vjpOps"><span class="hs-identifier hs-var hs-var">vjpOps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([Adj] -&gt; [VName] -&gt; Lambda -&gt; ADM Lambda)
-&gt; (Stm SOACS -&gt; ADM () -&gt; ADM ()) -&gt; VjpOps
</span><a href="Futhark.AD.Rev.Monad.html#VjpOps"><span class="hs-identifier hs-var">VjpOps</span></a></span><span> </span><span class="annot"><span class="annottext">[Adj] -&gt; [VName] -&gt; Lambda -&gt; ADM Lambda
</span><a href="Futhark.AD.Rev.html#diffLambda"><span class="hs-identifier hs-var">diffLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Stm SOACS -&gt; ADM () -&gt; ADM ()
</span><a href="Futhark.AD.Rev.html#diffStm"><span class="hs-identifier hs-var">diffStm</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="annot"><a href="Futhark.AD.Rev.html#diffStm"><span class="hs-identifier hs-type">diffStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-227"></span><span id="diffStm"><span class="annot"><span class="annottext">diffStm :: Stm SOACS -&gt; ADM () -&gt; ADM ()
</span><a href="Futhark.AD.Rev.html#diffStm"><span class="hs-identifier hs-var hs-var">diffStm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684465160"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465160"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684465159"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684465159"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span id="local-6989586621684465158"><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465158"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684465157"><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465157"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-228"></span><span>  </span><span class="annot"><span class="annottext">Pat -&gt; StmAux () -&gt; BasicOp -&gt; ADM () -&gt; ADM ()
</span><a href="Futhark.AD.Rev.html#diffBasicOp"><span class="hs-identifier hs-var">diffBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465160"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684465159"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684465158"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465157"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-229"></span><span class="annot"><a href="Futhark.AD.Rev.html#diffStm"><span class="hs-identifier hs-var">diffStm</span></a></span><span> </span><span id="local-6989586621684465156"><span class="annot"><span class="annottext">stm :: Stm SOACS
</span><a href="#local-6989586621684465156"><span class="hs-identifier hs-var">stm</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684465155"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465155"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621684465153"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684465153"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684465152"><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684465152"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="annot"><span class="annottext">[RetType SOACS]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">(Safety, SrcLoc, [SrcLoc])
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684465151"><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465151"><span class="hs-identifier hs-var">m</span></a></span></span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684465150"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465150"><span class="hs-identifier hs-var">ret</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465149"><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684465149"><span class="hs-identifier hs-var">argts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name
-&gt; Map Name (PrimType, [PrimType]) -&gt; Maybe (PrimType, [PrimType])
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684465153"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (PrimType, [PrimType])
</span><a href="Futhark.IR.Prop.html#builtInFunctions"><span class="hs-identifier hs-var">builtInFunctions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-231"></span><span>    </span><span class="annot"><span class="annottext">Stm (Rep ADM) -&gt; ADM ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStm"><span class="hs-identifier hs-var">addStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Rep ADM)
Stm SOACS
</span><a href="#local-6989586621684465156"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465151"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span>    </span><span id="local-6989586621684465146"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465146"><span class="hs-identifier hs-var">pat_adj</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM VName
</span><a href="Futhark.AD.Rev.Monad.html#lookupAdjVal"><span class="hs-identifier hs-var">lookupAdjVal</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ADM VName) -&gt; ADM VName -&gt; ADM VName
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Pat -&gt; ADM VName
</span><a href="Futhark.AD.Rev.html#patName"><span class="hs-identifier hs-var">patName</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465155"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-235"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684465145"><span class="annot"><span class="annottext">arg_pes :: [PrimExp VName]
</span><a href="#local-6989586621684465145"><span class="hs-identifier hs-var hs-var">arg_pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; SubExp -&gt; PrimExp VName)
-&gt; [PrimType] -&gt; [SubExp] -&gt; [PrimExp VName]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; PrimExp VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#primExpFromSubExp"><span class="hs-identifier hs-var">primExpFromSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684465149"><span class="hs-identifier hs-var">argts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((SubExp, Diet) -&gt; SubExp) -&gt; [(SubExp, Diet)] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubExp, Diet) -&gt; SubExp
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684465152"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>        </span><span id="local-6989586621684465143"><span class="annot"><span class="annottext">pat_adj' :: PrimExp VName
</span><a href="#local-6989586621684465143"><span class="hs-identifier hs-var hs-var">pat_adj'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; PrimExp VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#primExpFromSubExp"><span class="hs-identifier hs-var">primExpFromSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465150"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465146"><span class="hs-identifier hs-var">pat_adj</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>        </span><span id="local-6989586621684465131"><span class="annot"><span class="annottext">convert :: PrimType -&gt; PrimType -&gt; PrimExp v -&gt; PrimExp v
</span><a href="#local-6989586621684465131"><span class="hs-identifier hs-var hs-var">convert</span></a></span></span><span> </span><span id="local-6989586621684465130"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465130"><span class="hs-identifier hs-var">ft</span></a></span></span><span> </span><span id="local-6989586621684465129"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465129"><span class="hs-identifier hs-var">tt</span></a></span></span><span>
</span><span id="line-238"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465130"><span class="hs-identifier hs-var">ft</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; PrimType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465129"><span class="hs-identifier hs-var">tt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimExp v -&gt; PrimExp v
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-239"></span><span>        </span><span class="annot"><a href="#local-6989586621684465131"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-type">IntType</span></a></span><span> </span><span id="local-6989586621684465127"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684465127"><span class="hs-identifier hs-var">ft</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-type">IntType</span></a></span><span> </span><span id="local-6989586621684465126"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684465126"><span class="hs-identifier hs-var">tt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-240"></span><span>          </span><span class="annot"><span class="annottext">ConvOp -&gt; PrimExp v -&gt; PrimExp v
forall v. ConvOp -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#ConvOpExp"><span class="hs-identifier hs-var">ConvOpExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; IntType -&gt; ConvOp
</span><a href="Futhark.IR.Primitive.html#SExt"><span class="hs-identifier hs-var">SExt</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684465127"><span class="hs-identifier hs-var">ft</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684465126"><span class="hs-identifier hs-var">tt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-241"></span><span>        </span><span class="annot"><a href="#local-6989586621684465131"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#FloatType"><span class="hs-identifier hs-type">FloatType</span></a></span><span> </span><span id="local-6989586621684465123"><span class="annot"><span class="annottext">FloatType
</span><a href="#local-6989586621684465123"><span class="hs-identifier hs-var">ft</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#FloatType"><span class="hs-identifier hs-type">FloatType</span></a></span><span> </span><span id="local-6989586621684465122"><span class="annot"><span class="annottext">FloatType
</span><a href="#local-6989586621684465122"><span class="hs-identifier hs-var">tt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-242"></span><span>          </span><span class="annot"><span class="annottext">ConvOp -&gt; PrimExp v -&gt; PrimExp v
forall v. ConvOp -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#ConvOpExp"><span class="hs-identifier hs-var">ConvOpExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatType -&gt; FloatType -&gt; ConvOp
</span><a href="Futhark.IR.Primitive.html#FPConv"><span class="hs-identifier hs-var">FPConv</span></a></span><span> </span><span class="annot"><span class="annottext">FloatType
</span><a href="#local-6989586621684465123"><span class="hs-identifier hs-var">ft</span></a></span><span> </span><span class="annot"><span class="annottext">FloatType
</span><a href="#local-6989586621684465122"><span class="hs-identifier hs-var">tt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>        </span><span class="annot"><a href="#local-6989586621684465131"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span id="local-6989586621684465120"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465120"><span class="hs-identifier hs-var">ft</span></a></span></span><span> </span><span id="local-6989586621684465119"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465119"><span class="hs-identifier hs-var">tt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-244"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; PrimExp v -&gt; PrimExp v
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; PrimExp v -&gt; PrimExp v)
-&gt; [Char] -&gt; PrimExp v -&gt; PrimExp v
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;diffStm.convert: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(PrimType, PrimType) -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465120"><span class="hs-identifier hs-var">ft</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465119"><span class="hs-identifier hs-var">tt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span>    </span><span id="local-6989586621684465118"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465118"><span class="hs-identifier hs-var">contribs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-247"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [PrimExp VName] -&gt; Maybe [PrimExp VName]
</span><a href="Futhark.AD.Derivatives.html#pdBuiltin"><span class="hs-identifier hs-var">pdBuiltin</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684465153"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimExp VName]
</span><a href="#local-6989586621684465145"><span class="hs-identifier hs-var">arg_pes</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-248"></span><span>        </span><span class="annot"><span class="annottext">Maybe [PrimExp VName]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-249"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; ADM [VName]
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ADM [VName]) -&gt; [Char] -&gt; ADM [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;No partial derivative defined for builtin function: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684465153"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-250"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684465116"><span class="annot"><span class="annottext">[PrimExp VName]
</span><a href="#local-6989586621684465116"><span class="hs-identifier hs-var">derivs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-251"></span><span>          </span><span class="annot"><span class="annottext">[(PrimExp VName, PrimType)]
-&gt; ((PrimExp VName, PrimType) -&gt; ADM VName) -&gt; ADM [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PrimExp VName] -&gt; [PrimType] -&gt; [(PrimExp VName, PrimType)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PrimExp VName]
</span><a href="#local-6989586621684465116"><span class="hs-identifier hs-var">derivs</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684465149"><span class="hs-identifier hs-var">argts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PrimExp VName, PrimType) -&gt; ADM VName) -&gt; ADM [VName])
-&gt; ((PrimExp VName, PrimType) -&gt; ADM VName) -&gt; ADM [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684465114"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684465114"><span class="hs-identifier hs-var">deriv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465113"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465113"><span class="hs-identifier hs-var">argt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-252"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;contrib&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM VName)
-&gt; (PrimExp VName -&gt; ADM (Exp SOACS)) -&gt; PrimExp VName -&gt; ADM VName
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; ADM (Exp SOACS)
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; ADM (Exp SOACS))
-&gt; (PrimExp VName -&gt; PrimExp VName)
-&gt; PrimExp VName
-&gt; ADM (Exp SOACS)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; PrimType -&gt; PrimExp VName -&gt; PrimExp VName
forall {v}. PrimType -&gt; PrimType -&gt; PrimExp v -&gt; PrimExp v
</span><a href="#local-6989586621684465131"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465150"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684465113"><span class="hs-identifier hs-var">argt</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; ADM VName) -&gt; PrimExp VName -&gt; ADM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684465143"><span class="hs-identifier hs-var">pat_adj'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#~%2A~"><span class="hs-operator hs-var">~*~</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684465114"><span class="hs-identifier hs-var">deriv</span></a></span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span>    </span><span class="annot"><span class="annottext">(SubExp -&gt; VName -&gt; ADM ()) -&gt; [SubExp] -&gt; [VName] -&gt; ADM ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateSubExpAdj"><span class="hs-identifier hs-var">updateSubExpAdj</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((SubExp, Diet) -&gt; SubExp) -&gt; [(SubExp, Diet)] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubExp, Diet) -&gt; SubExp
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684465152"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465118"><span class="hs-identifier hs-var">contribs</span></a></span><span>
</span><span id="line-255"></span><span class="annot"><a href="Futhark.AD.Rev.html#diffStm"><span class="hs-identifier hs-var">diffStm</span></a></span><span> </span><span id="local-6989586621684465112"><span class="annot"><span class="annottext">stm :: Stm SOACS
</span><a href="#local-6989586621684465112"><span class="hs-identifier hs-var">stm</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684465111"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465111"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span id="local-6989586621684465110"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465110"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684465109"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684465109"><span class="hs-identifier hs-var">tbody</span></a></span></span><span> </span><span id="local-6989586621684465108"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684465108"><span class="hs-identifier hs-var">fbody</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType SOACS)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684465107"><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465107"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>  </span><span class="annot"><span class="annottext">Stm (Rep ADM) -&gt; ADM ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStm"><span class="hs-identifier hs-var">addStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Rep ADM)
Stm SOACS
</span><a href="#local-6989586621684465112"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465107"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#returnSweepCode"><span class="hs-identifier hs-var">returnSweepCode</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-259"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684465106"><span class="annot"><span class="annottext">tbody_free :: Names
</span><a href="#local-6989586621684465106"><span class="hs-identifier hs-var hs-var">tbody_free</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684465109"><span class="hs-identifier hs-var">tbody</span></a></span><span>
</span><span id="line-260"></span><span>        </span><span id="local-6989586621684465104"><span class="annot"><span class="annottext">fbody_free :: Names
</span><a href="#local-6989586621684465104"><span class="hs-identifier hs-var hs-var">fbody_free</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684465108"><span class="hs-identifier hs-var">fbody</span></a></span><span>
</span><span id="line-261"></span><span>        </span><span id="local-6989586621684465103"><span class="annot"><span class="annottext">branches_free :: [VName]
</span><a href="#local-6989586621684465103"><span class="hs-identifier hs-var hs-var">branches_free</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; [VName]) -&gt; Names -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684465106"><span class="hs-identifier hs-var">tbody_free</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684465104"><span class="hs-identifier hs-var">fbody_free</span></a></span><span>
</span><span id="line-262"></span><span>
</span><span id="line-263"></span><span>    </span><span id="local-6989586621684465101"><span class="annot"><span class="annottext">[Adj]
</span><a href="#local-6989586621684465101"><span class="hs-identifier hs-var">adjs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ADM Adj) -&gt; [VName] -&gt; ADM [Adj]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM Adj
</span><a href="Futhark.AD.Rev.Monad.html#lookupAdj"><span class="hs-identifier hs-var">lookupAdj</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; ADM [Adj]) -&gt; [VName] -&gt; ADM [Adj]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT Type -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT Type
Pat
</span><a href="#local-6989586621684465111"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span>    </span><span id="local-6989586621684465098"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465098"><span class="hs-identifier hs-var">branches_free_adj</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-266"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; ADM [VName]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; ADM [VName])
-&gt; ([VName] -&gt; [VName]) -&gt; [VName] -&gt; ADM [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; [VName]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#takeLast"><span class="hs-identifier hs-var">takeLast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465103"><span class="hs-identifier hs-var">branches_free</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>          </span><span class="annot"><span class="annottext">([VName] -&gt; ADM [VName])
-&gt; (Exp SOACS -&gt; ADM [VName]) -&gt; Exp SOACS -&gt; ADM [VName]
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep ADM) -&gt; ADM [VName]
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m [VName]
</span><a href="Futhark.Construct.html#letTupExp"><span class="hs-identifier hs-var">letTupExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;branch_adj&quot;</span></span><span>
</span><span id="line-268"></span><span>          </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM [VName])
-&gt; (Exp SOACS -&gt; ADM (Exp SOACS)) -&gt; Exp SOACS -&gt; ADM [VName]
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">Exp SOACS -&gt; ADM (Exp SOACS)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Exp rep -&gt; m (Exp rep)
</span><a href="Futhark.Transform.Rename.html#renameExp"><span class="hs-identifier hs-var">renameExp</span></a></span><span>
</span><span id="line-269"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-270"></span><span>        </span><span class="annot"><span class="annottext">(Exp SOACS -&gt; ADM [VName]) -&gt; ADM (Exp SOACS) -&gt; ADM [VName]
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">ADM (Exp (Rep ADM))
-&gt; ADM (Body (Rep ADM))
-&gt; ADM (Body (Rep ADM))
-&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *).
(MonadBuilder m, BranchType (Rep m) ~ ExtType) =&gt;
m (Exp (Rep m))
-&gt; m (Body (Rep m)) -&gt; m (Body (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eIf"><span class="hs-identifier hs-var">eIf</span></a></span><span>
</span><span id="line-271"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; ADM (Exp (Rep ADM))
forall (m :: * -&gt; *). MonadBuilder m =&gt; SubExp -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eSubExp"><span class="hs-identifier hs-var">eSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684465110"><span class="hs-identifier hs-var">cond</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Adj] -&gt; [VName] -&gt; BodyT SOACS -&gt; ADM (BodyT SOACS)
</span><a href="Futhark.AD.Rev.html#diffBody"><span class="hs-identifier hs-var">diffBody</span></a></span><span> </span><span class="annot"><span class="annottext">[Adj]
</span><a href="#local-6989586621684465101"><span class="hs-identifier hs-var">adjs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465103"><span class="hs-identifier hs-var">branches_free</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684465109"><span class="hs-identifier hs-var">tbody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Adj] -&gt; [VName] -&gt; BodyT SOACS -&gt; ADM (BodyT SOACS)
</span><a href="Futhark.AD.Rev.html#diffBody"><span class="hs-identifier hs-var">diffBody</span></a></span><span> </span><span class="annot"><span class="annottext">[Adj]
</span><a href="#local-6989586621684465101"><span class="hs-identifier hs-var">adjs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465103"><span class="hs-identifier hs-var">branches_free</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684465108"><span class="hs-identifier hs-var">fbody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>    </span><span class="annot"><span class="annottext">(VName -&gt; VName -&gt; ADM ()) -&gt; [VName] -&gt; [VName] -&gt; ADM ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#insAdj"><span class="hs-identifier hs-var">insAdj</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465103"><span class="hs-identifier hs-var">branches_free</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465098"><span class="hs-identifier hs-var">branches_free_adj</span></a></span><span>
</span><span id="line-275"></span><span class="annot"><a href="Futhark.AD.Rev.html#diffStm"><span class="hs-identifier hs-var">diffStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684465090"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465090"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684465089"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684465089"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span id="local-6989586621684465088"><span class="annot"><span class="annottext">Op SOACS
</span><a href="#local-6989586621684465088"><span class="hs-identifier hs-var">soac</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684465087"><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465087"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-276"></span><span>  </span><span class="annot"><span class="annottext">VjpOps -&gt; Pat -&gt; StmAux () -&gt; SOAC SOACS -&gt; ADM () -&gt; ADM ()
</span><a href="Futhark.AD.Rev.SOAC.html#vjpSOAC"><span class="hs-identifier hs-var">vjpSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">VjpOps
</span><a href="Futhark.AD.Rev.html#vjpOps"><span class="hs-identifier hs-var">vjpOps</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465090"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684465089"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">Op SOACS
SOAC SOACS
</span><a href="#local-6989586621684465088"><span class="hs-identifier hs-var">soac</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465087"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-277"></span><span class="annot"><a href="Futhark.AD.Rev.html#diffStm"><span class="hs-identifier hs-var">diffStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684465085"><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465085"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684465084"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684465084"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684465083"><span class="annot"><span class="annottext">loop :: Exp SOACS
</span><a href="#local-6989586621684465083"><span class="hs-identifier hs-var">loop</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684465081"><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465081"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-278"></span><span>  </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; ADM ())
-&gt; Pat -&gt; StmAux () -&gt; Exp SOACS -&gt; ADM () -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Loop.html#diffLoop"><span class="hs-identifier hs-var">diffLoop</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; ADM ()
</span><a href="Futhark.AD.Rev.html#diffStms"><span class="hs-identifier hs-var">diffStms</span></a></span><span> </span><span class="annot"><span class="annottext">Pat
</span><a href="#local-6989586621684465085"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684465084"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">Exp SOACS
</span><a href="#local-6989586621684465083"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><a href="#local-6989586621684465081"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-279"></span><span class="annot"><a href="Futhark.AD.Rev.html#diffStm"><span class="hs-identifier hs-var">diffStm</span></a></span><span> </span><span id="local-6989586621684465078"><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684465078"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="annot"><span class="annottext">ADM ()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ADM ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ADM ()) -&gt; [Char] -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;diffStm unhandled:\n&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Stm SOACS -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684465078"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span class="annot"><a href="Futhark.AD.Rev.html#diffStms"><span class="hs-identifier hs-type">diffStms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span id="diffStms"><span class="annot"><span class="annottext">diffStms :: Stms SOACS -&gt; ADM ()
</span><a href="Futhark.AD.Rev.html#diffStms"><span class="hs-identifier hs-var hs-var">diffStms</span></a></span></span><span> </span><span id="local-6989586621684465077"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684465077"><span class="hs-identifier hs-var">all_stms</span></a></span></span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684465076"><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684465076"><span class="hs-identifier hs-var">stm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465075"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684465075"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; Maybe (Stm SOACS, Stms SOACS)
forall rep. Stms rep -&gt; Maybe (Stm rep, Stms rep)
</span><a href="Futhark.IR.Syntax.html#stmsHead"><span class="hs-identifier hs-var">stmsHead</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684465077"><span class="hs-identifier hs-var">all_stms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684465073"><span class="annot"><span class="annottext">Substitutions
</span><a href="#local-6989586621684465073"><span class="hs-identifier hs-var">subst</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465072"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684465072"><span class="hs-identifier hs-var">copy_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm SOACS -&gt; ADM (Substitutions, Stms SOACS)
</span><a href="Futhark.AD.Rev.Monad.html#copyConsumedArrsInStm"><span class="hs-identifier hs-var">copyConsumedArrsInStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684465076"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684465070"><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684465070"><span class="hs-identifier hs-var">stm'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465069"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684465069"><span class="hs-identifier hs-var">stms'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Substitutions -&gt; (Stm SOACS, Stms SOACS) -&gt; (Stm SOACS, Stms SOACS)
forall a. Substitute a =&gt; Substitutions -&gt; a -&gt; a
</span><a href="Futhark.Transform.Substitute.html#substituteNames"><span class="hs-identifier hs-var">substituteNames</span></a></span><span> </span><span class="annot"><span class="annottext">Substitutions
</span><a href="#local-6989586621684465073"><span class="hs-identifier hs-var">subst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684465076"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684465075"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>    </span><span class="annot"><span class="annottext">Stms SOACS -&gt; ADM ()
</span><a href="Futhark.AD.Rev.html#diffStms"><span class="hs-identifier hs-var">diffStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684465072"><span class="hs-identifier hs-var">copy_stms</span></a></span><span> </span><span class="annot"><span class="annottext">ADM () -&gt; ADM () -&gt; ADM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stm SOACS -&gt; ADM () -&gt; ADM ()
</span><a href="Futhark.AD.Rev.html#diffStm"><span class="hs-identifier hs-var">diffStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684465070"><span class="hs-identifier hs-var">stm'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms SOACS -&gt; ADM ()
</span><a href="Futhark.AD.Rev.html#diffStms"><span class="hs-identifier hs-var">diffStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684465069"><span class="hs-identifier hs-var">stms'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span>    </span><span class="annot"><span class="annottext">[(VName, VName)] -&gt; ((VName, VName) -&gt; ADM ()) -&gt; ADM ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Substitutions -&gt; [(VName, VName)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Substitutions
</span><a href="#local-6989586621684465073"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, VName) -&gt; ADM ()) -&gt; ADM ())
-&gt; ((VName, VName) -&gt; ADM ()) -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684465066"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465066"><span class="hs-identifier hs-var">from</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465065"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465065"><span class="hs-identifier hs-var">to</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-288"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; Adj -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#setAdj"><span class="hs-identifier hs-var">setAdj</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465066"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">(Adj -&gt; ADM ()) -&gt; ADM Adj -&gt; ADM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM Adj
</span><a href="Futhark.AD.Rev.Monad.html#lookupAdj"><span class="hs-identifier hs-var">lookupAdj</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465065"><span class="hs-identifier hs-var">to</span></a></span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-290"></span><span>    </span><span class="annot"><span class="annottext">() -&gt; ADM ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span class="hs-comment">-- | Preprocess statements before differentiating.</span><span>
</span><span id="line-293"></span><span class="hs-comment">-- For now, it's just stripmining.</span><span>
</span><span id="line-294"></span><span class="annot"><a href="Futhark.AD.Rev.html#preprocess"><span class="hs-identifier hs-type">preprocess</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span id="preprocess"><span class="annot"><span class="annottext">preprocess :: Stms SOACS -&gt; ADM (Stms SOACS)
</span><a href="Futhark.AD.Rev.html#preprocess"><span class="hs-identifier hs-var hs-var">preprocess</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; ADM (Stms SOACS)
</span><a href="Futhark.AD.Rev.Loop.html#stripmineStms"><span class="hs-identifier hs-var">stripmineStms</span></a></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="annot"><a href="Futhark.AD.Rev.html#diffBody"><span class="hs-identifier hs-type">diffBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#Adj"><span class="hs-identifier hs-type">Adj</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span>
</span><span id="line-298"></span><span id="diffBody"><span class="annot"><span class="annottext">diffBody :: [Adj] -&gt; [VName] -&gt; BodyT SOACS -&gt; ADM (BodyT SOACS)
</span><a href="Futhark.AD.Rev.html#diffBody"><span class="hs-identifier hs-var hs-var">diffBody</span></a></span></span><span> </span><span id="local-6989586621684465060"><span class="annot"><span class="annottext">[Adj]
</span><a href="#local-6989586621684465060"><span class="hs-identifier hs-var">res_adjs</span></a></span></span><span> </span><span id="local-6989586621684465059"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465059"><span class="hs-identifier hs-var">get_adjs_for</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684465057"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684465057"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684465056"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684465056"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ADM (BodyT SOACS) -&gt; ADM (BodyT SOACS)
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#subAD"><span class="hs-identifier hs-var">subAD</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM (BodyT SOACS) -&gt; ADM (BodyT SOACS))
-&gt; ADM (BodyT SOACS) -&gt; ADM (BodyT SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-299"></span><span>  </span><span class="annot"><span class="annottext">ADM (BodyT SOACS) -&gt; ADM (BodyT SOACS)
forall a. ADM a -&gt; ADM a
</span><a href="Futhark.AD.Rev.Monad.html#subSubsts"><span class="hs-identifier hs-var">subSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM (BodyT SOACS) -&gt; ADM (BodyT SOACS))
-&gt; ADM (BodyT SOACS) -&gt; ADM (BodyT SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684465050"><span class="annot"><span class="annottext">onResult :: SubExpRes -&gt; Adj -&gt; ADM ()
</span><a href="#local-6989586621684465050"><span class="hs-identifier hs-var hs-var">onResult</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Adj
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; ADM ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>        </span><span class="annot"><a href="#local-6989586621684465050"><span class="hs-identifier hs-var">onResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684465047"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465047"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684465046"><span class="annot"><span class="annottext">Adj
</span><a href="#local-6989586621684465046"><span class="hs-identifier hs-var">v_adj</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ADM () -&gt; ADM ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ADM () -&gt; ADM ()) -&gt; ADM () -&gt; ADM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; ADM ()
</span><a href="Futhark.AD.Rev.Monad.html#updateAdj"><span class="hs-identifier hs-var">updateAdj</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684465047"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ADM ()) -&gt; ADM VName -&gt; ADM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Adj -&gt; ADM VName
</span><a href="Futhark.AD.Rev.Monad.html#adjVal"><span class="hs-identifier hs-var">adjVal</span></a></span><span> </span><span class="annot"><span class="annottext">Adj
</span><a href="#local-6989586621684465046"><span class="hs-identifier hs-var">v_adj</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684465044"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465044"><span class="hs-identifier hs-var">adjs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684465043"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684465043"><span class="hs-identifier hs-var">stms'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ADM [VName] -&gt; ADM ([VName], Stms (Rep ADM))
forall (m :: * -&gt; *) a.
MonadBuilder m =&gt;
m a -&gt; m (a, Stms (Rep m))
</span><a href="Futhark.Builder.Class.html#collectStms"><span class="hs-identifier hs-var">collectStms</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM [VName] -&gt; ADM ([VName], Stms (Rep ADM)))
-&gt; ADM [VName] -&gt; ADM ([VName], Stms (Rep ADM))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-303"></span><span>      </span><span class="annot"><span class="annottext">(SubExpRes -&gt; Adj -&gt; ADM ()) -&gt; Result -&gt; [Adj] -&gt; ADM ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; Adj -&gt; ADM ()
</span><a href="#local-6989586621684465050"><span class="hs-identifier hs-var">onResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; Result
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#takeLast"><span class="hs-identifier hs-var">takeLast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Adj] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Adj]
</span><a href="#local-6989586621684465060"><span class="hs-identifier hs-var">res_adjs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684465056"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Adj]
</span><a href="#local-6989586621684465060"><span class="hs-identifier hs-var">res_adjs</span></a></span><span>
</span><span id="line-304"></span><span>      </span><span class="annot"><span class="annottext">Stms SOACS -&gt; ADM ()
</span><a href="Futhark.AD.Rev.html#diffStms"><span class="hs-identifier hs-var">diffStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; ADM ()) -&gt; ADM (Stms SOACS) -&gt; ADM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; ADM (Stms SOACS)
</span><a href="Futhark.AD.Rev.html#preprocess"><span class="hs-identifier hs-var">preprocess</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684465057"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-305"></span><span>      </span><span class="annot"><span class="annottext">(VName -&gt; ADM VName) -&gt; [VName] -&gt; ADM [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM VName
</span><a href="Futhark.AD.Rev.Monad.html#lookupAdjVal"><span class="hs-identifier hs-var">lookupAdjVal</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465059"><span class="hs-identifier hs-var">get_adjs_for</span></a></span><span>
</span><span id="line-306"></span><span>    </span><span class="annot"><span class="annottext">BodyT SOACS -&gt; ADM (BodyT SOACS)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(BodyT SOACS -&gt; ADM (BodyT SOACS))
-&gt; BodyT SOACS -&gt; ADM (BodyT SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyDec SOACS -&gt; Stms SOACS -&gt; Result -&gt; BodyT SOACS
forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684465043"><span class="hs-identifier hs-var">stms'</span></a></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; BodyT SOACS) -&gt; Result -&gt; BodyT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684465056"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Result
</span><a href="Futhark.IR.Syntax.html#varsRes"><span class="hs-identifier hs-var">varsRes</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465044"><span class="hs-identifier hs-var">adjs</span></a></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span class="annot"><a href="Futhark.AD.Rev.html#diffLambda"><span class="hs-identifier hs-type">diffLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#Adj"><span class="hs-identifier hs-type">Adj</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.AD.Rev.Monad.html#ADM"><span class="hs-identifier hs-type">ADM</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span>
</span><span id="line-309"></span><span id="diffLambda"><span class="annot"><span class="annottext">diffLambda :: [Adj] -&gt; [VName] -&gt; Lambda -&gt; ADM Lambda
</span><a href="Futhark.AD.Rev.html#diffLambda"><span class="hs-identifier hs-var hs-var">diffLambda</span></a></span></span><span> </span><span id="local-6989586621684465040"><span class="annot"><span class="annottext">[Adj]
</span><a href="#local-6989586621684465040"><span class="hs-identifier hs-var">res_adjs</span></a></span></span><span> </span><span id="local-6989586621684465039"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465039"><span class="hs-identifier hs-var">get_adjs_for</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span id="local-6989586621684465037"><span class="annot"><span class="annottext">[LParam SOACS]
</span><a href="#local-6989586621684465037"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684465036"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684465036"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-310"></span><span>  </span><span class="annot"><span class="annottext">Scope SOACS -&gt; ADM Lambda -&gt; ADM Lambda
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param Type] -&gt; Scope SOACS
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
[LParam SOACS]
</span><a href="#local-6989586621684465037"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ADM Lambda -&gt; ADM Lambda) -&gt; ADM Lambda -&gt; ADM Lambda
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-311"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684465033"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684465033"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684465032"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684465032"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Adj] -&gt; [VName] -&gt; BodyT SOACS -&gt; ADM (BodyT SOACS)
</span><a href="Futhark.AD.Rev.html#diffBody"><span class="hs-identifier hs-var">diffBody</span></a></span><span> </span><span class="annot"><span class="annottext">[Adj]
</span><a href="#local-6989586621684465040"><span class="hs-identifier hs-var">res_adjs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465039"><span class="hs-identifier hs-var">get_adjs_for</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684465036"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684465031"><span class="annot"><span class="annottext">body' :: BodyT SOACS
</span><a href="#local-6989586621684465031"><span class="hs-identifier hs-var hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyDec SOACS -&gt; Stms SOACS -&gt; Result -&gt; BodyT SOACS
forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684465033"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; BodyT SOACS) -&gt; Result -&gt; BodyT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; Result
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#takeLast"><span class="hs-identifier hs-var">takeLast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465039"><span class="hs-identifier hs-var">get_adjs_for</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684465032"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-313"></span><span>    </span><span id="local-6989586621684465030"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684465030"><span class="hs-identifier hs-var">ts'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ADM Type) -&gt; [VName] -&gt; ADM [Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684465039"><span class="hs-identifier hs-var">get_adjs_for</span></a></span><span>
</span><span id="line-314"></span><span>    </span><span class="annot"><span class="annottext">Lambda -&gt; ADM Lambda
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Lambda -&gt; ADM Lambda) -&gt; Lambda -&gt; ADM Lambda
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[LParam SOACS] -&gt; BodyT SOACS -&gt; [Type] -&gt; Lambda
forall rep. [LParam rep] -&gt; BodyT rep -&gt; [Type] -&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[LParam SOACS]
</span><a href="#local-6989586621684465037"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684465031"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684465030"><span class="hs-identifier hs-var">ts'</span></a></span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span id="local-6989586621684465737"><span class="annot"><a href="Futhark.AD.Rev.html#revVJP"><span class="hs-identifier hs-type">revVJP</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684465737"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684465737"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span></span><span>
</span><span id="line-317"></span><span id="revVJP"><span class="annot"><span class="annottext">revVJP :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Scope SOACS -&gt; Lambda -&gt; m Lambda
</span><a href="Futhark.AD.Rev.html#revVJP"><span class="hs-identifier hs-var hs-var">revVJP</span></a></span></span><span> </span><span id="local-6989586621684465003"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684465003"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span id="local-6989586621684465002"><span class="annot"><span class="annottext">[LParam SOACS]
</span><a href="#local-6989586621684465002"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684465001"><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684465001"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621684465000"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684465000"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-318"></span><span>  </span><span class="annot"><span class="annottext">ADM Lambda -&gt; m Lambda
forall (m :: * -&gt; *) a. MonadFreshNames m =&gt; ADM a -&gt; m a
</span><a href="Futhark.AD.Rev.Monad.html#runADM"><span class="hs-identifier hs-var">runADM</span></a></span><span> </span><span class="annot"><span class="annottext">(ADM Lambda -&gt; m Lambda)
-&gt; (ADM Lambda -&gt; ADM Lambda) -&gt; ADM Lambda -&gt; m Lambda
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Scope SOACS -&gt; ADM Lambda -&gt; ADM Lambda
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684465003"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope SOACS -&gt; Scope SOACS -&gt; Scope SOACS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; Scope SOACS
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
[LParam SOACS]
</span><a href="#local-6989586621684465002"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ADM Lambda -&gt; m Lambda) -&gt; ADM Lambda -&gt; m Lambda
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-319"></span><span>    </span><span id="local-6989586621684464998"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684464998"><span class="hs-identifier hs-var">params_adj</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(SubExp, Type)]
-&gt; ((SubExp, Type) -&gt; ADM (Param Type)) -&gt; ADM [Param Type]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; [Type] -&gt; [(SubExp, Type)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; Result -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT SOACS -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684465001"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684465000"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SubExp, Type) -&gt; ADM (Param Type)) -&gt; ADM [Param Type])
-&gt; ((SubExp, Type) -&gt; ADM (Param Type)) -&gt; ADM [Param Type]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684464995"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684464995"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684464994"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684464994"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-320"></span><span>      </span><span class="annot"><span class="annottext">Attrs -&gt; VName -&gt; Type -&gt; Param Type
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Type -&gt; Param Type)
-&gt; ADM VName -&gt; ADM (Type -&gt; Param Type)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ADM VName -&gt; (VName -&gt; ADM VName) -&gt; Maybe VName -&gt; ADM VName
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; ADM VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;const_adj&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ADM VName
</span><a href="Futhark.AD.Rev.Monad.html#adjVName"><span class="hs-identifier hs-var">adjVName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Maybe VName
</span><a href="Futhark.IR.Prop.html#subExpVar"><span class="hs-identifier hs-var">subExpVar</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684464995"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ADM (Type -&gt; Param Type) -&gt; ADM Type -&gt; ADM (Param Type)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; ADM Type
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684464994"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-321"></span><span>
</span><span id="line-322"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684464988"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684464988"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684464987"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684464987"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-323"></span><span>      </span><span class="annot"><span class="annottext">Scope SOACS -&gt; ADM (BodyT SOACS) -&gt; ADM (BodyT SOACS)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param Type] -&gt; Scope SOACS
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684464998"><span class="hs-identifier hs-var">params_adj</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ADM (BodyT SOACS) -&gt; ADM (BodyT SOACS))
-&gt; ADM (BodyT SOACS) -&gt; ADM (BodyT SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-324"></span><span>        </span><span class="annot"><span class="annottext">[Adj] -&gt; [VName] -&gt; BodyT SOACS -&gt; ADM (BodyT SOACS)
</span><a href="Futhark.AD.Rev.html#diffBody"><span class="hs-identifier hs-var">diffBody</span></a></span><span>
</span><span id="line-325"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Param Type -&gt; Adj) -&gt; [Param Type] -&gt; [Adj]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; Adj
forall t. Param t -&gt; Adj
</span><a href="Futhark.AD.Rev.Monad.html#adjFromParam"><span class="hs-identifier hs-var">adjFromParam</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684464998"><span class="hs-identifier hs-var">params_adj</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Param Type -&gt; VName) -&gt; [Param Type] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
[LParam SOACS]
</span><a href="#local-6989586621684465002"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-327"></span><span>          </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684465001"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-328"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684464984"><span class="annot"><span class="annottext">body' :: BodyT SOACS
</span><a href="#local-6989586621684464984"><span class="hs-identifier hs-var hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyDec SOACS -&gt; Stms SOACS -&gt; Result -&gt; BodyT SOACS
forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684464988"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684464987"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span>    </span><span class="annot"><span class="annottext">Lambda -&gt; ADM Lambda
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Lambda -&gt; ADM Lambda) -&gt; Lambda -&gt; ADM Lambda
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[LParam SOACS] -&gt; BodyT SOACS -&gt; [Type] -&gt; Lambda
forall rep. [LParam rep] -&gt; BodyT rep -&gt; [Type] -&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param Type]
[LParam SOACS]
</span><a href="#local-6989586621684465002"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type] -&gt; [Param Type] -&gt; [Param Type]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684464998"><span class="hs-identifier hs-var">params_adj</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BodyT SOACS
</span><a href="#local-6989586621684464984"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684465000"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; [Type] -&gt; [Type]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; Type) -&gt; [Param Type] -&gt; [Type]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">[Param Type]
[LParam SOACS]
</span><a href="#local-6989586621684465002"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span></pre></body></html>