<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">-- | FutharkScript is a (tiny) subset of Futhark used to write small</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- expressions that are evaluated by server executables.  The @futhark</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- literate@ command is the main user.</span><span>
</span><span id="line-8"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Script</span><span>
</span><span id="line-9"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Server</span></span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#ScriptServer"><span class="hs-identifier">ScriptServer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#withScriptServer"><span class="hs-identifier">withScriptServer</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#withScriptServer%27"><span class="hs-identifier">withScriptServer'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Expressions, values, and types</span></span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#Func"><span class="hs-identifier">Func</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier">Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#parseExp"><span class="hs-identifier">parseExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#parseExpFromText"><span class="hs-identifier">parseExpFromText</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier">varsInExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#ScriptValueType"><span class="hs-identifier">ScriptValueType</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#ScriptValue"><span class="hs-identifier">ScriptValue</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#scriptValueType"><span class="hs-identifier">scriptValueType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#serverVarsInValue"><span class="hs-identifier">serverVarsInValue</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#ValOrVar"><span class="hs-identifier">ValOrVar</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#ExpValue"><span class="hs-identifier">ExpValue</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Evaluation</span></span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#EvalBuiltin"><span class="hs-identifier">EvalBuiltin</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#evalExp"><span class="hs-identifier">evalExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#getExpValue"><span class="hs-identifier">getExpValue</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#evalExpToGround"><span class="hs-identifier">evalExpToGround</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#valueToExp"><span class="hs-identifier">valueToExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Futhark.Script.html#freeValue"><span class="hs-identifier">freeValue</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">where</span><span>
</span><span id="line-36"></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Char</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">toList</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Functor</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.IORef</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">intersperse</span></span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Traversable</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Void</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Futhark.Data.Parser</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Futhark.Server</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Futhark.Server.Values</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">getValue</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">putValue</span></span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Test.Values.html"><span class="hs-identifier">Futhark.Test.Values</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">V</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#nubOrd"><span class="hs-identifier">nubOrd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.Pretty.html"><span class="hs-identifier">Futhark.Util.Pretty</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">float</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">line</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sep</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">space</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">string</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(&lt;/&gt;)</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(&lt;|&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.Megaparsec</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.Megaparsec.Char</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">space</span></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Text.Megaparsec.Char.Lexer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">charLiteral</span></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-comment">-- | Like a 'Server', but keeps a bit more state to make FutharkScript</span><span>
</span><span id="line-59"></span><span class="hs-comment">-- more convenient.</span><span>
</span><span id="line-60"></span><span class="hs-keyword">data</span><span> </span><span id="ScriptServer"><span class="annot"><a href="Futhark.Script.html#ScriptServer"><span class="hs-identifier hs-var">ScriptServer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ScriptServer"><span class="annot"><a href="Futhark.Script.html#ScriptServer"><span class="hs-identifier hs-var">ScriptServer</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Server</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">IORef</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-comment">-- | Run an action with a 'ScriptServer' produced by an existing</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- 'Server', without shutting it down at the end.</span><span>
</span><span id="line-64"></span><span id="local-6989586621684320300"><span id="local-6989586621684320304"><span class="annot"><a href="Futhark.Script.html#withScriptServer%27"><span class="hs-identifier hs-type">withScriptServer'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621684320304"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Server</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#ScriptServer"><span class="hs-identifier hs-type">ScriptServer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684320304"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684320300"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684320304"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684320300"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-65"></span><span id="withScriptServer%27"><span class="annot"><span class="annottext">withScriptServer' :: forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Server -&gt; (ScriptServer -&gt; m a) -&gt; m a
</span><a href="Futhark.Script.html#withScriptServer%27"><span class="hs-identifier hs-var hs-var">withScriptServer'</span></a></span></span><span> </span><span id="local-6989586621684319866"><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319866"><span class="hs-identifier hs-var">server</span></a></span></span><span> </span><span id="local-6989586621684319865"><span class="annot"><span class="annottext">ScriptServer -&gt; m a
</span><a href="#local-6989586621684319865"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-66"></span><span>  </span><span id="local-6989586621684319864"><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621684319864"><span class="hs-identifier hs-var">counter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IORef Int) -&gt; m (IORef Int)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef Int) -&gt; m (IORef Int))
-&gt; IO (IORef Int) -&gt; m (IORef Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; IO (IORef Int)
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-67"></span><span>  </span><span class="annot"><span class="annottext">ScriptServer -&gt; m a
</span><a href="#local-6989586621684319865"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(ScriptServer -&gt; m a) -&gt; ScriptServer -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Server -&gt; IORef Int -&gt; ScriptServer
</span><a href="Futhark.Script.html#ScriptServer"><span class="hs-identifier hs-var">ScriptServer</span></a></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319866"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621684319864"><span class="hs-identifier hs-var">counter</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="hs-comment">-- | Start a server, execute an action, then shut down the server.</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- Similar to 'withServer'.</span><span>
</span><span id="line-71"></span><span id="local-6989586621684320289"><span class="annot"><a href="Futhark.Script.html#withScriptServer"><span class="hs-identifier hs-type">withScriptServer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ServerCfg</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#ScriptServer"><span class="hs-identifier hs-type">ScriptServer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621684320289"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><a href="#local-6989586621684320289"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-72"></span><span id="withScriptServer"><span class="annot"><span class="annottext">withScriptServer :: forall a. ServerCfg -&gt; (ScriptServer -&gt; IO a) -&gt; IO a
</span><a href="Futhark.Script.html#withScriptServer"><span class="hs-identifier hs-var hs-var">withScriptServer</span></a></span></span><span> </span><span id="local-6989586621684319859"><span class="annot"><span class="annottext">ServerCfg
</span><a href="#local-6989586621684319859"><span class="hs-identifier hs-var">cfg</span></a></span></span><span> </span><span id="local-6989586621684319858"><span class="annot"><span class="annottext">ScriptServer -&gt; IO a
</span><a href="#local-6989586621684319858"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-73"></span><span>  </span><span class="annot"><span class="annottext">ServerCfg -&gt; (Server -&gt; IO a) -&gt; IO a
forall a. ServerCfg -&gt; (Server -&gt; IO a) -&gt; IO a
</span><span class="hs-identifier hs-var">withServer</span></span><span> </span><span class="annot"><span class="annottext">ServerCfg
</span><a href="#local-6989586621684319859"><span class="hs-identifier hs-var">cfg</span></a></span><span> </span><span class="annot"><span class="annottext">((Server -&gt; IO a) -&gt; IO a) -&gt; (Server -&gt; IO a) -&gt; IO a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Server -&gt; (ScriptServer -&gt; IO a) -&gt; IO a)
-&gt; (ScriptServer -&gt; IO a) -&gt; Server -&gt; IO a
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Server -&gt; (ScriptServer -&gt; IO a) -&gt; IO a
forall (m :: * -&gt; *) a.
MonadIO m =&gt;
Server -&gt; (ScriptServer -&gt; m a) -&gt; m a
</span><a href="Futhark.Script.html#withScriptServer%27"><span class="hs-identifier hs-var">withScriptServer'</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptServer -&gt; IO a
</span><a href="#local-6989586621684319858"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-comment">-- | A function called in a 'Call' expression can be either a Futhark</span><span>
</span><span id="line-76"></span><span class="hs-comment">-- function or a builtin function.</span><span>
</span><span id="line-77"></span><span class="hs-keyword">data</span><span> </span><span id="Func"><span class="annot"><a href="Futhark.Script.html#Func"><span class="hs-identifier hs-var">Func</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="FuncFut"><span class="annot"><a href="Futhark.Script.html#FuncFut"><span class="hs-identifier hs-var">FuncFut</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">EntryName</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="FuncBuiltin"><span class="annot"><a href="Futhark.Script.html#FuncBuiltin"><span class="hs-identifier hs-var">FuncBuiltin</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684319841"><span id="local-6989586621684319843"><span id="local-6989586621684319851"><span class="annot"><span class="annottext">Int -&gt; Func -&gt; ShowS
[Func] -&gt; ShowS
Func -&gt; String
(Int -&gt; Func -&gt; ShowS)
-&gt; (Func -&gt; String) -&gt; ([Func] -&gt; ShowS) -&gt; Show Func
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Func] -&gt; ShowS
$cshowList :: [Func] -&gt; ShowS
show :: Func -&gt; String
$cshow :: Func -&gt; String
showsPrec :: Int -&gt; Func -&gt; ShowS
$cshowsPrec :: Int -&gt; Func -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span class="hs-comment">-- | A FutharkScript expression.  This is a simple AST that might not</span><span>
</span><span id="line-81"></span><span class="hs-comment">-- correspond exactly to what the user wrote (e.g. no parentheses or</span><span>
</span><span id="line-82"></span><span class="hs-comment">-- source locations).  This is fine for small expressions, which is</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- all this is meant for.</span><span>
</span><span id="line-84"></span><span class="hs-keyword">data</span><span> </span><span id="Exp"><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier hs-var">Exp</span></a></span></span><span>
</span><span id="line-85"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Call"><span class="annot"><a href="Futhark.Script.html#Call"><span class="hs-identifier hs-var">Call</span></a></span></span><span> </span><span class="annot"><a href="Futhark.Script.html#Func"><span class="hs-identifier hs-type">Func</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-86"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Const"><span class="annot"><a href="Futhark.Script.html#Const"><span class="hs-identifier hs-var">Const</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">V.Value</span></span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Tuple"><span class="annot"><a href="Futhark.Script.html#Tuple"><span class="hs-identifier hs-var">Tuple</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Record"><span class="annot"><a href="Futhark.Script.html#Record"><span class="hs-identifier hs-var">Record</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="StringLit"><span class="annot"><a href="Futhark.Script.html#StringLit"><span class="hs-identifier hs-var">StringLit</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-90"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Let"><span class="annot"><a href="Futhark.Script.html#Let"><span class="hs-identifier hs-var">Let</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">VarName</span></span><span class="hs-special">]</span><span> </span><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | Server-side variable, *not* Futhark variable (these are</span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-comment">-- handled in 'Call').</span><span>
</span><span id="line-93"></span><span>    </span><span id="ServerVar"><span class="annot"><a href="Futhark.Script.html#ServerVar"><span class="hs-identifier hs-var">ServerVar</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeName</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">VarName</span></span><span>
</span><span id="line-94"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684319802"><span id="local-6989586621684319804"><span id="local-6989586621684319829"><span class="annot"><span class="annottext">Int -&gt; Exp -&gt; ShowS
[Exp] -&gt; ShowS
Exp -&gt; String
(Int -&gt; Exp -&gt; ShowS)
-&gt; (Exp -&gt; String) -&gt; ([Exp] -&gt; ShowS) -&gt; Show Exp
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Exp] -&gt; ShowS
$cshowList :: [Exp] -&gt; ShowS
show :: Exp -&gt; String
$cshow :: Exp -&gt; String
showsPrec :: Int -&gt; Exp -&gt; ShowS
$cshowsPrec :: Int -&gt; Exp -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>
</span><span id="line-96"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684319796"><span id="local-6989586621684319798"><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="Futhark.Script.html#Func"><span class="hs-identifier hs-type">Func</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-97"></span><span>  </span><span id="local-6989586621684319787"><span class="annot"><span class="annottext">ppr :: Func -&gt; Doc
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#FuncFut"><span class="hs-identifier hs-type">FuncFut</span></a></span><span> </span><span id="local-6989586621684319785"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319785"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319785"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-98"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#FuncBuiltin"><span class="hs-identifier hs-type">FuncBuiltin</span></a></span><span> </span><span id="local-6989586621684319784"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319784"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;$&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319784"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684319780"><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-101"></span><span>  </span><span id="local-6989586621684319778"><span class="annot"><span class="annottext">ppr :: Exp -&gt; Doc
</span><a href="#local-6989586621684319778"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Exp -&gt; Doc
forall a. Pretty a =&gt; Int -&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">pprPrec</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-102"></span><span>  </span><span id="local-6989586621684319754"><span class="annot"><span class="annottext">pprPrec :: Int -&gt; Exp -&gt; Doc
</span><a href="#local-6989586621684319754"><span class="hs-identifier hs-var hs-var hs-var hs-var">pprPrec</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#ServerVar"><span class="hs-identifier hs-type">ServerVar</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684319753"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319753"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;$&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319753"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pprPrec</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Const"><span class="hs-identifier hs-type">Const</span></a></span><span> </span><span id="local-6989586621684319752"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319752"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Doc
</span><span class="hs-identifier hs-var">strictText</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; Doc) -&gt; EntryName -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; EntryName
</span><span class="hs-identifier hs-var">V.valueText</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319752"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-104"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pprPrec</span></span><span> </span><span id="local-6989586621684319749"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684319749"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684319748"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319748"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684319747"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684319747"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621684319746"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684319746"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parensIf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684319749"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; Doc) -&gt; Doc -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;let&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684319742"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">equals</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684319747"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;in&quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684319746"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-106"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-107"></span><span>      </span><span id="local-6989586621684319742"><span class="annot"><span class="annottext">pat' :: Doc
</span><a href="#local-6989586621684319742"><span class="hs-identifier hs-var hs-var">pat'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319748"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-108"></span><span>        </span><span class="hs-special">[</span><span id="local-6989586621684319738"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319738"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319738"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-109"></span><span>        </span><span class="annot"><span class="annottext">[EntryName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parens</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; Doc) -&gt; Doc -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; Doc) -&gt; [EntryName] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319748"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-110"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pprPrec</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Call"><span class="hs-identifier hs-type">Call</span></a></span><span> </span><span id="local-6989586621684319735"><span class="annot"><span class="annottext">Func
</span><a href="#local-6989586621684319735"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Func -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Func
</span><a href="#local-6989586621684319735"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-111"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pprPrec</span></span><span> </span><span id="local-6989586621684319734"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684319734"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Call"><span class="hs-identifier hs-type">Call</span></a></span><span> </span><span id="local-6989586621684319733"><span class="annot"><span class="annottext">Func
</span><a href="#local-6989586621684319733"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684319732"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319732"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parensIf</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684319734"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; Doc) -&gt; Doc -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Func -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Func
</span><a href="#local-6989586621684319733"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
</span><span class="hs-operator hs-var">&lt;+&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">spread</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Doc) -&gt; [Exp] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Exp -&gt; Doc
forall a. Pretty a =&gt; Int -&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">pprPrec</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319732"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-113"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pprPrec</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Tuple"><span class="hs-identifier hs-type">Tuple</span></a></span><span> </span><span id="local-6989586621684319730"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319730"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-114"></span><span>    </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parens</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; Doc) -&gt; Doc -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Doc) -&gt; [Exp] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319730"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-115"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pprPrec</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#StringLit"><span class="hs-identifier hs-type">StringLit</span></a></span><span> </span><span id="local-6989586621684319729"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319729"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Doc) -&gt; String -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319729"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">pprPrec</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684319727"><span class="annot"><span class="annottext">[(EntryName, Exp)]
</span><a href="#local-6989586621684319727"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">braces</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; Doc) -&gt; Doc -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((EntryName, Exp) -&gt; Doc) -&gt; [(EntryName, Exp)] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(EntryName, Exp) -&gt; Doc
forall {a} {a}. (Pretty a, Pretty a) =&gt; (a, a) -&gt; Doc
</span><a href="#local-6989586621684319725"><span class="hs-identifier hs-var">field</span></a></span><span> </span><span class="annot"><span class="annottext">[(EntryName, Exp)]
</span><a href="#local-6989586621684319727"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-117"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-118"></span><span>      </span><span id="local-6989586621684319725"><span class="annot"><span class="annottext">field :: (a, a) -&gt; Doc
</span><a href="#local-6989586621684319725"><span class="hs-identifier hs-var hs-var">field</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684319718"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684319718"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684319717"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684319717"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684319718"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-identifier hs-var">equals</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684319717"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span class="hs-keyword">type</span><span> </span><span id="Parser"><span class="annot"><a href="Futhark.Script.html#Parser"><span class="hs-identifier hs-var">Parser</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Parsec</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Void</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span id="local-6989586621684320268"><span class="annot"><a href="Futhark.Script.html#lexeme"><span class="hs-identifier hs-type">lexeme</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#Parser"><span class="hs-identifier hs-type">Parser</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#Parser"><span class="hs-identifier hs-type">Parser</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684320268"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#Parser"><span class="hs-identifier hs-type">Parser</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684320268"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-123"></span><span id="lexeme"><span class="annot"><span class="annottext">lexeme :: forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#lexeme"><span class="hs-identifier hs-var hs-var">lexeme</span></a></span></span><span> </span><span id="local-6989586621684319714"><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319714"><span class="hs-identifier hs-var">sep</span></a></span></span><span> </span><span id="local-6989586621684319713"><span class="annot"><span class="annottext">Parser a
</span><a href="#local-6989586621684319713"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Parser a
</span><a href="#local-6989586621684319713"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Parser a -&gt; Parser () -&gt; Parser a
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;*</span></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319714"><span class="hs-identifier hs-var">sep</span></a></span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span id="local-6989586621684319711"><span class="annot"><a href="Futhark.Script.html#inParens"><span class="hs-identifier hs-type">inParens</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#Parser"><span class="hs-identifier hs-type">Parser</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#Parser"><span class="hs-identifier hs-type">Parser</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684319711"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#Parser"><span class="hs-identifier hs-type">Parser</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684319711"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-126"></span><span id="inParens"><span class="annot"><span class="annottext">inParens :: forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#inParens"><span class="hs-identifier hs-var hs-var">inParens</span></a></span></span><span> </span><span id="local-6989586621684319698"><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319698"><span class="hs-identifier hs-var">sep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Parser EntryName
-&gt; Parser EntryName
-&gt; ParsecT Void EntryName Identity a
-&gt; ParsecT Void EntryName Identity a
forall (m :: * -&gt; *) open close a.
Applicative m =&gt;
m open -&gt; m close -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">between</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Parser () -&gt; Parser EntryName -&gt; Parser EntryName
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#lexeme"><span class="hs-identifier hs-var">lexeme</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319698"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><span class="hs-string">&quot;(&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Parser () -&gt; Parser EntryName -&gt; Parser EntryName
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#lexeme"><span class="hs-identifier hs-var">lexeme</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319698"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><span class="hs-string">&quot;)&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span id="local-6989586621684319696"><span class="annot"><a href="Futhark.Script.html#inBraces"><span class="hs-identifier hs-type">inBraces</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#Parser"><span class="hs-identifier hs-type">Parser</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#Parser"><span class="hs-identifier hs-type">Parser</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684319696"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#Parser"><span class="hs-identifier hs-type">Parser</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684319696"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-129"></span><span id="inBraces"><span class="annot"><span class="annottext">inBraces :: forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#inBraces"><span class="hs-identifier hs-var hs-var">inBraces</span></a></span></span><span> </span><span id="local-6989586621684319683"><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319683"><span class="hs-identifier hs-var">sep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Parser EntryName
-&gt; Parser EntryName
-&gt; ParsecT Void EntryName Identity a
-&gt; ParsecT Void EntryName Identity a
forall (m :: * -&gt; *) open close a.
Applicative m =&gt;
m open -&gt; m close -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">between</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Parser () -&gt; Parser EntryName -&gt; Parser EntryName
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#lexeme"><span class="hs-identifier hs-var">lexeme</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319683"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><span class="hs-string">&quot;{&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Parser () -&gt; Parser EntryName -&gt; Parser EntryName
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#lexeme"><span class="hs-identifier hs-var">lexeme</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319683"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><span class="hs-string">&quot;}&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span class="hs-comment">-- | Parse a FutharkScript expression, given a whitespace parser.</span><span>
</span><span id="line-132"></span><span class="annot"><a href="Futhark.Script.html#parseExp"><span class="hs-identifier hs-type">parseExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#Parser"><span class="hs-identifier hs-type">Parser</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#Parser"><span class="hs-identifier hs-type">Parser</span></a></span><span> </span><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span>
</span><span id="line-133"></span><span id="parseExp"><span class="annot"><span class="annottext">parseExp :: Parser () -&gt; Parser Exp
</span><a href="Futhark.Script.html#parseExp"><span class="hs-identifier hs-var hs-var">parseExp</span></a></span></span><span> </span><span id="local-6989586621684319682"><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-134"></span><span>  </span><span class="annot"><span class="annottext">[Parser Exp] -&gt; Parser Exp
forall (f :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable f, Alternative m) =&gt;
f (m a) -&gt; m a
</span><span class="hs-identifier hs-var">choice</span></span><span>
</span><span id="line-135"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Parser () -&gt; Parser EntryName -&gt; Parser EntryName
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#lexeme"><span class="hs-identifier hs-var">lexeme</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><span class="hs-string">&quot;let&quot;</span></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
-&gt; ([EntryName] -&gt; Exp -&gt; Exp -&gt; Exp)
-&gt; ParsecT
     Void EntryName Identity ([EntryName] -&gt; Exp -&gt; Exp -&gt; Exp)
forall (f :: * -&gt; *) a b. Functor f =&gt; f a -&gt; b -&gt; f b
</span><span class="hs-operator hs-var">$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[EntryName] -&gt; Exp -&gt; Exp -&gt; Exp
</span><a href="Futhark.Script.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span>
</span><span id="line-136"></span><span>        </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity ([EntryName] -&gt; Exp -&gt; Exp -&gt; Exp)
-&gt; ParsecT Void EntryName Identity [EntryName]
-&gt; ParsecT Void EntryName Identity (Exp -&gt; Exp -&gt; Exp)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity [EntryName]
</span><a href="#local-6989586621684319679"><span class="hs-identifier hs-var">pPat</span></a></span><span> </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity (Exp -&gt; Exp -&gt; Exp)
-&gt; Parser EntryName
-&gt; ParsecT Void EntryName Identity (Exp -&gt; Exp -&gt; Exp)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;*</span></span><span> </span><span class="annot"><span class="annottext">Parser () -&gt; Parser EntryName -&gt; Parser EntryName
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#lexeme"><span class="hs-identifier hs-var">lexeme</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><span class="hs-string">&quot;=&quot;</span></span><span>
</span><span id="line-137"></span><span>        </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity (Exp -&gt; Exp -&gt; Exp)
-&gt; Parser Exp -&gt; ParsecT Void EntryName Identity (Exp -&gt; Exp)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser () -&gt; Parser Exp
</span><a href="Futhark.Script.html#parseExp"><span class="hs-identifier hs-var">parseExp</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity (Exp -&gt; Exp)
-&gt; Parser EntryName -&gt; ParsecT Void EntryName Identity (Exp -&gt; Exp)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;*</span></span><span> </span><span class="annot"><span class="annottext">Parser () -&gt; Parser EntryName -&gt; Parser EntryName
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#lexeme"><span class="hs-identifier hs-var">lexeme</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><span class="hs-string">&quot;in&quot;</span></span><span>
</span><span id="line-138"></span><span>        </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity (Exp -&gt; Exp)
-&gt; Parser Exp -&gt; Parser Exp
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser () -&gt; Parser Exp
</span><a href="Futhark.Script.html#parseExp"><span class="hs-identifier hs-var">parseExp</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-139"></span><span>      </span><span class="annot"><span class="annottext">Parser Exp -&gt; Parser Exp
forall e s (m :: * -&gt; *) a. MonadParsec e s m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="annot"><span class="annottext">(Parser Exp -&gt; Parser Exp) -&gt; Parser Exp -&gt; Parser Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Func -&gt; [Exp] -&gt; Exp
</span><a href="Futhark.Script.html#Call"><span class="hs-identifier hs-var">Call</span></a></span><span> </span><span class="annot"><span class="annottext">(Func -&gt; [Exp] -&gt; Exp)
-&gt; ParsecT Void EntryName Identity Func
-&gt; ParsecT Void EntryName Identity ([Exp] -&gt; Exp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity Func
</span><a href="#local-6989586621684319676"><span class="hs-identifier hs-var">parseFunc</span></a></span><span> </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity ([Exp] -&gt; Exp)
-&gt; ParsecT Void EntryName Identity [Exp] -&gt; Parser Exp
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser Exp -&gt; ParsecT Void EntryName Identity [Exp]
forall (m :: * -&gt; *) a. MonadPlus m =&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">many</span></span><span> </span><span class="annot"><span class="annottext">Parser Exp
</span><a href="#local-6989586621684319674"><span class="hs-identifier hs-var">pAtom</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-140"></span><span>      </span><span class="annot"><span class="annottext">Parser Exp
</span><a href="#local-6989586621684319674"><span class="hs-identifier hs-var">pAtom</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-142"></span><span>    </span><span class="annot"><span class="annottext">Parser Exp -&gt; String -&gt; Parser Exp
forall e s (m :: * -&gt; *) a.
MonadParsec e s m =&gt;
m a -&gt; String -&gt; m a
</span><span class="hs-operator hs-var">&lt;?&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;expression&quot;</span></span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-144"></span><span>    </span><span id="local-6989586621684319668"><span class="annot"><span class="annottext">pField :: ParsecT Void EntryName Identity (EntryName, Exp)
</span><a href="#local-6989586621684319668"><span class="hs-identifier hs-var hs-var">pField</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; Exp -&gt; (EntryName, Exp))
-&gt; Parser EntryName
-&gt; ParsecT Void EntryName Identity (Exp -&gt; (EntryName, Exp))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><a href="#local-6989586621684319667"><span class="hs-identifier hs-var">pVarName</span></a></span><span> </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity (Exp -&gt; (EntryName, Exp))
-&gt; Parser Exp -&gt; ParsecT Void EntryName Identity (EntryName, Exp)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Parser EntryName
</span><a href="#local-6989586621684319666"><span class="hs-identifier hs-var">pEquals</span></a></span><span> </span><span class="annot"><span class="annottext">Parser EntryName -&gt; Parser Exp -&gt; Parser Exp
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser () -&gt; Parser Exp
</span><a href="Futhark.Script.html#parseExp"><span class="hs-identifier hs-var">parseExp</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-145"></span><span>    </span><span id="local-6989586621684319666"><span class="annot"><span class="annottext">pEquals :: Parser EntryName
</span><a href="#local-6989586621684319666"><span class="hs-identifier hs-var hs-var">pEquals</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Parser () -&gt; Parser EntryName -&gt; Parser EntryName
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#lexeme"><span class="hs-identifier hs-var">lexeme</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><span class="hs-string">&quot;=&quot;</span></span><span>
</span><span id="line-146"></span><span>    </span><span id="local-6989586621684319651"><span class="annot"><span class="annottext">pComma :: Parser EntryName
</span><a href="#local-6989586621684319651"><span class="hs-identifier hs-var hs-var">pComma</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Parser () -&gt; Parser EntryName -&gt; Parser EntryName
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#lexeme"><span class="hs-identifier hs-var">lexeme</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><span class="hs-string">&quot;,&quot;</span></span><span>
</span><span id="line-147"></span><span>    </span><span id="local-6989586621684319650"><span class="annot"><span class="annottext">mkTuple :: [Exp] -&gt; Exp
</span><a href="#local-6989586621684319650"><span class="hs-identifier hs-var hs-var">mkTuple</span></a></span></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684319649"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684319649"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684319649"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><a href="#local-6989586621684319650"><span class="hs-identifier hs-var">mkTuple</span></a></span><span> </span><span id="local-6989586621684319648"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319648"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Exp] -&gt; Exp
</span><a href="Futhark.Script.html#Tuple"><span class="hs-identifier hs-var">Tuple</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319648"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span>    </span><span id="local-6989586621684319674"><span class="annot"><span class="annottext">pAtom :: Parser Exp
</span><a href="#local-6989586621684319674"><span class="hs-identifier hs-var hs-var">pAtom</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-151"></span><span>      </span><span class="annot"><span class="annottext">[Parser Exp] -&gt; Parser Exp
forall (f :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable f, Alternative m) =&gt;
f (m a) -&gt; m a
</span><span class="hs-identifier hs-var">choice</span></span><span>
</span><span id="line-152"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Parser Exp -&gt; Parser Exp
forall e s (m :: * -&gt; *) a. MonadParsec e s m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="annot"><span class="annottext">(Parser Exp -&gt; Parser Exp) -&gt; Parser Exp -&gt; Parser Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Parser () -&gt; Parser Exp -&gt; Parser Exp
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#inParens"><span class="hs-identifier hs-var">inParens</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Exp] -&gt; Exp
</span><a href="#local-6989586621684319650"><span class="hs-identifier hs-var">mkTuple</span></a></span><span> </span><span class="annot"><span class="annottext">([Exp] -&gt; Exp)
-&gt; ParsecT Void EntryName Identity [Exp] -&gt; Parser Exp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Parser () -&gt; Parser Exp
</span><a href="Futhark.Script.html#parseExp"><span class="hs-identifier hs-var">parseExp</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">Parser Exp
-&gt; Parser EntryName -&gt; ParsecT Void EntryName Identity [Exp]
forall (m :: * -&gt; *) a sep. MonadPlus m =&gt; m a -&gt; m sep -&gt; m [a]
</span><span class="hs-operator hs-var">`sepBy`</span></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><a href="#local-6989586621684319651"><span class="hs-identifier hs-var">pComma</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-153"></span><span>          </span><span class="annot"><span class="annottext">Parser () -&gt; Parser Exp -&gt; Parser Exp
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#inParens"><span class="hs-identifier hs-var">inParens</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">(Parser Exp -&gt; Parser Exp) -&gt; Parser Exp -&gt; Parser Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Parser () -&gt; Parser Exp
</span><a href="Futhark.Script.html#parseExp"><span class="hs-identifier hs-var">parseExp</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-154"></span><span>          </span><span class="annot"><span class="annottext">Parser () -&gt; Parser Exp -&gt; Parser Exp
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#inBraces"><span class="hs-identifier hs-var">inBraces</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(EntryName, Exp)] -&gt; Exp
</span><a href="Futhark.Script.html#Record"><span class="hs-identifier hs-var">Record</span></a></span><span> </span><span class="annot"><span class="annottext">([(EntryName, Exp)] -&gt; Exp)
-&gt; ParsecT Void EntryName Identity [(EntryName, Exp)] -&gt; Parser Exp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity (EntryName, Exp)
</span><a href="#local-6989586621684319668"><span class="hs-identifier hs-var">pField</span></a></span><span> </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity (EntryName, Exp)
-&gt; Parser EntryName
-&gt; ParsecT Void EntryName Identity [(EntryName, Exp)]
forall (m :: * -&gt; *) a sep. MonadPlus m =&gt; m a -&gt; m sep -&gt; m [a]
</span><span class="hs-operator hs-var">`sepBy`</span></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><a href="#local-6989586621684319651"><span class="hs-identifier hs-var">pComma</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-155"></span><span>          </span><span class="annot"><span class="annottext">Value -&gt; Exp
</span><a href="Futhark.Script.html#Const"><span class="hs-identifier hs-var">Const</span></a></span><span> </span><span class="annot"><span class="annottext">(Value -&gt; Exp)
-&gt; ParsecT Void EntryName Identity Value -&gt; Parser Exp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser () -&gt; ParsecT Void EntryName Identity Value
</span><span class="hs-identifier hs-var">V.parseValue</span></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-156"></span><span>          </span><span class="annot"><span class="annottext">EntryName -&gt; Exp
</span><a href="Futhark.Script.html#StringLit"><span class="hs-identifier hs-var">StringLit</span></a></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; Exp) -&gt; (String -&gt; EntryName) -&gt; String -&gt; Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; EntryName
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Exp)
-&gt; ParsecT Void EntryName Identity String -&gt; Parser Exp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser ()
-&gt; ParsecT Void EntryName Identity String
-&gt; ParsecT Void EntryName Identity String
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#lexeme"><span class="hs-identifier hs-var">lexeme</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Parser EntryName
</span><span class="hs-string">&quot;\&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
-&gt; ParsecT Void EntryName Identity String
-&gt; ParsecT Void EntryName Identity String
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity Char
-&gt; Parser EntryName -&gt; ParsecT Void EntryName Identity String
forall (m :: * -&gt; *) a sep. MonadPlus m =&gt; m a -&gt; m sep -&gt; m [a]
</span><span class="hs-identifier hs-var">manyTill</span></span><span> </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity Char
forall e s (m :: * -&gt; *).
(MonadParsec e s m, Token s ~ Char) =&gt;
m Char
</span><span class="hs-identifier hs-var">charLiteral</span></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><span class="hs-string">&quot;\&quot;&quot;</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-157"></span><span>          </span><span class="annot"><span class="annottext">Func -&gt; [Exp] -&gt; Exp
</span><a href="Futhark.Script.html#Call"><span class="hs-identifier hs-var">Call</span></a></span><span> </span><span class="annot"><span class="annottext">(Func -&gt; [Exp] -&gt; Exp)
-&gt; ParsecT Void EntryName Identity Func
-&gt; ParsecT Void EntryName Identity ([Exp] -&gt; Exp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity Func
</span><a href="#local-6989586621684319676"><span class="hs-identifier hs-var">parseFunc</span></a></span><span> </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity ([Exp] -&gt; Exp)
-&gt; ParsecT Void EntryName Identity [Exp] -&gt; Parser Exp
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Exp] -&gt; ParsecT Void EntryName Identity [Exp]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-158"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span>    </span><span id="local-6989586621684319679"><span class="annot"><span class="annottext">pPat :: ParsecT Void EntryName Identity [EntryName]
</span><a href="#local-6989586621684319679"><span class="hs-identifier hs-var hs-var">pPat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-161"></span><span>      </span><span class="annot"><span class="annottext">[ParsecT Void EntryName Identity [EntryName]]
-&gt; ParsecT Void EntryName Identity [EntryName]
forall (f :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable f, Alternative m) =&gt;
f (m a) -&gt; m a
</span><span class="hs-identifier hs-var">choice</span></span><span>
</span><span id="line-162"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Parser ()
-&gt; ParsecT Void EntryName Identity [EntryName]
-&gt; ParsecT Void EntryName Identity [EntryName]
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#inParens"><span class="hs-identifier hs-var">inParens</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">(ParsecT Void EntryName Identity [EntryName]
 -&gt; ParsecT Void EntryName Identity [EntryName])
-&gt; ParsecT Void EntryName Identity [EntryName]
-&gt; ParsecT Void EntryName Identity [EntryName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><a href="#local-6989586621684319667"><span class="hs-identifier hs-var">pVarName</span></a></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
-&gt; Parser EntryName -&gt; ParsecT Void EntryName Identity [EntryName]
forall (m :: * -&gt; *) a sep. MonadPlus m =&gt; m a -&gt; m sep -&gt; m [a]
</span><span class="hs-operator hs-var">`sepBy`</span></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><a href="#local-6989586621684319651"><span class="hs-identifier hs-var">pComma</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-163"></span><span>          </span><span class="annot"><span class="annottext">EntryName -&gt; [EntryName]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; [EntryName])
-&gt; Parser EntryName -&gt; ParsecT Void EntryName Identity [EntryName]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><a href="#local-6989586621684319667"><span class="hs-identifier hs-var">pVarName</span></a></span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-165"></span><span>
</span><span id="line-166"></span><span>    </span><span id="local-6989586621684319676"><span class="annot"><span class="annottext">parseFunc :: ParsecT Void EntryName Identity Func
</span><a href="#local-6989586621684319676"><span class="hs-identifier hs-var hs-var">parseFunc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-167"></span><span>      </span><span class="annot"><span class="annottext">[ParsecT Void EntryName Identity Func]
-&gt; ParsecT Void EntryName Identity Func
forall (f :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable f, Alternative m) =&gt;
f (m a) -&gt; m a
</span><span class="hs-identifier hs-var">choice</span></span><span>
</span><span id="line-168"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Func
</span><a href="Futhark.Script.html#FuncBuiltin"><span class="hs-identifier hs-var">FuncBuiltin</span></a></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; Func)
-&gt; Parser EntryName -&gt; ParsecT Void EntryName Identity Func
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Parser EntryName
</span><span class="hs-string">&quot;$&quot;</span></span><span> </span><span class="annot"><span class="annottext">Parser EntryName -&gt; Parser EntryName -&gt; Parser EntryName
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f b
</span><span class="hs-operator hs-var">*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><a href="#local-6989586621684319667"><span class="hs-identifier hs-var">pVarName</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-169"></span><span>          </span><span class="annot"><span class="annottext">EntryName -&gt; Func
</span><a href="Futhark.Script.html#FuncFut"><span class="hs-identifier hs-var">FuncFut</span></a></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; Func)
-&gt; Parser EntryName -&gt; ParsecT Void EntryName Identity Func
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Parser EntryName
</span><a href="#local-6989586621684319667"><span class="hs-identifier hs-var">pVarName</span></a></span><span>
</span><span id="line-170"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span>    </span><span id="local-6989586621684319591"><span class="annot"><span class="annottext">reserved :: [EntryName]
</span><a href="#local-6989586621684319591"><span class="hs-identifier hs-var hs-var">reserved</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;let&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;in&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span>    </span><span id="local-6989586621684319667"><span class="annot"><span class="annottext">pVarName :: Parser EntryName
</span><a href="#local-6989586621684319667"><span class="hs-identifier hs-var hs-var">pVarName</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Parser () -&gt; Parser EntryName -&gt; Parser EntryName
forall a. Parser () -&gt; Parser a -&gt; Parser a
</span><a href="Futhark.Script.html#lexeme"><span class="hs-identifier hs-var">lexeme</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
</span><a href="#local-6989586621684319682"><span class="hs-identifier hs-var">sep</span></a></span><span> </span><span class="annot"><span class="annottext">(Parser EntryName -&gt; Parser EntryName)
-&gt; (Parser EntryName -&gt; Parser EntryName)
-&gt; Parser EntryName
-&gt; Parser EntryName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Parser EntryName -&gt; Parser EntryName
forall e s (m :: * -&gt; *) a. MonadParsec e s m =&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">try</span></span><span> </span><span class="annot"><span class="annottext">(Parser EntryName -&gt; Parser EntryName)
-&gt; Parser EntryName -&gt; Parser EntryName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-175"></span><span>      </span><span id="local-6989586621684319574"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319574"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(String -&gt; EntryName)
-&gt; ParsecT Void EntryName Identity String -&gt; Parser EntryName
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; EntryName
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">(ParsecT Void EntryName Identity String -&gt; Parser EntryName)
-&gt; ParsecT Void EntryName Identity String -&gt; Parser EntryName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">:</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Char -&gt; ShowS)
-&gt; ParsecT Void EntryName Identity Char
-&gt; ParsecT Void EntryName Identity ShowS
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Token EntryName -&gt; Bool)
-&gt; ParsecT Void EntryName Identity (Token EntryName)
forall e s (m :: * -&gt; *).
MonadParsec e s m =&gt;
(Token s -&gt; Bool) -&gt; m (Token s)
</span><span class="hs-identifier hs-var">satisfy</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Bool
Token EntryName -&gt; Bool
</span><span class="hs-identifier hs-var">isAlpha</span></span><span> </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity ShowS
-&gt; ParsecT Void EntryName Identity String
-&gt; ParsecT Void EntryName Identity String
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">ParsecT Void EntryName Identity Char
-&gt; ParsecT Void EntryName Identity String
forall (m :: * -&gt; *) a. MonadPlus m =&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">many</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Token EntryName -&gt; Bool)
-&gt; ParsecT Void EntryName Identity (Token EntryName)
forall e s (m :: * -&gt; *).
MonadParsec e s m =&gt;
(Token s -&gt; Bool) -&gt; m (Token s)
</span><span class="hs-identifier hs-var">satisfy</span></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Bool
Token EntryName -&gt; Bool
</span><a href="#local-6989586621684319571"><span class="hs-identifier hs-var">constituent</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Parser ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Parser ()) -&gt; Bool -&gt; Parser ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319574"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; [EntryName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319591"><span class="hs-identifier hs-var">reserved</span></a></span><span>
</span><span id="line-177"></span><span>      </span><span class="annot"><span class="annottext">EntryName -&gt; Parser EntryName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319574"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-178"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-179"></span><span>        </span><span id="local-6989586621684319571"><span class="annot"><span class="annottext">constituent :: Char -&gt; Bool
</span><a href="#local-6989586621684319571"><span class="hs-identifier hs-var hs-var">constituent</span></a></span></span><span> </span><span id="local-6989586621684319567"><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621684319567"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Char -&gt; Bool
</span><span class="hs-identifier hs-var">isAlphaNum</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621684319567"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><a href="#local-6989586621684319567"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Char -&gt; Char -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Char
</span><span class="hs-char">'_'</span></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span class="hs-comment">-- | Parse a FutharkScript expression with normal whitespace handling.</span><span>
</span><span id="line-182"></span><span class="annot"><a href="Futhark.Script.html#parseExpFromText"><span class="hs-identifier hs-type">parseExpFromText</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">FilePath</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span>
</span><span id="line-183"></span><span id="parseExpFromText"><span class="annot"><span class="annottext">parseExpFromText :: String -&gt; EntryName -&gt; Either EntryName Exp
</span><a href="Futhark.Script.html#parseExpFromText"><span class="hs-identifier hs-var hs-var">parseExpFromText</span></a></span></span><span> </span><span id="local-6989586621684319563"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684319563"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684319562"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319562"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-184"></span><span>  </span><span class="annot"><span class="annottext">(ParseErrorBundle EntryName Void -&gt; Either EntryName Exp)
-&gt; (Exp -&gt; Either EntryName Exp)
-&gt; Either (ParseErrorBundle EntryName Void) Exp
-&gt; Either EntryName Exp
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntryName -&gt; Either EntryName Exp
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; Either EntryName Exp)
-&gt; (ParseErrorBundle EntryName Void -&gt; EntryName)
-&gt; ParseErrorBundle EntryName Void
-&gt; Either EntryName Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; EntryName
</span><span class="hs-identifier hs-var">T.pack</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; EntryName)
-&gt; (ParseErrorBundle EntryName Void -&gt; String)
-&gt; ParseErrorBundle EntryName Void
-&gt; EntryName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ParseErrorBundle EntryName Void -&gt; String
forall s e.
(VisualStream s, TraversableStream s, ShowErrorComponent e) =&gt;
ParseErrorBundle s e -&gt; String
</span><span class="hs-identifier hs-var">errorBundlePretty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Either EntryName Exp
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(Either (ParseErrorBundle EntryName Void) Exp
 -&gt; Either EntryName Exp)
-&gt; Either (ParseErrorBundle EntryName Void) Exp
-&gt; Either EntryName Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Parser Exp
-&gt; String
-&gt; EntryName
-&gt; Either (ParseErrorBundle EntryName Void) Exp
forall e s a.
Parsec e s a -&gt; String -&gt; s -&gt; Either (ParseErrorBundle s e) a
</span><span class="hs-identifier hs-var">parse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Parser () -&gt; Parser Exp
</span><a href="Futhark.Script.html#parseExp"><span class="hs-identifier hs-var">parseExp</span></a></span><span> </span><span class="annot"><span class="annottext">Parser ()
forall e s (m :: * -&gt; *).
(MonadParsec e s m, Token s ~ Char) =&gt;
m ()
</span><span class="hs-identifier hs-var">space</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684319563"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319562"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span id="local-6989586621684320194"><span class="annot"><a href="Futhark.Script.html#readVar"><span class="hs-identifier hs-type">readVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="annot"><a href="#local-6989586621684320194"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621684320194"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Server</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">VarName</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684320194"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">V.Value</span></span></span><span>
</span><span id="line-187"></span><span id="readVar"><span class="annot"><span class="annottext">readVar :: forall (m :: * -&gt; *).
(MonadError EntryName m, MonadIO m) =&gt;
Server -&gt; EntryName -&gt; m Value
</span><a href="Futhark.Script.html#readVar"><span class="hs-identifier hs-var hs-var">readVar</span></a></span></span><span> </span><span id="local-6989586621684319547"><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319547"><span class="hs-identifier hs-var">server</span></a></span></span><span> </span><span id="local-6989586621684319546"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319546"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-188"></span><span>  </span><span class="annot"><span class="annottext">(EntryName -&gt; m Value)
-&gt; (Value -&gt; m Value) -&gt; Either EntryName Value -&gt; m Value
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; m Value
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; m Value
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either EntryName Value -&gt; m Value)
-&gt; m (Either EntryName Value) -&gt; m Value
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">IO (Either EntryName Value) -&gt; m (Either EntryName Value)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Server -&gt; EntryName -&gt; IO (Either EntryName Value)
</span><span class="hs-identifier hs-var">getValue</span></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319547"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319546"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span id="local-6989586621684320184"><span class="annot"><a href="Futhark.Script.html#writeVar"><span class="hs-identifier hs-type">writeVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="annot"><a href="#local-6989586621684320184"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621684320184"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Server</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">VarName</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">V.Value</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684320184"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-191"></span><span id="writeVar"><span class="annot"><span class="annottext">writeVar :: forall (m :: * -&gt; *).
(MonadError EntryName m, MonadIO m) =&gt;
Server -&gt; EntryName -&gt; Value -&gt; m ()
</span><a href="Futhark.Script.html#writeVar"><span class="hs-identifier hs-var hs-var">writeVar</span></a></span></span><span> </span><span id="local-6989586621684319537"><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319537"><span class="hs-identifier hs-var">server</span></a></span></span><span> </span><span id="local-6989586621684319536"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319536"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684319535"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319535"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-192"></span><span>  </span><span class="annot"><span class="annottext">IO (Maybe CmdFailure) -&gt; m ()
forall (m :: * -&gt; *).
(MonadError EntryName m, MonadIO m) =&gt;
IO (Maybe CmdFailure) -&gt; m ()
</span><span class="hs-identifier hs-var">cmdMaybe</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe CmdFailure) -&gt; m ()) -&gt; IO (Maybe CmdFailure) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Maybe CmdFailure) -&gt; IO (Maybe CmdFailure)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Server -&gt; EntryName -&gt; Value -&gt; IO (Maybe CmdFailure)
</span><span class="hs-identifier hs-var">putValue</span></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319537"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319536"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319535"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span class="hs-comment">-- | A ScriptValue is either a base value or a partially applied</span><span>
</span><span id="line-195"></span><span class="hs-comment">-- function.  We don't have real first-class functions in</span><span>
</span><span id="line-196"></span><span class="hs-comment">-- FutharkScript, but we sort of have closures.</span><span>
</span><span id="line-197"></span><span class="hs-keyword">data</span><span> </span><span id="ScriptValue"><span class="annot"><a href="Futhark.Script.html#ScriptValue"><span class="hs-identifier hs-var">ScriptValue</span></a></span></span><span> </span><span id="local-6989586621684320180"><span class="annot"><a href="#local-6989586621684320180"><span class="hs-identifier hs-type">v</span></a></span></span><span>
</span><span id="line-198"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="SValue"><span class="annot"><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-var">SValue</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeName</span></span><span> </span><span class="annot"><a href="#local-6989586621684320180"><span class="hs-identifier hs-type">v</span></a></span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | Ins, then outs.  Yes, this is the opposite of more or less</span><span>
</span><span id="line-200"></span><span>    </span><span class="hs-comment">-- everywhere else.</span><span>
</span><span id="line-201"></span><span>    </span><span id="SFun"><span class="annot"><a href="Futhark.Script.html#SFun"><span class="hs-identifier hs-var">SFun</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">EntryName</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TypeName</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TypeName</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Script.html#ScriptValue"><span class="hs-identifier hs-type">ScriptValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684320180"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684319517"><span id="local-6989586621684319519"><span id="local-6989586621684319530"><span class="annot"><span class="annottext">Int -&gt; ScriptValue v -&gt; ShowS
[ScriptValue v] -&gt; ShowS
ScriptValue v -&gt; String
(Int -&gt; ScriptValue v -&gt; ShowS)
-&gt; (ScriptValue v -&gt; String)
-&gt; ([ScriptValue v] -&gt; ShowS)
-&gt; Show (ScriptValue v)
forall v. Show v =&gt; Int -&gt; ScriptValue v -&gt; ShowS
forall v. Show v =&gt; [ScriptValue v] -&gt; ShowS
forall v. Show v =&gt; ScriptValue v -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ScriptValue v] -&gt; ShowS
$cshowList :: forall v. Show v =&gt; [ScriptValue v] -&gt; ShowS
show :: ScriptValue v -&gt; String
$cshow :: forall v. Show v =&gt; ScriptValue v -&gt; String
showsPrec :: Int -&gt; ScriptValue v -&gt; ShowS
$cshowsPrec :: forall v. Show v =&gt; Int -&gt; ScriptValue v -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684319514"><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="annot"><a href="Futhark.Script.html#ScriptValue"><span class="hs-identifier hs-type">ScriptValue</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-205"></span><span>  </span><span id="local-6989586621684319511"><span class="annot"><span class="annottext">fmap :: forall a b. (a -&gt; b) -&gt; ScriptValue a -&gt; ScriptValue b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">fmap</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; b) -&gt; ScriptValue a -&gt; ScriptValue b
forall (t :: * -&gt; *) a b. Traversable t =&gt; (a -&gt; b) -&gt; t a -&gt; t b
</span><span class="hs-identifier hs-var">fmapDefault</span></span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684319477"><span id="local-6989586621684319479"><span id="local-6989586621684319481"><span id="local-6989586621684319483"><span id="local-6989586621684319485"><span id="local-6989586621684319487"><span id="local-6989586621684319489"><span id="local-6989586621684319491"><span id="local-6989586621684319493"><span id="local-6989586621684319495"><span id="local-6989586621684319497"><span id="local-6989586621684319499"><span id="local-6989586621684319501"><span id="local-6989586621684319503"><span id="local-6989586621684319505"><span id="local-6989586621684319508"><span class="annot"><span class="hs-identifier hs-type">Foldable</span></span><span> </span><span class="annot"><a href="Futhark.Script.html#ScriptValue"><span class="hs-identifier hs-type">ScriptValue</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-208"></span><span>  </span><span id="local-6989586621684319472"><span class="annot"><span class="annottext">foldMap :: forall m a. Monoid m =&gt; (a -&gt; m) -&gt; ScriptValue a -&gt; m
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">foldMap</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; m) -&gt; ScriptValue a -&gt; m
forall (t :: * -&gt; *) m a.
(Traversable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMapDefault</span></span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684319459"><span id="local-6989586621684319461"><span id="local-6989586621684319463"><span class="annot"><span class="hs-identifier hs-type">Traversable</span></span><span> </span><span class="annot"><a href="Futhark.Script.html#ScriptValue"><span class="hs-identifier hs-type">ScriptValue</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-211"></span><span>  </span><span id="local-6989586621684319447"><span class="annot"><span class="annottext">traverse :: forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; ScriptValue a -&gt; f (ScriptValue b)
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">traverse</span></span></span><span> </span><span id="local-6989586621684319445"><span class="annot"><span class="annottext">a -&gt; f b
</span><a href="#local-6989586621684319445"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-type">SValue</span></a></span><span> </span><span id="local-6989586621684319444"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319444"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684319443"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684319443"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; b -&gt; ScriptValue b
forall v. EntryName -&gt; v -&gt; ScriptValue v
</span><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-var">SValue</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319444"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">(b -&gt; ScriptValue b) -&gt; f b -&gt; f (ScriptValue b)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; f b
</span><a href="#local-6989586621684319445"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684319443"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-212"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">traverse</span></span><span> </span><span id="local-6989586621684319442"><span class="annot"><span class="annottext">a -&gt; f b
</span><a href="#local-6989586621684319442"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#SFun"><span class="hs-identifier hs-type">SFun</span></a></span><span> </span><span id="local-6989586621684319441"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319441"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span id="local-6989586621684319440"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319440"><span class="hs-identifier hs-var">ins</span></a></span></span><span> </span><span id="local-6989586621684319439"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319439"><span class="hs-identifier hs-var">outs</span></a></span></span><span> </span><span id="local-6989586621684319438"><span class="annot"><span class="annottext">[ScriptValue a]
</span><a href="#local-6989586621684319438"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-213"></span><span>    </span><span class="annot"><span class="annottext">EntryName
-&gt; [EntryName] -&gt; [EntryName] -&gt; [ScriptValue b] -&gt; ScriptValue b
forall v.
EntryName
-&gt; [EntryName] -&gt; [EntryName] -&gt; [ScriptValue v] -&gt; ScriptValue v
</span><a href="Futhark.Script.html#SFun"><span class="hs-identifier hs-var">SFun</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319441"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319440"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319439"><span class="hs-identifier hs-var">outs</span></a></span><span> </span><span class="annot"><span class="annottext">([ScriptValue b] -&gt; ScriptValue b)
-&gt; f [ScriptValue b] -&gt; f (ScriptValue b)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(ScriptValue a -&gt; f (ScriptValue b))
-&gt; [ScriptValue a] -&gt; f [ScriptValue b]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a -&gt; f b) -&gt; ScriptValue a -&gt; f (ScriptValue b)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; f b
</span><a href="#local-6989586621684319442"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ScriptValue a]
</span><a href="#local-6989586621684319438"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span class="hs-comment">-- | The type of a 'ScriptValue' - either a value type or a function type.</span><span>
</span><span id="line-216"></span><span class="hs-keyword">data</span><span> </span><span id="ScriptValueType"><span class="annot"><a href="Futhark.Script.html#ScriptValueType"><span class="hs-identifier hs-var">ScriptValueType</span></a></span></span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="STValue"><span class="annot"><a href="Futhark.Script.html#STValue"><span class="hs-identifier hs-var">STValue</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">TypeName</span></span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | Ins, then outs.</span><span>
</span><span id="line-219"></span><span>    </span><span id="STFun"><span class="annot"><a href="Futhark.Script.html#STFun"><span class="hs-identifier hs-var">STFun</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TypeName</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">TypeName</span></span><span class="hs-special">]</span><span>
</span><span id="line-220"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684319428"><span id="local-6989586621684319434"><span class="annot"><span class="annottext">ScriptValueType -&gt; ScriptValueType -&gt; Bool
(ScriptValueType -&gt; ScriptValueType -&gt; Bool)
-&gt; (ScriptValueType -&gt; ScriptValueType -&gt; Bool)
-&gt; Eq ScriptValueType
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: ScriptValueType -&gt; ScriptValueType -&gt; Bool
$c/= :: ScriptValueType -&gt; ScriptValueType -&gt; Bool
== :: ScriptValueType -&gt; ScriptValueType -&gt; Bool
$c== :: ScriptValueType -&gt; ScriptValueType -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684319416"><span id="local-6989586621684319418"><span id="local-6989586621684319425"><span class="annot"><span class="annottext">Int -&gt; ScriptValueType -&gt; ShowS
[ScriptValueType] -&gt; ShowS
ScriptValueType -&gt; String
(Int -&gt; ScriptValueType -&gt; ShowS)
-&gt; (ScriptValueType -&gt; String)
-&gt; ([ScriptValueType] -&gt; ShowS)
-&gt; Show ScriptValueType
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ScriptValueType] -&gt; ShowS
$cshowList :: [ScriptValueType] -&gt; ShowS
show :: ScriptValueType -&gt; String
$cshow :: ScriptValueType -&gt; String
showsPrec :: Int -&gt; ScriptValueType -&gt; ShowS
$cshowsPrec :: Int -&gt; ScriptValueType -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684319411"><span id="local-6989586621684319413"><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="Futhark.Script.html#ScriptValueType"><span class="hs-identifier hs-type">ScriptValueType</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-223"></span><span>  </span><span id="local-6989586621684319407"><span class="annot"><span class="annottext">ppr :: ScriptValueType -&gt; Doc
</span><a href="#local-6989586621684319407"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#STValue"><span class="hs-identifier hs-type">STValue</span></a></span><span> </span><span id="local-6989586621684319406"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319406"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319406"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-224"></span><span>  </span><span class="annot"><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#STFun"><span class="hs-identifier hs-type">STFun</span></a></span><span> </span><span id="local-6989586621684319405"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319405"><span class="hs-identifier hs-var">ins</span></a></span></span><span> </span><span id="local-6989586621684319404"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319404"><span class="hs-identifier hs-var">outs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-225"></span><span>    </span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">spread</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; [Doc] -&gt; [Doc]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">intersperse</span></span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;-&gt;&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EntryName -&gt; Doc) -&gt; [EntryName] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319405"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">[Doc] -&gt; [Doc] -&gt; [Doc]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Doc
</span><a href="#local-6989586621684319403"><span class="hs-identifier hs-var">outs'</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-227"></span><span>      </span><span id="local-6989586621684319403"><span class="annot"><span class="annottext">outs' :: Doc
</span><a href="#local-6989586621684319403"><span class="hs-identifier hs-var hs-var">outs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319404"><span class="hs-identifier hs-var">outs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-228"></span><span>        </span><span class="hs-special">[</span><span id="local-6989586621684319402"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319402"><span class="hs-identifier hs-var">out</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Doc
</span><span class="hs-identifier hs-var">strictText</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319402"><span class="hs-identifier hs-var">out</span></a></span><span>
</span><span id="line-229"></span><span>        </span><span class="annot"><span class="annottext">[EntryName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">parens</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; Doc) -&gt; Doc -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; Doc) -&gt; [EntryName] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Doc
</span><span class="hs-identifier hs-var">strictText</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319404"><span class="hs-identifier hs-var">outs</span></a></span><span>
</span><span id="line-230"></span><span>
</span><span id="line-231"></span><span class="hs-comment">-- | A Haskell-level value or a variable on the server.</span><span>
</span><span id="line-232"></span><span class="hs-keyword">data</span><span> </span><span id="ValOrVar"><span class="annot"><a href="Futhark.Script.html#ValOrVar"><span class="hs-identifier hs-var">ValOrVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="VVal"><span class="annot"><a href="Futhark.Script.html#VVal"><span class="hs-identifier hs-var">VVal</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">V.Value</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="VVar"><span class="annot"><a href="Futhark.Script.html#VVar"><span class="hs-identifier hs-var">VVar</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">VarName</span></span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684319390"><span id="local-6989586621684319392"><span id="local-6989586621684319398"><span class="annot"><span class="annottext">Int -&gt; ValOrVar -&gt; ShowS
[ValOrVar] -&gt; ShowS
ValOrVar -&gt; String
(Int -&gt; ValOrVar -&gt; ShowS)
-&gt; (ValOrVar -&gt; String) -&gt; ([ValOrVar] -&gt; ShowS) -&gt; Show ValOrVar
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ValOrVar] -&gt; ShowS
$cshowList :: [ValOrVar] -&gt; ShowS
show :: ValOrVar -&gt; String
$cshow :: ValOrVar -&gt; String
showsPrec :: Int -&gt; ValOrVar -&gt; ShowS
$cshowsPrec :: Int -&gt; ValOrVar -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>
</span><span id="line-235"></span><span class="hs-comment">-- | The intermediate values produced by an expression - in</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- particular, these may not be on the server.</span><span>
</span><span id="line-237"></span><span class="hs-keyword">type</span><span> </span><span id="ExpValue"><span class="annot"><a href="Futhark.Script.html#ExpValue"><span class="hs-identifier hs-var">ExpValue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.Test.Values.html#Compound"><span class="hs-identifier hs-type">V.Compound</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#ScriptValue"><span class="hs-identifier hs-type">ScriptValue</span></a></span><span> </span><span class="annot"><a href="Futhark.Script.html#ValOrVar"><span class="hs-identifier hs-type">ValOrVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="hs-comment">-- | The type of a 'ScriptValue'.</span><span>
</span><span id="line-240"></span><span id="local-6989586621684320136"><span class="annot"><a href="Futhark.Script.html#scriptValueType"><span class="hs-identifier hs-type">scriptValueType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#ScriptValue"><span class="hs-identifier hs-type">ScriptValue</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684320136"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#ScriptValueType"><span class="hs-identifier hs-type">ScriptValueType</span></a></span></span><span>
</span><span id="line-241"></span><span id="scriptValueType"><span class="annot"><span class="annottext">scriptValueType :: forall v. ScriptValue v -&gt; ScriptValueType
</span><a href="Futhark.Script.html#scriptValueType"><span class="hs-identifier hs-var hs-var">scriptValueType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-type">SValue</span></a></span><span> </span><span id="local-6989586621684319389"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319389"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">v
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; ScriptValueType
</span><a href="Futhark.Script.html#STValue"><span class="hs-identifier hs-var">STValue</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319389"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-242"></span><span class="annot"><a href="Futhark.Script.html#scriptValueType"><span class="hs-identifier hs-var">scriptValueType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#SFun"><span class="hs-identifier hs-type">SFun</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684319388"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319388"><span class="hs-identifier hs-var">ins</span></a></span></span><span> </span><span id="local-6989586621684319387"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319387"><span class="hs-identifier hs-var">outs</span></a></span></span><span> </span><span class="annot"><span class="annottext">[ScriptValue v]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EntryName] -&gt; [EntryName] -&gt; ScriptValueType
</span><a href="Futhark.Script.html#STFun"><span class="hs-identifier hs-var">STFun</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319388"><span class="hs-identifier hs-var">ins</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319387"><span class="hs-identifier hs-var">outs</span></a></span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span class="hs-comment">-- | The set of server-side variables in the value.</span><span>
</span><span id="line-245"></span><span class="annot"><a href="Futhark.Script.html#serverVarsInValue"><span class="hs-identifier hs-type">serverVarsInValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#ExpValue"><span class="hs-identifier hs-type">ExpValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">VarName</span></span><span>
</span><span id="line-246"></span><span id="serverVarsInValue"><span class="annot"><span class="annottext">serverVarsInValue :: ExpValue -&gt; Set EntryName
</span><a href="Futhark.Script.html#serverVarsInValue"><span class="hs-identifier hs-var hs-var">serverVarsInValue</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[EntryName] -&gt; Set EntryName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">([EntryName] -&gt; Set EntryName)
-&gt; (ExpValue -&gt; [EntryName]) -&gt; ExpValue -&gt; Set EntryName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(ScriptValue ValOrVar -&gt; [EntryName])
-&gt; [ScriptValue ValOrVar] -&gt; [EntryName]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; [EntryName]
</span><a href="#local-6989586621684319384"><span class="hs-identifier hs-var">isVar</span></a></span><span> </span><span class="annot"><span class="annottext">([ScriptValue ValOrVar] -&gt; [EntryName])
-&gt; (ExpValue -&gt; [ScriptValue ValOrVar]) -&gt; ExpValue -&gt; [EntryName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExpValue -&gt; [ScriptValue ValOrVar]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-248"></span><span>    </span><span id="local-6989586621684319384"><span class="annot"><span class="annottext">isVar :: ScriptValue ValOrVar -&gt; [EntryName]
</span><a href="#local-6989586621684319384"><span class="hs-identifier hs-var hs-var">isVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-type">SValue</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#VVar"><span class="hs-identifier hs-type">VVar</span></a></span><span> </span><span id="local-6989586621684319381"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319381"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319381"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-249"></span><span>    </span><span class="annot"><a href="#local-6989586621684319384"><span class="hs-identifier hs-var">isVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-type">SValue</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#VVal"><span class="hs-identifier hs-type">VVal</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-250"></span><span>    </span><span class="annot"><a href="#local-6989586621684319384"><span class="hs-identifier hs-var">isVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#SFun"><span class="hs-identifier hs-type">SFun</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684319380"><span class="annot"><span class="annottext">[ScriptValue ValOrVar]
</span><a href="#local-6989586621684319380"><span class="hs-identifier hs-var">closure</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ScriptValue ValOrVar -&gt; [EntryName])
-&gt; [ScriptValue ValOrVar] -&gt; [EntryName]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; [EntryName]
</span><a href="#local-6989586621684319384"><span class="hs-identifier hs-var">isVar</span></a></span><span> </span><span class="annot"><span class="annottext">([ScriptValue ValOrVar] -&gt; [EntryName])
-&gt; [ScriptValue ValOrVar] -&gt; [EntryName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ScriptValue ValOrVar] -&gt; [ScriptValue ValOrVar]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><span class="hs-identifier hs-var">toList</span></span><span> </span><span class="annot"><span class="annottext">[ScriptValue ValOrVar]
</span><a href="#local-6989586621684319380"><span class="hs-identifier hs-var">closure</span></a></span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="hs-comment">-- | Convert a value into a corresponding expression.</span><span>
</span><span id="line-253"></span><span class="annot"><a href="Futhark.Script.html#valueToExp"><span class="hs-identifier hs-type">valueToExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#ExpValue"><span class="hs-identifier hs-type">ExpValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span>
</span><span id="line-254"></span><span id="valueToExp"><span class="annot"><span class="annottext">valueToExp :: ExpValue -&gt; Exp
</span><a href="Futhark.Script.html#valueToExp"><span class="hs-identifier hs-var hs-var">valueToExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Test.Values.html#ValueAtom"><span class="hs-identifier hs-type">V.ValueAtom</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-type">SValue</span></a></span><span> </span><span id="local-6989586621684319378"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319378"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#VVar"><span class="hs-identifier hs-type">VVar</span></a></span><span> </span><span id="local-6989586621684319377"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319377"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; Exp
</span><a href="Futhark.Script.html#ServerVar"><span class="hs-identifier hs-var">ServerVar</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319378"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319377"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-256"></span><span class="annot"><a href="Futhark.Script.html#valueToExp"><span class="hs-identifier hs-var">valueToExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Test.Values.html#ValueAtom"><span class="hs-identifier hs-type">V.ValueAtom</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-type">SValue</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#VVal"><span class="hs-identifier hs-type">VVal</span></a></span><span> </span><span id="local-6989586621684319376"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319376"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="annottext">Value -&gt; Exp
</span><a href="Futhark.Script.html#Const"><span class="hs-identifier hs-var">Const</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319376"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-258"></span><span class="annot"><a href="Futhark.Script.html#valueToExp"><span class="hs-identifier hs-var">valueToExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Test.Values.html#ValueAtom"><span class="hs-identifier hs-type">V.ValueAtom</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#SFun"><span class="hs-identifier hs-type">SFun</span></a></span><span> </span><span id="local-6989586621684319375"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319375"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684319374"><span class="annot"><span class="annottext">[ScriptValue ValOrVar]
</span><a href="#local-6989586621684319374"><span class="hs-identifier hs-var">closure</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><span class="annottext">Func -&gt; [Exp] -&gt; Exp
</span><a href="Futhark.Script.html#Call"><span class="hs-identifier hs-var">Call</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntryName -&gt; Func
</span><a href="Futhark.Script.html#FuncFut"><span class="hs-identifier hs-var">FuncFut</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319375"><span class="hs-identifier hs-var">fname</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Exp] -&gt; Exp) -&gt; [Exp] -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ScriptValue ValOrVar -&gt; Exp) -&gt; [ScriptValue ValOrVar] -&gt; [Exp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpValue -&gt; Exp
</span><a href="Futhark.Script.html#valueToExp"><span class="hs-identifier hs-var">valueToExp</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpValue -&gt; Exp)
-&gt; (ScriptValue ValOrVar -&gt; ExpValue)
-&gt; ScriptValue ValOrVar
-&gt; Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; ExpValue
forall v. v -&gt; Compound v
</span><a href="Futhark.Test.Values.html#ValueAtom"><span class="hs-identifier hs-var">V.ValueAtom</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ScriptValue ValOrVar]
</span><a href="#local-6989586621684319374"><span class="hs-identifier hs-var">closure</span></a></span><span>
</span><span id="line-260"></span><span class="annot"><a href="Futhark.Script.html#valueToExp"><span class="hs-identifier hs-var">valueToExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Test.Values.html#ValueRecord"><span class="hs-identifier hs-type">V.ValueRecord</span></a></span><span> </span><span id="local-6989586621684319372"><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319372"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-261"></span><span>  </span><span class="annot"><span class="annottext">[(EntryName, Exp)] -&gt; Exp
</span><a href="Futhark.Script.html#Record"><span class="hs-identifier hs-var">Record</span></a></span><span> </span><span class="annot"><span class="annottext">([(EntryName, Exp)] -&gt; Exp) -&gt; [(EntryName, Exp)] -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map EntryName Exp -&gt; [(EntryName, Exp)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">(Map EntryName Exp -&gt; [(EntryName, Exp)])
-&gt; Map EntryName Exp -&gt; [(EntryName, Exp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ExpValue -&gt; Exp) -&gt; Map EntryName ExpValue -&gt; Map EntryName Exp
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">ExpValue -&gt; Exp
</span><a href="Futhark.Script.html#valueToExp"><span class="hs-identifier hs-var">valueToExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319372"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-262"></span><span class="annot"><a href="Futhark.Script.html#valueToExp"><span class="hs-identifier hs-var">valueToExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Test.Values.html#ValueTuple"><span class="hs-identifier hs-type">V.ValueTuple</span></a></span><span> </span><span id="local-6989586621684319368"><span class="annot"><span class="annottext">[ExpValue]
</span><a href="#local-6989586621684319368"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-263"></span><span>  </span><span class="annot"><span class="annottext">[Exp] -&gt; Exp
</span><a href="Futhark.Script.html#Tuple"><span class="hs-identifier hs-var">Tuple</span></a></span><span> </span><span class="annot"><span class="annottext">([Exp] -&gt; Exp) -&gt; [Exp] -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ExpValue -&gt; Exp) -&gt; [ExpValue] -&gt; [Exp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ExpValue -&gt; Exp
</span><a href="Futhark.Script.html#valueToExp"><span class="hs-identifier hs-var">valueToExp</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpValue]
</span><a href="#local-6989586621684319368"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span class="hs-comment">-- | How to evaluate a builtin function.</span><span>
</span><span id="line-266"></span><span class="hs-keyword">type</span><span> </span><span id="EvalBuiltin"><span class="annot"><a href="Futhark.Script.html#EvalBuiltin"><span class="hs-identifier hs-var">EvalBuiltin</span></a></span></span><span> </span><span id="local-6989586621684319367"><span class="annot"><a href="#local-6989586621684319367"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Test.Values.html#CompoundValue"><span class="hs-identifier hs-type">V.CompoundValue</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684319367"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Futhark.Test.Values.html#CompoundValue"><span class="hs-identifier hs-type">V.CompoundValue</span></a></span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span class="hs-comment">-- | Symbol table used for local variable lookups during expression evaluation.</span><span>
</span><span id="line-269"></span><span class="hs-keyword">type</span><span> </span><span id="VTable"><span class="annot"><a href="Futhark.Script.html#VTable"><span class="hs-identifier hs-var">VTable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">VarName</span></span><span> </span><span class="annot"><a href="Futhark.Script.html#ExpValue"><span class="hs-identifier hs-type">ExpValue</span></a></span><span>
</span><span id="line-270"></span><span>
</span><span id="line-271"></span><span class="hs-comment">-- | Evaluate a FutharkScript expression relative to some running server.</span><span>
</span><span id="line-272"></span><span class="annot"><a href="Futhark.Script.html#evalExp"><span class="hs-identifier hs-type">evalExp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-273"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621684320122"><span class="annot"><a href="#local-6989586621684320122"><span class="hs-identifier hs-type">m</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-274"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="annot"><a href="#local-6989586621684320122"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621684320122"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-275"></span><span>  </span><span class="annot"><a href="Futhark.Script.html#EvalBuiltin"><span class="hs-identifier hs-type">EvalBuiltin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684320122"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-276"></span><span>  </span><span class="annot"><a href="Futhark.Script.html#ScriptServer"><span class="hs-identifier hs-type">ScriptServer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-277"></span><span>  </span><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-278"></span><span>  </span><span class="annot"><a href="#local-6989586621684320122"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Futhark.Script.html#ExpValue"><span class="hs-identifier hs-type">ExpValue</span></a></span><span>
</span><span id="line-279"></span><span id="evalExp"><span class="annot"><span class="annottext">evalExp :: forall (m :: * -&gt; *).
(MonadError EntryName m, MonadIO m) =&gt;
EvalBuiltin m -&gt; ScriptServer -&gt; Exp -&gt; m ExpValue
</span><a href="Futhark.Script.html#evalExp"><span class="hs-identifier hs-var hs-var">evalExp</span></a></span></span><span> </span><span id="local-6989586621684319209"><span class="annot"><span class="annottext">EvalBuiltin m
</span><a href="#local-6989586621684319209"><span class="hs-identifier hs-var">builtin</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#ScriptServer"><span class="hs-identifier hs-type">ScriptServer</span></a></span><span> </span><span id="local-6989586621684319208"><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319208"><span class="hs-identifier hs-var">server</span></a></span></span><span> </span><span id="local-6989586621684319207"><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621684319207"><span class="hs-identifier hs-var">counter</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684319206"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684319206"><span class="hs-identifier hs-var">top_level_e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-280"></span><span>  </span><span id="local-6989586621684319205"><span class="annot"><span class="annottext">IORef [EntryName]
</span><a href="#local-6989586621684319205"><span class="hs-identifier hs-var">vars</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IORef [EntryName]) -&gt; m (IORef [EntryName])
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (IORef [EntryName]) -&gt; m (IORef [EntryName]))
-&gt; IO (IORef [EntryName]) -&gt; m (IORef [EntryName])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[EntryName] -&gt; IO (IORef [EntryName])
forall a. a -&gt; IO (IORef a)
</span><span class="hs-identifier hs-var">newIORef</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-281"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684319194"><span class="annot"><span class="annottext">newVar :: EntryName -&gt; m EntryName
</span><a href="#local-6989586621684319194"><span class="hs-identifier hs-var hs-var">newVar</span></a></span></span><span> </span><span id="local-6989586621684319193"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319193"><span class="hs-identifier hs-var">base</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IO EntryName -&gt; m EntryName
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO EntryName -&gt; m EntryName) -&gt; IO EntryName -&gt; m EntryName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-282"></span><span>        </span><span id="local-6989586621684319192"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684319192"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IORef Int -&gt; IO Int
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621684319207"><span class="hs-identifier hs-var">counter</span></a></span><span>
</span><span id="line-283"></span><span>        </span><span class="annot"><span class="annottext">IORef Int -&gt; (Int -&gt; Int) -&gt; IO ()
forall a. IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><span class="hs-identifier hs-var">modifyIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><a href="#local-6989586621684319207"><span class="hs-identifier hs-var">counter</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684319185"><span class="annot"><span class="annottext">v :: EntryName
</span><a href="#local-6989586621684319185"><span class="hs-identifier hs-var hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319193"><span class="hs-identifier hs-var">base</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; EntryName
forall a. Pretty a =&gt; a -&gt; EntryName
</span><a href="Futhark.Util.Pretty.html#prettyText"><span class="hs-identifier hs-var">prettyText</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684319192"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-285"></span><span>        </span><span class="annot"><span class="annottext">IORef [EntryName] -&gt; ([EntryName] -&gt; [EntryName]) -&gt; IO ()
forall a. IORef a -&gt; (a -&gt; a) -&gt; IO ()
</span><span class="hs-identifier hs-var">modifyIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef [EntryName]
</span><a href="#local-6989586621684319205"><span class="hs-identifier hs-var">vars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319185"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; [EntryName] -&gt; [EntryName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>        </span><span class="annot"><span class="annottext">EntryName -&gt; IO EntryName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319185"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span>      </span><span class="annot"><a href="#local-6989586621684319183"><span class="hs-identifier hs-type">toVal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#ValOrVar"><span class="hs-identifier hs-type">ValOrVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684320122"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">V.Value</span></span><span>
</span><span id="line-289"></span><span>      </span><span id="local-6989586621684319183"><span class="annot"><span class="annottext">toVal :: ValOrVar -&gt; m Value
</span><a href="#local-6989586621684319183"><span class="hs-identifier hs-var hs-var">toVal</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#VVal"><span class="hs-identifier hs-type">VVal</span></a></span><span> </span><span id="local-6989586621684319182"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319182"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; m Value
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319182"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-290"></span><span>      </span><span class="annot"><a href="#local-6989586621684319183"><span class="hs-identifier hs-var">toVal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#VVar"><span class="hs-identifier hs-type">VVar</span></a></span><span> </span><span id="local-6989586621684319181"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319181"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Server -&gt; EntryName -&gt; m Value
forall (m :: * -&gt; *).
(MonadError EntryName m, MonadIO m) =&gt;
Server -&gt; EntryName -&gt; m Value
</span><a href="Futhark.Script.html#readVar"><span class="hs-identifier hs-var">readVar</span></a></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319208"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319181"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span>      </span><span class="annot"><a href="#local-6989586621684319180"><span class="hs-identifier hs-type">toVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#ValOrVar"><span class="hs-identifier hs-type">ValOrVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684320122"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">VarName</span></span><span>
</span><span id="line-293"></span><span>      </span><span id="local-6989586621684319180"><span class="annot"><span class="annottext">toVar :: ValOrVar -&gt; m EntryName
</span><a href="#local-6989586621684319180"><span class="hs-identifier hs-var hs-var">toVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#VVar"><span class="hs-identifier hs-type">VVar</span></a></span><span> </span><span id="local-6989586621684319179"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319179"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; m EntryName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319179"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-294"></span><span>      </span><span class="annot"><a href="#local-6989586621684319180"><span class="hs-identifier hs-var">toVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#VVal"><span class="hs-identifier hs-type">VVal</span></a></span><span> </span><span id="local-6989586621684319178"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319178"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-295"></span><span>        </span><span id="local-6989586621684319177"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319177"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; m EntryName
forall {m :: * -&gt; *}. MonadIO m =&gt; EntryName -&gt; m EntryName
</span><a href="#local-6989586621684319194"><span class="hs-identifier hs-var">newVar</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;const&quot;</span></span><span>
</span><span id="line-296"></span><span>        </span><span class="annot"><span class="annottext">Server -&gt; EntryName -&gt; Value -&gt; m ()
forall (m :: * -&gt; *).
(MonadError EntryName m, MonadIO m) =&gt;
Server -&gt; EntryName -&gt; Value -&gt; m ()
</span><a href="Futhark.Script.html#writeVar"><span class="hs-identifier hs-var">writeVar</span></a></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319208"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319177"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319178"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-297"></span><span>        </span><span class="annot"><span class="annottext">EntryName -&gt; m EntryName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319177"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span>      </span><span id="local-6989586621684319167"><span class="annot"><span class="annottext">scriptValueToValOrVar :: ScriptValue a -&gt; m a
</span><a href="#local-6989586621684319167"><span class="hs-identifier hs-var hs-var">scriptValueToValOrVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#SFun"><span class="hs-identifier hs-type">SFun</span></a></span><span> </span><span id="local-6989586621684319166"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319166"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[ScriptValue a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-300"></span><span>        </span><span class="annot"><span class="annottext">EntryName -&gt; m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; m a) -&gt; EntryName -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;Function &quot;</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319166"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot; not fully applied.&quot;</span></span><span>
</span><span id="line-301"></span><span>      </span><span class="annot"><a href="#local-6989586621684319167"><span class="hs-identifier hs-var">scriptValueToValOrVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-type">SValue</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684319165"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684319165"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-302"></span><span>        </span><span class="annot"><span class="annottext">a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684319165"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span>      </span><span class="annot"><a href="#local-6989586621684319164"><span class="hs-identifier hs-type">scriptValueToVal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#ScriptValue"><span class="hs-identifier hs-type">ScriptValue</span></a></span><span> </span><span class="annot"><a href="Futhark.Script.html#ValOrVar"><span class="hs-identifier hs-type">ValOrVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684320122"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">V.Value</span></span><span>
</span><span id="line-305"></span><span>      </span><span id="local-6989586621684319164"><span class="annot"><span class="annottext">scriptValueToVal :: ScriptValue ValOrVar -&gt; m Value
</span><a href="#local-6989586621684319164"><span class="hs-identifier hs-var hs-var">scriptValueToVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValOrVar -&gt; m Value
</span><a href="#local-6989586621684319183"><span class="hs-identifier hs-var">toVal</span></a></span><span> </span><span class="annot"><span class="annottext">(ValOrVar -&gt; m Value)
-&gt; (ScriptValue ValOrVar -&gt; m ValOrVar)
-&gt; ScriptValue ValOrVar
-&gt; m Value
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; m ValOrVar
forall {m :: * -&gt; *} {a}.
MonadError EntryName m =&gt;
ScriptValue a -&gt; m a
</span><a href="#local-6989586621684319167"><span class="hs-identifier hs-var">scriptValueToValOrVar</span></a></span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span>      </span><span class="annot"><a href="#local-6989586621684319162"><span class="hs-identifier hs-type">scriptValueToVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#ScriptValue"><span class="hs-identifier hs-type">ScriptValue</span></a></span><span> </span><span class="annot"><a href="Futhark.Script.html#ValOrVar"><span class="hs-identifier hs-type">ValOrVar</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684320122"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">VarName</span></span><span>
</span><span id="line-308"></span><span>      </span><span id="local-6989586621684319162"><span class="annot"><span class="annottext">scriptValueToVar :: ScriptValue ValOrVar -&gt; m EntryName
</span><a href="#local-6989586621684319162"><span class="hs-identifier hs-var hs-var">scriptValueToVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValOrVar -&gt; m EntryName
</span><a href="#local-6989586621684319180"><span class="hs-identifier hs-var">toVar</span></a></span><span> </span><span class="annot"><span class="annottext">(ValOrVar -&gt; m EntryName)
-&gt; (ScriptValue ValOrVar -&gt; m ValOrVar)
-&gt; ScriptValue ValOrVar
-&gt; m EntryName
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; m ValOrVar
forall {m :: * -&gt; *} {a}.
MonadError EntryName m =&gt;
ScriptValue a -&gt; m a
</span><a href="#local-6989586621684319167"><span class="hs-identifier hs-var">scriptValueToValOrVar</span></a></span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span>      </span><span class="annot"><a href="#local-6989586621684319161"><span class="hs-identifier hs-type">interValToVal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#ExpValue"><span class="hs-identifier hs-type">ExpValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684320122"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Futhark.Test.Values.html#CompoundValue"><span class="hs-identifier hs-type">V.CompoundValue</span></a></span><span>
</span><span id="line-311"></span><span>      </span><span id="local-6989586621684319161"><span class="annot"><span class="annottext">interValToVal :: ExpValue -&gt; m CompoundValue
</span><a href="#local-6989586621684319161"><span class="hs-identifier hs-var hs-var">interValToVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ScriptValue ValOrVar -&gt; m Value) -&gt; ExpValue -&gt; m CompoundValue
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; m Value
</span><a href="#local-6989586621684319164"><span class="hs-identifier hs-var">scriptValueToVal</span></a></span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span>      </span><span class="annot"><a href="#local-6989586621684319160"><span class="hs-identifier hs-type">interValToVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#ExpValue"><span class="hs-identifier hs-type">ExpValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684320122"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">VarName</span></span><span>
</span><span id="line-314"></span><span>      </span><span id="local-6989586621684319160"><span class="annot"><span class="annottext">interValToVar :: ExpValue -&gt; m EntryName
</span><a href="#local-6989586621684319160"><span class="hs-identifier hs-var hs-var">interValToVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Test.Values.html#ValueAtom"><span class="hs-identifier hs-type">V.ValueAtom</span></a></span><span> </span><span id="local-6989586621684319159"><span class="annot"><span class="annottext">ScriptValue ValOrVar
</span><a href="#local-6989586621684319159"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; m EntryName
</span><a href="#local-6989586621684319162"><span class="hs-identifier hs-var">scriptValueToVar</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar
</span><a href="#local-6989586621684319159"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-315"></span><span>      </span><span class="annot"><a href="#local-6989586621684319160"><span class="hs-identifier hs-var">interValToVar</span></a></span><span> </span><span class="annot"><span class="annottext">ExpValue
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; m EntryName
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;Unexpected tuple or record value.&quot;</span></span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span>      </span><span class="annot"><a href="#local-6989586621684319158"><span class="hs-identifier hs-type">valToInterVal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Test.Values.html#CompoundValue"><span class="hs-identifier hs-type">V.CompoundValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#ExpValue"><span class="hs-identifier hs-type">ExpValue</span></a></span><span>
</span><span id="line-318"></span><span>      </span><span id="local-6989586621684319158"><span class="annot"><span class="annottext">valToInterVal :: CompoundValue -&gt; ExpValue
</span><a href="#local-6989586621684319158"><span class="hs-identifier hs-var hs-var">valToInterVal</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Value -&gt; ScriptValue ValOrVar) -&gt; CompoundValue -&gt; ExpValue
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">((Value -&gt; ScriptValue ValOrVar) -&gt; CompoundValue -&gt; ExpValue)
-&gt; (Value -&gt; ScriptValue ValOrVar) -&gt; CompoundValue -&gt; ExpValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684319157"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319157"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-319"></span><span>        </span><span class="annot"><span class="annottext">EntryName -&gt; ValOrVar -&gt; ScriptValue ValOrVar
forall v. EntryName -&gt; v -&gt; ScriptValue v
</span><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-var">SValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValueType -&gt; EntryName
</span><span class="hs-identifier hs-var">V.valueTypeTextNoDims</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; ValueType
</span><span class="hs-identifier hs-var">V.valueType</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319157"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ValOrVar -&gt; ScriptValue ValOrVar)
-&gt; ValOrVar -&gt; ScriptValue ValOrVar
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; ValOrVar
</span><a href="Futhark.Script.html#VVal"><span class="hs-identifier hs-var">VVal</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319157"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-320"></span><span>
</span><span id="line-321"></span><span>      </span><span id="local-6989586621684319154"><span class="annot"><span class="annottext">simpleType :: Compound ScriptValueType -&gt; Bool
</span><a href="#local-6989586621684319154"><span class="hs-identifier hs-var hs-var">simpleType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Test.Values.html#ValueAtom"><span class="hs-identifier hs-type">V.ValueAtom</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#STValue"><span class="hs-identifier hs-type">STValue</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-322"></span><span>      </span><span class="annot"><a href="#local-6989586621684319154"><span class="hs-identifier hs-var">simpleType</span></a></span><span> </span><span class="annot"><span class="annottext">Compound ScriptValueType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span>      </span><span class="annot"><a href="#local-6989586621684319153"><span class="hs-identifier hs-type">letMatch</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">VarName</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#ExpValue"><span class="hs-identifier hs-type">ExpValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684320122"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Futhark.Script.html#VTable"><span class="hs-identifier hs-type">VTable</span></a></span><span>
</span><span id="line-325"></span><span>      </span><span id="local-6989586621684319153"><span class="annot"><span class="annottext">letMatch :: [EntryName] -&gt; ExpValue -&gt; m (Map EntryName ExpValue)
</span><a href="#local-6989586621684319153"><span class="hs-identifier hs-var hs-var">letMatch</span></a></span></span><span> </span><span id="local-6989586621684319152"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319152"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span id="local-6989586621684319151"><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684319151"><span class="hs-identifier hs-var">val</span></a></span></span><span>
</span><span id="line-326"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684319150"><span class="annot"><span class="annottext">[ExpValue]
</span><a href="#local-6989586621684319150"><span class="hs-identifier hs-var">vals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExpValue -&gt; [ExpValue]
forall v. Compound v -&gt; [Compound v]
</span><a href="Futhark.Test.Values.html#unCompound"><span class="hs-identifier hs-var">V.unCompound</span></a></span><span> </span><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684319151"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-327"></span><span>          </span><span class="annot"><span class="annottext">[EntryName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319152"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[ExpValue] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[ExpValue]
</span><a href="#local-6989586621684319150"><span class="hs-identifier hs-var">vals</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-328"></span><span>          </span><span class="annot"><span class="annottext">Map EntryName ExpValue -&gt; m (Map EntryName ExpValue)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Map EntryName ExpValue -&gt; m (Map EntryName ExpValue))
-&gt; Map EntryName ExpValue -&gt; m (Map EntryName ExpValue)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(EntryName, ExpValue)] -&gt; Map EntryName ExpValue
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EntryName] -&gt; [ExpValue] -&gt; [(EntryName, ExpValue)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319152"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpValue]
</span><a href="#local-6989586621684319150"><span class="hs-identifier hs-var">vals</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-329"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-330"></span><span>          </span><span class="annot"><span class="annottext">EntryName -&gt; m (Map EntryName ExpValue)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; m (Map EntryName ExpValue))
-&gt; EntryName -&gt; m (Map EntryName ExpValue)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-331"></span><span>            </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;Pat: &quot;</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[EntryName] -&gt; EntryName
forall a. Pretty a =&gt; a -&gt; EntryName
</span><a href="Futhark.Util.Pretty.html#prettyTextOneLine"><span class="hs-identifier hs-var">prettyTextOneLine</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319152"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-332"></span><span>              </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;\nDoes not match value of type: &quot;</span></span><span>
</span><span id="line-333"></span><span>              </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Compound ScriptValueType -&gt; EntryName
forall a. Pretty a =&gt; a -&gt; EntryName
</span><a href="Futhark.Util.Pretty.html#prettyTextOneLine"><span class="hs-identifier hs-var">prettyTextOneLine</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ScriptValue ValOrVar -&gt; ScriptValueType)
-&gt; ExpValue -&gt; Compound ScriptValueType
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; ScriptValueType
forall v. ScriptValue v -&gt; ScriptValueType
</span><a href="Futhark.Script.html#scriptValueType"><span class="hs-identifier hs-var">scriptValueType</span></a></span><span> </span><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684319151"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span>      </span><span class="annot"><a href="#local-6989586621684319145"><span class="hs-identifier hs-type">evalExp'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#VTable"><span class="hs-identifier hs-type">VTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684320122"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Futhark.Script.html#ExpValue"><span class="hs-identifier hs-type">ExpValue</span></a></span><span>
</span><span id="line-336"></span><span>      </span><span id="local-6989586621684319145"><span class="annot"><span class="annottext">evalExp' :: Map EntryName ExpValue -&gt; Exp -&gt; m ExpValue
</span><a href="#local-6989586621684319145"><span class="hs-identifier hs-var hs-var">evalExp'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#ServerVar"><span class="hs-identifier hs-type">ServerVar</span></a></span><span> </span><span id="local-6989586621684319144"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319144"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684319143"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319143"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-337"></span><span>        </span><span class="annot"><span class="annottext">ExpValue -&gt; m ExpValue
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ExpValue -&gt; m ExpValue) -&gt; ExpValue -&gt; m ExpValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; ExpValue
forall v. v -&gt; Compound v
</span><a href="Futhark.Test.Values.html#ValueAtom"><span class="hs-identifier hs-var">V.ValueAtom</span></a></span><span> </span><span class="annot"><span class="annottext">(ScriptValue ValOrVar -&gt; ExpValue)
-&gt; ScriptValue ValOrVar -&gt; ExpValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; ValOrVar -&gt; ScriptValue ValOrVar
forall v. EntryName -&gt; v -&gt; ScriptValue v
</span><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-var">SValue</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319144"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">(ValOrVar -&gt; ScriptValue ValOrVar)
-&gt; ValOrVar -&gt; ScriptValue ValOrVar
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; ValOrVar
</span><a href="Futhark.Script.html#VVar"><span class="hs-identifier hs-var">VVar</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319143"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-338"></span><span>      </span><span class="annot"><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span id="local-6989586621684319142"><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319142"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Call"><span class="hs-identifier hs-type">Call</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#FuncBuiltin"><span class="hs-identifier hs-type">FuncBuiltin</span></a></span><span> </span><span id="local-6989586621684319141"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319141"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684319140"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319140"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-339"></span><span>        </span><span id="local-6989586621684319139"><span class="annot"><span class="annottext">CompoundValue
</span><a href="#local-6989586621684319139"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EvalBuiltin m
</span><a href="#local-6989586621684319209"><span class="hs-identifier hs-var">builtin</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319141"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">([CompoundValue] -&gt; m CompoundValue)
-&gt; m [CompoundValue] -&gt; m CompoundValue
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; m CompoundValue) -&gt; [Exp] -&gt; m [CompoundValue]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpValue -&gt; m CompoundValue
</span><a href="#local-6989586621684319161"><span class="hs-identifier hs-var">interValToVal</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpValue -&gt; m CompoundValue)
-&gt; (Exp -&gt; m ExpValue) -&gt; Exp -&gt; m CompoundValue
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue -&gt; Exp -&gt; m ExpValue
</span><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319142"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319140"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-340"></span><span>        </span><span class="annot"><span class="annottext">ExpValue -&gt; m ExpValue
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ExpValue -&gt; m ExpValue) -&gt; ExpValue -&gt; m ExpValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CompoundValue -&gt; ExpValue
</span><a href="#local-6989586621684319158"><span class="hs-identifier hs-var">valToInterVal</span></a></span><span> </span><span class="annot"><span class="annottext">CompoundValue
</span><a href="#local-6989586621684319139"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-341"></span><span>      </span><span class="annot"><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span id="local-6989586621684319137"><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319137"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Call"><span class="hs-identifier hs-type">Call</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#FuncFut"><span class="hs-identifier hs-type">FuncFut</span></a></span><span> </span><span id="local-6989586621684319136"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319136"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684319135"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319135"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-342"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684319134"><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684319134"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Map EntryName ExpValue -&gt; Maybe ExpValue
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319136"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319137"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-343"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Exp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319135"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-344"></span><span>            </span><span class="annot"><span class="annottext">EntryName -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; m ()) -&gt; EntryName -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;Locally bound name cannot be invoked as a function: &quot;</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName
forall a. Pretty a =&gt; a -&gt; EntryName
</span><a href="Futhark.Util.Pretty.html#prettyText"><span class="hs-identifier hs-var">prettyText</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319136"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-345"></span><span>          </span><span class="annot"><span class="annottext">ExpValue -&gt; m ExpValue
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684319134"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-346"></span><span>      </span><span class="annot"><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span id="local-6989586621684319130"><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319130"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Call"><span class="hs-identifier hs-type">Call</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#FuncFut"><span class="hs-identifier hs-type">FuncFut</span></a></span><span> </span><span id="local-6989586621684319129"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319129"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684319128"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319128"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-347"></span><span>        </span><span id="local-6989586621684319127"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319127"><span class="hs-identifier hs-var">in_types</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([InputType] -&gt; [EntryName]) -&gt; m [InputType] -&gt; m [EntryName]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(InputType -&gt; EntryName) -&gt; [InputType] -&gt; [EntryName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">InputType -&gt; EntryName
</span><span class="hs-identifier hs-var hs-var">inputType</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m [InputType] -&gt; m [EntryName]) -&gt; m [InputType] -&gt; m [EntryName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either CmdFailure [InputType]) -&gt; m [InputType]
forall (m :: * -&gt; *) a.
(MonadError EntryName m, MonadIO m) =&gt;
IO (Either CmdFailure a) -&gt; m a
</span><span class="hs-identifier hs-var">cmdEither</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either CmdFailure [InputType]) -&gt; m [InputType])
-&gt; IO (Either CmdFailure [InputType]) -&gt; m [InputType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Server -&gt; EntryName -&gt; IO (Either CmdFailure [InputType])
</span><span class="hs-identifier hs-var">cmdInputs</span></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319208"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319129"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-348"></span><span>        </span><span id="local-6989586621684319123"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319123"><span class="hs-identifier hs-var">out_types</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([OutputType] -&gt; [EntryName]) -&gt; m [OutputType] -&gt; m [EntryName]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(OutputType -&gt; EntryName) -&gt; [OutputType] -&gt; [EntryName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">OutputType -&gt; EntryName
</span><span class="hs-identifier hs-var hs-var">outputType</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m [OutputType] -&gt; m [EntryName])
-&gt; m [OutputType] -&gt; m [EntryName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either CmdFailure [OutputType]) -&gt; m [OutputType]
forall (m :: * -&gt; *) a.
(MonadError EntryName m, MonadIO m) =&gt;
IO (Either CmdFailure a) -&gt; m a
</span><span class="hs-identifier hs-var">cmdEither</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either CmdFailure [OutputType]) -&gt; m [OutputType])
-&gt; IO (Either CmdFailure [OutputType]) -&gt; m [OutputType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Server -&gt; EntryName -&gt; IO (Either CmdFailure [OutputType])
</span><span class="hs-identifier hs-var">cmdOutputs</span></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319208"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319129"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span>        </span><span id="local-6989586621684319120"><span class="annot"><span class="annottext">[ExpValue]
</span><a href="#local-6989586621684319120"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; m ExpValue) -&gt; [Exp] -&gt; m [ExpValue]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map EntryName ExpValue -&gt; Exp -&gt; m ExpValue
</span><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319130"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319128"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-351"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684319118"><span class="annot"><span class="annottext">es_types :: [Compound ScriptValueType]
</span><a href="#local-6989586621684319118"><span class="hs-identifier hs-var hs-var">es_types</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ExpValue -&gt; Compound ScriptValueType)
-&gt; [ExpValue] -&gt; [Compound ScriptValueType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ScriptValue ValOrVar -&gt; ScriptValueType)
-&gt; ExpValue -&gt; Compound ScriptValueType
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; ScriptValueType
forall v. ScriptValue v -&gt; ScriptValueType
</span><a href="Futhark.Script.html#scriptValueType"><span class="hs-identifier hs-var">scriptValueType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ExpValue]
</span><a href="#local-6989586621684319120"><span class="hs-identifier hs-var">es'</span></a></span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Compound ScriptValueType -&gt; Bool)
-&gt; [Compound ScriptValueType] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Compound ScriptValueType -&gt; Bool
</span><a href="#local-6989586621684319154"><span class="hs-identifier hs-var">simpleType</span></a></span><span> </span><span class="annot"><span class="annottext">[Compound ScriptValueType]
</span><a href="#local-6989586621684319118"><span class="hs-identifier hs-var">es_types</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-354"></span><span>          </span><span class="annot"><span class="annottext">EntryName -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; m ()) -&gt; EntryName -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-355"></span><span>            </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;Literate Futhark does not support passing script-constructed records, tuples, or functions to entry points.\n&quot;</span></span><span>
</span><span id="line-356"></span><span>              </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;Create a Futhark wrapper function.&quot;</span></span><span>
</span><span id="line-357"></span><span>
</span><span id="line-358"></span><span>        </span><span class="hs-comment">-- Careful to not require saturated application, but do still</span><span>
</span><span id="line-359"></span><span>        </span><span class="hs-comment">-- check for over-saturation.</span><span>
</span><span id="line-360"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684319113"><span class="annot"><span class="annottext">too_many :: Bool
</span><a href="#local-6989586621684319113"><span class="hs-identifier hs-var hs-var">too_many</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Compound ScriptValueType] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Compound ScriptValueType]
</span><a href="#local-6989586621684319118"><span class="hs-identifier hs-var">es_types</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">[EntryName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319127"><span class="hs-identifier hs-var">in_types</span></a></span><span>
</span><span id="line-361"></span><span>            </span><span id="local-6989586621684319109"><span class="annot"><span class="annottext">too_wrong :: [Bool]
</span><a href="#local-6989586621684319109"><span class="hs-identifier hs-var hs-var">too_wrong</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Compound ScriptValueType -&gt; Compound ScriptValueType -&gt; Bool)
-&gt; [Compound ScriptValueType]
-&gt; [Compound ScriptValueType]
-&gt; [Bool]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Compound ScriptValueType -&gt; Compound ScriptValueType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">(/=)</span></span><span> </span><span class="annot"><span class="annottext">[Compound ScriptValueType]
</span><a href="#local-6989586621684319118"><span class="hs-identifier hs-var">es_types</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EntryName -&gt; Compound ScriptValueType)
-&gt; [EntryName] -&gt; [Compound ScriptValueType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScriptValueType -&gt; Compound ScriptValueType
forall v. v -&gt; Compound v
</span><a href="Futhark.Test.Values.html#ValueAtom"><span class="hs-identifier hs-var">V.ValueAtom</span></a></span><span> </span><span class="annot"><span class="annottext">(ScriptValueType -&gt; Compound ScriptValueType)
-&gt; (EntryName -&gt; ScriptValueType)
-&gt; EntryName
-&gt; Compound ScriptValueType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; ScriptValueType
</span><a href="Futhark.Script.html#STValue"><span class="hs-identifier hs-var">STValue</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319127"><span class="hs-identifier hs-var">in_types</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Bool] -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><span class="hs-identifier hs-var">or</span></span><span> </span><span class="annot"><span class="annottext">([Bool] -&gt; Bool) -&gt; [Bool] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684319113"><span class="hs-identifier hs-var">too_many</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; [Bool] -&gt; [Bool]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621684319109"><span class="hs-identifier hs-var">too_wrong</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; (EntryName -&gt; m ()) -&gt; EntryName -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; m ()) -&gt; EntryName -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-363"></span><span>          </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;Function \&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319129"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;\&quot; expects arguments of types:\n&quot;</span></span><span>
</span><span id="line-364"></span><span>            </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Compound EntryName -&gt; EntryName
forall a. Pretty a =&gt; a -&gt; EntryName
</span><a href="Futhark.Util.Pretty.html#prettyText"><span class="hs-identifier hs-var">prettyText</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Compound EntryName] -&gt; Compound EntryName
forall v. [Compound v] -&gt; Compound v
</span><a href="Futhark.Test.Values.html#mkCompound"><span class="hs-identifier hs-var">V.mkCompound</span></a></span><span> </span><span class="annot"><span class="annottext">([Compound EntryName] -&gt; Compound EntryName)
-&gt; [Compound EntryName] -&gt; Compound EntryName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; Compound EntryName)
-&gt; [EntryName] -&gt; [Compound EntryName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Compound EntryName
forall v. v -&gt; Compound v
</span><a href="Futhark.Test.Values.html#ValueAtom"><span class="hs-identifier hs-var">V.ValueAtom</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319127"><span class="hs-identifier hs-var">in_types</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-365"></span><span>            </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;\nBut called with arguments of types:\n&quot;</span></span><span>
</span><span id="line-366"></span><span>            </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Compound (Compound ScriptValueType) -&gt; EntryName
forall a. Pretty a =&gt; a -&gt; EntryName
</span><a href="Futhark.Util.Pretty.html#prettyText"><span class="hs-identifier hs-var">prettyText</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Compound (Compound ScriptValueType)]
-&gt; Compound (Compound ScriptValueType)
forall v. [Compound v] -&gt; Compound v
</span><a href="Futhark.Test.Values.html#mkCompound"><span class="hs-identifier hs-var">V.mkCompound</span></a></span><span> </span><span class="annot"><span class="annottext">([Compound (Compound ScriptValueType)]
 -&gt; Compound (Compound ScriptValueType))
-&gt; [Compound (Compound ScriptValueType)]
-&gt; Compound (Compound ScriptValueType)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Compound ScriptValueType -&gt; Compound (Compound ScriptValueType))
-&gt; [Compound ScriptValueType]
-&gt; [Compound (Compound ScriptValueType)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Compound ScriptValueType -&gt; Compound (Compound ScriptValueType)
forall v. v -&gt; Compound v
</span><a href="Futhark.Test.Values.html#ValueAtom"><span class="hs-identifier hs-var">V.ValueAtom</span></a></span><span> </span><span class="annot"><span class="annottext">[Compound ScriptValueType]
</span><a href="#local-6989586621684319118"><span class="hs-identifier hs-var">es_types</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span>
</span><span id="line-368"></span><span>        </span><span id="local-6989586621684319103"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319103"><span class="hs-identifier hs-var">ins</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; m EntryName) -&gt; [Exp] -&gt; m [EntryName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpValue -&gt; m EntryName
</span><a href="#local-6989586621684319160"><span class="hs-identifier hs-var">interValToVar</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpValue -&gt; m EntryName)
-&gt; (Exp -&gt; m ExpValue) -&gt; Exp -&gt; m EntryName
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue -&gt; Exp -&gt; m ExpValue
</span><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319130"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319128"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-369"></span><span>
</span><span id="line-370"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[EntryName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319127"><span class="hs-identifier hs-var">in_types</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[EntryName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319103"><span class="hs-identifier hs-var">ins</span></a></span><span>
</span><span id="line-371"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-372"></span><span>            </span><span id="local-6989586621684319102"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319102"><span class="hs-identifier hs-var">outs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; m EntryName -&gt; m [EntryName]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EntryName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319123"><span class="hs-identifier hs-var">out_types</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m EntryName -&gt; m [EntryName]) -&gt; m EntryName -&gt; m [EntryName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; m EntryName
forall {m :: * -&gt; *}. MonadIO m =&gt; EntryName -&gt; m EntryName
</span><a href="#local-6989586621684319194"><span class="hs-identifier hs-var">newVar</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;out&quot;</span></span><span>
</span><span id="line-373"></span><span>            </span><span class="annot"><span class="annottext">m [EntryName] -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m [EntryName] -&gt; m ()) -&gt; m [EntryName] -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Either CmdFailure [EntryName]) -&gt; m [EntryName]
forall (m :: * -&gt; *) a.
(MonadError EntryName m, MonadIO m) =&gt;
IO (Either CmdFailure a) -&gt; m a
</span><span class="hs-identifier hs-var">cmdEither</span></span><span> </span><span class="annot"><span class="annottext">(IO (Either CmdFailure [EntryName]) -&gt; m [EntryName])
-&gt; IO (Either CmdFailure [EntryName]) -&gt; m [EntryName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Server
-&gt; EntryName
-&gt; [EntryName]
-&gt; [EntryName]
-&gt; IO (Either CmdFailure [EntryName])
</span><span class="hs-identifier hs-var">cmdCall</span></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319208"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319129"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319102"><span class="hs-identifier hs-var">outs</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319103"><span class="hs-identifier hs-var">ins</span></a></span><span>
</span><span id="line-374"></span><span>            </span><span class="annot"><span class="annottext">ExpValue -&gt; m ExpValue
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ExpValue -&gt; m ExpValue) -&gt; ExpValue -&gt; m ExpValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ExpValue] -&gt; ExpValue
forall v. [Compound v] -&gt; Compound v
</span><a href="Futhark.Test.Values.html#mkCompound"><span class="hs-identifier hs-var">V.mkCompound</span></a></span><span> </span><span class="annot"><span class="annottext">([ExpValue] -&gt; ExpValue) -&gt; [ExpValue] -&gt; ExpValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ScriptValue ValOrVar -&gt; ExpValue)
-&gt; [ScriptValue ValOrVar] -&gt; [ExpValue]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; ExpValue
forall v. v -&gt; Compound v
</span><a href="Futhark.Test.Values.html#ValueAtom"><span class="hs-identifier hs-var">V.ValueAtom</span></a></span><span> </span><span class="annot"><span class="annottext">([ScriptValue ValOrVar] -&gt; [ExpValue])
-&gt; [ScriptValue ValOrVar] -&gt; [ExpValue]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; ValOrVar -&gt; ScriptValue ValOrVar)
-&gt; [EntryName] -&gt; [ValOrVar] -&gt; [ScriptValue ValOrVar]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; ValOrVar -&gt; ScriptValue ValOrVar
forall v. EntryName -&gt; v -&gt; ScriptValue v
</span><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-var">SValue</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319123"><span class="hs-identifier hs-var">out_types</span></a></span><span> </span><span class="annot"><span class="annottext">([ValOrVar] -&gt; [ScriptValue ValOrVar])
-&gt; [ValOrVar] -&gt; [ScriptValue ValOrVar]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; ValOrVar) -&gt; [EntryName] -&gt; [ValOrVar]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; ValOrVar
</span><a href="Futhark.Script.html#VVar"><span class="hs-identifier hs-var">VVar</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319102"><span class="hs-identifier hs-var">outs</span></a></span><span>
</span><span id="line-375"></span><span>          </span><span class="hs-keyword">else</span><span>
</span><span id="line-376"></span><span>            </span><span class="annot"><span class="annottext">ExpValue -&gt; m ExpValue
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ExpValue -&gt; m ExpValue)
-&gt; ([ScriptValue ValOrVar] -&gt; ExpValue)
-&gt; [ScriptValue ValOrVar]
-&gt; m ExpValue
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; ExpValue
forall v. v -&gt; Compound v
</span><a href="Futhark.Test.Values.html#ValueAtom"><span class="hs-identifier hs-var">V.ValueAtom</span></a></span><span> </span><span class="annot"><span class="annottext">(ScriptValue ValOrVar -&gt; ExpValue)
-&gt; ([ScriptValue ValOrVar] -&gt; ScriptValue ValOrVar)
-&gt; [ScriptValue ValOrVar]
-&gt; ExpValue
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EntryName
-&gt; [EntryName]
-&gt; [EntryName]
-&gt; [ScriptValue ValOrVar]
-&gt; ScriptValue ValOrVar
forall v.
EntryName
-&gt; [EntryName] -&gt; [EntryName] -&gt; [ScriptValue v] -&gt; ScriptValue v
</span><a href="Futhark.Script.html#SFun"><span class="hs-identifier hs-var">SFun</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319129"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319127"><span class="hs-identifier hs-var">in_types</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319123"><span class="hs-identifier hs-var">out_types</span></a></span><span> </span><span class="annot"><span class="annottext">([ScriptValue ValOrVar] -&gt; m ExpValue)
-&gt; [ScriptValue ValOrVar] -&gt; m ExpValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-377"></span><span>              </span><span class="annot"><span class="annottext">(EntryName -&gt; ValOrVar -&gt; ScriptValue ValOrVar)
-&gt; [EntryName] -&gt; [ValOrVar] -&gt; [ScriptValue ValOrVar]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; ValOrVar -&gt; ScriptValue ValOrVar
forall v. EntryName -&gt; v -&gt; ScriptValue v
</span><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-var">SValue</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319127"><span class="hs-identifier hs-var">in_types</span></a></span><span> </span><span class="annot"><span class="annottext">([ValOrVar] -&gt; [ScriptValue ValOrVar])
-&gt; [ValOrVar] -&gt; [ScriptValue ValOrVar]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; ValOrVar) -&gt; [EntryName] -&gt; [ValOrVar]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; ValOrVar
</span><a href="Futhark.Script.html#VVar"><span class="hs-identifier hs-var">VVar</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319103"><span class="hs-identifier hs-var">ins</span></a></span><span>
</span><span id="line-378"></span><span>      </span><span class="annot"><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#StringLit"><span class="hs-identifier hs-type">StringLit</span></a></span><span> </span><span id="local-6989586621684319098"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319098"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-379"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Maybe Value
forall t. PutValue t =&gt; t -&gt; Maybe Value
</span><span class="hs-identifier hs-var">V.putValue</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319098"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-380"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684319096"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319096"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-381"></span><span>            </span><span class="annot"><span class="annottext">ExpValue -&gt; m ExpValue
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ExpValue -&gt; m ExpValue) -&gt; ExpValue -&gt; m ExpValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; ExpValue
forall v. v -&gt; Compound v
</span><a href="Futhark.Test.Values.html#ValueAtom"><span class="hs-identifier hs-var">V.ValueAtom</span></a></span><span> </span><span class="annot"><span class="annottext">(ScriptValue ValOrVar -&gt; ExpValue)
-&gt; ScriptValue ValOrVar -&gt; ExpValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; ValOrVar -&gt; ScriptValue ValOrVar
forall v. EntryName -&gt; v -&gt; ScriptValue v
</span><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-var">SValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValueType -&gt; EntryName
</span><span class="hs-identifier hs-var">V.valueTypeText</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; ValueType
</span><span class="hs-identifier hs-var">V.valueType</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319096"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ValOrVar -&gt; ScriptValue ValOrVar)
-&gt; ValOrVar -&gt; ScriptValue ValOrVar
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; ValOrVar
</span><a href="Futhark.Script.html#VVal"><span class="hs-identifier hs-var">VVal</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319096"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-382"></span><span>          </span><span class="annot"><span class="annottext">Maybe Value
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m ExpValue
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m ExpValue) -&gt; String -&gt; m ExpValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unable to write value &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319098"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-383"></span><span>      </span><span class="annot"><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Const"><span class="hs-identifier hs-type">Const</span></a></span><span> </span><span id="local-6989586621684319092"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319092"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-384"></span><span>        </span><span class="annot"><span class="annottext">ExpValue -&gt; m ExpValue
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ExpValue -&gt; m ExpValue) -&gt; ExpValue -&gt; m ExpValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; ExpValue
forall v. v -&gt; Compound v
</span><a href="Futhark.Test.Values.html#ValueAtom"><span class="hs-identifier hs-var">V.ValueAtom</span></a></span><span> </span><span class="annot"><span class="annottext">(ScriptValue ValOrVar -&gt; ExpValue)
-&gt; ScriptValue ValOrVar -&gt; ExpValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; ValOrVar -&gt; ScriptValue ValOrVar
forall v. EntryName -&gt; v -&gt; ScriptValue v
</span><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-var">SValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValueType -&gt; EntryName
</span><span class="hs-identifier hs-var">V.valueTypeTextNoDims</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Value -&gt; ValueType
</span><span class="hs-identifier hs-var">V.valueType</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319092"><span class="hs-identifier hs-var">val</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ValOrVar -&gt; ScriptValue ValOrVar)
-&gt; ValOrVar -&gt; ScriptValue ValOrVar
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Value -&gt; ValOrVar
</span><a href="Futhark.Script.html#VVal"><span class="hs-identifier hs-var">VVal</span></a></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319092"><span class="hs-identifier hs-var">val</span></a></span><span>
</span><span id="line-385"></span><span>      </span><span class="annot"><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span id="local-6989586621684319091"><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319091"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Tuple"><span class="hs-identifier hs-type">Tuple</span></a></span><span> </span><span id="local-6989586621684319090"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319090"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-386"></span><span>        </span><span class="annot"><span class="annottext">[ExpValue] -&gt; ExpValue
forall v. [Compound v] -&gt; Compound v
</span><a href="Futhark.Test.Values.html#ValueTuple"><span class="hs-identifier hs-var">V.ValueTuple</span></a></span><span> </span><span class="annot"><span class="annottext">([ExpValue] -&gt; ExpValue) -&gt; m [ExpValue] -&gt; m ExpValue
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; m ExpValue) -&gt; [Exp] -&gt; m [ExpValue]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map EntryName ExpValue -&gt; Exp -&gt; m ExpValue
</span><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319091"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684319090"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-387"></span><span>      </span><span class="annot"><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span id="local-6989586621684319089"><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319089"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684319088"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684319088"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684319087"><span class="annot"><span class="annottext">[(EntryName, Exp)]
</span><a href="#local-6989586621684319087"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-388"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EntryName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[EntryName] -&gt; [EntryName]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#nubOrd"><span class="hs-identifier hs-var">nubOrd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((EntryName, Exp) -&gt; EntryName)
-&gt; [(EntryName, Exp)] -&gt; [EntryName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(EntryName, Exp) -&gt; EntryName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(EntryName, Exp)]
</span><a href="#local-6989586621684319087"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">[EntryName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((EntryName, Exp) -&gt; EntryName)
-&gt; [(EntryName, Exp)] -&gt; [EntryName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(EntryName, Exp) -&gt; EntryName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(EntryName, Exp)]
</span><a href="#local-6989586621684319087"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-389"></span><span>          </span><span class="annot"><span class="annottext">EntryName -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; m ()) -&gt; EntryName -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;Record &quot;</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; EntryName
forall a. Pretty a =&gt; a -&gt; EntryName
</span><a href="Futhark.Util.Pretty.html#prettyText"><span class="hs-identifier hs-var">prettyText</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684319088"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot; has duplicate fields.&quot;</span></span><span>
</span><span id="line-390"></span><span>        </span><span class="annot"><span class="annottext">Map EntryName ExpValue -&gt; ExpValue
forall v. Map EntryName (Compound v) -&gt; Compound v
</span><a href="Futhark.Test.Values.html#ValueRecord"><span class="hs-identifier hs-var">V.ValueRecord</span></a></span><span> </span><span class="annot"><span class="annottext">(Map EntryName ExpValue -&gt; ExpValue)
-&gt; m (Map EntryName ExpValue) -&gt; m ExpValue
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; m ExpValue)
-&gt; Map EntryName Exp -&gt; m (Map EntryName ExpValue)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map EntryName ExpValue -&gt; Exp -&gt; m ExpValue
</span><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319089"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(EntryName, Exp)] -&gt; Map EntryName Exp
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(EntryName, Exp)]
</span><a href="#local-6989586621684319087"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-391"></span><span>      </span><span class="annot"><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span id="local-6989586621684319086"><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319086"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684319085"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319085"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684319084"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684319084"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621684319083"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684319083"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-392"></span><span>        </span><span id="local-6989586621684319082"><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684319082"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue -&gt; Exp -&gt; m ExpValue
</span><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319086"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684319084"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-393"></span><span>        </span><span id="local-6989586621684319081"><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319081"><span class="hs-identifier hs-var">pat_vtable</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[EntryName] -&gt; ExpValue -&gt; m (Map EntryName ExpValue)
</span><a href="#local-6989586621684319153"><span class="hs-identifier hs-var">letMatch</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319085"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684319082"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-394"></span><span>        </span><span class="annot"><span class="annottext">Map EntryName ExpValue -&gt; Exp -&gt; m ExpValue
</span><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319081"><span class="hs-identifier hs-var">pat_vtable</span></a></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue
-&gt; Map EntryName ExpValue -&gt; Map EntryName ExpValue
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue
</span><a href="#local-6989586621684319086"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684319083"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684319067"><span class="annot"><span class="annottext">freeNonresultVars :: ExpValue -&gt; m ExpValue
</span><a href="#local-6989586621684319067"><span class="hs-identifier hs-var hs-var">freeNonresultVars</span></a></span></span><span> </span><span id="local-6989586621684319066"><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684319066"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-397"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684319065"><span class="annot"><span class="annottext">v_vars :: Set EntryName
</span><a href="#local-6989586621684319065"><span class="hs-identifier hs-var hs-var">v_vars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpValue -&gt; Set EntryName
</span><a href="Futhark.Script.html#serverVarsInValue"><span class="hs-identifier hs-var">serverVarsInValue</span></a></span><span> </span><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684319066"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-398"></span><span>        </span><span id="local-6989586621684319064"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319064"><span class="hs-identifier hs-var">to_free</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [EntryName] -&gt; m [EntryName]
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO [EntryName] -&gt; m [EntryName])
-&gt; IO [EntryName] -&gt; m [EntryName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; Bool) -&gt; [EntryName] -&gt; [EntryName]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntryName -&gt; Set EntryName -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.notMember`</span></span><span> </span><span class="annot"><span class="annottext">Set EntryName
</span><a href="#local-6989586621684319065"><span class="hs-identifier hs-var">v_vars</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([EntryName] -&gt; [EntryName]) -&gt; IO [EntryName] -&gt; IO [EntryName]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">IORef [EntryName] -&gt; IO [EntryName]
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef [EntryName]
</span><a href="#local-6989586621684319205"><span class="hs-identifier hs-var">vars</span></a></span><span>
</span><span id="line-399"></span><span>        </span><span class="annot"><span class="annottext">IO (Maybe CmdFailure) -&gt; m ()
forall (m :: * -&gt; *).
(MonadError EntryName m, MonadIO m) =&gt;
IO (Maybe CmdFailure) -&gt; m ()
</span><span class="hs-identifier hs-var">cmdMaybe</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe CmdFailure) -&gt; m ()) -&gt; IO (Maybe CmdFailure) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Server -&gt; [EntryName] -&gt; IO (Maybe CmdFailure)
</span><span class="hs-identifier hs-var">cmdFree</span></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319208"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684319064"><span class="hs-identifier hs-var">to_free</span></a></span><span>
</span><span id="line-400"></span><span>        </span><span class="annot"><span class="annottext">ExpValue -&gt; m ExpValue
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684319066"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-401"></span><span>      </span><span id="local-6989586621684319051"><span class="annot"><span class="annottext">freeVarsOnError :: e -&gt; m b
</span><a href="#local-6989586621684319051"><span class="hs-identifier hs-var hs-var">freeVarsOnError</span></a></span></span><span> </span><span id="local-6989586621684319050"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621684319050"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-402"></span><span>        </span><span class="hs-comment">-- We are intentionally ignoring any errors produced by</span><span>
</span><span id="line-403"></span><span>        </span><span class="hs-comment">-- cmdFree, because we already have another error to</span><span>
</span><span id="line-404"></span><span>        </span><span class="hs-comment">-- propagate.  Also, not all of the variables that we put in</span><span>
</span><span id="line-405"></span><span>        </span><span class="hs-comment">-- 'vars' might actually exist server-side, if we failed in a</span><span>
</span><span id="line-406"></span><span>        </span><span class="hs-comment">-- Call.</span><span>
</span><span id="line-407"></span><span>        </span><span class="annot"><span class="annottext">m (Maybe CmdFailure) -&gt; m ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(m (Maybe CmdFailure) -&gt; m ()) -&gt; m (Maybe CmdFailure) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IO (Maybe CmdFailure) -&gt; m (Maybe CmdFailure)
forall (m :: * -&gt; *) a. MonadIO m =&gt; IO a -&gt; m a
</span><span class="hs-identifier hs-var">liftIO</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe CmdFailure) -&gt; m (Maybe CmdFailure))
-&gt; IO (Maybe CmdFailure) -&gt; m (Maybe CmdFailure)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Server -&gt; [EntryName] -&gt; IO (Maybe CmdFailure)
</span><span class="hs-identifier hs-var">cmdFree</span></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319208"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">([EntryName] -&gt; IO (Maybe CmdFailure))
-&gt; IO [EntryName] -&gt; IO (Maybe CmdFailure)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">IORef [EntryName] -&gt; IO [EntryName]
forall a. IORef a -&gt; IO a
</span><span class="hs-identifier hs-var">readIORef</span></span><span> </span><span class="annot"><span class="annottext">IORef [EntryName]
</span><a href="#local-6989586621684319205"><span class="hs-identifier hs-var">vars</span></a></span><span>
</span><span id="line-408"></span><span>        </span><span class="annot"><span class="annottext">e -&gt; m b
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621684319050"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-409"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpValue -&gt; m ExpValue
forall {m :: * -&gt; *}.
(MonadIO m, MonadError EntryName m) =&gt;
ExpValue -&gt; m ExpValue
</span><a href="#local-6989586621684319067"><span class="hs-identifier hs-var">freeNonresultVars</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpValue -&gt; m ExpValue) -&gt; m ExpValue -&gt; m ExpValue
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue -&gt; Exp -&gt; m ExpValue
</span><a href="#local-6989586621684319145"><span class="hs-identifier hs-var">evalExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Map EntryName ExpValue
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684319206"><span class="hs-identifier hs-var">top_level_e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m ExpValue -&gt; (EntryName -&gt; m ExpValue) -&gt; m ExpValue
forall e (m :: * -&gt; *) a.
MonadError e m =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catchError`</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; m ExpValue
forall {m :: * -&gt; *} {e} {b}.
(MonadIO m, MonadError e m) =&gt;
e -&gt; m b
</span><a href="#local-6989586621684319051"><span class="hs-identifier hs-var">freeVarsOnError</span></a></span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span class="hs-comment">-- | Read actual values from the server.  Fails for values that have</span><span>
</span><span id="line-412"></span><span class="hs-comment">-- no well-defined external representation.</span><span>
</span><span id="line-413"></span><span id="local-6989586621684320059"><span class="annot"><a href="Futhark.Script.html#getExpValue"><span class="hs-identifier hs-type">getExpValue</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-414"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="annot"><a href="#local-6989586621684320059"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621684320059"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#ScriptServer"><span class="hs-identifier hs-type">ScriptServer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#ExpValue"><span class="hs-identifier hs-type">ExpValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684320059"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Futhark.Test.Values.html#CompoundValue"><span class="hs-identifier hs-type">V.CompoundValue</span></a></span></span><span>
</span><span id="line-415"></span><span id="getExpValue"><span class="annot"><span class="annottext">getExpValue :: forall (m :: * -&gt; *).
(MonadError EntryName m, MonadIO m) =&gt;
ScriptServer -&gt; ExpValue -&gt; m CompoundValue
</span><a href="Futhark.Script.html#getExpValue"><span class="hs-identifier hs-var hs-var">getExpValue</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#ScriptServer"><span class="hs-identifier hs-type">ScriptServer</span></a></span><span> </span><span id="local-6989586621684319034"><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319034"><span class="hs-identifier hs-var">server</span></a></span></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684319033"><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684319033"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-416"></span><span>  </span><span class="annot"><span class="annottext">(ScriptValue Value -&gt; m Value)
-&gt; Compound (ScriptValue Value) -&gt; m CompoundValue
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue Value -&gt; m Value
forall {m :: * -&gt; *} {a}.
MonadError EntryName m =&gt;
ScriptValue a -&gt; m a
</span><a href="#local-6989586621684319032"><span class="hs-identifier hs-var">toGround</span></a></span><span> </span><span class="annot"><span class="annottext">(Compound (ScriptValue Value) -&gt; m CompoundValue)
-&gt; m (Compound (ScriptValue Value)) -&gt; m CompoundValue
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">(ScriptValue ValOrVar -&gt; m (ScriptValue Value))
-&gt; ExpValue -&gt; m (Compound (ScriptValue Value))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ValOrVar -&gt; m Value)
-&gt; ScriptValue ValOrVar -&gt; m (ScriptValue Value)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">ValOrVar -&gt; m Value
forall {m :: * -&gt; *}.
(MonadError EntryName m, MonadIO m) =&gt;
ValOrVar -&gt; m Value
</span><a href="#local-6989586621684319031"><span class="hs-identifier hs-var">onLeaf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684319033"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-417"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-418"></span><span>    </span><span id="local-6989586621684319031"><span class="annot"><span class="annottext">onLeaf :: ValOrVar -&gt; m Value
</span><a href="#local-6989586621684319031"><span class="hs-identifier hs-var hs-var">onLeaf</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#VVar"><span class="hs-identifier hs-type">VVar</span></a></span><span> </span><span id="local-6989586621684319023"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319023"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Server -&gt; EntryName -&gt; m Value
forall (m :: * -&gt; *).
(MonadError EntryName m, MonadIO m) =&gt;
Server -&gt; EntryName -&gt; m Value
</span><a href="Futhark.Script.html#readVar"><span class="hs-identifier hs-var">readVar</span></a></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684319034"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319023"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-419"></span><span>    </span><span class="annot"><a href="#local-6989586621684319031"><span class="hs-identifier hs-var">onLeaf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#VVal"><span class="hs-identifier hs-type">VVal</span></a></span><span> </span><span id="local-6989586621684319022"><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319022"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Value -&gt; m Value
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Value
</span><a href="#local-6989586621684319022"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-420"></span><span>    </span><span id="local-6989586621684319032"><span class="annot"><span class="annottext">toGround :: ScriptValue a -&gt; m a
</span><a href="#local-6989586621684319032"><span class="hs-identifier hs-var hs-var">toGround</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#SFun"><span class="hs-identifier hs-type">SFun</span></a></span><span> </span><span id="local-6989586621684319012"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319012"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[ScriptValue a]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-421"></span><span>      </span><span class="annot"><span class="annottext">EntryName -&gt; m a
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; m a) -&gt; EntryName -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot;Function &quot;</span></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684319012"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; EntryName -&gt; EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-string">&quot; not fully applied.&quot;</span></span><span>
</span><span id="line-422"></span><span>    </span><span class="annot"><a href="#local-6989586621684319032"><span class="hs-identifier hs-var">toGround</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#SValue"><span class="hs-identifier hs-type">SValue</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684319011"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684319011"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684319011"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-423"></span><span>
</span><span id="line-424"></span><span class="hs-comment">-- | Like 'evalExp', but requires all values to be non-functional.  If</span><span>
</span><span id="line-425"></span><span class="hs-comment">-- the value has a bad type, return that type instead.  Other</span><span>
</span><span id="line-426"></span><span class="hs-comment">-- evaluation problems (e.g. type failures) raise errors.</span><span>
</span><span id="line-427"></span><span id="local-6989586621684320054"><span class="annot"><a href="Futhark.Script.html#evalExpToGround"><span class="hs-identifier hs-type">evalExpToGround</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="annot"><a href="#local-6989586621684320054"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621684320054"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-429"></span><span>  </span><span class="annot"><a href="Futhark.Script.html#EvalBuiltin"><span class="hs-identifier hs-type">EvalBuiltin</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684320054"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-430"></span><span>  </span><span class="annot"><a href="Futhark.Script.html#ScriptServer"><span class="hs-identifier hs-type">ScriptServer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-431"></span><span>  </span><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-432"></span><span>  </span><span class="annot"><a href="#local-6989586621684320054"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Test.Values.html#Compound"><span class="hs-identifier hs-type">V.Compound</span></a></span><span> </span><span class="annot"><a href="Futhark.Script.html#ScriptValueType"><span class="hs-identifier hs-type">ScriptValueType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.Test.Values.html#CompoundValue"><span class="hs-identifier hs-type">V.CompoundValue</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-433"></span><span id="evalExpToGround"><span class="annot"><span class="annottext">evalExpToGround :: forall (m :: * -&gt; *).
(MonadError EntryName m, MonadIO m) =&gt;
EvalBuiltin m
-&gt; ScriptServer
-&gt; Exp
-&gt; m (Either (Compound ScriptValueType) CompoundValue)
</span><a href="Futhark.Script.html#evalExpToGround"><span class="hs-identifier hs-var hs-var">evalExpToGround</span></a></span></span><span> </span><span id="local-6989586621684318996"><span class="annot"><span class="annottext">EvalBuiltin m
</span><a href="#local-6989586621684318996"><span class="hs-identifier hs-var">builtin</span></a></span></span><span> </span><span id="local-6989586621684318995"><span class="annot"><span class="annottext">ScriptServer
</span><a href="#local-6989586621684318995"><span class="hs-identifier hs-var">server</span></a></span></span><span> </span><span id="local-6989586621684318994"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684318994"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-434"></span><span>  </span><span id="local-6989586621684318993"><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684318993"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">EvalBuiltin m -&gt; ScriptServer -&gt; Exp -&gt; m ExpValue
forall (m :: * -&gt; *).
(MonadError EntryName m, MonadIO m) =&gt;
EvalBuiltin m -&gt; ScriptServer -&gt; Exp -&gt; m ExpValue
</span><a href="Futhark.Script.html#evalExp"><span class="hs-identifier hs-var">evalExp</span></a></span><span> </span><span class="annot"><span class="annottext">EvalBuiltin m
</span><a href="#local-6989586621684318996"><span class="hs-identifier hs-var">builtin</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptServer
</span><a href="#local-6989586621684318995"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684318994"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-comment">-- This assumes that the only error that can occur during</span><span>
</span><span id="line-436"></span><span>  </span><span class="hs-comment">-- getExpValue is trying to read an opaque.</span><span>
</span><span id="line-437"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CompoundValue -&gt; Either (Compound ScriptValueType) CompoundValue
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(CompoundValue -&gt; Either (Compound ScriptValueType) CompoundValue)
-&gt; m CompoundValue
-&gt; m (Either (Compound ScriptValueType) CompoundValue)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ScriptServer -&gt; ExpValue -&gt; m CompoundValue
forall (m :: * -&gt; *).
(MonadError EntryName m, MonadIO m) =&gt;
ScriptServer -&gt; ExpValue -&gt; m CompoundValue
</span><a href="Futhark.Script.html#getExpValue"><span class="hs-identifier hs-var">getExpValue</span></a></span><span> </span><span class="annot"><span class="annottext">ScriptServer
</span><a href="#local-6989586621684318995"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684318993"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>    </span><span class="annot"><span class="annottext">m (Either (Compound ScriptValueType) CompoundValue)
-&gt; (EntryName
    -&gt; m (Either (Compound ScriptValueType) CompoundValue))
-&gt; m (Either (Compound ScriptValueType) CompoundValue)
forall e (m :: * -&gt; *) a.
MonadError e m =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catchError`</span></span><span> </span><span class="annot"><span class="annottext">m (Either (Compound ScriptValueType) CompoundValue)
-&gt; EntryName -&gt; m (Either (Compound ScriptValueType) CompoundValue)
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either (Compound ScriptValueType) CompoundValue
-&gt; m (Either (Compound ScriptValueType) CompoundValue)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either (Compound ScriptValueType) CompoundValue
 -&gt; m (Either (Compound ScriptValueType) CompoundValue))
-&gt; Either (Compound ScriptValueType) CompoundValue
-&gt; m (Either (Compound ScriptValueType) CompoundValue)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Compound ScriptValueType
-&gt; Either (Compound ScriptValueType) CompoundValue
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(Compound ScriptValueType
 -&gt; Either (Compound ScriptValueType) CompoundValue)
-&gt; Compound ScriptValueType
-&gt; Either (Compound ScriptValueType) CompoundValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ScriptValue ValOrVar -&gt; ScriptValueType)
-&gt; ExpValue -&gt; Compound ScriptValueType
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">ScriptValue ValOrVar -&gt; ScriptValueType
forall v. ScriptValue v -&gt; ScriptValueType
</span><a href="Futhark.Script.html#scriptValueType"><span class="hs-identifier hs-var">scriptValueType</span></a></span><span> </span><span class="annot"><span class="annottext">ExpValue
</span><a href="#local-6989586621684318993"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span class="hs-comment">-- | The set of Futhark variables that are referenced by the</span><span>
</span><span id="line-441"></span><span class="hs-comment">-- expression - these will have to be entry points in the Futhark</span><span>
</span><span id="line-442"></span><span class="hs-comment">-- program.</span><span>
</span><span id="line-443"></span><span class="annot"><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-type">varsInExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Script.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">EntryName</span></span><span>
</span><span id="line-444"></span><span id="varsInExp"><span class="annot"><span class="annottext">varsInExp :: Exp -&gt; Set EntryName
</span><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-var hs-var">varsInExp</span></a></span></span><span> </span><span class="annot"><a href="Futhark.Script.html#ServerVar"><span class="hs-identifier hs-type">ServerVar</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set EntryName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-445"></span><span class="annot"><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-var">varsInExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Call"><span class="hs-identifier hs-type">Call</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#FuncFut"><span class="hs-identifier hs-type">FuncFut</span></a></span><span> </span><span id="local-6989586621684318991"><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684318991"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684318990"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684318990"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntryName -&gt; Set EntryName -&gt; Set EntryName
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.insert</span></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><a href="#local-6989586621684318991"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Set EntryName -&gt; Set EntryName) -&gt; Set EntryName -&gt; Set EntryName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Set EntryName) -&gt; [Exp] -&gt; Set EntryName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Set EntryName
</span><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-var">varsInExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684318990"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-446"></span><span class="annot"><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-var">varsInExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Call"><span class="hs-identifier hs-type">Call</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#FuncBuiltin"><span class="hs-identifier hs-type">FuncBuiltin</span></a></span><span> </span><span class="annot"><span class="annottext">EntryName
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684318988"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684318988"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Set EntryName) -&gt; [Exp] -&gt; Set EntryName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Set EntryName
</span><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-var">varsInExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684318988"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-447"></span><span class="annot"><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-var">varsInExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Tuple"><span class="hs-identifier hs-type">Tuple</span></a></span><span> </span><span id="local-6989586621684318987"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684318987"><span class="hs-identifier hs-var">es</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Set EntryName) -&gt; [Exp] -&gt; Set EntryName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Set EntryName
</span><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-var">varsInExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684318987"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-448"></span><span class="annot"><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-var">varsInExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684318986"><span class="annot"><span class="annottext">[(EntryName, Exp)]
</span><a href="#local-6989586621684318986"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((EntryName, Exp) -&gt; Set EntryName)
-&gt; [(EntryName, Exp)] -&gt; Set EntryName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Exp -&gt; Set EntryName) -&gt; (EntryName, Exp) -&gt; Set EntryName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Set EntryName
</span><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-var">varsInExp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(EntryName, Exp)]
</span><a href="#local-6989586621684318986"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-449"></span><span class="annot"><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-var">varsInExp</span></a></span><span> </span><span class="annot"><a href="Futhark.Script.html#Const"><span class="hs-identifier hs-type">Const</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set EntryName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-450"></span><span class="annot"><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-var">varsInExp</span></a></span><span> </span><span class="annot"><a href="Futhark.Script.html#StringLit"><span class="hs-identifier hs-type">StringLit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set EntryName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-451"></span><span class="annot"><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-var">varsInExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684318985"><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684318985"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684318984"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684318984"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621684318983"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684318983"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Set EntryName
</span><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-var">varsInExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684318984"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Set EntryName -&gt; Set EntryName -&gt; Set EntryName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(EntryName -&gt; Bool) -&gt; Set EntryName -&gt; Set EntryName
forall a. (a -&gt; Bool) -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntryName -&gt; [EntryName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`notElem`</span></span><span> </span><span class="annot"><span class="annottext">[EntryName]
</span><a href="#local-6989586621684318985"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Set EntryName
</span><a href="Futhark.Script.html#varsInExp"><span class="hs-identifier hs-var">varsInExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684318983"><span class="hs-identifier hs-var">e2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span class="hs-comment">-- | Release all the server-side variables in the value.  Yes,</span><span>
</span><span id="line-454"></span><span class="hs-comment">-- FutharkScript has manual memory management...</span><span>
</span><span id="line-455"></span><span id="local-6989586621684320048"><span class="annot"><a href="Futhark.Script.html#freeValue"><span class="hs-identifier hs-type">freeValue</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">T.Text</span></span><span> </span><span class="annot"><a href="#local-6989586621684320048"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621684320048"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#ScriptServer"><span class="hs-identifier hs-type">ScriptServer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Script.html#ExpValue"><span class="hs-identifier hs-type">ExpValue</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684320048"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-456"></span><span id="freeValue"><span class="annot"><span class="annottext">freeValue :: forall (m :: * -&gt; *).
(MonadError EntryName m, MonadIO m) =&gt;
ScriptServer -&gt; ExpValue -&gt; m ()
</span><a href="Futhark.Script.html#freeValue"><span class="hs-identifier hs-var hs-var">freeValue</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Script.html#ScriptServer"><span class="hs-identifier hs-type">ScriptServer</span></a></span><span> </span><span id="local-6989586621684318977"><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684318977"><span class="hs-identifier hs-var">server</span></a></span></span><span> </span><span class="annot"><span class="annottext">IORef Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-457"></span><span>  </span><span class="annot"><span class="annottext">IO (Maybe CmdFailure) -&gt; m ()
forall (m :: * -&gt; *).
(MonadError EntryName m, MonadIO m) =&gt;
IO (Maybe CmdFailure) -&gt; m ()
</span><span class="hs-identifier hs-var">cmdMaybe</span></span><span> </span><span class="annot"><span class="annottext">(IO (Maybe CmdFailure) -&gt; m ())
-&gt; (ExpValue -&gt; IO (Maybe CmdFailure)) -&gt; ExpValue -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Server -&gt; [EntryName] -&gt; IO (Maybe CmdFailure)
</span><span class="hs-identifier hs-var">cmdFree</span></span><span> </span><span class="annot"><span class="annottext">Server
</span><a href="#local-6989586621684318977"><span class="hs-identifier hs-var">server</span></a></span><span> </span><span class="annot"><span class="annottext">([EntryName] -&gt; IO (Maybe CmdFailure))
-&gt; (ExpValue -&gt; [EntryName]) -&gt; ExpValue -&gt; IO (Maybe CmdFailure)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Set EntryName -&gt; [EntryName]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set EntryName -&gt; [EntryName])
-&gt; (ExpValue -&gt; Set EntryName) -&gt; ExpValue -&gt; [EntryName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ExpValue -&gt; Set EntryName
</span><a href="Futhark.Script.html#serverVarsInValue"><span class="hs-identifier hs-var">serverVarsInValue</span></a></span><span>
</span><span id="line-458"></span></pre></body></html>