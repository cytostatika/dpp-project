<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-comment">-- | This module defines a collection of simplification rules, as per</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- &quot;Futhark.Optimise.Simplify.Rule&quot;.  They are used in the</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- simplifier.</span><span>
</span><span id="line-9"></span><span class="hs-comment">--</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- For performance reasons, many sufficiently simple logically</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- separate rules are merged into single &quot;super-rules&quot;, like ruleIf</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- and ruleBasicOp.  This is because it is relatively expensive to</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- activate a rule just to determine that it does not apply.  Thus, it</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- is more efficient to have a few very fat rules than a lot of small</span><span>
</span><span id="line-15"></span><span class="hs-comment">-- rules.  This does not affect the compiler result in any way; it is</span><span>
</span><span id="line-16"></span><span class="hs-comment">-- purely an optimisation to speed up compilation.</span><span>
</span><span id="line-17"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Optimise.Simplify.Rules</span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#standardRules"><span class="hs-identifier">standardRules</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#removeUnnecessaryCopy"><span class="hs-identifier">removeUnnecessaryCopy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span class="hs-keyword">where</span><span>
</span><span id="line-22"></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Either</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">find</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">insert</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">unzip4</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">zip4</span></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.Convert.html"><span class="hs-identifier">Futhark.Analysis.PrimExp.Convert</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html"><span class="hs-identifier">Futhark.Analysis.SymbolTable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ST</span></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html"><span class="hs-identifier">Futhark.Analysis.UsageTable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UT</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Construct.html"><span class="hs-identifier">Futhark.Construct</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.html"><span class="hs-identifier">Futhark.IR</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html"><span class="hs-identifier">Futhark.IR.Prop.Aliases</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rule</span></a></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rules.BasicOp</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.Index.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rules.Index</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.Loop.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rules.Loop</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span>
</span><span id="line-40"></span><span>
</span><span id="line-41"></span><span id="local-6989586621684368393"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#topDownRules"><span class="hs-identifier hs-type">topDownRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368393"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#TopDownRule"><span class="hs-identifier hs-type">TopDownRule</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368393"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-42"></span><span id="topDownRules"><span class="annot"><span class="annottext">topDownRules :: forall rep. BuilderOps rep =&gt; [TopDownRule rep]
</span><a href="Futhark.Optimise.Simplify.Rules.html#topDownRules"><span class="hs-identifier hs-var hs-var">topDownRules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">RuleGeneric rep (TopDown rep) -&gt; TopDownRule rep
forall rep a. RuleGeneric rep a -&gt; SimplificationRule rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#RuleGeneric"><span class="hs-identifier hs-var">RuleGeneric</span></a></span><span> </span><span class="annot"><span class="annottext">RuleGeneric rep (TopDown rep)
forall rep. BuilderOps rep =&gt; TopDownRuleGeneric rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#constantFoldPrimFun"><span class="hs-identifier hs-var">constantFoldPrimFun</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><span class="annottext">RuleIf rep (TopDown rep) -&gt; TopDownRule rep
forall rep a. RuleIf rep a -&gt; SimplificationRule rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#RuleIf"><span class="hs-identifier hs-var">RuleIf</span></a></span><span> </span><span class="annot"><span class="annottext">RuleIf rep (TopDown rep)
forall rep. BuilderOps rep =&gt; TopDownRuleIf rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#ruleIf"><span class="hs-identifier hs-var">ruleIf</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><span class="annottext">RuleIf rep (TopDown rep) -&gt; TopDownRule rep
forall rep a. RuleIf rep a -&gt; SimplificationRule rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#RuleIf"><span class="hs-identifier hs-var">RuleIf</span></a></span><span> </span><span class="annot"><span class="annottext">RuleIf rep (TopDown rep)
forall rep. BuilderOps rep =&gt; TopDownRuleIf rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#hoistBranchInvariant"><span class="hs-identifier hs-var">hoistBranchInvariant</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><span class="annottext">RuleGeneric rep (TopDown rep) -&gt; TopDownRule rep
forall rep a. RuleGeneric rep a -&gt; SimplificationRule rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#RuleGeneric"><span class="hs-identifier hs-var">RuleGeneric</span></a></span><span> </span><span class="annot"><span class="annottext">RuleGeneric rep (TopDown rep)
forall rep. BuilderOps rep =&gt; TopDownRuleGeneric rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#withAccTopDown"><span class="hs-identifier hs-var">withAccTopDown</span></a></span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span id="local-6989586621684368379"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#bottomUpRules"><span class="hs-identifier hs-type">bottomUpRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368379"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Traversals.html#TraverseOpStms"><span class="hs-identifier hs-type">TraverseOpStms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368379"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#BottomUpRule"><span class="hs-identifier hs-type">BottomUpRule</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368379"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-50"></span><span id="bottomUpRules"><span class="annot"><span class="annottext">bottomUpRules :: forall rep.
(BuilderOps rep, TraverseOpStms rep) =&gt;
[BottomUpRule rep]
</span><a href="Futhark.Optimise.Simplify.Rules.html#bottomUpRules"><span class="hs-identifier hs-var hs-var">bottomUpRules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">RuleIf rep (BottomUp rep) -&gt; BottomUpRule rep
forall rep a. RuleIf rep a -&gt; SimplificationRule rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#RuleIf"><span class="hs-identifier hs-var">RuleIf</span></a></span><span> </span><span class="annot"><span class="annottext">RuleIf rep (BottomUp rep)
forall rep. BuilderOps rep =&gt; BottomUpRuleIf rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#removeDeadBranchResult"><span class="hs-identifier hs-var">removeDeadBranchResult</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-52"></span><span>    </span><span class="annot"><span class="annottext">RuleGeneric rep (BottomUp rep) -&gt; BottomUpRule rep
forall rep a. RuleGeneric rep a -&gt; SimplificationRule rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#RuleGeneric"><span class="hs-identifier hs-var">RuleGeneric</span></a></span><span> </span><span class="annot"><span class="annottext">RuleGeneric rep (BottomUp rep)
forall rep.
(TraverseOpStms rep, BuilderOps rep) =&gt;
BottomUpRuleGeneric rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#withAccBottomUp"><span class="hs-identifier hs-var">withAccBottomUp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>    </span><span class="annot"><span class="annottext">RuleBasicOp rep (BottomUp rep) -&gt; BottomUpRule rep
forall rep a. RuleBasicOp rep a -&gt; SimplificationRule rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#RuleBasicOp"><span class="hs-identifier hs-var">RuleBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBasicOp rep (BottomUp rep)
forall rep. BuilderOps rep =&gt; BottomUpRuleBasicOp rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#simplifyIndex"><span class="hs-identifier hs-var">simplifyIndex</span></a></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-comment">-- | A set of standard simplification rules.  These assume pure</span><span>
</span><span id="line-57"></span><span class="hs-comment">-- functional semantics, and so probably should not be applied after</span><span>
</span><span id="line-58"></span><span class="hs-comment">-- memory block merging.</span><span>
</span><span id="line-59"></span><span id="local-6989586621684368367"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#standardRules"><span class="hs-identifier hs-type">standardRules</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368367"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Traversals.html#TraverseOpStms"><span class="hs-identifier hs-type">TraverseOpStms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368367"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368367"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#RuleBook"><span class="hs-identifier hs-type">RuleBook</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368367"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-60"></span><span id="standardRules"><span class="annot"><span class="annottext">standardRules :: forall rep.
(BuilderOps rep, TraverseOpStms rep, Aliased rep) =&gt;
RuleBook rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#standardRules"><span class="hs-identifier hs-var hs-var">standardRules</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TopDownRule rep] -&gt; [BottomUpRule rep] -&gt; RuleBook rep
forall m. [TopDownRule m] -&gt; [BottomUpRule m] -&gt; RuleBook m
</span><a href="Futhark.Optimise.Simplify.Rule.html#ruleBook"><span class="hs-identifier hs-var">ruleBook</span></a></span><span> </span><span class="annot"><span class="annottext">[TopDownRule rep]
forall rep. BuilderOps rep =&gt; [TopDownRule rep]
</span><a href="Futhark.Optimise.Simplify.Rules.html#topDownRules"><span class="hs-identifier hs-var">topDownRules</span></a></span><span> </span><span class="annot"><span class="annottext">[BottomUpRule rep]
forall rep.
(BuilderOps rep, TraverseOpStms rep) =&gt;
[BottomUpRule rep]
</span><a href="Futhark.Optimise.Simplify.Rules.html#bottomUpRules"><span class="hs-identifier hs-var">bottomUpRules</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBook rep -&gt; RuleBook rep -&gt; RuleBook rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RuleBook rep
forall rep. (BuilderOps rep, Aliased rep) =&gt; RuleBook rep
</span><a href="Futhark.Optimise.Simplify.Rules.Loop.html#loopRules"><span class="hs-identifier hs-var">loopRules</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBook rep -&gt; RuleBook rep -&gt; RuleBook rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RuleBook rep
forall rep. (BuilderOps rep, Aliased rep) =&gt; RuleBook rep
</span><a href="Futhark.Optimise.Simplify.Rules.BasicOp.html#basicOpRules"><span class="hs-identifier hs-var">basicOpRules</span></a></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-comment">-- | Turn @copy(x)@ into @x@ iff @x@ is not used after this copy</span><span>
</span><span id="line-63"></span><span class="hs-comment">-- statement and it can be consumed.</span><span>
</span><span id="line-64"></span><span class="hs-comment">--</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- This simplistic rule is only valid before we introduce memory.</span><span>
</span><span id="line-66"></span><span id="local-6989586621684368359"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#removeUnnecessaryCopy"><span class="hs-identifier hs-type">removeUnnecessaryCopy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368359"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368359"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#BottomUpRuleBasicOp"><span class="hs-identifier hs-type">BottomUpRuleBasicOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368359"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-67"></span><span id="removeUnnecessaryCopy"><span class="annot"><span class="annottext">removeUnnecessaryCopy :: forall rep.
(BuilderOps rep, Aliased rep) =&gt;
BottomUpRuleBasicOp rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#removeUnnecessaryCopy"><span class="hs-identifier hs-var hs-var">removeUnnecessaryCopy</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367950"><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684367950"><span class="hs-identifier hs-var">vtable</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367949"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684367949"><span class="hs-identifier hs-var">used</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684367947"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367947"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-type">Copy</span></a></span><span> </span><span id="local-6989586621684367945"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367945"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367945"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#isConsumed"><span class="hs-operator hs-var">`UT.isConsumed`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684367949"><span class="hs-identifier hs-var">used</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>    </span><span class="hs-comment">-- This next line is too conservative, but the problem is that 'v'</span><span>
</span><span id="line-70"></span><span>    </span><span class="hs-comment">-- might not look like it has been consumed if it is consumed in</span><span>
</span><span id="line-71"></span><span>    </span><span class="hs-comment">-- an outer scope.  This is because the simplifier applies</span><span>
</span><span id="line-72"></span><span>    </span><span class="hs-comment">-- bottom-up rules in a kind of deepest-first order.</span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367947"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#isInResult"><span class="hs-operator hs-var">`UT.isInResult`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684367949"><span class="hs-identifier hs-var">used</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367947"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#isConsumed"><span class="hs-operator hs-var">`UT.isConsumed`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684367949"><span class="hs-identifier hs-var">used</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367945"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#used"><span class="hs-operator hs-var">`UT.used`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684367949"><span class="hs-identifier hs-var">used</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684367937"><span class="hs-identifier hs-var">consumable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367947"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#isConsumed"><span class="hs-operator hs-var">`UT.isConsumed`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684367949"><span class="hs-identifier hs-var">used</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-75"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367947"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367945"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-77"></span><span>    </span><span class="hs-comment">-- We need to make sure we can even consume the original.  The big</span><span>
</span><span id="line-78"></span><span>    </span><span class="hs-comment">-- missing piece here is that we cannot do copy removal inside of</span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-comment">-- 'map' and other SOACs, but that is handled by SOAC-specific rules.</span><span>
</span><span id="line-80"></span><span>    </span><span id="local-6989586621684367937"><span class="annot"><span class="annottext">consumable :: Bool
</span><a href="#local-6989586621684367937"><span class="hs-identifier hs-var hs-var">consumable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool -&gt; Bool
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Bool -&gt; Bool) -&gt; Maybe Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-81"></span><span>      </span><span id="local-6989586621684367930"><span class="annot"><span class="annottext">Entry rep
</span><a href="#local-6989586621684367930"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SymbolTable rep -&gt; Maybe (Entry rep)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (Entry rep)
</span><a href="Futhark.Analysis.SymbolTable.html#lookup"><span class="hs-identifier hs-var">ST.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367945"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684367950"><span class="hs-identifier hs-var">vtable</span></a></span><span>
</span><span id="line-82"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Entry rep -&gt; Int
forall rep. Entry rep -&gt; Int
</span><a href="Futhark.Analysis.SymbolTable.html#entryDepth"><span class="hs-identifier hs-var hs-var">ST.entryDepth</span></a></span><span> </span><span class="annot"><span class="annottext">Entry rep
</span><a href="#local-6989586621684367930"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep -&gt; Int
forall rep. SymbolTable rep -&gt; Int
</span><a href="Futhark.Analysis.SymbolTable.html#loopDepth"><span class="hs-identifier hs-var hs-var">ST.loopDepth</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684367950"><span class="hs-identifier hs-var">vtable</span></a></span><span>
</span><span id="line-83"></span><span>      </span><span class="annot"><span class="annottext">Entry rep -&gt; Maybe Bool
</span><a href="#local-6989586621684367926"><span class="hs-identifier hs-var">consumableStm</span></a></span><span> </span><span class="annot"><span class="annottext">Entry rep
</span><a href="#local-6989586621684367930"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Bool -&gt; Maybe Bool -&gt; Maybe Bool
forall (m :: * -&gt; *) a. MonadPlus m =&gt; m a -&gt; m a -&gt; m a
</span><span class="hs-operator hs-var">`mplus`</span></span><span> </span><span class="annot"><span class="annottext">Entry rep -&gt; Maybe Bool
</span><a href="#local-6989586621684367924"><span class="hs-identifier hs-var">consumableFParam</span></a></span><span> </span><span class="annot"><span class="annottext">Entry rep
</span><a href="#local-6989586621684367930"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-84"></span><span>    </span><span id="local-6989586621684367924"><span class="annot"><span class="annottext">consumableFParam :: Entry rep -&gt; Maybe Bool
</span><a href="#local-6989586621684367924"><span class="hs-identifier hs-var hs-var">consumableFParam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-85"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe Bool)
-&gt; (Entry rep -&gt; Bool) -&gt; Entry rep -&gt; Maybe Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; (FParamInfo rep -&gt; Bool) -&gt; Maybe (FParamInfo rep) -&gt; Bool
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape Uniqueness -&gt; Bool
forall shape. TypeBase shape Uniqueness -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#unique"><span class="hs-identifier hs-var">unique</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape Uniqueness -&gt; Bool)
-&gt; (FParamInfo rep -&gt; TypeBase Shape Uniqueness)
-&gt; FParamInfo rep
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">FParamInfo rep -&gt; TypeBase Shape Uniqueness
forall t. DeclTyped t =&gt; t -&gt; TypeBase Shape Uniqueness
</span><a href="Futhark.IR.Prop.Types.html#declTypeOf"><span class="hs-identifier hs-var">declTypeOf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (FParamInfo rep) -&gt; Bool)
-&gt; (Entry rep -&gt; Maybe (FParamInfo rep)) -&gt; Entry rep -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Entry rep -&gt; Maybe (FParamInfo rep)
forall rep. Entry rep -&gt; Maybe (FParamInfo rep)
</span><a href="Futhark.Analysis.SymbolTable.html#entryFParam"><span class="hs-identifier hs-var">ST.entryFParam</span></a></span><span>
</span><span id="line-86"></span><span>    </span><span id="local-6989586621684367926"><span class="annot"><span class="annottext">consumableStm :: Entry rep -&gt; Maybe Bool
</span><a href="#local-6989586621684367926"><span class="hs-identifier hs-var hs-var">consumableStm</span></a></span></span><span> </span><span id="local-6989586621684367916"><span class="annot"><span class="annottext">Entry rep
</span><a href="#local-6989586621684367916"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-87"></span><span>      </span><span id="local-6989586621684367915"><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><a href="#local-6989586621684367915"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; PatT (LetDec rep)
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; PatT (LetDec rep))
-&gt; Maybe (Stm rep) -&gt; Maybe (PatT (LetDec rep))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Entry rep -&gt; Maybe (Stm rep)
forall rep. Entry rep -&gt; Maybe (Stm rep)
</span><a href="Futhark.Analysis.SymbolTable.html#entryStm"><span class="hs-identifier hs-var">ST.entryStm</span></a></span><span> </span><span class="annot"><span class="annottext">Entry rep
</span><a href="#local-6989586621684367916"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-88"></span><span>      </span><span id="local-6989586621684367911"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367911"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PatElemT (LetDec rep) -&gt; Bool)
-&gt; [PatElemT (LetDec rep)] -&gt; Maybe (PatElemT (LetDec rep))
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367945"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; (PatElemT (LetDec rep) -&gt; VName)
-&gt; PatElemT (LetDec rep)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT (LetDec rep) -&gt; [PatElemT (LetDec rep)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><a href="#local-6989586621684367915"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; Names
forall a. AliasesOf a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Aliases.html#aliasesOf"><span class="hs-identifier hs-var">aliasesOf</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367911"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-90"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Maybe Bool
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-91"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#removeUnnecessaryCopy"><span class="hs-identifier hs-var">removeUnnecessaryCopy</span></a></span><span> </span><span class="annot"><span class="annottext">(SymbolTable rep, UsageTable)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rule rep
forall rep. Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span id="local-6989586621684368384"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#constantFoldPrimFun"><span class="hs-identifier hs-type">constantFoldPrimFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368384"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#TopDownRuleGeneric"><span class="hs-identifier hs-type">TopDownRuleGeneric</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368384"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-94"></span><span id="constantFoldPrimFun"><span class="annot"><span class="annottext">constantFoldPrimFun :: forall rep. BuilderOps rep =&gt; TopDownRuleGeneric rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#constantFoldPrimFun"><span class="hs-identifier hs-var hs-var">constantFoldPrimFun</span></a></span></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684367893"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367893"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684367891"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367891"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684367890"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684367890"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExpDec rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621684367888"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684367888"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span id="local-6989586621684367887"><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684367887"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="annot"><span class="annottext">[RetType rep]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">(Safety, SrcLoc, [SrcLoc])
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684367886"><span class="annot"><span class="annottext">[PrimValue]
</span><a href="#local-6989586621684367886"><span class="hs-identifier hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((SubExp, Diet) -&gt; Maybe PrimValue)
-&gt; [(SubExp, Diet)] -&gt; Maybe [PrimValue]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Maybe PrimValue
</span><a href="#local-6989586621684367884"><span class="hs-identifier hs-var">isConst</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Maybe PrimValue)
-&gt; ((SubExp, Diet) -&gt; SubExp) -&gt; (SubExp, Diet) -&gt; Maybe PrimValue
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SubExp, Diet) -&gt; SubExp
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684367887"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-96"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PrimType]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367883"><span class="annot"><span class="annottext">[PrimValue] -&gt; Maybe PrimValue
</span><a href="#local-6989586621684367883"><span class="hs-identifier hs-var">fun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Map
     String ([PrimType], PrimType, [PrimValue] -&gt; Maybe PrimValue)
-&gt; Maybe ([PrimType], PrimType, [PrimValue] -&gt; Maybe PrimValue)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; String
</span><a href="Language.Futhark.Core.html#nameToString"><span class="hs-identifier hs-var">nameToString</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684367888"><span class="hs-identifier hs-var">fname</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map String ([PrimType], PrimType, [PrimValue] -&gt; Maybe PrimValue)
</span><a href="Futhark.IR.Primitive.html#primFuns"><span class="hs-identifier hs-var">primFuns</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684367879"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684367879"><span class="hs-identifier hs-var">result</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[PrimValue] -&gt; Maybe PrimValue
</span><a href="#local-6989586621684367883"><span class="hs-identifier hs-var">fun</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimValue]
</span><a href="#local-6989586621684367886"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-99"></span><span>      </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367891"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><span class="annottext">Attrs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Attrs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#attributing"><span class="hs-identifier hs-var">attributing</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684367890"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-101"></span><span>          </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684367893"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-var">Constant</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684367879"><span class="hs-identifier hs-var">result</span></a></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-103"></span><span>    </span><span id="local-6989586621684367884"><span class="annot"><span class="annottext">isConst :: SubExp -&gt; Maybe PrimValue
</span><a href="#local-6989586621684367884"><span class="hs-identifier hs-var hs-var">isConst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684367874"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684367874"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; Maybe PrimValue
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684367874"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><a href="#local-6989586621684367884"><span class="hs-identifier hs-var">isConst</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe PrimValue
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-105"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#constantFoldPrimFun"><span class="hs-identifier hs-var">constantFoldPrimFun</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rule rep
forall rep. Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span id="local-6989586621684368369"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#simplifyIndex"><span class="hs-identifier hs-type">simplifyIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368369"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#BottomUpRuleBasicOp"><span class="hs-identifier hs-type">BottomUpRuleBasicOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368369"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-108"></span><span id="simplifyIndex"><span class="annot"><span class="annottext">simplifyIndex :: forall rep. BuilderOps rep =&gt; BottomUpRuleBasicOp rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#simplifyIndex"><span class="hs-identifier hs-var hs-var">simplifyIndex</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367858"><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684367858"><span class="hs-identifier hs-var">vtable</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367857"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684367857"><span class="hs-identifier hs-var">used</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684367856"><span class="annot"><span class="annottext">pat :: Pat rep
</span><a href="#local-6989586621684367856"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684367855"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367855"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684367854"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367854"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684367853"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684367853"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExpDec rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span id="local-6989586621684367851"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367851"><span class="hs-identifier hs-var">idd</span></a></span></span><span> </span><span id="local-6989586621684367850"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684367850"><span class="hs-identifier hs-var">inds</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684367849"><span class="annot"><span class="annottext">RuleM rep IndexResult
</span><a href="#local-6989586621684367849"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SymbolTable (Rep (RuleM rep))
-&gt; TypeLookup
-&gt; VName
-&gt; Slice SubExp
-&gt; Bool
-&gt; Maybe (RuleM rep IndexResult)
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
SymbolTable (Rep m)
-&gt; TypeLookup
-&gt; VName
-&gt; Slice SubExp
-&gt; Bool
-&gt; Maybe (m IndexResult)
</span><a href="Futhark.Optimise.Simplify.Rules.Index.html#simplifyIndexing"><span class="hs-identifier hs-var">simplifyIndexing</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
SymbolTable (Rep (RuleM rep))
</span><a href="#local-6989586621684367858"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="annot"><span class="annottext">TypeLookup
</span><a href="#local-6989586621684367847"><span class="hs-identifier hs-var">seType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367851"><span class="hs-identifier hs-var">idd</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684367850"><span class="hs-identifier hs-var">inds</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684367846"><span class="hs-identifier hs-var">consumed</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-110"></span><span>    </span><span id="local-6989586621684367845"><span class="annot"><span class="annottext">IndexResult
</span><a href="#local-6989586621684367845"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleM rep IndexResult
</span><a href="#local-6989586621684367849"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-111"></span><span>    </span><span class="annot"><span class="annottext">Attrs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Attrs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#attributing"><span class="hs-identifier hs-var">attributing</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684367853"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IndexResult
</span><a href="#local-6989586621684367845"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-112"></span><span>      </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.Index.html#SubExpResult"><span class="hs-identifier hs-type">SubExpResult</span></a></span><span> </span><span id="local-6989586621684367843"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367843"><span class="hs-identifier hs-var">cs'</span></a></span></span><span> </span><span id="local-6989586621684367842"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367842"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-113"></span><span>        </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367854"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367843"><span class="hs-identifier hs-var">cs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-114"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367856"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367842"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-115"></span><span>      </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.Index.html#IndexResult"><span class="hs-identifier hs-type">IndexResult</span></a></span><span> </span><span id="local-6989586621684367839"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367839"><span class="hs-identifier hs-var">extra_cs</span></a></span></span><span> </span><span id="local-6989586621684367838"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367838"><span class="hs-identifier hs-var">idd'</span></a></span></span><span> </span><span id="local-6989586621684367837"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684367837"><span class="hs-identifier hs-var">inds'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-116"></span><span>        </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367854"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367839"><span class="hs-identifier hs-var">extra_cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-117"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367856"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367838"><span class="hs-identifier hs-var">idd'</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684367837"><span class="hs-identifier hs-var">inds'</span></a></span><span>
</span><span id="line-118"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-119"></span><span>    </span><span id="local-6989586621684367846"><span class="annot"><span class="annottext">consumed :: Bool
</span><a href="#local-6989586621684367846"><span class="hs-identifier hs-var hs-var">consumed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367855"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#isConsumed"><span class="hs-operator hs-var">`UT.isConsumed`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684367857"><span class="hs-identifier hs-var">used</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span id="local-6989586621684367847"><span class="annot"><span class="annottext">seType :: TypeLookup
</span><a href="#local-6989586621684367847"><span class="hs-identifier hs-var hs-var">seType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684367836"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367836"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SymbolTable rep -&gt; Maybe Type
forall rep. ASTRep rep =&gt; VName -&gt; SymbolTable rep -&gt; Maybe Type
</span><a href="Futhark.Analysis.SymbolTable.html#lookupType"><span class="hs-identifier hs-var">ST.lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367836"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684367858"><span class="hs-identifier hs-var">vtable</span></a></span><span>
</span><span id="line-121"></span><span>    </span><span class="annot"><a href="#local-6989586621684367847"><span class="hs-identifier hs-var">seType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684367834"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684367834"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Maybe Type
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Maybe Type) -&gt; Type -&gt; Maybe Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; Type) -&gt; PrimType -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#primValueType"><span class="hs-identifier hs-var">primValueType</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684367834"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-122"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#simplifyIndex"><span class="hs-identifier hs-var">simplifyIndex</span></a></span><span> </span><span class="annot"><span class="annottext">(SymbolTable rep, UsageTable)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rule rep
forall rep. Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span id="local-6989586621684368381"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#ruleIf"><span class="hs-identifier hs-type">ruleIf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368381"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#TopDownRuleIf"><span class="hs-identifier hs-type">TopDownRuleIf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368381"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-125"></span><span id="ruleIf"><span class="annot"><span class="annottext">ruleIf :: forall rep. BuilderOps rep =&gt; TopDownRuleIf rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#ruleIf"><span class="hs-identifier hs-var hs-var">ruleIf</span></a></span></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684367754"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367754"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367753"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367753"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367752"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367752"><span class="hs-identifier hs-var">tb</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367751"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367751"><span class="hs-identifier hs-var">fb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-type">IfDec</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType rep]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684367749"><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684367749"><span class="hs-identifier hs-var">ifsort</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684367748"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367748"><span class="hs-identifier hs-var">branch</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (BodyT rep)
</span><a href="#local-6989586621684367747"><span class="hs-identifier hs-var">checkBranch</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684367749"><span class="hs-identifier hs-var">ifsort</span></a></span><span> </span><span class="annot"><span class="annottext">IfSort -&gt; IfSort -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="Futhark.IR.Syntax.html#IfFallback"><span class="hs-identifier hs-var">IfFallback</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Rules.html#isCt1"><span class="hs-identifier hs-var">isCt1</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367753"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684367743"><span class="annot"><span class="annottext">ses :: Result
</span><a href="#local-6989586621684367743"><span class="hs-identifier hs-var hs-var">ses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367748"><span class="hs-identifier hs-var">branch</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="annot"><span class="annottext">Stms (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Stms (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Stms rep
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367748"><span class="hs-identifier hs-var">branch</span></a></span><span>
</span><span id="line-130"></span><span>    </span><span class="annot"><span class="annottext">[RuleM rep ()] -&gt; RuleM rep ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><span class="hs-identifier hs-var">sequence_</span></span><span>
</span><span id="line-131"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367738"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367737"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367736"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-132"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367737"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367737"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684367738"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367738"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684367736"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367736"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
-&gt; Result -&gt; [(PatElemT (LetDec rep), SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [PatElemT (LetDec rep)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367754"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367743"><span class="hs-identifier hs-var">ses</span></a></span><span>
</span><span id="line-133"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-135"></span><span>    </span><span id="local-6989586621684367747"><span class="annot"><span class="annottext">checkBranch :: Maybe (BodyT rep)
</span><a href="#local-6989586621684367747"><span class="hs-identifier hs-var hs-var">checkBranch</span></a></span></span><span>
</span><span id="line-136"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Rules.html#isCt1"><span class="hs-identifier hs-var">isCt1</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367753"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Maybe (BodyT rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367752"><span class="hs-identifier hs-var">tb</span></a></span><span>
</span><span id="line-137"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Rules.html#isCt0"><span class="hs-identifier hs-var">isCt0</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367753"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Maybe (BodyT rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367751"><span class="hs-identifier hs-var">fb</span></a></span><span>
</span><span id="line-138"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (BodyT rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="hs-comment">-- IMPROVE: the following two rules can be generalised to work in more</span><span>
</span><span id="line-141"></span><span class="hs-comment">-- cases, especially when the branches have bindings, or return more</span><span>
</span><span id="line-142"></span><span class="hs-comment">-- than one value.</span><span>
</span><span id="line-143"></span><span class="hs-comment">--</span><span>
</span><span id="line-144"></span><span class="hs-comment">-- if c then True else v == c || v</span><span>
</span><span id="line-145"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#ruleIf"><span class="hs-identifier hs-var">ruleIf</span></a></span><span>
</span><span id="line-146"></span><span>  </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-147"></span><span>  </span><span id="local-6989586621684367733"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367733"><span class="hs-identifier hs-var">pat</span></a></span></span><span>
</span><span id="line-148"></span><span>  </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-special">(</span><span> </span><span id="local-6989586621684367732"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367732"><span class="hs-identifier hs-var">cond</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684367730"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684367730"><span class="hs-identifier hs-var">tstms</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684367729"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367729"><span class="hs-identifier hs-var">tcs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#BoolValue"><span class="hs-identifier hs-type">BoolValue</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684367727"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684367727"><span class="hs-identifier hs-var">fstms</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684367726"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367726"><span class="hs-identifier hs-var">fcs</span></a></span></span><span> </span><span id="local-6989586621684367725"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367725"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-type">IfDec</span></a></span><span> </span><span id="local-6989586621684367724"><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367724"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684367730"><span class="hs-identifier hs-var">tstms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-155"></span><span>      </span><span class="annot"><span class="annottext">Stms rep -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684367727"><span class="hs-identifier hs-var">fstms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-156"></span><span>      </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Primitive.html#Bool"><span class="hs-identifier hs-var">Bool</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(BranchType rep -&gt; TypeBase ExtShape NoUniqueness)
-&gt; [BranchType rep] -&gt; [TypeBase ExtShape NoUniqueness]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">BranchType rep -&gt; TypeBase ExtShape NoUniqueness
forall t. ExtTyped t =&gt; t -&gt; TypeBase ExtShape NoUniqueness
</span><a href="Futhark.IR.Prop.Types.html#extTypeOf"><span class="hs-identifier hs-var">extTypeOf</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367724"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-157"></span><span>      </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367729"><span class="hs-identifier hs-var">tcs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367726"><span class="hs-identifier hs-var">fcs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684367733"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="Futhark.IR.Primitive.html#LogOr"><span class="hs-identifier hs-var">LogOr</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367732"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367725"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-158"></span><span class="hs-comment">-- When type(x)==bool, if c then x else y == (c &amp;&amp; x) || (!c &amp;&amp; y)</span><span>
</span><span id="line-159"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#ruleIf"><span class="hs-identifier hs-var">ruleIf</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684367718"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367718"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367717"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367717"><span class="hs-identifier hs-var">cond</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367716"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367716"><span class="hs-identifier hs-var">tb</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367715"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367715"><span class="hs-identifier hs-var">fb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-type">IfDec</span></a></span><span> </span><span id="local-6989586621684367714"><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367714"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-160"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684367713"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684367713"><span class="hs-identifier hs-var">tstms</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684367712"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367712"><span class="hs-identifier hs-var">tcs</span></a></span></span><span> </span><span id="local-6989586621684367711"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367711"><span class="hs-identifier hs-var">tres</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367716"><span class="hs-identifier hs-var">tb</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-161"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684367710"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684367710"><span class="hs-identifier hs-var">fstms</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684367709"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367709"><span class="hs-identifier hs-var">fcs</span></a></span></span><span> </span><span id="local-6989586621684367708"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367708"><span class="hs-identifier hs-var">fres</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367715"><span class="hs-identifier hs-var">fb</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><span class="annottext">(Stm rep -&gt; Bool) -&gt; Stms rep -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpT rep -&gt; Bool
forall rep. IsOp (Op rep) =&gt; Exp rep -&gt; Bool
</span><a href="Futhark.IR.Prop.html#safeExp"><span class="hs-identifier hs-var">safeExp</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Bool) -&gt; (Stm rep -&gt; ExpT rep) -&gt; Stm rep -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stms rep -&gt; Bool) -&gt; Stms rep -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684367713"><span class="hs-identifier hs-var">tstms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Stms rep -&gt; Stms rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684367710"><span class="hs-identifier hs-var">fstms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-163"></span><span>    </span><span class="annot"><span class="annottext">(BranchType rep -&gt; Bool) -&gt; [BranchType rep] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase ExtShape NoUniqueness
-&gt; TypeBase ExtShape NoUniqueness -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TypeBase ExtShape NoUniqueness
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Primitive.html#Bool"><span class="hs-identifier hs-var">Bool</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TypeBase ExtShape NoUniqueness -&gt; Bool)
-&gt; (BranchType rep -&gt; TypeBase ExtShape NoUniqueness)
-&gt; BranchType rep
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BranchType rep -&gt; TypeBase ExtShape NoUniqueness
forall t. ExtTyped t =&gt; t -&gt; TypeBase ExtShape NoUniqueness
</span><a href="Futhark.IR.Prop.Types.html#extTypeOf"><span class="hs-identifier hs-var">extTypeOf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367714"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>    </span><span class="annot"><span class="annottext">Stms (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
Stms (Rep (RuleM rep))
</span><a href="#local-6989586621684367713"><span class="hs-identifier hs-var">tstms</span></a></span><span>
</span><span id="line-165"></span><span>    </span><span class="annot"><span class="annottext">Stms (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
Stms (Rep (RuleM rep))
</span><a href="#local-6989586621684367710"><span class="hs-identifier hs-var">fstms</span></a></span><span>
</span><span id="line-166"></span><span>    </span><span id="local-6989586621684367704"><span class="annot"><span class="annottext">ExpT rep
</span><a href="#local-6989586621684367704"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-167"></span><span>      </span><span class="annot"><span class="annottext">BinOp
-&gt; RuleM rep (Exp (Rep (RuleM rep)))
-&gt; RuleM rep (Exp (Rep (RuleM rep)))
-&gt; RuleM rep (Exp (Rep (RuleM rep)))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
BinOp -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eBinOp"><span class="hs-identifier hs-var">eBinOp</span></a></span><span>
</span><span id="line-168"></span><span>        </span><span class="annot"><span class="annottext">BinOp
</span><a href="Futhark.IR.Primitive.html#LogOr"><span class="hs-identifier hs-var">LogOr</span></a></span><span>
</span><span id="line-169"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpT rep -&gt; RuleM rep (ExpT rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; RuleM rep (ExpT rep))
-&gt; ExpT rep -&gt; RuleM rep (ExpT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="Futhark.IR.Primitive.html#LogAnd"><span class="hs-identifier hs-var">LogAnd</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367717"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367711"><span class="hs-identifier hs-var">tres</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">BinOp
-&gt; RuleM rep (Exp (Rep (RuleM rep)))
-&gt; RuleM rep (Exp (Rep (RuleM rep)))
-&gt; RuleM rep (Exp (Rep (RuleM rep)))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
BinOp -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m)) -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#eBinOp"><span class="hs-identifier hs-var">eBinOp</span></a></span><span>
</span><span id="line-171"></span><span>            </span><span class="annot"><span class="annottext">BinOp
</span><a href="Futhark.IR.Primitive.html#LogAnd"><span class="hs-identifier hs-var">LogAnd</span></a></span><span>
</span><span id="line-172"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpT rep -&gt; RuleM rep (ExpT rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; RuleM rep (ExpT rep))
-&gt; ExpT rep -&gt; RuleM rep (ExpT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UnOp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#UnOp"><span class="hs-identifier hs-var">UnOp</span></a></span><span> </span><span class="annot"><span class="annottext">UnOp
</span><a href="Futhark.IR.Primitive.html#Not"><span class="hs-identifier hs-var">Not</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367717"><span class="hs-identifier hs-var">cond</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpT rep -&gt; RuleM rep (ExpT rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; RuleM rep (ExpT rep))
-&gt; ExpT rep -&gt; RuleM rep (ExpT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367708"><span class="hs-identifier hs-var">fres</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367712"><span class="hs-identifier hs-var">tcs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367709"><span class="hs-identifier hs-var">fcs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684367718"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT rep
Exp (Rep (RuleM rep))
</span><a href="#local-6989586621684367704"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-176"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#ruleIf"><span class="hs-identifier hs-var">ruleIf</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684367699"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367699"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367698"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367698"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-type">IfDec</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType rep]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="Futhark.IR.Syntax.html#IfFallback"><span class="hs-identifier hs-var">IfFallback</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; Bool) -&gt; Stms rep -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpT rep -&gt; Bool
forall rep. IsOp (Op rep) =&gt; Exp rep -&gt; Bool
</span><a href="Futhark.IR.Prop.html#safeExp"><span class="hs-identifier hs-var">safeExp</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Bool) -&gt; (Stm rep -&gt; ExpT rep) -&gt; Stm rep -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; ExpT rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stms rep -&gt; Bool) -&gt; Stms rep -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Stms rep
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367698"><span class="hs-identifier hs-var">tbranch</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-178"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684367697"><span class="annot"><span class="annottext">ses :: Result
</span><a href="#local-6989586621684367697"><span class="hs-identifier hs-var hs-var">ses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367698"><span class="hs-identifier hs-var">tbranch</span></a></span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><span class="annottext">Stms (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Stms (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Stms rep
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367698"><span class="hs-identifier hs-var">tbranch</span></a></span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><span class="annottext">[RuleM rep ()] -&gt; RuleM rep ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><span class="hs-identifier hs-var">sequence_</span></span><span>
</span><span id="line-181"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367696"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367695"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367694"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-182"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367695"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367695"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684367696"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367696"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684367694"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367694"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
-&gt; Result -&gt; [(PatElemT (LetDec rep), SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [PatElemT (LetDec rep)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367699"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367697"><span class="hs-identifier hs-var">ses</span></a></span><span>
</span><span id="line-183"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-184"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#ruleIf"><span class="hs-identifier hs-var">ruleIf</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684367693"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367693"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367692"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367692"><span class="hs-identifier hs-var">cond</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367691"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367691"><span class="hs-identifier hs-var">tb</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367690"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367690"><span class="hs-identifier hs-var">fb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType rep)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684367689"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367689"><span class="hs-identifier hs-var">tcs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#IntValue"><span class="hs-identifier hs-type">IntValue</span></a></span><span> </span><span id="local-6989586621684367687"><span class="annot"><span class="annottext">IntValue
</span><a href="#local-6989586621684367687"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367691"><span class="hs-identifier hs-var">tb</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-186"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684367686"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367686"><span class="hs-identifier hs-var">fcs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#IntValue"><span class="hs-identifier hs-type">IntValue</span></a></span><span> </span><span id="local-6989586621684367685"><span class="annot"><span class="annottext">IntValue
</span><a href="#local-6989586621684367685"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367690"><span class="hs-identifier hs-var">fb</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-187"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">IntValue -&gt; Bool
</span><a href="Futhark.IR.Primitive.html#oneIshInt"><span class="hs-identifier hs-var">oneIshInt</span></a></span><span> </span><span class="annot"><span class="annottext">IntValue
</span><a href="#local-6989586621684367687"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">IntValue -&gt; Bool
</span><a href="Futhark.IR.Primitive.html#zeroIshInt"><span class="hs-identifier hs-var">zeroIshInt</span></a></span><span> </span><span class="annot"><span class="annottext">IntValue
</span><a href="#local-6989586621684367685"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367689"><span class="hs-identifier hs-var">tcs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367686"><span class="hs-identifier hs-var">fcs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-188"></span><span>      </span><span class="hs-keyword">then</span><span>
</span><span id="line-189"></span><span>        </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-190"></span><span>          </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684367693"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConvOp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#ConvOp"><span class="hs-identifier hs-var">ConvOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; ConvOp
</span><a href="Futhark.IR.Primitive.html#BToI"><span class="hs-identifier hs-var">BToI</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntValue -&gt; IntType
</span><a href="Futhark.IR.Primitive.html#intValueType"><span class="hs-identifier hs-var">intValueType</span></a></span><span> </span><span class="annot"><span class="annottext">IntValue
</span><a href="#local-6989586621684367687"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367692"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-191"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-192"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">IntValue -&gt; Bool
</span><a href="Futhark.IR.Primitive.html#zeroIshInt"><span class="hs-identifier hs-var">zeroIshInt</span></a></span><span> </span><span class="annot"><span class="annottext">IntValue
</span><a href="#local-6989586621684367687"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">IntValue -&gt; Bool
</span><a href="Futhark.IR.Primitive.html#oneIshInt"><span class="hs-identifier hs-var">oneIshInt</span></a></span><span> </span><span class="annot"><span class="annottext">IntValue
</span><a href="#local-6989586621684367685"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-193"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-194"></span><span>            </span><span id="local-6989586621684367679"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367679"><span class="hs-identifier hs-var">cond_neg</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;cond_neg&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp)
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UnOp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#UnOp"><span class="hs-identifier hs-var">UnOp</span></a></span><span> </span><span class="annot"><span class="annottext">UnOp
</span><a href="Futhark.IR.Primitive.html#Not"><span class="hs-identifier hs-var">Not</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367692"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-195"></span><span>            </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
Pat (Rep (RuleM rep))
</span><a href="#local-6989586621684367693"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ConvOp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#ConvOp"><span class="hs-identifier hs-var">ConvOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; ConvOp
</span><a href="Futhark.IR.Primitive.html#BToI"><span class="hs-identifier hs-var">BToI</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntValue -&gt; IntType
</span><a href="Futhark.IR.Primitive.html#intValueType"><span class="hs-identifier hs-var">intValueType</span></a></span><span> </span><span class="annot"><span class="annottext">IntValue
</span><a href="#local-6989586621684367687"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367679"><span class="hs-identifier hs-var">cond_neg</span></a></span><span>
</span><span id="line-196"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Rule rep
forall rep. Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>
</span><span id="line-197"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#ruleIf"><span class="hs-identifier hs-var">ruleIf</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">(SubExp, BodyT rep, BodyT rep, IfDec (BranchType rep))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rule rep
forall rep. Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span class="hs-comment">-- | Move out results of a conditional expression whose computation is</span><span>
</span><span id="line-200"></span><span class="hs-comment">-- either invariant to the branches (only done for results used for</span><span>
</span><span id="line-201"></span><span class="hs-comment">-- existentials), or the same in both branches.</span><span>
</span><span id="line-202"></span><span id="local-6989586621684367677"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#hoistBranchInvariant"><span class="hs-identifier hs-type">hoistBranchInvariant</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684367677"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#TopDownRuleIf"><span class="hs-identifier hs-type">TopDownRuleIf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684367677"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-203"></span><span id="hoistBranchInvariant"><span class="annot"><span class="annottext">hoistBranchInvariant :: forall rep. BuilderOps rep =&gt; TopDownRuleIf rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#hoistBranchInvariant"><span class="hs-identifier hs-var hs-var">hoistBranchInvariant</span></a></span></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684367611"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367611"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367610"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367610"><span class="hs-identifier hs-var">cond</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367609"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367609"><span class="hs-identifier hs-var">tb</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367608"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367608"><span class="hs-identifier hs-var">fb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-type">IfDec</span></a></span><span> </span><span id="local-6989586621684367607"><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367607"><span class="hs-identifier hs-var">ret</span></a></span></span><span> </span><span id="local-6989586621684367606"><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684367606"><span class="hs-identifier hs-var">ifsort</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-204"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684367605"><span class="annot"><span class="annottext">tses :: Result
</span><a href="#local-6989586621684367605"><span class="hs-identifier hs-var hs-var">tses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367609"><span class="hs-identifier hs-var">tb</span></a></span><span>
</span><span id="line-205"></span><span>      </span><span id="local-6989586621684367604"><span class="annot"><span class="annottext">fses :: Result
</span><a href="#local-6989586621684367604"><span class="hs-identifier hs-var hs-var">fses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367608"><span class="hs-identifier hs-var">fb</span></a></span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684367603"><span class="annot"><span class="annottext">[Maybe (Int, SubExp)]
</span><a href="#local-6989586621684367603"><span class="hs-identifier hs-var">hoistings</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367602"><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367602"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367601"><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367601"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367600"><span class="annot"><span class="annottext">[(SubExpRes, SubExpRes)]
</span><a href="#local-6989586621684367600"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-207"></span><span>    </span><span class="annot"><span class="annottext">([Either
    (Maybe (Int, SubExp))
    (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))]
 -&gt; ([Maybe (Int, SubExp)],
     ([PatElemT (LetDec rep)], [BranchType rep],
      [(SubExpRes, SubExpRes)])))
-&gt; RuleM
     rep
     [Either
        (Maybe (Int, SubExp))
        (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))]
-&gt; RuleM
     rep
     ([Maybe (Int, SubExp)],
      ([PatElemT (LetDec rep)], [BranchType rep],
       [(SubExpRes, SubExpRes)]))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([(PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))]
 -&gt; ([PatElemT (LetDec rep)], [BranchType rep],
     [(SubExpRes, SubExpRes)]))
-&gt; ([Maybe (Int, SubExp)],
    [(PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))])
-&gt; ([Maybe (Int, SubExp)],
    ([PatElemT (LetDec rep)], [BranchType rep],
     [(SubExpRes, SubExpRes)]))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[(PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))]
-&gt; ([PatElemT (LetDec rep)], [BranchType rep],
    [(SubExpRes, SubExpRes)])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">(([Maybe (Int, SubExp)],
  [(PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))])
 -&gt; ([Maybe (Int, SubExp)],
     ([PatElemT (LetDec rep)], [BranchType rep],
      [(SubExpRes, SubExpRes)])))
-&gt; ([Either
       (Maybe (Int, SubExp))
       (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))]
    -&gt; ([Maybe (Int, SubExp)],
        [(PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))]))
-&gt; [Either
      (Maybe (Int, SubExp))
      (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))]
-&gt; ([Maybe (Int, SubExp)],
    ([PatElemT (LetDec rep)], [BranchType rep],
     [(SubExpRes, SubExpRes)]))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Either
   (Maybe (Int, SubExp))
   (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))]
-&gt; ([Maybe (Int, SubExp)],
    [(PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))])
forall a b. [Either a b] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">partitionEithers</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM
   rep
   [Either
      (Maybe (Int, SubExp))
      (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))]
 -&gt; RuleM
      rep
      ([Maybe (Int, SubExp)],
       ([PatElemT (LetDec rep)], [BranchType rep],
        [(SubExpRes, SubExpRes)])))
-&gt; ([(Int, PatElemT (LetDec rep), BranchType rep,
      (SubExpRes, SubExpRes))]
    -&gt; RuleM
         rep
         [Either
            (Maybe (Int, SubExp))
            (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))])
-&gt; [(Int, PatElemT (LetDec rep), BranchType rep,
     (SubExpRes, SubExpRes))]
-&gt; RuleM
     rep
     ([Maybe (Int, SubExp)],
      ([PatElemT (LetDec rep)], [BranchType rep],
       [(SubExpRes, SubExpRes)]))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Int, PatElemT (LetDec rep), BranchType rep,
  (SubExpRes, SubExpRes))
 -&gt; RuleM
      rep
      (Either
         (Maybe (Int, SubExp))
         (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))))
-&gt; [(Int, PatElemT (LetDec rep), BranchType rep,
     (SubExpRes, SubExpRes))]
-&gt; RuleM
     rep
     [Either
        (Maybe (Int, SubExp))
        (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Int, PatElemT (LetDec rep), BranchType rep,
 (SubExpRes, SubExpRes))
-&gt; RuleM
     rep
     (Either
        (Maybe (Int, SubExp))
        (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes)))
</span><a href="#local-6989586621684367597"><span class="hs-identifier hs-var">branchInvariant</span></a></span><span> </span><span class="annot"><span class="annottext">([(Int, PatElemT (LetDec rep), BranchType rep,
   (SubExpRes, SubExpRes))]
 -&gt; RuleM
      rep
      ([Maybe (Int, SubExp)],
       ([PatElemT (LetDec rep)], [BranchType rep],
        [(SubExpRes, SubExpRes)])))
-&gt; [(Int, PatElemT (LetDec rep), BranchType rep,
     (SubExpRes, SubExpRes))]
-&gt; RuleM
     rep
     ([Maybe (Int, SubExp)],
      ([PatElemT (LetDec rep)], [BranchType rep],
       [(SubExpRes, SubExpRes)]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-208"></span><span>      </span><span class="annot"><span class="annottext">[Int]
-&gt; [PatElemT (LetDec rep)]
-&gt; [BranchType rep]
-&gt; [(SubExpRes, SubExpRes)]
-&gt; [(Int, PatElemT (LetDec rep), BranchType rep,
     (SubExpRes, SubExpRes))]
forall a b c d. [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [(a, b, c, d)]
</span><span class="hs-identifier hs-var">zip4</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [PatElemT (LetDec rep)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367611"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367607"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; [(SubExpRes, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367605"><span class="hs-identifier hs-var">tses</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367604"><span class="hs-identifier hs-var">fses</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684367596"><span class="annot"><span class="annottext">ctx_fixes :: [(Int, SubExp)]
</span><a href="#local-6989586621684367596"><span class="hs-identifier hs-var hs-var">ctx_fixes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe (Int, SubExp)] -&gt; [(Int, SubExp)]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (Int, SubExp)]
</span><a href="#local-6989586621684367603"><span class="hs-identifier hs-var">hoistings</span></a></span><span>
</span><span id="line-210"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684367594"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367594"><span class="hs-identifier hs-var">tses'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367593"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367593"><span class="hs-identifier hs-var">fses'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(SubExpRes, SubExpRes)] -&gt; (Result, Result)
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(SubExpRes, SubExpRes)]
</span><a href="#local-6989586621684367600"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-211"></span><span>      </span><span id="local-6989586621684367591"><span class="annot"><span class="annottext">tb' :: BodyT rep
</span><a href="#local-6989586621684367591"><span class="hs-identifier hs-var hs-var">tb'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367609"><span class="hs-identifier hs-var">tb</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">bodyResult :: Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var">bodyResult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367594"><span class="hs-identifier hs-var">tses'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-212"></span><span>      </span><span id="local-6989586621684367590"><span class="annot"><span class="annottext">fb' :: BodyT rep
</span><a href="#local-6989586621684367590"><span class="hs-identifier hs-var hs-var">fb'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367608"><span class="hs-identifier hs-var">fb</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">bodyResult :: Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var">bodyResult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367593"><span class="hs-identifier hs-var">fses'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-213"></span><span>      </span><span id="local-6989586621684367589"><span class="annot"><span class="annottext">ret' :: [BranchType rep]
</span><a href="#local-6989586621684367589"><span class="hs-identifier hs-var hs-var">ret'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Int, SubExp) -&gt; [BranchType rep] -&gt; [BranchType rep])
-&gt; [BranchType rep] -&gt; [(Int, SubExp)] -&gt; [BranchType rep]
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int -&gt; SubExp -&gt; [BranchType rep] -&gt; [BranchType rep])
-&gt; (Int, SubExp) -&gt; [BranchType rep] -&gt; [BranchType rep]
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SubExp -&gt; [BranchType rep] -&gt; [BranchType rep]
forall t. FixExt t =&gt; Int -&gt; SubExp -&gt; t -&gt; t
</span><a href="Futhark.IR.Prop.Types.html#fixExt"><span class="hs-identifier hs-var">fixExt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367601"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">[(Int, SubExp)]
</span><a href="#local-6989586621684367596"><span class="hs-identifier hs-var">ctx_fixes</span></a></span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (Int, SubExp)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (Int, SubExp)]
</span><a href="#local-6989586621684367603"><span class="hs-identifier hs-var">hoistings</span></a></span><span> </span><span class="hs-comment">-- Was something hoisted?</span><span>
</span><span id="line-215"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-216"></span><span>      </span><span class="hs-comment">-- We may have to add some reshapes if we made the type</span><span>
</span><span id="line-217"></span><span>      </span><span class="hs-comment">-- less existential.</span><span>
</span><span id="line-218"></span><span>      </span><span id="local-6989586621684367585"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367585"><span class="hs-identifier hs-var">tb''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Body (Rep (RuleM rep))
-&gt; [TypeBase ExtShape NoUniqueness]
-&gt; RuleM rep (Body (Rep (RuleM rep)))
forall {m :: * -&gt; *}.
MonadBuilder m =&gt;
Body (Rep m)
-&gt; [TypeBase ExtShape NoUniqueness] -&gt; m (Body (Rep m))
</span><a href="#local-6989586621684367584"><span class="hs-identifier hs-var">reshapeBodyResults</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
Body (Rep (RuleM rep))
</span><a href="#local-6989586621684367591"><span class="hs-identifier hs-var">tb'</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase ExtShape NoUniqueness]
 -&gt; RuleM rep (Body (Rep (RuleM rep))))
-&gt; [TypeBase ExtShape NoUniqueness]
-&gt; RuleM rep (Body (Rep (RuleM rep)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(BranchType rep -&gt; TypeBase ExtShape NoUniqueness)
-&gt; [BranchType rep] -&gt; [TypeBase ExtShape NoUniqueness]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">BranchType rep -&gt; TypeBase ExtShape NoUniqueness
forall t. ExtTyped t =&gt; t -&gt; TypeBase ExtShape NoUniqueness
</span><a href="Futhark.IR.Prop.Types.html#extTypeOf"><span class="hs-identifier hs-var">extTypeOf</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367589"><span class="hs-identifier hs-var">ret'</span></a></span><span>
</span><span id="line-219"></span><span>      </span><span id="local-6989586621684367583"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367583"><span class="hs-identifier hs-var">fb''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Body (Rep (RuleM rep))
-&gt; [TypeBase ExtShape NoUniqueness]
-&gt; RuleM rep (Body (Rep (RuleM rep)))
forall {m :: * -&gt; *}.
MonadBuilder m =&gt;
Body (Rep m)
-&gt; [TypeBase ExtShape NoUniqueness] -&gt; m (Body (Rep m))
</span><a href="#local-6989586621684367584"><span class="hs-identifier hs-var">reshapeBodyResults</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
Body (Rep (RuleM rep))
</span><a href="#local-6989586621684367590"><span class="hs-identifier hs-var">fb'</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase ExtShape NoUniqueness]
 -&gt; RuleM rep (Body (Rep (RuleM rep))))
-&gt; [TypeBase ExtShape NoUniqueness]
-&gt; RuleM rep (Body (Rep (RuleM rep)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(BranchType rep -&gt; TypeBase ExtShape NoUniqueness)
-&gt; [BranchType rep] -&gt; [TypeBase ExtShape NoUniqueness]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">BranchType rep -&gt; TypeBase ExtShape NoUniqueness
forall t. ExtTyped t =&gt; t -&gt; TypeBase ExtShape NoUniqueness
</span><a href="Futhark.IR.Prop.Types.html#extTypeOf"><span class="hs-identifier hs-var">extTypeOf</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367589"><span class="hs-identifier hs-var">ret'</span></a></span><span>
</span><span id="line-220"></span><span>      </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)] -&gt; Pat rep
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367602"><span class="hs-identifier hs-var">pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
forall rep.
SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367610"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367585"><span class="hs-identifier hs-var">tb''</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367583"><span class="hs-identifier hs-var">fb''</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BranchType rep] -&gt; IfSort -&gt; IfDec (BranchType rep)
forall rt. [rt] -&gt; IfSort -&gt; IfDec rt
</span><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-var">IfDec</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367589"><span class="hs-identifier hs-var">ret'</span></a></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684367606"><span class="hs-identifier hs-var">ifsort</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-221"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">RuleM rep ()
forall rep a. RuleM rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#cannotSimplify"><span class="hs-identifier hs-var">cannotSimplify</span></a></span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-223"></span><span>    </span><span id="local-6989586621684367580"><span class="annot"><span class="annottext">bound_in_branches :: Names
</span><a href="#local-6989586621684367580"><span class="hs-identifier hs-var hs-var">bound_in_branches</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-224"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; (Stms rep -&gt; [VName]) -&gt; Stms rep -&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; [VName]) -&gt; Stms rep -&gt; [VName]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">(Pat rep -&gt; [VName]) -&gt; (Stm rep -&gt; Pat rep) -&gt; Stm rep -&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Pat rep
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stms rep -&gt; Names) -&gt; Stms rep -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-225"></span><span>        </span><span class="annot"><span class="annottext">BodyT rep -&gt; Stms rep
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367609"><span class="hs-identifier hs-var">tb</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Stms rep -&gt; Stms rep
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Stms rep
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367608"><span class="hs-identifier hs-var">fb</span></a></span><span>
</span><span id="line-226"></span><span>    </span><span id="local-6989586621684367577"><span class="annot"><span class="annottext">invariant :: SubExp -&gt; Bool
</span><a href="#local-6989586621684367577"><span class="hs-identifier hs-var hs-var">invariant</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-227"></span><span>    </span><span class="annot"><a href="#local-6989586621684367577"><span class="hs-identifier hs-var">invariant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684367576"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367576"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367576"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684367580"><span class="hs-identifier hs-var">bound_in_branches</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>    </span><span id="local-6989586621684367597"><span class="annot"><span class="annottext">branchInvariant :: (Int, PatElemT (LetDec rep), BranchType rep,
 (SubExpRes, SubExpRes))
-&gt; RuleM
     rep
     (Either
        (Maybe (Int, SubExp))
        (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes)))
</span><a href="#local-6989586621684367597"><span class="hs-identifier hs-var hs-var">branchInvariant</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367574"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684367574"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367573"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367573"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367572"><span class="annot"><span class="annottext">BranchType rep
</span><a href="#local-6989586621684367572"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367571"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367571"><span class="hs-identifier hs-var">tse</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367570"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367570"><span class="hs-identifier hs-var">fse</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-230"></span><span>      </span><span class="hs-comment">-- Do both branches return the same value?</span><span>
</span><span id="line-231"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367571"><span class="hs-identifier hs-var">tse</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExpRes -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367570"><span class="hs-identifier hs-var">fse</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>        </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExpRes -&gt; Certs
</span><a href="Futhark.IR.Syntax.html#resCerts"><span class="hs-identifier hs-var hs-var">resCerts</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367571"><span class="hs-identifier hs-var">tse</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; Certs
</span><a href="Futhark.IR.Syntax.html#resCerts"><span class="hs-identifier hs-var hs-var">resCerts</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367570"><span class="hs-identifier hs-var">fse</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-233"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367573"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367571"><span class="hs-identifier hs-var">tse</span></a></span><span>
</span><span id="line-234"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; PatElemT (LetDec rep)
-&gt; RuleM
     rep
     (Either
        (Maybe (Int, SubExp))
        (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes)))
forall {f :: * -&gt; *} {a} {dec} {b}.
Applicative f =&gt;
a -&gt; PatElemT dec -&gt; f (Either (Maybe (a, SubExp)) b)
</span><a href="#local-6989586621684367567"><span class="hs-identifier hs-var">hoisted</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684367574"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367573"><span class="hs-identifier hs-var">pe</span></a></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span>      </span><span class="hs-comment">-- Do both branches return values that are free in the</span><span>
</span><span id="line-237"></span><span>      </span><span class="hs-comment">-- branch, and are we not the only pattern element?  The</span><span>
</span><span id="line-238"></span><span>      </span><span class="hs-comment">-- latter is to avoid infinite application of this rule.</span><span>
</span><span id="line-239"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="#local-6989586621684367577"><span class="hs-identifier hs-var">invariant</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Bool) -&gt; SubExp -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367571"><span class="hs-identifier hs-var">tse</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-240"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="#local-6989586621684367577"><span class="hs-identifier hs-var">invariant</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Bool) -&gt; SubExp -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367570"><span class="hs-identifier hs-var">fse</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-241"></span><span>        </span><span class="annot"><span class="annottext">Pat rep -&gt; Int
forall dec. PatT dec -&gt; Int
</span><a href="Futhark.IR.Prop.Patterns.html#patSize"><span class="hs-identifier hs-var">patSize</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367611"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span>
</span><span id="line-242"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; Type
forall dec. Typed dec =&gt; PatElemT dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#patElemType"><span class="hs-identifier hs-var">patElemType</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367573"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-243"></span><span>        </span><span id="local-6989586621684367563"><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367563"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; RuleM rep [BranchType rep]
forall rep (m :: * -&gt; *).
(ASTRep rep, HasScope rep m, Monad m) =&gt;
Pat rep -&gt; m [BranchType rep]
</span><a href="Futhark.IR.Prop.html#expTypesFromPat"><span class="hs-identifier hs-var">expTypesFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">(Pat rep -&gt; RuleM rep [BranchType rep])
-&gt; Pat rep -&gt; RuleM rep [BranchType rep]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)] -&gt; Pat rep
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367573"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-244"></span><span>        </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367573"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-245"></span><span>          </span><span class="annot"><span class="annottext">(ExpT rep -&gt; RuleM rep ()) -&gt; RuleM rep (ExpT rep) -&gt; RuleM rep ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
forall rep.
SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367610"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep)
-&gt; RuleM rep (BodyT rep)
-&gt; RuleM rep (BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; RuleM rep (Body (Rep (RuleM rep)))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[SubExp] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#resultBodyM"><span class="hs-identifier hs-var">resultBodyM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367571"><span class="hs-identifier hs-var">tse</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-246"></span><span>                  </span><span class="annot"><span class="annottext">RuleM rep (BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep)
-&gt; RuleM rep (BodyT rep)
-&gt; RuleM rep (IfDec (BranchType rep) -&gt; ExpT rep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; RuleM rep (Body (Rep (RuleM rep)))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[SubExp] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#resultBodyM"><span class="hs-identifier hs-var">resultBodyM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367570"><span class="hs-identifier hs-var">fse</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-247"></span><span>                  </span><span class="annot"><span class="annottext">RuleM rep (IfDec (BranchType rep) -&gt; ExpT rep)
-&gt; RuleM rep (IfDec (BranchType rep)) -&gt; RuleM rep (ExpT rep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType rep) -&gt; RuleM rep (IfDec (BranchType rep))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BranchType rep] -&gt; IfSort -&gt; IfDec (BranchType rep)
forall rt. [rt] -&gt; IfSort -&gt; IfDec rt
</span><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-var">IfDec</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367563"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684367606"><span class="hs-identifier hs-var">ifsort</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-249"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; PatElemT (LetDec rep)
-&gt; RuleM
     rep
     (Either
        (Maybe (Int, SubExp))
        (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes)))
forall {f :: * -&gt; *} {a} {dec} {b}.
Applicative f =&gt;
a -&gt; PatElemT dec -&gt; f (Either (Maybe (a, SubExp)) b)
</span><a href="#local-6989586621684367567"><span class="hs-identifier hs-var">hoisted</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684367574"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367573"><span class="hs-identifier hs-var">pe</span></a></span><span>
</span><span id="line-250"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-251"></span><span>        </span><span class="annot"><span class="annottext">Either
  (Maybe (Int, SubExp))
  (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))
-&gt; RuleM
     rep
     (Either
        (Maybe (Int, SubExp))
        (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either
   (Maybe (Int, SubExp))
   (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))
 -&gt; RuleM
      rep
      (Either
         (Maybe (Int, SubExp))
         (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))))
-&gt; Either
     (Maybe (Int, SubExp))
     (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))
-&gt; RuleM
     rep
     (Either
        (Maybe (Int, SubExp))
        (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))
-&gt; Either
     (Maybe (Int, SubExp))
     (PatElemT (LetDec rep), BranchType rep, (SubExpRes, SubExpRes))
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367573"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BranchType rep
</span><a href="#local-6989586621684367572"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367571"><span class="hs-identifier hs-var">tse</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367570"><span class="hs-identifier hs-var">fse</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span>    </span><span id="local-6989586621684367567"><span class="annot"><span class="annottext">hoisted :: a -&gt; PatElemT dec -&gt; f (Either (Maybe (a, SubExp)) b)
</span><a href="#local-6989586621684367567"><span class="hs-identifier hs-var hs-var">hoisted</span></a></span></span><span> </span><span id="local-6989586621684367557"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684367557"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684367556"><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684367556"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Either (Maybe (a, SubExp)) b -&gt; f (Either (Maybe (a, SubExp)) b)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either (Maybe (a, SubExp)) b -&gt; f (Either (Maybe (a, SubExp)) b))
-&gt; Either (Maybe (a, SubExp)) b -&gt; f (Either (Maybe (a, SubExp)) b)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (a, SubExp) -&gt; Either (Maybe (a, SubExp)) b
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (a, SubExp) -&gt; Either (Maybe (a, SubExp)) b)
-&gt; Maybe (a, SubExp) -&gt; Either (Maybe (a, SubExp)) b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(a, SubExp) -&gt; Maybe (a, SubExp)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684367557"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT dec -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684367556"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span>    </span><span id="local-6989586621684367584"><span class="annot"><span class="annottext">reshapeBodyResults :: Body (Rep m)
-&gt; [TypeBase ExtShape NoUniqueness] -&gt; m (Body (Rep m))
</span><a href="#local-6989586621684367584"><span class="hs-identifier hs-var hs-var">reshapeBodyResults</span></a></span></span><span> </span><span id="local-6989586621684367539"><span class="annot"><span class="annottext">Body (Rep m)
</span><a href="#local-6989586621684367539"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621684367538"><span class="annot"><span class="annottext">[TypeBase ExtShape NoUniqueness]
</span><a href="#local-6989586621684367538"><span class="hs-identifier hs-var">rets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m Result -&gt; m (Body (Rep m))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
m Result -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#buildBody_"><span class="hs-identifier hs-var">buildBody_</span></a></span><span> </span><span class="annot"><span class="annottext">(m Result -&gt; m (Body (Rep m))) -&gt; m Result -&gt; m (Body (Rep m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>      </span><span id="local-6989586621684367536"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367536"><span class="hs-identifier hs-var">ses</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Body (Rep m) -&gt; m Result
forall (m :: * -&gt; *). MonadBuilder m =&gt; Body (Rep m) -&gt; m Result
</span><a href="Futhark.Builder.Class.html#bodyBind"><span class="hs-identifier hs-var">bodyBind</span></a></span><span> </span><span class="annot"><span class="annottext">Body (Rep m)
</span><a href="#local-6989586621684367539"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-257"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367534"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367534"><span class="hs-identifier hs-var">ctx_ses</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367533"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367533"><span class="hs-identifier hs-var">val_ses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; (Result, Result)
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Futhark.Util.html#splitFromEnd"><span class="hs-identifier hs-var">splitFromEnd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TypeBase ExtShape NoUniqueness] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TypeBase ExtShape NoUniqueness]
</span><a href="#local-6989586621684367538"><span class="hs-identifier hs-var">rets</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367536"><span class="hs-identifier hs-var">ses</span></a></span><span>
</span><span id="line-258"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367534"><span class="hs-identifier hs-var">ctx_ses</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Result -&gt; Result) -&gt; m Result -&gt; m Result
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; TypeBase ExtShape NoUniqueness -&gt; m SubExpRes)
-&gt; Result -&gt; [TypeBase ExtShape NoUniqueness] -&gt; m Result
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; TypeBase ExtShape NoUniqueness -&gt; m SubExpRes
forall {m :: * -&gt; *}.
MonadBuilder m =&gt;
SubExpRes -&gt; TypeBase ExtShape NoUniqueness -&gt; m SubExpRes
</span><a href="#local-6989586621684367529"><span class="hs-identifier hs-var">reshapeResult</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367533"><span class="hs-identifier hs-var">val_ses</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase ExtShape NoUniqueness]
</span><a href="#local-6989586621684367538"><span class="hs-identifier hs-var">rets</span></a></span><span>
</span><span id="line-259"></span><span>    </span><span id="local-6989586621684367529"><span class="annot"><span class="annottext">reshapeResult :: SubExpRes -&gt; TypeBase ExtShape NoUniqueness -&gt; m SubExpRes
</span><a href="#local-6989586621684367529"><span class="hs-identifier hs-var hs-var">reshapeResult</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684367507"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367507"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684367506"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367506"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684367505"><span class="annot"><span class="annottext">t :: TypeBase ExtShape NoUniqueness
</span><a href="#local-6989586621684367505"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-260"></span><span>      </span><span id="local-6989586621684367503"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684367503"><span class="hs-identifier hs-var">v_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367506"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-261"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684367501"><span class="annot"><span class="annottext">newshape :: [SubExp]
</span><a href="#local-6989586621684367501"><span class="hs-identifier hs-var hs-var">newshape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; [SubExp]) -&gt; Type -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeBase ExtShape NoUniqueness -&gt; Type -&gt; Type
</span><a href="Futhark.Construct.html#removeExistentials"><span class="hs-identifier hs-var">removeExistentials</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase ExtShape NoUniqueness
</span><a href="#local-6989586621684367505"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684367503"><span class="hs-identifier hs-var">v_t</span></a></span><span>
</span><span id="line-262"></span><span>      </span><span class="annot"><span class="annottext">Certs -&gt; SubExp -&gt; SubExpRes
</span><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-var">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367507"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-263"></span><span>        </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExpRes) -&gt; m SubExp -&gt; m SubExpRes
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684367501"><span class="hs-identifier hs-var">newshape</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684367503"><span class="hs-identifier hs-var">v_t</span></a></span><span>
</span><span id="line-264"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;branch_ctx_reshaped&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; VName -&gt; Exp (Rep m)
forall rep. [SubExp] -&gt; VName -&gt; Exp rep
</span><a href="Futhark.IR.Prop.Reshape.html#shapeCoerce"><span class="hs-identifier hs-var">shapeCoerce</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684367501"><span class="hs-identifier hs-var">newshape</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367506"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; m SubExp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; m SubExp) -&gt; SubExp -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367506"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-266"></span><span>    </span><span class="annot"><a href="#local-6989586621684367529"><span class="hs-identifier hs-var">reshapeResult</span></a></span><span> </span><span id="local-6989586621684367497"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367497"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="annot"><span class="annottext">TypeBase ExtShape NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-267"></span><span>      </span><span class="annot"><span class="annottext">SubExpRes -&gt; m SubExpRes
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684367497"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span class="hs-comment">-- | Remove the return values of a branch, that are not actually used</span><span>
</span><span id="line-270"></span><span class="hs-comment">-- after a branch.  Standard dead code removal can remove the branch</span><span>
</span><span id="line-271"></span><span class="hs-comment">-- if *none* of the return values are used, but this rule is more</span><span>
</span><span id="line-272"></span><span class="hs-comment">-- precise.</span><span>
</span><span id="line-273"></span><span id="local-6989586621684368374"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#removeDeadBranchResult"><span class="hs-identifier hs-type">removeDeadBranchResult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368374"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#BottomUpRuleIf"><span class="hs-identifier hs-type">BottomUpRuleIf</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368374"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-274"></span><span id="removeDeadBranchResult"><span class="annot"><span class="annottext">removeDeadBranchResult :: forall rep. BuilderOps rep =&gt; BottomUpRuleIf rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#removeDeadBranchResult"><span class="hs-identifier hs-var hs-var">removeDeadBranchResult</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367482"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684367482"><span class="hs-identifier hs-var">used</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684367481"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367481"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367480"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367480"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367479"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367479"><span class="hs-identifier hs-var">tb</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367478"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367478"><span class="hs-identifier hs-var">fb</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-type">IfDec</span></a></span><span> </span><span id="local-6989586621684367477"><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367477"><span class="hs-identifier hs-var">rettype</span></a></span></span><span> </span><span id="local-6989586621684367476"><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684367476"><span class="hs-identifier hs-var">ifsort</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- Only if there is no existential binding...</span><span>
</span><span id="line-276"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">(PatElemT (LetDec rep) -&gt; Names)
-&gt; [PatElemT (LetDec rep)] -&gt; Names
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [PatElemT (LetDec rep)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367481"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367481"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-comment">-- Figure out which of the names in 'pat' are used...</span><span>
</span><span id="line-278"></span><span>    </span><span id="local-6989586621684367472"><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621684367472"><span class="hs-identifier hs-var">patused</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; [Bool]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#isUsedDirectly"><span class="hs-operator hs-var">`UT.isUsedDirectly`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684367482"><span class="hs-identifier hs-var">used</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [Bool]) -&gt; [VName] -&gt; [Bool]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367481"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-279"></span><span>    </span><span class="hs-comment">-- If they are not all used, then this rule applies.</span><span>
</span><span id="line-280"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Bool] -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><span class="hs-identifier hs-var">and</span></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621684367472"><span class="hs-identifier hs-var">patused</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-281"></span><span>    </span><span class="hs-comment">-- Remove the parts of the branch-results that correspond to dead</span><span>
</span><span id="line-282"></span><span>    </span><span class="hs-comment">-- return value bindings.  Note that this leaves dead code in the</span><span>
</span><span id="line-283"></span><span>    </span><span class="hs-comment">-- branch bodies, but that will be removed later.</span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684367469"><span class="annot"><span class="annottext">tses :: Result
</span><a href="#local-6989586621684367469"><span class="hs-identifier hs-var hs-var">tses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367479"><span class="hs-identifier hs-var">tb</span></a></span><span>
</span><span id="line-285"></span><span>        </span><span id="local-6989586621684367468"><span class="annot"><span class="annottext">fses :: Result
</span><a href="#local-6989586621684367468"><span class="hs-identifier hs-var hs-var">fses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367478"><span class="hs-identifier hs-var">fb</span></a></span><span>
</span><span id="line-286"></span><span>        </span><span id="local-6989586621684368126"><span class="annot"><a href="#local-6989586621684367467"><span class="hs-identifier hs-type">pick</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684368126"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684368126"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-287"></span><span>        </span><span id="local-6989586621684367467"><span class="annot"><span class="annottext">pick :: forall a. [a] -&gt; [a]
</span><a href="#local-6989586621684367467"><span class="hs-identifier hs-var hs-var">pick</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Bool, a) -&gt; a) -&gt; [(Bool, a)] -&gt; [a]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Bool, a) -&gt; a
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([(Bool, a)] -&gt; [a]) -&gt; ([a] -&gt; [(Bool, a)]) -&gt; [a] -&gt; [a]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((Bool, a) -&gt; Bool) -&gt; [(Bool, a)] -&gt; [(Bool, a)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">(Bool, a) -&gt; Bool
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(Bool, a)] -&gt; [(Bool, a)])
-&gt; ([a] -&gt; [(Bool, a)]) -&gt; [a] -&gt; [(Bool, a)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; [a] -&gt; [(Bool, a)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Bool]
</span><a href="#local-6989586621684367472"><span class="hs-identifier hs-var">patused</span></a></span><span>
</span><span id="line-288"></span><span>        </span><span id="local-6989586621684367466"><span class="annot"><span class="annottext">tb' :: BodyT rep
</span><a href="#local-6989586621684367466"><span class="hs-identifier hs-var hs-var">tb'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367479"><span class="hs-identifier hs-var">tb</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">bodyResult :: Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var">bodyResult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result
forall a. [a] -&gt; [a]
</span><a href="#local-6989586621684367467"><span class="hs-identifier hs-var">pick</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367469"><span class="hs-identifier hs-var">tses</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-289"></span><span>        </span><span id="local-6989586621684367465"><span class="annot"><span class="annottext">fb' :: BodyT rep
</span><a href="#local-6989586621684367465"><span class="hs-identifier hs-var hs-var">fb'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367478"><span class="hs-identifier hs-var">fb</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">bodyResult :: Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var">bodyResult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result
forall a. [a] -&gt; [a]
</span><a href="#local-6989586621684367467"><span class="hs-identifier hs-var">pick</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367468"><span class="hs-identifier hs-var">fses</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-290"></span><span>        </span><span id="local-6989586621684367464"><span class="annot"><span class="annottext">pat' :: [PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367464"><span class="hs-identifier hs-var hs-var">pat'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)] -&gt; [PatElemT (LetDec rep)]
forall a. [a] -&gt; [a]
</span><a href="#local-6989586621684367467"><span class="hs-identifier hs-var">pick</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT (LetDec rep)] -&gt; [PatElemT (LetDec rep)])
-&gt; [PatElemT (LetDec rep)] -&gt; [PatElemT (LetDec rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; [PatElemT (LetDec rep)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367481"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-291"></span><span>        </span><span id="local-6989586621684367463"><span class="annot"><span class="annottext">rettype' :: [BranchType rep]
</span><a href="#local-6989586621684367463"><span class="hs-identifier hs-var hs-var">rettype'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[BranchType rep] -&gt; [BranchType rep]
forall a. [a] -&gt; [a]
</span><a href="#local-6989586621684367467"><span class="hs-identifier hs-var">pick</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367477"><span class="hs-identifier hs-var">rettype</span></a></span><span>
</span><span id="line-292"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)] -&gt; Pat rep
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367464"><span class="hs-identifier hs-var">pat'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
forall rep.
SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367480"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367466"><span class="hs-identifier hs-var">tb'</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367465"><span class="hs-identifier hs-var">fb'</span></a></span><span> </span><span class="annot"><span class="annottext">(IfDec (BranchType rep) -&gt; ExpT rep)
-&gt; IfDec (BranchType rep) -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[BranchType rep] -&gt; IfSort -&gt; IfDec (BranchType rep)
forall rt. [rt] -&gt; IfSort -&gt; IfDec rt
</span><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-var">IfDec</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684367463"><span class="hs-identifier hs-var">rettype'</span></a></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684367476"><span class="hs-identifier hs-var">ifsort</span></a></span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rule rep
forall rep. Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>
</span><span id="line-294"></span><span>
</span><span id="line-295"></span><span id="local-6989586621684367462"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#withAccTopDown"><span class="hs-identifier hs-type">withAccTopDown</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684367462"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#TopDownRuleGeneric"><span class="hs-identifier hs-type">TopDownRuleGeneric</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684367462"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-296"></span><span class="hs-comment">-- A WithAcc with no accumulators is sent to Valhalla.</span><span>
</span><span id="line-297"></span><span id="withAccTopDown"><span class="annot"><span class="annottext">withAccTopDown :: forall rep. BuilderOps rep =&gt; TopDownRuleGeneric rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#withAccTopDown"><span class="hs-identifier hs-var hs-var">withAccTopDown</span></a></span></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684367404"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367404"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684367403"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684367403"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-type">WithAcc</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684367401"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367401"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep)
-&gt; (RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; Rule rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684367403"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-298"></span><span>  </span><span id="local-6989586621684367399"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367399"><span class="hs-identifier hs-var">lam_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Body (Rep (RuleM rep)) -&gt; RuleM rep Result
forall (m :: * -&gt; *). MonadBuilder m =&gt; Body (Rep m) -&gt; m Result
</span><a href="Futhark.Builder.Class.html#bodyBind"><span class="hs-identifier hs-var">bodyBind</span></a></span><span> </span><span class="annot"><span class="annottext">(Body (Rep (RuleM rep)) -&gt; RuleM rep Result)
-&gt; Body (Rep (RuleM rep)) -&gt; RuleM rep Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367401"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span class="annot"><span class="annottext">[(VName, SubExpRes)]
-&gt; ((VName, SubExpRes) -&gt; RuleM rep ()) -&gt; RuleM rep ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Result -&gt; [(VName, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367404"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367399"><span class="hs-identifier hs-var">lam_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExpRes) -&gt; RuleM rep ()) -&gt; RuleM rep ())
-&gt; ((VName, SubExpRes) -&gt; RuleM rep ()) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684367396"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367396"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684367395"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367395"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684367394"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367394"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-300"></span><span>    </span><span class="annot"><span class="annottext">Certs -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367395"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367396"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684367394"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-301"></span><span class="hs-comment">-- Identify those results in 'lam' that are free and move them out.</span><span>
</span><span id="line-302"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#withAccTopDown"><span class="hs-identifier hs-var">withAccTopDown</span></a></span><span> </span><span id="local-6989586621684367393"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684367393"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684367392"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367392"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684367391"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684367391"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-type">WithAcc</span></a></span><span> </span><span id="local-6989586621684367390"><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684367390"><span class="hs-identifier hs-var">inputs</span></a></span></span><span> </span><span id="local-6989586621684367389"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367389"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep)
-&gt; (RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; Rule rep
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684367391"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367388"><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684367388"><span class="hs-identifier hs-var">cert_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367387"><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684367387"><span class="hs-identifier hs-var">acc_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-304"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; [Param (LParamInfo rep)]
-&gt; ([Param (LParamInfo rep)], [Param (LParamInfo rep)])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[WithAccInput rep] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684367390"><span class="hs-identifier hs-var">inputs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param (LParamInfo rep)]
 -&gt; ([Param (LParamInfo rep)], [Param (LParamInfo rep)]))
-&gt; [Param (LParamInfo rep)]
-&gt; ([Param (LParamInfo rep)], [Param (LParamInfo rep)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [Param (LParamInfo rep)]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367389"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-305"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684367384"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367384"><span class="hs-identifier hs-var">acc_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367383"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367383"><span class="hs-identifier hs-var">nonacc_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-306"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; (Result, Result)
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Futhark.Util.html#splitFromEnd"><span class="hs-identifier hs-var">splitFromEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684367382"><span class="hs-identifier hs-var">num_nonaccs</span></a></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; (Result, Result)) -&gt; Result -&gt; (Result, Result)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT rep -&gt; Result) -&gt; BodyT rep -&gt; Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367389"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-307"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684367381"><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367381"><span class="hs-identifier hs-var">acc_pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367380"><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367380"><span class="hs-identifier hs-var">nonacc_pes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-308"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; [PatElemT (LetDec rep)]
-&gt; ([PatElemT (LetDec rep)], [PatElemT (LetDec rep)])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Futhark.Util.html#splitFromEnd"><span class="hs-identifier hs-var">splitFromEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684367382"><span class="hs-identifier hs-var">num_nonaccs</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT (LetDec rep)]
 -&gt; ([PatElemT (LetDec rep)], [PatElemT (LetDec rep)]))
-&gt; [PatElemT (LetDec rep)]
-&gt; ([PatElemT (LetDec rep)], [PatElemT (LetDec rep)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; [PatElemT (LetDec rep)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367392"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-309"></span><span>
</span><span id="line-310"></span><span>  </span><span class="hs-comment">-- Look at accumulator results.</span><span>
</span><span id="line-311"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684367379"><span class="annot"><span class="annottext">[[PatElemT (LetDec rep)]]
</span><a href="#local-6989586621684367379"><span class="hs-identifier hs-var">acc_pes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367378"><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684367378"><span class="hs-identifier hs-var">inputs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367377"><span class="annot"><span class="annottext">[(Param (LParamInfo rep), Param (LParamInfo rep))]
</span><a href="#local-6989586621684367377"><span class="hs-identifier hs-var">params'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367376"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367376"><span class="hs-identifier hs-var">acc_res'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-312"></span><span>    </span><span class="annot"><span class="annottext">([Maybe
    ([PatElemT (LetDec rep)], WithAccInput rep,
     (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
 -&gt; ([[PatElemT (LetDec rep)]], [WithAccInput rep],
     [(Param (LParamInfo rep), Param (LParamInfo rep))], Result))
-&gt; RuleM
     rep
     [Maybe
        ([PatElemT (LetDec rep)], WithAccInput rep,
         (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
-&gt; RuleM
     rep
     ([[PatElemT (LetDec rep)]], [WithAccInput rep],
      [(Param (LParamInfo rep), Param (LParamInfo rep))], Result)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[([PatElemT (LetDec rep)], WithAccInput rep,
  (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
-&gt; ([[PatElemT (LetDec rep)]], [WithAccInput rep],
    [(Param (LParamInfo rep), Param (LParamInfo rep))], Result)
forall a b c d. [(a, b, c, d)] -&gt; ([a], [b], [c], [d])
</span><span class="hs-identifier hs-var">unzip4</span></span><span> </span><span class="annot"><span class="annottext">([([PatElemT (LetDec rep)], WithAccInput rep,
   (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
 -&gt; ([[PatElemT (LetDec rep)]], [WithAccInput rep],
     [(Param (LParamInfo rep), Param (LParamInfo rep))], Result))
-&gt; ([Maybe
       ([PatElemT (LetDec rep)], WithAccInput rep,
        (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
    -&gt; [([PatElemT (LetDec rep)], WithAccInput rep,
         (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)])
-&gt; [Maybe
      ([PatElemT (LetDec rep)], WithAccInput rep,
       (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
-&gt; ([[PatElemT (LetDec rep)]], [WithAccInput rep],
    [(Param (LParamInfo rep), Param (LParamInfo rep))], Result)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Maybe
   ([PatElemT (LetDec rep)], WithAccInput rep,
    (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
-&gt; [([PatElemT (LetDec rep)], WithAccInput rep,
     (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM
   rep
   [Maybe
      ([PatElemT (LetDec rep)], WithAccInput rep,
       (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
 -&gt; RuleM
      rep
      ([[PatElemT (LetDec rep)]], [WithAccInput rep],
       [(Param (LParamInfo rep), Param (LParamInfo rep))], Result))
-&gt; ([([PatElemT (LetDec rep)], WithAccInput rep,
      (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
    -&gt; RuleM
         rep
         [Maybe
            ([PatElemT (LetDec rep)], WithAccInput rep,
             (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)])
-&gt; [([PatElemT (LetDec rep)], WithAccInput rep,
     (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
-&gt; RuleM
     rep
     ([[PatElemT (LetDec rep)]], [WithAccInput rep],
      [(Param (LParamInfo rep), Param (LParamInfo rep))], Result)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(([PatElemT (LetDec rep)], WithAccInput rep,
  (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)
 -&gt; RuleM
      rep
      (Maybe
         ([PatElemT (LetDec rep)], WithAccInput rep,
          (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)))
-&gt; [([PatElemT (LetDec rep)], WithAccInput rep,
     (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
-&gt; RuleM
     rep
     [Maybe
        ([PatElemT (LetDec rep)], WithAccInput rep,
         (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">([PatElemT (LetDec rep)], WithAccInput rep,
 (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)
-&gt; RuleM
     rep
     (Maybe
        ([PatElemT (LetDec rep)], WithAccInput rep,
         (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes))
forall {m :: * -&gt; *} {dec} {a} {c} {a} {dec}.
MonadBuilder m =&gt;
([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes)
-&gt; m (Maybe
        ([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes))
</span><a href="#local-6989586621684367375"><span class="hs-identifier hs-var">tryMoveAcc</span></a></span><span> </span><span class="annot"><span class="annottext">([([PatElemT (LetDec rep)], WithAccInput rep,
   (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
 -&gt; RuleM
      rep
      ([[PatElemT (LetDec rep)]], [WithAccInput rep],
       [(Param (LParamInfo rep), Param (LParamInfo rep))], Result))
-&gt; [([PatElemT (LetDec rep)], WithAccInput rep,
     (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
-&gt; RuleM
     rep
     ([[PatElemT (LetDec rep)]], [WithAccInput rep],
      [(Param (LParamInfo rep), Param (LParamInfo rep))], Result)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-313"></span><span>      </span><span class="annot"><span class="annottext">[[PatElemT (LetDec rep)]]
-&gt; [WithAccInput rep]
-&gt; [(Param (LParamInfo rep), Param (LParamInfo rep))]
-&gt; Result
-&gt; [([PatElemT (LetDec rep)], WithAccInput rep,
     (Param (LParamInfo rep), Param (LParamInfo rep)), SubExpRes)]
forall a b c d. [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [(a, b, c, d)]
</span><span class="hs-identifier hs-var">zip4</span></span><span>
</span><span id="line-314"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; [PatElemT (LetDec rep)] -&gt; [[PatElemT (LetDec rep)]]
forall a. [Int] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.Util.html#chunks"><span class="hs-identifier hs-var">chunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(WithAccInput rep -&gt; Int) -&gt; [WithAccInput rep] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">WithAccInput rep -&gt; Int
forall {t :: * -&gt; *} {a} {a} {c}. Foldable t =&gt; (a, t a, c) -&gt; Int
</span><a href="#local-6989586621684367373"><span class="hs-identifier hs-var">inputArrs</span></a></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684367390"><span class="hs-identifier hs-var">inputs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367381"><span class="hs-identifier hs-var">acc_pes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>        </span><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684367390"><span class="hs-identifier hs-var">inputs</span></a></span><span>
</span><span id="line-316"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
-&gt; [Param (LParamInfo rep)]
-&gt; [(Param (LParamInfo rep), Param (LParamInfo rep))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684367388"><span class="hs-identifier hs-var">cert_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684367387"><span class="hs-identifier hs-var">acc_params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>        </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367384"><span class="hs-identifier hs-var">acc_res</span></a></span><span>
</span><span id="line-318"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367372"><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684367372"><span class="hs-identifier hs-var">cert_params'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367371"><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684367371"><span class="hs-identifier hs-var">acc_params'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Param (LParamInfo rep), Param (LParamInfo rep))]
-&gt; ([Param (LParamInfo rep)], [Param (LParamInfo rep)])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Param (LParamInfo rep), Param (LParamInfo rep))]
</span><a href="#local-6989586621684367377"><span class="hs-identifier hs-var">params'</span></a></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span>  </span><span class="hs-comment">-- Look at non-accumulator results.</span><span>
</span><span id="line-321"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684367370"><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367370"><span class="hs-identifier hs-var">nonacc_pes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367369"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367369"><span class="hs-identifier hs-var">nonacc_res'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-322"></span><span>    </span><span class="annot"><span class="annottext">[(PatElemT (LetDec rep), SubExpRes)]
-&gt; ([PatElemT (LetDec rep)], Result)
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(PatElemT (LetDec rep), SubExpRes)]
 -&gt; ([PatElemT (LetDec rep)], Result))
-&gt; ([Maybe (PatElemT (LetDec rep), SubExpRes)]
    -&gt; [(PatElemT (LetDec rep), SubExpRes)])
-&gt; [Maybe (PatElemT (LetDec rep), SubExpRes)]
-&gt; ([PatElemT (LetDec rep)], Result)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (PatElemT (LetDec rep), SubExpRes)]
-&gt; [(PatElemT (LetDec rep), SubExpRes)]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">([Maybe (PatElemT (LetDec rep), SubExpRes)]
 -&gt; ([PatElemT (LetDec rep)], Result))
-&gt; RuleM rep [Maybe (PatElemT (LetDec rep), SubExpRes)]
-&gt; RuleM rep ([PatElemT (LetDec rep)], Result)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((PatElemT (LetDec rep), SubExpRes)
 -&gt; RuleM rep (Maybe (PatElemT (LetDec rep), SubExpRes)))
-&gt; [(PatElemT (LetDec rep), SubExpRes)]
-&gt; RuleM rep [Maybe (PatElemT (LetDec rep), SubExpRes)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (LetDec rep), SubExpRes)
-&gt; RuleM rep (Maybe (PatElemT (LetDec rep), SubExpRes))
</span><a href="#local-6989586621684367368"><span class="hs-identifier hs-var">tryMoveNonAcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
-&gt; Result -&gt; [(PatElemT (LetDec rep), SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367380"><span class="hs-identifier hs-var">nonacc_pes</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367383"><span class="hs-identifier hs-var">nonacc_res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; RuleM rep () -&gt; RuleM rep ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[PatElemT (LetDec rep)]] -&gt; [PatElemT (LetDec rep)]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[PatElemT (LetDec rep)]]
</span><a href="#local-6989586621684367379"><span class="hs-identifier hs-var">acc_pes'</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)] -&gt; [PatElemT (LetDec rep)] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367381"><span class="hs-identifier hs-var">acc_pes</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367370"><span class="hs-identifier hs-var">nonacc_pes'</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)] -&gt; [PatElemT (LetDec rep)] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367380"><span class="hs-identifier hs-var">nonacc_pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RuleM rep ()
forall rep a. RuleM rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#cannotSimplify"><span class="hs-identifier hs-var">cannotSimplify</span></a></span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span>  </span><span id="local-6989586621684367365"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367365"><span class="hs-identifier hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">[LParam (Rep (RuleM rep))]
-&gt; RuleM rep Result -&gt; RuleM rep (Lambda (Rep (RuleM rep)))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[LParam (Rep m)] -&gt; m Result -&gt; m (Lambda (Rep m))
</span><a href="Futhark.Construct.html#mkLambda"><span class="hs-identifier hs-var">mkLambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684367372"><span class="hs-identifier hs-var">cert_params'</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
-&gt; [Param (LParamInfo rep)] -&gt; [Param (LParamInfo rep)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684367371"><span class="hs-identifier hs-var">acc_params'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep Result -&gt; RuleM rep (Lambda (Rep (RuleM rep))))
-&gt; RuleM rep Result -&gt; RuleM rep (Lambda (Rep (RuleM rep)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-328"></span><span>      </span><span class="annot"><span class="annottext">Body (Rep (RuleM rep)) -&gt; RuleM rep Result
forall (m :: * -&gt; *). MonadBuilder m =&gt; Body (Rep m) -&gt; m Result
</span><a href="Futhark.Builder.Class.html#bodyBind"><span class="hs-identifier hs-var">bodyBind</span></a></span><span> </span><span class="annot"><span class="annottext">(Body (Rep (RuleM rep)) -&gt; RuleM rep Result)
-&gt; Body (Rep (RuleM rep)) -&gt; RuleM rep Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367389"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">bodyResult :: Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var">bodyResult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367376"><span class="hs-identifier hs-var">acc_res'</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367369"><span class="hs-identifier hs-var">nonacc_res'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span>  </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)] -&gt; Pat rep
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[PatElemT (LetDec rep)]] -&gt; [PatElemT (LetDec rep)]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[PatElemT (LetDec rep)]]
</span><a href="#local-6989586621684367379"><span class="hs-identifier hs-var">acc_pes'</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
-&gt; [PatElemT (LetDec rep)] -&gt; [PatElemT (LetDec rep)]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367370"><span class="hs-identifier hs-var">nonacc_pes'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep] -&gt; Lambda rep -&gt; ExpT rep
forall rep. [WithAccInput rep] -&gt; Lambda rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-var">WithAcc</span></a></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684367378"><span class="hs-identifier hs-var">inputs'</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367365"><span class="hs-identifier hs-var">lam'</span></a></span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-332"></span><span>    </span><span id="local-6989586621684367382"><span class="annot"><span class="annottext">num_nonaccs :: Int
</span><a href="#local-6989586621684367382"><span class="hs-identifier hs-var hs-var">num_nonaccs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367389"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684367390"><span class="hs-identifier hs-var">inputs</span></a></span><span>
</span><span id="line-333"></span><span>    </span><span id="local-6989586621684367373"><span class="annot"><span class="annottext">inputArrs :: (a, t a, c) -&gt; Int
</span><a href="#local-6989586621684367373"><span class="hs-identifier hs-var hs-var">inputArrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367360"><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621684367360"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t a -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621684367360"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span>    </span><span id="local-6989586621684367375"><span class="annot"><span class="annottext">tryMoveAcc :: ([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes)
-&gt; m (Maybe
        ([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes))
</span><a href="#local-6989586621684367375"><span class="hs-identifier hs-var hs-var">tryMoveAcc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367346"><span class="annot"><span class="annottext">[PatElemT dec]
</span><a href="#local-6989586621684367346"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367345"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684367345"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367344"><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684367344"><span class="hs-identifier hs-var">acc_p</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684367343"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367343"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684367342"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367342"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Param dec -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684367344"><span class="hs-identifier hs-var">acc_p</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367342"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-337"></span><span>        </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367343"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-338"></span><span>        </span><span class="annot"><span class="annottext">[(PatElemT dec, VName)] -&gt; ((PatElemT dec, VName) -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT dec] -&gt; [VName] -&gt; [(PatElemT dec, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT dec]
</span><a href="#local-6989586621684367346"><span class="hs-identifier hs-var">pes</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684367345"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT dec, VName) -&gt; m ()) -&gt; m ())
-&gt; ((PatElemT dec, VName) -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684367340"><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684367340"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367339"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367339"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-339"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep m) -&gt; m ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT dec -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684367340"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m ()) -&gt; Exp (Rep m) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367339"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-340"></span><span>        </span><span class="annot"><span class="annottext">Maybe ([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes)
-&gt; m (Maybe
        ([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe ([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-341"></span><span>    </span><span class="annot"><a href="#local-6989586621684367375"><span class="hs-identifier hs-var">tryMoveAcc</span></a></span><span> </span><span id="local-6989586621684367338"><span class="annot"><span class="annottext">([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes)
</span><a href="#local-6989586621684367338"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-342"></span><span>      </span><span class="annot"><span class="annottext">Maybe ([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes)
-&gt; m (Maybe
        ([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe ([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes)
 -&gt; m (Maybe
         ([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes)))
-&gt; Maybe
     ([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes)
-&gt; m (Maybe
        ([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes)
-&gt; Maybe
     ([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">([PatElemT dec], (a, [VName], c), (a, Param dec), SubExpRes)
</span><a href="#local-6989586621684367338"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span>    </span><span id="local-6989586621684367368"><span class="annot"><span class="annottext">tryMoveNonAcc :: (PatElemT (LetDec rep), SubExpRes)
-&gt; RuleM rep (Maybe (PatElemT (LetDec rep), SubExpRes))
</span><a href="#local-6989586621684367368"><span class="hs-identifier hs-var hs-var">tryMoveNonAcc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367337"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367337"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684367336"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367336"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684367335"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367335"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-345"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367335"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TopDown rep -&gt; Bool
forall rep. VName -&gt; SymbolTable rep -&gt; Bool
</span><a href="Futhark.Analysis.SymbolTable.html#elem"><span class="hs-operator hs-var">`ST.elem`</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684367393"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-346"></span><span>        </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367336"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-347"></span><span>        </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367337"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367335"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-348"></span><span>        </span><span class="annot"><span class="annottext">Maybe (PatElemT (LetDec rep), SubExpRes)
-&gt; RuleM rep (Maybe (PatElemT (LetDec rep), SubExpRes))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe (PatElemT (LetDec rep), SubExpRes)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-349"></span><span>    </span><span class="annot"><a href="#local-6989586621684367368"><span class="hs-identifier hs-var">tryMoveNonAcc</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367333"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367333"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684367332"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367332"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684367331"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684367331"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-350"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684367332"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-351"></span><span>        </span><span class="annot"><span class="annottext">[VName] -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367333"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-var">Constant</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684367331"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-352"></span><span>        </span><span class="annot"><span class="annottext">Maybe (PatElemT (LetDec rep), SubExpRes)
-&gt; RuleM rep (Maybe (PatElemT (LetDec rep), SubExpRes))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe (PatElemT (LetDec rep), SubExpRes)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-353"></span><span>    </span><span class="annot"><a href="#local-6989586621684367368"><span class="hs-identifier hs-var">tryMoveNonAcc</span></a></span><span> </span><span id="local-6989586621684367330"><span class="annot"><span class="annottext">(PatElemT (LetDec rep), SubExpRes)
</span><a href="#local-6989586621684367330"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-354"></span><span>      </span><span class="annot"><span class="annottext">Maybe (PatElemT (LetDec rep), SubExpRes)
-&gt; RuleM rep (Maybe (PatElemT (LetDec rep), SubExpRes))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (PatElemT (LetDec rep), SubExpRes)
 -&gt; RuleM rep (Maybe (PatElemT (LetDec rep), SubExpRes)))
-&gt; Maybe (PatElemT (LetDec rep), SubExpRes)
-&gt; RuleM rep (Maybe (PatElemT (LetDec rep), SubExpRes))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (LetDec rep), SubExpRes)
-&gt; Maybe (PatElemT (LetDec rep), SubExpRes)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (LetDec rep), SubExpRes)
</span><a href="#local-6989586621684367330"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-355"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#withAccTopDown"><span class="hs-identifier hs-var">withAccTopDown</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rule rep
forall rep. Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span id="local-6989586621684368083"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#elimUpdates"><span class="hs-identifier hs-type">elimUpdates</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368083"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Traversals.html#TraverseOpStms"><span class="hs-identifier hs-type">TraverseOpStms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368083"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368083"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368083"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-358"></span><span id="elimUpdates"><span class="annot"><span class="annottext">elimUpdates :: forall rep.
(ASTRep rep, TraverseOpStms rep) =&gt;
[VName] -&gt; Body rep -&gt; (Body rep, [VName])
</span><a href="Futhark.Optimise.Simplify.Rules.html#elimUpdates"><span class="hs-identifier hs-var hs-var">elimUpdates</span></a></span></span><span> </span><span id="local-6989586621684367293"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684367293"><span class="hs-identifier hs-var">get_rid_of</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(State [VName] (BodyT rep) -&gt; [VName] -&gt; (BodyT rep, [VName]))
-&gt; [VName] -&gt; State [VName] (BodyT rep) -&gt; (BodyT rep, [VName])
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">State [VName] (BodyT rep) -&gt; [VName] -&gt; (BodyT rep, [VName])
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="annot"><span class="annottext">[VName]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(State [VName] (BodyT rep) -&gt; (BodyT rep, [VName]))
-&gt; (BodyT rep -&gt; State [VName] (BodyT rep))
-&gt; BodyT rep
-&gt; (BodyT rep, [VName])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; State [VName] (BodyT rep)
</span><a href="#local-6989586621684367290"><span class="hs-identifier hs-var">onBody</span></a></span><span>
</span><span id="line-359"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-360"></span><span>    </span><span id="local-6989586621684367290"><span class="annot"><span class="annottext">onBody :: BodyT rep -&gt; State [VName] (BodyT rep)
</span><a href="#local-6989586621684367290"><span class="hs-identifier hs-var hs-var">onBody</span></a></span></span><span> </span><span id="local-6989586621684367289"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367289"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-361"></span><span>      </span><span id="local-6989586621684367288"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684367288"><span class="hs-identifier hs-var">stms'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; StateT [VName] Identity (Stms rep)
</span><a href="#local-6989586621684367287"><span class="hs-identifier hs-var">onStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms rep -&gt; StateT [VName] Identity (Stms rep))
-&gt; Stms rep -&gt; StateT [VName] Identity (Stms rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Stms rep
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367289"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-362"></span><span>      </span><span class="annot"><span class="annottext">BodyT rep -&gt; State [VName] (BodyT rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367289"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">bodyStms :: Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var">bodyStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684367288"><span class="hs-identifier hs-var">stms'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-363"></span><span>    </span><span id="local-6989586621684367287"><span class="annot"><span class="annottext">onStms :: Stms rep -&gt; StateT [VName] Identity (Stms rep)
</span><a href="#local-6989586621684367287"><span class="hs-identifier hs-var hs-var">onStms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; StateT [VName] Identity (Stm rep))
-&gt; Stms rep -&gt; StateT [VName] Identity (Stms rep)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; StateT [VName] Identity (Stm rep)
</span><a href="#local-6989586621684367285"><span class="hs-identifier hs-var">onStm</span></a></span><span>
</span><span id="line-364"></span><span>    </span><span id="local-6989586621684367285"><span class="annot"><span class="annottext">onStm :: Stm rep -&gt; StateT [VName] Identity (Stm rep)
</span><a href="#local-6989586621684367285"><span class="hs-identifier hs-var hs-var">onStm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684367284"><span class="annot"><span class="annottext">pat :: Pat rep
</span><a href="#local-6989586621684367284"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-type">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684367282"><span class="annot"><span class="annottext">LetDec rep
</span><a href="#local-6989586621684367282"><span class="hs-identifier hs-var">dec</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684367281"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684367281"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#UpdateAcc"><span class="hs-identifier hs-type">UpdateAcc</span></a></span><span> </span><span id="local-6989586621684367279"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367279"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-365"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span id="local-6989586621684367277"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367277"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LetDec rep -&gt; Type
forall t. Typed t =&gt; t -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">LetDec rep
</span><a href="#local-6989586621684367282"><span class="hs-identifier hs-var">dec</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-366"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367277"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684367293"><span class="hs-identifier hs-var">get_rid_of</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-367"></span><span>        </span><span class="annot"><span class="annottext">([VName] -&gt; [VName]) -&gt; StateT [VName] Identity ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. Ord a =&gt; a -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">insert</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367277"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-368"></span><span>        </span><span class="annot"><span class="annottext">Stm rep -&gt; StateT [VName] Identity (Stm rep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; StateT [VName] Identity (Stm rep))
-&gt; Stm rep -&gt; StateT [VName] Identity (Stm rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; StmAux (ExpDec rep) -&gt; ExpT rep -&gt; Stm rep
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367284"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684367281"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Stm rep) -&gt; ExpT rep -&gt; Stm rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT rep) -&gt; BasicOp -&gt; ExpT rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684367279"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-369"></span><span>    </span><span class="annot"><a href="#local-6989586621684367285"><span class="hs-identifier hs-var">onStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684367273"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367273"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684367272"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684367272"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684367271"><span class="annot"><span class="annottext">ExpT rep
</span><a href="#local-6989586621684367271"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; StmAux (ExpDec rep) -&gt; ExpT rep -&gt; Stm rep
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367273"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684367272"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Stm rep)
-&gt; StateT [VName] Identity (ExpT rep)
-&gt; StateT [VName] Identity (Stm rep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ExpT rep -&gt; StateT [VName] Identity (ExpT rep)
</span><a href="#local-6989586621684367270"><span class="hs-identifier hs-var">onExp</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT rep
</span><a href="#local-6989586621684367271"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-370"></span><span>    </span><span id="local-6989586621684367270"><span class="annot"><span class="annottext">onExp :: ExpT rep -&gt; StateT [VName] Identity (ExpT rep)
</span><a href="#local-6989586621684367270"><span class="hs-identifier hs-var hs-var">onExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Mapper rep rep (StateT [VName] Identity)
-&gt; ExpT rep -&gt; StateT [VName] Identity (ExpT rep)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
Mapper frep trep m -&gt; Exp frep -&gt; m (Exp trep)
</span><a href="Futhark.IR.Traversals.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a></span><span> </span><span class="annot"><span class="annottext">Mapper rep rep (StateT [VName] Identity)
</span><a href="#local-6989586621684367268"><span class="hs-identifier hs-var">mapper</span></a></span><span>
</span><span id="line-371"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-372"></span><span>        </span><span id="local-6989586621684367268"><span class="annot"><span class="annottext">mapper :: Mapper rep rep (StateT [VName] Identity)
</span><a href="#local-6989586621684367268"><span class="hs-identifier hs-var hs-var">mapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-373"></span><span>          </span><span class="annot"><span class="annottext">Mapper rep rep (StateT [VName] Identity)
forall (m :: * -&gt; *) rep. Monad m =&gt; Mapper rep rep m
</span><a href="Futhark.IR.Traversals.html#identityMapper"><span class="hs-identifier hs-var">identityMapper</span></a></span><span>
</span><span id="line-374"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnOp :: Op rep -&gt; StateT [VName] Identity (Op rep)
</span><a href="Futhark.IR.Traversals.html#mapOnOp"><span class="hs-identifier hs-var">mapOnOp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OpStmsTraverser (StateT [VName] Identity) (Op rep) rep
forall rep (m :: * -&gt; *).
(TraverseOpStms rep, Monad m) =&gt;
OpStmsTraverser m (Op rep) rep
</span><a href="Futhark.IR.Traversals.html#traverseOpStms"><span class="hs-identifier hs-var">traverseOpStms</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Scope rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684367264"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684367264"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; StateT [VName] Identity (Stms rep)
</span><a href="#local-6989586621684367287"><span class="hs-identifier hs-var">onStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684367264"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-375"></span><span>              </span><span class="annot"><span class="annottext">mapOnBody :: Scope rep -&gt; BodyT rep -&gt; State [VName] (BodyT rep)
</span><a href="Futhark.IR.Traversals.html#mapOnBody"><span class="hs-identifier hs-var">mapOnBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Scope rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684367262"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367262"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; State [VName] (BodyT rep)
</span><a href="#local-6989586621684367290"><span class="hs-identifier hs-var">onBody</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367262"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-376"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span id="local-6989586621684368372"><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#withAccBottomUp"><span class="hs-identifier hs-type">withAccBottomUp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Traversals.html#TraverseOpStms"><span class="hs-identifier hs-type">TraverseOpStms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368372"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368372"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#BottomUpRuleGeneric"><span class="hs-identifier hs-type">BottomUpRuleGeneric</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368372"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-379"></span><span class="hs-comment">-- Eliminate dead results.  See Note [Dead Code Elimination for WithAcc]</span><span>
</span><span id="line-380"></span><span id="withAccBottomUp"><span class="annot"><span class="annottext">withAccBottomUp :: forall rep.
(TraverseOpStms rep, BuilderOps rep) =&gt;
BottomUpRuleGeneric rep
</span><a href="Futhark.Optimise.Simplify.Rules.html#withAccBottomUp"><span class="hs-identifier hs-var hs-var">withAccBottomUp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367226"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684367226"><span class="hs-identifier hs-var">utable</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684367225"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367225"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684367224"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684367224"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-type">WithAcc</span></a></span><span> </span><span id="local-6989586621684367223"><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684367223"><span class="hs-identifier hs-var">inputs</span></a></span></span><span> </span><span id="local-6989586621684367222"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367222"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-381"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#used"><span class="hs-operator hs-var">`UT.used`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684367226"><span class="hs-identifier hs-var">utable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Bool) -&gt; [VName] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367225"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleM rep () -&gt; Rule rep
forall rep. RuleM rep () -&gt; Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Simplify"><span class="hs-identifier hs-var">Simplify</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; Rule rep) -&gt; RuleM rep () -&gt; Rule rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-382"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367221"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367221"><span class="hs-identifier hs-var">acc_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367220"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367220"><span class="hs-identifier hs-var">nonacc_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-383"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; (Result, Result)
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Futhark.Util.html#splitFromEnd"><span class="hs-identifier hs-var">splitFromEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684367219"><span class="hs-identifier hs-var">num_nonaccs</span></a></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; (Result, Result)) -&gt; Result -&gt; (Result, Result)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT rep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT rep -&gt; Result) -&gt; BodyT rep -&gt; Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367222"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-384"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684367218"><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367218"><span class="hs-identifier hs-var">acc_pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367217"><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367217"><span class="hs-identifier hs-var">nonacc_pes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-385"></span><span>          </span><span class="annot"><span class="annottext">Int
-&gt; [PatElemT (LetDec rep)]
-&gt; ([PatElemT (LetDec rep)], [PatElemT (LetDec rep)])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Futhark.Util.html#splitFromEnd"><span class="hs-identifier hs-var">splitFromEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684367219"><span class="hs-identifier hs-var">num_nonaccs</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT (LetDec rep)]
 -&gt; ([PatElemT (LetDec rep)], [PatElemT (LetDec rep)]))
-&gt; [PatElemT (LetDec rep)]
-&gt; ([PatElemT (LetDec rep)], [PatElemT (LetDec rep)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; [PatElemT (LetDec rep)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684367225"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-386"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684367216"><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684367216"><span class="hs-identifier hs-var">cert_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367215"><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684367215"><span class="hs-identifier hs-var">acc_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-387"></span><span>          </span><span class="annot"><span class="annottext">Int
-&gt; [Param (LParamInfo rep)]
-&gt; ([Param (LParamInfo rep)], [Param (LParamInfo rep)])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[WithAccInput rep] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684367223"><span class="hs-identifier hs-var">inputs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param (LParamInfo rep)]
 -&gt; ([Param (LParamInfo rep)], [Param (LParamInfo rep)]))
-&gt; [Param (LParamInfo rep)]
-&gt; ([Param (LParamInfo rep)], [Param (LParamInfo rep)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [Param (LParamInfo rep)]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367222"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span>    </span><span class="hs-comment">-- Eliminate unused accumulator results</span><span>
</span><span id="line-390"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684367214"><span class="annot"><span class="annottext">get_rid_of :: [VName]
</span><a href="#local-6989586621684367214"><span class="hs-identifier hs-var hs-var">get_rid_of</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-391"></span><span>          </span><span class="annot"><span class="annottext">(([PatElemT (LetDec rep)], VName) -&gt; VName)
-&gt; [([PatElemT (LetDec rep)], VName)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">([PatElemT (LetDec rep)], VName) -&gt; VName
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([([PatElemT (LetDec rep)], VName)] -&gt; [VName])
-&gt; ([([PatElemT (LetDec rep)], VName)]
    -&gt; [([PatElemT (LetDec rep)], VName)])
-&gt; [([PatElemT (LetDec rep)], VName)]
-&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(([PatElemT (LetDec rep)], VName) -&gt; Bool)
-&gt; [([PatElemT (LetDec rep)], VName)]
-&gt; [([PatElemT (LetDec rep)], VName)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">([PatElemT (LetDec rep)], VName) -&gt; Bool
</span><a href="#local-6989586621684367213"><span class="hs-identifier hs-var">getRidOf</span></a></span><span> </span><span class="annot"><span class="annottext">([([PatElemT (LetDec rep)], VName)] -&gt; [VName])
-&gt; [([PatElemT (LetDec rep)], VName)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-392"></span><span>            </span><span class="annot"><span class="annottext">[[PatElemT (LetDec rep)]]
-&gt; [VName] -&gt; [([PatElemT (LetDec rep)], VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span>
</span><span id="line-393"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Int] -&gt; [PatElemT (LetDec rep)] -&gt; [[PatElemT (LetDec rep)]]
forall a. [Int] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.Util.html#chunks"><span class="hs-identifier hs-var">chunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(WithAccInput rep -&gt; Int) -&gt; [WithAccInput rep] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">WithAccInput rep -&gt; Int
forall {t :: * -&gt; *} {a} {a} {c}. Foldable t =&gt; (a, t a, c) -&gt; Int
</span><a href="#local-6989586621684367212"><span class="hs-identifier hs-var">inputArrs</span></a></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684367223"><span class="hs-identifier hs-var">inputs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367218"><span class="hs-identifier hs-var">acc_pes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>              </span><span class="annot"><span class="annottext">([VName] -&gt; [([PatElemT (LetDec rep)], VName)])
-&gt; [VName] -&gt; [([PatElemT (LetDec rep)], VName)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param (LParamInfo rep) -&gt; VName)
-&gt; [Param (LParamInfo rep)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (LParamInfo rep) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684367216"><span class="hs-identifier hs-var">cert_params</span></a></span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span>    </span><span class="hs-comment">-- Eliminate unused non-accumulator results</span><span>
</span><span id="line-397"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367211"><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367211"><span class="hs-identifier hs-var">nonacc_pes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367210"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367210"><span class="hs-identifier hs-var">nonacc_res'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-398"></span><span>          </span><span class="annot"><span class="annottext">[(PatElemT (LetDec rep), SubExpRes)]
-&gt; ([PatElemT (LetDec rep)], Result)
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(PatElemT (LetDec rep), SubExpRes)]
 -&gt; ([PatElemT (LetDec rep)], Result))
-&gt; [(PatElemT (LetDec rep), SubExpRes)]
-&gt; ([PatElemT (LetDec rep)], Result)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((PatElemT (LetDec rep), SubExpRes) -&gt; Bool)
-&gt; [(PatElemT (LetDec rep), SubExpRes)]
-&gt; [(PatElemT (LetDec rep), SubExpRes)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (LetDec rep), SubExpRes) -&gt; Bool
</span><a href="#local-6989586621684367209"><span class="hs-identifier hs-var">keepNonAccRes</span></a></span><span> </span><span class="annot"><span class="annottext">([(PatElemT (LetDec rep), SubExpRes)]
 -&gt; [(PatElemT (LetDec rep), SubExpRes)])
-&gt; [(PatElemT (LetDec rep), SubExpRes)]
-&gt; [(PatElemT (LetDec rep), SubExpRes)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
-&gt; Result -&gt; [(PatElemT (LetDec rep), SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367217"><span class="hs-identifier hs-var">nonacc_pes</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367220"><span class="hs-identifier hs-var">nonacc_res</span></a></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; RuleM rep () -&gt; RuleM rep ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684367214"><span class="hs-identifier hs-var">get_rid_of</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367211"><span class="hs-identifier hs-var">nonacc_pes'</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)] -&gt; [PatElemT (LetDec rep)] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367217"><span class="hs-identifier hs-var">nonacc_pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RuleM rep ()
forall rep a. RuleM rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#cannotSimplify"><span class="hs-identifier hs-var">cannotSimplify</span></a></span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367208"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684367208"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367207"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684367207"><span class="hs-identifier hs-var">eliminated</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; BodyT rep -&gt; (BodyT rep, [VName])
forall rep.
(ASTRep rep, TraverseOpStms rep) =&gt;
[VName] -&gt; Body rep -&gt; (Body rep, [VName])
</span><a href="Futhark.Optimise.Simplify.Rules.html#elimUpdates"><span class="hs-identifier hs-var">elimUpdates</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684367214"><span class="hs-identifier hs-var">get_rid_of</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT rep -&gt; (BodyT rep, [VName]))
-&gt; BodyT rep -&gt; (BodyT rep, [VName])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367222"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; RuleM rep () -&gt; RuleM rep ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684367207"><span class="hs-identifier hs-var">eliminated</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367211"><span class="hs-identifier hs-var">nonacc_pes'</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)] -&gt; [PatElemT (LetDec rep)] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367217"><span class="hs-identifier hs-var">nonacc_pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RuleM rep ()
forall rep a. RuleM rep a
</span><a href="Futhark.Optimise.Simplify.Rule.html#cannotSimplify"><span class="hs-identifier hs-var">cannotSimplify</span></a></span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684367206"><span class="annot"><span class="annottext">pes' :: [PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367206"><span class="hs-identifier hs-var hs-var">pes'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367218"><span class="hs-identifier hs-var">acc_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
-&gt; [PatElemT (LetDec rep)] -&gt; [PatElemT (LetDec rep)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367211"><span class="hs-identifier hs-var">nonacc_pes'</span></a></span><span>
</span><span id="line-407"></span><span>
</span><span id="line-408"></span><span>    </span><span id="local-6989586621684367205"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367205"><span class="hs-identifier hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[LParam (Rep (RuleM rep))]
-&gt; RuleM rep Result -&gt; RuleM rep (Lambda (Rep (RuleM rep)))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[LParam (Rep m)] -&gt; m Result -&gt; m (Lambda (Rep m))
</span><a href="Futhark.Construct.html#mkLambda"><span class="hs-identifier hs-var">mkLambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684367216"><span class="hs-identifier hs-var">cert_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
-&gt; [Param (LParamInfo rep)] -&gt; [Param (LParamInfo rep)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684367215"><span class="hs-identifier hs-var">acc_params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RuleM rep Result -&gt; RuleM rep (Lambda (Rep (RuleM rep))))
-&gt; RuleM rep Result -&gt; RuleM rep (Lambda (Rep (RuleM rep)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-409"></span><span>      </span><span class="annot"><span class="annottext">RuleM rep Result -&gt; RuleM rep ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(RuleM rep Result -&gt; RuleM rep ())
-&gt; RuleM rep Result -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body (Rep (RuleM rep)) -&gt; RuleM rep Result
forall (m :: * -&gt; *). MonadBuilder m =&gt; Body (Rep m) -&gt; m Result
</span><a href="Futhark.Builder.Class.html#bodyBind"><span class="hs-identifier hs-var">bodyBind</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
Body (Rep (RuleM rep))
</span><a href="#local-6989586621684367208"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-410"></span><span>      </span><span class="annot"><span class="annottext">Result -&gt; RuleM rep Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; RuleM rep Result) -&gt; Result -&gt; RuleM rep Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367221"><span class="hs-identifier hs-var">acc_res</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684367210"><span class="hs-identifier hs-var">nonacc_res'</span></a></span><span>
</span><span id="line-411"></span><span>
</span><span id="line-412"></span><span>    </span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; RuleM rep () -&gt; RuleM rep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684367224"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(RuleM rep () -&gt; RuleM rep ()) -&gt; RuleM rep () -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (RuleM rep)) -&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)] -&gt; Pat rep
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367206"><span class="hs-identifier hs-var">pes'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (RuleM rep)) -&gt; RuleM rep ())
-&gt; Exp (Rep (RuleM rep)) -&gt; RuleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep] -&gt; Lambda rep -&gt; ExpT rep
forall rep. [WithAccInput rep] -&gt; Lambda rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-var">WithAcc</span></a></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684367223"><span class="hs-identifier hs-var">inputs</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367205"><span class="hs-identifier hs-var">lam'</span></a></span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-414"></span><span>    </span><span id="local-6989586621684367219"><span class="annot"><span class="annottext">num_nonaccs :: Int
</span><a href="#local-6989586621684367219"><span class="hs-identifier hs-var hs-var">num_nonaccs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684367222"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684367223"><span class="hs-identifier hs-var">inputs</span></a></span><span>
</span><span id="line-415"></span><span>    </span><span id="local-6989586621684367212"><span class="annot"><span class="annottext">inputArrs :: (a, t a, c) -&gt; Int
</span><a href="#local-6989586621684367212"><span class="hs-identifier hs-var hs-var">inputArrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684367201"><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621684367201"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t a -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621684367201"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-416"></span><span>    </span><span id="local-6989586621684367213"><span class="annot"><span class="annottext">getRidOf :: ([PatElemT (LetDec rep)], VName) -&gt; Bool
</span><a href="#local-6989586621684367213"><span class="hs-identifier hs-var hs-var">getRidOf</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367200"><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367200"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (LetDec rep) -&gt; Bool) -&gt; [PatElemT (LetDec rep)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#used"><span class="hs-operator hs-var">`UT.used`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684367226"><span class="hs-identifier hs-var">utable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; (PatElemT (LetDec rep) -&gt; VName)
-&gt; PatElemT (LetDec rep)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)]
</span><a href="#local-6989586621684367200"><span class="hs-identifier hs-var">pes</span></a></span><span>
</span><span id="line-417"></span><span>    </span><span id="local-6989586621684367209"><span class="annot"><span class="annottext">keepNonAccRes :: (PatElemT (LetDec rep), SubExpRes) -&gt; Bool
</span><a href="#local-6989586621684367209"><span class="hs-identifier hs-var hs-var">keepNonAccRes</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684367199"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367199"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684367199"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#used"><span class="hs-operator hs-var">`UT.used`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684367226"><span class="hs-identifier hs-var">utable</span></a></span><span>
</span><span id="line-418"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#withAccBottomUp"><span class="hs-identifier hs-var">withAccBottomUp</span></a></span><span> </span><span class="annot"><span class="annottext">(SymbolTable rep, UsageTable)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Rule rep
forall rep. Rule rep
</span><a href="Futhark.Optimise.Simplify.Rule.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span class="hs-comment">-- Some helper functions</span><span>
</span><span id="line-421"></span><span>
</span><span id="line-422"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#isCt1"><span class="hs-identifier hs-type">isCt1</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-423"></span><span id="isCt1"><span class="annot"><span class="annottext">isCt1 :: SubExp -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Rules.html#isCt1"><span class="hs-identifier hs-var hs-var">isCt1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684367198"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684367198"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; Bool
</span><a href="Futhark.IR.Primitive.html#oneIsh"><span class="hs-identifier hs-var">oneIsh</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684367198"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-424"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#isCt1"><span class="hs-identifier hs-var">isCt1</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#isCt0"><span class="hs-identifier hs-type">isCt0</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-427"></span><span id="isCt0"><span class="annot"><span class="annottext">isCt0 :: SubExp -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Rules.html#isCt0"><span class="hs-identifier hs-var hs-var">isCt0</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684367196"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684367196"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; Bool
</span><a href="Futhark.IR.Primitive.html#zeroIsh"><span class="hs-identifier hs-var">zeroIsh</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684367196"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-428"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Rules.html#isCt0"><span class="hs-identifier hs-var">isCt0</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-429"></span><span>
</span><span id="line-430"></span><span class="hs-comment">-- Note [Dead Code Elimination for WithAcc]</span><span>
</span><span id="line-431"></span><span class="hs-comment">--</span><span>
</span><span id="line-432"></span><span class="hs-comment">-- Our static semantics for accumulators are basically those of linear</span><span>
</span><span id="line-433"></span><span class="hs-comment">-- types.  This makes dead code elimination somewhat tricky.  First,</span><span>
</span><span id="line-434"></span><span class="hs-comment">-- what we consider dead code is when we have a WithAcc where at least</span><span>
</span><span id="line-435"></span><span class="hs-comment">-- one of the array results (that internally correspond to an</span><span>
</span><span id="line-436"></span><span class="hs-comment">-- accumulator) are unused.  E.g</span><span>
</span><span id="line-437"></span><span class="hs-comment">--</span><span>
</span><span id="line-438"></span><span class="hs-comment">-- let {X',Y'} =</span><span>
</span><span id="line-439"></span><span class="hs-comment">--   with_acc {X, Y} (\X_p Y_p X_acc Y_acc -&gt; ... {X_acc', Y_acc'})</span><span>
</span><span id="line-440"></span><span class="hs-comment">--</span><span>
</span><span id="line-441"></span><span class="hs-comment">-- where X' is not used later.  Note that Y' is still used later.  If</span><span>
</span><span id="line-442"></span><span class="hs-comment">-- none of the results of the WithAcc are used, then the Stm as a</span><span>
</span><span id="line-443"></span><span class="hs-comment">-- whole is dead and can be removed.  That's the trivial case, done</span><span>
</span><span id="line-444"></span><span class="hs-comment">-- implicitly by the simplifier.  The interesting case is exactly when</span><span>
</span><span id="line-445"></span><span class="hs-comment">-- some of the results are unused.  How do we get rid of them?</span><span>
</span><span id="line-446"></span><span class="hs-comment">--</span><span>
</span><span id="line-447"></span><span class="hs-comment">-- Naively, we might just remove them:</span><span>
</span><span id="line-448"></span><span class="hs-comment">--</span><span>
</span><span id="line-449"></span><span class="hs-comment">-- let Y' =</span><span>
</span><span id="line-450"></span><span class="hs-comment">--   with_acc Y (\Y_p Y_acc -&gt; ... Y_acc')</span><span>
</span><span id="line-451"></span><span class="hs-comment">--</span><span>
</span><span id="line-452"></span><span class="hs-comment">-- This is safe *only* if X_acc is used *only* in the result (i.e. an</span><span>
</span><span id="line-453"></span><span class="hs-comment">-- &quot;identity&quot; WithAcc).  Otherwise we end up with references to X_acc,</span><span>
</span><span id="line-454"></span><span class="hs-comment">-- which no longer exists.  This simple case is actually handled in</span><span>
</span><span id="line-455"></span><span class="hs-comment">-- the withAccTopDown rule, and is easy enough.</span><span>
</span><span id="line-456"></span><span class="hs-comment">--</span><span>
</span><span id="line-457"></span><span class="hs-comment">-- What we actually do when we decide to eliminate X_acc is that we</span><span>
</span><span id="line-458"></span><span class="hs-comment">-- inspect the body of the WithAcc and eliminate all UpdateAcc</span><span>
</span><span id="line-459"></span><span class="hs-comment">-- operations that refer to the same accumulator as X_acc (identified</span><span>
</span><span id="line-460"></span><span class="hs-comment">-- by the X_p token).  I.e. we turn every</span><span>
</span><span id="line-461"></span><span class="hs-comment">--</span><span>
</span><span id="line-462"></span><span class="hs-comment">-- let B = update_acc(A, ...)</span><span>
</span><span id="line-463"></span><span class="hs-comment">--</span><span>
</span><span id="line-464"></span><span class="hs-comment">-- where 'A' is ultimately decided from X_acc into</span><span>
</span><span id="line-465"></span><span class="hs-comment">--</span><span>
</span><span id="line-466"></span><span class="hs-comment">-- let B = A</span><span>
</span><span id="line-467"></span><span class="hs-comment">--</span><span>
</span><span id="line-468"></span><span class="hs-comment">-- That's it!  We then let ordinary dead code elimination eventually</span><span>
</span><span id="line-469"></span><span class="hs-comment">-- simplify the body enough that we have an &quot;identity&quot; WithAcc.  There</span><span>
</span><span id="line-470"></span><span class="hs-comment">-- is no _guarantee_ that this will happen, but our general dead code</span><span>
</span><span id="line-471"></span><span class="hs-comment">-- elimination tends to be pretty good.</span><span>
</span><span id="line-472"></span></pre></body></html>