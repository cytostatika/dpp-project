<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-comment">-- | Code generation for segmented and non-segmented scans.  Uses a</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- fast single-pass algorithm, but which only works on NVIDIA GPUs and</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- with some constraints on the operator.  We use this when we can.</span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#compileSegScan"><span class="hs-identifier">compileSegScan</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">zip4</span></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html"><span class="hs-identifier">Futhark.CodeGen.ImpCode.GPU</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Imp</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.GPU.Base</span></a></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html"><span class="hs-identifier">Futhark.IR.GPUMem</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html"><span class="hs-identifier">Futhark.IR.Mem.IxFun</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IxFun</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html"><span class="hs-identifier">Futhark.Transform.Rename</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#takeLast"><span class="hs-identifier">takeLast</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html"><span class="hs-identifier">Futhark.Util.IntegralExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier">IntegralExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.IntegralExp.html#mod"><span class="hs-identifier">mod</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-identifier">rem</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-identifier">divUp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-identifier">quot</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">mod</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">quot</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">rem</span></span><span class="hs-special">)</span><span>
</span><span id="line-21"></span><span>
</span><span id="line-22"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#xParams"><span class="hs-identifier hs-type">xParams</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#yParams"><span class="hs-identifier hs-type">yParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-23"></span><span id="xParams"><span class="annot"><span class="annottext">xParams :: SegBinOp GPUMem -&gt; [LParam GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#xParams"><span class="hs-identifier hs-var hs-var">xParams</span></a></span></span><span> </span><span id="local-6989586621684540640"><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540640"><span class="hs-identifier hs-var">scan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-24"></span><span>  </span><span class="annot"><span class="annottext">Int
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540640"><span class="hs-identifier hs-var">scan</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; LambdaT GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540640"><span class="hs-identifier hs-var">scan</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span id="yParams"><span class="annot"><span class="annottext">yParams :: SegBinOp GPUMem -&gt; [LParam GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#yParams"><span class="hs-identifier hs-var hs-var">yParams</span></a></span></span><span> </span><span id="local-6989586621684540634"><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540634"><span class="hs-identifier hs-var">scan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-26"></span><span>  </span><span class="annot"><span class="annottext">Int
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540634"><span class="hs-identifier hs-var">scan</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; LambdaT GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540634"><span class="hs-identifier hs-var">scan</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>
</span><span id="line-28"></span><span id="local-6989586621684541525"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#alignTo"><span class="hs-identifier hs-type">alignTo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684541525"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684541525"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684541525"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684541525"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-29"></span><span id="alignTo"><span class="annot"><span class="annottext">alignTo :: forall a. IntegralExp a =&gt; a -&gt; a -&gt; a
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#alignTo"><span class="hs-identifier hs-var hs-var">alignTo</span></a></span></span><span> </span><span id="local-6989586621684540626"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684540626"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684540625"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684540625"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684540626"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. IntegralExp a =&gt; a -&gt; a -&gt; a
</span><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-operator hs-var">`divUp`</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684540625"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684540625"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#createLocalArrays"><span class="hs-identifier hs-type">createLocalArrays</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-32"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#GroupSize"><span class="hs-identifier hs-type">GroupSize</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-33"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-35"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span id="createLocalArrays"><span class="annot"><span class="annottext">createLocalArrays :: Count GroupSize SubExp
-&gt; SubExp
-&gt; [PrimType]
-&gt; InKernelGen (VName, [VName], [VName], VName, [VName])
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#createLocalArrays"><span class="hs-identifier hs-var hs-var">createLocalArrays</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span id="local-6989586621684540621"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540621"><span class="hs-identifier hs-var">groupSize</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684540620"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540620"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621684540619"><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540619"><span class="hs-identifier hs-var">types</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540618"><span class="annot"><span class="annottext">groupSizeE :: TPrimExp Int64 VName
</span><a href="#local-6989586621684540618"><span class="hs-identifier hs-var hs-var">groupSizeE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540621"><span class="hs-identifier hs-var">groupSize</span></a></span><span>
</span><span id="line-38"></span><span>      </span><span id="local-6989586621684540616"><span class="annot"><span class="annottext">workSize :: TPrimExp Int64 VName
</span><a href="#local-6989586621684540616"><span class="hs-identifier hs-var hs-var">workSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540620"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540618"><span class="hs-identifier hs-var">groupSizeE</span></a></span><span>
</span><span id="line-39"></span><span>      </span><span id="local-6989586621684540615"><span class="annot"><span class="annottext">prefixArraysSize :: TPrimExp Int64 VName
</span><a href="#local-6989586621684540615"><span class="hs-identifier hs-var hs-var">prefixArraysSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-40"></span><span>        </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName
-&gt; [TPrimExp Int64 VName]
-&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684540613"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540613"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684540612"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540612"><span class="hs-identifier hs-var">tySize</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. IntegralExp a =&gt; a -&gt; a -&gt; a
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#alignTo"><span class="hs-identifier hs-var">alignTo</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540613"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540612"><span class="hs-identifier hs-var">tySize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540612"><span class="hs-identifier hs-var">tySize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540618"><span class="hs-identifier hs-var">groupSizeE</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-41"></span><span>          </span><span class="annot"><span class="annottext">(PrimType -&gt; TPrimExp Int64 VName)
-&gt; [PrimType] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540619"><span class="hs-identifier hs-var">types</span></a></span><span>
</span><span id="line-42"></span><span>      </span><span id="local-6989586621684540609"><span class="annot"><span class="annottext">maxTransposedArraySize :: TPrimExp Int64 VName
</span><a href="#local-6989586621684540609"><span class="hs-identifier hs-var hs-var">maxTransposedArraySize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-43"></span><span>        </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; a -&gt; a) -&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">foldl1</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall v. TPrimExp Int64 v -&gt; TPrimExp Int64 v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sMax64"><span class="hs-identifier hs-var">sMax64</span></a></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; TPrimExp Int64 VName)
-&gt; [PrimType] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684540606"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540606"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540616"><span class="hs-identifier hs-var">workSize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540606"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540619"><span class="hs-identifier hs-var">types</span></a></span><span>
</span><span id="line-44"></span><span>
</span><span id="line-45"></span><span>      </span><span id="local-6989586621684541508"><span class="annot"><a href="#local-6989586621684540605"><span class="hs-identifier hs-type">warpSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Num</span></span><span> </span><span class="annot"><a href="#local-6989586621684541508"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684541508"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-46"></span><span>      </span><span id="local-6989586621684540605"><span class="annot"><span class="annottext">warpSize :: forall a. Num a =&gt; a
</span><a href="#local-6989586621684540605"><span class="hs-identifier hs-var hs-var">warpSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">32</span></span><span>
</span><span id="line-47"></span><span>      </span><span id="local-6989586621684540602"><span class="annot"><span class="annottext">maxWarpExchangeSize :: TPrimExp Int64 VName
</span><a href="#local-6989586621684540602"><span class="hs-identifier hs-var hs-var">maxWarpExchangeSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-48"></span><span>        </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName
-&gt; [TPrimExp Int64 VName]
-&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684540601"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540601"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684540600"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540600"><span class="hs-identifier hs-var">tySize</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. IntegralExp a =&gt; a -&gt; a -&gt; a
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#alignTo"><span class="hs-identifier hs-var">alignTo</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540601"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540600"><span class="hs-identifier hs-var">tySize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540600"><span class="hs-identifier hs-var">tySize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; Integer -&gt; a
</span><span class="hs-identifier hs-var">fromInteger</span></span><span> </span><span class="annot"><span class="annottext">Integer
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540605"><span class="hs-identifier hs-var">warpSize</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-49"></span><span>          </span><span class="annot"><span class="annottext">(PrimType -&gt; TPrimExp Int64 VName)
-&gt; [PrimType] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540619"><span class="hs-identifier hs-var">types</span></a></span><span>
</span><span id="line-50"></span><span>      </span><span id="local-6989586621684540599"><span class="annot"><span class="annottext">maxLookbackSize :: TPrimExp Int64 VName
</span><a href="#local-6989586621684540599"><span class="hs-identifier hs-var hs-var">maxLookbackSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540602"><span class="hs-identifier hs-var">maxWarpExchangeSize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540605"><span class="hs-identifier hs-var">warpSize</span></a></span><span>
</span><span id="line-51"></span><span>      </span><span id="local-6989586621684540598"><span class="annot"><span class="annottext">size :: Count Bytes (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540598"><span class="hs-identifier hs-var hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Count Bytes (TPrimExp Int64 VName)
forall a. a -&gt; Count Bytes a
</span><a href="Futhark.CodeGen.ImpCode.html#bytes"><span class="hs-identifier hs-var">Imp.bytes</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; Count Bytes (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName -&gt; Count Bytes (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540599"><span class="hs-identifier hs-var">maxLookbackSize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall v. TPrimExp Int64 v -&gt; TPrimExp Int64 v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sMax64"><span class="hs-operator hs-var">`sMax64`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540615"><span class="hs-identifier hs-var">prefixArraysSize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall v. TPrimExp Int64 v -&gt; TPrimExp Int64 v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sMax64"><span class="hs-operator hs-var">`sMax64`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540609"><span class="hs-identifier hs-var">maxTransposedArraySize</span></a></span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span>      </span><span class="annot"><a href="#local-6989586621684540596"><span class="hs-identifier hs-type">varTE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-54"></span><span>      </span><span id="local-6989586621684540596"><span class="annot"><span class="annottext">varTE :: TV Int64 -&gt; TPrimExp Int64 VName
</span><a href="#local-6989586621684540596"><span class="hs-identifier hs-var hs-var">varTE</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">le64</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TPrimExp Int64 VName)
-&gt; (TV Int64 -&gt; VName) -&gt; TV Int64 -&gt; TPrimExp Int64 VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span>  </span><span id="local-6989586621684540592"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684540592"><span class="hs-identifier hs-var">byteOffsets</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName))
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp [TPrimExp Int64 VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TV Int64 -&gt; TPrimExp Int64 VName)
-&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
</span><a href="#local-6989586621684540596"><span class="hs-identifier hs-var">varTE</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp (TV Int64)
 -&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName))
-&gt; (TPrimExp Int64 VName
    -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;byte_offsets&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName]
 -&gt; ImpM GPUMem KernelEnv KernelOp [TPrimExp Int64 VName])
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-58"></span><span>      </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName
-&gt; [TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName]
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">scanl</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684540588"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540588"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621684540587"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540587"><span class="hs-identifier hs-var">tySize</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. IntegralExp a =&gt; a -&gt; a -&gt; a
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#alignTo"><span class="hs-identifier hs-var">alignTo</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540588"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540587"><span class="hs-identifier hs-var">tySize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540621"><span class="hs-identifier hs-var">groupSize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540587"><span class="hs-identifier hs-var">tySize</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName])
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-59"></span><span>        </span><span class="annot"><span class="annottext">(PrimType -&gt; TPrimExp Int64 VName)
-&gt; [PrimType] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540619"><span class="hs-identifier hs-var">types</span></a></span><span>
</span><span id="line-60"></span><span>
</span><span id="line-61"></span><span>  </span><span id="local-6989586621684540586"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684540586"><span class="hs-identifier hs-var">warpByteOffsets</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName))
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp [TPrimExp Int64 VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TV Int64 -&gt; TPrimExp Int64 VName)
-&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
</span><a href="#local-6989586621684540596"><span class="hs-identifier hs-var">varTE</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp (TV Int64)
 -&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName))
-&gt; (TPrimExp Int64 VName
    -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;warp_byte_offset&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName]
 -&gt; ImpM GPUMem KernelEnv KernelOp [TPrimExp Int64 VName])
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-63"></span><span>      </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName
-&gt; [TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName]
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">scanl</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684540585"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540585"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621684540584"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540584"><span class="hs-identifier hs-var">tySize</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. IntegralExp a =&gt; a -&gt; a -&gt; a
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#alignTo"><span class="hs-identifier hs-var">alignTo</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540585"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540584"><span class="hs-identifier hs-var">tySize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540605"><span class="hs-identifier hs-var">warpSize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540584"><span class="hs-identifier hs-var">tySize</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540605"><span class="hs-identifier hs-var">warpSize</span></a></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName])
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-64"></span><span>        </span><span class="annot"><span class="annottext">(PrimType -&gt; TPrimExp Int64 VName)
-&gt; [PrimType] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540619"><span class="hs-identifier hs-var">types</span></a></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Allocate reused shared memeory&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span>  </span><span id="local-6989586621684540582"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540582"><span class="hs-identifier hs-var">localMem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Count Bytes (TPrimExp Int64 VName)
-&gt; Space
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String
-&gt; Count Bytes (TPrimExp Int64 VName)
-&gt; Space
-&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAlloc"><span class="hs-identifier hs-var">sAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local_mem&quot;</span></span><span> </span><span class="annot"><span class="annottext">Count Bytes (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540598"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span>  </span><span id="local-6989586621684540579"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540579"><span class="hs-identifier hs-var">transposeArrayLength</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;trans_arr_len&quot;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540616"><span class="hs-identifier hs-var">workSize</span></a></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span>  </span><span id="local-6989586621684540578"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540578"><span class="hs-identifier hs-var">sharedId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; ShapeBase SubExp
-&gt; VName
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String
-&gt; PrimType -&gt; ShapeBase SubExp -&gt; VName -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArrayInMem"><span class="hs-identifier hs-var">sArrayInMem</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;shared_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int32 -&gt; SubExp
forall v. IsValue v =&gt; v -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#constant"><span class="hs-identifier hs-var">constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int32
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540582"><span class="hs-identifier hs-var">localMem</span></a></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span>  </span><span id="local-6989586621684540573"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540573"><span class="hs-identifier hs-var">transposedArrays</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><span class="annottext">[PrimType]
-&gt; (PrimType -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; ImpM GPUMem KernelEnv KernelOp [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540619"><span class="hs-identifier hs-var">types</span></a></span><span> </span><span class="annot"><span class="annottext">((PrimType -&gt; ImpM GPUMem KernelEnv KernelOp VName)
 -&gt; ImpM GPUMem KernelEnv KernelOp [VName])
-&gt; (PrimType -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; ImpM GPUMem KernelEnv KernelOp [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684540571"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540571"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-75"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; ShapeBase SubExp
-&gt; VName
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String
-&gt; PrimType -&gt; ShapeBase SubExp -&gt; VName -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArrayInMem"><span class="hs-identifier hs-var">sArrayInMem</span></a></span><span>
</span><span id="line-76"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local_transpose_arr&quot;</span></span><span>
</span><span id="line-77"></span><span>        </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540571"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-78"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540579"><span class="hs-identifier hs-var">transposeArrayLength</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540582"><span class="hs-identifier hs-var">localMem</span></a></span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span>  </span><span id="local-6989586621684540569"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540569"><span class="hs-identifier hs-var">prefixArrays</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><span class="annottext">[(TPrimExp Int64 VName, PrimType)]
-&gt; ((TPrimExp Int64 VName, PrimType)
    -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; ImpM GPUMem KernelEnv KernelOp [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [PrimType] -&gt; [(TPrimExp Int64 VName, PrimType)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684540592"><span class="hs-identifier hs-var">byteOffsets</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540619"><span class="hs-identifier hs-var">types</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((TPrimExp Int64 VName, PrimType)
  -&gt; ImpM GPUMem KernelEnv KernelOp VName)
 -&gt; ImpM GPUMem KernelEnv KernelOp [VName])
-&gt; ((TPrimExp Int64 VName, PrimType)
    -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; ImpM GPUMem KernelEnv KernelOp [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540568"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540568"><span class="hs-identifier hs-var">off</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540567"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540567"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-83"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540566"><span class="annot"><span class="annottext">off' :: TPrimExp Int64 VName
</span><a href="#local-6989586621684540566"><span class="hs-identifier hs-var hs-var">off'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540568"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. IntegralExp a =&gt; a -&gt; a -&gt; a
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540567"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-84"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; ShapeBase SubExp
-&gt; VName
-&gt; IxFun
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String
-&gt; PrimType
-&gt; ShapeBase SubExp
-&gt; VName
-&gt; IxFun
-&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArray"><span class="hs-identifier hs-var">sArray</span></a></span><span>
</span><span id="line-85"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local_prefix_arr&quot;</span></span><span>
</span><span id="line-86"></span><span>        </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540567"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-87"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540621"><span class="hs-identifier hs-var">groupSize</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540582"><span class="hs-identifier hs-var">localMem</span></a></span><span>
</span><span id="line-89"></span><span>        </span><span class="annot"><span class="annottext">(IxFun -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; IxFun -&gt; ImpM GPUMem KernelEnv KernelOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; [TPrimExp Int64 VName] -&gt; IxFun
forall num. IntegralExp num =&gt; num -&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iotaOffset"><span class="hs-identifier hs-var">IxFun.iotaOffset</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540566"><span class="hs-identifier hs-var">off'</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540621"><span class="hs-identifier hs-var">groupSize</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span>  </span><span id="local-6989586621684540562"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540562"><span class="hs-identifier hs-var">warpscan</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; ShapeBase SubExp
-&gt; VName
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String
-&gt; PrimType -&gt; ShapeBase SubExp -&gt; VName -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArrayInMem"><span class="hs-identifier hs-var">sArrayInMem</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;warpscan&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int8"><span class="hs-identifier hs-var">int8</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int64 -&gt; SubExp
forall v. IsValue v =&gt; v -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#constant"><span class="hs-identifier hs-var">constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540605"><span class="hs-identifier hs-var">warpSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540582"><span class="hs-identifier hs-var">localMem</span></a></span><span>
</span><span id="line-92"></span><span>  </span><span id="local-6989586621684540560"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540560"><span class="hs-identifier hs-var">warpExchanges</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-93"></span><span>    </span><span class="annot"><span class="annottext">[(TPrimExp Int64 VName, PrimType)]
-&gt; ((TPrimExp Int64 VName, PrimType)
    -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; ImpM GPUMem KernelEnv KernelOp [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [PrimType] -&gt; [(TPrimExp Int64 VName, PrimType)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684540586"><span class="hs-identifier hs-var">warpByteOffsets</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540619"><span class="hs-identifier hs-var">types</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((TPrimExp Int64 VName, PrimType)
  -&gt; ImpM GPUMem KernelEnv KernelOp VName)
 -&gt; ImpM GPUMem KernelEnv KernelOp [VName])
-&gt; ((TPrimExp Int64 VName, PrimType)
    -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; ImpM GPUMem KernelEnv KernelOp [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540559"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540559"><span class="hs-identifier hs-var">off</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540558"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540558"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-94"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540557"><span class="annot"><span class="annottext">off' :: TPrimExp Int64 VName
</span><a href="#local-6989586621684540557"><span class="hs-identifier hs-var hs-var">off'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540559"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. IntegralExp a =&gt; a -&gt; a -&gt; a
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540558"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-95"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; ShapeBase SubExp
-&gt; VName
-&gt; IxFun
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String
-&gt; PrimType
-&gt; ShapeBase SubExp
-&gt; VName
-&gt; IxFun
-&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArray"><span class="hs-identifier hs-var">sArray</span></a></span><span>
</span><span id="line-96"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;warp_exchange&quot;</span></span><span>
</span><span id="line-97"></span><span>        </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540558"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-98"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int64 -&gt; SubExp
forall v. IsValue v =&gt; v -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#constant"><span class="hs-identifier hs-var">constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540605"><span class="hs-identifier hs-var">warpSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540582"><span class="hs-identifier hs-var">localMem</span></a></span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><span class="annottext">(IxFun -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; IxFun -&gt; ImpM GPUMem KernelEnv KernelOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; [TPrimExp Int64 VName] -&gt; IxFun
forall num. IntegralExp num =&gt; num -&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iotaOffset"><span class="hs-identifier hs-var">IxFun.iotaOffset</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540557"><span class="hs-identifier hs-var">off'</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540605"><span class="hs-identifier hs-var">warpSize</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span>  </span><span class="annot"><span class="annottext">(VName, [VName], [VName], VName, [VName])
-&gt; InKernelGen (VName, [VName], [VName], VName, [VName])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540578"><span class="hs-identifier hs-var">sharedId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540573"><span class="hs-identifier hs-var">transposedArrays</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540569"><span class="hs-identifier hs-var">prefixArrays</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540562"><span class="hs-identifier hs-var">warpscan</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540560"><span class="hs-identifier hs-var">warpExchanges</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>
</span><span id="line-104"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#inBlockScanLookback"><span class="hs-identifier hs-type">inBlockScanLookback</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-105"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier hs-type">KernelConstants</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-106"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-107"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-110"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span id="inBlockScanLookback"><span class="annot"><span class="annottext">inBlockScanLookback :: KernelConstants
-&gt; TPrimExp Int64 VName
-&gt; VName
-&gt; [VName]
-&gt; LambdaT GPUMem
-&gt; ImpM GPUMem KernelEnv KernelOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#inBlockScanLookback"><span class="hs-identifier hs-var hs-var">inBlockScanLookback</span></a></span></span><span> </span><span id="local-6989586621684540555"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540555"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span id="local-6989586621684540554"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540554"><span class="hs-identifier hs-var">arrs_full_size</span></a></span></span><span> </span><span id="local-6989586621684540553"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540553"><span class="hs-identifier hs-var">flag_arr</span></a></span></span><span> </span><span id="local-6989586621684540552"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540552"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684540551"><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540551"><span class="hs-identifier hs-var">scan_lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-112"></span><span>  </span><span id="local-6989586621684540549"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540549"><span class="hs-identifier hs-var">flg_x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;flg_x&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540547"><span class="hs-identifier hs-var">p_int8</span></a></span><span>
</span><span id="line-113"></span><span>  </span><span id="local-6989586621684540546"><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540546"><span class="hs-identifier hs-var">flg_y</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int8)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;flg_y&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540547"><span class="hs-identifier hs-var">p_int8</span></a></span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540545"><span class="annot"><span class="annottext">flg_param_x :: Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540545"><span class="hs-identifier hs-var hs-var">flg_param_x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Attrs
-&gt; VName
-&gt; MemInfo SubExp NoUniqueness MemBind
-&gt; Param (MemInfo SubExp NoUniqueness MemBind)
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540549"><span class="hs-identifier hs-var">flg_x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; MemInfo SubExp NoUniqueness MemBind
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540547"><span class="hs-identifier hs-var">p_int8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span>      </span><span id="local-6989586621684540542"><span class="annot"><span class="annottext">flg_param_y :: Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540542"><span class="hs-identifier hs-var hs-var">flg_param_y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Attrs
-&gt; VName
-&gt; MemInfo SubExp NoUniqueness MemBind
-&gt; Param (MemInfo SubExp NoUniqueness MemBind)
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540546"><span class="hs-identifier hs-var">flg_y</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; MemInfo SubExp NoUniqueness MemBind
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540547"><span class="hs-identifier hs-var">p_int8</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>      </span><span id="local-6989586621684540541"><span class="annot"><span class="annottext">flg_y_exp :: TPrimExp Int8 VName
</span><a href="#local-6989586621684540541"><span class="hs-identifier hs-var hs-var">flg_y_exp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TV Int8 -&gt; TPrimExp Int8 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540546"><span class="hs-identifier hs-var">flg_y</span></a></span><span>
</span><span id="line-117"></span><span>      </span><span id="local-6989586621684540536"><span class="annot"><span class="annottext">statusP :: TPrimExp Int8 VName
</span><a href="#local-6989586621684540536"><span class="hs-identifier hs-var hs-var">statusP</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int8 VName
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int8</span></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>      </span><span id="local-6989586621684540532"><span class="annot"><span class="annottext">statusX :: TPrimExp Int8 VName
</span><a href="#local-6989586621684540532"><span class="hs-identifier hs-var hs-var">statusX</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int8 VName
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int8</span></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span>  </span><span class="annot"><span class="annottext">[LParam GPUMem] -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep inner r op.
Mem rep inner =&gt;
[LParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-var">dLParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540551"><span class="hs-identifier hs-var">scan_lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>
</span><span id="line-122"></span><span>  </span><span id="local-6989586621684540530"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540530"><span class="hs-identifier hs-var">skip_threads</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;skip_threads&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-123"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540529"><span class="annot"><span class="annottext">in_block_thread_active :: TPrimExp Bool VName
</span><a href="#local-6989586621684540529"><span class="hs-identifier hs-var hs-var">in_block_thread_active</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-124"></span><span>        </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540530"><span class="hs-identifier hs-var">skip_threads</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C%3D."><span class="hs-operator hs-var">.&lt;=.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540527"><span class="hs-identifier hs-var">in_block_id</span></a></span><span>
</span><span id="line-125"></span><span>      </span><span id="local-6989586621684540526"><span class="annot"><span class="annottext">actual_params :: [LParam GPUMem]
</span><a href="#local-6989586621684540526"><span class="hs-identifier hs-var hs-var">actual_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540551"><span class="hs-identifier hs-var">scan_lam</span></a></span><span>
</span><span id="line-126"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684540525"><span class="annot"><span class="annottext">[Param (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684540525"><span class="hs-identifier hs-var">x_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540524"><span class="annot"><span class="annottext">[Param (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684540524"><span class="hs-identifier hs-var">y_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-127"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; ([Param (MemInfo SubExp NoUniqueness MemBind)],
    [Param (MemInfo SubExp NoUniqueness MemBind)])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684540526"><span class="hs-identifier hs-var">actual_params</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684540526"><span class="hs-identifier hs-var">actual_params</span></a></span><span>
</span><span id="line-128"></span><span>      </span><span id="local-6989586621684540521"><span class="annot"><span class="annottext">y_to_x :: ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540521"><span class="hs-identifier hs-var hs-var">y_to_x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-129"></span><span>        </span><span class="annot"><span class="annottext">[(Param (MemInfo SubExp NoUniqueness MemBind),
  Param (MemInfo SubExp NoUniqueness MemBind))]
-&gt; ((Param (MemInfo SubExp NoUniqueness MemBind),
     Param (MemInfo SubExp NoUniqueness MemBind))
    -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [(Param (MemInfo SubExp NoUniqueness MemBind),
     Param (MemInfo SubExp NoUniqueness MemBind))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684540525"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684540524"><span class="hs-identifier hs-var">y_params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param (MemInfo SubExp NoUniqueness MemBind),
   Param (MemInfo SubExp NoUniqueness MemBind))
  -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((Param (MemInfo SubExp NoUniqueness MemBind),
     Param (MemInfo SubExp NoUniqueness MemBind))
    -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540519"><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540519"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540518"><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540518"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-130"></span><span>          </span><span class="annot"><span class="annottext">Bool
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall dec.
Typed dec =&gt;
Param dec -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540519"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-131"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540519"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540518"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-132"></span><span>      </span><span id="local-6989586621684540511"><span class="annot"><span class="annottext">y_to_x_flg :: ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540511"><span class="hs-identifier hs-var hs-var">y_to_x_flg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-133"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540549"><span class="hs-identifier hs-var">flg_x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540546"><span class="hs-identifier hs-var">flg_y</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-134"></span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-comment">-- Set initial y values</span><span>
</span><span id="line-136"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;read input for in-block scan&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-137"></span><span>    </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp NoUniqueness MemBind)
 -&gt; VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; VName -&gt; ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540509"><span class="hs-identifier hs-var">readInitial</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540542"><span class="hs-identifier hs-var">flg_param_y</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Param (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684540524"><span class="hs-identifier hs-var">y_params</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540553"><span class="hs-identifier hs-var">flag_arr</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540552"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-comment">-- Since the final result is expected to be in x_params, we may</span><span>
</span><span id="line-139"></span><span>    </span><span class="hs-comment">-- need to copy it there for the first thread in the block.</span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540527"><span class="hs-identifier hs-var">in_block_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-141"></span><span>      </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540521"><span class="hs-identifier hs-var">y_to_x</span></a></span><span>
</span><span id="line-142"></span><span>      </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540511"><span class="hs-identifier hs-var">y_to_x_flg</span></a></span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684540506"><span class="hs-identifier hs-var">array_scan</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540505"><span class="hs-identifier hs-var">barrier</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540504"><span class="annot"><span class="annottext">op_to_x :: ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540504"><span class="hs-identifier hs-var hs-var">op_to_x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-147"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span>
</span><span id="line-148"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int8 VName
</span><a href="#local-6989586621684540541"><span class="hs-identifier hs-var">flg_y_exp</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName -&gt; TPrimExp Int8 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName
</span><a href="#local-6989586621684540536"><span class="hs-identifier hs-var">statusP</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; TPrimExp Bool VName -&gt; TPrimExp Bool VName
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%7C%7C."><span class="hs-operator hs-var">.||.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName
</span><a href="#local-6989586621684540541"><span class="hs-identifier hs-var">flg_y_exp</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName -&gt; TPrimExp Int8 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName
</span><a href="#local-6989586621684540532"><span class="hs-identifier hs-var">statusX</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-150"></span><span>              </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540511"><span class="hs-identifier hs-var">y_to_x_flg</span></a></span><span>
</span><span id="line-151"></span><span>              </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540521"><span class="hs-identifier hs-var">y_to_x</span></a></span><span>
</span><span id="line-152"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; Body GPUMem -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall dec rep r op. [Param dec] -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody%27"><span class="hs-identifier hs-var">compileBody'</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684540525"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; Body GPUMem -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540551"><span class="hs-identifier hs-var">scan_lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>
</span><span id="line-155"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;in-block scan (hopefully no barriers needed)&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-156"></span><span>    </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540530"><span class="hs-identifier hs-var">skip_threads</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span>
</span><span id="line-157"></span><span>
</span><span id="line-158"></span><span>    </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhile"><span class="hs-identifier hs-var">sWhile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540530"><span class="hs-identifier hs-var">skip_threads</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540496"><span class="hs-identifier hs-var">block_size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-159"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
</span><a href="#local-6989586621684540529"><span class="hs-identifier hs-var">in_block_thread_active</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-160"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;read operands&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-161"></span><span>          </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp NoUniqueness MemBind)
 -&gt; VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span>
</span><span id="line-162"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540495"><span class="hs-identifier hs-var">readParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TPrimExp Int64 VName)
-&gt; TExp Int32 -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540530"><span class="hs-identifier hs-var">skip_threads</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540545"><span class="hs-identifier hs-var">flg_param_x</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Param (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684540525"><span class="hs-identifier hs-var">x_params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540553"><span class="hs-identifier hs-var">flag_arr</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540552"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-165"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;perform operation&quot;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540504"><span class="hs-identifier hs-var">op_to_x</span></a></span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;write result&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-168"></span><span>          </span><span class="annot"><span class="annottext">[ImpM GPUMem KernelEnv KernelOp ()]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><span class="hs-identifier hs-var">sequence_</span></span><span> </span><span class="annot"><span class="annottext">([ImpM GPUMem KernelEnv KernelOp ()]
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; [ImpM GPUMem KernelEnv KernelOp ()]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-169"></span><span>            </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp NoUniqueness MemBind)
 -&gt; Param (MemInfo SubExp NoUniqueness MemBind)
 -&gt; VName
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [VName]
-&gt; [ImpM GPUMem KernelEnv KernelOp ()]
forall a b c d. (a -&gt; b -&gt; c -&gt; d) -&gt; [a] -&gt; [b] -&gt; [c] -&gt; [d]
</span><span class="hs-identifier hs-var">zipWith3</span></span><span>
</span><span id="line-170"></span><span>              </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540491"><span class="hs-identifier hs-var">writeResult</span></a></span><span>
</span><span id="line-171"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540545"><span class="hs-identifier hs-var">flg_param_x</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Param (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684540525"><span class="hs-identifier hs-var">x_params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-172"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540542"><span class="hs-identifier hs-var">flg_param_y</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Param (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684540524"><span class="hs-identifier hs-var">y_params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540553"><span class="hs-identifier hs-var">flag_arr</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540552"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span>      </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540530"><span class="hs-identifier hs-var">skip_threads</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540530"><span class="hs-identifier hs-var">skip_threads</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">2</span></span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-177"></span><span>    </span><span id="local-6989586621684540547"><span class="annot"><span class="annottext">p_int8 :: PrimType
</span><a href="#local-6989586621684540547"><span class="hs-identifier hs-var hs-var">p_int8</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int8"><span class="hs-identifier hs-var">Int8</span></a></span><span>
</span><span id="line-178"></span><span>    </span><span id="local-6989586621684540496"><span class="annot"><span class="annottext">block_size :: TExp Int32
</span><a href="#local-6989586621684540496"><span class="hs-identifier hs-var hs-var">block_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">32</span></span><span>
</span><span id="line-179"></span><span>    </span><span id="local-6989586621684540487"><span class="annot"><span class="annottext">block_id :: TExp Int32
</span><a href="#local-6989586621684540487"><span class="hs-identifier hs-var hs-var">block_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540486"><span class="hs-identifier hs-var">ltid32</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. IntegralExp a =&gt; a -&gt; a -&gt; a
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540496"><span class="hs-identifier hs-var">block_size</span></a></span><span>
</span><span id="line-180"></span><span>    </span><span id="local-6989586621684540527"><span class="annot"><span class="annottext">in_block_id :: TExp Int32
</span><a href="#local-6989586621684540527"><span class="hs-identifier hs-var hs-var">in_block_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540486"><span class="hs-identifier hs-var">ltid32</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540487"><span class="hs-identifier hs-var">block_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540496"><span class="hs-identifier hs-var">block_size</span></a></span><span>
</span><span id="line-181"></span><span>    </span><span id="local-6989586621684540486"><span class="annot"><span class="annottext">ltid32 :: TExp Int32
</span><a href="#local-6989586621684540486"><span class="hs-identifier hs-var hs-var">ltid32</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540555"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-182"></span><span>    </span><span id="local-6989586621684540484"><span class="annot"><span class="annottext">ltid :: TPrimExp Int64 VName
</span><a href="#local-6989586621684540484"><span class="hs-identifier hs-var hs-var">ltid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540486"><span class="hs-identifier hs-var">ltid32</span></a></span><span>
</span><span id="line-183"></span><span>    </span><span id="local-6989586621684540483"><span class="annot"><span class="annottext">gtid :: TPrimExp Int64 VName
</span><a href="#local-6989586621684540483"><span class="hs-identifier hs-var hs-var">gtid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TPrimExp Int64 VName)
-&gt; TExp Int32 -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGlobalThreadId"><span class="hs-identifier hs-var hs-var">kernelGlobalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540555"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-184"></span><span>    </span><span id="local-6989586621684540506"><span class="annot"><span class="annottext">array_scan :: Bool
</span><a href="#local-6989586621684540506"><span class="hs-identifier hs-var hs-var">array_scan</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Bool)
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Bool)
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
LambdaT rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540551"><span class="hs-identifier hs-var">scan_lam</span></a></span><span>
</span><span id="line-185"></span><span>    </span><span id="local-6989586621684540505"><span class="annot"><span class="annottext">barrier :: ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540505"><span class="hs-identifier hs-var hs-var">barrier</span></a></span></span><span>
</span><span id="line-186"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684540506"><span class="hs-identifier hs-var">array_scan</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-187"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceGlobal"><span class="hs-identifier hs-var">Imp.FenceGlobal</span></a></span><span>
</span><span id="line-188"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-189"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span>    </span><span id="local-6989586621684540509"><span class="annot"><span class="annottext">readInitial :: Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; VName -&gt; ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540509"><span class="hs-identifier hs-var hs-var">readInitial</span></a></span></span><span> </span><span id="local-6989586621684540474"><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540474"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684540473"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540473"><span class="hs-identifier hs-var">arr</span></a></span></span><span>
</span><span id="line-192"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Bool)
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall dec.
Typed dec =&gt;
Param dec -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540474"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-193"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540474"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540473"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540484"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-194"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-195"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540474"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540473"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540483"><span class="hs-identifier hs-var">gtid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-196"></span><span>    </span><span id="local-6989586621684540495"><span class="annot"><span class="annottext">readParam :: TPrimExp Int64 VName
-&gt; Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540495"><span class="hs-identifier hs-var hs-var">readParam</span></a></span></span><span> </span><span id="local-6989586621684540471"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540471"><span class="hs-identifier hs-var">behind</span></a></span></span><span> </span><span id="local-6989586621684540470"><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540470"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684540469"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540469"><span class="hs-identifier hs-var">arr</span></a></span></span><span>
</span><span id="line-197"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Bool)
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall dec.
Typed dec =&gt;
Param dec -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540470"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-198"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540470"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540469"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540484"><span class="hs-identifier hs-var">ltid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540471"><span class="hs-identifier hs-var">behind</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-199"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-200"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540470"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540469"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540483"><span class="hs-identifier hs-var">gtid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540471"><span class="hs-identifier hs-var">behind</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540554"><span class="hs-identifier hs-var">arrs_full_size</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span>    </span><span id="local-6989586621684540491"><span class="annot"><span class="annottext">writeResult :: Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540491"><span class="hs-identifier hs-var hs-var">writeResult</span></a></span></span><span> </span><span id="local-6989586621684540468"><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540468"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684540467"><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540467"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span id="local-6989586621684540466"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540466"><span class="hs-identifier hs-var">arr</span></a></span></span><span>
</span><span id="line-203"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Bool)
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall dec.
Typed dec =&gt;
Param dec -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540468"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-204"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540466"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540484"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540468"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-205"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540467"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540468"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-206"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-207"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; SubExp
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540467"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540468"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span class="hs-comment">-- | Compile 'SegScan' instance to host-level code with calls to a</span><span>
</span><span id="line-210"></span><span class="hs-comment">-- single-pass kernel.</span><span>
</span><span id="line-211"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#compileSegScan"><span class="hs-identifier hs-type">compileSegScan</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-212"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-213"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegLevel"><span class="hs-identifier hs-type">SegLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-217"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span id="compileSegScan"><span class="annot"><span class="annottext">compileSegScan :: Pat GPUMem
-&gt; SegLevel
-&gt; SegSpace
-&gt; SegBinOp GPUMem
-&gt; KernelBody GPUMem
-&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#compileSegScan"><span class="hs-identifier hs-var hs-var">compileSegScan</span></a></span></span><span> </span><span id="local-6989586621684540465"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684540465"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684540464"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684540464"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684540463"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684540463"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684540462"><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540462"><span class="hs-identifier hs-var">scanOp</span></a></span></span><span> </span><span id="local-6989586621684540461"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684540461"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span id="local-6989586621684540459"><span class="annot"><span class="annottext">[PatElemT (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684540459"><span class="hs-identifier hs-var">all_pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540465"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-220"></span><span>      </span><span id="local-6989586621684540458"><span class="annot"><span class="annottext">group_size :: Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540458"><span class="hs-identifier hs-var hs-var">group_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; Count GroupSize SubExp -&gt; Count GroupSize (TPrimExp Int64 VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SegLevel -&gt; Count GroupSize SubExp
</span><a href="Futhark.IR.GPU.Op.html#segGroupSize"><span class="hs-identifier hs-var hs-var">segGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684540464"><span class="hs-identifier hs-var">lvl</span></a></span><span>
</span><span id="line-221"></span><span>      </span><span id="local-6989586621684540455"><span class="annot"><span class="annottext">n :: TPrimExp Int64 VName
</span><a href="#local-6989586621684540455"><span class="hs-identifier hs-var hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TPrimExp Int64 VName])
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segSpaceDims"><span class="hs-identifier hs-var">segSpaceDims</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684540463"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-222"></span><span>      </span><span id="local-6989586621684540452"><span class="annot"><span class="annottext">num_groups :: Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540452"><span class="hs-identifier hs-var hs-var">num_groups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Count NumGroups (TPrimExp Int64 VName)
forall u e. e -&gt; Count u e
</span><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-var">Count</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540455"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. IntegralExp a =&gt; a -&gt; a -&gt; a
</span><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-operator hs-var">`divUp`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540458"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>      </span><span id="local-6989586621684540449"><span class="annot"><span class="annottext">num_threads :: TPrimExp Int64 VName
</span><a href="#local-6989586621684540449"><span class="hs-identifier hs-var hs-var">num_threads</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540452"><span class="hs-identifier hs-var">num_groups</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540458"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-224"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684540448"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540448"><span class="hs-identifier hs-var">gtids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540447"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684540447"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684540463"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-225"></span><span>      </span><span id="local-6989586621684540444"><span class="annot"><span class="annottext">dims' :: [TPrimExp Int64 VName]
</span><a href="#local-6989586621684540444"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684540447"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-226"></span><span>      </span><span id="local-6989586621684540443"><span class="annot"><span class="annottext">segmented :: Bool
</span><a href="#local-6989586621684540443"><span class="hs-identifier hs-var hs-var">segmented</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684540444"><span class="hs-identifier hs-var">dims'</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-227"></span><span>      </span><span id="local-6989586621684540441"><span class="annot"><span class="annottext">not_segmented_e :: TPrimExp Bool VName
</span><a href="#local-6989586621684540441"><span class="hs-identifier hs-var hs-var">not_segmented_e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684540443"><span class="hs-identifier hs-var">segmented</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
forall v. TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#false"><span class="hs-identifier hs-var">false</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
forall v. TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#true"><span class="hs-identifier hs-var">true</span></a></span><span>
</span><span id="line-228"></span><span>      </span><span id="local-6989586621684540438"><span class="annot"><span class="annottext">segment_size :: TPrimExp Int64 VName
</span><a href="#local-6989586621684540438"><span class="hs-identifier hs-var hs-var">segment_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684540444"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-229"></span><span>      </span><span id="local-6989586621684540436"><span class="annot"><span class="annottext">scanOpNe :: [SubExp]
</span><a href="#local-6989586621684540436"><span class="hs-identifier hs-var hs-var">scanOpNe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540462"><span class="hs-identifier hs-var">scanOp</span></a></span><span>
</span><span id="line-230"></span><span>      </span><span id="local-6989586621684540435"><span class="annot"><span class="annottext">tys :: [PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var hs-var">tys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness -&gt; PrimType)
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; [PrimType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684540433"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540433"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540433"><span class="hs-identifier hs-var">pt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; [PrimType])
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; [PrimType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall rep.
LambdaT rep -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT GPUMem -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness])
-&gt; LambdaT GPUMem -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; LambdaT GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540462"><span class="hs-identifier hs-var">scanOp</span></a></span><span>
</span><span id="line-231"></span><span>
</span><span id="line-232"></span><span>      </span><span id="local-6989586621684540432"><span class="annot"><a href="#local-6989586621684540431"><span class="hs-identifier hs-type">statusX</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684540430"><span class="hs-identifier hs-type">statusA</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684540429"><span class="hs-identifier hs-type">statusP</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Num</span></span><span> </span><span class="annot"><a href="#local-6989586621684540432"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684540432"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-233"></span><span>      </span><span id="local-6989586621684540431"><span class="annot"><span class="annottext">statusX :: forall a. Num a =&gt; a
</span><a href="#local-6989586621684540431"><span class="hs-identifier hs-var hs-var">statusX</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">0</span></span><span>
</span><span id="line-234"></span><span>      </span><span id="local-6989586621684540430"><span class="annot"><span class="annottext">statusA :: forall a. Num a =&gt; a
</span><a href="#local-6989586621684540430"><span class="hs-identifier hs-var hs-var">statusA</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span>
</span><span id="line-235"></span><span>      </span><span id="local-6989586621684540429"><span class="annot"><span class="annottext">statusP :: forall a. Num a =&gt; a
</span><a href="#local-6989586621684540429"><span class="hs-identifier hs-var hs-var">statusP</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">2</span></span><span>
</span><span id="line-236"></span><span>      </span><span class="annot"><a href="#local-6989586621684540422"><span class="hs-identifier hs-type">sumT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span>
</span><span id="line-237"></span><span>      </span><span class="annot"><a href="#local-6989586621684540421"><span class="hs-identifier hs-type">maxT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Integer</span></span><span>
</span><span id="line-238"></span><span>      </span><span id="local-6989586621684540422"><span class="annot"><span class="annottext">sumT :: Integer
</span><a href="#local-6989586621684540422"><span class="hs-identifier hs-var hs-var">sumT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; PrimType -&gt; Integer)
-&gt; Integer -&gt; [PrimType] -&gt; Integer
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684540420"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540420"><span class="hs-identifier hs-var">bytes</span></a></span></span><span> </span><span id="local-6989586621684540419"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540419"><span class="hs-identifier hs-var">typ</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540420"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Integer
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540419"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-239"></span><span>      </span><span id="local-6989586621684540415"><span class="annot"><span class="annottext">primByteSize' :: PrimType -&gt; Integer
</span><a href="#local-6989586621684540415"><span class="hs-identifier hs-var hs-var">primByteSize'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">4</span></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Integer)
-&gt; (PrimType -&gt; Integer) -&gt; PrimType -&gt; Integer
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Integer
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span>
</span><span id="line-240"></span><span>      </span><span id="local-6989586621684540413"><span class="annot"><span class="annottext">sumT' :: Integer
</span><a href="#local-6989586621684540413"><span class="hs-identifier hs-var hs-var">sumT'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; PrimType -&gt; Integer)
-&gt; Integer -&gt; [PrimType] -&gt; Integer
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684540412"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540412"><span class="hs-identifier hs-var">bytes</span></a></span></span><span> </span><span id="local-6989586621684540411"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540411"><span class="hs-identifier hs-var">typ</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540412"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Integer
</span><a href="#local-6989586621684540415"><span class="hs-identifier hs-var">primByteSize'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540411"><span class="hs-identifier hs-var">typ</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">4</span></span><span>
</span><span id="line-241"></span><span>      </span><span id="local-6989586621684540421"><span class="annot"><span class="annottext">maxT :: Integer
</span><a href="#local-6989586621684540421"><span class="hs-identifier hs-var hs-var">maxT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Integer] -&gt; Integer
forall (t :: * -&gt; *) a. (Foldable t, Ord a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">maximum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PrimType -&gt; Integer) -&gt; [PrimType] -&gt; [Integer]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Integer
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-242"></span><span>      </span><span class="hs-comment">-- TODO: Make these constants dynamic by querying device</span><span>
</span><span id="line-243"></span><span>      </span><span id="local-6989586621684540408"><span class="annot"><span class="annottext">k_reg :: Integer
</span><a href="#local-6989586621684540408"><span class="hs-identifier hs-var hs-var">k_reg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">64</span></span><span>
</span><span id="line-244"></span><span>      </span><span id="local-6989586621684540406"><span class="annot"><span class="annottext">k_mem :: Integer
</span><a href="#local-6989586621684540406"><span class="hs-identifier hs-var hs-var">k_mem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">95</span></span><span>
</span><span id="line-245"></span><span>      </span><span id="local-6989586621684540405"><span class="annot"><span class="annottext">mem_constraint :: Integer
</span><a href="#local-6989586621684540405"><span class="hs-identifier hs-var hs-var">mem_constraint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540406"><span class="hs-identifier hs-var">k_mem</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540422"><span class="hs-identifier hs-var">sumT</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540421"><span class="hs-identifier hs-var">maxT</span></a></span><span>
</span><span id="line-246"></span><span>      </span><span id="local-6989586621684540404"><span class="annot"><span class="annottext">reg_constraint :: Integer
</span><a href="#local-6989586621684540404"><span class="hs-identifier hs-var hs-var">reg_constraint</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540408"><span class="hs-identifier hs-var">k_reg</span></a></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540413"><span class="hs-identifier hs-var">sumT'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Integral a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">`div`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540413"><span class="hs-identifier hs-var">sumT'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>      </span><span id="local-6989586621684540403"><span class="annot"><a href="#local-6989586621684540450"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Num</span></span><span> </span><span class="annot"><a href="#local-6989586621684540403"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684540403"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-248"></span><span>      </span><span id="local-6989586621684540450"><span class="annot"><span class="annottext">m :: forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer -&gt; a
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; a) -&gt; Integer -&gt; a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; Integer) -&gt; Integer -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; Integer -&gt; Integer
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">min</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540405"><span class="hs-identifier hs-var">mem_constraint</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540404"><span class="hs-identifier hs-var">reg_constraint</span></a></span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SegScan: number of elements processed sequentially per thread is m:&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SegScan: memory constraints is: &quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; TExp Int32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540405"><span class="hs-identifier hs-var">mem_constraint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SegScan: register constraints is: &quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; TExp Int32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540404"><span class="hs-identifier hs-var">reg_constraint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">)</span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;SegScan: sumT' is: &quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; TExp Int32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684540413"><span class="hs-identifier hs-var">sumT'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">)</span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-comment">-- Allocate the shared memory for output component</span><span>
</span><span id="line-256"></span><span>  </span><span id="local-6989586621684540392"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540392"><span class="hs-identifier hs-var">numThreads</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;numThreads&quot;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540449"><span class="hs-identifier hs-var">num_threads</span></a></span><span>
</span><span id="line-257"></span><span>  </span><span id="local-6989586621684540391"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540391"><span class="hs-identifier hs-var">numGroups</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;numGroups&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64))
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540452"><span class="hs-identifier hs-var">num_groups</span></a></span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span>  </span><span id="local-6989586621684540390"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540390"><span class="hs-identifier hs-var">globalId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Space
-&gt; PrimType
-&gt; ArrayContents
-&gt; ImpM GPUMem HostEnv HostOp VName
forall rep r op.
String -&gt; Space -&gt; PrimType -&gt; ArrayContents -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sStaticArray"><span class="hs-identifier hs-var">sStaticArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;id_counter&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span> </span><span class="annot"><span class="annottext">(ArrayContents -&gt; ImpM GPUMem HostEnv HostOp VName)
-&gt; ArrayContents -&gt; ImpM GPUMem HostEnv HostOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ArrayContents
</span><a href="Futhark.CodeGen.ImpCode.html#ArrayZeros"><span class="hs-identifier hs-var">Imp.ArrayZeros</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-260"></span><span>  </span><span id="local-6989586621684540387"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540387"><span class="hs-identifier hs-var">statusFlags</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; ShapeBase SubExp
-&gt; Space
-&gt; ImpM GPUMem HostEnv HostOp VName
forall rep r op.
String
-&gt; PrimType -&gt; ShapeBase SubExp -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var">sAllocArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;status_flags&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int8"><span class="hs-identifier hs-var">int8</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540391"><span class="hs-identifier hs-var">numGroups</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684540385"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540385"><span class="hs-identifier hs-var">aggregateArrays</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540384"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540384"><span class="hs-identifier hs-var">incprefixArrays</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-262"></span><span>    </span><span class="annot"><span class="annottext">([(VName, VName)] -&gt; ([VName], [VName]))
-&gt; ImpM GPUMem HostEnv HostOp [(VName, VName)]
-&gt; ImpM GPUMem HostEnv HostOp ([VName], [VName])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[(VName, VName)] -&gt; ([VName], [VName])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem HostEnv HostOp [(VName, VName)]
 -&gt; ImpM GPUMem HostEnv HostOp ([VName], [VName]))
-&gt; ImpM GPUMem HostEnv HostOp [(VName, VName)]
-&gt; ImpM GPUMem HostEnv HostOp ([VName], [VName])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-263"></span><span>      </span><span class="annot"><span class="annottext">[PrimType]
-&gt; (PrimType -&gt; ImpM GPUMem HostEnv HostOp (VName, VName))
-&gt; ImpM GPUMem HostEnv HostOp [(VName, VName)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">((PrimType -&gt; ImpM GPUMem HostEnv HostOp (VName, VName))
 -&gt; ImpM GPUMem HostEnv HostOp [(VName, VName)])
-&gt; (PrimType -&gt; ImpM GPUMem HostEnv HostOp (VName, VName))
-&gt; ImpM GPUMem HostEnv HostOp [(VName, VName)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684540383"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540383"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-264"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; VName -&gt; (VName, VName))
-&gt; ImpM GPUMem HostEnv HostOp VName
-&gt; ImpM GPUMem HostEnv HostOp (VName -&gt; (VName, VName))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; ShapeBase SubExp
-&gt; Space
-&gt; ImpM GPUMem HostEnv HostOp VName
forall rep r op.
String
-&gt; PrimType -&gt; ShapeBase SubExp -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var">sAllocArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;aggregates&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540383"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540391"><span class="hs-identifier hs-var">numGroups</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span>          </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp (VName -&gt; (VName, VName))
-&gt; ImpM GPUMem HostEnv HostOp VName
-&gt; ImpM GPUMem HostEnv HostOp (VName, VName)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; ShapeBase SubExp
-&gt; Space
-&gt; ImpM GPUMem HostEnv HostOp VName
forall rep r op.
String
-&gt; PrimType -&gt; ShapeBase SubExp -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var">sAllocArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;incprefixes&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540383"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540391"><span class="hs-identifier hs-var">numGroups</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; SubExp -&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sReplicate"><span class="hs-identifier hs-var">sReplicate</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540387"><span class="hs-identifier hs-var">statusFlags</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; CallKernelGen ()) -&gt; SubExp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int8"><span class="hs-identifier hs-var">Int8</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540431"><span class="hs-identifier hs-var">statusX</span></a></span><span>
</span><span id="line-268"></span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; Count NumGroups (TPrimExp Int64 VName)
-&gt; Count GroupSize (TPrimExp Int64 VName)
-&gt; VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelThread"><span class="hs-identifier hs-var">sKernelThread</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segscan&quot;</span></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540452"><span class="hs-identifier hs-var">num_groups</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540458"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684540463"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp () -&gt; CallKernelGen ())
-&gt; ImpM GPUMem KernelEnv KernelOp () -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-270"></span><span>    </span><span id="local-6989586621684540378"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelConstants)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp KernelConstants
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-271"></span><span>
</span><span id="line-272"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684540375"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540375"><span class="hs-identifier hs-var">sharedId</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540374"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540374"><span class="hs-identifier hs-var">transposedArrays</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540373"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540373"><span class="hs-identifier hs-var">prefixArrays</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540372"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540372"><span class="hs-identifier hs-var">warpscan</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540371"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540371"><span class="hs-identifier hs-var">exchanges</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-273"></span><span>      </span><span class="annot"><span class="annottext">Count GroupSize SubExp
-&gt; SubExp
-&gt; [PrimType]
-&gt; InKernelGen (VName, [VName], [VName], VName, [VName])
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#createLocalArrays"><span class="hs-identifier hs-var">createLocalArrays</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegLevel -&gt; Count GroupSize SubExp
</span><a href="Futhark.IR.GPU.Op.html#segGroupSize"><span class="hs-identifier hs-var hs-var">segGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684540464"><span class="hs-identifier hs-var">lvl</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-274"></span><span>
</span><span id="line-275"></span><span>    </span><span id="local-6989586621684540369"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dynamic_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-276"></span><span>    </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-277"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684540368"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540368"><span class="hs-identifier hs-var">globalIdMem</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540367"><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540367"><span class="hs-identifier hs-var">globalIdOff</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (VName, Space, Count Elements (TPrimExp Int64 VName))
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM
     rep r op (VName, Space, Count Elements (TPrimExp Int64 VName))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray"><span class="hs-identifier hs-var">fullyIndexArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540390"><span class="hs-identifier hs-var">globalId</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-278"></span><span>      </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-279"></span><span>        </span><span class="annot"><span class="annottext">Space -&gt; AtomicOp -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Atomic"><span class="hs-identifier hs-var">Imp.Atomic</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(AtomicOp -&gt; KernelOp) -&gt; AtomicOp -&gt; KernelOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-280"></span><span>          </span><span class="annot"><span class="annottext">IntType
-&gt; VName
-&gt; VName
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; Exp
-&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicAdd"><span class="hs-identifier hs-var">Imp.AtomicAdd</span></a></span><span>
</span><span id="line-281"></span><span>            </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span>
</span><span id="line-282"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>            </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540368"><span class="hs-identifier hs-var">globalIdMem</span></a></span><span>
</span><span id="line-284"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Count Elements (TPrimExp Int64 VName)
forall u e. e -&gt; Count u e
</span><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-var">Count</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; Count Elements (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName -&gt; Count Elements (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540367"><span class="hs-identifier hs-var">globalIdOff</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>      </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540375"><span class="hs-identifier hs-var">sharedId</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-287"></span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540360"><span class="annot"><span class="annottext">localBarrier :: KernelOp
</span><a href="#local-6989586621684540360"><span class="hs-identifier hs-var hs-var">localBarrier</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-289"></span><span>        </span><span id="local-6989586621684540359"><span class="annot"><span class="annottext">localFence :: KernelOp
</span><a href="#local-6989586621684540359"><span class="hs-identifier hs-var hs-var">localFence</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#MemFence"><span class="hs-identifier hs-var">Imp.MemFence</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-290"></span><span>        </span><span id="local-6989586621684540357"><span class="annot"><span class="annottext">globalFence :: KernelOp
</span><a href="#local-6989586621684540357"><span class="hs-identifier hs-var hs-var">globalFence</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#MemFence"><span class="hs-identifier hs-var">Imp.MemFence</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceGlobal"><span class="hs-identifier hs-var">Imp.FenceGlobal</span></a></span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span>    </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540360"><span class="hs-identifier hs-var">localBarrier</span></a></span><span>
</span><span id="line-293"></span><span>    </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540375"><span class="hs-identifier hs-var">sharedId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-294"></span><span>    </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540360"><span class="hs-identifier hs-var">localBarrier</span></a></span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span>    </span><span id="local-6989586621684540356"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540356"><span class="hs-identifier hs-var">blockOff</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-297"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;blockOff&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-298"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-299"></span><span>    </span><span id="local-6989586621684540354"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540354"><span class="hs-identifier hs-var">sgmIdx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;sgm_idx&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540356"><span class="hs-identifier hs-var">blockOff</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. IntegralExp a =&gt; a -&gt; a -&gt; a
</span><a href="Futhark.Util.IntegralExp.html#mod"><span class="hs-operator hs-var">`mod`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540438"><span class="hs-identifier hs-var">segment_size</span></a></span><span>
</span><span id="line-300"></span><span>    </span><span id="local-6989586621684540352"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540352"><span class="hs-identifier hs-var">boundary</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-301"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;boundary&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32))
-&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-302"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; TExp Int32)
-&gt; TPrimExp Int64 VName -&gt; TExp Int32
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall v. TPrimExp Int64 v -&gt; TPrimExp Int64 v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sMin64"><span class="hs-identifier hs-var">sMin64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540458"><span class="hs-identifier hs-var">group_size</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540438"><span class="hs-identifier hs-var">segment_size</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540354"><span class="hs-identifier hs-var">sgmIdx</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>    </span><span id="local-6989586621684540349"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540349"><span class="hs-identifier hs-var">segsize_compact</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-304"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segsize_compact&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32))
-&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-305"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; TExp Int32)
-&gt; TPrimExp Int64 VName -&gt; TExp Int32
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall v. TPrimExp Int64 v -&gt; TPrimExp Int64 v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sMin64"><span class="hs-identifier hs-var">sMin64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540458"><span class="hs-identifier hs-var">group_size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540438"><span class="hs-identifier hs-var">segment_size</span></a></span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621684540348"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540348"><span class="hs-identifier hs-var">privateArrays</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-307"></span><span>      </span><span class="annot"><span class="annottext">[PrimType]
-&gt; (PrimType -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; ImpM GPUMem KernelEnv KernelOp [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">((PrimType -&gt; ImpM GPUMem KernelEnv KernelOp VName)
 -&gt; ImpM GPUMem KernelEnv KernelOp [VName])
-&gt; (PrimType -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; ImpM GPUMem KernelEnv KernelOp [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684540347"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540347"><span class="hs-identifier hs-var">ty</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-308"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; ShapeBase SubExp
-&gt; Space
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String
-&gt; PrimType -&gt; ShapeBase SubExp -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var">sAllocArray</span></a></span><span>
</span><span id="line-309"></span><span>          </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;private&quot;</span></span><span>
</span><span id="line-310"></span><span>          </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540347"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-311"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-312"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; PrimType -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#ScalarSpace"><span class="hs-identifier hs-var">ScalarSpace</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540347"><span class="hs-identifier hs-var">ty</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>
</span><span id="line-314"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Load and map&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-315"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; (TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">((TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; (TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684540344"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540344"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-316"></span><span>        </span><span class="hs-comment">-- The map's input index</span><span>
</span><span id="line-317"></span><span>        </span><span id="local-6989586621684540343"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540343"><span class="hs-identifier hs-var">phys_tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-318"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;phys_tid&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-319"></span><span>            </span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540356"><span class="hs-identifier hs-var">blockOff</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-320"></span><span>              </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540344"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-321"></span><span>        </span><span class="annot"><span class="annottext">[(VName, TPrimExp Int64 VName)]
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
[(VName, TPrimExp Int64 VName)]
-&gt; TPrimExp Int64 VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace"><span class="hs-identifier hs-var">dIndexSpace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
-&gt; [TPrimExp Int64 VName] -&gt; [(VName, TPrimExp Int64 VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540448"><span class="hs-identifier hs-var">gtids</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684540444"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540343"><span class="hs-identifier hs-var">phys_tid</span></a></span><span>
</span><span id="line-322"></span><span>        </span><span class="hs-comment">-- Perform the map</span><span>
</span><span id="line-323"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540341"><span class="annot"><span class="annottext">in_bounds :: ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540341"><span class="hs-identifier hs-var hs-var">in_bounds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-324"></span><span>              </span><span class="annot"><span class="annottext">Names
-&gt; Stms GPUMem
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Stms GPUMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684540461"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-325"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684540338"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684540338"><span class="hs-identifier hs-var">all_scan_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540337"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684540337"><span class="hs-identifier hs-var">map_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp GPUMem] -&gt; Int
forall rep. [SegBinOp rep] -&gt; Int
</span><a href="Futhark.IR.SegOp.html#segBinOpResults"><span class="hs-identifier hs-var">segBinOpResults</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540462"><span class="hs-identifier hs-var">scanOp</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; ([KernelResult], [KernelResult]))
-&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684540461"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span>                </span><span class="hs-comment">-- Write map results to their global memory destinations</span><span>
</span><span id="line-328"></span><span>                </span><span class="annot"><span class="annottext">[(PatElemT (MemInfo SubExp NoUniqueness MemBind), KernelResult)]
-&gt; ((PatElemT (MemInfo SubExp NoUniqueness MemBind), KernelResult)
    -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [KernelResult]
-&gt; [(PatElemT (MemInfo SubExp NoUniqueness MemBind), KernelResult)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
-&gt; [PatElemT (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [PatElemT (MemInfo SubExp NoUniqueness MemBind)]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#takeLast"><span class="hs-identifier hs-var">takeLast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[KernelResult] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684540337"><span class="hs-identifier hs-var">map_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684540459"><span class="hs-identifier hs-var">all_pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684540337"><span class="hs-identifier hs-var">map_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT (MemInfo SubExp NoUniqueness MemBind), KernelResult)
  -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((PatElemT (MemInfo SubExp NoUniqueness MemBind), KernelResult)
    -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540334"><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540334"><span class="hs-identifier hs-var">dest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540333"><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684540333"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-329"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684540334"><span class="hs-identifier hs-var">dest</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TPrimExp Int64 VName)
-&gt; [VName] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540448"><span class="hs-identifier hs-var">gtids</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684540333"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-330"></span><span>
</span><span id="line-331"></span><span>                </span><span class="hs-comment">-- Write to-scan results to private memory.</span><span>
</span><span id="line-332"></span><span>                </span><span class="annot"><span class="annottext">[(VName, SubExp)]
-&gt; ((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540348"><span class="hs-identifier hs-var">privateArrays</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(VName, SubExp)]) -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(KernelResult -&gt; SubExp) -&gt; [KernelResult] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684540338"><span class="hs-identifier hs-var">all_scan_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540330"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540330"><span class="hs-identifier hs-var">dest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540329"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540329"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-333"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540330"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540344"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540329"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span>            </span><span id="local-6989586621684540328"><span class="annot"><span class="annottext">out_of_bounds :: ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540328"><span class="hs-identifier hs-var hs-var">out_of_bounds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-336"></span><span>              </span><span class="annot"><span class="annottext">[(VName, SubExp)]
-&gt; ((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540348"><span class="hs-identifier hs-var">privateArrays</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684540436"><span class="hs-identifier hs-var">scanOpNe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540327"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540327"><span class="hs-identifier hs-var">dest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540326"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540326"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-337"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540327"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540344"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540326"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-338"></span><span>
</span><span id="line-339"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540343"><span class="hs-identifier hs-var">phys_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540455"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540341"><span class="hs-identifier hs-var">in_bounds</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540328"><span class="hs-identifier hs-var">out_of_bounds</span></a></span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Transpose scan inputs&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-342"></span><span>      </span><span class="annot"><span class="annottext">[(VName, VName)]
-&gt; ((VName, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [(VName, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540374"><span class="hs-identifier hs-var">transposedArrays</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540348"><span class="hs-identifier hs-var">privateArrays</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540325"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540325"><span class="hs-identifier hs-var">trans</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540324"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540324"><span class="hs-identifier hs-var">priv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-343"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540360"><span class="hs-identifier hs-var">localBarrier</span></a></span><span>
</span><span id="line-344"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; (TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">((TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; (TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684540323"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540323"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-345"></span><span>          </span><span id="local-6989586621684540322"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540322"><span class="hs-identifier hs-var">sharedIdx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-346"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;sharedIdx&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-347"></span><span>              </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>                </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540323"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-349"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540325"><span class="hs-identifier hs-var">trans</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540322"><span class="hs-identifier hs-var">sharedIdx</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540324"><span class="hs-identifier hs-var">priv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540323"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-350"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540360"><span class="hs-identifier hs-var">localBarrier</span></a></span><span>
</span><span id="line-351"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; TExp Int32
-&gt; (TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">((TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; (TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684540321"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540321"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-352"></span><span>          </span><span id="local-6989586621684540320"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540320"><span class="hs-identifier hs-var">sharedIdx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;sharedIdx&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32))
-&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540321"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-353"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540324"><span class="hs-identifier hs-var">priv</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540321"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540325"><span class="hs-identifier hs-var">trans</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TPrimExp Int64 VName)
-&gt; TExp Int32 -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540320"><span class="hs-identifier hs-var">sharedIdx</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-354"></span><span>      </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540360"><span class="hs-identifier hs-var">localBarrier</span></a></span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Per thread scan&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-357"></span><span>      </span><span class="hs-comment">-- We don't need to touch the first element, so only m-1</span><span>
</span><span id="line-358"></span><span>      </span><span class="hs-comment">-- iterations here.</span><span>
</span><span id="line-359"></span><span>      </span><span id="local-6989586621684540319"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540319"><span class="hs-identifier hs-var">globalIdx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-360"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;gidx&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32))
-&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-361"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span>
</span><span id="line-362"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; (TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; (TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684540318"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540318"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-363"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540317"><span class="annot"><span class="annottext">xs :: [VName]
</span><a href="#local-6989586621684540317"><span class="hs-identifier hs-var hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName)
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName])
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; [LParam GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#xParams"><span class="hs-identifier hs-var">xParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540462"><span class="hs-identifier hs-var">scanOp</span></a></span><span>
</span><span id="line-364"></span><span>            </span><span id="local-6989586621684540316"><span class="annot"><span class="annottext">ys :: [VName]
</span><a href="#local-6989586621684540316"><span class="hs-identifier hs-var hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName)
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName])
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; [LParam GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#yParams"><span class="hs-identifier hs-var">yParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540462"><span class="hs-identifier hs-var">scanOp</span></a></span><span>
</span><span id="line-365"></span><span>        </span><span class="hs-comment">-- determine if start of segment</span><span>
</span><span id="line-366"></span><span>        </span><span id="local-6989586621684540315"><span class="annot"><span class="annottext">TPrimExp Bool VName
</span><a href="#local-6989586621684540315"><span class="hs-identifier hs-var">new_sgm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-367"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684540443"><span class="hs-identifier hs-var">segmented</span></a></span><span>
</span><span id="line-368"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Bool VName)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;new_sgm&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Bool VName
 -&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Bool VName))
-&gt; TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Bool VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540319"><span class="hs-identifier hs-var">globalIdx</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540318"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540352"><span class="hs-identifier hs-var">boundary</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. IntegralExp a =&gt; a -&gt; a -&gt; a
</span><a href="Futhark.Util.IntegralExp.html#mod"><span class="hs-operator hs-var">`mod`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540349"><span class="hs-identifier hs-var">segsize_compact</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span>
</span><span id="line-369"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Bool VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
forall v. TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#false"><span class="hs-identifier hs-var">false</span></a></span><span>
</span><span id="line-370"></span><span>        </span><span class="hs-comment">-- skip scan of first element in segment</span><span>
</span><span id="line-371"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sUnless"><span class="hs-identifier hs-var">sUnless</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
</span><a href="#local-6989586621684540315"><span class="hs-identifier hs-var">new_sgm</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-372"></span><span>          </span><span class="annot"><span class="annottext">[(VName, (VName, VName, PrimType))]
-&gt; ((VName, (VName, VName, PrimType))
    -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
-&gt; [(VName, VName, PrimType)]
-&gt; [(VName, (VName, VName, PrimType))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540348"><span class="hs-identifier hs-var">privateArrays</span></a></span><span> </span><span class="annot"><span class="annottext">([(VName, VName, PrimType)] -&gt; [(VName, (VName, VName, PrimType))])
-&gt; [(VName, VName, PrimType)]
-&gt; [(VName, (VName, VName, PrimType))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [PrimType] -&gt; [(VName, VName, PrimType)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540317"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540316"><span class="hs-identifier hs-var">ys</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, (VName, VName, PrimType))
  -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, (VName, VName, PrimType))
    -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540312"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540312"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684540311"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540311"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540310"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540310"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540309"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540309"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-373"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540311"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540309"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-374"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540310"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540309"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-375"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540311"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540312"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540318"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-376"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540310"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540312"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540318"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-377"></span><span>
</span><span id="line-378"></span><span>          </span><span class="annot"><span class="annottext">Names
-&gt; Stms GPUMem
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; Stms GPUMem) -&gt; Body GPUMem -&gt; Stms GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT GPUMem -&gt; Body GPUMem) -&gt; LambdaT GPUMem -&gt; Body GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; LambdaT GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540462"><span class="hs-identifier hs-var">scanOp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-379"></span><span>            </span><span class="annot"><span class="annottext">[(VName, SubExp)]
-&gt; ((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540348"><span class="hs-identifier hs-var">privateArrays</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(VName, SubExp)]) -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; [SubExpRes]) -&gt; Body GPUMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT GPUMem -&gt; Body GPUMem) -&gt; LambdaT GPUMem -&gt; Body GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; LambdaT GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540462"><span class="hs-identifier hs-var">scanOp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540304"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540304"><span class="hs-identifier hs-var">dest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540303"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540303"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-380"></span><span>              </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540304"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540318"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540303"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Publish results in shared memory&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-383"></span><span>      </span><span class="annot"><span class="annottext">[(VName, VName)]
-&gt; ((VName, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [(VName, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540373"><span class="hs-identifier hs-var">prefixArrays</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540348"><span class="hs-identifier hs-var">privateArrays</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540302"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540302"><span class="hs-identifier hs-var">dest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540301"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540301"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-384"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540302"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TPrimExp Int64 VName)
-&gt; TExp Int32 -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540301"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-385"></span><span>      </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540360"><span class="hs-identifier hs-var">localBarrier</span></a></span><span>
</span><span id="line-386"></span><span>
</span><span id="line-387"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540300"><span class="annot"><span class="annottext">crossesSegment :: Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName)
</span><a href="#local-6989586621684540300"><span class="hs-identifier hs-var hs-var">crossesSegment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-388"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684540443"><span class="hs-identifier hs-var">segmented</span></a></span><span>
</span><span id="line-389"></span><span>          </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName)
-&gt; Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">((TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName)
 -&gt; Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName))
-&gt; (TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName)
-&gt; Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684540299"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540299"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621684540298"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540298"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-390"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540297"><span class="annot"><span class="annottext">from' :: TExp Int32
</span><a href="#local-6989586621684540297"><span class="hs-identifier hs-var hs-var">from'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540299"><span class="hs-identifier hs-var">from</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span>
</span><span id="line-391"></span><span>                </span><span id="local-6989586621684540296"><span class="annot"><span class="annottext">to' :: TExp Int32
</span><a href="#local-6989586621684540296"><span class="hs-identifier hs-var hs-var">to'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540298"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span>
</span><span id="line-392"></span><span>             </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540296"><span class="hs-identifier hs-var">to'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540297"><span class="hs-identifier hs-var">from'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3E."><span class="hs-operator hs-var">.&gt;.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540296"><span class="hs-identifier hs-var">to'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540349"><span class="hs-identifier hs-var">segsize_compact</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540352"><span class="hs-identifier hs-var">boundary</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. IntegralExp a =&gt; a -&gt; a -&gt; a
</span><a href="Futhark.Util.IntegralExp.html#mod"><span class="hs-operator hs-var">`mod`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540349"><span class="hs-identifier hs-var">segsize_compact</span></a></span><span>
</span><span id="line-393"></span><span>
</span><span id="line-394"></span><span>    </span><span id="local-6989586621684540294"><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540294"><span class="hs-identifier hs-var">scanOp'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; ImpM GPUMem KernelEnv KernelOp (LambdaT GPUMem)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">(LambdaT GPUMem -&gt; ImpM GPUMem KernelEnv KernelOp (LambdaT GPUMem))
-&gt; LambdaT GPUMem
-&gt; ImpM GPUMem KernelEnv KernelOp (LambdaT GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; LambdaT GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684540462"><span class="hs-identifier hs-var">scanOp</span></a></span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span>    </span><span id="local-6989586621684540292"><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540292"><span class="hs-identifier hs-var">accs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any))
-&gt; [PrimType] -&gt; ImpM GPUMem KernelEnv KernelOp [TV Any]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;acc&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span>
</span><span id="line-397"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Scan results (with warp scan)&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-398"></span><span>      </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName)
-&gt; TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName
-&gt; LambdaT GPUMem
-&gt; [VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupScan"><span class="hs-identifier hs-var">groupScan</span></a></span><span>
</span><span id="line-399"></span><span>        </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName)
</span><a href="#local-6989586621684540300"><span class="hs-identifier hs-var">crossesSegment</span></a></span><span>
</span><span id="line-400"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540392"><span class="hs-identifier hs-var">numThreads</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-401"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>        </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540294"><span class="hs-identifier hs-var">scanOp'</span></a></span><span>
</span><span id="line-403"></span><span>        </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540373"><span class="hs-identifier hs-var">prefixArrays</span></a></span><span>
</span><span id="line-404"></span><span>
</span><span id="line-405"></span><span>      </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540360"><span class="hs-identifier hs-var">localBarrier</span></a></span><span>
</span><span id="line-406"></span><span>
</span><span id="line-407"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540290"><span class="annot"><span class="annottext">firstThread :: TV Any -&gt; VName -&gt; ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540290"><span class="hs-identifier hs-var hs-var">firstThread</span></a></span></span><span> </span><span id="local-6989586621684540289"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540289"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684540288"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540288"><span class="hs-identifier hs-var">prefixes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-408"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540289"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540288"><span class="hs-identifier hs-var">prefixes</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-409"></span><span>          </span><span id="local-6989586621684540287"><span class="annot"><span class="annottext">notFirstThread :: TV Any -&gt; VName -&gt; ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540287"><span class="hs-identifier hs-var hs-var">notFirstThread</span></a></span></span><span> </span><span id="local-6989586621684540286"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540286"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684540285"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540285"><span class="hs-identifier hs-var">prefixes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-410"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540286"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540285"><span class="hs-identifier hs-var">prefixes</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-411"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span>
</span><span id="line-412"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TV Any -&gt; VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; [TV Any] -&gt; [VName] -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">TV Any -&gt; VName -&gt; ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540290"><span class="hs-identifier hs-var">firstThread</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540292"><span class="hs-identifier hs-var">accs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540373"><span class="hs-identifier hs-var">prefixArrays</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-414"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TV Any -&gt; VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; [TV Any] -&gt; [VName] -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">TV Any -&gt; VName -&gt; ImpM GPUMem KernelEnv KernelOp ()
</span><a href="#local-6989586621684540287"><span class="hs-identifier hs-var">notFirstThread</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540292"><span class="hs-identifier hs-var">accs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540373"><span class="hs-identifier hs-var">prefixArrays</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span>      </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540360"><span class="hs-identifier hs-var">localBarrier</span></a></span><span>
</span><span id="line-417"></span><span>
</span><span id="line-418"></span><span>    </span><span id="local-6989586621684540284"><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540284"><span class="hs-identifier hs-var">prefixes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(SubExp, PrimType)]
-&gt; ((SubExp, PrimType) -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any))
-&gt; ImpM GPUMem KernelEnv KernelOp [TV Any]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; [PrimType] -&gt; [(SubExp, PrimType)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684540436"><span class="hs-identifier hs-var">scanOpNe</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SubExp, PrimType) -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any))
 -&gt; ImpM GPUMem KernelEnv KernelOp [TV Any])
-&gt; ((SubExp, PrimType) -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any))
-&gt; ImpM GPUMem KernelEnv KernelOp [TV Any]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540283"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540283"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540282"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540282"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-419"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;prefix&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any))
-&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TExp Any
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; TExp Any) -&gt; Exp -&gt; TExp Any
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; Exp
forall a. ToExp a =&gt; PrimType -&gt; a -&gt; Exp
</span><a href="Futhark.CodeGen.ImpGen.html#toExp%27"><span class="hs-identifier hs-var">toExp'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540282"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540283"><span class="hs-identifier hs-var">ne</span></a></span><span>
</span><span id="line-420"></span><span>    </span><span id="local-6989586621684540279"><span class="annot"><span class="annottext">TPrimExp Bool VName
</span><a href="#local-6989586621684540279"><span class="hs-identifier hs-var">blockNewSgm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Bool VName)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;block_new_sgm&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Bool VName
 -&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Bool VName))
-&gt; TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Bool VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540354"><span class="hs-identifier hs-var">sgmIdx</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span>
</span><span id="line-421"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Perform lookback&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-422"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Bool VName
</span><a href="#local-6989586621684540279"><span class="hs-identifier hs-var">blockNewSgm</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; TPrimExp Bool VName -&gt; TPrimExp Bool VName
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-423"></span><span>        </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-424"></span><span>          </span><span class="annot"><span class="annottext">[(TV Any, VName)]
-&gt; ((TV Any, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TV Any] -&gt; [VName] -&gt; [(TV Any, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540292"><span class="hs-identifier hs-var">accs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540384"><span class="hs-identifier hs-var">incprefixArrays</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((TV Any, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((TV Any, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540277"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540277"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540276"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540276"><span class="hs-identifier hs-var">incprefixArray</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-425"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540276"><span class="hs-identifier hs-var">incprefixArray</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540277"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-426"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540357"><span class="hs-identifier hs-var">globalFence</span></a></span><span>
</span><span id="line-427"></span><span>        </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-428"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540387"><span class="hs-identifier hs-var">statusFlags</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int8"><span class="hs-identifier hs-var">Int8</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540429"><span class="hs-identifier hs-var">statusP</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-429"></span><span>        </span><span class="annot"><span class="annottext">[(SubExp, TV Any)]
-&gt; ((SubExp, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; [TV Any] -&gt; [(SubExp, TV Any)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684540436"><span class="hs-identifier hs-var">scanOpNe</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540292"><span class="hs-identifier hs-var">accs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SubExp, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((SubExp, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540275"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540275"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540274"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540274"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-430"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540274"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540275"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-431"></span><span>      </span><span class="hs-comment">-- end sWhen</span><span>
</span><span id="line-432"></span><span>
</span><span id="line-433"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540273"><span class="annot"><span class="annottext">warpSize :: TExp Int32
</span><a href="#local-6989586621684540273"><span class="hs-identifier hs-var hs-var">warpSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelWaveSize"><span class="hs-identifier hs-var hs-var">kernelWaveSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-434"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; TPrimExp Bool VName
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#bNot"><span class="hs-identifier hs-var">bNot</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
</span><a href="#local-6989586621684540279"><span class="hs-identifier hs-var">blockNewSgm</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; TPrimExp Bool VName -&gt; TPrimExp Bool VName
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540273"><span class="hs-identifier hs-var">warpSize</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-435"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-436"></span><span>          </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span>
</span><span id="line-437"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Bool VName
</span><a href="#local-6989586621684540441"><span class="hs-identifier hs-var">not_segmented_e</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; TPrimExp Bool VName -&gt; TPrimExp Bool VName
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%7C%7C."><span class="hs-operator hs-var">.||.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540352"><span class="hs-identifier hs-var">boundary</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540458"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-439"></span><span>                </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-440"></span><span>                  </span><span class="annot"><span class="annottext">[(VName, TV Any)]
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [TV Any] -&gt; [(VName, TV Any)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540385"><span class="hs-identifier hs-var">aggregateArrays</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540292"><span class="hs-identifier hs-var">accs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540270"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540270"><span class="hs-identifier hs-var">aggregateArray</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540269"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540269"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-441"></span><span>                    </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540270"><span class="hs-identifier hs-var">aggregateArray</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540269"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-442"></span><span>                </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540357"><span class="hs-identifier hs-var">globalFence</span></a></span><span>
</span><span id="line-443"></span><span>                </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-444"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540387"><span class="hs-identifier hs-var">statusFlags</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int8"><span class="hs-identifier hs-var">Int8</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540430"><span class="hs-identifier hs-var">statusA</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-445"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-447"></span><span>                </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-448"></span><span>                  </span><span class="annot"><span class="annottext">[(VName, TV Any)]
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [TV Any] -&gt; [(VName, TV Any)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540384"><span class="hs-identifier hs-var">incprefixArrays</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540292"><span class="hs-identifier hs-var">accs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540268"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540268"><span class="hs-identifier hs-var">incprefixArray</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540267"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540267"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-449"></span><span>                    </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540268"><span class="hs-identifier hs-var">incprefixArray</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540267"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-450"></span><span>                </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540357"><span class="hs-identifier hs-var">globalFence</span></a></span><span>
</span><span id="line-451"></span><span>                </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-452"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540387"><span class="hs-identifier hs-var">statusFlags</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int8"><span class="hs-identifier hs-var">Int8</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540429"><span class="hs-identifier hs-var">statusP</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-453"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-454"></span><span>          </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-455"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540372"><span class="hs-identifier hs-var">warpscan</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540387"><span class="hs-identifier hs-var">statusFlags</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-456"></span><span>        </span><span class="hs-comment">-- sWhen</span><span>
</span><span id="line-457"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540359"><span class="hs-identifier hs-var">localFence</span></a></span><span>
</span><span id="line-458"></span><span>
</span><span id="line-459"></span><span>        </span><span id="local-6989586621684540266"><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540266"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int8)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;status&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int8"><span class="hs-identifier hs-var">int8</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int8</span></span><span class="hs-special">)</span><span>
</span><span id="line-460"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540266"><span class="hs-identifier hs-var">status</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540372"><span class="hs-identifier hs-var">warpscan</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-461"></span><span>
</span><span id="line-462"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span>
</span><span id="line-463"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; TPrimExp Int8 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540266"><span class="hs-identifier hs-var">status</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName -&gt; TPrimExp Int8 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540429"><span class="hs-identifier hs-var">statusP</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-465"></span><span>              </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-466"></span><span>                </span><span class="annot"><span class="annottext">[(TV Any, VName)]
-&gt; ((TV Any, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TV Any] -&gt; [VName] -&gt; [(TV Any, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540284"><span class="hs-identifier hs-var">prefixes</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540384"><span class="hs-identifier hs-var">incprefixArrays</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((TV Any, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((TV Any, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540265"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540265"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540264"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540264"><span class="hs-identifier hs-var">incprefixArray</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-467"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540265"><span class="hs-identifier hs-var">prefix</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540264"><span class="hs-identifier hs-var">incprefixArray</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-468"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-470"></span><span>              </span><span id="local-6989586621684540263"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540263"><span class="hs-identifier hs-var">readOffset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-471"></span><span>                </span><span class="annot"><span class="annottext">String -&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;readOffset&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32))
-&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-472"></span><span>                  </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; TExp Int32)
-&gt; TPrimExp Int64 VName -&gt; TExp Int32
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelWaveSize"><span class="hs-identifier hs-var hs-var">kernelWaveSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540262"><span class="annot"><span class="annottext">loopStop :: TExp Int32
</span><a href="#local-6989586621684540262"><span class="hs-identifier hs-var hs-var">loopStop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540273"><span class="hs-identifier hs-var">warpSize</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-474"></span><span>                  </span><span id="local-6989586621684540261"><span class="annot"><span class="annottext">sameSegment :: TV Int32 -&gt; TPrimExp Bool VName
</span><a href="#local-6989586621684540261"><span class="hs-identifier hs-var hs-var">sameSegment</span></a></span></span><span> </span><span id="local-6989586621684540260"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540260"><span class="hs-identifier hs-var">readIdx</span></a></span></span><span>
</span><span id="line-475"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684540443"><span class="hs-identifier hs-var">segmented</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-476"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540259"><span class="annot"><span class="annottext">startIdx :: TPrimExp Int64 VName
</span><a href="#local-6989586621684540259"><span class="hs-identifier hs-var hs-var">startIdx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540260"><span class="hs-identifier hs-var">readIdx</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span>
</span><span id="line-477"></span><span>                       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540356"><span class="hs-identifier hs-var">blockOff</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540259"><span class="hs-identifier hs-var">startIdx</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C%3D."><span class="hs-operator hs-var">.&lt;=.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540354"><span class="hs-identifier hs-var">sgmIdx</span></a></span><span>
</span><span id="line-478"></span><span>                    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
forall v. TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#true"><span class="hs-identifier hs-var">true</span></a></span><span>
</span><span id="line-479"></span><span>              </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhile"><span class="hs-identifier hs-var">sWhile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540263"><span class="hs-identifier hs-var">readOffset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3E."><span class="hs-operator hs-var">.&gt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540262"><span class="hs-identifier hs-var">loopStop</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-480"></span><span>                </span><span id="local-6989586621684540258"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540258"><span class="hs-identifier hs-var">readI</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;read_i&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32))
-&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int32)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540263"><span class="hs-identifier hs-var">readOffset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-481"></span><span>                </span><span id="local-6989586621684540257"><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540257"><span class="hs-identifier hs-var">aggrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(SubExp, PrimType)]
-&gt; ((SubExp, PrimType) -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any))
-&gt; ImpM GPUMem KernelEnv KernelOp [TV Any]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; [PrimType] -&gt; [(SubExp, PrimType)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684540436"><span class="hs-identifier hs-var">scanOpNe</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SubExp, PrimType) -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any))
 -&gt; ImpM GPUMem KernelEnv KernelOp [TV Any])
-&gt; ((SubExp, PrimType) -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any))
-&gt; ImpM GPUMem KernelEnv KernelOp [TV Any]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540256"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540256"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540255"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540255"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-482"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;aggr&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any))
-&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TExp Any
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; TExp Any) -&gt; Exp -&gt; TExp Any
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; Exp
forall a. ToExp a =&gt; PrimType -&gt; a -&gt; Exp
</span><a href="Futhark.CodeGen.ImpGen.html#toExp%27"><span class="hs-identifier hs-var">toExp'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540255"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540256"><span class="hs-identifier hs-var">ne</span></a></span><span>
</span><span id="line-483"></span><span>                </span><span id="local-6989586621684540254"><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540254"><span class="hs-identifier hs-var">flag</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int8 VName -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int8)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;flag&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int8 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540431"><span class="hs-identifier hs-var">statusX</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int8</span></span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>                </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; (ImpM GPUMem KernelEnv KernelOp ()
    -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540258"><span class="hs-identifier hs-var">readI</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3E%3D."><span class="hs-operator hs-var">.&gt;=.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-485"></span><span>                  </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span>
</span><span id="line-486"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; TPrimExp Bool VName
</span><a href="#local-6989586621684540261"><span class="hs-identifier hs-var">sameSegment</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540258"><span class="hs-identifier hs-var">readI</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-487"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-488"></span><span>                        </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540254"><span class="hs-identifier hs-var">flag</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540387"><span class="hs-identifier hs-var">statusFlags</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TPrimExp Int64 VName)
-&gt; TExp Int32 -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540258"><span class="hs-identifier hs-var">readI</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-489"></span><span>                        </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span>
</span><span id="line-490"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; TPrimExp Int8 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540254"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName -&gt; TPrimExp Int8 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540429"><span class="hs-identifier hs-var">statusP</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-491"></span><span>                          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[(VName, TV Any)]
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [TV Any] -&gt; [(VName, TV Any)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540384"><span class="hs-identifier hs-var">incprefixArrays</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540257"><span class="hs-identifier hs-var">aggrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540252"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540252"><span class="hs-identifier hs-var">incprefix</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540251"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540251"><span class="hs-identifier hs-var">aggr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-492"></span><span>                              </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540251"><span class="hs-identifier hs-var">aggr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540252"><span class="hs-identifier hs-var">incprefix</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TPrimExp Int64 VName)
-&gt; TExp Int32 -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540258"><span class="hs-identifier hs-var">readI</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-493"></span><span>                          </span><span class="hs-special">)</span><span>
</span><span id="line-494"></span><span>                          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; TPrimExp Int8 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540254"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName -&gt; TPrimExp Int8 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540430"><span class="hs-identifier hs-var">statusA</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-495"></span><span>                              </span><span class="annot"><span class="annottext">[(TV Any, VName)]
-&gt; ((TV Any, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TV Any] -&gt; [VName] -&gt; [(TV Any, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540257"><span class="hs-identifier hs-var">aggrs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540385"><span class="hs-identifier hs-var">aggregateArrays</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((TV Any, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((TV Any, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540250"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540250"><span class="hs-identifier hs-var">aggr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540249"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540249"><span class="hs-identifier hs-var">aggregate</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-496"></span><span>                                </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540250"><span class="hs-identifier hs-var">aggr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540249"><span class="hs-identifier hs-var">aggregate</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TPrimExp Int64 VName)
-&gt; TExp Int32 -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540258"><span class="hs-identifier hs-var">readI</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-497"></span><span>                          </span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540254"><span class="hs-identifier hs-var">flag</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int8"><span class="hs-identifier hs-var">Int8</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540429"><span class="hs-identifier hs-var">statusP</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-500"></span><span>                </span><span class="hs-comment">-- end sIf</span><span>
</span><span id="line-501"></span><span>                </span><span class="hs-comment">-- end sWhen</span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span>                </span><span class="annot"><span class="annottext">[(VName, TV Any)]
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [TV Any] -&gt; [(VName, TV Any)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540371"><span class="hs-identifier hs-var">exchanges</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540257"><span class="hs-identifier hs-var">aggrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540248"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540248"><span class="hs-identifier hs-var">exchange</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540247"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540247"><span class="hs-identifier hs-var">aggr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-504"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540248"><span class="hs-identifier hs-var">exchange</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TPrimExp Int64 VName)
-&gt; TExp Int32 -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540247"><span class="hs-identifier hs-var">aggr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-505"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540372"><span class="hs-identifier hs-var">warpscan</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TPrimExp Int64 VName)
-&gt; TExp Int32 -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540254"><span class="hs-identifier hs-var">flag</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-506"></span><span>
</span><span id="line-507"></span><span>                </span><span class="hs-comment">-- execute warp-parallel reduction but only if the last read flag in not STATUS_P</span><span>
</span><span id="line-508"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540254"><span class="hs-identifier hs-var">flag</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540372"><span class="hs-identifier hs-var">warpscan</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540273"><span class="hs-identifier hs-var">warpSize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-509"></span><span>                </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; TPrimExp Int8 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540254"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName -&gt; TPrimExp Int8 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int8 VName
</span><span class="hs-number">2</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int8</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-510"></span><span>                  </span><span id="local-6989586621684540246"><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540246"><span class="hs-identifier hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; ImpM GPUMem KernelEnv KernelOp (LambdaT GPUMem)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540294"><span class="hs-identifier hs-var">scanOp'</span></a></span><span>
</span><span id="line-511"></span><span>                  </span><span class="annot"><span class="annottext">KernelConstants
-&gt; TPrimExp Int64 VName
-&gt; VName
-&gt; [VName]
-&gt; LambdaT GPUMem
-&gt; ImpM GPUMem KernelEnv KernelOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.SinglePass.html#inBlockScanLookback"><span class="hs-identifier hs-var">inBlockScanLookback</span></a></span><span>
</span><span id="line-512"></span><span>                    </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-513"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540392"><span class="hs-identifier hs-var">numThreads</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-514"></span><span>                    </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540372"><span class="hs-identifier hs-var">warpscan</span></a></span><span>
</span><span id="line-515"></span><span>                    </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540371"><span class="hs-identifier hs-var">exchanges</span></a></span><span>
</span><span id="line-516"></span><span>                    </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540246"><span class="hs-identifier hs-var">lam'</span></a></span><span>
</span><span id="line-517"></span><span>
</span><span id="line-518"></span><span>                </span><span class="hs-comment">-- all threads of the warp read the result of reduction</span><span>
</span><span id="line-519"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540254"><span class="hs-identifier hs-var">flag</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540372"><span class="hs-identifier hs-var">warpscan</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540273"><span class="hs-identifier hs-var">warpSize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-520"></span><span>                </span><span class="annot"><span class="annottext">[(TV Any, VName)]
-&gt; ((TV Any, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TV Any] -&gt; [VName] -&gt; [(TV Any, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540257"><span class="hs-identifier hs-var">aggrs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540371"><span class="hs-identifier hs-var">exchanges</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((TV Any, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((TV Any, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540245"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540245"><span class="hs-identifier hs-var">aggr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540244"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540244"><span class="hs-identifier hs-var">exchange</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-521"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540245"><span class="hs-identifier hs-var">aggr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540244"><span class="hs-identifier hs-var">exchange</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540273"><span class="hs-identifier hs-var">warpSize</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-522"></span><span>                </span><span class="hs-comment">-- update read offset</span><span>
</span><span id="line-523"></span><span>                </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span>
</span><span id="line-524"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; TPrimExp Int8 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540254"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName -&gt; TPrimExp Int8 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540429"><span class="hs-identifier hs-var">statusP</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-525"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540263"><span class="hs-identifier hs-var">readOffset</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540262"><span class="hs-identifier hs-var">loopStop</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-526"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; TPrimExp Int8 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540254"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName -&gt; TPrimExp Int8 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540430"><span class="hs-identifier hs-var">statusA</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-527"></span><span>                      </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540263"><span class="hs-identifier hs-var">readOffset</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684540263"><span class="hs-identifier hs-var">readOffset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#zExt32"><span class="hs-identifier hs-var">zExt32</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540273"><span class="hs-identifier hs-var">warpSize</span></a></span><span>
</span><span id="line-528"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>
</span><span id="line-530"></span><span>                </span><span class="hs-comment">-- update prefix if flag different than STATUS_X:</span><span>
</span><span id="line-531"></span><span>                </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int8 -&gt; TPrimExp Int8 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int8
</span><a href="#local-6989586621684540254"><span class="hs-identifier hs-var">flag</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int8 VName -&gt; TPrimExp Int8 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3E."><span class="hs-operator hs-var">.&gt;.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int8 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540431"><span class="hs-identifier hs-var">statusX</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int8</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-532"></span><span>                  </span><span id="local-6989586621684540242"><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540242"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; ImpM GPUMem KernelEnv KernelOp (LambdaT GPUMem)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540294"><span class="hs-identifier hs-var">scanOp'</span></a></span><span>
</span><span id="line-533"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684540241"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540241"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540240"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540240"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; ([VName], [VName])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PrimType] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; ([VName], [VName])) -&gt; [VName] -&gt; ([VName], [VName])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName)
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName])
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540242"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-534"></span><span>                  </span><span class="annot"><span class="annottext">[(VName, TV Any)]
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [TV Any] -&gt; [(VName, TV Any)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540241"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540257"><span class="hs-identifier hs-var">aggrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540239"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540239"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540238"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540238"><span class="hs-identifier hs-var">aggr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540239"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; TExp Any
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540238"><span class="hs-identifier hs-var">aggr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-535"></span><span>                  </span><span class="annot"><span class="annottext">[(VName, TV Any)]
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [TV Any] -&gt; [(VName, TV Any)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540240"><span class="hs-identifier hs-var">ys</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540284"><span class="hs-identifier hs-var">prefixes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540236"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540236"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540235"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540235"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540236"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; TExp Any
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540235"><span class="hs-identifier hs-var">prefix</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-536"></span><span>                  </span><span class="annot"><span class="annottext">Names
-&gt; Stms GPUMem
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; Stms GPUMem) -&gt; Body GPUMem -&gt; Stms GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540242"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-537"></span><span>                    </span><span class="annot"><span class="annottext">[(TV Any, PrimType, SubExp)]
-&gt; ((TV Any, PrimType, SubExp)
    -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TV Any] -&gt; [PrimType] -&gt; [SubExp] -&gt; [(TV Any, PrimType, SubExp)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540284"><span class="hs-identifier hs-var">prefixes</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(TV Any, PrimType, SubExp)])
-&gt; [SubExp] -&gt; [(TV Any, PrimType, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; [SubExpRes]) -&gt; Body GPUMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540242"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((TV Any, PrimType, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((TV Any, PrimType, SubExp)
    -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-538"></span><span>                      </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540234"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540234"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540233"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540233"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540232"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540232"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540234"><span class="hs-identifier hs-var">prefix</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any -&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TExp Any
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; Exp
forall a. ToExp a =&gt; PrimType -&gt; a -&gt; Exp
</span><a href="Futhark.CodeGen.ImpGen.html#toExp%27"><span class="hs-identifier hs-var">toExp'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540233"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540232"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-539"></span><span>                </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540359"><span class="hs-identifier hs-var">localFence</span></a></span><span>
</span><span id="line-540"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span>        </span><span class="hs-comment">-- end sWhile</span><span>
</span><span id="line-542"></span><span>        </span><span class="hs-comment">-- end sIf</span><span>
</span><span id="line-543"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-544"></span><span>          </span><span id="local-6989586621684540231"><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540231"><span class="hs-identifier hs-var">scanOp''''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; ImpM GPUMem KernelEnv KernelOp (LambdaT GPUMem)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540294"><span class="hs-identifier hs-var">scanOp'</span></a></span><span>
</span><span id="line-545"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684540230"><span class="annot"><span class="annottext">xs :: [VName]
</span><a href="#local-6989586621684540230"><span class="hs-identifier hs-var hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName)
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName])
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PrimType] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param (MemInfo SubExp NoUniqueness MemBind)]
 -&gt; [Param (MemInfo SubExp NoUniqueness MemBind)])
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540231"><span class="hs-identifier hs-var">scanOp''''</span></a></span><span>
</span><span id="line-546"></span><span>              </span><span id="local-6989586621684540229"><span class="annot"><span class="annottext">ys :: [VName]
</span><a href="#local-6989586621684540229"><span class="hs-identifier hs-var hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName)
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName])
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PrimType] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param (MemInfo SubExp NoUniqueness MemBind)]
 -&gt; [Param (MemInfo SubExp NoUniqueness MemBind)])
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540231"><span class="hs-identifier hs-var">scanOp''''</span></a></span><span>
</span><span id="line-547"></span><span>          </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540352"><span class="hs-identifier hs-var">boundary</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540458"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-548"></span><span>            </span><span class="annot"><span class="annottext">[(VName, TV Any)]
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [TV Any] -&gt; [(VName, TV Any)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540230"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540284"><span class="hs-identifier hs-var">prefixes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540228"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540228"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540227"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540227"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540228"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Any -&gt; TExp Any
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540227"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-549"></span><span>            </span><span class="annot"><span class="annottext">[(VName, TV Any)]
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [TV Any] -&gt; [(VName, TV Any)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540229"><span class="hs-identifier hs-var">ys</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540292"><span class="hs-identifier hs-var">accs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540226"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540226"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540225"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540225"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540226"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Any -&gt; TExp Any
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540225"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-550"></span><span>            </span><span class="annot"><span class="annottext">Names
-&gt; Stms GPUMem
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; Stms GPUMem) -&gt; Body GPUMem -&gt; Stms GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540231"><span class="hs-identifier hs-var">scanOp''''</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-551"></span><span>              </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-552"></span><span>                </span><span class="annot"><span class="annottext">[(VName, SubExp)]
-&gt; ((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540384"><span class="hs-identifier hs-var">incprefixArrays</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(VName, SubExp)]) -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; [SubExpRes]) -&gt; Body GPUMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540231"><span class="hs-identifier hs-var">scanOp''''</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-553"></span><span>                  </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540224"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540224"><span class="hs-identifier hs-var">incprefixArray</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540223"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540223"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540224"><span class="hs-identifier hs-var">incprefixArray</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540223"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-554"></span><span>            </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540357"><span class="hs-identifier hs-var">globalFence</span></a></span><span>
</span><span id="line-555"></span><span>            </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var">everythingVolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540387"><span class="hs-identifier hs-var">statusFlags</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int8"><span class="hs-identifier hs-var">Int8</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540429"><span class="hs-identifier hs-var">statusP</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-556"></span><span>          </span><span class="annot"><span class="annottext">[(VName, TV Any)]
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [TV Any] -&gt; [(VName, TV Any)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540371"><span class="hs-identifier hs-var">exchanges</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540284"><span class="hs-identifier hs-var">prefixes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540222"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540222"><span class="hs-identifier hs-var">exchange</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540221"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540221"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-557"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540222"><span class="hs-identifier hs-var">exchange</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540221"><span class="hs-identifier hs-var">prefix</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-558"></span><span>          </span><span class="annot"><span class="annottext">[(TV Any, PrimType, SubExp)]
-&gt; ((TV Any, PrimType, SubExp)
    -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TV Any] -&gt; [PrimType] -&gt; [SubExp] -&gt; [(TV Any, PrimType, SubExp)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540292"><span class="hs-identifier hs-var">accs</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684540436"><span class="hs-identifier hs-var">scanOpNe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((TV Any, PrimType, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((TV Any, PrimType, SubExp)
    -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540220"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540220"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540219"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540219"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540218"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540218"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-559"></span><span>            </span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540220"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Exp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. VName -&gt; Exp -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator hs-var">&lt;~~</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; Exp
forall a. ToExp a =&gt; PrimType -&gt; a -&gt; Exp
</span><a href="Futhark.CodeGen.ImpGen.html#toExp%27"><span class="hs-identifier hs-var">toExp'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540219"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540218"><span class="hs-identifier hs-var">ne</span></a></span><span>
</span><span id="line-560"></span><span>      </span><span class="hs-comment">-- end sWhen</span><span>
</span><span id="line-561"></span><span>      </span><span class="hs-comment">-- end sWhen</span><span>
</span><span id="line-562"></span><span>
</span><span id="line-563"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; TPrimExp Bool VName
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#bNot"><span class="hs-identifier hs-var">bNot</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Bool VName -&gt; TPrimExp Bool VName)
-&gt; TPrimExp Bool VName -&gt; TPrimExp Bool VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-564"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540360"><span class="hs-identifier hs-var">localBarrier</span></a></span><span>
</span><span id="line-565"></span><span>        </span><span class="annot"><span class="annottext">[(VName, TV Any)]
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [TV Any] -&gt; [(VName, TV Any)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540371"><span class="hs-identifier hs-var">exchanges</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540284"><span class="hs-identifier hs-var">prefixes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540216"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540216"><span class="hs-identifier hs-var">exchange</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540215"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540215"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-566"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540215"><span class="hs-identifier hs-var">prefix</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540216"><span class="hs-identifier hs-var">exchange</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-567"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540360"><span class="hs-identifier hs-var">localBarrier</span></a></span><span>
</span><span id="line-568"></span><span>    </span><span class="hs-comment">-- end sWhen</span><span>
</span><span id="line-569"></span><span>    </span><span class="hs-comment">-- end sComment</span><span>
</span><span id="line-570"></span><span>
</span><span id="line-571"></span><span>    </span><span id="local-6989586621684540214"><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540214"><span class="hs-identifier hs-var">scanOp'''''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; ImpM GPUMem KernelEnv KernelOp (LambdaT GPUMem)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540294"><span class="hs-identifier hs-var">scanOp'</span></a></span><span>
</span><span id="line-572"></span><span>    </span><span id="local-6989586621684540213"><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540213"><span class="hs-identifier hs-var">scanOp''''''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; ImpM GPUMem KernelEnv KernelOp (LambdaT GPUMem)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540294"><span class="hs-identifier hs-var">scanOp'</span></a></span><span>
</span><span id="line-573"></span><span>
</span><span id="line-574"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Distribute results&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-575"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684540212"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540212"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540211"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540211"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; ([VName], [VName])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PrimType] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; ([VName], [VName])) -&gt; [VName] -&gt; ([VName], [VName])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName)
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName])
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540214"><span class="hs-identifier hs-var">scanOp'''''</span></a></span><span>
</span><span id="line-576"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684540210"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540210"><span class="hs-identifier hs-var">xs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540209"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540209"><span class="hs-identifier hs-var">ys'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; ([VName], [VName])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PrimType] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; ([VName], [VName])) -&gt; [VName] -&gt; ([VName], [VName])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName)
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName])
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540213"><span class="hs-identifier hs-var">scanOp''''''</span></a></span><span>
</span><span id="line-577"></span><span>
</span><span id="line-578"></span><span>      </span><span class="annot"><span class="annottext">[((TV Any, TV Any), (VName, VName), (VName, VName), PrimType)]
-&gt; (((TV Any, TV Any), (VName, VName), (VName, VName), PrimType)
    -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(TV Any, TV Any)]
-&gt; [(VName, VName)]
-&gt; [(VName, VName)]
-&gt; [PrimType]
-&gt; [((TV Any, TV Any), (VName, VName), (VName, VName), PrimType)]
forall a b c d. [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [(a, b, c, d)]
</span><span class="hs-identifier hs-var">zip4</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TV Any] -&gt; [TV Any] -&gt; [(TV Any, TV Any)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540284"><span class="hs-identifier hs-var">prefixes</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540292"><span class="hs-identifier hs-var">accs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [(VName, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540212"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540210"><span class="hs-identifier hs-var">xs'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [(VName, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540211"><span class="hs-identifier hs-var">ys</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540209"><span class="hs-identifier hs-var">ys'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((((TV Any, TV Any), (VName, VName), (VName, VName), PrimType)
  -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; (((TV Any, TV Any), (VName, VName), (VName, VName), PrimType)
    -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-579"></span><span>        </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684540208"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540208"><span class="hs-identifier hs-var">prefix</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540207"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540207"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684540206"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540206"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540205"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540205"><span class="hs-identifier hs-var">x'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684540204"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540204"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540203"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540203"><span class="hs-identifier hs-var">y'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540202"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540202"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-580"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540206"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540202"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-581"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540204"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540202"><span class="hs-identifier hs-var">ty</span></a></span><span>
</span><span id="line-582"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540205"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Any -&gt; TExp Any
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540208"><span class="hs-identifier hs-var">prefix</span></a></span><span>
</span><span id="line-583"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540203"><span class="hs-identifier hs-var">y'</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; TExp Any -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Any -&gt; TExp Any
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540207"><span class="hs-identifier hs-var">acc</span></a></span><span>
</span><span id="line-584"></span><span>
</span><span id="line-585"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span>
</span><span id="line-586"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540352"><span class="hs-identifier hs-var">boundary</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; TPrimExp Bool VName -&gt; TPrimExp Bool VName
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; TPrimExp Bool VName
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#bNot"><span class="hs-identifier hs-var">bNot</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
</span><a href="#local-6989586621684540279"><span class="hs-identifier hs-var">blockNewSgm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-587"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Names
-&gt; Stms GPUMem
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; Stms GPUMem) -&gt; Body GPUMem -&gt; Stms GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540213"><span class="hs-identifier hs-var">scanOp''''''</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-588"></span><span>            </span><span class="annot"><span class="annottext">[(VName, PrimType, SubExp)]
-&gt; ((VName, PrimType, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [PrimType] -&gt; [SubExp] -&gt; [(VName, PrimType, SubExp)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540212"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimType]
</span><a href="#local-6989586621684540435"><span class="hs-identifier hs-var">tys</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(VName, PrimType, SubExp)])
-&gt; [SubExp] -&gt; [(VName, PrimType, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; [SubExpRes]) -&gt; Body GPUMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540213"><span class="hs-identifier hs-var">scanOp''''''</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, PrimType, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, PrimType, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-589"></span><span>              </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540201"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540201"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540200"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540200"><span class="hs-identifier hs-var">ty</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540199"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540199"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540201"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Exp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. VName -&gt; Exp -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator hs-var">&lt;~~</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; Exp
forall a. ToExp a =&gt; PrimType -&gt; a -&gt; Exp
</span><a href="Futhark.CodeGen.ImpGen.html#toExp%27"><span class="hs-identifier hs-var">toExp'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684540200"><span class="hs-identifier hs-var">ty</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540199"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-590"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-591"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(VName, TV Any)]
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [TV Any] -&gt; [(VName, TV Any)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540212"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[TV Any]
</span><a href="#local-6989586621684540292"><span class="hs-identifier hs-var">accs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, TV Any) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540198"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540198"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540197"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540197"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540198"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684540197"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-592"></span><span>      </span><span class="hs-comment">-- calculate where previous thread stopped, to determine number of</span><span>
</span><span id="line-593"></span><span>      </span><span class="hs-comment">-- elements left before new segment.</span><span>
</span><span id="line-594"></span><span>      </span><span id="local-6989586621684540196"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540196"><span class="hs-identifier hs-var">stop</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-595"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;stopping_point&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32))
-&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-596"></span><span>          </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540349"><span class="hs-identifier hs-var">segsize_compact</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540349"><span class="hs-identifier hs-var">segsize_compact</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540352"><span class="hs-identifier hs-var">boundary</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. IntegralExp a =&gt; a -&gt; a -&gt; a
</span><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540349"><span class="hs-identifier hs-var">segsize_compact</span></a></span><span>
</span><span id="line-597"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; (TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">((TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; (TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684540195"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540195"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-598"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540195"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684540196"><span class="hs-identifier hs-var">stop</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-599"></span><span>          </span><span class="annot"><span class="annottext">[(VName, VName)]
-&gt; ((VName, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [(VName, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540348"><span class="hs-identifier hs-var">privateArrays</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540211"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540194"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540194"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540193"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540193"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-600"></span><span>            </span><span class="hs-comment">-- only include prefix for the first segment part per thread</span><span>
</span><span id="line-601"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540193"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540194"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540195"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-602"></span><span>          </span><span class="annot"><span class="annottext">Names
-&gt; Stms GPUMem
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; Stms GPUMem) -&gt; Body GPUMem -&gt; Stms GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540214"><span class="hs-identifier hs-var">scanOp'''''</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-603"></span><span>            </span><span class="annot"><span class="annottext">[(VName, SubExp)]
-&gt; ((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540348"><span class="hs-identifier hs-var">privateArrays</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(VName, SubExp)]) -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; [SubExpRes]) -&gt; Body GPUMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT GPUMem
</span><a href="#local-6989586621684540214"><span class="hs-identifier hs-var">scanOp'''''</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, SubExp) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-604"></span><span>              </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540192"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540192"><span class="hs-identifier hs-var">dest</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540191"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540191"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-605"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540192"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540195"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684540191"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-606"></span><span>
</span><span id="line-607"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Transpose scan output and Write it to global memory in coalesced fashion&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-608"></span><span>      </span><span class="annot"><span class="annottext">[(VName, VName, VName)]
-&gt; ((VName, VName, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName] -&gt; [(VName, VName, VName)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540374"><span class="hs-identifier hs-var">transposedArrays</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540348"><span class="hs-identifier hs-var">privateArrays</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [(VName, VName, VName)])
-&gt; [VName] -&gt; [(VName, VName, VName)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (MemInfo SubExp NoUniqueness MemBind) -&gt; VName)
-&gt; [PatElemT (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684540459"><span class="hs-identifier hs-var">all_pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, VName, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ((VName, VName, VName) -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684540190"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540190"><span class="hs-identifier hs-var">locmem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540189"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540189"><span class="hs-identifier hs-var">priv</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684540188"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540188"><span class="hs-identifier hs-var">dest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-609"></span><span>        </span><span class="hs-comment">--sOp localBarrier</span><span>
</span><span id="line-610"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; (TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">((TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; (TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684540187"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540187"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-611"></span><span>          </span><span id="local-6989586621684540186"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540186"><span class="hs-identifier hs-var">sharedIdx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-612"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;sharedIdx&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-613"></span><span>              </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540187"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-614"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540190"><span class="hs-identifier hs-var">locmem</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540186"><span class="hs-identifier hs-var">sharedIdx</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540189"><span class="hs-identifier hs-var">priv</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540187"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-615"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540360"><span class="hs-identifier hs-var">localBarrier</span></a></span><span>
</span><span id="line-616"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; (TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
forall a. Num a =&gt; a
</span><a href="#local-6989586621684540450"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">((TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; (TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684540185"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540185"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-617"></span><span>          </span><span id="local-6989586621684540184"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540184"><span class="hs-identifier hs-var">flat_idx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-618"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;flat_idx&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-619"></span><span>              </span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540356"><span class="hs-identifier hs-var">blockOff</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540185"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-620"></span><span>                </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684540378"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-621"></span><span>          </span><span class="annot"><span class="annottext">[(VName, TPrimExp Int64 VName)]
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
[(VName, TPrimExp Int64 VName)]
-&gt; TPrimExp Int64 VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace"><span class="hs-identifier hs-var">dIndexSpace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
-&gt; [TPrimExp Int64 VName] -&gt; [(VName, TPrimExp Int64 VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540448"><span class="hs-identifier hs-var">gtids</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684540444"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540184"><span class="hs-identifier hs-var">flat_idx</span></a></span><span>
</span><span id="line-622"></span><span>          </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540184"><span class="hs-identifier hs-var">flat_idx</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540455"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-623"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span>
</span><span id="line-624"></span><span>              </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540188"><span class="hs-identifier hs-var">dest</span></a></span><span>
</span><span id="line-625"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TPrimExp Int64 VName)
-&gt; [VName] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684540448"><span class="hs-identifier hs-var">gtids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-626"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540190"><span class="hs-identifier hs-var">locmem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-627"></span><span>              </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684540184"><span class="hs-identifier hs-var">flat_idx</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540356"><span class="hs-identifier hs-var">blockOff</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-628"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; ImpM GPUMem KernelEnv KernelOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><a href="#local-6989586621684540360"><span class="hs-identifier hs-var">localBarrier</span></a></span><span>
</span><span id="line-629"></span><span>
</span><span id="line-630"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;If this is the last block, reset the dynamicId&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-631"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684540369"><span class="hs-identifier hs-var">dynamicId</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684540452"><span class="hs-identifier hs-var">num_groups</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem KernelEnv KernelOp ()
 -&gt; ImpM GPUMem KernelEnv KernelOp ())
-&gt; ImpM GPUMem KernelEnv KernelOp ()
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-632"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM GPUMem KernelEnv KernelOp ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684540390"><span class="hs-identifier hs-var">globalId</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int32 -&gt; SubExp
forall v. IsValue v =&gt; v -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#constant"><span class="hs-identifier hs-var">constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int32
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-633"></span></pre></body></html>