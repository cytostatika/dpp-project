<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE Strict #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE Trustworthy #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-12"></span><span>
</span><span id="line-13"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.CodeGen.ImpGen</span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Entry Points</span></span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileProg"><span class="hs-identifier">compileProg</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Pluggable Compiler</span></span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#OpCompiler"><span class="hs-identifier">OpCompiler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ExpCompiler"><span class="hs-identifier">ExpCompiler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#CopyCompiler"><span class="hs-identifier">CopyCompiler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#StmsCompiler"><span class="hs-identifier">StmsCompiler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#AllocCompiler"><span class="hs-identifier">AllocCompiler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier">Operations</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defaultOperations"><span class="hs-identifier">defaultOperations</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier">MemLoc</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sliceMemLoc"><span class="hs-identifier">sliceMemLoc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemEntry"><span class="hs-identifier">MemEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarEntry"><span class="hs-identifier">ScalarEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Monadic Compiler Interface</span></span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier">ImpM</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#localDefaultSpace"><span class="hs-identifier">localDefaultSpace</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#askFunction"><span class="hs-identifier">askFunction</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#newVNameForFun"><span class="hs-identifier">newVNameForFun</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#nameForFun"><span class="hs-identifier">nameForFun</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier">askEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#localEnv"><span class="hs-identifier">localEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#localOps"><span class="hs-identifier">localOps</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VTable"><span class="hs-identifier">VTable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#getVTable"><span class="hs-identifier">getVTable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#localVTable"><span class="hs-identifier">localVTable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#subImpM"><span class="hs-identifier">subImpM</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#subImpM_"><span class="hs-identifier">subImpM_</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier">emit</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#emitFunction"><span class="hs-identifier">emitFunction</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#hasFunction"><span class="hs-identifier">hasFunction</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier">collect</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#collect%27"><span class="hs-identifier">collect'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#comment"><span class="hs-identifier">comment</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VarEntry"><span class="hs-identifier">VarEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayEntry"><span class="hs-identifier">ArrayEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Lookups</span></span><span>
</span><span id="line-54"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#lookupVar"><span class="hs-identifier">lookupVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#lookupArray"><span class="hs-identifier">lookupArray</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier">lookupMemory</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#lookupAcc"><span class="hs-identifier">lookupAcc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Building Blocks</span></span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier">TV</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#mkTV"><span class="hs-identifier">mkTV</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier">tvSize</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier">tvExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-64"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier">tvVar</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-65"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ToExp"><span class="hs-identifier">ToExp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-66"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileAlloc"><span class="hs-identifier">compileAlloc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-67"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier">everythingVolatile</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileBody"><span class="hs-identifier">compileBody</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileBody%27"><span class="hs-identifier">compileBody'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileLoopBody"><span class="hs-identifier">compileLoopBody</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileStms"><span class="hs-identifier">defCompileStms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-72"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier">compileStms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-73"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileExp"><span class="hs-identifier">compileExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileExp"><span class="hs-identifier">defCompileExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-75"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray"><span class="hs-identifier">fullyIndexArray</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-76"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray%27"><span class="hs-identifier">fullyIndexArray'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-77"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#copy"><span class="hs-identifier">copy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-78"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier">copyDWIM</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier">copyDWIMFix</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#copyElementWise"><span class="hs-identifier">copyElementWise</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-81"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#typeSize"><span class="hs-identifier">typeSize</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#inBounds"><span class="hs-identifier">inBounds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#isMapTransposeCopy"><span class="hs-identifier">isMapTransposeCopy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span>
</span><span id="line-85"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Constructing code.</span></span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier">dLParams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dFParams"><span class="hs-identifier">dFParams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-88"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dScope"><span class="hs-identifier">dScope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dArray"><span class="hs-identifier">dArray</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-90"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier">dPrim</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-91"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dPrimVol"><span class="hs-identifier">dPrimVol</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier">dPrim_</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-93"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier">dPrimV_</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-94"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier">dPrimV</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-95"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier">dPrimVE</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-96"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace"><span class="hs-identifier">dIndexSpace</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace%27"><span class="hs-identifier">dIndexSpace'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier">sFor</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-99"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sWhile"><span class="hs-identifier">sWhile</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-100"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier">sComment</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-101"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier">sIf</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-102"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier">sWhen</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-103"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sUnless"><span class="hs-identifier">sUnless</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier">sOp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sDeclareMem"><span class="hs-identifier">sDeclareMem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sAlloc"><span class="hs-identifier">sAlloc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-107"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sAlloc_"><span class="hs-identifier">sAlloc_</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-108"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sArray"><span class="hs-identifier">sArray</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-109"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sArrayInMem"><span class="hs-identifier">sArrayInMem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-110"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier">sAllocArray</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-111"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sAllocArrayPerm"><span class="hs-identifier">sAllocArrayPerm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sStaticArray"><span class="hs-identifier">sStaticArray</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-113"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sWrite"><span class="hs-identifier">sWrite</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-114"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sUpdate"><span class="hs-identifier">sUpdate</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-115"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier">sLoopNest</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-116"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator">(&lt;--)</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-117"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator">(&lt;~~)</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-118"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#function"><span class="hs-identifier">function</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-119"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#warn"><span class="hs-identifier">warn</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Language.Futhark.Warnings.html"><span class="hs-identifier">Language.Futhark.Warnings</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span class="hs-keyword">where</span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-125"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-126"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Writer</span></span><span>
</span><span id="line-127"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Parallel.Strategies</span></span><span>
</span><span id="line-128"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">first</span></span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.DList</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DL</span></span><span>
</span><span id="line-130"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Either</span></span><span>
</span><span id="line-131"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">find</span></span><span class="hs-special">)</span><span>
</span><span id="line-132"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-133"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-134"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-135"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.String</span></span><span>
</span><span id="line-136"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html"><span class="hs-identifier">Futhark.CodeGen.ImpCode</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Bytes"><span class="hs-identifier">Bytes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-138"></span><span>    </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier">Count</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-139"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Elements"><span class="hs-identifier">Elements</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#bytes"><span class="hs-identifier">bytes</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-141"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#elements"><span class="hs-identifier">elements</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-142"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#withElemType"><span class="hs-identifier">withElemType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-143"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html"><span class="hs-identifier">Futhark.CodeGen.ImpCode</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Imp</span></span><span>
</span><span id="line-145"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Transpose.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.Transpose</span></a></span><span>
</span><span id="line-146"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Construct.html"><span class="hs-identifier">Futhark.Construct</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Construct.html#ToExp"><span class="hs-identifier">ToExp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-147"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html"><span class="hs-identifier">Futhark.IR.Mem</span></a></span><span>
</span><span id="line-148"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html"><span class="hs-identifier">Futhark.IR.Mem.IxFun</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IxFun</span></span><span>
</span><span id="line-149"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html"><span class="hs-identifier">Futhark.IR.SOACS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier">SOACS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span>
</span><span id="line-151"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html"><span class="hs-identifier">Futhark.Util.IntegralExp</span></a></span><span>
</span><span id="line-152"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.Loc.html"><span class="hs-identifier">Futhark.Util.Loc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">noLoc</span></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.Warnings.html"><span class="hs-identifier">Language.Futhark.Warnings</span></a></span><span>
</span><span id="line-154"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">quot</span></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span class="hs-comment">-- | How to compile an t'Op'.</span><span>
</span><span id="line-157"></span><span class="hs-keyword">type</span><span> </span><span id="OpCompiler"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#OpCompiler"><span class="hs-identifier hs-var">OpCompiler</span></a></span></span><span> </span><span id="local-6989586621684529168"><span class="annot"><a href="#local-6989586621684529168"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684529167"><span class="annot"><a href="#local-6989586621684529167"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621684529166"><span class="annot"><a href="#local-6989586621684529166"><span class="hs-identifier hs-type">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529168"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529168"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529168"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529167"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529166"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span>
</span><span id="line-159"></span><span class="hs-comment">-- | How to compile some 'Stms'.</span><span>
</span><span id="line-160"></span><span class="hs-keyword">type</span><span> </span><span id="StmsCompiler"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#StmsCompiler"><span class="hs-identifier hs-var">StmsCompiler</span></a></span></span><span> </span><span id="local-6989586621684529165"><span class="annot"><a href="#local-6989586621684529165"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684529164"><span class="annot"><a href="#local-6989586621684529164"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621684529163"><span class="annot"><a href="#local-6989586621684529163"><span class="hs-identifier hs-type">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529165"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529165"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529164"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529163"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529165"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529164"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529163"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span class="hs-comment">-- | How to compile an 'Exp'.</span><span>
</span><span id="line-163"></span><span class="hs-keyword">type</span><span> </span><span id="ExpCompiler"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ExpCompiler"><span class="hs-identifier hs-var">ExpCompiler</span></a></span></span><span> </span><span id="local-6989586621684529162"><span class="annot"><a href="#local-6989586621684529162"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684529161"><span class="annot"><a href="#local-6989586621684529161"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621684529160"><span class="annot"><a href="#local-6989586621684529160"><span class="hs-identifier hs-type">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529162"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529162"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529162"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529161"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529160"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span class="hs-keyword">type</span><span> </span><span id="CopyCompiler"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#CopyCompiler"><span class="hs-identifier hs-var">CopyCompiler</span></a></span></span><span> </span><span id="local-6989586621684529159"><span class="annot"><a href="#local-6989586621684529159"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684529158"><span class="annot"><a href="#local-6989586621684529158"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621684529157"><span class="annot"><a href="#local-6989586621684529157"><span class="hs-identifier hs-type">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-166"></span><span>  </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-167"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-169"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529159"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529158"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529157"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span class="hs-comment">-- | An alternate way of compiling an allocation.</span><span>
</span><span id="line-172"></span><span class="hs-keyword">type</span><span> </span><span id="AllocCompiler"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#AllocCompiler"><span class="hs-identifier hs-var">AllocCompiler</span></a></span></span><span> </span><span id="local-6989586621684529156"><span class="annot"><a href="#local-6989586621684529156"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684529155"><span class="annot"><a href="#local-6989586621684529155"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621684529154"><span class="annot"><a href="#local-6989586621684529154"><span class="hs-identifier hs-type">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Bytes"><span class="hs-identifier hs-type">Bytes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529156"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529155"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529154"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-173"></span><span>
</span><span id="line-174"></span><span class="hs-keyword">data</span><span> </span><span id="Operations"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-var">Operations</span></a></span></span><span> </span><span id="local-6989586621684530707"><span class="annot"><a href="#local-6989586621684530707"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684530706"><span class="annot"><a href="#local-6989586621684530706"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621684530705"><span class="annot"><a href="#local-6989586621684530705"><span class="hs-identifier hs-type">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Operations"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-var">Operations</span></a></span></span><span>
</span><span id="line-175"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="opsExpCompiler"><span class="annot"><span class="annottext">forall rep r op. Operations rep r op -&gt; ExpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsExpCompiler"><span class="hs-identifier hs-var hs-var">opsExpCompiler</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ExpCompiler"><span class="hs-identifier hs-type">ExpCompiler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530707"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530706"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530705"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-176"></span><span>    </span><span id="opsOpCompiler"><span class="annot"><span class="annottext">forall rep r op. Operations rep r op -&gt; OpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsOpCompiler"><span class="hs-identifier hs-var hs-var">opsOpCompiler</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#OpCompiler"><span class="hs-identifier hs-type">OpCompiler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530707"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530706"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530705"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-177"></span><span>    </span><span id="opsStmsCompiler"><span class="annot"><span class="annottext">forall rep r op. Operations rep r op -&gt; StmsCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsStmsCompiler"><span class="hs-identifier hs-var hs-var">opsStmsCompiler</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#StmsCompiler"><span class="hs-identifier hs-type">StmsCompiler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530707"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530706"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530705"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-178"></span><span>    </span><span id="opsCopyCompiler"><span class="annot"><span class="annottext">forall rep r op. Operations rep r op -&gt; CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsCopyCompiler"><span class="hs-identifier hs-var hs-var">opsCopyCompiler</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#CopyCompiler"><span class="hs-identifier hs-type">CopyCompiler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530707"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530706"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530705"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-179"></span><span>    </span><span id="opsAllocCompilers"><span class="annot"><span class="annottext">forall rep r op.
Operations rep r op -&gt; Map Space (AllocCompiler rep r op)
</span><a href="Futhark.CodeGen.ImpGen.html#opsAllocCompilers"><span class="hs-identifier hs-var hs-var">opsAllocCompilers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#AllocCompiler"><span class="hs-identifier hs-type">AllocCompiler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530707"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530706"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530705"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-180"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">-- | An operations set for which the expression compiler always</span><span>
</span><span id="line-183"></span><span class="hs-comment">-- returns 'defCompileExp'.</span><span>
</span><span id="line-184"></span><span id="local-6989586621684530676"><span id="local-6989586621684530678"><span id="local-6989586621684530680"><span id="local-6989586621684530681"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defaultOperations"><span class="hs-identifier hs-type">defaultOperations</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-185"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530681"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530680"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#FreeIn"><span class="hs-identifier hs-type">FreeIn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530678"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-186"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#OpCompiler"><span class="hs-identifier hs-type">OpCompiler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530681"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530676"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530678"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-187"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-type">Operations</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530681"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530676"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530678"><span class="hs-identifier hs-type">op</span></a></span></span></span></span></span><span>
</span><span id="line-188"></span><span id="defaultOperations"><span class="annot"><span class="annottext">defaultOperations :: forall rep inner op r.
(Mem rep inner, FreeIn op) =&gt;
OpCompiler rep r op -&gt; Operations rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#defaultOperations"><span class="hs-identifier hs-var hs-var">defaultOperations</span></a></span></span><span> </span><span id="local-6989586621684529095"><span class="annot"><span class="annottext">OpCompiler rep r op
</span><a href="#local-6989586621684529095"><span class="hs-identifier hs-var">opc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><span class="annottext">Operations :: forall rep r op.
ExpCompiler rep r op
-&gt; OpCompiler rep r op
-&gt; StmsCompiler rep r op
-&gt; CopyCompiler rep r op
-&gt; Map Space (AllocCompiler rep r op)
-&gt; Operations rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-type">Operations</span></a></span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">opsExpCompiler :: ExpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsExpCompiler"><span class="hs-identifier hs-var">opsExpCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpCompiler rep r op
forall rep inner r op.
Mem rep inner =&gt;
Pat rep -&gt; Exp rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#defCompileExp"><span class="hs-identifier hs-var">defCompileExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-191"></span><span>      </span><span class="annot"><span class="annottext">opsOpCompiler :: OpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsOpCompiler"><span class="hs-identifier hs-var">opsOpCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OpCompiler rep r op
</span><a href="#local-6989586621684529095"><span class="hs-identifier hs-var">opc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-192"></span><span>      </span><span class="annot"><span class="annottext">opsStmsCompiler :: StmsCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsStmsCompiler"><span class="hs-identifier hs-var">opsStmsCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StmsCompiler rep r op
forall rep inner op r.
(Mem rep inner, FreeIn op) =&gt;
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#defCompileStms"><span class="hs-identifier hs-var">defCompileStms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-193"></span><span>      </span><span class="annot"><span class="annottext">opsCopyCompiler :: CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsCopyCompiler"><span class="hs-identifier hs-var">opsCopyCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CopyCompiler rep r op
forall rep r op. CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#defaultCopy"><span class="hs-identifier hs-var">defaultCopy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-194"></span><span>      </span><span class="annot"><span class="annottext">opsAllocCompilers :: Map Space (AllocCompiler rep r op)
</span><a href="Futhark.CodeGen.ImpGen.html#opsAllocCompilers"><span class="hs-identifier hs-var">opsAllocCompilers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Space (AllocCompiler rep r op)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-195"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-196"></span><span>
</span><span id="line-197"></span><span class="hs-comment">-- | When an array is declared, this is where it is stored.</span><span>
</span><span id="line-198"></span><span class="hs-keyword">data</span><span> </span><span id="MemLoc"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-var">MemLoc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MemLoc"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-var">MemLoc</span></a></span></span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="memLocName"><span class="annot"><span class="annottext">MemLoc -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#memLocName"><span class="hs-identifier hs-var hs-var">memLocName</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-200"></span><span>    </span><span id="memLocShape"><span class="annot"><span class="annottext">MemLoc -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.html#memLocShape"><span class="hs-identifier hs-var hs-var">memLocShape</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#DimSize"><span class="hs-identifier hs-type">Imp.DimSize</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-201"></span><span>    </span><span id="memLocIxFun"><span class="annot"><span class="annottext">MemLoc -&gt; IxFun (TExp Int64)
</span><a href="Futhark.CodeGen.ImpGen.html#memLocIxFun"><span class="hs-identifier hs-var hs-var">memLocIxFun</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun.IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span>
</span><span id="line-202"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684529079"><span id="local-6989586621684529087"><span class="annot"><span class="annottext">MemLoc -&gt; MemLoc -&gt; Bool
(MemLoc -&gt; MemLoc -&gt; Bool)
-&gt; (MemLoc -&gt; MemLoc -&gt; Bool) -&gt; Eq MemLoc
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: MemLoc -&gt; MemLoc -&gt; Bool
$c/= :: MemLoc -&gt; MemLoc -&gt; Bool
== :: MemLoc -&gt; MemLoc -&gt; Bool
$c== :: MemLoc -&gt; MemLoc -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684529061"><span id="local-6989586621684529063"><span id="local-6989586621684529075"><span class="annot"><span class="annottext">Int -&gt; MemLoc -&gt; ShowS
[MemLoc] -&gt; ShowS
MemLoc -&gt; [Char]
(Int -&gt; MemLoc -&gt; ShowS)
-&gt; (MemLoc -&gt; [Char]) -&gt; ([MemLoc] -&gt; ShowS) -&gt; Show MemLoc
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [MemLoc] -&gt; ShowS
$cshowList :: [MemLoc] -&gt; ShowS
show :: MemLoc -&gt; [Char]
$cshow :: MemLoc -&gt; [Char]
showsPrec :: Int -&gt; MemLoc -&gt; ShowS
$cshowsPrec :: Int -&gt; MemLoc -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sliceMemLoc"><span class="hs-identifier hs-type">sliceMemLoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span>
</span><span id="line-206"></span><span id="sliceMemLoc"><span class="annot"><span class="annottext">sliceMemLoc :: MemLoc -&gt; Slice (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#sliceMemLoc"><span class="hs-identifier hs-var hs-var">sliceMemLoc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span id="local-6989586621684529057"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684529057"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684529056"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684529056"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684529055"><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684529055"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684529054"><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684529054"><span class="hs-identifier hs-var">slice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; [SubExp] -&gt; IxFun (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-var">MemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684529057"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684529056"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">(IxFun (TExp Int64) -&gt; MemLoc) -&gt; IxFun (TExp Int64) -&gt; MemLoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64) -&gt; Slice (TExp Int64) -&gt; IxFun (TExp Int64)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; Slice num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#slice"><span class="hs-identifier hs-var">IxFun.slice</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684529055"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684529054"><span class="hs-identifier hs-var">slice</span></a></span><span>
</span><span id="line-208"></span><span>
</span><span id="line-209"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#flatSliceMemLoc"><span class="hs-identifier hs-type">flatSliceMemLoc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#FlatSlice"><span class="hs-identifier hs-type">FlatSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span>
</span><span id="line-210"></span><span id="flatSliceMemLoc"><span class="annot"><span class="annottext">flatSliceMemLoc :: MemLoc -&gt; FlatSlice (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#flatSliceMemLoc"><span class="hs-identifier hs-var hs-var">flatSliceMemLoc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span id="local-6989586621684529051"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684529051"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684529050"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684529050"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684529049"><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684529049"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684529048"><span class="annot"><span class="annottext">FlatSlice (TExp Int64)
</span><a href="#local-6989586621684529048"><span class="hs-identifier hs-var">slice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-211"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; [SubExp] -&gt; IxFun (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-var">MemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684529051"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684529050"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">(IxFun (TExp Int64) -&gt; MemLoc) -&gt; IxFun (TExp Int64) -&gt; MemLoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64) -&gt; FlatSlice (TExp Int64) -&gt; IxFun (TExp Int64)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; FlatSlice num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#flatSlice"><span class="hs-identifier hs-var">IxFun.flatSlice</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684529049"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">FlatSlice (TExp Int64)
</span><a href="#local-6989586621684529048"><span class="hs-identifier hs-var">slice</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="hs-keyword">data</span><span> </span><span id="ArrayEntry"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayEntry"><span class="hs-identifier hs-var">ArrayEntry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ArrayEntry"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayEntry"><span class="hs-identifier hs-var">ArrayEntry</span></a></span></span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="entryArrayLoc"><span class="annot"><span class="annottext">ArrayEntry -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var hs-var">entryArrayLoc</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-215"></span><span>    </span><span id="entryArrayElemType"><span class="annot"><span class="annottext">ArrayEntry -&gt; PrimType
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayElemType"><span class="hs-identifier hs-var hs-var">entryArrayElemType</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span>
</span><span id="line-216"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-217"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684529034"><span id="local-6989586621684529036"><span id="local-6989586621684529042"><span class="annot"><span class="annottext">Int -&gt; ArrayEntry -&gt; ShowS
[ArrayEntry] -&gt; ShowS
ArrayEntry -&gt; [Char]
(Int -&gt; ArrayEntry -&gt; ShowS)
-&gt; (ArrayEntry -&gt; [Char])
-&gt; ([ArrayEntry] -&gt; ShowS)
-&gt; Show ArrayEntry
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ArrayEntry] -&gt; ShowS
$cshowList :: [ArrayEntry] -&gt; ShowS
show :: ArrayEntry -&gt; [Char]
$cshow :: ArrayEntry -&gt; [Char]
showsPrec :: Int -&gt; ArrayEntry -&gt; ShowS
$cshowsPrec :: Int -&gt; ArrayEntry -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span>
</span><span id="line-219"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#entryArrayShape"><span class="hs-identifier hs-type">entryArrayShape</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayEntry"><span class="hs-identifier hs-type">ArrayEntry</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#DimSize"><span class="hs-identifier hs-type">Imp.DimSize</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-220"></span><span id="entryArrayShape"><span class="annot"><span class="annottext">entryArrayShape :: ArrayEntry -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayShape"><span class="hs-identifier hs-var hs-var">entryArrayShape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemLoc -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.html#memLocShape"><span class="hs-identifier hs-var hs-var">memLocShape</span></a></span><span> </span><span class="annot"><span class="annottext">(MemLoc -&gt; [SubExp])
-&gt; (ArrayEntry -&gt; MemLoc) -&gt; ArrayEntry -&gt; [SubExp]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ArrayEntry -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var hs-var">entryArrayLoc</span></a></span><span>
</span><span id="line-221"></span><span>
</span><span id="line-222"></span><span class="hs-keyword">newtype</span><span> </span><span id="MemEntry"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemEntry"><span class="hs-identifier hs-var">MemEntry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="MemEntry"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemEntry"><span class="hs-identifier hs-var">MemEntry</span></a></span></span><span> </span><span class="hs-special">{</span><span id="entryMemSpace"><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Imp.Space</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684529021"><span id="local-6989586621684529023"><span id="local-6989586621684529028"><span class="annot"><span class="annottext">Int -&gt; MemEntry -&gt; ShowS
[MemEntry] -&gt; ShowS
MemEntry -&gt; [Char]
(Int -&gt; MemEntry -&gt; ShowS)
-&gt; (MemEntry -&gt; [Char]) -&gt; ([MemEntry] -&gt; ShowS) -&gt; Show MemEntry
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [MemEntry] -&gt; ShowS
$cshowList :: [MemEntry] -&gt; ShowS
show :: MemEntry -&gt; [Char]
$cshow :: MemEntry -&gt; [Char]
showsPrec :: Int -&gt; MemEntry -&gt; ShowS
$cshowsPrec :: Int -&gt; MemEntry -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span class="hs-keyword">newtype</span><span> </span><span id="ScalarEntry"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarEntry"><span class="hs-identifier hs-var">ScalarEntry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ScalarEntry"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarEntry"><span class="hs-identifier hs-var">ScalarEntry</span></a></span></span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="entryScalarType"><span class="annot"><span class="annottext">ScalarEntry -&gt; PrimType
</span><a href="Futhark.CodeGen.ImpGen.html#entryScalarType"><span class="hs-identifier hs-var hs-var">entryScalarType</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span>
</span><span id="line-227"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-228"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684529011"><span id="local-6989586621684529013"><span id="local-6989586621684529017"><span class="annot"><span class="annottext">Int -&gt; ScalarEntry -&gt; ShowS
[ScalarEntry] -&gt; ShowS
ScalarEntry -&gt; [Char]
(Int -&gt; ScalarEntry -&gt; ShowS)
-&gt; (ScalarEntry -&gt; [Char])
-&gt; ([ScalarEntry] -&gt; ShowS)
-&gt; Show ScalarEntry
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ScalarEntry] -&gt; ShowS
$cshowList :: [ScalarEntry] -&gt; ShowS
show :: ScalarEntry -&gt; [Char]
$cshow :: ScalarEntry -&gt; [Char]
showsPrec :: Int -&gt; ScalarEntry -&gt; ShowS
$cshowsPrec :: Int -&gt; ScalarEntry -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span class="hs-comment">-- | Every non-scalar variable must be associated with an entry.</span><span>
</span><span id="line-231"></span><span class="hs-keyword">data</span><span> </span><span id="VarEntry"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VarEntry"><span class="hs-identifier hs-var">VarEntry</span></a></span></span><span> </span><span id="local-6989586621684530600"><span class="annot"><a href="#local-6989586621684530600"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="ArrayVar"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayVar"><span class="hs-identifier hs-var">ArrayVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530600"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayEntry"><span class="hs-identifier hs-type">ArrayEntry</span></a></span><span>
</span><span id="line-233"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ScalarVar"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-var">ScalarVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530600"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarEntry"><span class="hs-identifier hs-type">ScalarEntry</span></a></span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MemVar"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-var">MemVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530600"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemEntry"><span class="hs-identifier hs-type">MemEntry</span></a></span><span>
</span><span id="line-235"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="AccVar"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#AccVar"><span class="hs-identifier hs-var">AccVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530600"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684528983"><span id="local-6989586621684528985"><span id="local-6989586621684529005"><span class="annot"><span class="annottext">Int -&gt; VarEntry rep -&gt; ShowS
[VarEntry rep] -&gt; ShowS
VarEntry rep -&gt; [Char]
(Int -&gt; VarEntry rep -&gt; ShowS)
-&gt; (VarEntry rep -&gt; [Char])
-&gt; ([VarEntry rep] -&gt; ShowS)
-&gt; Show (VarEntry rep)
forall rep. RepTypes rep =&gt; Int -&gt; VarEntry rep -&gt; ShowS
forall rep. RepTypes rep =&gt; [VarEntry rep] -&gt; ShowS
forall rep. RepTypes rep =&gt; VarEntry rep -&gt; [Char]
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [VarEntry rep] -&gt; ShowS
$cshowList :: forall rep. RepTypes rep =&gt; [VarEntry rep] -&gt; ShowS
show :: VarEntry rep -&gt; [Char]
$cshow :: forall rep. RepTypes rep =&gt; VarEntry rep -&gt; [Char]
showsPrec :: Int -&gt; VarEntry rep -&gt; ShowS
$cshowsPrec :: forall rep. RepTypes rep =&gt; Int -&gt; VarEntry rep -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span class="hs-keyword">data</span><span> </span><span id="ValueDestination"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ValueDestination"><span class="hs-identifier hs-var">ValueDestination</span></a></span></span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="ScalarDestination"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarDestination"><span class="hs-identifier hs-var">ScalarDestination</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="MemoryDestination"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemoryDestination"><span class="hs-identifier hs-var">MemoryDestination</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | The 'MemLoc' is 'Just' if a copy if</span><span>
</span><span id="line-242"></span><span>    </span><span class="hs-comment">-- required.  If it is 'Nothing', then a</span><span>
</span><span id="line-243"></span><span>    </span><span class="hs-comment">-- copy/assignment of a memory block somewhere</span><span>
</span><span id="line-244"></span><span>    </span><span class="hs-comment">-- takes care of this array.</span><span>
</span><span id="line-245"></span><span>    </span><span id="ArrayDestination"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDestination"><span class="hs-identifier hs-var">ArrayDestination</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684528960"><span id="local-6989586621684528962"><span id="local-6989586621684528971"><span class="annot"><span class="annottext">Int -&gt; ValueDestination -&gt; ShowS
[ValueDestination] -&gt; ShowS
ValueDestination -&gt; [Char]
(Int -&gt; ValueDestination -&gt; ShowS)
-&gt; (ValueDestination -&gt; [Char])
-&gt; ([ValueDestination] -&gt; ShowS)
-&gt; Show ValueDestination
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; [Char]) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ValueDestination] -&gt; ShowS
$cshowList :: [ValueDestination] -&gt; ShowS
show :: ValueDestination -&gt; [Char]
$cshow :: ValueDestination -&gt; [Char]
showsPrec :: Int -&gt; ValueDestination -&gt; ShowS
$cshowsPrec :: Int -&gt; ValueDestination -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span class="hs-keyword">data</span><span> </span><span id="Env"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Env"><span class="hs-identifier hs-var">Env</span></a></span></span><span> </span><span id="local-6989586621684530599"><span class="annot"><a href="#local-6989586621684530599"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684530598"><span class="annot"><a href="#local-6989586621684530598"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621684530597"><span class="annot"><a href="#local-6989586621684530597"><span class="hs-identifier hs-type">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Env"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Env"><span class="hs-identifier hs-var">Env</span></a></span></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="envExpCompiler"><span class="annot"><span class="annottext">forall rep r op. Env rep r op -&gt; ExpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envExpCompiler"><span class="hs-identifier hs-var hs-var">envExpCompiler</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ExpCompiler"><span class="hs-identifier hs-type">ExpCompiler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530599"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530598"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530597"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-250"></span><span>    </span><span id="envStmsCompiler"><span class="annot"><span class="annottext">forall rep r op. Env rep r op -&gt; StmsCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envStmsCompiler"><span class="hs-identifier hs-var hs-var">envStmsCompiler</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#StmsCompiler"><span class="hs-identifier hs-type">StmsCompiler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530599"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530598"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530597"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-251"></span><span>    </span><span id="envOpCompiler"><span class="annot"><span class="annottext">forall rep r op. Env rep r op -&gt; OpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envOpCompiler"><span class="hs-identifier hs-var hs-var">envOpCompiler</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#OpCompiler"><span class="hs-identifier hs-type">OpCompiler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530599"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530598"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530597"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-252"></span><span>    </span><span id="envCopyCompiler"><span class="annot"><span class="annottext">forall rep r op. Env rep r op -&gt; CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envCopyCompiler"><span class="hs-identifier hs-var hs-var">envCopyCompiler</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#CopyCompiler"><span class="hs-identifier hs-type">CopyCompiler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530599"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530598"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530597"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-253"></span><span>    </span><span id="envAllocCompilers"><span class="annot"><span class="annottext">forall rep r op. Env rep r op -&gt; Map Space (AllocCompiler rep r op)
</span><a href="Futhark.CodeGen.ImpGen.html#envAllocCompilers"><span class="hs-identifier hs-var hs-var">envAllocCompilers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#AllocCompiler"><span class="hs-identifier hs-type">AllocCompiler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530599"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530598"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530597"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-254"></span><span>    </span><span id="envDefaultSpace"><span class="annot"><span class="annottext">forall rep r op. Env rep r op -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#envDefaultSpace"><span class="hs-identifier hs-var hs-var">envDefaultSpace</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Imp.Space</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-255"></span><span>    </span><span id="envVolatility"><span class="annot"><span class="annottext">forall rep r op. Env rep r op -&gt; Volatility
</span><a href="Futhark.CodeGen.ImpGen.html#envVolatility"><span class="hs-identifier hs-var hs-var">envVolatility</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Volatility"><span class="hs-identifier hs-type">Imp.Volatility</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-256"></span><span>    </span><span class="hs-comment">-- | User-extensible environment.</span><span>
</span><span id="line-257"></span><span>    </span><span id="envEnv"><span class="annot"><span class="annottext">forall rep r op. Env rep r op -&gt; r
</span><a href="Futhark.CodeGen.ImpGen.html#envEnv"><span class="hs-identifier hs-var hs-var">envEnv</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621684530598"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-comment">-- | Name of the function we are compiling, if any.</span><span>
</span><span id="line-259"></span><span>    </span><span id="envFunction"><span class="annot"><span class="annottext">forall rep r op. Env rep r op -&gt; Maybe Name
</span><a href="Futhark.CodeGen.ImpGen.html#envFunction"><span class="hs-identifier hs-var hs-var">envFunction</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-comment">-- | The set of attributes that are active on the enclosing</span><span>
</span><span id="line-261"></span><span>    </span><span class="hs-comment">-- statements (including the one we are currently compiling).</span><span>
</span><span id="line-262"></span><span>    </span><span id="envAttrs"><span class="annot"><span class="annottext">forall rep r op. Env rep r op -&gt; Attrs
</span><a href="Futhark.CodeGen.ImpGen.html#envAttrs"><span class="hs-identifier hs-var hs-var">envAttrs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Attrs"><span class="hs-identifier hs-type">Attrs</span></a></span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-264"></span><span>
</span><span id="line-265"></span><span id="local-6989586621684530560"><span id="local-6989586621684530561"><span id="local-6989586621684530562"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#newEnv"><span class="hs-identifier hs-type">newEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621684530562"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-type">Operations</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530561"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530562"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530560"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Imp.Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530561"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530562"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530560"><span class="hs-identifier hs-type">op</span></a></span></span></span></span><span>
</span><span id="line-266"></span><span id="newEnv"><span class="annot"><span class="annottext">newEnv :: forall r rep op. r -&gt; Operations rep r op -&gt; Space -&gt; Env rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#newEnv"><span class="hs-identifier hs-var hs-var">newEnv</span></a></span></span><span> </span><span id="local-6989586621684528943"><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621684528943"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684528942"><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684528942"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684528941"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528941"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-267"></span><span>  </span><span class="annot"><span class="annottext">Env :: forall rep r op.
ExpCompiler rep r op
-&gt; StmsCompiler rep r op
-&gt; OpCompiler rep r op
-&gt; CopyCompiler rep r op
-&gt; Map Space (AllocCompiler rep r op)
-&gt; Space
-&gt; Volatility
-&gt; r
-&gt; Maybe Name
-&gt; Attrs
-&gt; Env rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">envExpCompiler :: ExpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envExpCompiler"><span class="hs-identifier hs-var">envExpCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations rep r op -&gt; ExpCompiler rep r op
forall rep r op. Operations rep r op -&gt; ExpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsExpCompiler"><span class="hs-identifier hs-var hs-var">opsExpCompiler</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684528942"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-269"></span><span>      </span><span class="annot"><span class="annottext">envStmsCompiler :: StmsCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envStmsCompiler"><span class="hs-identifier hs-var">envStmsCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations rep r op -&gt; StmsCompiler rep r op
forall rep r op. Operations rep r op -&gt; StmsCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsStmsCompiler"><span class="hs-identifier hs-var hs-var">opsStmsCompiler</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684528942"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-270"></span><span>      </span><span class="annot"><span class="annottext">envOpCompiler :: OpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envOpCompiler"><span class="hs-identifier hs-var">envOpCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations rep r op -&gt; OpCompiler rep r op
forall rep r op. Operations rep r op -&gt; OpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsOpCompiler"><span class="hs-identifier hs-var hs-var">opsOpCompiler</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684528942"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-271"></span><span>      </span><span class="annot"><span class="annottext">envCopyCompiler :: CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envCopyCompiler"><span class="hs-identifier hs-var">envCopyCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations rep r op -&gt; CopyCompiler rep r op
forall rep r op. Operations rep r op -&gt; CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsCopyCompiler"><span class="hs-identifier hs-var hs-var">opsCopyCompiler</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684528942"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-272"></span><span>      </span><span class="annot"><span class="annottext">envAllocCompilers :: Map Space (AllocCompiler rep r op)
</span><a href="Futhark.CodeGen.ImpGen.html#envAllocCompilers"><span class="hs-identifier hs-var">envAllocCompilers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Space (AllocCompiler rep r op)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-273"></span><span>      </span><span class="annot"><span class="annottext">envDefaultSpace :: Space
</span><a href="Futhark.CodeGen.ImpGen.html#envDefaultSpace"><span class="hs-identifier hs-var">envDefaultSpace</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528941"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-274"></span><span>      </span><span class="annot"><span class="annottext">envVolatility :: Volatility
</span><a href="Futhark.CodeGen.ImpGen.html#envVolatility"><span class="hs-identifier hs-var">envVolatility</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="Futhark.CodeGen.ImpCode.html#Nonvolatile"><span class="hs-identifier hs-var">Imp.Nonvolatile</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-275"></span><span>      </span><span class="annot"><span class="annottext">envEnv :: r
</span><a href="Futhark.CodeGen.ImpGen.html#envEnv"><span class="hs-identifier hs-var">envEnv</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621684528943"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-276"></span><span>      </span><span class="annot"><span class="annottext">envFunction :: Maybe Name
</span><a href="Futhark.CodeGen.ImpGen.html#envFunction"><span class="hs-identifier hs-var">envFunction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-277"></span><span>      </span><span class="annot"><span class="annottext">envAttrs :: Attrs
</span><a href="Futhark.CodeGen.ImpGen.html#envAttrs"><span class="hs-identifier hs-var">envAttrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Attrs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-278"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span class="hs-comment">-- | The symbol table used during compilation.</span><span>
</span><span id="line-281"></span><span class="hs-keyword">type</span><span> </span><span id="VTable"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VTable"><span class="hs-identifier hs-var">VTable</span></a></span></span><span> </span><span id="local-6989586621684528939"><span class="annot"><a href="#local-6989586621684528939"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VarEntry"><span class="hs-identifier hs-type">VarEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684528939"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="hs-keyword">data</span><span> </span><span id="ImpState"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpState"><span class="hs-identifier hs-var">ImpState</span></a></span></span><span> </span><span id="local-6989586621684530555"><span class="annot"><a href="#local-6989586621684530555"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684530554"><span class="annot"><a href="#local-6989586621684530554"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621684530553"><span class="annot"><a href="#local-6989586621684530553"><span class="hs-identifier hs-type">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ImpState"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpState"><span class="hs-identifier hs-var">ImpState</span></a></span></span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="stateVTable"><span class="annot"><span class="annottext">forall rep r op. ImpState rep r op -&gt; VTable rep
</span><a href="Futhark.CodeGen.ImpGen.html#stateVTable"><span class="hs-identifier hs-var hs-var">stateVTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VTable"><span class="hs-identifier hs-type">VTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530555"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-285"></span><span>    </span><span id="stateFunctions"><span class="annot"><span class="annottext">forall rep r op. ImpState rep r op -&gt; Functions op
</span><a href="Futhark.CodeGen.ImpGen.html#stateFunctions"><span class="hs-identifier hs-var hs-var">stateFunctions</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Functions"><span class="hs-identifier hs-type">Imp.Functions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530553"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-286"></span><span>    </span><span id="stateCode"><span class="annot"><span class="annottext">forall rep r op. ImpState rep r op -&gt; Code op
</span><a href="Futhark.CodeGen.ImpGen.html#stateCode"><span class="hs-identifier hs-var hs-var">stateCode</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530553"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-287"></span><span>    </span><span id="stateWarnings"><span class="annot"><span class="annottext">forall rep r op. ImpState rep r op -&gt; Warnings
</span><a href="Futhark.CodeGen.ImpGen.html#stateWarnings"><span class="hs-identifier hs-var hs-var">stateWarnings</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Warnings.html#Warnings"><span class="hs-identifier hs-type">Warnings</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-288"></span><span>    </span><span class="hs-comment">-- | Maps the arrays backing each accumulator to their</span><span>
</span><span id="line-289"></span><span>    </span><span class="hs-comment">-- update function and neutral elements.  This works</span><span>
</span><span id="line-290"></span><span>    </span><span class="hs-comment">-- because an array name can only become part of a single</span><span>
</span><span id="line-291"></span><span>    </span><span class="hs-comment">-- accumulator throughout its lifetime.  If the arrays</span><span>
</span><span id="line-292"></span><span>    </span><span class="hs-comment">-- backing an accumulator is not in this mapping, the</span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-comment">-- accumulator is scatter-like.</span><span>
</span><span id="line-294"></span><span>    </span><span id="stateAccs"><span class="annot"><span class="annottext">forall rep r op.
ImpState rep r op
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
</span><a href="Futhark.CodeGen.ImpGen.html#stateAccs"><span class="hs-identifier hs-var hs-var">stateAccs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530555"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-295"></span><span>    </span><span id="stateNameSource"><span class="annot"><span class="annottext">forall rep r op. ImpState rep r op -&gt; VNameSource
</span><a href="Futhark.CodeGen.ImpGen.html#stateNameSource"><span class="hs-identifier hs-var hs-var">stateNameSource</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-297"></span><span>
</span><span id="line-298"></span><span id="local-6989586621684530525"><span id="local-6989586621684530526"><span id="local-6989586621684530527"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#newState"><span class="hs-identifier hs-type">newState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpState"><span class="hs-identifier hs-type">ImpState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530527"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530526"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530525"><span class="hs-identifier hs-type">op</span></a></span></span></span></span><span>
</span><span id="line-299"></span><span id="newState"><span class="annot"><span class="annottext">newState :: forall rep r op. VNameSource -&gt; ImpState rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#newState"><span class="hs-identifier hs-var hs-var">newState</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VTable rep
-&gt; Functions op
-&gt; Code op
-&gt; Warnings
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
-&gt; VNameSource
-&gt; ImpState rep r op
forall rep r op.
VTable rep
-&gt; Functions op
-&gt; Code op
-&gt; Warnings
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
-&gt; VNameSource
-&gt; ImpState rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#ImpState"><span class="hs-identifier hs-var">ImpState</span></a></span><span> </span><span class="annot"><span class="annottext">VTable rep
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Functions op
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Code op
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Warnings
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Map VName ([VName], Maybe (Lambda rep, [SubExp]))
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span class="hs-keyword">newtype</span><span> </span><span id="ImpM"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-var">ImpM</span></a></span></span><span> </span><span id="local-6989586621684530499"><span class="annot"><a href="#local-6989586621684530499"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684530498"><span class="annot"><a href="#local-6989586621684530498"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621684530497"><span class="annot"><a href="#local-6989586621684530497"><span class="hs-identifier hs-type">op</span></a></span></span><span> </span><span id="local-6989586621684528920"><span class="annot"><a href="#local-6989586621684528920"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="ImpM"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-var">ImpM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530499"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530498"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530497"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpState"><span class="hs-identifier hs-type">ImpState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530499"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530498"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530497"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684528920"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-304"></span><span>    </span><span class="hs-special">(</span><span> </span><span id="local-6989586621684528911"><span id="local-6989586621684528917"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; ImpM rep r op a -&gt; ImpM rep r op b)
-&gt; (forall a b. a -&gt; ImpM rep r op b -&gt; ImpM rep r op a)
-&gt; Functor (ImpM rep r op)
forall a b. a -&gt; ImpM rep r op b -&gt; ImpM rep r op a
forall a b. (a -&gt; b) -&gt; ImpM rep r op a -&gt; ImpM rep r op b
forall rep r op a b. a -&gt; ImpM rep r op b -&gt; ImpM rep r op a
forall rep r op a b. (a -&gt; b) -&gt; ImpM rep r op a -&gt; ImpM rep r op b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: forall a b. a -&gt; ImpM rep r op b -&gt; ImpM rep r op a
$c&lt;$ :: forall rep r op a b. a -&gt; ImpM rep r op b -&gt; ImpM rep r op a
fmap :: forall a b. (a -&gt; b) -&gt; ImpM rep r op a -&gt; ImpM rep r op b
$cfmap :: forall rep r op a b. (a -&gt; b) -&gt; ImpM rep r op a -&gt; ImpM rep r op b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-305"></span><span>      </span><span id="local-6989586621684528877"><span id="local-6989586621684528882"><span id="local-6989586621684528887"><span id="local-6989586621684528892"><span id="local-6989586621684528898"><span class="annot"><span class="annottext">Functor (ImpM rep r op)
Functor (ImpM rep r op)
-&gt; (forall a. a -&gt; ImpM rep r op a)
-&gt; (forall a b.
    ImpM rep r op (a -&gt; b) -&gt; ImpM rep r op a -&gt; ImpM rep r op b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c)
    -&gt; ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op c)
-&gt; (forall a b.
    ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op b)
-&gt; (forall a b.
    ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op a)
-&gt; Applicative (ImpM rep r op)
forall a. a -&gt; ImpM rep r op a
forall a b. ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op a
forall a b. ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op b
forall a b.
ImpM rep r op (a -&gt; b) -&gt; ImpM rep r op a -&gt; ImpM rep r op b
forall rep r op. Functor (ImpM rep r op)
forall a b c.
(a -&gt; b -&gt; c)
-&gt; ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op c
forall rep r op a. a -&gt; ImpM rep r op a
forall rep r op a b.
ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op a
forall rep r op a b.
ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op b
forall rep r op a b.
ImpM rep r op (a -&gt; b) -&gt; ImpM rep r op a -&gt; ImpM rep r op b
forall rep r op a b c.
(a -&gt; b -&gt; c)
-&gt; ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: forall a b. ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op a
$c&lt;* :: forall rep r op a b.
ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op a
*&gt; :: forall a b. ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op b
$c*&gt; :: forall rep r op a b.
ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op b
liftA2 :: forall a b c.
(a -&gt; b -&gt; c)
-&gt; ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op c
$cliftA2 :: forall rep r op a b c.
(a -&gt; b -&gt; c)
-&gt; ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op c
&lt;*&gt; :: forall a b.
ImpM rep r op (a -&gt; b) -&gt; ImpM rep r op a -&gt; ImpM rep r op b
$c&lt;*&gt; :: forall rep r op a b.
ImpM rep r op (a -&gt; b) -&gt; ImpM rep r op a -&gt; ImpM rep r op b
pure :: forall a. a -&gt; ImpM rep r op a
$cpure :: forall rep r op a. a -&gt; ImpM rep r op a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-306"></span><span>      </span><span id="local-6989586621684528845"><span id="local-6989586621684528850"><span id="local-6989586621684528856"><span class="annot"><span class="annottext">Applicative (ImpM rep r op)
Applicative (ImpM rep r op)
-&gt; (forall a b.
    ImpM rep r op a -&gt; (a -&gt; ImpM rep r op b) -&gt; ImpM rep r op b)
-&gt; (forall a b.
    ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op b)
-&gt; (forall a. a -&gt; ImpM rep r op a)
-&gt; Monad (ImpM rep r op)
forall a. a -&gt; ImpM rep r op a
forall a b. ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op b
forall a b.
ImpM rep r op a -&gt; (a -&gt; ImpM rep r op b) -&gt; ImpM rep r op b
forall rep r op. Applicative (ImpM rep r op)
forall rep r op a. a -&gt; ImpM rep r op a
forall rep r op a b.
ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op b
forall rep r op a b.
ImpM rep r op a -&gt; (a -&gt; ImpM rep r op b) -&gt; ImpM rep r op b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: forall a. a -&gt; ImpM rep r op a
$creturn :: forall rep r op a. a -&gt; ImpM rep r op a
&gt;&gt; :: forall a b. ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op b
$c&gt;&gt; :: forall rep r op a b.
ImpM rep r op a -&gt; ImpM rep r op b -&gt; ImpM rep r op b
&gt;&gt;= :: forall a b.
ImpM rep r op a -&gt; (a -&gt; ImpM rep r op b) -&gt; ImpM rep r op b
$c&gt;&gt;= :: forall rep r op a b.
ImpM rep r op a -&gt; (a -&gt; ImpM rep r op b) -&gt; ImpM rep r op b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-307"></span><span>      </span><span id="local-6989586621684528821"><span id="local-6989586621684528826"><span id="local-6989586621684528832"><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpState"><span class="hs-identifier hs-type">ImpState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530499"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530498"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530497"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-308"></span><span>      </span><span id="local-6989586621684528797"><span id="local-6989586621684528802"><span id="local-6989586621684528808"><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530499"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530498"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530497"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-309"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span id="local-6989586621684530418"><span id="local-6989586621684530419"><span id="local-6989586621684530420"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530420"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530419"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530418"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-312"></span><span>  </span><span id="local-6989586621684528779"><span class="annot"><span class="annottext">getNameSource :: ImpM rep r op VNameSource
</span><a href="Futhark.MonadFreshNames.html#getNameSource"><span class="hs-identifier hs-var hs-var hs-var hs-var">getNameSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; VNameSource) -&gt; ImpM rep r op VNameSource
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; VNameSource
forall rep r op. ImpState rep r op -&gt; VNameSource
</span><a href="Futhark.CodeGen.ImpGen.html#stateNameSource"><span class="hs-identifier hs-var hs-var">stateNameSource</span></a></span><span>
</span><span id="line-313"></span><span>  </span><span id="local-6989586621684528775"><span class="annot"><span class="annottext">putNameSource :: VNameSource -&gt; ImpM rep r op ()
</span><a href="Futhark.MonadFreshNames.html#putNameSource"><span class="hs-identifier hs-var hs-var hs-var hs-var">putNameSource</span></a></span></span><span> </span><span id="local-6989586621684528773"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684528773"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ())
-&gt; (ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684528771"><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528771"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528771"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateNameSource :: VNameSource
</span><a href="Futhark.CodeGen.ImpGen.html#stateNameSource"><span class="hs-identifier hs-var">stateNameSource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684528773"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">}</span></span></span></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span class="hs-comment">-- Cannot be an KernelsMem scope because the index functions have</span><span>
</span><span id="line-316"></span><span class="hs-comment">-- the wrong leaves (VName instead of Imp.Exp).</span><span>
</span><span id="line-317"></span><span id="local-6989586621684530405"><span id="local-6989586621684530406"><span id="local-6989586621684530407"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684528759"><span id="local-6989586621684528762"><span id="local-6989586621684528764"><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530407"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530406"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530405"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-318"></span><span>  </span><span id="local-6989586621684528756"><span class="annot"><span class="annottext">askScope :: ImpM rep r op (Scope SOACS)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var hs-var hs-var hs-var">askScope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; Scope SOACS) -&gt; ImpM rep r op (Scope SOACS)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">((ImpState rep r op -&gt; Scope SOACS) -&gt; ImpM rep r op (Scope SOACS))
-&gt; (ImpState rep r op -&gt; Scope SOACS)
-&gt; ImpM rep r op (Scope SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VarEntry rep -&gt; NameInfo SOACS)
-&gt; Map VName (VarEntry rep) -&gt; Scope SOACS
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; NameInfo SOACS
forall rep. LetDec rep -&gt; NameInfo rep
</span><a href="Futhark.IR.Prop.Scope.html#LetName"><span class="hs-identifier hs-var">LetName</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; NameInfo SOACS)
-&gt; (VarEntry rep -&gt; Type) -&gt; VarEntry rep -&gt; NameInfo SOACS
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VarEntry rep -&gt; Type
forall {rep}. VarEntry rep -&gt; Type
</span><a href="#local-6989586621684528752"><span class="hs-identifier hs-var">entryType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map VName (VarEntry rep) -&gt; Scope SOACS)
-&gt; (ImpState rep r op -&gt; Map VName (VarEntry rep))
-&gt; ImpState rep r op
-&gt; Scope SOACS
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; Map VName (VarEntry rep)
forall rep r op. ImpState rep r op -&gt; VTable rep
</span><a href="Futhark.CodeGen.ImpGen.html#stateVTable"><span class="hs-identifier hs-var hs-var">stateVTable</span></a></span><span>
</span><span id="line-319"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-320"></span><span>      </span><span id="local-6989586621684528752"><span class="annot"><span class="annottext">entryType :: VarEntry rep -&gt; Type
</span><a href="#local-6989586621684528752"><span class="hs-identifier hs-var hs-var">entryType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-type">MemVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528751"><span class="annot"><span class="annottext">MemEntry
</span><a href="#local-6989586621684528751"><span class="hs-identifier hs-var">memEntry</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-321"></span><span>        </span><span class="annot"><span class="annottext">Space -&gt; Type
forall shape u. Space -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-var">Mem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">MemEntry
</span><a href="#local-6989586621684528751"><span class="hs-identifier hs-var">memEntry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-322"></span><span>      </span><span class="annot"><a href="#local-6989586621684528752"><span class="hs-identifier hs-var">entryType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayVar"><span class="hs-identifier hs-type">ArrayVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528749"><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684528749"><span class="hs-identifier hs-var">arrayEntry</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-323"></span><span>        </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; NoUniqueness -&gt; Type
forall shape u. PrimType -&gt; shape -&gt; u -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span>
</span><span id="line-324"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayEntry -&gt; PrimType
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayElemType"><span class="hs-identifier hs-var hs-var">entryArrayElemType</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684528749"><span class="hs-identifier hs-var">arrayEntry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Shape) -&gt; [SubExp] -&gt; Shape
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ArrayEntry -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayShape"><span class="hs-identifier hs-var">entryArrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684528749"><span class="hs-identifier hs-var">arrayEntry</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-326"></span><span>          </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-var">NoUniqueness</span></a></span><span>
</span><span id="line-327"></span><span>      </span><span class="annot"><a href="#local-6989586621684528752"><span class="hs-identifier hs-var">entryType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-type">ScalarVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528745"><span class="annot"><span class="annottext">ScalarEntry
</span><a href="#local-6989586621684528745"><span class="hs-identifier hs-var">scalarEntry</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-328"></span><span>        </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; Type) -&gt; PrimType -&gt; Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarEntry -&gt; PrimType
</span><a href="Futhark.CodeGen.ImpGen.html#entryScalarType"><span class="hs-identifier hs-var hs-var">entryScalarType</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarEntry
</span><a href="#local-6989586621684528745"><span class="hs-identifier hs-var">scalarEntry</span></a></span><span>
</span><span id="line-329"></span><span>      </span><span class="annot"><a href="#local-6989586621684528752"><span class="hs-identifier hs-var">entryType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#AccVar"><span class="hs-identifier hs-type">AccVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684528743"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528743"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528742"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684528742"><span class="hs-identifier hs-var">ispace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528741"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684528741"><span class="hs-identifier hs-var">ts</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-330"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; Shape -&gt; [Type] -&gt; NoUniqueness -&gt; Type
forall shape u. VName -&gt; Shape -&gt; [Type] -&gt; u -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-var">Acc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528743"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684528742"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684528741"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-var">NoUniqueness</span></a></span></span></span></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span id="local-6989586621684530396"><span id="local-6989586621684530397"><span id="local-6989586621684530398"><span id="local-6989586621684530399"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#runImpM"><span class="hs-identifier hs-type">runImpM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-333"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530399"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530398"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530397"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530396"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-334"></span><span>  </span><span class="annot"><a href="#local-6989586621684530398"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-335"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-type">Operations</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530399"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530398"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530397"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-336"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Imp.Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-337"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpState"><span class="hs-identifier hs-type">ImpState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530399"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530398"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530397"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-338"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684530396"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpState"><span class="hs-identifier hs-type">ImpState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530399"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530398"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530397"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-339"></span><span id="runImpM"><span class="annot"><span class="annottext">runImpM :: forall rep r op a.
ImpM rep r op a
-&gt; r
-&gt; Operations rep r op
-&gt; Space
-&gt; ImpState rep r op
-&gt; (a, ImpState rep r op)
</span><a href="Futhark.CodeGen.ImpGen.html#runImpM"><span class="hs-identifier hs-var hs-var">runImpM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span id="local-6989586621684528738"><span class="annot"><span class="annottext">ReaderT (Env rep r op) (State (ImpState rep r op)) a
</span><a href="#local-6989586621684528738"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684528737"><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621684528737"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684528736"><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684528736"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684528735"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528735"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State (ImpState rep r op) a
-&gt; ImpState rep r op -&gt; (a, ImpState rep r op)
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT (Env rep r op) (State (ImpState rep r op)) a
-&gt; Env rep r op -&gt; State (ImpState rep r op) a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (Env rep r op) (State (ImpState rep r op)) a
</span><a href="#local-6989586621684528738"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; State (ImpState rep r op) a)
-&gt; Env rep r op -&gt; State (ImpState rep r op) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">r -&gt; Operations rep r op -&gt; Space -&gt; Env rep r op
forall r rep op. r -&gt; Operations rep r op -&gt; Space -&gt; Env rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#newEnv"><span class="hs-identifier hs-var">newEnv</span></a></span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621684528737"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684528736"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528735"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span id="local-6989586621684530381"><span id="local-6989586621684530382"><span id="local-6989586621684530383"><span id="local-6989586621684530384"><span id="local-6989586621684530385"><span id="local-6989586621684530386"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#subImpM_"><span class="hs-identifier hs-type">subImpM_</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-342"></span><span>  </span><span class="annot"><a href="#local-6989586621684530386"><span class="hs-identifier hs-type">r'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-343"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-type">Operations</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530385"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530386"><span class="hs-identifier hs-type">r'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530384"><span class="hs-identifier hs-type">op'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-344"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530385"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530386"><span class="hs-identifier hs-type">r'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530384"><span class="hs-identifier hs-type">op'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530383"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-345"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530385"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530382"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530381"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530384"><span class="hs-identifier hs-type">op'</span></a></span><span class="hs-special">)</span></span></span></span></span></span></span><span>
</span><span id="line-346"></span><span id="subImpM_"><span class="annot"><span class="annottext">subImpM_ :: forall r' rep op' a r op.
r'
-&gt; Operations rep r' op'
-&gt; ImpM rep r' op' a
-&gt; ImpM rep r op (Code op')
</span><a href="Futhark.CodeGen.ImpGen.html#subImpM_"><span class="hs-identifier hs-var hs-var">subImpM_</span></a></span></span><span> </span><span id="local-6989586621684528731"><span class="annot"><span class="annottext">r'
</span><a href="#local-6989586621684528731"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684528730"><span class="annot"><span class="annottext">Operations rep r' op'
</span><a href="#local-6989586621684528730"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684528729"><span class="annot"><span class="annottext">ImpM rep r' op' a
</span><a href="#local-6989586621684528729"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a, Code op') -&gt; Code op'
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((a, Code op') -&gt; Code op')
-&gt; ImpM rep r op (a, Code op') -&gt; ImpM rep r op (Code op')
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">r'
-&gt; Operations rep r' op'
-&gt; ImpM rep r' op' a
-&gt; ImpM rep r op (a, Code op')
forall r' rep op' a r op.
r'
-&gt; Operations rep r' op'
-&gt; ImpM rep r' op' a
-&gt; ImpM rep r op (a, Code op')
</span><a href="Futhark.CodeGen.ImpGen.html#subImpM"><span class="hs-identifier hs-var">subImpM</span></a></span><span> </span><span class="annot"><span class="annottext">r'
</span><a href="#local-6989586621684528731"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r' op'
</span><a href="#local-6989586621684528730"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM rep r' op' a
</span><a href="#local-6989586621684528729"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-347"></span><span>
</span><span id="line-348"></span><span id="local-6989586621684530364"><span id="local-6989586621684530365"><span id="local-6989586621684530366"><span id="local-6989586621684530367"><span id="local-6989586621684530368"><span id="local-6989586621684530369"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#subImpM"><span class="hs-identifier hs-type">subImpM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-349"></span><span>  </span><span class="annot"><a href="#local-6989586621684530369"><span class="hs-identifier hs-type">r'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-350"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-type">Operations</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530368"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530369"><span class="hs-identifier hs-type">r'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530367"><span class="hs-identifier hs-type">op'</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-351"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530368"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530369"><span class="hs-identifier hs-type">r'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530367"><span class="hs-identifier hs-type">op'</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530366"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-352"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530368"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530365"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530364"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684530366"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530367"><span class="hs-identifier hs-type">op'</span></a></span><span class="hs-special">)</span></span></span></span></span></span></span><span>
</span><span id="line-353"></span><span id="subImpM"><span class="annot"><span class="annottext">subImpM :: forall r' rep op' a r op.
r'
-&gt; Operations rep r' op'
-&gt; ImpM rep r' op' a
-&gt; ImpM rep r op (a, Code op')
</span><a href="Futhark.CodeGen.ImpGen.html#subImpM"><span class="hs-identifier hs-var hs-var">subImpM</span></a></span></span><span> </span><span id="local-6989586621684528716"><span class="annot"><span class="annottext">r'
</span><a href="#local-6989586621684528716"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684528715"><span class="annot"><span class="annottext">Operations rep r' op'
</span><a href="#local-6989586621684528715"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span id="local-6989586621684528714"><span class="annot"><span class="annottext">ReaderT (Env rep r' op') (State (ImpState rep r' op')) a
</span><a href="#local-6989586621684528714"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-354"></span><span>  </span><span id="local-6989586621684528713"><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684528713"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op (Env rep r op)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-355"></span><span>  </span><span id="local-6989586621684528711"><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528711"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op (ImpState rep r op)
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-356"></span><span>
</span><span id="line-357"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684528709"><span class="annot"><span class="annottext">env' :: Env rep r' op'
</span><a href="#local-6989586621684528709"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-358"></span><span>        </span><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684528713"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-359"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">envExpCompiler :: ExpCompiler rep r' op'
</span><a href="Futhark.CodeGen.ImpGen.html#envExpCompiler"><span class="hs-identifier hs-var">envExpCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations rep r' op' -&gt; ExpCompiler rep r' op'
forall rep r op. Operations rep r op -&gt; ExpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsExpCompiler"><span class="hs-identifier hs-var hs-var">opsExpCompiler</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r' op'
</span><a href="#local-6989586621684528715"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-360"></span><span>            </span><span class="annot"><span class="annottext">envStmsCompiler :: StmsCompiler rep r' op'
</span><a href="Futhark.CodeGen.ImpGen.html#envStmsCompiler"><span class="hs-identifier hs-var">envStmsCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations rep r' op' -&gt; StmsCompiler rep r' op'
forall rep r op. Operations rep r op -&gt; StmsCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsStmsCompiler"><span class="hs-identifier hs-var hs-var">opsStmsCompiler</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r' op'
</span><a href="#local-6989586621684528715"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-361"></span><span>            </span><span class="annot"><span class="annottext">envCopyCompiler :: CopyCompiler rep r' op'
</span><a href="Futhark.CodeGen.ImpGen.html#envCopyCompiler"><span class="hs-identifier hs-var">envCopyCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations rep r' op' -&gt; CopyCompiler rep r' op'
forall rep r op. Operations rep r op -&gt; CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsCopyCompiler"><span class="hs-identifier hs-var hs-var">opsCopyCompiler</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r' op'
</span><a href="#local-6989586621684528715"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-362"></span><span>            </span><span class="annot"><span class="annottext">envOpCompiler :: OpCompiler rep r' op'
</span><a href="Futhark.CodeGen.ImpGen.html#envOpCompiler"><span class="hs-identifier hs-var">envOpCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations rep r' op' -&gt; OpCompiler rep r' op'
forall rep r op. Operations rep r op -&gt; OpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsOpCompiler"><span class="hs-identifier hs-var hs-var">opsOpCompiler</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r' op'
</span><a href="#local-6989586621684528715"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-363"></span><span>            </span><span class="annot"><span class="annottext">envAllocCompilers :: Map Space (AllocCompiler rep r' op')
</span><a href="Futhark.CodeGen.ImpGen.html#envAllocCompilers"><span class="hs-identifier hs-var">envAllocCompilers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations rep r' op' -&gt; Map Space (AllocCompiler rep r' op')
forall rep r op.
Operations rep r op -&gt; Map Space (AllocCompiler rep r op)
</span><a href="Futhark.CodeGen.ImpGen.html#opsAllocCompilers"><span class="hs-identifier hs-var hs-var">opsAllocCompilers</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r' op'
</span><a href="#local-6989586621684528715"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-364"></span><span>            </span><span class="annot"><span class="annottext">envEnv :: r'
</span><a href="Futhark.CodeGen.ImpGen.html#envEnv"><span class="hs-identifier hs-var">envEnv</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">r'
</span><a href="#local-6989586621684528716"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-365"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-366"></span><span>      </span><span id="local-6989586621684528708"><span class="annot"><span class="annottext">s' :: ImpState rep r' op'
</span><a href="#local-6989586621684528708"><span class="hs-identifier hs-var hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-367"></span><span>        </span><span class="annot"><span class="annottext">ImpState :: forall rep r op.
VTable rep
-&gt; Functions op
-&gt; Code op
-&gt; Warnings
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
-&gt; VNameSource
-&gt; ImpState rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#ImpState"><span class="hs-identifier hs-type">ImpState</span></a></span><span>
</span><span id="line-368"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">stateVTable :: VTable rep
</span><a href="Futhark.CodeGen.ImpGen.html#stateVTable"><span class="hs-identifier hs-var">stateVTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; VTable rep
forall rep r op. ImpState rep r op -&gt; VTable rep
</span><a href="Futhark.CodeGen.ImpGen.html#stateVTable"><span class="hs-identifier hs-var hs-var">stateVTable</span></a></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528711"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-369"></span><span>            </span><span class="annot"><span class="annottext">stateFunctions :: Functions op'
</span><a href="Futhark.CodeGen.ImpGen.html#stateFunctions"><span class="hs-identifier hs-var">stateFunctions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Functions op'
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-370"></span><span>            </span><span class="annot"><span class="annottext">stateCode :: Code op'
</span><a href="Futhark.CodeGen.ImpGen.html#stateCode"><span class="hs-identifier hs-var">stateCode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code op'
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-371"></span><span>            </span><span class="annot"><span class="annottext">stateNameSource :: VNameSource
</span><a href="Futhark.CodeGen.ImpGen.html#stateNameSource"><span class="hs-identifier hs-var">stateNameSource</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; VNameSource
forall rep r op. ImpState rep r op -&gt; VNameSource
</span><a href="Futhark.CodeGen.ImpGen.html#stateNameSource"><span class="hs-identifier hs-var hs-var">stateNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528711"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-372"></span><span>            </span><span class="annot"><span class="annottext">stateWarnings :: Warnings
</span><a href="Futhark.CodeGen.ImpGen.html#stateWarnings"><span class="hs-identifier hs-var">stateWarnings</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Warnings
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-373"></span><span>            </span><span class="annot"><span class="annottext">stateAccs :: Map VName ([VName], Maybe (Lambda rep, [SubExp]))
</span><a href="Futhark.CodeGen.ImpGen.html#stateAccs"><span class="hs-identifier hs-var">stateAccs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
forall rep r op.
ImpState rep r op
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
</span><a href="Futhark.CodeGen.ImpGen.html#stateAccs"><span class="hs-identifier hs-var hs-var">stateAccs</span></a></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528711"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-374"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-375"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684528707"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684528707"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528706"><span class="annot"><span class="annottext">ImpState rep r' op'
</span><a href="#local-6989586621684528706"><span class="hs-identifier hs-var">s''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State (ImpState rep r' op') a
-&gt; ImpState rep r' op' -&gt; (a, ImpState rep r' op')
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT (Env rep r' op') (State (ImpState rep r' op')) a
-&gt; Env rep r' op' -&gt; State (ImpState rep r' op') a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (Env rep r' op') (State (ImpState rep r' op')) a
</span><a href="#local-6989586621684528714"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Env rep r' op'
</span><a href="#local-6989586621684528709"><span class="hs-identifier hs-var">env'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ImpState rep r' op'
</span><a href="#local-6989586621684528708"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-376"></span><span>
</span><span id="line-377"></span><span>  </span><span class="annot"><span class="annottext">VNameSource -&gt; ImpM rep r op ()
forall (m :: * -&gt; *). MonadFreshNames m =&gt; VNameSource -&gt; m ()
</span><a href="Futhark.MonadFreshNames.html#putNameSource"><span class="hs-identifier hs-var">putNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">(VNameSource -&gt; ImpM rep r op ())
-&gt; VNameSource -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r' op' -&gt; VNameSource
forall rep r op. ImpState rep r op -&gt; VNameSource
</span><a href="Futhark.CodeGen.ImpGen.html#stateNameSource"><span class="hs-identifier hs-var hs-var">stateNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">ImpState rep r' op'
</span><a href="#local-6989586621684528706"><span class="hs-identifier hs-var">s''</span></a></span><span>
</span><span id="line-378"></span><span>  </span><span class="annot"><span class="annottext">Warnings -&gt; ImpM rep r op ()
forall rep r op. Warnings -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#warnings"><span class="hs-identifier hs-var">warnings</span></a></span><span> </span><span class="annot"><span class="annottext">(Warnings -&gt; ImpM rep r op ()) -&gt; Warnings -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r' op' -&gt; Warnings
forall rep r op. ImpState rep r op -&gt; Warnings
</span><a href="Futhark.CodeGen.ImpGen.html#stateWarnings"><span class="hs-identifier hs-var hs-var">stateWarnings</span></a></span><span> </span><span class="annot"><span class="annottext">ImpState rep r' op'
</span><a href="#local-6989586621684528706"><span class="hs-identifier hs-var">s''</span></a></span><span>
</span><span id="line-379"></span><span>  </span><span class="annot"><span class="annottext">(a, Code op') -&gt; ImpM rep r op (a, Code op')
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684528707"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ImpState rep r' op' -&gt; Code op'
forall rep r op. ImpState rep r op -&gt; Code op
</span><a href="Futhark.CodeGen.ImpGen.html#stateCode"><span class="hs-identifier hs-var hs-var">stateCode</span></a></span><span> </span><span class="annot"><span class="annottext">ImpState rep r' op'
</span><a href="#local-6989586621684528706"><span class="hs-identifier hs-var">s''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-380"></span><span>
</span><span id="line-381"></span><span class="hs-comment">-- | Execute a code generation action, returning the code that was</span><span>
</span><span id="line-382"></span><span class="hs-comment">-- emitted.</span><span>
</span><span id="line-383"></span><span id="local-6989586621684530352"><span id="local-6989586621684530353"><span id="local-6989586621684530354"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-type">collect</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530354"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530353"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530352"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530354"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530353"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530352"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530352"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-384"></span><span id="collect"><span class="annot"><span class="annottext">collect :: forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var hs-var">collect</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(((), Code op) -&gt; Code op)
-&gt; ImpM rep r op ((), Code op) -&gt; ImpM rep r op (Code op)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">((), Code op) -&gt; Code op
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op ((), Code op) -&gt; ImpM rep r op (Code op))
-&gt; (ImpM rep r op () -&gt; ImpM rep r op ((), Code op))
-&gt; ImpM rep r op ()
-&gt; ImpM rep r op (Code op)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op ((), Code op)
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op (a, Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect%27"><span class="hs-identifier hs-var">collect'</span></a></span><span>
</span><span id="line-385"></span><span>
</span><span id="line-386"></span><span id="local-6989586621684530345"><span id="local-6989586621684530346"><span id="local-6989586621684530347"><span id="local-6989586621684530348"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#collect%27"><span class="hs-identifier hs-type">collect'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530348"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530347"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530346"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530345"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530348"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530347"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530346"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684530345"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530346"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-387"></span><span id="collect%27"><span class="annot"><span class="annottext">collect' :: forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op (a, Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect%27"><span class="hs-identifier hs-var hs-var">collect'</span></a></span></span><span> </span><span id="local-6989586621684528692"><span class="annot"><span class="annottext">ImpM rep r op a
</span><a href="#local-6989586621684528692"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-388"></span><span>  </span><span id="local-6989586621684528691"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528691"><span class="hs-identifier hs-var">prev_code</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; Code op) -&gt; ImpM rep r op (Code op)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; Code op
forall rep r op. ImpState rep r op -&gt; Code op
</span><a href="Futhark.CodeGen.ImpGen.html#stateCode"><span class="hs-identifier hs-var hs-var">stateCode</span></a></span><span>
</span><span id="line-389"></span><span>  </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ())
-&gt; (ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684528690"><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528690"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528690"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateCode :: Code op
</span><a href="Futhark.CodeGen.ImpGen.html#stateCode"><span class="hs-identifier hs-var">stateCode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code op
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">}</span><span>
</span><span id="line-390"></span><span>  </span><span id="local-6989586621684528689"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684528689"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op a
</span><a href="#local-6989586621684528692"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-391"></span><span>  </span><span id="local-6989586621684528688"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528688"><span class="hs-identifier hs-var">new_code</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; Code op) -&gt; ImpM rep r op (Code op)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; Code op
forall rep r op. ImpState rep r op -&gt; Code op
</span><a href="Futhark.CodeGen.ImpGen.html#stateCode"><span class="hs-identifier hs-var hs-var">stateCode</span></a></span><span>
</span><span id="line-392"></span><span>  </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ())
-&gt; (ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684528687"><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528687"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528687"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateCode :: Code op
</span><a href="Futhark.CodeGen.ImpGen.html#stateCode"><span class="hs-identifier hs-var">stateCode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528691"><span class="hs-identifier hs-var">prev_code</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-393"></span><span>  </span><span class="annot"><span class="annottext">(a, Code op) -&gt; ImpM rep r op (a, Code op)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684528689"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528688"><span class="hs-identifier hs-var">new_code</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span class="hs-comment">-- | Execute a code generation action, wrapping the generated code</span><span>
</span><span id="line-396"></span><span class="hs-comment">-- within a 'Imp.Comment' with the given description.</span><span>
</span><span id="line-397"></span><span id="local-6989586621684530338"><span id="local-6989586621684530339"><span id="local-6989586621684530340"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#comment"><span class="hs-identifier hs-type">comment</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530340"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530339"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530338"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530340"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530339"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530338"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-398"></span><span id="comment"><span class="annot"><span class="annottext">comment :: forall rep r op. [Char] -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#comment"><span class="hs-identifier hs-var hs-var">comment</span></a></span></span><span> </span><span id="local-6989586621684528685"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684528685"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684528684"><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684528684"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-399"></span><span>  </span><span id="local-6989586621684528683"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528683"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684528684"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-400"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Code op -&gt; Code op
forall a. [Char] -&gt; Code a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Comment"><span class="hs-identifier hs-var">Imp.Comment</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684528685"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528683"><span class="hs-identifier hs-var">code</span></a></span><span>
</span><span id="line-401"></span><span>
</span><span id="line-402"></span><span class="hs-comment">-- | Emit some generated imperative code.</span><span>
</span><span id="line-403"></span><span id="local-6989586621684530332"><span id="local-6989586621684530333"><span id="local-6989586621684530334"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-type">emit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530334"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530333"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530332"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530334"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-404"></span><span id="emit"><span class="annot"><span class="annottext">emit :: forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var hs-var">emit</span></a></span></span><span> </span><span id="local-6989586621684528678"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528678"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ())
-&gt; (ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684528677"><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528677"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528677"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateCode :: Code op
</span><a href="Futhark.CodeGen.ImpGen.html#stateCode"><span class="hs-identifier hs-var">stateCode</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; Code op
forall rep r op. ImpState rep r op -&gt; Code op
</span><a href="Futhark.CodeGen.ImpGen.html#stateCode"><span class="hs-identifier hs-var hs-var">stateCode</span></a></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528677"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Code op -&gt; Code op -&gt; Code op
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528678"><span class="hs-identifier hs-var">code</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span id="local-6989586621684530355"><span id="local-6989586621684530356"><span id="local-6989586621684530357"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#warnings"><span class="hs-identifier hs-type">warnings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Warnings.html#Warnings"><span class="hs-identifier hs-type">Warnings</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530357"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530356"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530355"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-407"></span><span id="warnings"><span class="annot"><span class="annottext">warnings :: forall rep r op. Warnings -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#warnings"><span class="hs-identifier hs-var hs-var">warnings</span></a></span></span><span> </span><span id="local-6989586621684528673"><span class="annot"><span class="annottext">Warnings
</span><a href="#local-6989586621684528673"><span class="hs-identifier hs-var">ws</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ())
-&gt; (ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684528672"><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528672"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528672"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateWarnings :: Warnings
</span><a href="Futhark.CodeGen.ImpGen.html#stateWarnings"><span class="hs-identifier hs-var">stateWarnings</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Warnings
</span><a href="#local-6989586621684528673"><span class="hs-identifier hs-var">ws</span></a></span><span> </span><span class="annot"><span class="annottext">Warnings -&gt; Warnings -&gt; Warnings
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; Warnings
forall rep r op. ImpState rep r op -&gt; Warnings
</span><a href="Futhark.CodeGen.ImpGen.html#stateWarnings"><span class="hs-identifier hs-var hs-var">stateWarnings</span></a></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528672"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span class="hs-comment">-- | Emit a warning about something the user should be aware of.</span><span>
</span><span id="line-410"></span><span id="local-6989586621684530318"><span id="local-6989586621684530319"><span id="local-6989586621684530320"><span id="local-6989586621684530322"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#warn"><span class="hs-identifier hs-type">warn</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Located</span></span><span> </span><span class="annot"><a href="#local-6989586621684530322"><span class="hs-identifier hs-type">loc</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684530322"><span class="hs-identifier hs-type">loc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684530322"><span class="hs-identifier hs-type">loc</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530320"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530319"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530318"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-411"></span><span id="warn"><span class="annot"><span class="annottext">warn :: forall loc rep r op.
Located loc =&gt;
loc -&gt; [loc] -&gt; [Char] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#warn"><span class="hs-identifier hs-var hs-var">warn</span></a></span></span><span> </span><span id="local-6989586621684528666"><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684528666"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span id="local-6989586621684528665"><span class="annot"><span class="annottext">[loc]
</span><a href="#local-6989586621684528665"><span class="hs-identifier hs-var">locs</span></a></span></span><span> </span><span id="local-6989586621684528664"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684528664"><span class="hs-identifier hs-var">problem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-412"></span><span>  </span><span class="annot"><span class="annottext">Warnings -&gt; ImpM rep r op ()
forall rep r op. Warnings -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#warnings"><span class="hs-identifier hs-var">warnings</span></a></span><span> </span><span class="annot"><span class="annottext">(Warnings -&gt; ImpM rep r op ()) -&gt; Warnings -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; [SrcLoc] -&gt; Doc -&gt; Warnings
</span><a href="Language.Futhark.Warnings.html#singleWarning%27"><span class="hs-identifier hs-var">singleWarning'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">loc -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">loc
</span><a href="#local-6989586621684528666"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(loc -&gt; SrcLoc) -&gt; [loc] -&gt; [SrcLoc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">loc -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">[loc]
</span><a href="#local-6989586621684528665"><span class="hs-identifier hs-var">locs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; Doc
forall a. IsString a =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">fromString</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684528664"><span class="hs-identifier hs-var">problem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-413"></span><span>
</span><span id="line-414"></span><span class="hs-comment">-- | Emit a function in the generated code.</span><span>
</span><span id="line-415"></span><span id="local-6989586621684530304"><span id="local-6989586621684530305"><span id="local-6989586621684530307"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#emitFunction"><span class="hs-identifier hs-type">emitFunction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Function"><span class="hs-identifier hs-type">Imp.Function</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530307"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530305"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530304"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530307"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-416"></span><span id="emitFunction"><span class="annot"><span class="annottext">emitFunction :: forall op rep r. Name -&gt; Function op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emitFunction"><span class="hs-identifier hs-var hs-var">emitFunction</span></a></span></span><span> </span><span id="local-6989586621684528658"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528658"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span id="local-6989586621684528657"><span class="annot"><span class="annottext">Function op
</span><a href="#local-6989586621684528657"><span class="hs-identifier hs-var">fun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-417"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Functions"><span class="hs-identifier hs-type">Imp.Functions</span></a></span><span> </span><span id="local-6989586621684528655"><span class="annot"><span class="annottext">[(Name, Function op)]
</span><a href="#local-6989586621684528655"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; Functions op) -&gt; ImpM rep r op (Functions op)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; Functions op
forall rep r op. ImpState rep r op -&gt; Functions op
</span><a href="Futhark.CodeGen.ImpGen.html#stateFunctions"><span class="hs-identifier hs-var hs-var">stateFunctions</span></a></span><span>
</span><span id="line-418"></span><span>  </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ())
-&gt; (ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684528654"><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528654"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528654"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateFunctions :: Functions op
</span><a href="Futhark.CodeGen.ImpGen.html#stateFunctions"><span class="hs-identifier hs-var">stateFunctions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, Function op)] -&gt; Functions op
forall a. [(Name, Function a)] -&gt; Functions a
</span><a href="Futhark.CodeGen.ImpCode.html#Functions"><span class="hs-identifier hs-var">Imp.Functions</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, Function op)] -&gt; Functions op)
-&gt; [(Name, Function op)] -&gt; Functions op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528658"><span class="hs-identifier hs-var">fname</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Function op
</span><a href="#local-6989586621684528657"><span class="hs-identifier hs-var">fun</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name, Function op)
-&gt; [(Name, Function op)] -&gt; [(Name, Function op)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Function op)]
</span><a href="#local-6989586621684528655"><span class="hs-identifier hs-var">fs</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span class="hs-comment">-- | Check if a function of a given name exists.</span><span>
</span><span id="line-421"></span><span id="local-6989586621684530297"><span id="local-6989586621684530298"><span id="local-6989586621684530299"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#hasFunction"><span class="hs-identifier hs-type">hasFunction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530299"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530298"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530297"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span></span></span><span>
</span><span id="line-422"></span><span id="hasFunction"><span class="annot"><span class="annottext">hasFunction :: forall rep r op. Name -&gt; ImpM rep r op Bool
</span><a href="Futhark.CodeGen.ImpGen.html#hasFunction"><span class="hs-identifier hs-var hs-var">hasFunction</span></a></span></span><span> </span><span id="local-6989586621684528650"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528650"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; Bool) -&gt; ImpM rep r op Bool
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">((ImpState rep r op -&gt; Bool) -&gt; ImpM rep r op Bool)
-&gt; (ImpState rep r op -&gt; Bool) -&gt; ImpM rep r op Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684528649"><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528649"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Functions"><span class="hs-identifier hs-type">Imp.Functions</span></a></span><span> </span><span id="local-6989586621684528648"><span class="annot"><span class="annottext">[(Name, Function op)]
</span><a href="#local-6989586621684528648"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; Functions op
forall rep r op. ImpState rep r op -&gt; Functions op
</span><a href="Futhark.CodeGen.ImpGen.html#stateFunctions"><span class="hs-identifier hs-var hs-var">stateFunctions</span></a></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528649"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-424"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Maybe (Function op) -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Function op) -&gt; Bool) -&gt; Maybe (Function op) -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [(Name, Function op)] -&gt; Maybe (Function op)
forall a b. Eq a =&gt; a -&gt; [(a, b)] -&gt; Maybe b
</span><span class="hs-identifier hs-var">lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528650"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, Function op)]
</span><a href="#local-6989586621684528648"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span id="local-6989586621684530289"><span id="local-6989586621684530290"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#constsVTable"><span class="hs-identifier hs-type">constsVTable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530290"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530289"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530290"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VTable"><span class="hs-identifier hs-type">VTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530290"><span class="hs-identifier hs-type">rep</span></a></span></span></span><span>
</span><span id="line-427"></span><span id="constsVTable"><span class="annot"><span class="annottext">constsVTable :: forall rep inner. Mem rep inner =&gt; Stms rep -&gt; VTable rep
</span><a href="Futhark.CodeGen.ImpGen.html#constsVTable"><span class="hs-identifier hs-var hs-var">constsVTable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; Map VName (VarEntry rep))
-&gt; Seq (Stm rep) -&gt; Map VName (VarEntry rep)
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Map VName (VarEntry rep)
forall {rep}.
HasLetDecMem (LetDec rep) =&gt;
Stm rep -&gt; Map VName (VarEntry rep)
</span><a href="#local-6989586621684528634"><span class="hs-identifier hs-var">stmVtable</span></a></span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-429"></span><span>    </span><span id="local-6989586621684528634"><span class="annot"><span class="annottext">stmVtable :: Stm rep -&gt; Map VName (VarEntry rep)
</span><a href="#local-6989586621684528634"><span class="hs-identifier hs-var hs-var">stmVtable</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684528625"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684528625"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528624"><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684528624"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-430"></span><span>      </span><span class="annot"><span class="annottext">(PatElemT (LetDec rep) -&gt; Map VName (VarEntry rep))
-&gt; [PatElemT (LetDec rep)] -&gt; Map VName (VarEntry rep)
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp rep -&gt; PatElemT (LetDec rep) -&gt; Map VName (VarEntry rep)
forall {t} {rep}.
HasLetDecMem t =&gt;
Exp rep -&gt; PatElemT t -&gt; Map VName (VarEntry rep)
</span><a href="#local-6989586621684528623"><span class="hs-identifier hs-var">peVtable</span></a></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684528624"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT (LetDec rep)] -&gt; Map VName (VarEntry rep))
-&gt; [PatElemT (LetDec rep)] -&gt; Map VName (VarEntry rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; [PatElemT (LetDec rep)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684528625"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-431"></span><span>    </span><span id="local-6989586621684528623"><span class="annot"><span class="annottext">peVtable :: Exp rep -&gt; PatElemT t -&gt; Map VName (VarEntry rep)
</span><a href="#local-6989586621684528623"><span class="hs-identifier hs-var hs-var">peVtable</span></a></span></span><span> </span><span id="local-6989586621684528619"><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684528619"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-type">PatElem</span></a></span><span> </span><span id="local-6989586621684528617"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528617"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684528616"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684528616"><span class="hs-identifier hs-var">dec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-432"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; VarEntry rep -&gt; Map VName (VarEntry rep)
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528617"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(VarEntry rep -&gt; Map VName (VarEntry rep))
-&gt; VarEntry rep -&gt; Map VName (VarEntry rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; LParamMem -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; LParamMem -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#memBoundToVarEntry"><span class="hs-identifier hs-var">memBoundToVarEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp rep -&gt; Maybe (Exp rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684528619"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; VarEntry rep) -&gt; LParamMem -&gt; VarEntry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; LParamMem
forall t. HasLetDecMem t =&gt; t -&gt; LParamMem
</span><a href="Futhark.IR.Mem.html#letDecMem"><span class="hs-identifier hs-var">letDecMem</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684528616"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-433"></span><span>
</span><span id="line-434"></span><span id="local-6989586621684530265"><span id="local-6989586621684530266"><span id="local-6989586621684530267"><span id="local-6989586621684530268"><span id="local-6989586621684530269"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileProg"><span class="hs-identifier hs-type">compileProg</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-435"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530269"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530268"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#FreeIn"><span class="hs-identifier hs-type">FreeIn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530267"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530266"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-436"></span><span>  </span><span class="annot"><a href="#local-6989586621684530265"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-437"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-type">Operations</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530269"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530265"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530267"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-438"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Imp.Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-439"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530269"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-440"></span><span>  </span><span class="annot"><a href="#local-6989586621684530266"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Warnings.html#Warnings"><span class="hs-identifier hs-type">Warnings</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Definitions"><span class="hs-identifier hs-type">Imp.Definitions</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530267"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span></span></span></span></span></span><span>
</span><span id="line-441"></span><span id="compileProg"><span class="annot"><span class="annottext">compileProg :: forall rep inner op (m :: * -&gt; *) r.
(Mem rep inner, FreeIn op, MonadFreshNames m) =&gt;
r
-&gt; Operations rep r op
-&gt; Space
-&gt; Prog rep
-&gt; m (Warnings, Definitions op)
</span><a href="Futhark.CodeGen.ImpGen.html#compileProg"><span class="hs-identifier hs-var hs-var">compileProg</span></a></span></span><span> </span><span id="local-6989586621684528568"><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621684528568"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684528567"><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684528567"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684528566"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528566"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span id="local-6989586621684528564"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528564"><span class="hs-identifier hs-var">consts</span></a></span></span><span> </span><span id="local-6989586621684528563"><span class="annot"><span class="annottext">[FunDef rep]
</span><a href="#local-6989586621684528563"><span class="hs-identifier hs-var">funs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-442"></span><span>  </span><span class="annot"><span class="annottext">(VNameSource -&gt; ((Warnings, Definitions op), VNameSource))
-&gt; m (Warnings, Definitions op)
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
(VNameSource -&gt; (a, VNameSource)) -&gt; m a
</span><a href="Futhark.MonadFreshNames.html#modifyNameSource"><span class="hs-identifier hs-var">modifyNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">((VNameSource -&gt; ((Warnings, Definitions op), VNameSource))
 -&gt; m (Warnings, Definitions op))
-&gt; (VNameSource -&gt; ((Warnings, Definitions op), VNameSource))
-&gt; m (Warnings, Definitions op)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684528561"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684528561"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-443"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[()]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528560"><span class="annot"><span class="annottext">[ImpState rep r op]
</span><a href="#local-6989586621684528560"><span class="hs-identifier hs-var">ss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-444"></span><span>          </span><span class="annot"><span class="annottext">[((), ImpState rep r op)] -&gt; ([()], [ImpState rep r op])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([((), ImpState rep r op)] -&gt; ([()], [ImpState rep r op]))
-&gt; [((), ImpState rep r op)] -&gt; ([()], [ImpState rep r op])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Strategy ((), ImpState rep r op)
-&gt; (FunDef rep -&gt; ((), ImpState rep r op))
-&gt; [FunDef rep]
-&gt; [((), ImpState rep r op)]
forall b a. Strategy b -&gt; (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">parMap</span></span><span> </span><span class="annot"><span class="annottext">Strategy ((), ImpState rep r op)
forall a. Strategy a
</span><span class="hs-identifier hs-var">rpar</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VNameSource -&gt; FunDef rep -&gt; ((), ImpState rep r op)
</span><a href="#local-6989586621684528556"><span class="hs-identifier hs-var">compileFunDef'</span></a></span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684528561"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FunDef rep]
</span><a href="#local-6989586621684528563"><span class="hs-identifier hs-var">funs</span></a></span><span>
</span><span id="line-445"></span><span>        </span><span id="local-6989586621684528555"><span class="annot"><span class="annottext">free_in_funs :: Names
</span><a href="#local-6989586621684528555"><span class="hs-identifier hs-var hs-var">free_in_funs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-446"></span><span>          </span><span class="annot"><span class="annottext">Functions op -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">(Functions op -&gt; Names) -&gt; Functions op -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Functions op] -&gt; Functions op
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Functions op] -&gt; Functions op) -&gt; [Functions op] -&gt; Functions op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; Functions op)
-&gt; [ImpState rep r op] -&gt; [Functions op]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; Functions op
forall rep r op. ImpState rep r op -&gt; Functions op
</span><a href="Futhark.CodeGen.ImpGen.html#stateFunctions"><span class="hs-identifier hs-var hs-var">stateFunctions</span></a></span><span> </span><span class="annot"><span class="annottext">[ImpState rep r op]
</span><a href="#local-6989586621684528560"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-447"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684528553"><span class="annot"><span class="annottext">Constants op
</span><a href="#local-6989586621684528553"><span class="hs-identifier hs-var">consts'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528552"><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528552"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-448"></span><span>          </span><span class="annot"><span class="annottext">ImpM rep r op (Constants op)
-&gt; r
-&gt; Operations rep r op
-&gt; Space
-&gt; ImpState rep r op
-&gt; (Constants op, ImpState rep r op)
forall rep r op a.
ImpM rep r op a
-&gt; r
-&gt; Operations rep r op
-&gt; Space
-&gt; ImpState rep r op
-&gt; (a, ImpState rep r op)
</span><a href="Futhark.CodeGen.ImpGen.html#runImpM"><span class="hs-identifier hs-var">runImpM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; Stms rep -&gt; ImpM rep r op (Constants op)
forall rep r op. Names -&gt; Stms rep -&gt; ImpM rep r op (Constants op)
</span><a href="Futhark.CodeGen.ImpGen.html#compileConsts"><span class="hs-identifier hs-var">compileConsts</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684528555"><span class="hs-identifier hs-var">free_in_funs</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528564"><span class="hs-identifier hs-var">consts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621684528568"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684528567"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528566"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; (Constants op, ImpState rep r op))
-&gt; ImpState rep r op -&gt; (Constants op, ImpState rep r op)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-449"></span><span>            </span><span class="annot"><span class="annottext">[ImpState rep r op] -&gt; ImpState rep r op
forall {rep} {r} {op} {rep} {r}.
[ImpState rep r op] -&gt; ImpState rep r op
</span><a href="#local-6989586621684528550"><span class="hs-identifier hs-var">combineStates</span></a></span><span> </span><span class="annot"><span class="annottext">[ImpState rep r op]
</span><a href="#local-6989586621684528560"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-450"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; Warnings
forall rep r op. ImpState rep r op -&gt; Warnings
</span><a href="Futhark.CodeGen.ImpGen.html#stateWarnings"><span class="hs-identifier hs-var hs-var">stateWarnings</span></a></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528552"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-451"></span><span>            </span><span class="annot"><span class="annottext">Constants op -&gt; Functions op -&gt; Definitions op
forall a. Constants a -&gt; Functions a -&gt; Definitions a
</span><a href="Futhark.CodeGen.ImpCode.html#Definitions"><span class="hs-identifier hs-var">Imp.Definitions</span></a></span><span> </span><span class="annot"><span class="annottext">Constants op
</span><a href="#local-6989586621684528553"><span class="hs-identifier hs-var">consts'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ImpState rep r op -&gt; Functions op
forall rep r op. ImpState rep r op -&gt; Functions op
</span><a href="Futhark.CodeGen.ImpGen.html#stateFunctions"><span class="hs-identifier hs-var hs-var">stateFunctions</span></a></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528552"><span class="hs-identifier hs-var">s'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-452"></span><span>          </span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-453"></span><span>          </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; VNameSource
forall rep r op. ImpState rep r op -&gt; VNameSource
</span><a href="Futhark.CodeGen.ImpGen.html#stateNameSource"><span class="hs-identifier hs-var hs-var">stateNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684528552"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-454"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-455"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-456"></span><span>    </span><span id="local-6989586621684528556"><span class="annot"><span class="annottext">compileFunDef' :: VNameSource -&gt; FunDef rep -&gt; ((), ImpState rep r op)
</span><a href="#local-6989586621684528556"><span class="hs-identifier hs-var hs-var">compileFunDef'</span></a></span></span><span> </span><span id="local-6989586621684528548"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684528548"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621684528547"><span class="annot"><span class="annottext">FunDef rep
</span><a href="#local-6989586621684528547"><span class="hs-identifier hs-var">fdef</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-457"></span><span>      </span><span class="annot"><span class="annottext">ImpM rep r op ()
-&gt; r
-&gt; Operations rep r op
-&gt; Space
-&gt; ImpState rep r op
-&gt; ((), ImpState rep r op)
forall rep r op a.
ImpM rep r op a
-&gt; r
-&gt; Operations rep r op
-&gt; Space
-&gt; ImpState rep r op
-&gt; (a, ImpState rep r op)
</span><a href="Futhark.CodeGen.ImpGen.html#runImpM"><span class="hs-identifier hs-var">runImpM</span></a></span><span>
</span><span id="line-458"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunDef rep -&gt; ImpM rep r op ()
forall rep inner r op.
Mem rep inner =&gt;
FunDef rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileFunDef"><span class="hs-identifier hs-var">compileFunDef</span></a></span><span> </span><span class="annot"><span class="annottext">FunDef rep
</span><a href="#local-6989586621684528547"><span class="hs-identifier hs-var">fdef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-459"></span><span>        </span><span class="annot"><span class="annottext">r
</span><a href="#local-6989586621684528568"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-460"></span><span>        </span><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684528567"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-461"></span><span>        </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528566"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-462"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VNameSource -&gt; ImpState rep Any op
forall rep r op. VNameSource -&gt; ImpState rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#newState"><span class="hs-identifier hs-var">newState</span></a></span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684528548"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateVTable :: VTable rep
</span><a href="Futhark.CodeGen.ImpGen.html#stateVTable"><span class="hs-identifier hs-var">stateVTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; VTable rep
forall rep inner. Mem rep inner =&gt; Stms rep -&gt; VTable rep
</span><a href="Futhark.CodeGen.ImpGen.html#constsVTable"><span class="hs-identifier hs-var">constsVTable</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528564"><span class="hs-identifier hs-var">consts</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-463"></span><span>
</span><span id="line-464"></span><span>    </span><span id="local-6989586621684528550"><span class="annot"><span class="annottext">combineStates :: [ImpState rep r op] -&gt; ImpState rep r op
</span><a href="#local-6989586621684528550"><span class="hs-identifier hs-var hs-var">combineStates</span></a></span></span><span> </span><span id="local-6989586621684528539"><span class="annot"><span class="annottext">[ImpState rep r op]
</span><a href="#local-6989586621684528539"><span class="hs-identifier hs-var">ss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-465"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Functions"><span class="hs-identifier hs-type">Imp.Functions</span></a></span><span> </span><span id="local-6989586621684528538"><span class="annot"><span class="annottext">[(Name, Function op)]
</span><a href="#local-6989586621684528538"><span class="hs-identifier hs-var">funs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Functions op] -&gt; Functions op
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Functions op] -&gt; Functions op) -&gt; [Functions op] -&gt; Functions op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; Functions op)
-&gt; [ImpState rep r op] -&gt; [Functions op]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; Functions op
forall rep r op. ImpState rep r op -&gt; Functions op
</span><a href="Futhark.CodeGen.ImpGen.html#stateFunctions"><span class="hs-identifier hs-var hs-var">stateFunctions</span></a></span><span> </span><span class="annot"><span class="annottext">[ImpState rep r op]
</span><a href="#local-6989586621684528539"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-466"></span><span>          </span><span id="local-6989586621684528537"><span class="annot"><span class="annottext">src :: VNameSource
</span><a href="#local-6989586621684528537"><span class="hs-identifier hs-var hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VNameSource] -&gt; VNameSource
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; VNameSource)
-&gt; [ImpState rep r op] -&gt; [VNameSource]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; VNameSource
forall rep r op. ImpState rep r op -&gt; VNameSource
</span><a href="Futhark.CodeGen.ImpGen.html#stateNameSource"><span class="hs-identifier hs-var hs-var">stateNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">[ImpState rep r op]
</span><a href="#local-6989586621684528539"><span class="hs-identifier hs-var">ss</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-467"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VNameSource -&gt; ImpState rep Any op
forall rep r op. VNameSource -&gt; ImpState rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#newState"><span class="hs-identifier hs-var">newState</span></a></span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684528537"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">stateFunctions :: Functions op
</span><a href="Futhark.CodeGen.ImpGen.html#stateFunctions"><span class="hs-identifier hs-var">stateFunctions</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-469"></span><span>                </span><span class="annot"><span class="annottext">[(Name, Function op)] -&gt; Functions op
forall a. [(Name, Function a)] -&gt; Functions a
</span><a href="Futhark.CodeGen.ImpCode.html#Functions"><span class="hs-identifier hs-var">Imp.Functions</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, Function op)] -&gt; Functions op)
-&gt; [(Name, Function op)] -&gt; Functions op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Name (Function op) -&gt; [(Name, Function op)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">(Map Name (Function op) -&gt; [(Name, Function op)])
-&gt; Map Name (Function op) -&gt; [(Name, Function op)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Function op)] -&gt; Map Name (Function op)
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Function op)]
</span><a href="#local-6989586621684528538"><span class="hs-identifier hs-var">funs'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-470"></span><span>              </span><span class="annot"><span class="annottext">stateWarnings :: Warnings
</span><a href="Futhark.CodeGen.ImpGen.html#stateWarnings"><span class="hs-identifier hs-var">stateWarnings</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-471"></span><span>                </span><span class="annot"><span class="annottext">[Warnings] -&gt; Warnings
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Warnings] -&gt; Warnings) -&gt; [Warnings] -&gt; Warnings
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; Warnings)
-&gt; [ImpState rep r op] -&gt; [Warnings]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; Warnings
forall rep r op. ImpState rep r op -&gt; Warnings
</span><a href="Futhark.CodeGen.ImpGen.html#stateWarnings"><span class="hs-identifier hs-var hs-var">stateWarnings</span></a></span><span> </span><span class="annot"><span class="annottext">[ImpState rep r op]
</span><a href="#local-6989586621684528539"><span class="hs-identifier hs-var">ss</span></a></span><span>
</span><span id="line-472"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-473"></span><span>
</span><span id="line-474"></span><span id="local-6989586621684530243"><span id="local-6989586621684530244"><span id="local-6989586621684530245"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileConsts"><span class="hs-identifier hs-type">compileConsts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530245"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530245"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530244"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530243"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Constants"><span class="hs-identifier hs-type">Imp.Constants</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530243"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-475"></span><span id="compileConsts"><span class="annot"><span class="annottext">compileConsts :: forall rep r op. Names -&gt; Stms rep -&gt; ImpM rep r op (Constants op)
</span><a href="Futhark.CodeGen.ImpGen.html#compileConsts"><span class="hs-identifier hs-var hs-var">compileConsts</span></a></span></span><span> </span><span id="local-6989586621684528520"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684528520"><span class="hs-identifier hs-var">used_consts</span></a></span></span><span> </span><span id="local-6989586621684528519"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528519"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-476"></span><span>  </span><span id="local-6989586621684528518"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528518"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op (Code op))
-&gt; ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684528520"><span class="hs-identifier hs-var">used_consts</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528519"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-477"></span><span>  </span><span class="annot"><span class="annottext">Constants op -&gt; ImpM rep r op (Constants op)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Constants op -&gt; ImpM rep r op (Constants op))
-&gt; Constants op -&gt; ImpM rep r op (Constants op)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([Param] -&gt; Code op -&gt; Constants op)
-&gt; ([Param], Code op) -&gt; Constants op
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">[Param] -&gt; Code op -&gt; Constants op
forall a. [Param] -&gt; Code a -&gt; Constants a
</span><a href="Futhark.CodeGen.ImpCode.html#Constants"><span class="hs-identifier hs-var">Imp.Constants</span></a></span><span> </span><span class="annot"><span class="annottext">(([Param], Code op) -&gt; Constants op)
-&gt; ([Param], Code op) -&gt; Constants op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DList Param -&gt; [Param])
-&gt; (DList Param, Code op) -&gt; ([Param], Code op)
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">DList Param -&gt; [Param]
forall a. DList a -&gt; [a]
</span><span class="hs-identifier hs-var">DL.toList</span></span><span> </span><span class="annot"><span class="annottext">((DList Param, Code op) -&gt; ([Param], Code op))
-&gt; (DList Param, Code op) -&gt; ([Param], Code op)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code op -&gt; (DList Param, Code op)
</span><a href="#local-6989586621684528514"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528518"><span class="hs-identifier hs-var">code</span></a></span><span>
</span><span id="line-478"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-479"></span><span>    </span><span class="hs-comment">-- Fish out those top-level declarations in the constant</span><span>
</span><span id="line-480"></span><span>    </span><span class="hs-comment">-- initialisation code that are free in the functions.</span><span>
</span><span id="line-481"></span><span>    </span><span id="local-6989586621684528514"><span class="annot"><span class="annottext">extract :: Code op -&gt; (DList Param, Code op)
</span><a href="#local-6989586621684528514"><span class="hs-identifier hs-var hs-var">extract</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684528513"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528513"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#%3A%3E%3E%3A"><span class="hs-operator hs-type">Imp.:&gt;&gt;:</span></a></span><span> </span><span id="local-6989586621684528511"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528511"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-482"></span><span>      </span><span class="annot"><span class="annottext">Code op -&gt; (DList Param, Code op)
</span><a href="#local-6989586621684528514"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528513"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(DList Param, Code op)
-&gt; (DList Param, Code op) -&gt; (DList Param, Code op)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Code op -&gt; (DList Param, Code op)
</span><a href="#local-6989586621684528514"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528511"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-483"></span><span>    </span><span class="annot"><a href="#local-6989586621684528514"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#DeclareMem"><span class="hs-identifier hs-type">Imp.DeclareMem</span></a></span><span> </span><span id="local-6989586621684528509"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528509"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684528508"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528508"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528509"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684528520"><span class="hs-identifier hs-var">used_consts</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-485"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Param -&gt; DList Param
forall a. a -&gt; DList a
</span><span class="hs-identifier hs-var">DL.singleton</span></span><span> </span><span class="annot"><span class="annottext">(Param -&gt; DList Param) -&gt; Param -&gt; DList Param
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#MemParam"><span class="hs-identifier hs-var">Imp.MemParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528509"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528508"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-486"></span><span>          </span><span class="annot"><span class="annottext">Code op
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-487"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-488"></span><span>    </span><span class="annot"><a href="#local-6989586621684528514"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#DeclareScalar"><span class="hs-identifier hs-type">Imp.DeclareScalar</span></a></span><span> </span><span id="local-6989586621684528503"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528503"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528502"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528502"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-489"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528503"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684528520"><span class="hs-identifier hs-var">used_consts</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-490"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Param -&gt; DList Param
forall a. a -&gt; DList a
</span><span class="hs-identifier hs-var">DL.singleton</span></span><span> </span><span class="annot"><span class="annottext">(Param -&gt; DList Param) -&gt; Param -&gt; DList Param
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#ScalarParam"><span class="hs-identifier hs-var">Imp.ScalarParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528503"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528502"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-491"></span><span>          </span><span class="annot"><span class="annottext">Code op
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-492"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-493"></span><span>    </span><span class="annot"><a href="#local-6989586621684528514"><span class="hs-identifier hs-var">extract</span></a></span><span> </span><span id="local-6989586621684528500"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528500"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-494"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DList Param
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528500"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span>
</span><span id="line-496"></span><span id="local-6989586621684530201"><span id="local-6989586621684530202"><span id="local-6989586621684530204"><span id="local-6989586621684530205"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileInParam"><span class="hs-identifier hs-type">compileInParam</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-497"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530205"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530204"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-498"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530205"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-499"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530205"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530202"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530201"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Param"><span class="hs-identifier hs-type">Imp.Param</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDecl"><span class="hs-identifier hs-type">ArrayDecl</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-500"></span><span id="compileInParam"><span class="annot"><span class="annottext">compileInParam :: forall rep inner r op.
Mem rep inner =&gt;
FParam rep -&gt; ImpM rep r op (Either Param ArrayDecl)
</span><a href="Futhark.CodeGen.ImpGen.html#compileInParam"><span class="hs-identifier hs-var hs-var">compileInParam</span></a></span></span><span> </span><span id="local-6989586621684528488"><span class="annot"><span class="annottext">FParam rep
</span><a href="#local-6989586621684528488"><span class="hs-identifier hs-var">fparam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; FParamMem
forall dec. Param dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var hs-var">paramDec</span></a></span><span> </span><span class="annot"><span class="annottext">FParam rep
Param FParamMem
</span><a href="#local-6989586621684528488"><span class="hs-identifier hs-var">fparam</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-501"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-type">MemPrim</span></a></span><span> </span><span id="local-6989586621684528485"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528485"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-502"></span><span>    </span><span class="annot"><span class="annottext">Either Param ArrayDecl -&gt; ImpM rep r op (Either Param ArrayDecl)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Param ArrayDecl -&gt; ImpM rep r op (Either Param ArrayDecl))
-&gt; Either Param ArrayDecl -&gt; ImpM rep r op (Either Param ArrayDecl)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param -&gt; Either Param ArrayDecl
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(Param -&gt; Either Param ArrayDecl)
-&gt; Param -&gt; Either Param ArrayDecl
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#ScalarParam"><span class="hs-identifier hs-var">Imp.ScalarParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528484"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528485"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-503"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-type">MemMem</span></a></span><span> </span><span id="local-6989586621684528482"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528482"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-504"></span><span>    </span><span class="annot"><span class="annottext">Either Param ArrayDecl -&gt; ImpM rep r op (Either Param ArrayDecl)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Param ArrayDecl -&gt; ImpM rep r op (Either Param ArrayDecl))
-&gt; Either Param ArrayDecl -&gt; ImpM rep r op (Either Param ArrayDecl)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param -&gt; Either Param ArrayDecl
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(Param -&gt; Either Param ArrayDecl)
-&gt; Param -&gt; Either Param ArrayDecl
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#MemParam"><span class="hs-identifier hs-var">Imp.MemParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528484"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528482"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-505"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684528480"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528480"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span id="local-6989586621684528479"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684528479"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684528477"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528477"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684528476"><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684528476"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-506"></span><span>    </span><span class="annot"><span class="annottext">Either Param ArrayDecl -&gt; ImpM rep r op (Either Param ArrayDecl)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either Param ArrayDecl -&gt; ImpM rep r op (Either Param ArrayDecl))
-&gt; Either Param ArrayDecl -&gt; ImpM rep r op (Either Param ArrayDecl)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ArrayDecl -&gt; Either Param ArrayDecl
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(ArrayDecl -&gt; Either Param ArrayDecl)
-&gt; ArrayDecl -&gt; Either Param ArrayDecl
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; MemLoc -&gt; ArrayDecl
</span><a href="Futhark.CodeGen.ImpGen.html#ArrayDecl"><span class="hs-identifier hs-var">ArrayDecl</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528484"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528480"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">(MemLoc -&gt; ArrayDecl) -&gt; MemLoc -&gt; ArrayDecl
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [SubExp] -&gt; IxFun (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-var">MemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528477"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684528479"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684528476"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-507"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-type">MemAcc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-508"></span><span>    </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op (Either Param ArrayDecl)
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Functions may not have accumulator parameters.&quot;</span></span><span>
</span><span id="line-509"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-510"></span><span>    </span><span id="local-6989586621684528484"><span class="annot"><span class="annottext">name :: VName
</span><a href="#local-6989586621684528484"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">FParam rep
Param FParamMem
</span><a href="#local-6989586621684528488"><span class="hs-identifier hs-var">fparam</span></a></span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span class="hs-keyword">data</span><span> </span><span id="ArrayDecl"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDecl"><span class="hs-identifier hs-var">ArrayDecl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ArrayDecl"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDecl"><span class="hs-identifier hs-var">ArrayDecl</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span id="local-6989586621684530182"><span id="local-6989586621684530183"><span id="local-6989586621684530185"><span id="local-6989586621684530186"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileInParams"><span class="hs-identifier hs-type">compileInParams</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-515"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530186"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530185"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-516"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530186"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-517"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#EntryParam"><span class="hs-identifier hs-type">EntryParam</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-518"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530186"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530183"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530182"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Param"><span class="hs-identifier hs-type">Imp.Param</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDecl"><span class="hs-identifier hs-type">ArrayDecl</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#ExternalValue"><span class="hs-identifier hs-type">Imp.ExternalValue</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-519"></span><span id="compileInParams"><span class="annot"><span class="annottext">compileInParams :: forall rep inner r op.
Mem rep inner =&gt;
[FParam rep]
-&gt; [EntryParam]
-&gt; ImpM rep r op ([Param], [ArrayDecl], [(Name, ExternalValue)])
</span><a href="Futhark.CodeGen.ImpGen.html#compileInParams"><span class="hs-identifier hs-var hs-var">compileInParams</span></a></span></span><span> </span><span id="local-6989586621684528411"><span class="annot"><span class="annottext">[FParam rep]
</span><a href="#local-6989586621684528411"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684528410"><span class="annot"><span class="annottext">[EntryParam]
</span><a href="#local-6989586621684528410"><span class="hs-identifier hs-var">eparams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-520"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684528409"><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528409"><span class="hs-identifier hs-var">ctx_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528408"><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528408"><span class="hs-identifier hs-var">val_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-521"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; [Param FParamMem] -&gt; ([Param FParamMem], [Param FParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[FParam rep]
[Param FParamMem]
</span><a href="#local-6989586621684528411"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EntryParam -&gt; Int) -&gt; [EntryParam] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">EntryPointType -&gt; Int
</span><a href="Futhark.IR.Prop.html#entryPointSize"><span class="hs-identifier hs-var">entryPointSize</span></a></span><span> </span><span class="annot"><span class="annottext">(EntryPointType -&gt; Int)
-&gt; (EntryParam -&gt; EntryPointType) -&gt; EntryParam -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">EntryParam -&gt; EntryPointType
</span><a href="Futhark.IR.Syntax.html#entryParamType"><span class="hs-identifier hs-var hs-var">entryParamType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EntryParam]
</span><a href="#local-6989586621684528410"><span class="hs-identifier hs-var">eparams</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FParam rep]
[Param FParamMem]
</span><a href="#local-6989586621684528411"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-522"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684528402"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684528402"><span class="hs-identifier hs-var">inparams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528401"><span class="annot"><span class="annottext">[ArrayDecl]
</span><a href="#local-6989586621684528401"><span class="hs-identifier hs-var">arrayds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Either Param ArrayDecl] -&gt; ([Param], [ArrayDecl])
forall a b. [Either a b] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">partitionEithers</span></span><span> </span><span class="annot"><span class="annottext">([Either Param ArrayDecl] -&gt; ([Param], [ArrayDecl]))
-&gt; ImpM rep r op [Either Param ArrayDecl]
-&gt; ImpM rep r op ([Param], [ArrayDecl])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem -&gt; ImpM rep r op (Either Param ArrayDecl))
-&gt; [Param FParamMem] -&gt; ImpM rep r op [Either Param ArrayDecl]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; ImpM rep r op (Either Param ArrayDecl)
forall rep inner r op.
Mem rep inner =&gt;
FParam rep -&gt; ImpM rep r op (Either Param ArrayDecl)
</span><a href="Futhark.CodeGen.ImpGen.html#compileInParam"><span class="hs-identifier hs-var">compileInParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528409"><span class="hs-identifier hs-var">ctx_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; [Param FParamMem] -&gt; [Param FParamMem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528408"><span class="hs-identifier hs-var">val_params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684528398"><span class="annot"><span class="annottext">findArray :: VName -&gt; Maybe ArrayDecl
</span><a href="#local-6989586621684528398"><span class="hs-identifier hs-var hs-var">findArray</span></a></span></span><span> </span><span id="local-6989586621684528397"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528397"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ArrayDecl -&gt; Bool) -&gt; [ArrayDecl] -&gt; Maybe ArrayDecl
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; ArrayDecl -&gt; Bool
</span><a href="#local-6989586621684528396"><span class="hs-identifier hs-var">isArrayDecl</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528397"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ArrayDecl]
</span><a href="#local-6989586621684528401"><span class="hs-identifier hs-var">arrayds</span></a></span><span>
</span><span id="line-524"></span><span>
</span><span id="line-525"></span><span>      </span><span id="local-6989586621684528395"><span class="annot"><span class="annottext">summaries :: Map VName Space
</span><a href="#local-6989586621684528395"><span class="hs-identifier hs-var hs-var">summaries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, Space)] -&gt; Map VName Space
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Space)] -&gt; Map VName Space)
-&gt; [(VName, Space)] -&gt; Map VName Space
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem -&gt; Maybe (VName, Space))
-&gt; [Param FParamMem] -&gt; [(VName, Space)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; Maybe (VName, Space)
forall {d} {u} {ret}.
Param (MemInfo d u ret) -&gt; Maybe (VName, Space)
</span><a href="#local-6989586621684528393"><span class="hs-identifier hs-var">memSummary</span></a></span><span> </span><span class="annot"><span class="annottext">[FParam rep]
[Param FParamMem]
</span><a href="#local-6989586621684528411"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-526"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-527"></span><span>          </span><span id="local-6989586621684528393"><span class="annot"><span class="annottext">memSummary :: Param (MemInfo d u ret) -&gt; Maybe (VName, Space)
</span><a href="#local-6989586621684528393"><span class="hs-identifier hs-var hs-var">memSummary</span></a></span></span><span> </span><span id="local-6989586621684528392"><span class="annot"><span class="annottext">Param (MemInfo d u ret)
</span><a href="#local-6989586621684528392"><span class="hs-identifier hs-var">param</span></a></span></span><span>
</span><span id="line-528"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-type">MemMem</span></a></span><span> </span><span id="local-6989586621684528391"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528391"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Param (MemInfo d u ret) -&gt; MemInfo d u ret
forall dec. Param dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var hs-var">paramDec</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo d u ret)
</span><a href="#local-6989586621684528392"><span class="hs-identifier hs-var">param</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-529"></span><span>              </span><span class="annot"><span class="annottext">(VName, Space) -&gt; Maybe (VName, Space)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo d u ret) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo d u ret)
</span><a href="#local-6989586621684528392"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528391"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-530"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-531"></span><span>              </span><span class="annot"><span class="annottext">Maybe (VName, Space)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-532"></span><span>
</span><span id="line-533"></span><span>      </span><span class="annot"><a href="#local-6989586621684528390"><span class="hs-identifier hs-type">findMemInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span>
</span><span id="line-534"></span><span>      </span><span id="local-6989586621684528390"><span class="annot"><span class="annottext">findMemInfo :: VName -&gt; Maybe Space
</span><a href="#local-6989586621684528390"><span class="hs-identifier hs-var hs-var">findMemInfo</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Map VName Space -&gt; Maybe Space)
-&gt; Map VName Space -&gt; VName -&gt; Maybe Space
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName Space -&gt; Maybe Space
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Map VName Space
</span><a href="#local-6989586621684528395"><span class="hs-identifier hs-var">summaries</span></a></span><span>
</span><span id="line-535"></span><span>
</span><span id="line-536"></span><span>      </span><span id="local-6989586621684528387"><span class="annot"><span class="annottext">mkValueDesc :: Param FParamMem -&gt; Signedness -&gt; Maybe ValueDesc
</span><a href="#local-6989586621684528387"><span class="hs-identifier hs-var hs-var">mkValueDesc</span></a></span></span><span> </span><span id="local-6989586621684528386"><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684528386"><span class="hs-identifier hs-var">fparam</span></a></span></span><span> </span><span id="local-6989586621684528385"><span class="annot"><span class="annottext">Signedness
</span><a href="#local-6989586621684528385"><span class="hs-identifier hs-var">signedness</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-537"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Maybe ArrayDecl
</span><a href="#local-6989586621684528398"><span class="hs-identifier hs-var">findArray</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Maybe ArrayDecl) -&gt; VName -&gt; Maybe ArrayDecl
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684528386"><span class="hs-identifier hs-var">fparam</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684528386"><span class="hs-identifier hs-var">fparam</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-538"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDecl"><span class="hs-identifier hs-type">ArrayDecl</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528383"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528383"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span id="local-6989586621684528382"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528382"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684528381"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684528381"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-539"></span><span>            </span><span id="local-6989586621684528380"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528380"><span class="hs-identifier hs-var">memspace</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe Space
</span><a href="#local-6989586621684528390"><span class="hs-identifier hs-var">findMemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528382"><span class="hs-identifier hs-var">mem</span></a></span><span>
</span><span id="line-540"></span><span>            </span><span class="annot"><span class="annottext">ValueDesc -&gt; Maybe ValueDesc
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ValueDesc -&gt; Maybe ValueDesc) -&gt; ValueDesc -&gt; Maybe ValueDesc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; PrimType -&gt; Signedness -&gt; [SubExp] -&gt; ValueDesc
</span><a href="Futhark.CodeGen.ImpCode.html#ArrayValue"><span class="hs-identifier hs-var">Imp.ArrayValue</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528382"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528380"><span class="hs-identifier hs-var">memspace</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528383"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Signedness
</span><a href="#local-6989586621684528385"><span class="hs-identifier hs-var">signedness</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684528381"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-541"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ArrayDecl
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684528378"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528378"><span class="hs-identifier hs-var">bt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-542"></span><span>            </span><span class="annot"><span class="annottext">ValueDesc -&gt; Maybe ValueDesc
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ValueDesc -&gt; Maybe ValueDesc) -&gt; ValueDesc -&gt; Maybe ValueDesc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Signedness -&gt; VName -&gt; ValueDesc
</span><a href="Futhark.CodeGen.ImpCode.html#ScalarValue"><span class="hs-identifier hs-var">Imp.ScalarValue</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528378"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Signedness
</span><a href="#local-6989586621684528385"><span class="hs-identifier hs-var">signedness</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ValueDesc) -&gt; VName -&gt; ValueDesc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684528386"><span class="hs-identifier hs-var">fparam</span></a></span><span>
</span><span id="line-543"></span><span>          </span><span class="annot"><span class="annottext">(Maybe ArrayDecl, Type)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-544"></span><span>            </span><span class="annot"><span class="annottext">Maybe ValueDesc
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span>      </span><span id="local-6989586621684528376"><span class="annot"><span class="annottext">mkExts :: [EntryParam] -&gt; [Param FParamMem] -&gt; [(Name, ExternalValue)]
</span><a href="#local-6989586621684528376"><span class="hs-identifier hs-var hs-var">mkExts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#EntryParam"><span class="hs-identifier hs-type">EntryParam</span></a></span><span> </span><span id="local-6989586621684528374"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528374"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#TypeOpaque"><span class="hs-identifier hs-type">TypeOpaque</span></a></span><span> </span><span id="local-6989586621684528372"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684528372"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621684528371"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684528371"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684528370"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528370"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684528369"><span class="annot"><span class="annottext">[EntryParam]
</span><a href="#local-6989586621684528369"><span class="hs-identifier hs-var">epts</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684528368"><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528368"><span class="hs-identifier hs-var">fparams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-547"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684528367"><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528367"><span class="hs-identifier hs-var">fparams'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528366"><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528366"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param FParamMem] -&gt; ([Param FParamMem], [Param FParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528370"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528368"><span class="hs-identifier hs-var">fparams</span></a></span><span>
</span><span id="line-548"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528374"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-549"></span><span>              </span><span class="annot"><span class="annottext">Uniqueness -&gt; [Char] -&gt; [ValueDesc] -&gt; ExternalValue
</span><a href="Futhark.CodeGen.ImpCode.html#OpaqueValue"><span class="hs-identifier hs-var">Imp.OpaqueValue</span></a></span><span>
</span><span id="line-550"></span><span>                </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684528372"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-551"></span><span>                </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684528371"><span class="hs-identifier hs-var">desc</span></a></span><span>
</span><span id="line-552"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Param FParamMem -&gt; Maybe ValueDesc)
-&gt; [Param FParamMem] -&gt; [ValueDesc]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem -&gt; Signedness -&gt; Maybe ValueDesc
</span><a href="#local-6989586621684528387"><span class="hs-operator hs-var">`mkValueDesc`</span></a></span><span> </span><span class="annot"><span class="annottext">Signedness
</span><a href="Futhark.CodeGen.ImpCode.html#TypeDirect"><span class="hs-identifier hs-var">Imp.TypeDirect</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528367"><span class="hs-identifier hs-var">fparams'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span>            </span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name, ExternalValue)
-&gt; [(Name, ExternalValue)] -&gt; [(Name, ExternalValue)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span>
</span><span id="line-554"></span><span>            </span><span class="annot"><span class="annottext">[EntryParam] -&gt; [Param FParamMem] -&gt; [(Name, ExternalValue)]
</span><a href="#local-6989586621684528376"><span class="hs-identifier hs-var">mkExts</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryParam]
</span><a href="#local-6989586621684528369"><span class="hs-identifier hs-var">epts</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528366"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-555"></span><span>      </span><span class="annot"><a href="#local-6989586621684528376"><span class="hs-identifier hs-var">mkExts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#EntryParam"><span class="hs-identifier hs-type">EntryParam</span></a></span><span> </span><span id="local-6989586621684528363"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528363"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#TypeUnsigned"><span class="hs-identifier hs-type">TypeUnsigned</span></a></span><span> </span><span id="local-6989586621684528361"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684528361"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684528360"><span class="annot"><span class="annottext">[EntryParam]
</span><a href="#local-6989586621684528360"><span class="hs-identifier hs-var">epts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684528359"><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684528359"><span class="hs-identifier hs-var">fparam</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684528358"><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528358"><span class="hs-identifier hs-var">fparams</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-556"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Name, ExternalValue) -&gt; [(Name, ExternalValue)]
forall a. Maybe a -&gt; [a]
</span><span class="hs-identifier hs-var">maybeToList</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528363"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExternalValue -&gt; (Name, ExternalValue))
-&gt; (ValueDesc -&gt; ExternalValue)
-&gt; ValueDesc
-&gt; (Name, ExternalValue)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; ValueDesc -&gt; ExternalValue
</span><a href="Futhark.CodeGen.ImpCode.html#TransparentValue"><span class="hs-identifier hs-var">Imp.TransparentValue</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684528361"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(ValueDesc -&gt; (Name, ExternalValue))
-&gt; Maybe ValueDesc -&gt; Maybe (Name, ExternalValue)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; Signedness -&gt; Maybe ValueDesc
</span><a href="#local-6989586621684528387"><span class="hs-identifier hs-var">mkValueDesc</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684528359"><span class="hs-identifier hs-var">fparam</span></a></span><span> </span><span class="annot"><span class="annottext">Signedness
</span><a href="Futhark.CodeGen.ImpCode.html#TypeUnsigned"><span class="hs-identifier hs-var">Imp.TypeUnsigned</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span>          </span><span class="annot"><span class="annottext">[(Name, ExternalValue)]
-&gt; [(Name, ExternalValue)] -&gt; [(Name, ExternalValue)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[EntryParam] -&gt; [Param FParamMem] -&gt; [(Name, ExternalValue)]
</span><a href="#local-6989586621684528376"><span class="hs-identifier hs-var">mkExts</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryParam]
</span><a href="#local-6989586621684528360"><span class="hs-identifier hs-var">epts</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528358"><span class="hs-identifier hs-var">fparams</span></a></span><span>
</span><span id="line-558"></span><span>      </span><span class="annot"><a href="#local-6989586621684528376"><span class="hs-identifier hs-var">mkExts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#EntryParam"><span class="hs-identifier hs-type">EntryParam</span></a></span><span> </span><span id="local-6989586621684528354"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528354"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#TypeDirect"><span class="hs-identifier hs-type">TypeDirect</span></a></span><span> </span><span id="local-6989586621684528352"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684528352"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684528351"><span class="annot"><span class="annottext">[EntryParam]
</span><a href="#local-6989586621684528351"><span class="hs-identifier hs-var">epts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684528350"><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684528350"><span class="hs-identifier hs-var">fparam</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684528349"><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528349"><span class="hs-identifier hs-var">fparams</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-559"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Name, ExternalValue) -&gt; [(Name, ExternalValue)]
forall a. Maybe a -&gt; [a]
</span><span class="hs-identifier hs-var">maybeToList</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528354"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExternalValue -&gt; (Name, ExternalValue))
-&gt; (ValueDesc -&gt; ExternalValue)
-&gt; ValueDesc
-&gt; (Name, ExternalValue)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; ValueDesc -&gt; ExternalValue
</span><a href="Futhark.CodeGen.ImpCode.html#TransparentValue"><span class="hs-identifier hs-var">Imp.TransparentValue</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684528352"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(ValueDesc -&gt; (Name, ExternalValue))
-&gt; Maybe ValueDesc -&gt; Maybe (Name, ExternalValue)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; Signedness -&gt; Maybe ValueDesc
</span><a href="#local-6989586621684528387"><span class="hs-identifier hs-var">mkValueDesc</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684528350"><span class="hs-identifier hs-var">fparam</span></a></span><span> </span><span class="annot"><span class="annottext">Signedness
</span><a href="Futhark.CodeGen.ImpCode.html#TypeDirect"><span class="hs-identifier hs-var">Imp.TypeDirect</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span>          </span><span class="annot"><span class="annottext">[(Name, ExternalValue)]
-&gt; [(Name, ExternalValue)] -&gt; [(Name, ExternalValue)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[EntryParam] -&gt; [Param FParamMem] -&gt; [(Name, ExternalValue)]
</span><a href="#local-6989586621684528376"><span class="hs-identifier hs-var">mkExts</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryParam]
</span><a href="#local-6989586621684528351"><span class="hs-identifier hs-var">epts</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528349"><span class="hs-identifier hs-var">fparams</span></a></span><span>
</span><span id="line-561"></span><span>      </span><span class="annot"><a href="#local-6989586621684528376"><span class="hs-identifier hs-var">mkExts</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryParam]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-562"></span><span>
</span><span id="line-563"></span><span>  </span><span class="annot"><span class="annottext">([Param], [ArrayDecl], [(Name, ExternalValue)])
-&gt; ImpM rep r op ([Param], [ArrayDecl], [(Name, ExternalValue)])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684528402"><span class="hs-identifier hs-var">inparams</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ArrayDecl]
</span><a href="#local-6989586621684528401"><span class="hs-identifier hs-var">arrayds</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[EntryParam] -&gt; [Param FParamMem] -&gt; [(Name, ExternalValue)]
</span><a href="#local-6989586621684528376"><span class="hs-identifier hs-var">mkExts</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryParam]
</span><a href="#local-6989586621684528410"><span class="hs-identifier hs-var">eparams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684528408"><span class="hs-identifier hs-var">val_params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-564"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-565"></span><span>    </span><span id="local-6989586621684528396"><span class="annot"><span class="annottext">isArrayDecl :: VName -&gt; ArrayDecl -&gt; Bool
</span><a href="#local-6989586621684528396"><span class="hs-identifier hs-var hs-var">isArrayDecl</span></a></span></span><span> </span><span id="local-6989586621684528347"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528347"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDecl"><span class="hs-identifier hs-type">ArrayDecl</span></a></span><span> </span><span id="local-6989586621684528346"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528346"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528347"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528346"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-566"></span><span>
</span><span id="line-567"></span><span id="local-6989586621684530142"><span id="local-6989586621684530143"><span id="local-6989586621684530144"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileOutParam"><span class="hs-identifier hs-type">compileOutParam</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-568"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#FunReturns"><span class="hs-identifier hs-type">FunReturns</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530144"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530143"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530142"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Param"><span class="hs-identifier hs-type">Imp.Param</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ValueDestination"><span class="hs-identifier hs-type">ValueDestination</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-569"></span><span id="compileOutParam"><span class="annot"><span class="annottext">compileOutParam :: forall rep r op.
RetTypeMem -&gt; ImpM rep r op (Maybe Param, ValueDestination)
</span><a href="Futhark.CodeGen.ImpGen.html#compileOutParam"><span class="hs-identifier hs-var hs-var">compileOutParam</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-type">MemPrim</span></a></span><span> </span><span id="local-6989586621684528334"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528334"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-570"></span><span>  </span><span id="local-6989586621684528333"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528333"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;prim_out&quot;</span></span><span>
</span><span id="line-571"></span><span>  </span><span class="annot"><span class="annottext">(Maybe Param, ValueDestination)
-&gt; ImpM rep r op (Maybe Param, ValueDestination)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param -&gt; Maybe Param
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Param -&gt; Maybe Param) -&gt; Param -&gt; Maybe Param
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#ScalarParam"><span class="hs-identifier hs-var">Imp.ScalarParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528333"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528334"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ValueDestination
</span><a href="Futhark.CodeGen.ImpGen.html#ScalarDestination"><span class="hs-identifier hs-var">ScalarDestination</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528333"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-572"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileOutParam"><span class="hs-identifier hs-var">compileOutParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-type">MemMem</span></a></span><span> </span><span id="local-6989586621684528331"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528331"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-573"></span><span>  </span><span id="local-6989586621684528330"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528330"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;mem_out&quot;</span></span><span>
</span><span id="line-574"></span><span>  </span><span class="annot"><span class="annottext">(Maybe Param, ValueDestination)
-&gt; ImpM rep r op (Maybe Param, ValueDestination)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param -&gt; Maybe Param
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Param -&gt; Maybe Param) -&gt; Param -&gt; Maybe Param
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#MemParam"><span class="hs-identifier hs-var">Imp.MemParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528330"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528331"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ValueDestination
</span><a href="Futhark.CodeGen.ImpGen.html#MemoryDestination"><span class="hs-identifier hs-var">MemoryDestination</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528330"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileOutParam"><span class="hs-identifier hs-var">compileOutParam</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-576"></span><span>  </span><span class="annot"><span class="annottext">(Maybe Param, ValueDestination)
-&gt; ImpM rep r op (Maybe Param, ValueDestination)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Param
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe MemLoc -&gt; ValueDestination
</span><a href="Futhark.CodeGen.ImpGen.html#ArrayDestination"><span class="hs-identifier hs-var">ArrayDestination</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe MemLoc
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-577"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileOutParam"><span class="hs-identifier hs-var">compileOutParam</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-type">MemAcc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-578"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op (Maybe Param, ValueDestination)
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Functions may not return accumulators.&quot;</span></span><span>
</span><span id="line-579"></span><span>
</span><span id="line-580"></span><span id="local-6989586621684530134"><span id="local-6989586621684530135"><span id="local-6989586621684530136"><span id="local-6989586621684530137"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileExternalValues"><span class="hs-identifier hs-type">compileExternalValues</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-581"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530137"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530136"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-582"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Rep.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530137"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-583"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#EntryPointType"><span class="hs-identifier hs-type">EntryPointType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-584"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Param"><span class="hs-identifier hs-type">Imp.Param</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-585"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530137"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530135"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530134"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#ExternalValue"><span class="hs-identifier hs-type">Imp.ExternalValue</span></a></span><span class="hs-special">]</span></span></span></span></span><span>
</span><span id="line-586"></span><span id="compileExternalValues"><span class="annot"><span class="annottext">compileExternalValues :: forall rep inner r op.
Mem rep inner =&gt;
[RetType rep]
-&gt; [EntryPointType]
-&gt; [Maybe Param]
-&gt; ImpM rep r op [ExternalValue]
</span><a href="Futhark.CodeGen.ImpGen.html#compileExternalValues"><span class="hs-identifier hs-var hs-var">compileExternalValues</span></a></span></span><span> </span><span id="local-6989586621684528279"><span class="annot"><span class="annottext">[RetType rep]
</span><a href="#local-6989586621684528279"><span class="hs-identifier hs-var">orig_rts</span></a></span></span><span> </span><span id="local-6989586621684528278"><span class="annot"><span class="annottext">[EntryPointType]
</span><a href="#local-6989586621684528278"><span class="hs-identifier hs-var">orig_epts</span></a></span></span><span> </span><span id="local-6989586621684528277"><span class="annot"><span class="annottext">[Maybe Param]
</span><a href="#local-6989586621684528277"><span class="hs-identifier hs-var">maybe_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-587"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684528276"><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684528276"><span class="hs-identifier hs-var">ctx_rts</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528275"><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684528275"><span class="hs-identifier hs-var">val_rts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-588"></span><span>        </span><span class="annot"><span class="annottext">Int -&gt; [RetTypeMem] -&gt; ([RetTypeMem], [RetTypeMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[RetTypeMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[RetType rep]
[RetTypeMem]
</span><a href="#local-6989586621684528279"><span class="hs-identifier hs-var">orig_rts</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(EntryPointType -&gt; Int) -&gt; [EntryPointType] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">EntryPointType -&gt; Int
</span><a href="Futhark.IR.Prop.html#entryPointSize"><span class="hs-identifier hs-var">entryPointSize</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryPointType]
</span><a href="#local-6989586621684528278"><span class="hs-identifier hs-var">orig_epts</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[RetType rep]
[RetTypeMem]
</span><a href="#local-6989586621684528279"><span class="hs-identifier hs-var">orig_rts</span></a></span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684528274"><span class="annot"><span class="annottext">nthOut :: Int -&gt; VName
</span><a href="#local-6989586621684528274"><span class="hs-identifier hs-var hs-var">nthOut</span></a></span></span><span> </span><span id="local-6989586621684528273"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528273"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Maybe Param] -&gt; Maybe (Maybe Param)
forall int a. Integral int =&gt; int -&gt; [a] -&gt; Maybe a
</span><a href="Futhark.Util.html#maybeNth"><span class="hs-identifier hs-var">maybeNth</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528273"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Param]
</span><a href="#local-6989586621684528277"><span class="hs-identifier hs-var">maybe_params</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-591"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684528271"><span class="annot"><span class="annottext">Param
</span><a href="#local-6989586621684528271"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Param -&gt; VName
</span><a href="Futhark.CodeGen.ImpCode.html#paramName"><span class="hs-identifier hs-var">Imp.paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param
</span><a href="#local-6989586621684528271"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-592"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Maybe Param
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; VName
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; VName) -&gt; [Char] -&gt; VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Output &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528273"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; not a param.&quot;</span></span><span>
</span><span id="line-593"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Maybe Param)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; VName
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; VName) -&gt; [Char] -&gt; VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Param &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Show a =&gt; a -&gt; [Char]
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528273"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; does not exist.&quot;</span></span><span>
</span><span id="line-594"></span><span>
</span><span id="line-595"></span><span>      </span><span id="local-6989586621684528268"><span class="annot"><span class="annottext">mkValueDesc :: Int -&gt; Signedness -&gt; RetTypeMem -&gt; ImpM rep r op ValueDesc
</span><a href="#local-6989586621684528268"><span class="hs-identifier hs-var hs-var">mkValueDesc</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528267"><span class="annot"><span class="annottext">Signedness
</span><a href="#local-6989586621684528267"><span class="hs-identifier hs-var">signedness</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684528266"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528266"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684528265"><span class="annot"><span class="annottext">ShapeBase (Ext SubExp)
</span><a href="#local-6989586621684528265"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528264"><span class="annot"><span class="annottext">MemReturn
</span><a href="#local-6989586621684528264"><span class="hs-identifier hs-var">ret</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-596"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684528263"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528263"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528262"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528262"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-597"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MemReturn
</span><a href="#local-6989586621684528264"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-598"></span><span>            </span><span class="annot"><a href="Futhark.IR.Mem.html#ReturnsNewBlock"><span class="hs-identifier hs-type">ReturnsNewBlock</span></a></span><span> </span><span id="local-6989586621684528260"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528260"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684528259"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528259"><span class="hs-identifier hs-var">j</span></a></span></span><span> </span><span id="local-6989586621684528258"><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684528258"><span class="hs-identifier hs-var">_ixfun</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-599"></span><span>              </span><span class="annot"><span class="annottext">(VName, Space) -&gt; ImpM rep r op (VName, Space)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; VName
</span><a href="#local-6989586621684528274"><span class="hs-identifier hs-var">nthOut</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528259"><span class="hs-identifier hs-var">j</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528260"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-600"></span><span>            </span><span class="annot"><a href="Futhark.IR.Mem.html#ReturnsInBlock"><span class="hs-identifier hs-type">ReturnsInBlock</span></a></span><span> </span><span id="local-6989586621684528256"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528256"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684528255"><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684528255"><span class="hs-identifier hs-var">_ixfun</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-601"></span><span>              </span><span id="local-6989586621684528254"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528254"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(MemEntry -&gt; Space)
-&gt; ImpM rep r op MemEntry -&gt; ImpM rep r op Space
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op MemEntry
forall rep r op. VName -&gt; ImpM rep r op MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier hs-var">lookupMemory</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528256"><span class="hs-identifier hs-var">mem</span></a></span><span>
</span><span id="line-602"></span><span>              </span><span class="annot"><span class="annottext">(VName, Space) -&gt; ImpM rep r op (VName, Space)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528256"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528254"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-603"></span><span>        </span><span class="annot"><span class="annottext">ValueDesc -&gt; ImpM rep r op ValueDesc
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ValueDesc -&gt; ImpM rep r op ValueDesc)
-&gt; ValueDesc -&gt; ImpM rep r op ValueDesc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; PrimType -&gt; Signedness -&gt; [SubExp] -&gt; ValueDesc
</span><a href="Futhark.CodeGen.ImpCode.html#ArrayValue"><span class="hs-identifier hs-var">Imp.ArrayValue</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528263"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528262"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528266"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Signedness
</span><a href="#local-6989586621684528267"><span class="hs-identifier hs-var">signedness</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; ValueDesc) -&gt; [SubExp] -&gt; ValueDesc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Ext SubExp -&gt; SubExp) -&gt; [Ext SubExp] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Ext SubExp -&gt; SubExp
</span><a href="#local-6989586621684528253"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">([Ext SubExp] -&gt; [SubExp]) -&gt; [Ext SubExp] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ShapeBase (Ext SubExp) -&gt; [Ext SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase (Ext SubExp)
</span><a href="#local-6989586621684528265"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-604"></span><span>        </span><span class="hs-keyword">where</span><span>
</span><span id="line-605"></span><span>          </span><span id="local-6989586621684528253"><span class="annot"><span class="annottext">f :: Ext SubExp -&gt; SubExp
</span><a href="#local-6989586621684528253"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-type">Free</span></a></span><span> </span><span id="local-6989586621684528251"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684528251"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684528251"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-606"></span><span>          </span><span class="annot"><a href="#local-6989586621684528253"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span id="local-6989586621684528249"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528249"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; VName
</span><a href="#local-6989586621684528274"><span class="hs-identifier hs-var">nthOut</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528249"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-607"></span><span>      </span><span class="annot"><a href="#local-6989586621684528268"><span class="hs-identifier hs-var">mkValueDesc</span></a></span><span> </span><span id="local-6989586621684528247"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528247"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684528246"><span class="annot"><span class="annottext">Signedness
</span><a href="#local-6989586621684528246"><span class="hs-identifier hs-var">signedness</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-type">MemPrim</span></a></span><span> </span><span id="local-6989586621684528245"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528245"><span class="hs-identifier hs-var">bt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-608"></span><span>        </span><span class="annot"><span class="annottext">ValueDesc -&gt; ImpM rep r op ValueDesc
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ValueDesc -&gt; ImpM rep r op ValueDesc)
-&gt; ValueDesc -&gt; ImpM rep r op ValueDesc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Signedness -&gt; VName -&gt; ValueDesc
</span><a href="Futhark.CodeGen.ImpCode.html#ScalarValue"><span class="hs-identifier hs-var">Imp.ScalarValue</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528245"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Signedness
</span><a href="#local-6989586621684528246"><span class="hs-identifier hs-var">signedness</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ValueDesc) -&gt; VName -&gt; ValueDesc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; VName
</span><a href="#local-6989586621684528274"><span class="hs-identifier hs-var">nthOut</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528247"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-609"></span><span>      </span><span class="annot"><a href="#local-6989586621684528268"><span class="hs-identifier hs-var">mkValueDesc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Signedness
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-type">MemAcc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-610"></span><span>        </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ValueDesc
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;mkValueDesc: unexpected MemAcc output.&quot;</span></span><span>
</span><span id="line-611"></span><span>      </span><span class="annot"><a href="#local-6989586621684528268"><span class="hs-identifier hs-var">mkValueDesc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Signedness
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-type">MemMem</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-612"></span><span>        </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ValueDesc
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;mkValueDesc: unexpected MemMem output.&quot;</span></span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span>      </span><span id="local-6989586621684528244"><span class="annot"><span class="annottext">mkExts :: Int
-&gt; [EntryPointType]
-&gt; [RetTypeMem]
-&gt; ImpM rep r op [ExternalValue]
</span><a href="#local-6989586621684528244"><span class="hs-identifier hs-var hs-var">mkExts</span></a></span></span><span> </span><span id="local-6989586621684528243"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528243"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#TypeOpaque"><span class="hs-identifier hs-type">TypeOpaque</span></a></span><span> </span><span id="local-6989586621684528242"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684528242"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621684528241"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684528241"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684528240"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528240"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684528239"><span class="annot"><span class="annottext">[EntryPointType]
</span><a href="#local-6989586621684528239"><span class="hs-identifier hs-var">epts</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684528238"><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684528238"><span class="hs-identifier hs-var">rets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-615"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684528237"><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684528237"><span class="hs-identifier hs-var">rets'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528236"><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684528236"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [RetTypeMem] -&gt; ([RetTypeMem], [RetTypeMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528240"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684528238"><span class="hs-identifier hs-var">rets</span></a></span><span>
</span><span id="line-616"></span><span>        </span><span id="local-6989586621684528235"><span class="annot"><span class="annottext">[ValueDesc]
</span><a href="#local-6989586621684528235"><span class="hs-identifier hs-var">vds</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; RetTypeMem -&gt; ImpM rep r op ValueDesc)
-&gt; [Int] -&gt; [RetTypeMem] -&gt; ImpM rep r op [ValueDesc]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Signedness -&gt; RetTypeMem -&gt; ImpM rep r op ValueDesc
</span><a href="#local-6989586621684528268"><span class="hs-operator hs-var">`mkValueDesc`</span></a></span><span> </span><span class="annot"><span class="annottext">Signedness
</span><a href="Futhark.CodeGen.ImpCode.html#TypeDirect"><span class="hs-identifier hs-var">Imp.TypeDirect</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528243"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684528237"><span class="hs-identifier hs-var">rets'</span></a></span><span>
</span><span id="line-617"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uniqueness -&gt; [Char] -&gt; [ValueDesc] -&gt; ExternalValue
</span><a href="Futhark.CodeGen.ImpCode.html#OpaqueValue"><span class="hs-identifier hs-var">Imp.OpaqueValue</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684528242"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684528241"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">[ValueDesc]
</span><a href="#local-6989586621684528235"><span class="hs-identifier hs-var">vds</span></a></span><span> </span><span class="annot"><span class="annottext">ExternalValue -&gt; [ExternalValue] -&gt; [ExternalValue]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([ExternalValue] -&gt; [ExternalValue])
-&gt; ImpM rep r op [ExternalValue] -&gt; ImpM rep r op [ExternalValue]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [EntryPointType]
-&gt; [RetTypeMem]
-&gt; ImpM rep r op [ExternalValue]
</span><a href="#local-6989586621684528244"><span class="hs-identifier hs-var">mkExts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528243"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528240"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EntryPointType]
</span><a href="#local-6989586621684528239"><span class="hs-identifier hs-var">epts</span></a></span><span> </span><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684528236"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-618"></span><span>      </span><span class="annot"><a href="#local-6989586621684528244"><span class="hs-identifier hs-var">mkExts</span></a></span><span> </span><span id="local-6989586621684528232"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528232"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#TypeUnsigned"><span class="hs-identifier hs-type">TypeUnsigned</span></a></span><span> </span><span id="local-6989586621684528231"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684528231"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684528230"><span class="annot"><span class="annottext">[EntryPointType]
</span><a href="#local-6989586621684528230"><span class="hs-identifier hs-var">epts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684528229"><span class="annot"><span class="annottext">RetTypeMem
</span><a href="#local-6989586621684528229"><span class="hs-identifier hs-var">ret</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684528228"><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684528228"><span class="hs-identifier hs-var">rets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-619"></span><span>        </span><span id="local-6989586621684528227"><span class="annot"><span class="annottext">ValueDesc
</span><a href="#local-6989586621684528227"><span class="hs-identifier hs-var">vd</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Signedness -&gt; RetTypeMem -&gt; ImpM rep r op ValueDesc
</span><a href="#local-6989586621684528268"><span class="hs-identifier hs-var">mkValueDesc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528232"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Signedness
</span><a href="Futhark.CodeGen.ImpCode.html#TypeUnsigned"><span class="hs-identifier hs-var">Imp.TypeUnsigned</span></a></span><span> </span><span class="annot"><span class="annottext">RetTypeMem
</span><a href="#local-6989586621684528229"><span class="hs-identifier hs-var">ret</span></a></span><span>
</span><span id="line-620"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uniqueness -&gt; ValueDesc -&gt; ExternalValue
</span><a href="Futhark.CodeGen.ImpCode.html#TransparentValue"><span class="hs-identifier hs-var">Imp.TransparentValue</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684528231"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">ValueDesc
</span><a href="#local-6989586621684528227"><span class="hs-identifier hs-var">vd</span></a></span><span> </span><span class="annot"><span class="annottext">ExternalValue -&gt; [ExternalValue] -&gt; [ExternalValue]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([ExternalValue] -&gt; [ExternalValue])
-&gt; ImpM rep r op [ExternalValue] -&gt; ImpM rep r op [ExternalValue]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [EntryPointType]
-&gt; [RetTypeMem]
-&gt; ImpM rep r op [ExternalValue]
</span><a href="#local-6989586621684528244"><span class="hs-identifier hs-var">mkExts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528232"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EntryPointType]
</span><a href="#local-6989586621684528230"><span class="hs-identifier hs-var">epts</span></a></span><span> </span><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684528228"><span class="hs-identifier hs-var">rets</span></a></span><span>
</span><span id="line-621"></span><span>      </span><span class="annot"><a href="#local-6989586621684528244"><span class="hs-identifier hs-var">mkExts</span></a></span><span> </span><span id="local-6989586621684528226"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528226"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#TypeDirect"><span class="hs-identifier hs-type">TypeDirect</span></a></span><span> </span><span id="local-6989586621684528225"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684528225"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684528224"><span class="annot"><span class="annottext">[EntryPointType]
</span><a href="#local-6989586621684528224"><span class="hs-identifier hs-var">epts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684528223"><span class="annot"><span class="annottext">RetTypeMem
</span><a href="#local-6989586621684528223"><span class="hs-identifier hs-var">ret</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684528222"><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684528222"><span class="hs-identifier hs-var">rets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-622"></span><span>        </span><span id="local-6989586621684528221"><span class="annot"><span class="annottext">ValueDesc
</span><a href="#local-6989586621684528221"><span class="hs-identifier hs-var">vd</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Signedness -&gt; RetTypeMem -&gt; ImpM rep r op ValueDesc
</span><a href="#local-6989586621684528268"><span class="hs-identifier hs-var">mkValueDesc</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528226"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Signedness
</span><a href="Futhark.CodeGen.ImpCode.html#TypeDirect"><span class="hs-identifier hs-var">Imp.TypeDirect</span></a></span><span> </span><span class="annot"><span class="annottext">RetTypeMem
</span><a href="#local-6989586621684528223"><span class="hs-identifier hs-var">ret</span></a></span><span>
</span><span id="line-623"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uniqueness -&gt; ValueDesc -&gt; ExternalValue
</span><a href="Futhark.CodeGen.ImpCode.html#TransparentValue"><span class="hs-identifier hs-var">Imp.TransparentValue</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684528225"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">ValueDesc
</span><a href="#local-6989586621684528221"><span class="hs-identifier hs-var">vd</span></a></span><span> </span><span class="annot"><span class="annottext">ExternalValue -&gt; [ExternalValue] -&gt; [ExternalValue]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([ExternalValue] -&gt; [ExternalValue])
-&gt; ImpM rep r op [ExternalValue] -&gt; ImpM rep r op [ExternalValue]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [EntryPointType]
-&gt; [RetTypeMem]
-&gt; ImpM rep r op [ExternalValue]
</span><a href="#local-6989586621684528244"><span class="hs-identifier hs-var">mkExts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684528226"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EntryPointType]
</span><a href="#local-6989586621684528224"><span class="hs-identifier hs-var">epts</span></a></span><span> </span><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684528222"><span class="hs-identifier hs-var">rets</span></a></span><span>
</span><span id="line-624"></span><span>      </span><span class="annot"><a href="#local-6989586621684528244"><span class="hs-identifier hs-var">mkExts</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[EntryPointType]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[RetTypeMem]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ExternalValue] -&gt; ImpM rep r op [ExternalValue]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-625"></span><span>
</span><span id="line-626"></span><span>  </span><span class="annot"><span class="annottext">Int
-&gt; [EntryPointType]
-&gt; [RetTypeMem]
-&gt; ImpM rep r op [ExternalValue]
</span><a href="#local-6989586621684528244"><span class="hs-identifier hs-var">mkExts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[RetTypeMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684528276"><span class="hs-identifier hs-var">ctx_rts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[EntryPointType]
</span><a href="#local-6989586621684528278"><span class="hs-identifier hs-var">orig_epts</span></a></span><span> </span><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684528275"><span class="hs-identifier hs-var">val_rts</span></a></span><span>
</span><span id="line-627"></span><span>
</span><span id="line-628"></span><span id="local-6989586621684530114"><span id="local-6989586621684530115"><span id="local-6989586621684530116"><span id="local-6989586621684530117"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileOutParams"><span class="hs-identifier hs-type">compileOutParams</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-629"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530117"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530116"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-630"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Rep.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530117"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-631"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#EntryPointType"><span class="hs-identifier hs-type">EntryPointType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-632"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530117"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530115"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530114"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#ExternalValue"><span class="hs-identifier hs-type">Imp.ExternalValue</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Param"><span class="hs-identifier hs-type">Imp.Param</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ValueDestination"><span class="hs-identifier hs-type">ValueDestination</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-633"></span><span id="compileOutParams"><span class="annot"><span class="annottext">compileOutParams :: forall rep inner r op.
Mem rep inner =&gt;
[RetType rep]
-&gt; Maybe [EntryPointType]
-&gt; ImpM rep r op ([ExternalValue], [Param], [ValueDestination])
</span><a href="Futhark.CodeGen.ImpGen.html#compileOutParams"><span class="hs-identifier hs-var hs-var">compileOutParams</span></a></span></span><span> </span><span id="local-6989586621684528178"><span class="annot"><span class="annottext">[RetType rep]
</span><a href="#local-6989586621684528178"><span class="hs-identifier hs-var">orig_rts</span></a></span></span><span> </span><span id="local-6989586621684528177"><span class="annot"><span class="annottext">Maybe [EntryPointType]
</span><a href="#local-6989586621684528177"><span class="hs-identifier hs-var">maybe_orig_epts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-634"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684528176"><span class="annot"><span class="annottext">[Maybe Param]
</span><a href="#local-6989586621684528176"><span class="hs-identifier hs-var">maybe_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528175"><span class="annot"><span class="annottext">[ValueDestination]
</span><a href="#local-6989586621684528175"><span class="hs-identifier hs-var">dests</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Maybe Param, ValueDestination)]
-&gt; ([Maybe Param], [ValueDestination])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Maybe Param, ValueDestination)]
 -&gt; ([Maybe Param], [ValueDestination]))
-&gt; ImpM rep r op [(Maybe Param, ValueDestination)]
-&gt; ImpM rep r op ([Maybe Param], [ValueDestination])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(RetTypeMem -&gt; ImpM rep r op (Maybe Param, ValueDestination))
-&gt; [RetTypeMem] -&gt; ImpM rep r op [(Maybe Param, ValueDestination)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">RetTypeMem -&gt; ImpM rep r op (Maybe Param, ValueDestination)
forall rep r op.
RetTypeMem -&gt; ImpM rep r op (Maybe Param, ValueDestination)
</span><a href="Futhark.CodeGen.ImpGen.html#compileOutParam"><span class="hs-identifier hs-var">compileOutParam</span></a></span><span> </span><span class="annot"><span class="annottext">[RetType rep]
[RetTypeMem]
</span><a href="#local-6989586621684528178"><span class="hs-identifier hs-var">orig_rts</span></a></span><span>
</span><span id="line-635"></span><span>  </span><span id="local-6989586621684528174"><span class="annot"><span class="annottext">[ExternalValue]
</span><a href="#local-6989586621684528174"><span class="hs-identifier hs-var">evs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe [EntryPointType]
</span><a href="#local-6989586621684528177"><span class="hs-identifier hs-var">maybe_orig_epts</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-636"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684528173"><span class="annot"><span class="annottext">[EntryPointType]
</span><a href="#local-6989586621684528173"><span class="hs-identifier hs-var">orig_epts</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[RetType rep]
-&gt; [EntryPointType]
-&gt; [Maybe Param]
-&gt; ImpM rep r op [ExternalValue]
forall rep inner r op.
Mem rep inner =&gt;
[RetType rep]
-&gt; [EntryPointType]
-&gt; [Maybe Param]
-&gt; ImpM rep r op [ExternalValue]
</span><a href="Futhark.CodeGen.ImpGen.html#compileExternalValues"><span class="hs-identifier hs-var">compileExternalValues</span></a></span><span> </span><span class="annot"><span class="annottext">[RetType rep]
</span><a href="#local-6989586621684528178"><span class="hs-identifier hs-var">orig_rts</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryPointType]
</span><a href="#local-6989586621684528173"><span class="hs-identifier hs-var">orig_epts</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Param]
</span><a href="#local-6989586621684528176"><span class="hs-identifier hs-var">maybe_params</span></a></span><span>
</span><span id="line-637"></span><span>    </span><span class="annot"><span class="annottext">Maybe [EntryPointType]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[ExternalValue] -&gt; ImpM rep r op [ExternalValue]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-638"></span><span>  </span><span class="annot"><span class="annottext">([ExternalValue], [Param], [ValueDestination])
-&gt; ImpM rep r op ([ExternalValue], [Param], [ValueDestination])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ExternalValue]
</span><a href="#local-6989586621684528174"><span class="hs-identifier hs-var">evs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Maybe Param] -&gt; [Param]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">[Maybe Param]
</span><a href="#local-6989586621684528176"><span class="hs-identifier hs-var">maybe_params</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ValueDestination]
</span><a href="#local-6989586621684528175"><span class="hs-identifier hs-var">dests</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-639"></span><span>
</span><span id="line-640"></span><span id="local-6989586621684530233"><span id="local-6989586621684530234"><span id="local-6989586621684530235"><span id="local-6989586621684530236"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileFunDef"><span class="hs-identifier hs-type">compileFunDef</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-641"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530236"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530235"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-642"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530236"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-643"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530236"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530234"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530233"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-644"></span><span id="compileFunDef"><span class="annot"><span class="annottext">compileFunDef :: forall rep inner r op.
Mem rep inner =&gt;
FunDef rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileFunDef"><span class="hs-identifier hs-var hs-var">compileFunDef</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span id="local-6989586621684528107"><span class="annot"><span class="annottext">Maybe EntryPoint
</span><a href="#local-6989586621684528107"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528106"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528106"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span id="local-6989586621684528105"><span class="annot"><span class="annottext">[RetType rep]
</span><a href="#local-6989586621684528105"><span class="hs-identifier hs-var">rettype</span></a></span></span><span> </span><span id="local-6989586621684528104"><span class="annot"><span class="annottext">[FParam rep]
</span><a href="#local-6989586621684528104"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684528103"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684528103"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-645"></span><span>  </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Env rep r op)
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684528101"><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684528101"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684528101"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">envFunction :: Maybe Name
</span><a href="Futhark.CodeGen.ImpGen.html#envFunction"><span class="hs-identifier hs-var">envFunction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684528100"><span class="hs-identifier hs-var">name_entry</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name -&gt; Maybe Name -&gt; Maybe Name
forall (m :: * -&gt; *) a. MonadPlus m =&gt; m a -&gt; m a -&gt; m a
</span><span class="hs-operator hs-var">`mplus`</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Name
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528106"><span class="hs-identifier hs-var">fname</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-646"></span><span>    </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684528098"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684528098"><span class="hs-identifier hs-var">outparams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528097"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684528097"><span class="hs-identifier hs-var">inparams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528096"><span class="annot"><span class="annottext">[ExternalValue]
</span><a href="#local-6989586621684528096"><span class="hs-identifier hs-var">results</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528095"><span class="annot"><span class="annottext">[(Name, ExternalValue)]
</span><a href="#local-6989586621684528095"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528094"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528094"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM
  rep
  r
  op
  ([Param], [Param], [ExternalValue], [(Name, ExternalValue)])
-&gt; ImpM
     rep
     r
     op
     (([Param], [Param], [ExternalValue], [(Name, ExternalValue)]),
      Code op)
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op (a, Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect%27"><span class="hs-identifier hs-var">collect'</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM
  rep
  r
  op
  ([Param], [Param], [ExternalValue], [(Name, ExternalValue)])
</span><a href="#local-6989586621684528093"><span class="hs-identifier hs-var">compile</span></a></span><span>
</span><span id="line-647"></span><span>    </span><span class="annot"><span class="annottext">Name -&gt; Function op -&gt; ImpM rep r op ()
forall op rep r. Name -&gt; Function op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emitFunction"><span class="hs-identifier hs-var">emitFunction</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528106"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">(Function op -&gt; ImpM rep r op ())
-&gt; Function op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Name
-&gt; [Param]
-&gt; [Param]
-&gt; Code op
-&gt; [ExternalValue]
-&gt; [(Name, ExternalValue)]
-&gt; Function op
forall a.
Maybe Name
-&gt; [Param]
-&gt; [Param]
-&gt; Code a
-&gt; [ExternalValue]
-&gt; [(Name, ExternalValue)]
-&gt; FunctionT a
</span><a href="Futhark.CodeGen.ImpCode.html#Function"><span class="hs-identifier hs-var">Imp.Function</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684528100"><span class="hs-identifier hs-var">name_entry</span></a></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684528098"><span class="hs-identifier hs-var">outparams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684528097"><span class="hs-identifier hs-var">inparams</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684528094"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">[ExternalValue]
</span><a href="#local-6989586621684528096"><span class="hs-identifier hs-var">results</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, ExternalValue)]
</span><a href="#local-6989586621684528095"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-648"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-649"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684528100"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684528100"><span class="hs-identifier hs-var">name_entry</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528091"><span class="annot"><span class="annottext">[EntryParam]
</span><a href="#local-6989586621684528091"><span class="hs-identifier hs-var">params_entry</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528090"><span class="annot"><span class="annottext">Maybe [EntryPointType]
</span><a href="#local-6989586621684528090"><span class="hs-identifier hs-var">ret_entry</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe EntryPoint
</span><a href="#local-6989586621684528107"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-650"></span><span>      </span><span class="annot"><span class="annottext">Maybe EntryPoint
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-651"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-652"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; EntryParam -&gt; [EntryParam]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[FParam rep]
[Param FParamMem]
</span><a href="#local-6989586621684528104"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; EntryPointType -&gt; EntryParam
</span><a href="Futhark.IR.Syntax.html#EntryParam"><span class="hs-identifier hs-var">EntryParam</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">(EntryPointType -&gt; EntryParam) -&gt; EntryPointType -&gt; EntryParam
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; EntryPointType
</span><a href="Futhark.IR.Syntax.html#TypeDirect"><span class="hs-identifier hs-var">TypeDirect</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-653"></span><span>          </span><span class="annot"><span class="annottext">Maybe [EntryPointType]
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-654"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-655"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684528088"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528088"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528087"><span class="annot"><span class="annottext">[EntryParam]
</span><a href="#local-6989586621684528087"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528086"><span class="annot"><span class="annottext">[EntryPointType]
</span><a href="#local-6989586621684528086"><span class="hs-identifier hs-var">z</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Maybe Name
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684528088"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[EntryParam]
</span><a href="#local-6989586621684528087"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[EntryPointType] -&gt; Maybe [EntryPointType]
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">[EntryPointType]
</span><a href="#local-6989586621684528086"><span class="hs-identifier hs-var">z</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-656"></span><span>    </span><span id="local-6989586621684528093"><span class="annot"><span class="annottext">compile :: ImpM
  rep
  r
  op
  ([Param], [Param], [ExternalValue], [(Name, ExternalValue)])
</span><a href="#local-6989586621684528093"><span class="hs-identifier hs-var hs-var">compile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-657"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684528085"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684528085"><span class="hs-identifier hs-var">inparams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528084"><span class="annot"><span class="annottext">[ArrayDecl]
</span><a href="#local-6989586621684528084"><span class="hs-identifier hs-var">arrayds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528083"><span class="annot"><span class="annottext">[(Name, ExternalValue)]
</span><a href="#local-6989586621684528083"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[FParam rep]
-&gt; [EntryParam]
-&gt; ImpM rep r op ([Param], [ArrayDecl], [(Name, ExternalValue)])
forall rep inner r op.
Mem rep inner =&gt;
[FParam rep]
-&gt; [EntryParam]
-&gt; ImpM rep r op ([Param], [ArrayDecl], [(Name, ExternalValue)])
</span><a href="Futhark.CodeGen.ImpGen.html#compileInParams"><span class="hs-identifier hs-var">compileInParams</span></a></span><span> </span><span class="annot"><span class="annottext">[FParam rep]
</span><a href="#local-6989586621684528104"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">[EntryParam]
</span><a href="#local-6989586621684528091"><span class="hs-identifier hs-var">params_entry</span></a></span><span>
</span><span id="line-658"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684528082"><span class="annot"><span class="annottext">[ExternalValue]
</span><a href="#local-6989586621684528082"><span class="hs-identifier hs-var">results</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528081"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684528081"><span class="hs-identifier hs-var">outparams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528080"><span class="annot"><span class="annottext">[ValueDestination]
</span><a href="#local-6989586621684528080"><span class="hs-identifier hs-var">dests</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[RetType rep]
-&gt; Maybe [EntryPointType]
-&gt; ImpM rep r op ([ExternalValue], [Param], [ValueDestination])
forall rep inner r op.
Mem rep inner =&gt;
[RetType rep]
-&gt; Maybe [EntryPointType]
-&gt; ImpM rep r op ([ExternalValue], [Param], [ValueDestination])
</span><a href="Futhark.CodeGen.ImpGen.html#compileOutParams"><span class="hs-identifier hs-var">compileOutParams</span></a></span><span> </span><span class="annot"><span class="annottext">[RetType rep]
</span><a href="#local-6989586621684528105"><span class="hs-identifier hs-var">rettype</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe [EntryPointType]
</span><a href="#local-6989586621684528090"><span class="hs-identifier hs-var">ret_entry</span></a></span><span>
</span><span id="line-659"></span><span>      </span><span class="annot"><span class="annottext">[FParam rep] -&gt; ImpM rep r op ()
forall rep inner r op.
Mem rep inner =&gt;
[FParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addFParams"><span class="hs-identifier hs-var">addFParams</span></a></span><span> </span><span class="annot"><span class="annottext">[FParam rep]
</span><a href="#local-6989586621684528104"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-660"></span><span>      </span><span class="annot"><span class="annottext">[ArrayDecl] -&gt; ImpM rep r op ()
forall rep r op. [ArrayDecl] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addArrays"><span class="hs-identifier hs-var">addArrays</span></a></span><span> </span><span class="annot"><span class="annottext">[ArrayDecl]
</span><a href="#local-6989586621684528084"><span class="hs-identifier hs-var">arrayds</span></a></span><span>
</span><span id="line-661"></span><span>
</span><span id="line-662"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528076"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528076"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684528075"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684528075"><span class="hs-identifier hs-var">ses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684528103"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-663"></span><span>      </span><span class="annot"><span class="annottext">Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684528075"><span class="hs-identifier hs-var">ses</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528076"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-664"></span><span>        </span><span class="annot"><span class="annottext">[(ValueDestination, SubExpRes)]
-&gt; ((ValueDestination, SubExpRes) -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ValueDestination] -&gt; Result -&gt; [(ValueDestination, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[ValueDestination]
</span><a href="#local-6989586621684528080"><span class="hs-identifier hs-var">dests</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684528075"><span class="hs-identifier hs-var">ses</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((ValueDestination, SubExpRes) -&gt; ImpM rep r op ())
 -&gt; ImpM rep r op ())
-&gt; ((ValueDestination, SubExpRes) -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684528073"><span class="annot"><span class="annottext">ValueDestination
</span><a href="#local-6989586621684528073"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528071"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684528071"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValueDestination
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
ValueDestination
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMDest"><span class="hs-identifier hs-var">copyDWIMDest</span></a></span><span> </span><span class="annot"><span class="annottext">ValueDestination
</span><a href="#local-6989586621684528073"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684528071"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-665"></span><span>
</span><span id="line-666"></span><span>      </span><span class="annot"><span class="annottext">([Param], [Param], [ExternalValue], [(Name, ExternalValue)])
-&gt; ImpM
     rep
     r
     op
     ([Param], [Param], [ExternalValue], [(Name, ExternalValue)])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684528081"><span class="hs-identifier hs-var">outparams</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684528085"><span class="hs-identifier hs-var">inparams</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ExternalValue]
</span><a href="#local-6989586621684528082"><span class="hs-identifier hs-var">results</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Name, ExternalValue)]
</span><a href="#local-6989586621684528083"><span class="hs-identifier hs-var">args</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-667"></span><span>
</span><span id="line-668"></span><span id="local-6989586621684530071"><span id="local-6989586621684530072"><span id="local-6989586621684530074"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileBody"><span class="hs-identifier hs-type">compileBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530074"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530074"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530074"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530072"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530071"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-669"></span><span id="compileBody"><span class="annot"><span class="annottext">compileBody :: forall rep r op. Pat rep -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody"><span class="hs-identifier hs-var hs-var">compileBody</span></a></span></span><span> </span><span id="local-6989586621684528064"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684528064"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528063"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528063"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684528062"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684528062"><span class="hs-identifier hs-var">ses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-670"></span><span>  </span><span id="local-6989586621684528061"><span class="annot"><span class="annottext">[ValueDestination]
</span><a href="#local-6989586621684528061"><span class="hs-identifier hs-var">dests</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; ImpM rep r op [ValueDestination]
forall rep r op. Pat rep -&gt; ImpM rep r op [ValueDestination]
</span><a href="Futhark.CodeGen.ImpGen.html#destinationFromPat"><span class="hs-identifier hs-var">destinationFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684528064"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-671"></span><span>  </span><span class="annot"><span class="annottext">Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684528062"><span class="hs-identifier hs-var">ses</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528063"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-672"></span><span>    </span><span class="annot"><span class="annottext">[(ValueDestination, SubExpRes)]
-&gt; ((ValueDestination, SubExpRes) -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ValueDestination] -&gt; Result -&gt; [(ValueDestination, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[ValueDestination]
</span><a href="#local-6989586621684528061"><span class="hs-identifier hs-var">dests</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684528062"><span class="hs-identifier hs-var">ses</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((ValueDestination, SubExpRes) -&gt; ImpM rep r op ())
 -&gt; ImpM rep r op ())
-&gt; ((ValueDestination, SubExpRes) -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684528059"><span class="annot"><span class="annottext">ValueDestination
</span><a href="#local-6989586621684528059"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528058"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684528058"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ValueDestination
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
ValueDestination
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMDest"><span class="hs-identifier hs-var">copyDWIMDest</span></a></span><span> </span><span class="annot"><span class="annottext">ValueDestination
</span><a href="#local-6989586621684528059"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684528058"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-673"></span><span>
</span><span id="line-674"></span><span id="local-6989586621684530061"><span id="local-6989586621684530062"><span id="local-6989586621684530063"><span id="local-6989586621684530064"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileBody%27"><span class="hs-identifier hs-type">compileBody'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530064"><span class="hs-identifier hs-type">dec</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530063"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530063"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530062"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530061"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-675"></span><span id="compileBody%27"><span class="annot"><span class="annottext">compileBody' :: forall dec rep r op. [Param dec] -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody%27"><span class="hs-identifier hs-var hs-var">compileBody'</span></a></span></span><span> </span><span id="local-6989586621684528053"><span class="annot"><span class="annottext">[Param dec]
</span><a href="#local-6989586621684528053"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528052"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528052"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684528051"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684528051"><span class="hs-identifier hs-var">ses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-676"></span><span>  </span><span class="annot"><span class="annottext">Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684528051"><span class="hs-identifier hs-var">ses</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528052"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-677"></span><span>    </span><span class="annot"><span class="annottext">[(Param dec, SubExpRes)]
-&gt; ((Param dec, SubExpRes) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param dec] -&gt; Result -&gt; [(Param dec, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param dec]
</span><a href="#local-6989586621684528053"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684528051"><span class="hs-identifier hs-var">ses</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param dec, SubExpRes) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ())
-&gt; ((Param dec, SubExpRes) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684528050"><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684528050"><span class="hs-identifier hs-var">param</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528049"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684528049"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param dec -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684528050"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684528049"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-678"></span><span>
</span><span id="line-679"></span><span id="local-6989586621684530050"><span id="local-6989586621684530051"><span id="local-6989586621684530052"><span id="local-6989586621684530053"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileLoopBody"><span class="hs-identifier hs-type">compileLoopBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Types.html#Typed"><span class="hs-identifier hs-type">Typed</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530053"><span class="hs-identifier hs-type">dec</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530053"><span class="hs-identifier hs-type">dec</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530052"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530052"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530051"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530050"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-680"></span><span id="compileLoopBody"><span class="annot"><span class="annottext">compileLoopBody :: forall dec rep r op.
Typed dec =&gt;
[Param dec] -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileLoopBody"><span class="hs-identifier hs-var hs-var">compileLoopBody</span></a></span></span><span> </span><span id="local-6989586621684528024"><span class="annot"><span class="annottext">[Param dec]
</span><a href="#local-6989586621684528024"><span class="hs-identifier hs-var">mergeparams</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528023"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528023"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684528022"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684528022"><span class="hs-identifier hs-var">ses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-681"></span><span>  </span><span class="hs-comment">-- We cannot write the results to the merge parameters immediately,</span><span>
</span><span id="line-682"></span><span>  </span><span class="hs-comment">-- as some of the results may actually *be* merge parameters, and</span><span>
</span><span id="line-683"></span><span>  </span><span class="hs-comment">-- would thus be clobbered.  Therefore, we first copy to new</span><span>
</span><span id="line-684"></span><span>  </span><span class="hs-comment">-- variables mirroring the merge parameters, and then copy this</span><span>
</span><span id="line-685"></span><span>  </span><span class="hs-comment">-- buffer to the merge parameters.  This is efficient, because the</span><span>
</span><span id="line-686"></span><span>  </span><span class="hs-comment">-- operations are all scalar operations.</span><span>
</span><span id="line-687"></span><span>  </span><span id="local-6989586621684528021"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684528021"><span class="hs-identifier hs-var">tmpnames</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Param dec -&gt; ImpM rep r op VName)
-&gt; [Param dec] -&gt; ImpM rep r op [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op VName)
-&gt; (Param dec -&gt; [Char]) -&gt; Param dec -&gt; ImpM rep r op VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_tmp&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ShowS -&gt; (Param dec -&gt; [Char]) -&gt; Param dec -&gt; [Char]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; [Char]) -&gt; (Param dec -&gt; VName) -&gt; Param dec -&gt; [Char]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param dec -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param dec]
</span><a href="#local-6989586621684528024"><span class="hs-identifier hs-var">mergeparams</span></a></span><span>
</span><span id="line-688"></span><span>  </span><span class="annot"><span class="annottext">Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684528022"><span class="hs-identifier hs-var">ses</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528023"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-689"></span><span>    </span><span id="local-6989586621684528019"><span class="annot"><span class="annottext">[ImpM rep r op ()]
</span><a href="#local-6989586621684528019"><span class="hs-identifier hs-var">copy_to_merge_params</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Param dec, VName, SubExpRes)]
-&gt; ((Param dec, VName, SubExpRes)
    -&gt; ImpM rep r op (ImpM rep r op ()))
-&gt; ImpM rep r op [ImpM rep r op ()]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param dec] -&gt; [VName] -&gt; Result -&gt; [(Param dec, VName, SubExpRes)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[Param dec]
</span><a href="#local-6989586621684528024"><span class="hs-identifier hs-var">mergeparams</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684528021"><span class="hs-identifier hs-var">tmpnames</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684528022"><span class="hs-identifier hs-var">ses</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param dec, VName, SubExpRes)
  -&gt; ImpM rep r op (ImpM rep r op ()))
 -&gt; ImpM rep r op [ImpM rep r op ()])
-&gt; ((Param dec, VName, SubExpRes)
    -&gt; ImpM rep r op (ImpM rep r op ()))
-&gt; ImpM rep r op [ImpM rep r op ()]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684528016"><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684528016"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684528015"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528015"><span class="hs-identifier hs-var">tmp</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684528014"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684528014"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-690"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Param dec -&gt; Type
forall t. Typed t =&gt; t -&gt; Type
</span><a href="Futhark.IR.Prop.Types.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684528016"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-691"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684528012"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528012"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-692"></span><span>          </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Volatility -&gt; PrimType -&gt; Code op
forall a. VName -&gt; Volatility -&gt; PrimType -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DeclareScalar"><span class="hs-identifier hs-var">Imp.DeclareScalar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528015"><span class="hs-identifier hs-var">tmp</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="Futhark.CodeGen.ImpCode.html#Nonvolatile"><span class="hs-identifier hs-var">Imp.Nonvolatile</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528012"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-693"></span><span>          </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; Code op
forall a. VName -&gt; PrimExp VName -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#SetScalar"><span class="hs-identifier hs-var">Imp.SetScalar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528015"><span class="hs-identifier hs-var">tmp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Code op) -&gt; PrimExp VName -&gt; Code op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; PrimExp VName
forall a. ToExp a =&gt; PrimType -&gt; a -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpGen.html#toExp%27"><span class="hs-identifier hs-var">toExp'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528012"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684528014"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-694"></span><span>          </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (ImpM rep r op ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op (ImpM rep r op ()))
-&gt; ImpM rep r op () -&gt; ImpM rep r op (ImpM rep r op ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; Code op
forall a. VName -&gt; PrimExp VName -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#SetScalar"><span class="hs-identifier hs-var">Imp.SetScalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param dec -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684528016"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Code op) -&gt; PrimExp VName -&gt; Code op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528015"><span class="hs-identifier hs-var">tmp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684528012"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-695"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684528008"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528008"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684528007"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528007"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684528014"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-696"></span><span>          </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; Code op
forall a. VName -&gt; Space -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DeclareMem"><span class="hs-identifier hs-var">Imp.DeclareMem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528015"><span class="hs-identifier hs-var">tmp</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528008"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-697"></span><span>          </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Space -&gt; Code op
forall a. VName -&gt; VName -&gt; Space -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#SetMem"><span class="hs-identifier hs-var">Imp.SetMem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528015"><span class="hs-identifier hs-var">tmp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528007"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528008"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-698"></span><span>          </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (ImpM rep r op ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op (ImpM rep r op ()))
-&gt; ImpM rep r op () -&gt; ImpM rep r op (ImpM rep r op ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Space -&gt; Code op
forall a. VName -&gt; VName -&gt; Space -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#SetMem"><span class="hs-identifier hs-var">Imp.SetMem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param dec -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684528016"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684528015"><span class="hs-identifier hs-var">tmp</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684528008"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-699"></span><span>        </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (ImpM rep r op ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op (ImpM rep r op ()))
-&gt; ImpM rep r op () -&gt; ImpM rep r op (ImpM rep r op ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-700"></span><span>    </span><span class="annot"><span class="annottext">[ImpM rep r op ()] -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a.
(Foldable t, Monad m) =&gt;
t (m a) -&gt; m ()
</span><span class="hs-identifier hs-var">sequence_</span></span><span> </span><span class="annot"><span class="annottext">[ImpM rep r op ()]
</span><a href="#local-6989586621684528019"><span class="hs-identifier hs-var">copy_to_merge_params</span></a></span><span>
</span><span id="line-701"></span><span>
</span><span id="line-702"></span><span id="local-6989586621684530216"><span id="local-6989586621684530217"><span id="local-6989586621684530218"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-type">compileStms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530218"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530218"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530217"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530216"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530218"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530217"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530216"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-703"></span><span id="compileStms"><span class="annot"><span class="annottext">compileStms :: forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var hs-var">compileStms</span></a></span></span><span> </span><span id="local-6989586621684528002"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684528002"><span class="hs-identifier hs-var">alive_after_stms</span></a></span></span><span> </span><span id="local-6989586621684528001"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528001"><span class="hs-identifier hs-var">all_stms</span></a></span></span><span> </span><span id="local-6989586621684528000"><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684528000"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-704"></span><span>  </span><span id="local-6989586621684527999"><span class="annot"><span class="annottext">StmsCompiler rep r op
</span><a href="#local-6989586621684527999"><span class="hs-identifier hs-var">cb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; StmsCompiler rep r op)
-&gt; ImpM rep r op (StmsCompiler rep r op)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; StmsCompiler rep r op
forall rep r op. Env rep r op -&gt; StmsCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envStmsCompiler"><span class="hs-identifier hs-var hs-var">envStmsCompiler</span></a></span><span>
</span><span id="line-705"></span><span>  </span><span class="annot"><span class="annottext">StmsCompiler rep r op
</span><a href="#local-6989586621684527999"><span class="hs-identifier hs-var">cb</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684528002"><span class="hs-identifier hs-var">alive_after_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684528001"><span class="hs-identifier hs-var">all_stms</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684528000"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-706"></span><span>
</span><span id="line-707"></span><span id="local-6989586621684530636"><span id="local-6989586621684530639"><span id="local-6989586621684530640"><span id="local-6989586621684530641"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileStms"><span class="hs-identifier hs-type">defCompileStms</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-708"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530641"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530640"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#FreeIn"><span class="hs-identifier hs-type">FreeIn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530639"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-709"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-710"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530641"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-711"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530641"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530636"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530639"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-712"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530641"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530636"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530639"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-713"></span><span id="defCompileStms"><span class="annot"><span class="annottext">defCompileStms :: forall rep inner op r.
(Mem rep inner, FreeIn op) =&gt;
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#defCompileStms"><span class="hs-identifier hs-var hs-var">defCompileStms</span></a></span></span><span> </span><span id="local-6989586621684527928"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684527928"><span class="hs-identifier hs-var">alive_after_stms</span></a></span></span><span> </span><span id="local-6989586621684527927"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684527927"><span class="hs-identifier hs-var">all_stms</span></a></span></span><span> </span><span id="local-6989586621684527926"><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684527926"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-714"></span><span>  </span><span class="hs-comment">-- We keep track of any memory blocks produced by the statements,</span><span>
</span><span id="line-715"></span><span>  </span><span class="hs-comment">-- and after the last time that memory block is used, we insert a</span><span>
</span><span id="line-716"></span><span>  </span><span class="hs-comment">-- Free.  This is very conservative, but can cut down on lifetimes</span><span>
</span><span id="line-717"></span><span>  </span><span class="hs-comment">-- in some cases.</span><span>
</span><span id="line-718"></span><span>  </span><span class="annot"><span class="annottext">ImpM rep r op Names -&gt; ImpM rep r op ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op Names -&gt; ImpM rep r op ())
-&gt; ImpM rep r op Names -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set (VName, Space) -&gt; [Stm rep] -&gt; ImpM rep r op Names
</span><a href="#local-6989586621684527924"><span class="hs-identifier hs-var">compileStms'</span></a></span><span> </span><span class="annot"><span class="annottext">Set (VName, Space)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">([Stm rep] -&gt; ImpM rep r op Names)
-&gt; [Stm rep] -&gt; ImpM rep r op Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; [Stm rep]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684527927"><span class="hs-identifier hs-var">all_stms</span></a></span><span>
</span><span id="line-719"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-720"></span><span>    </span><span id="local-6989586621684527924"><span class="annot"><span class="annottext">compileStms' :: Set (VName, Space) -&gt; [Stm rep] -&gt; ImpM rep r op Names
</span><a href="#local-6989586621684527924"><span class="hs-identifier hs-var hs-var">compileStms'</span></a></span></span><span> </span><span id="local-6989586621684527922"><span class="annot"><span class="annottext">Set (VName, Space)
</span><a href="#local-6989586621684527922"><span class="hs-identifier hs-var">allocs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684527921"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527921"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684527920"><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684527920"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684527919"><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684527919"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684527918"><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684527918"><span class="hs-identifier hs-var">bs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-721"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; [PatElem rep] -&gt; ImpM rep r op ()
forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; [PatElem rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dVars"><span class="hs-identifier hs-var">dVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp rep -&gt; Maybe (Exp rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684527919"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [PatElem rep]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527921"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-722"></span><span>
</span><span id="line-723"></span><span>      </span><span id="local-6989586621684527916"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684527916"><span class="hs-identifier hs-var">e_code</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-724"></span><span>        </span><span class="annot"><span class="annottext">Attrs -&gt; ImpM rep r op (Code op) -&gt; ImpM rep r op (Code op)
forall rep r op a. Attrs -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localAttrs"><span class="hs-identifier hs-var">localAttrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StmAux (ExpDec rep) -&gt; Attrs
forall dec. StmAux dec -&gt; Attrs
</span><a href="Futhark.IR.Syntax.html#stmAuxAttrs"><span class="hs-identifier hs-var hs-var">stmAuxAttrs</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684527920"><span class="hs-identifier hs-var">aux</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op (Code op) -&gt; ImpM rep r op (Code op))
-&gt; ImpM rep r op (Code op) -&gt; ImpM rep r op (Code op)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-725"></span><span>          </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op (Code op))
-&gt; ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; Exp rep -&gt; ImpM rep r op ()
forall rep r op. Pat rep -&gt; Exp rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileExp"><span class="hs-identifier hs-var">compileExp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527921"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684527919"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-726"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684527913"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684527913"><span class="hs-identifier hs-var">live_after</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527912"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684527912"><span class="hs-identifier hs-var">bs_code</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op Names -&gt; ImpM rep r op (Names, Code op)
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op (a, Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect%27"><span class="hs-identifier hs-var">collect'</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op Names -&gt; ImpM rep r op (Names, Code op))
-&gt; ImpM rep r op Names -&gt; ImpM rep r op (Names, Code op)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set (VName, Space) -&gt; [Stm rep] -&gt; ImpM rep r op Names
</span><a href="#local-6989586621684527924"><span class="hs-identifier hs-var">compileStms'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; Set (VName, Space)
</span><a href="#local-6989586621684527911"><span class="hs-identifier hs-var">patternAllocs</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527921"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Set (VName, Space) -&gt; Set (VName, Space) -&gt; Set (VName, Space)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set (VName, Space)
</span><a href="#local-6989586621684527922"><span class="hs-identifier hs-var">allocs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Stm rep]
</span><a href="#local-6989586621684527918"><span class="hs-identifier hs-var">bs</span></a></span><span>
</span><span id="line-727"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684527910"><span class="annot"><span class="annottext">dies_here :: VName -&gt; Bool
</span><a href="#local-6989586621684527910"><span class="hs-identifier hs-var hs-var">dies_here</span></a></span></span><span> </span><span id="local-6989586621684527909"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527909"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-728"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527909"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684527913"><span class="hs-identifier hs-var">live_after</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-729"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527909"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Code op -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684527916"><span class="hs-identifier hs-var">e_code</span></a></span><span>
</span><span id="line-730"></span><span>          </span><span id="local-6989586621684527906"><span class="annot"><span class="annottext">to_free :: Set (VName, Space)
</span><a href="#local-6989586621684527906"><span class="hs-identifier hs-var hs-var">to_free</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VName, Space) -&gt; Bool)
-&gt; Set (VName, Space) -&gt; Set (VName, Space)
forall a. (a -&gt; Bool) -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Bool
</span><a href="#local-6989586621684527910"><span class="hs-identifier hs-var">dies_here</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; ((VName, Space) -&gt; VName) -&gt; (VName, Space) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VName, Space) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set (VName, Space)
</span><a href="#local-6989586621684527922"><span class="hs-identifier hs-var">allocs</span></a></span><span>
</span><span id="line-731"></span><span>
</span><span id="line-732"></span><span>      </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684527916"><span class="hs-identifier hs-var">e_code</span></a></span><span>
</span><span id="line-733"></span><span>      </span><span class="annot"><span class="annottext">((VName, Space) -&gt; ImpM rep r op ())
-&gt; Set (VName, Space) -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ())
-&gt; ((VName, Space) -&gt; Code op)
-&gt; (VName, Space)
-&gt; ImpM rep r op ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Space -&gt; Code op) -&gt; (VName, Space) -&gt; Code op
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; Code op
forall a. VName -&gt; Space -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Free"><span class="hs-identifier hs-var">Imp.Free</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set (VName, Space)
</span><a href="#local-6989586621684527906"><span class="hs-identifier hs-var">to_free</span></a></span><span>
</span><span id="line-734"></span><span>      </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684527912"><span class="hs-identifier hs-var">bs_code</span></a></span><span>
</span><span id="line-735"></span><span>
</span><span id="line-736"></span><span>      </span><span class="annot"><span class="annottext">Names -&gt; ImpM rep r op Names
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; ImpM rep r op Names) -&gt; Names -&gt; ImpM rep r op Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code op -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684527916"><span class="hs-identifier hs-var">e_code</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684527913"><span class="hs-identifier hs-var">live_after</span></a></span><span>
</span><span id="line-737"></span><span>    </span><span class="annot"><a href="#local-6989586621684527924"><span class="hs-identifier hs-var">compileStms'</span></a></span><span> </span><span class="annot"><span class="annottext">Set (VName, Space)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-738"></span><span>      </span><span id="local-6989586621684527902"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684527902"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684527926"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-739"></span><span>      </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684527902"><span class="hs-identifier hs-var">code</span></a></span><span>
</span><span id="line-740"></span><span>      </span><span class="annot"><span class="annottext">Names -&gt; ImpM rep r op Names
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; ImpM rep r op Names) -&gt; Names -&gt; ImpM rep r op Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code op -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684527902"><span class="hs-identifier hs-var">code</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684527928"><span class="hs-identifier hs-var">alive_after_stms</span></a></span><span>
</span><span id="line-741"></span><span>
</span><span id="line-742"></span><span>    </span><span id="local-6989586621684527911"><span class="annot"><span class="annottext">patternAllocs :: Pat rep -&gt; Set (VName, Space)
</span><a href="#local-6989586621684527911"><span class="hs-identifier hs-var hs-var">patternAllocs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, Space)] -&gt; Set (VName, Space)
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Space)] -&gt; Set (VName, Space))
-&gt; (Pat rep -&gt; [(VName, Space)]) -&gt; Pat rep -&gt; Set (VName, Space)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PatElem rep -&gt; Maybe (VName, Space))
-&gt; [PatElem rep] -&gt; [(VName, Space)]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">PatElem rep -&gt; Maybe (VName, Space)
forall {dec}. Typed dec =&gt; PatElemT dec -&gt; Maybe (VName, Space)
</span><a href="#local-6989586621684527896"><span class="hs-identifier hs-var">isMemPatElem</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElem rep] -&gt; [(VName, Space)])
-&gt; (Pat rep -&gt; [PatElem rep]) -&gt; Pat rep -&gt; [(VName, Space)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; [PatElem rep]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span>
</span><span id="line-743"></span><span>    </span><span id="local-6989586621684527896"><span class="annot"><span class="annottext">isMemPatElem :: PatElemT dec -&gt; Maybe (VName, Space)
</span><a href="#local-6989586621684527896"><span class="hs-identifier hs-var hs-var">isMemPatElem</span></a></span></span><span> </span><span id="local-6989586621684527893"><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684527893"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PatElemT dec -&gt; Type
forall dec. Typed dec =&gt; PatElemT dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#patElemType"><span class="hs-identifier hs-var">patElemType</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684527893"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-744"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684527891"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684527891"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(VName, Space) -&gt; Maybe (VName, Space)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT dec -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684527893"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684527891"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-745"></span><span>      </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (VName, Space)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-746"></span><span>
</span><span id="line-747"></span><span id="local-6989586621684530001"><span id="local-6989586621684530002"><span id="local-6989586621684530003"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileExp"><span class="hs-identifier hs-type">compileExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530003"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530003"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530003"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530002"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530001"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-748"></span><span id="compileExp"><span class="annot"><span class="annottext">compileExp :: forall rep r op. Pat rep -&gt; Exp rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileExp"><span class="hs-identifier hs-var hs-var">compileExp</span></a></span></span><span> </span><span id="local-6989586621684527887"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527887"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684527886"><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684527886"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-749"></span><span>  </span><span id="local-6989586621684527885"><span class="annot"><span class="annottext">Pat rep -&gt; Exp rep -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684527885"><span class="hs-identifier hs-var">ec</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Pat rep -&gt; Exp rep -&gt; ImpM rep r op ())
-&gt; ImpM rep r op (Pat rep -&gt; Exp rep -&gt; ImpM rep r op ())
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; Pat rep -&gt; Exp rep -&gt; ImpM rep r op ()
forall rep r op. Env rep r op -&gt; ExpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envExpCompiler"><span class="hs-identifier hs-var hs-var">envExpCompiler</span></a></span><span>
</span><span id="line-750"></span><span>  </span><span class="annot"><span class="annottext">Pat rep -&gt; Exp rep -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684527885"><span class="hs-identifier hs-var">ec</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527887"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684527886"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-751"></span><span>
</span><span id="line-752"></span><span id="local-6989586621684530642"><span id="local-6989586621684530643"><span id="local-6989586621684530646"><span id="local-6989586621684530647"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileExp"><span class="hs-identifier hs-type">defCompileExp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-753"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530647"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530646"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-754"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530647"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-755"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530647"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-756"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530647"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530643"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530642"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-757"></span><span id="defCompileExp"><span class="annot"><span class="annottext">defCompileExp :: forall rep inner r op.
Mem rep inner =&gt;
Pat rep -&gt; Exp rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#defCompileExp"><span class="hs-identifier hs-var hs-var">defCompileExp</span></a></span></span><span> </span><span id="local-6989586621684527776"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527776"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span id="local-6989586621684527774"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527774"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684527773"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684527773"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span> </span><span id="local-6989586621684527772"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684527772"><span class="hs-identifier hs-var">fbranch</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType rep)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-758"></span><span>  </span><span class="annot"><span class="annottext">TExp Bool
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op.
TExp Bool
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; TExp Bool
forall a. ToExp a =&gt; a -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.html#toBoolExp"><span class="hs-identifier hs-var">toBoolExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527774"><span class="hs-identifier hs-var">cond</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; BodyT rep -&gt; ImpM rep r op ()
forall rep r op. Pat rep -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527776"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684527773"><span class="hs-identifier hs-var">tbranch</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; BodyT rep -&gt; ImpM rep r op ()
forall rep r op. Pat rep -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527776"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684527772"><span class="hs-identifier hs-var">fbranch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-759"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileExp"><span class="hs-identifier hs-var">defCompileExp</span></a></span><span> </span><span id="local-6989586621684527770"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527770"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621684527768"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684527768"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span id="local-6989586621684527767"><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684527767"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="annot"><span class="annottext">[RetType rep]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">(Safety, SrcLoc, [SrcLoc])
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-760"></span><span>  </span><span id="local-6989586621684527766"><span class="annot"><span class="annottext">[ValueDestination]
</span><a href="#local-6989586621684527766"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; ImpM rep r op [ValueDestination]
forall rep r op. Pat rep -&gt; ImpM rep r op [ValueDestination]
</span><a href="Futhark.CodeGen.ImpGen.html#destinationFromPat"><span class="hs-identifier hs-var">destinationFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527770"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-761"></span><span>  </span><span id="local-6989586621684527765"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527765"><span class="hs-identifier hs-var">targets</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ValueDestination] -&gt; ImpM rep r op [VName]
forall rep r op. [ValueDestination] -&gt; ImpM rep r op [VName]
</span><a href="Futhark.CodeGen.ImpGen.html#funcallTargets"><span class="hs-identifier hs-var">funcallTargets</span></a></span><span> </span><span class="annot"><span class="annottext">[ValueDestination]
</span><a href="#local-6989586621684527766"><span class="hs-identifier hs-var">dest</span></a></span><span>
</span><span id="line-762"></span><span>  </span><span id="local-6989586621684527763"><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684527763"><span class="hs-identifier hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Maybe Arg] -&gt; [Arg]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">([Maybe Arg] -&gt; [Arg])
-&gt; ImpM rep r op [Maybe Arg] -&gt; ImpM rep r op [Arg]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((SubExp, Diet) -&gt; ImpM rep r op (Maybe Arg))
-&gt; [(SubExp, Diet)] -&gt; ImpM rep r op [Maybe Arg]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(SubExp, Diet) -&gt; ImpM rep r op (Maybe Arg)
forall {m :: * -&gt; *} {t} {b}.
(Monad m, HasScope t m) =&gt;
(SubExp, b) -&gt; m (Maybe Arg)
</span><a href="#local-6989586621684527762"><span class="hs-identifier hs-var">compileArg</span></a></span><span> </span><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684527767"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-763"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Name -&gt; [Arg] -&gt; Code op
forall a. [VName] -&gt; Name -&gt; [Arg] -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Call"><span class="hs-identifier hs-var">Imp.Call</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527765"><span class="hs-identifier hs-var">targets</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684527768"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">[Arg]
</span><a href="#local-6989586621684527763"><span class="hs-identifier hs-var">args'</span></a></span><span>
</span><span id="line-764"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-765"></span><span>    </span><span id="local-6989586621684527762"><span class="annot"><span class="annottext">compileArg :: (SubExp, b) -&gt; m (Maybe Arg)
</span><a href="#local-6989586621684527762"><span class="hs-identifier hs-var hs-var">compileArg</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684527752"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527752"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-766"></span><span>      </span><span id="local-6989586621684527751"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684527751"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; m Type
forall t (m :: * -&gt; *). HasScope t m =&gt; SubExp -&gt; m Type
</span><a href="Futhark.IR.Prop.TypeOf.html#subExpType"><span class="hs-identifier hs-var">subExpType</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527752"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-767"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527752"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684527751"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-768"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684527749"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527749"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Arg -&gt; m (Maybe Arg)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Arg -&gt; m (Maybe Arg)) -&gt; Maybe Arg -&gt; m (Maybe Arg)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Arg -&gt; Maybe Arg
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Arg -&gt; Maybe Arg) -&gt; Arg -&gt; Maybe Arg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#ExpArg"><span class="hs-identifier hs-var">Imp.ExpArg</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Arg) -&gt; PrimExp VName -&gt; Arg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; PrimExp VName
forall a. ToExp a =&gt; PrimType -&gt; a -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpGen.html#toExp%27"><span class="hs-identifier hs-var">toExp'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527749"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527752"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-769"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684527747"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527747"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Arg -&gt; m (Maybe Arg)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Arg -&gt; m (Maybe Arg)) -&gt; Maybe Arg -&gt; m (Maybe Arg)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Arg -&gt; Maybe Arg
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Arg -&gt; Maybe Arg) -&gt; Arg -&gt; Maybe Arg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#MemArg"><span class="hs-identifier hs-var">Imp.MemArg</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527747"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-770"></span><span>        </span><span class="annot"><span class="annottext">(SubExp, Type)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Arg -&gt; m (Maybe Arg)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Arg
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-771"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileExp"><span class="hs-identifier hs-var">defCompileExp</span></a></span><span> </span><span id="local-6989586621684527745"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527745"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span id="local-6989586621684527743"><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684527743"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; BasicOp -&gt; ImpM rep r op ()
forall rep inner r op.
Mem rep inner =&gt;
Pat rep -&gt; BasicOp -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527745"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684527743"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-772"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileExp"><span class="hs-identifier hs-var">defCompileExp</span></a></span><span> </span><span id="local-6989586621684527741"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527741"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span id="local-6989586621684527739"><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
</span><a href="#local-6989586621684527739"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684527738"><span class="annot"><span class="annottext">LoopForm rep
</span><a href="#local-6989586621684527738"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684527737"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684527737"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-773"></span><span>  </span><span id="local-6989586621684527736"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684527736"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op Attrs
forall rep r op. ImpM rep r op Attrs
</span><a href="Futhark.CodeGen.ImpGen.html#askAttrs"><span class="hs-identifier hs-var">askAttrs</span></a></span><span>
</span><span id="line-774"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;unroll&quot;</span></span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684527736"><span class="hs-identifier hs-var">attrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-775"></span><span>    </span><span class="annot"><span class="annottext">SrcLoc -&gt; [SrcLoc] -&gt; [Char] -&gt; ImpM rep r op ()
forall loc rep r op.
Located loc =&gt;
loc -&gt; [loc] -&gt; [Char] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#warn"><span class="hs-identifier hs-var">warn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc
forall a. IsLocation a =&gt; a
</span><span class="hs-identifier hs-var">noLoc</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;#[unroll] on loop with unknown number of iterations.&quot;</span></span><span> </span><span class="hs-comment">-- FIXME: no location.</span><span>
</span><span id="line-776"></span><span>  </span><span class="annot"><span class="annottext">[FParam rep] -&gt; ImpM rep r op ()
forall rep inner r op.
Mem rep inner =&gt;
[FParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dFParams"><span class="hs-identifier hs-var">dFParams</span></a></span><span> </span><span class="annot"><span class="annottext">[FParam rep]
[Param FParamMem]
</span><a href="#local-6989586621684527732"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-777"></span><span>  </span><span class="annot"><span class="annottext">[(Param FParamMem, SubExp)]
-&gt; ((Param FParamMem, SubExp) -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684527739"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">(((Param FParamMem, SubExp) -&gt; ImpM rep r op ())
 -&gt; ImpM rep r op ())
-&gt; ((Param FParamMem, SubExp) -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684527731"><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684527731"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527730"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527730"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-778"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Bool) -&gt; Int -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Int) -&gt; Type -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684527731"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-779"></span><span>      </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684527731"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527730"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-780"></span><span>
</span><span id="line-781"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684527728"><span class="annot"><span class="annottext">doBody :: ImpM rep r op ()
</span><a href="#local-6989586621684527728"><span class="hs-identifier hs-var hs-var">doBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; BodyT rep -&gt; ImpM rep r op ()
forall dec rep r op.
Typed dec =&gt;
[Param dec] -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileLoopBody"><span class="hs-identifier hs-var">compileLoopBody</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684527732"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684527737"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-782"></span><span>
</span><span id="line-783"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LoopForm rep
</span><a href="#local-6989586621684527738"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-784"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#ForLoop"><span class="hs-identifier hs-type">ForLoop</span></a></span><span> </span><span id="local-6989586621684527726"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527726"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="annot"><span class="annottext">IntType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684527725"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527725"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span id="local-6989586621684527724"><span class="annot"><span class="annottext">[(LParam rep, VName)]
</span><a href="#local-6989586621684527724"><span class="hs-identifier hs-var">loopvars</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-785"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684527723"><span class="annot"><span class="annottext">setLoopParam :: (Param LParamMem, VName) -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684527723"><span class="hs-identifier hs-var hs-var">setLoopParam</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684527722"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684527722"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527721"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527721"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-786"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684527722"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-787"></span><span>              </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684527722"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527721"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527726"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-788"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-789"></span><span>              </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-790"></span><span>
</span><span id="line-791"></span><span>      </span><span id="local-6989586621684527718"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527718"><span class="hs-identifier hs-var">bound'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM rep r op (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527725"><span class="hs-identifier hs-var">bound</span></a></span><span>
</span><span id="line-792"></span><span>
</span><span id="line-793"></span><span>      </span><span class="annot"><span class="annottext">[LParam rep] -&gt; ImpM rep r op ()
forall rep inner r op.
Mem rep inner =&gt;
[LParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-var">dLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([LParam rep] -&gt; ImpM rep r op ())
-&gt; [LParam rep] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Param LParamMem, VName) -&gt; Param LParamMem)
-&gt; [(Param LParamMem, VName)] -&gt; [Param LParamMem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param LParamMem, VName) -&gt; Param LParamMem
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(LParam rep, VName)]
[(Param LParamMem, VName)]
</span><a href="#local-6989586621684527724"><span class="hs-identifier hs-var">loopvars</span></a></span><span>
</span><span id="line-794"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op.
VName -&gt; PrimExp VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor%27"><span class="hs-identifier hs-var">sFor'</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527726"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527718"><span class="hs-identifier hs-var">bound'</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-795"></span><span>        </span><span class="annot"><span class="annottext">((Param LParamMem, VName) -&gt; ImpM rep r op ())
-&gt; [(Param LParamMem, VName)] -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">(Param LParamMem, VName) -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684527723"><span class="hs-identifier hs-var">setLoopParam</span></a></span><span> </span><span class="annot"><span class="annottext">[(LParam rep, VName)]
[(Param LParamMem, VName)]
</span><a href="#local-6989586621684527724"><span class="hs-identifier hs-var">loopvars</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684527728"><span class="hs-identifier hs-var">doBody</span></a></span><span>
</span><span id="line-796"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#WhileLoop"><span class="hs-identifier hs-type">WhileLoop</span></a></span><span> </span><span id="local-6989586621684527714"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527714"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-797"></span><span>      </span><span class="annot"><span class="annottext">TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhile"><span class="hs-identifier hs-var">sWhile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp VName -&gt; TExp Bool
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; TExp Bool) -&gt; PrimExp VName -&gt; TExp Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527714"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Primitive.html#Bool"><span class="hs-identifier hs-var">Bool</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684527728"><span class="hs-identifier hs-var">doBody</span></a></span><span>
</span><span id="line-798"></span><span>
</span><span id="line-799"></span><span>  </span><span id="local-6989586621684527711"><span class="annot"><span class="annottext">[ValueDestination]
</span><a href="#local-6989586621684527711"><span class="hs-identifier hs-var">pat_dests</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; ImpM rep r op [ValueDestination]
forall rep r op. Pat rep -&gt; ImpM rep r op [ValueDestination]
</span><a href="Futhark.CodeGen.ImpGen.html#destinationFromPat"><span class="hs-identifier hs-var">destinationFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527741"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-800"></span><span>  </span><span class="annot"><span class="annottext">[(ValueDestination, SubExp)]
-&gt; ((ValueDestination, SubExp) -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ValueDestination] -&gt; [SubExp] -&gt; [(ValueDestination, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[ValueDestination]
</span><a href="#local-6989586621684527711"><span class="hs-identifier hs-var">pat_dests</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(ValueDestination, SubExp)])
-&gt; [SubExp] -&gt; [(ValueDestination, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Param FParamMem, SubExp) -&gt; SubExp)
-&gt; [(Param FParamMem, SubExp)] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp)
-&gt; ((Param FParamMem, SubExp) -&gt; VName)
-&gt; (Param FParamMem, SubExp)
-&gt; SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem -&gt; VName)
-&gt; ((Param FParamMem, SubExp) -&gt; Param FParamMem)
-&gt; (Param FParamMem, SubExp)
-&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem, SubExp) -&gt; Param FParamMem
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684527739"><span class="hs-identifier hs-var">merge</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((ValueDestination, SubExp) -&gt; ImpM rep r op ())
 -&gt; ImpM rep r op ())
-&gt; ((ValueDestination, SubExp) -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684527710"><span class="annot"><span class="annottext">ValueDestination
</span><a href="#local-6989586621684527710"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527709"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527709"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-801"></span><span>    </span><span class="annot"><span class="annottext">ValueDestination
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
ValueDestination
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMDest"><span class="hs-identifier hs-var">copyDWIMDest</span></a></span><span> </span><span class="annot"><span class="annottext">ValueDestination
</span><a href="#local-6989586621684527710"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527709"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-802"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-803"></span><span>    </span><span id="local-6989586621684527732"><span class="annot"><span class="annottext">params :: [Param FParamMem]
</span><a href="#local-6989586621684527732"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Param FParamMem, SubExp) -&gt; Param FParamMem)
-&gt; [(Param FParamMem, SubExp)] -&gt; [Param FParamMem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param FParamMem, SubExp) -&gt; Param FParamMem
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(FParam rep, SubExp)]
[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684527739"><span class="hs-identifier hs-var">merge</span></a></span><span>
</span><span id="line-804"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileExp"><span class="hs-identifier hs-var">defCompileExp</span></a></span><span> </span><span id="local-6989586621684527708"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527708"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-type">WithAcc</span></a></span><span> </span><span id="local-6989586621684527706"><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684527706"><span class="hs-identifier hs-var">inputs</span></a></span></span><span> </span><span id="local-6989586621684527705"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684527705"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-805"></span><span>  </span><span class="annot"><span class="annottext">[LParam rep] -&gt; ImpM rep r op ()
forall rep inner r op.
Mem rep inner =&gt;
[LParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-var">dLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([LParam rep] -&gt; ImpM rep r op ())
-&gt; [LParam rep] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [LParam rep]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684527705"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-806"></span><span>  </span><span class="annot"><span class="annottext">[(WithAccInput rep, Param LParamMem)]
-&gt; ((WithAccInput rep, Param LParamMem) -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[WithAccInput rep]
-&gt; [Param LParamMem] -&gt; [(WithAccInput rep, Param LParamMem)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684527706"><span class="hs-identifier hs-var">inputs</span></a></span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; [(WithAccInput rep, Param LParamMem)])
-&gt; [Param LParamMem] -&gt; [(WithAccInput rep, Param LParamMem)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [LParam rep]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684527705"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((WithAccInput rep, Param LParamMem) -&gt; ImpM rep r op ())
 -&gt; ImpM rep r op ())
-&gt; ((WithAccInput rep, Param LParamMem) -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527703"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527703"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527702"><span class="annot"><span class="annottext">Maybe (Lambda rep, [SubExp])
</span><a href="#local-6989586621684527702"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527701"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684527701"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-807"></span><span>    </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ())
-&gt; (ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684527700"><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684527700"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-808"></span><span>      </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684527700"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateAccs :: Map VName ([VName], Maybe (Lambda rep, [SubExp]))
</span><a href="Futhark.CodeGen.ImpGen.html#stateAccs"><span class="hs-identifier hs-var">stateAccs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; ([VName], Maybe (Lambda rep, [SubExp]))
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684527701"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527703"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Lambda rep, [SubExp])
</span><a href="#local-6989586621684527702"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map VName ([VName], Maybe (Lambda rep, [SubExp]))
 -&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp])))
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
forall rep r op.
ImpState rep r op
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
</span><a href="Futhark.CodeGen.ImpGen.html#stateAccs"><span class="hs-identifier hs-var hs-var">stateAccs</span></a></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684527700"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-809"></span><span>  </span><span class="annot"><span class="annottext">Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT rep -&gt; Stms rep
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT rep -&gt; Stms rep) -&gt; BodyT rep -&gt; Stms rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684527705"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-810"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684527696"><span class="annot"><span class="annottext">nonacc_res :: Result
</span><a href="#local-6989586621684527696"><span class="hs-identifier hs-var hs-var">nonacc_res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; Result
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684527694"><span class="hs-identifier hs-var">num_accs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT rep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684527705"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-811"></span><span>        </span><span id="local-6989586621684527692"><span class="annot"><span class="annottext">nonacc_pat_names :: [VName]
</span><a href="#local-6989586621684527692"><span class="hs-identifier hs-var hs-var">nonacc_pat_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; [VName]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#takeLast"><span class="hs-identifier hs-var">takeLast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684527696"><span class="hs-identifier hs-var">nonacc_res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527708"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-812"></span><span>    </span><span class="annot"><span class="annottext">[(VName, SubExpRes)]
-&gt; ((VName, SubExpRes) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Result -&gt; [(VName, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527692"><span class="hs-identifier hs-var">nonacc_pat_names</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684527696"><span class="hs-identifier hs-var">nonacc_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExpRes) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ())
-&gt; ((VName, SubExpRes) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684527689"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527689"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684527688"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527688"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-813"></span><span>      </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527689"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527688"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-814"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-815"></span><span>    </span><span id="local-6989586621684527694"><span class="annot"><span class="annottext">num_accs :: Int
</span><a href="#local-6989586621684527694"><span class="hs-identifier hs-var hs-var">num_accs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[WithAccInput rep]
</span><a href="#local-6989586621684527706"><span class="hs-identifier hs-var">inputs</span></a></span><span>
</span><span id="line-816"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileExp"><span class="hs-identifier hs-var">defCompileExp</span></a></span><span> </span><span id="local-6989586621684527687"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527687"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span id="local-6989586621684527685"><span class="annot"><span class="annottext">Op rep
</span><a href="#local-6989586621684527685"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-817"></span><span>  </span><span id="local-6989586621684527684"><span class="annot"><span class="annottext">Pat rep -&gt; MemOp inner -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684527684"><span class="hs-identifier hs-var">opc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Pat rep -&gt; MemOp inner -&gt; ImpM rep r op ())
-&gt; ImpM rep r op (Pat rep -&gt; MemOp inner -&gt; ImpM rep r op ())
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; Pat rep -&gt; MemOp inner -&gt; ImpM rep r op ()
forall rep r op. Env rep r op -&gt; OpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envOpCompiler"><span class="hs-identifier hs-var hs-var">envOpCompiler</span></a></span><span>
</span><span id="line-818"></span><span>  </span><span class="annot"><span class="annottext">Pat rep -&gt; MemOp inner -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684527684"><span class="hs-identifier hs-var">opc</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684527687"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Op rep
MemOp inner
</span><a href="#local-6989586621684527685"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-819"></span><span>
</span><span id="line-820"></span><span id="local-6989586621684529924"><span id="local-6989586621684529925"><span id="local-6989586621684529926"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#tracePrim"><span class="hs-identifier hs-type">tracePrim</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529926"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529925"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529924"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-821"></span><span id="tracePrim"><span class="annot"><span class="annottext">tracePrim :: forall rep r op. [Char] -&gt; PrimType -&gt; SubExp -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#tracePrim"><span class="hs-identifier hs-var hs-var">tracePrim</span></a></span></span><span> </span><span id="local-6989586621684527678"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527678"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684527677"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527677"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684527676"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527676"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-822"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ())
-&gt; (ErrorMsg (PrimExp VName) -&gt; Code op)
-&gt; ErrorMsg (PrimExp VName)
-&gt; ImpM rep r op ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ErrorMsg (PrimExp VName) -&gt; Code op
forall a. ErrorMsg (PrimExp VName) -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#TracePrint"><span class="hs-identifier hs-var">Imp.TracePrint</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorMsg (PrimExp VName) -&gt; ImpM rep r op ())
-&gt; ErrorMsg (PrimExp VName) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-823"></span><span>    </span><span class="annot"><span class="annottext">[ErrorMsgPart (PrimExp VName)] -&gt; ErrorMsg (PrimExp VName)
forall a. [ErrorMsgPart a] -&gt; ErrorMsg a
</span><a href="Futhark.IR.Syntax.Core.html#ErrorMsg"><span class="hs-identifier hs-var">ErrorMsg</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char] -&gt; ErrorMsgPart (PrimExp VName)
forall a. [Char] -&gt; ErrorMsgPart a
</span><a href="Futhark.IR.Syntax.Core.html#ErrorString"><span class="hs-identifier hs-var">ErrorString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527678"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;: &quot;</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; PrimExp VName -&gt; ErrorMsgPart (PrimExp VName)
forall a. PrimType -&gt; a -&gt; ErrorMsgPart a
</span><a href="Futhark.IR.Syntax.Core.html#ErrorVal"><span class="hs-identifier hs-var">ErrorVal</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527677"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; PrimExp VName
forall a. ToExp a =&gt; PrimType -&gt; a -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpGen.html#toExp%27"><span class="hs-identifier hs-var">toExp'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527677"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527676"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ErrorMsgPart (PrimExp VName)
forall a. [Char] -&gt; ErrorMsgPart a
</span><a href="Futhark.IR.Syntax.Core.html#ErrorString"><span class="hs-identifier hs-var">ErrorString</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;\n&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-824"></span><span>
</span><span id="line-825"></span><span id="local-6989586621684529913"><span id="local-6989586621684529914"><span id="local-6989586621684529915"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#traceArray"><span class="hs-identifier hs-type">traceArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529915"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529914"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529913"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-826"></span><span id="traceArray"><span class="annot"><span class="annottext">traceArray :: forall rep r op.
[Char] -&gt; PrimType -&gt; Shape -&gt; SubExp -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#traceArray"><span class="hs-identifier hs-var hs-var">traceArray</span></a></span></span><span> </span><span id="local-6989586621684527661"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527661"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684527660"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527660"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684527659"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684527659"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684527658"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527658"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-827"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ())
-&gt; (ErrorMsg (PrimExp VName) -&gt; Code op)
-&gt; ErrorMsg (PrimExp VName)
-&gt; ImpM rep r op ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ErrorMsg (PrimExp VName) -&gt; Code op
forall a. ErrorMsg (PrimExp VName) -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#TracePrint"><span class="hs-identifier hs-var">Imp.TracePrint</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorMsg (PrimExp VName) -&gt; ImpM rep r op ())
-&gt; ErrorMsg (PrimExp VName) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ErrorMsgPart (PrimExp VName)] -&gt; ErrorMsg (PrimExp VName)
forall a. [ErrorMsgPart a] -&gt; ErrorMsg a
</span><a href="Futhark.IR.Syntax.Core.html#ErrorMsg"><span class="hs-identifier hs-var">ErrorMsg</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char] -&gt; ErrorMsgPart (PrimExp VName)
forall a. [Char] -&gt; ErrorMsgPart a
</span><a href="Futhark.IR.Syntax.Core.html#ErrorString"><span class="hs-identifier hs-var">ErrorString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527661"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;: &quot;</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-828"></span><span>  </span><span class="annot"><span class="annottext">Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684527659"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ())
-&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684527657"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684527657"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-829"></span><span>    </span><span id="local-6989586621684527656"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684527656"><span class="hs-identifier hs-var">arr_elem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; PrimType -&gt; ImpM rep r op (TV Any)
forall rep r op t. [Char] -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;arr_elem&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527660"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-830"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684527656"><span class="hs-identifier hs-var">arr_elem</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527658"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684527657"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-831"></span><span>    </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ())
-&gt; (ErrorMsg (PrimExp VName) -&gt; Code op)
-&gt; ErrorMsg (PrimExp VName)
-&gt; ImpM rep r op ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ErrorMsg (PrimExp VName) -&gt; Code op
forall a. ErrorMsg (PrimExp VName) -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#TracePrint"><span class="hs-identifier hs-var">Imp.TracePrint</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorMsg (PrimExp VName) -&gt; ImpM rep r op ())
-&gt; ErrorMsg (PrimExp VName) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ErrorMsgPart (PrimExp VName)] -&gt; ErrorMsg (PrimExp VName)
forall a. [ErrorMsgPart a] -&gt; ErrorMsg a
</span><a href="Futhark.IR.Syntax.Core.html#ErrorMsg"><span class="hs-identifier hs-var">ErrorMsg</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimType -&gt; PrimExp VName -&gt; ErrorMsgPart (PrimExp VName)
forall a. PrimType -&gt; a -&gt; ErrorMsgPart a
</span><a href="Futhark.IR.Syntax.Core.html#ErrorVal"><span class="hs-identifier hs-var">ErrorVal</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527660"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Any VName -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; TPrimExp Any VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684527656"><span class="hs-identifier hs-var">arr_elem</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ErrorMsgPart (PrimExp VName)
</span><span class="hs-string">&quot; &quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-832"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ())
-&gt; (ErrorMsg (PrimExp VName) -&gt; Code op)
-&gt; ErrorMsg (PrimExp VName)
-&gt; ImpM rep r op ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ErrorMsg (PrimExp VName) -&gt; Code op
forall a. ErrorMsg (PrimExp VName) -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#TracePrint"><span class="hs-identifier hs-var">Imp.TracePrint</span></a></span><span> </span><span class="annot"><span class="annottext">(ErrorMsg (PrimExp VName) -&gt; ImpM rep r op ())
-&gt; ErrorMsg (PrimExp VName) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ErrorMsgPart (PrimExp VName)] -&gt; ErrorMsg (PrimExp VName)
forall a. [ErrorMsgPart a] -&gt; ErrorMsg a
</span><a href="Futhark.IR.Syntax.Core.html#ErrorMsg"><span class="hs-identifier hs-var">ErrorMsg</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ErrorMsgPart (PrimExp VName)
</span><span class="hs-string">&quot;\n&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-833"></span><span>
</span><span id="line-834"></span><span id="local-6989586621684529960"><span id="local-6989586621684529961"><span id="local-6989586621684529962"><span id="local-6989586621684529963"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-type">defCompileBasicOp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-835"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529963"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529962"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-836"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529963"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-837"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-838"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529963"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529961"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529960"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-839"></span><span id="defCompileBasicOp"><span class="annot"><span class="annottext">defCompileBasicOp :: forall rep inner r op.
Mem rep inner =&gt;
Pat rep -&gt; BasicOp -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var hs-var">defCompileBasicOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527464"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527464"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span id="local-6989586621684527462"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527462"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-840"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527464"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527462"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-841"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527461"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527461"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Opaque"><span class="hs-identifier hs-type">Opaque</span></a></span><span> </span><span id="local-6989586621684527459"><span class="annot"><span class="annottext">OpaqueOp
</span><a href="#local-6989586621684527459"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621684527458"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527458"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-842"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527461"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527458"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-843"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">OpaqueOp
</span><a href="#local-6989586621684527459"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-844"></span><span>    </span><span class="annot"><span class="annottext">OpaqueOp
</span><a href="Futhark.IR.Syntax.html#OpaqueNil"><span class="hs-identifier hs-var">OpaqueNil</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-845"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#OpaqueTrace"><span class="hs-identifier hs-type">OpaqueTrace</span></a></span><span> </span><span id="local-6989586621684527455"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527455"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op. [Char] -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#comment"><span class="hs-identifier hs-var">comment</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Trace: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527455"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-846"></span><span>      </span><span id="local-6989586621684527454"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684527454"><span class="hs-identifier hs-var">se_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM rep r op Type
forall t (m :: * -&gt; *). HasScope t m =&gt; SubExp -&gt; m Type
</span><a href="Futhark.IR.Prop.TypeOf.html#subExpType"><span class="hs-identifier hs-var">subExpType</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527458"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-847"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684527454"><span class="hs-identifier hs-var">se_t</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-848"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684527453"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527453"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; PrimType -&gt; SubExp -&gt; ImpM rep r op ()
forall rep r op. [Char] -&gt; PrimType -&gt; SubExp -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#tracePrim"><span class="hs-identifier hs-var">tracePrim</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527455"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527453"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527458"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-849"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684527452"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527452"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684527451"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684527451"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; PrimType -&gt; Shape -&gt; SubExp -&gt; ImpM rep r op ()
forall rep r op.
[Char] -&gt; PrimType -&gt; Shape -&gt; SubExp -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#traceArray"><span class="hs-identifier hs-var">traceArray</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527455"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527452"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684527451"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527458"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-850"></span><span>        </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-851"></span><span>          </span><span class="annot"><span class="annottext">[SrcLoc] -&gt; [[SrcLoc]] -&gt; [Char] -&gt; ImpM rep r op ()
forall loc rep r op.
Located loc =&gt;
loc -&gt; [loc] -&gt; [Char] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#warn"><span class="hs-identifier hs-var">warn</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[[SrcLoc]]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op ()) -&gt; [Char] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-852"></span><span>            </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527455"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;: cannot trace value of this (core) type: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684527454"><span class="hs-identifier hs-var">se_t</span></a></span><span>
</span><span id="line-853"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527449"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527449"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#UnOp"><span class="hs-identifier hs-type">UnOp</span></a></span><span> </span><span id="local-6989586621684527447"><span class="annot"><span class="annottext">UnOp
</span><a href="#local-6989586621684527447"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621684527446"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527446"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-854"></span><span>  </span><span id="local-6989586621684527445"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527445"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM rep r op (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527446"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-855"></span><span>  </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527449"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator hs-var">&lt;~~</span></a></span><span> </span><span class="annot"><span class="annottext">UnOp -&gt; PrimExp VName -&gt; PrimExp VName
forall v. UnOp -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#UnOpExp"><span class="hs-identifier hs-var">Imp.UnOpExp</span></a></span><span> </span><span class="annot"><span class="annottext">UnOp
</span><a href="#local-6989586621684527447"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527445"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-856"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527443"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527443"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#ConvOp"><span class="hs-identifier hs-type">ConvOp</span></a></span><span> </span><span id="local-6989586621684527441"><span class="annot"><span class="annottext">ConvOp
</span><a href="#local-6989586621684527441"><span class="hs-identifier hs-var">conv</span></a></span></span><span> </span><span id="local-6989586621684527440"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527440"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-857"></span><span>  </span><span id="local-6989586621684527439"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527439"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM rep r op (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527440"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-858"></span><span>  </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527443"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator hs-var">&lt;~~</span></a></span><span> </span><span class="annot"><span class="annottext">ConvOp -&gt; PrimExp VName -&gt; PrimExp VName
forall v. ConvOp -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#ConvOpExp"><span class="hs-identifier hs-var">Imp.ConvOpExp</span></a></span><span> </span><span class="annot"><span class="annottext">ConvOp
</span><a href="#local-6989586621684527441"><span class="hs-identifier hs-var">conv</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527439"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-859"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527437"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527437"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span id="local-6989586621684527435"><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684527435"><span class="hs-identifier hs-var">bop</span></a></span></span><span> </span><span id="local-6989586621684527434"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527434"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684527433"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527433"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-860"></span><span>  </span><span id="local-6989586621684527432"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527432"><span class="hs-identifier hs-var">x'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM rep r op (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527434"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-861"></span><span>  </span><span id="local-6989586621684527431"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527431"><span class="hs-identifier hs-var">y'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM rep r op (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527433"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-862"></span><span>  </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527437"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator hs-var">&lt;~~</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. BinOp -&gt; PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#BinOpExp"><span class="hs-identifier hs-var">Imp.BinOpExp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684527435"><span class="hs-identifier hs-var">bop</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527432"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527431"><span class="hs-identifier hs-var">y'</span></a></span><span>
</span><span id="line-863"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527429"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527429"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#CmpOp"><span class="hs-identifier hs-type">CmpOp</span></a></span><span> </span><span id="local-6989586621684527427"><span class="annot"><span class="annottext">CmpOp
</span><a href="#local-6989586621684527427"><span class="hs-identifier hs-var">bop</span></a></span></span><span> </span><span id="local-6989586621684527426"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527426"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684527425"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527425"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-864"></span><span>  </span><span id="local-6989586621684527424"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527424"><span class="hs-identifier hs-var">x'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM rep r op (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527426"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-865"></span><span>  </span><span id="local-6989586621684527423"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527423"><span class="hs-identifier hs-var">y'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM rep r op (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527425"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-866"></span><span>  </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527429"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator hs-var">&lt;~~</span></a></span><span> </span><span class="annot"><span class="annottext">CmpOp -&gt; PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. CmpOp -&gt; PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#CmpOpExp"><span class="hs-identifier hs-var">Imp.CmpOpExp</span></a></span><span> </span><span class="annot"><span class="annottext">CmpOp
</span><a href="#local-6989586621684527427"><span class="hs-identifier hs-var">bop</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527424"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527423"><span class="hs-identifier hs-var">y'</span></a></span><span>
</span><span id="line-867"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Assert"><span class="hs-identifier hs-type">Assert</span></a></span><span> </span><span id="local-6989586621684527420"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527420"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684527419"><span class="annot"><span class="annottext">ErrorMsg SubExp
</span><a href="#local-6989586621684527419"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span id="local-6989586621684527418"><span class="annot"><span class="annottext">(SrcLoc, [SrcLoc])
</span><a href="#local-6989586621684527418"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-868"></span><span>  </span><span id="local-6989586621684527417"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527417"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM rep r op (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527420"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-869"></span><span>  </span><span id="local-6989586621684527416"><span class="annot"><span class="annottext">ErrorMsg (PrimExp VName)
</span><a href="#local-6989586621684527416"><span class="hs-identifier hs-var">msg'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; ImpM rep r op (PrimExp VName))
-&gt; ErrorMsg SubExp -&gt; ImpM rep r op (ErrorMsg (PrimExp VName))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM rep r op (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorMsg SubExp
</span><a href="#local-6989586621684527419"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-870"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
-&gt; ErrorMsg (PrimExp VName) -&gt; (SrcLoc, [SrcLoc]) -&gt; Code op
forall a.
PrimExp VName
-&gt; ErrorMsg (PrimExp VName) -&gt; (SrcLoc, [SrcLoc]) -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Assert"><span class="hs-identifier hs-var">Imp.Assert</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527417"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorMsg (PrimExp VName)
</span><a href="#local-6989586621684527416"><span class="hs-identifier hs-var">msg'</span></a></span><span> </span><span class="annot"><span class="annottext">(SrcLoc, [SrcLoc])
</span><a href="#local-6989586621684527418"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-871"></span><span>
</span><span id="line-872"></span><span>  </span><span id="local-6989586621684527413"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684527413"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op Attrs
forall rep r op. ImpM rep r op Attrs
</span><a href="Futhark.CodeGen.ImpGen.html#askAttrs"><span class="hs-identifier hs-var">askAttrs</span></a></span><span>
</span><span id="line-873"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; [Attr] -&gt; Attr
</span><a href="Futhark.IR.Syntax.Core.html#AttrComp"><span class="hs-identifier hs-var">AttrComp</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;warn&quot;</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;safety_checks&quot;</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684527413"><span class="hs-identifier hs-var">attrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-874"></span><span>    </span><span class="annot"><span class="annottext">(SrcLoc -&gt; [SrcLoc] -&gt; [Char] -&gt; ImpM rep r op ())
-&gt; (SrcLoc, [SrcLoc]) -&gt; [Char] -&gt; ImpM rep r op ()
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; [SrcLoc] -&gt; [Char] -&gt; ImpM rep r op ()
forall loc rep r op.
Located loc =&gt;
loc -&gt; [loc] -&gt; [Char] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#warn"><span class="hs-identifier hs-var">warn</span></a></span><span> </span><span class="annot"><span class="annottext">(SrcLoc, [SrcLoc])
</span><a href="#local-6989586621684527418"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Safety check required at run-time.&quot;</span></span><span>
</span><span id="line-875"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527411"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527411"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span id="local-6989586621684527409"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527409"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621684527408"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684527408"><span class="hs-identifier hs-var">slice</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-876"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684527407"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527407"><span class="hs-identifier hs-var">idxs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; Maybe [SubExp]
forall d. Slice d -&gt; Maybe [d]
</span><a href="Futhark.IR.Syntax.Core.html#sliceIndices"><span class="hs-identifier hs-var">sliceIndices</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684527408"><span class="hs-identifier hs-var">slice</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-877"></span><span>    </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527411"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527409"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([DimIndex (TExp Int64)] -&gt; ImpM rep r op ())
-&gt; [DimIndex (TExp Int64)] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; DimIndex (TExp Int64))
-&gt; [SubExp] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; (SubExp -&gt; TExp Int64) -&gt; SubExp -&gt; DimIndex (TExp Int64)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527407"><span class="hs-identifier hs-var">idxs</span></a></span><span>
</span><span id="line-878"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-879"></span><span>  </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-880"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527404"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527404"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span id="local-6989586621684527402"><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684527402"><span class="hs-identifier hs-var">safety</span></a></span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684527401"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684527401"><span class="hs-identifier hs-var">slice</span></a></span></span><span> </span><span id="local-6989586621684527400"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527400"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-881"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="#local-6989586621684527402"><span class="hs-identifier hs-var">safety</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-882"></span><span>    </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Unsafe"><span class="hs-identifier hs-var">Unsafe</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684527398"><span class="hs-identifier hs-var">write</span></a></span><span>
</span><span id="line-883"></span><span>    </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Safe"><span class="hs-identifier hs-var">Safe</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [TExp Int64] -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.html#inBounds"><span class="hs-identifier hs-var">inBounds</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684527396"><span class="hs-identifier hs-var">slice'</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684527395"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684527398"><span class="hs-identifier hs-var">write</span></a></span><span>
</span><span id="line-884"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-885"></span><span>    </span><span id="local-6989586621684527396"><span class="annot"><span class="annottext">slice' :: Slice (TExp Int64)
</span><a href="#local-6989586621684527396"><span class="hs-identifier hs-var hs-var">slice'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; Slice SubExp -&gt; Slice (TExp Int64)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684527401"><span class="hs-identifier hs-var">slice</span></a></span><span>
</span><span id="line-886"></span><span>    </span><span id="local-6989586621684527395"><span class="annot"><span class="annottext">dims :: [TExp Int64]
</span><a href="#local-6989586621684527395"><span class="hs-identifier hs-var hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; [SubExp]) -&gt; Type -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; Type
forall dec. Typed dec =&gt; PatElemT dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#patElemType"><span class="hs-identifier hs-var">patElemType</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527404"><span class="hs-identifier hs-var">pe</span></a></span><span>
</span><span id="line-887"></span><span>    </span><span id="local-6989586621684527398"><span class="annot"><span class="annottext">write :: ImpM rep r op ()
</span><a href="#local-6989586621684527398"><span class="hs-identifier hs-var hs-var">write</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice (TExp Int64) -&gt; SubExp -&gt; ImpM rep r op ()
forall rep r op.
VName -&gt; Slice (TExp Int64) -&gt; SubExp -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sUpdate"><span class="hs-identifier hs-var">sUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527404"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684527396"><span class="hs-identifier hs-var">slice'</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527400"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-888"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#FlatIndex"><span class="hs-identifier hs-type">FlatIndex</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-889"></span><span>  </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-890"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527392"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527392"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FlatUpdate"><span class="hs-identifier hs-type">FlatUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684527390"><span class="annot"><span class="annottext">FlatSlice SubExp
</span><a href="#local-6989586621684527390"><span class="hs-identifier hs-var">slice</span></a></span></span><span> </span><span id="local-6989586621684527389"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527389"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-891"></span><span>  </span><span id="local-6989586621684527388"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684527388"><span class="hs-identifier hs-var">pe_loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ArrayEntry -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var hs-var">entryArrayLoc</span></a></span><span> </span><span class="annot"><span class="annottext">(ArrayEntry -&gt; MemLoc)
-&gt; ImpM rep r op ArrayEntry -&gt; ImpM rep r op MemLoc
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op ArrayEntry
forall rep r op. VName -&gt; ImpM rep r op ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArray"><span class="hs-identifier hs-var">lookupArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527392"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-892"></span><span>  </span><span id="local-6989586621684527387"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684527387"><span class="hs-identifier hs-var">v_loc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ArrayEntry -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var hs-var">entryArrayLoc</span></a></span><span> </span><span class="annot"><span class="annottext">(ArrayEntry -&gt; MemLoc)
-&gt; ImpM rep r op ArrayEntry -&gt; ImpM rep r op MemLoc
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op ArrayEntry
forall rep r op. VName -&gt; ImpM rep r op ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArray"><span class="hs-identifier hs-var">lookupArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527389"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-893"></span><span>  </span><span class="annot"><span class="annottext">CopyCompiler rep r op
forall rep r op. CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#copy"><span class="hs-identifier hs-var">copy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; Type
forall dec. Typed dec =&gt; PatElemT dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#patElemType"><span class="hs-identifier hs-var">patElemType</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527392"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; FlatSlice (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#flatSliceMemLoc"><span class="hs-identifier hs-var">flatSliceMemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684527388"><span class="hs-identifier hs-var">pe_loc</span></a></span><span> </span><span class="annot"><span class="annottext">FlatSlice (TExp Int64)
</span><a href="#local-6989586621684527385"><span class="hs-identifier hs-var">slice'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684527387"><span class="hs-identifier hs-var">v_loc</span></a></span><span>
</span><span id="line-894"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-895"></span><span>    </span><span id="local-6989586621684527385"><span class="annot"><span class="annottext">slice' :: FlatSlice (TExp Int64)
</span><a href="#local-6989586621684527385"><span class="hs-identifier hs-var hs-var">slice'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64)
-&gt; FlatSlice SubExp -&gt; FlatSlice (TExp Int64)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">FlatSlice SubExp
</span><a href="#local-6989586621684527390"><span class="hs-identifier hs-var">slice</span></a></span><span>
</span><span id="line-896"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527384"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527384"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span id="local-6989586621684527382"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527382"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684527381"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527381"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-897"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; Type
forall dec. Typed dec =&gt; PatElemT dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#patElemType"><span class="hs-identifier hs-var">patElemType</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527384"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-898"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-899"></span><span>    </span><span id="local-6989586621684527380"><span class="annot"><span class="annottext">[PrimExp VName]
</span><a href="#local-6989586621684527380"><span class="hs-identifier hs-var">ds'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; ImpM rep r op (PrimExp VName))
-&gt; [SubExp] -&gt; ImpM rep r op [PrimExp VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM rep r op (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527382"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-900"></span><span>    </span><span id="local-6989586621684527379"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527379"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ImpM rep r op VName -&gt; ImpM rep r op [VName]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527382"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;i&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-901"></span><span>    </span><span id="local-6989586621684527377"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684527377"><span class="hs-identifier hs-var">copy_elem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op (Code op))
-&gt; ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527384"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; DimIndex (TExp Int64))
-&gt; [VName] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; (VName -&gt; TExp Int64) -&gt; VName -&gt; DimIndex (TExp Int64)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527379"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527381"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-902"></span><span>    </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Code op -&gt; Code op)
 -&gt; (Code op -&gt; Code op) -&gt; Code op -&gt; Code op)
-&gt; (Code op -&gt; Code op)
-&gt; [Code op -&gt; Code op]
-&gt; Code op
-&gt; Code op
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; Code op) -&gt; (Code op -&gt; Code op) -&gt; Code op -&gt; Code op
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">(.)</span></span><span> </span><span class="annot"><span class="annottext">Code op -&gt; Code op
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; PrimExp VName -&gt; Code op -&gt; Code op)
-&gt; [VName] -&gt; [PrimExp VName] -&gt; [Code op -&gt; Code op]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; Code op -&gt; Code op
forall a. VName -&gt; PrimExp VName -&gt; Code a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#For"><span class="hs-identifier hs-var">Imp.For</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527379"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimExp VName]
</span><a href="#local-6989586621684527380"><span class="hs-identifier hs-var">ds'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684527377"><span class="hs-identifier hs-var">copy_elem</span></a></span><span>
</span><span id="line-903"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Scratch"><span class="hs-identifier hs-type">Scratch</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-904"></span><span>  </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-905"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527371"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527371"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Iota"><span class="hs-identifier hs-type">Iota</span></a></span><span> </span><span id="local-6989586621684527369"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527369"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684527368"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527368"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684527367"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527367"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684527366"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684527366"><span class="hs-identifier hs-var">it</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-906"></span><span>  </span><span id="local-6989586621684527365"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527365"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM rep r op (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527368"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-907"></span><span>  </span><span id="local-6989586621684527364"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527364"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ImpM rep r op (PrimExp VName)
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op (PrimExp VName)
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527367"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-908"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; TExp Int64
-&gt; (TExp Int64 -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall t rep r op.
[Char]
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527369"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((TExp Int64 -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ())
-&gt; (TExp Int64 -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684527363"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684527363"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-909"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684527362"><span class="annot"><span class="annottext">i' :: PrimExp VName
</span><a href="#local-6989586621684527362"><span class="hs-identifier hs-var hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimExp VName -&gt; PrimExp VName
forall v. IntType -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#sExt"><span class="hs-identifier hs-var">sExt</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684527366"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; PrimExp VName) -&gt; PrimExp VName -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684527363"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-910"></span><span>    </span><span id="local-6989586621684527360"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684527360"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-911"></span><span>      </span><span class="annot"><span class="annottext">[Char] -&gt; TPrimExp Any VName -&gt; ImpM rep r op (TV Any)
forall t rep r op. [Char] -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;x&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Any VName -&gt; ImpM rep r op (TV Any))
-&gt; (PrimExp VName -&gt; TPrimExp Any VName)
-&gt; PrimExp VName
-&gt; ImpM rep r op (TV Any)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; TPrimExp Any VName
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; ImpM rep r op (TV Any))
-&gt; PrimExp VName -&gt; ImpM rep r op (TV Any)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-912"></span><span>        </span><span class="annot"><span class="annottext">BinOp -&gt; PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. BinOp -&gt; PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#BinOpExp"><span class="hs-identifier hs-var">BinOpExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Add"><span class="hs-identifier hs-var">Add</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684527366"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527365"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; PrimExp VName) -&gt; PrimExp VName -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-913"></span><span>          </span><span class="annot"><span class="annottext">BinOp -&gt; PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. BinOp -&gt; PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#BinOpExp"><span class="hs-identifier hs-var">BinOpExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Mul"><span class="hs-identifier hs-var">Mul</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684527366"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527362"><span class="hs-identifier hs-var">i'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684527364"><span class="hs-identifier hs-var">s'</span></a></span><span>
</span><span id="line-914"></span><span>    </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527371"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684527363"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684527360"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-915"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527356"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527356"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-type">Copy</span></a></span><span> </span><span id="local-6989586621684527354"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527354"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-916"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527356"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527354"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-917"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527353"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527353"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Manifest"><span class="hs-identifier hs-type">Manifest</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684527351"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527351"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-918"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527353"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527351"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-919"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527350"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527350"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Concat"><span class="hs-identifier hs-type">Concat</span></a></span><span> </span><span id="local-6989586621684527348"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684527348"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684527347"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527347"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684527346"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527346"><span class="hs-identifier hs-var">ys</span></a></span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-920"></span><span>  </span><span id="local-6989586621684527345"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684527345"><span class="hs-identifier hs-var">offs_glb</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; TExp Int64 -&gt; ImpM rep r op (TV Int64)
forall t rep r op. [Char] -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;tmp_offs&quot;</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">0</span></span><span>
</span><span id="line-921"></span><span>
</span><span id="line-922"></span><span>  </span><span class="annot"><span class="annottext">[VName] -&gt; (VName -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527347"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527346"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((VName -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ())
-&gt; (VName -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684527344"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527344"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-923"></span><span>    </span><span id="local-6989586621684527343"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527343"><span class="hs-identifier hs-var">y_dims</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; [SubExp]) -&gt; ImpM rep r op Type -&gt; ImpM rep r op [SubExp]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527344"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-924"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684527341"><span class="annot"><span class="annottext">rows :: TExp Int64
</span><a href="#local-6989586621684527341"><span class="hs-identifier hs-var hs-var">rows</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [SubExp] -&gt; [SubExp]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684527348"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527343"><span class="hs-identifier hs-var">y_dims</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-925"></span><span>          </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; TExp Int64
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; TExp Int64) -&gt; [Char] -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;defCompileBasicOp Concat: empty array shape for &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527344"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-926"></span><span>          </span><span id="local-6989586621684527340"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527340"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527340"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-927"></span><span>        </span><span id="local-6989586621684527339"><span class="annot"><span class="annottext">skip_dims :: [SubExp]
</span><a href="#local-6989586621684527339"><span class="hs-identifier hs-var hs-var">skip_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [SubExp] -&gt; [SubExp]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684527348"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527343"><span class="hs-identifier hs-var">y_dims</span></a></span><span>
</span><span id="line-928"></span><span>        </span><span id="local-6989586621684527334"><span class="annot"><span class="annottext">sliceAllDim :: d -&gt; DimIndex d
</span><a href="#local-6989586621684527334"><span class="hs-identifier hs-var hs-var">sliceAllDim</span></a></span></span><span> </span><span id="local-6989586621684527333"><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684527333"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">d -&gt; d -&gt; d -&gt; DimIndex d
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">d
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684527333"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">d
</span><span class="hs-number">1</span></span><span>
</span><span id="line-929"></span><span>        </span><span id="local-6989586621684527331"><span class="annot"><span class="annottext">skip_slices :: [DimIndex (TExp Int64)]
</span><a href="#local-6989586621684527331"><span class="hs-identifier hs-var hs-var">skip_slices</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; DimIndex (TExp Int64))
-&gt; [SubExp] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall {d}. Num d =&gt; d -&gt; DimIndex d
</span><a href="#local-6989586621684527334"><span class="hs-identifier hs-var">sliceAllDim</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; (SubExp -&gt; TExp Int64) -&gt; SubExp -&gt; DimIndex (TExp Int64)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527339"><span class="hs-identifier hs-var">skip_dims</span></a></span><span>
</span><span id="line-930"></span><span>        </span><span id="local-6989586621684527330"><span class="annot"><span class="annottext">destslice :: [DimIndex (TExp Int64)]
</span><a href="#local-6989586621684527330"><span class="hs-identifier hs-var hs-var">destslice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684527331"><span class="hs-identifier hs-var">skip_slices</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
-&gt; [DimIndex (TExp Int64)] -&gt; [DimIndex (TExp Int64)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684527345"><span class="hs-identifier hs-var">offs_glb</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684527341"><span class="hs-identifier hs-var">rows</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-931"></span><span>    </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527350"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684527330"><span class="hs-identifier hs-var">destslice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527344"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-932"></span><span>    </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684527345"><span class="hs-identifier hs-var">offs_glb</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64 -&gt; ImpM rep r op ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684527345"><span class="hs-identifier hs-var">offs_glb</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684527341"><span class="hs-identifier hs-var">rows</span></a></span><span>
</span><span id="line-933"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684527329"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527329"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#ArrayLit"><span class="hs-identifier hs-type">ArrayLit</span></a></span><span> </span><span id="local-6989586621684527327"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527327"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-934"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684527326"><span class="annot"><span class="annottext">vs :: [PrimValue]
</span><a href="#local-6989586621684527326"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621684527325"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684527325"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[PrimValue]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Maybe PrimValue) -&gt; [SubExp] -&gt; Maybe [PrimValue]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Maybe PrimValue
</span><a href="#local-6989586621684527324"><span class="hs-identifier hs-var">isLiteral</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527327"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-935"></span><span>    </span><span id="local-6989586621684527323"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684527323"><span class="hs-identifier hs-var">dest_mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ArrayEntry -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var hs-var">entryArrayLoc</span></a></span><span> </span><span class="annot"><span class="annottext">(ArrayEntry -&gt; MemLoc)
-&gt; ImpM rep r op ArrayEntry -&gt; ImpM rep r op MemLoc
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op ArrayEntry
forall rep r op. VName -&gt; ImpM rep r op ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArray"><span class="hs-identifier hs-var">lookupArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527329"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-936"></span><span>    </span><span id="local-6989586621684527322"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684527322"><span class="hs-identifier hs-var">dest_space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(MemEntry -&gt; Space)
-&gt; ImpM rep r op MemEntry -&gt; ImpM rep r op Space
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op MemEntry
forall rep r op. VName -&gt; ImpM rep r op MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier hs-var">lookupMemory</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#memLocName"><span class="hs-identifier hs-var hs-var">memLocName</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684527323"><span class="hs-identifier hs-var">dest_mem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-937"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684527321"><span class="annot"><span class="annottext">t :: PrimType
</span><a href="#local-6989586621684527321"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#primValueType"><span class="hs-identifier hs-var">primValueType</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684527325"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-938"></span><span>    </span><span id="local-6989586621684527319"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527319"><span class="hs-identifier hs-var">static_array</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall rep r op. [Char] -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#newVNameForFun"><span class="hs-identifier hs-var">newVNameForFun</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;static_array&quot;</span></span><span>
</span><span id="line-939"></span><span>    </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; PrimType -&gt; ArrayContents -&gt; Code op
forall a. VName -&gt; Space -&gt; PrimType -&gt; ArrayContents -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DeclareArray"><span class="hs-identifier hs-var">Imp.DeclareArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527319"><span class="hs-identifier hs-var">static_array</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684527322"><span class="hs-identifier hs-var">dest_space</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527321"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">(ArrayContents -&gt; Code op) -&gt; ArrayContents -&gt; Code op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PrimValue] -&gt; ArrayContents
</span><a href="Futhark.CodeGen.ImpCode.html#ArrayValues"><span class="hs-identifier hs-var">Imp.ArrayValues</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimValue]
</span><a href="#local-6989586621684527326"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-940"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684527316"><span class="annot"><span class="annottext">static_src :: MemLoc
</span><a href="#local-6989586621684527316"><span class="hs-identifier hs-var hs-var">static_src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-941"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; [SubExp] -&gt; IxFun (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-var">MemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527319"><span class="hs-identifier hs-var">static_array</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; SubExp) -&gt; Integer -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Integer
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Integer) -&gt; Int -&gt; Integer
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527327"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(IxFun (TExp Int64) -&gt; MemLoc) -&gt; IxFun (TExp Int64) -&gt; MemLoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-942"></span><span>            </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; IxFun (TExp Int64)
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int -&gt; TExp Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; TExp Int64) -&gt; Int -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527327"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-943"></span><span>        </span><span id="local-6989586621684527312"><span class="annot"><span class="annottext">entry :: VarEntry rep
</span><a href="#local-6989586621684527312"><span class="hs-identifier hs-var hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; MemEntry -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; MemEntry -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-var">MemVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(MemEntry -&gt; VarEntry rep) -&gt; MemEntry -&gt; VarEntry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#MemEntry"><span class="hs-identifier hs-var">MemEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684527322"><span class="hs-identifier hs-var">dest_space</span></a></span><span>
</span><span id="line-944"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addVar"><span class="hs-identifier hs-var">addVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527319"><span class="hs-identifier hs-var">static_array</span></a></span><span> </span><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684527312"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-945"></span><span>    </span><span class="annot"><span class="annottext">CopyCompiler rep r op
forall rep r op. CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#copy"><span class="hs-identifier hs-var">copy</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527321"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684527323"><span class="hs-identifier hs-var">dest_mem</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684527316"><span class="hs-identifier hs-var">static_src</span></a></span><span>
</span><span id="line-946"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-947"></span><span>    </span><span class="annot"><span class="annottext">[(Integer, SubExp)]
-&gt; ((Integer, SubExp) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Integer] -&gt; [SubExp] -&gt; [(Integer, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527327"><span class="hs-identifier hs-var">es</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Integer, SubExp) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ())
-&gt; ((Integer, SubExp) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684527310"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684527310"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527309"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527309"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-948"></span><span>      </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684527329"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; TExp Int64 -&gt; DimIndex (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Integer -&gt; TExp Int64
forall a. Num a =&gt; Integer -&gt; a
</span><span class="hs-identifier hs-var">fromInteger</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684527310"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527309"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-949"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-950"></span><span>    </span><span id="local-6989586621684527324"><span class="annot"><span class="annottext">isLiteral :: SubExp -&gt; Maybe PrimValue
</span><a href="#local-6989586621684527324"><span class="hs-identifier hs-var hs-var">isLiteral</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684527307"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684527307"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; Maybe PrimValue
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684527307"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-951"></span><span>    </span><span class="annot"><a href="#local-6989586621684527324"><span class="hs-identifier hs-var">isLiteral</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe PrimValue
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-952"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Rearrange"><span class="hs-identifier hs-type">Rearrange</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-953"></span><span>  </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-954"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Rotate"><span class="hs-identifier hs-type">Rotate</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-955"></span><span>  </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-956"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Reshape"><span class="hs-identifier hs-type">Reshape</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-957"></span><span>  </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-958"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#UpdateAcc"><span class="hs-identifier hs-type">UpdateAcc</span></a></span><span> </span><span id="local-6989586621684527302"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527302"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684527301"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527301"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621684527300"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527300"><span class="hs-identifier hs-var">vs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op. [Char] -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;UpdateAcc&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-959"></span><span>  </span><span class="hs-comment">-- We are abusing the comment mechanism to wrap the operator in</span><span>
</span><span id="line-960"></span><span>  </span><span class="hs-comment">-- braces when we end up generating code.  This is necessary because</span><span>
</span><span id="line-961"></span><span>  </span><span class="hs-comment">-- we might otherwise end up declaring lambda parameters (if any)</span><span>
</span><span id="line-962"></span><span>  </span><span class="hs-comment">-- multiple times, as they are duplicated every time we do an</span><span>
</span><span id="line-963"></span><span>  </span><span class="hs-comment">-- UpdateAcc for the same accumulator.</span><span>
</span><span id="line-964"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684527299"><span class="annot"><span class="annottext">is' :: [TExp Int64]
</span><a href="#local-6989586621684527299"><span class="hs-identifier hs-var hs-var">is'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527301"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-965"></span><span>
</span><span id="line-966"></span><span>  </span><span class="hs-comment">-- We need to figure out whether we are updating a scatter-like</span><span>
</span><span id="line-967"></span><span>  </span><span class="hs-comment">-- accumulator or a generalised reduction.  This also binds the</span><span>
</span><span id="line-968"></span><span>  </span><span class="hs-comment">-- index parameters.</span><span>
</span><span id="line-969"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527298"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527298"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527297"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684527297"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527296"><span class="annot"><span class="annottext">Maybe (Lambda rep)
</span><a href="#local-6989586621684527296"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; ImpM
     rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep))
forall rep r op.
VName
-&gt; [TExp Int64]
-&gt; ImpM
     rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep))
</span><a href="Futhark.CodeGen.ImpGen.html#lookupAcc"><span class="hs-identifier hs-var">lookupAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527302"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684527299"><span class="hs-identifier hs-var">is'</span></a></span><span>
</span><span id="line-970"></span><span>
</span><span id="line-971"></span><span>  </span><span class="annot"><span class="annottext">TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [TExp Int64] -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.html#inBounds"><span class="hs-identifier hs-var">inBounds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; [TExp Int64] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684527299"><span class="hs-identifier hs-var">is'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684527297"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-972"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Lambda rep)
</span><a href="#local-6989586621684527296"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-973"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Lambda rep)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-974"></span><span>        </span><span class="hs-comment">-- Scatter-like.</span><span>
</span><span id="line-975"></span><span>        </span><span class="annot"><span class="annottext">[(VName, SubExp)]
-&gt; ((VName, SubExp) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527298"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527300"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExp) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ())
-&gt; ((VName, SubExp) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684527294"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527294"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527293"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527293"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527294"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684527299"><span class="hs-identifier hs-var">is'</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527293"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-976"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684527292"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684527292"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-977"></span><span>        </span><span class="hs-comment">-- Generalised reduction.</span><span>
</span><span id="line-978"></span><span>        </span><span class="annot"><span class="annottext">[LParam rep] -&gt; ImpM rep r op ()
forall rep inner r op.
Mem rep inner =&gt;
[LParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-var">dLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([LParam rep] -&gt; ImpM rep r op ())
-&gt; [LParam rep] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [LParam rep]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684527292"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-979"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684527291"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527291"><span class="hs-identifier hs-var">x_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527290"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527290"><span class="hs-identifier hs-var">y_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-980"></span><span>              </span><span class="annot"><span class="annottext">Int -&gt; [VName] -&gt; ([VName], [VName])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527300"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; ([VName], [VName])) -&gt; [VName] -&gt; ([VName], [VName])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param LParamMem -&gt; VName) -&gt; [Param LParamMem] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; [VName]) -&gt; [Param LParamMem] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [LParam rep]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684527292"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-981"></span><span>
</span><span id="line-982"></span><span>        </span><span class="annot"><span class="annottext">[(VName, VName)]
-&gt; ((VName, VName) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [(VName, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527291"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527298"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, VName) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ())
-&gt; ((VName, VName) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684527289"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527289"><span class="hs-identifier hs-var">xp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527288"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527288"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-983"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527289"><span class="hs-identifier hs-var">xp</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527288"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684527299"><span class="hs-identifier hs-var">is'</span></a></span><span>
</span><span id="line-984"></span><span>
</span><span id="line-985"></span><span>        </span><span class="annot"><span class="annottext">[(VName, SubExp)]
-&gt; ((VName, SubExp) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527290"><span class="hs-identifier hs-var">y_params</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684527300"><span class="hs-identifier hs-var">vs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExp) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ())
-&gt; ((VName, SubExp) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684527287"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527287"><span class="hs-identifier hs-var">yp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684527286"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527286"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-986"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527287"><span class="hs-identifier hs-var">yp</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527286"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-987"></span><span>
</span><span id="line-988"></span><span>        </span><span class="annot"><span class="annottext">Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT rep -&gt; Stms rep
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT rep -&gt; Stms rep) -&gt; BodyT rep -&gt; Stms rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684527292"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-989"></span><span>          </span><span class="annot"><span class="annottext">[(VName, SubExpRes)]
-&gt; ((VName, SubExpRes) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Result -&gt; [(VName, SubExpRes)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684527298"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT rep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep -&gt; BodyT rep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684527292"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExpRes) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ())
-&gt; ((VName, SubExpRes) -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684527285"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527285"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684527284"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527284"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-990"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527285"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684527299"><span class="hs-identifier hs-var">is'</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684527284"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-991"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defCompileBasicOp"><span class="hs-identifier hs-var">defCompileBasicOp</span></a></span><span> </span><span id="local-6989586621684527283"><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><a href="#local-6989586621684527283"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684527282"><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684527282"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-992"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op ()) -&gt; [Char] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-993"></span><span>    </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;ImpGen.defCompileBasicOp: Invalid pattern\n  &quot;</span></span><span>
</span><span id="line-994"></span><span>      </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep) -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><a href="#local-6989586621684527283"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-995"></span><span>      </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;\nfor expression\n  &quot;</span></span><span>
</span><span id="line-996"></span><span>      </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684527282"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-997"></span><span>
</span><span id="line-998"></span><span class="hs-comment">-- | Note: a hack to be used only for functions.</span><span>
</span><span id="line-999"></span><span id="local-6989586621684530087"><span id="local-6989586621684530088"><span id="local-6989586621684530089"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#addArrays"><span class="hs-identifier hs-type">addArrays</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDecl"><span class="hs-identifier hs-type">ArrayDecl</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530089"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530088"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530087"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1000"></span><span id="addArrays"><span class="annot"><span class="annottext">addArrays :: forall rep r op. [ArrayDecl] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addArrays"><span class="hs-identifier hs-var hs-var">addArrays</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ArrayDecl -&gt; ImpM rep r op ()) -&gt; [ArrayDecl] -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">ArrayDecl -&gt; ImpM rep r op ()
forall {rep} {r} {op}. ArrayDecl -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684527279"><span class="hs-identifier hs-var">addArray</span></a></span><span>
</span><span id="line-1001"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1002"></span><span>    </span><span id="local-6989586621684527279"><span class="annot"><span class="annottext">addArray :: ArrayDecl -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684527279"><span class="hs-identifier hs-var hs-var">addArray</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDecl"><span class="hs-identifier hs-type">ArrayDecl</span></a></span><span> </span><span id="local-6989586621684527278"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527278"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684527277"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527277"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span id="local-6989586621684527276"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684527276"><span class="hs-identifier hs-var">location</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1003"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addVar"><span class="hs-identifier hs-var">addVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527278"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(VarEntry rep -&gt; ImpM rep r op ())
-&gt; VarEntry rep -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1004"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; ArrayEntry -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; ArrayEntry -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#ArrayVar"><span class="hs-identifier hs-var">ArrayVar</span></a></span><span>
</span><span id="line-1005"></span><span>          </span><span class="annot"><span class="annottext">Maybe (Exp rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1006"></span><span>          </span><span class="annot"><span class="annottext">ArrayEntry :: MemLoc -&gt; PrimType -&gt; ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#ArrayEntry"><span class="hs-identifier hs-type">ArrayEntry</span></a></span><span>
</span><span id="line-1007"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">entryArrayLoc :: MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var">entryArrayLoc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684527276"><span class="hs-identifier hs-var">location</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1008"></span><span>              </span><span class="annot"><span class="annottext">entryArrayElemType :: PrimType
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayElemType"><span class="hs-identifier hs-var">entryArrayElemType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527277"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1009"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-1010"></span><span>
</span><span id="line-1011"></span><span class="hs-comment">-- | Like 'dFParams', but does not create new declarations.</span><span>
</span><span id="line-1012"></span><span class="hs-comment">-- Note: a hack to be used only for functions.</span><span>
</span><span id="line-1013"></span><span id="local-6989586621684530090"><span id="local-6989586621684530091"><span id="local-6989586621684530092"><span id="local-6989586621684530093"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#addFParams"><span class="hs-identifier hs-type">addFParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530093"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530092"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530093"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530093"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530091"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530090"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1014"></span><span id="addFParams"><span class="annot"><span class="annottext">addFParams :: forall rep inner r op.
Mem rep inner =&gt;
[FParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addFParams"><span class="hs-identifier hs-var hs-var">addFParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param FParamMem -&gt; ImpM rep r op ())
-&gt; [Param FParamMem] -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; ImpM rep r op ()
forall {u} {rep} {r} {op}.
Param (MemInfo SubExp u MemBind) -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684527268"><span class="hs-identifier hs-var">addFParam</span></a></span><span>
</span><span id="line-1015"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1016"></span><span>    </span><span id="local-6989586621684527268"><span class="annot"><span class="annottext">addFParam :: Param (MemInfo SubExp u MemBind) -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684527268"><span class="hs-identifier hs-var hs-var">addFParam</span></a></span></span><span> </span><span id="local-6989586621684527267"><span class="annot"><span class="annottext">Param (MemInfo SubExp u MemBind)
</span><a href="#local-6989586621684527267"><span class="hs-identifier hs-var">fparam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1017"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addVar"><span class="hs-identifier hs-var">addVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (MemInfo SubExp u MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp u MemBind)
</span><a href="#local-6989586621684527267"><span class="hs-identifier hs-var">fparam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VarEntry rep -&gt; ImpM rep r op ())
-&gt; VarEntry rep -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1018"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; LParamMem -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; LParamMem -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#memBoundToVarEntry"><span class="hs-identifier hs-var">memBoundToVarEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; VarEntry rep) -&gt; LParamMem -&gt; VarEntry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MemInfo SubExp u MemBind -&gt; LParamMem
forall d u r. MemInfo d u r -&gt; MemInfo d NoUniqueness r
</span><a href="Futhark.IR.Mem.html#noUniquenessReturns"><span class="hs-identifier hs-var">noUniquenessReturns</span></a></span><span> </span><span class="annot"><span class="annottext">(MemInfo SubExp u MemBind -&gt; LParamMem)
-&gt; MemInfo SubExp u MemBind -&gt; LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp u MemBind) -&gt; MemInfo SubExp u MemBind
forall dec. Param dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var hs-var">paramDec</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp u MemBind)
</span><a href="#local-6989586621684527267"><span class="hs-identifier hs-var">fparam</span></a></span><span>
</span><span id="line-1019"></span><span>
</span><span id="line-1020"></span><span class="hs-comment">-- | Another hack.</span><span>
</span><span id="line-1021"></span><span id="local-6989586621684529803"><span id="local-6989586621684529804"><span id="local-6989586621684529805"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#addLoopVar"><span class="hs-identifier hs-type">addLoopVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-type">IntType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529805"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529804"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529803"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1022"></span><span id="addLoopVar"><span class="annot"><span class="annottext">addLoopVar :: forall rep r op. VName -&gt; IntType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addLoopVar"><span class="hs-identifier hs-var hs-var">addLoopVar</span></a></span></span><span> </span><span id="local-6989586621684527264"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527264"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684527263"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684527263"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addVar"><span class="hs-identifier hs-var">addVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527264"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">(VarEntry rep -&gt; ImpM rep r op ())
-&gt; VarEntry rep -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; ScalarEntry -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; ScalarEntry -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-var">ScalarVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(ScalarEntry -&gt; VarEntry rep) -&gt; ScalarEntry -&gt; VarEntry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarEntry
</span><a href="Futhark.CodeGen.ImpGen.html#ScalarEntry"><span class="hs-identifier hs-var">ScalarEntry</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ScalarEntry) -&gt; PrimType -&gt; ScalarEntry
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684527263"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-1023"></span><span>
</span><span id="line-1024"></span><span id="local-6989586621684530009"><span id="local-6989586621684530010"><span id="local-6989586621684530011"><span id="local-6989586621684530012"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dVars"><span class="hs-identifier hs-type">dVars</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1025"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530012"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530011"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1026"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530012"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1027"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#PatElem"><span class="hs-identifier hs-type">PatElem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530012"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1028"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530012"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530010"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530009"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1029"></span><span id="dVars"><span class="annot"><span class="annottext">dVars :: forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; [PatElem rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dVars"><span class="hs-identifier hs-var hs-var">dVars</span></a></span></span><span> </span><span id="local-6989586621684527223"><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684527223"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PatElemT (LetDec rep) -&gt; ImpM rep r op ())
-&gt; [PatElemT (LetDec rep)] -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684527222"><span class="hs-identifier hs-var">dVar</span></a></span><span>
</span><span id="line-1030"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1031"></span><span>    </span><span id="local-6989586621684527222"><span class="annot"><span class="annottext">dVar :: PatElemT (LetDec rep) -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684527222"><span class="hs-identifier hs-var hs-var">dVar</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dScope"><span class="hs-identifier hs-var">dScope</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684527223"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope rep -&gt; ImpM rep r op ())
-&gt; (PatElemT (LetDec rep) -&gt; Scope rep)
-&gt; PatElemT (LetDec rep)
-&gt; ImpM rep r op ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; Scope rep
forall rep dec. (LetDec rep ~ dec) =&gt; PatElemT dec -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfPatElem"><span class="hs-identifier hs-var">scopeOfPatElem</span></a></span><span>
</span><span id="line-1032"></span><span>
</span><span id="line-1033"></span><span id="local-6989586621684527217"><span id="local-6989586621684527218"><span id="local-6989586621684527219"><span id="local-6989586621684527220"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dFParams"><span class="hs-identifier hs-type">dFParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684527220"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684527219"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684527220"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684527220"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684527218"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684527217"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1034"></span><span id="dFParams"><span class="annot"><span class="annottext">dFParams :: forall rep inner r op.
Mem rep inner =&gt;
[FParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dFParams"><span class="hs-identifier hs-var hs-var">dFParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dScope"><span class="hs-identifier hs-var">dScope</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(Scope rep -&gt; ImpM rep r op ())
-&gt; ([Param FParamMem] -&gt; Scope rep)
-&gt; [Param FParamMem]
-&gt; ImpM rep r op ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; Scope rep
forall rep dec. (FParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfFParams"><span class="hs-identifier hs-var">scopeOfFParams</span></a></span><span>
</span><span id="line-1035"></span><span>
</span><span id="line-1036"></span><span id="local-6989586621684529941"><span id="local-6989586621684529942"><span id="local-6989586621684529943"><span id="local-6989586621684529944"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-type">dLParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529944"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529943"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529944"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529944"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529942"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529941"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1037"></span><span id="dLParams"><span class="annot"><span class="annottext">dLParams :: forall rep inner r op.
Mem rep inner =&gt;
[LParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-var hs-var">dLParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dScope"><span class="hs-identifier hs-var">dScope</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(Scope rep -&gt; ImpM rep r op ())
-&gt; ([Param LParamMem] -&gt; Scope rep)
-&gt; [Param LParamMem]
-&gt; ImpM rep r op ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; Scope rep
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span>
</span><span id="line-1038"></span><span>
</span><span id="line-1039"></span><span id="local-6989586621684529774"><span id="local-6989586621684529775"><span id="local-6989586621684529776"><span id="local-6989586621684529777"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dPrimVol"><span class="hs-identifier hs-type">dPrimVol</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529777"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529776"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529775"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529774"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529777"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1040"></span><span id="dPrimVol"><span class="annot"><span class="annottext">dPrimVol :: forall t rep r op.
[Char] -&gt; PrimType -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVol"><span class="hs-identifier hs-var hs-var">dPrimVol</span></a></span></span><span> </span><span id="local-6989586621684527136"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527136"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684527135"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527135"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684527134"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684527134"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1041"></span><span>  </span><span id="local-6989586621684527133"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527133"><span class="hs-identifier hs-var">name'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527136"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1042"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Volatility -&gt; PrimType -&gt; Code op
forall a. VName -&gt; Volatility -&gt; PrimType -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DeclareScalar"><span class="hs-identifier hs-var">Imp.DeclareScalar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527133"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="Futhark.CodeGen.ImpCode.html#Volatile"><span class="hs-identifier hs-var">Imp.Volatile</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527135"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1043"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addVar"><span class="hs-identifier hs-var">addVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527133"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">(VarEntry rep -&gt; ImpM rep r op ())
-&gt; VarEntry rep -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; ScalarEntry -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; ScalarEntry -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-var">ScalarVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(ScalarEntry -&gt; VarEntry rep) -&gt; ScalarEntry -&gt; VarEntry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarEntry
</span><a href="Futhark.CodeGen.ImpGen.html#ScalarEntry"><span class="hs-identifier hs-var">ScalarEntry</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527135"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1044"></span><span>  </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527133"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator hs-var">&lt;~~</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684527134"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1045"></span><span>  </span><span class="annot"><span class="annottext">TV t -&gt; ImpM rep r op (TV t)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(TV t -&gt; ImpM rep r op (TV t)) -&gt; TV t -&gt; ImpM rep r op (TV t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; TV t
forall t. VName -&gt; PrimType -&gt; TV t
</span><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-var">TV</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527133"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527135"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1046"></span><span>
</span><span id="line-1047"></span><span id="local-6989586621684529766"><span id="local-6989586621684529767"><span id="local-6989586621684529768"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-type">dPrim_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529768"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529767"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529766"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1048"></span><span id="dPrim_"><span class="annot"><span class="annottext">dPrim_ :: forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var hs-var">dPrim_</span></a></span></span><span> </span><span id="local-6989586621684527129"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527129"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684527128"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527128"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1049"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Volatility -&gt; PrimType -&gt; Code op
forall a. VName -&gt; Volatility -&gt; PrimType -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DeclareScalar"><span class="hs-identifier hs-var">Imp.DeclareScalar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527129"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="Futhark.CodeGen.ImpCode.html#Nonvolatile"><span class="hs-identifier hs-var">Imp.Nonvolatile</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527128"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1050"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addVar"><span class="hs-identifier hs-var">addVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527129"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(VarEntry rep -&gt; ImpM rep r op ())
-&gt; VarEntry rep -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; ScalarEntry -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; ScalarEntry -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-var">ScalarVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(ScalarEntry -&gt; VarEntry rep) -&gt; ScalarEntry -&gt; VarEntry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarEntry
</span><a href="Futhark.CodeGen.ImpGen.html#ScalarEntry"><span class="hs-identifier hs-var">ScalarEntry</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527128"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1051"></span><span>
</span><span id="line-1052"></span><span class="hs-comment">-- | The return type is polymorphic, so there is no guarantee it</span><span>
</span><span id="line-1053"></span><span class="hs-comment">-- actually matches the 'PrimType', but at least we have to use it</span><span>
</span><span id="line-1054"></span><span class="hs-comment">-- consistently.</span><span>
</span><span id="line-1055"></span><span id="local-6989586621684529901"><span id="local-6989586621684529902"><span id="local-6989586621684529903"><span id="local-6989586621684529904"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-type">dPrim</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529904"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529903"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529902"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529901"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1056"></span><span id="dPrim"><span class="annot"><span class="annottext">dPrim :: forall rep r op t. [Char] -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var hs-var">dPrim</span></a></span></span><span> </span><span id="local-6989586621684527123"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527123"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684527122"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527122"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1057"></span><span>  </span><span id="local-6989586621684527121"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527121"><span class="hs-identifier hs-var">name'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527123"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1058"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527121"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527122"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1059"></span><span>  </span><span class="annot"><span class="annottext">TV t -&gt; ImpM rep r op (TV t)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(TV t -&gt; ImpM rep r op (TV t)) -&gt; TV t -&gt; ImpM rep r op (TV t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; TV t
forall t. VName -&gt; PrimType -&gt; TV t
</span><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-var">TV</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527121"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527122"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1060"></span><span>
</span><span id="line-1061"></span><span id="local-6989586621684529755"><span id="local-6989586621684529756"><span id="local-6989586621684529757"><span id="local-6989586621684529758"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-type">dPrimV_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529758"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529757"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529756"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529755"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1062"></span><span id="dPrimV_"><span class="annot"><span class="annottext">dPrimV_ :: forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var hs-var">dPrimV_</span></a></span></span><span> </span><span id="local-6989586621684527119"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527119"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684527118"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684527118"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1063"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527119"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527117"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1064"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; TV t
forall t. VName -&gt; PrimType -&gt; TV t
</span><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-var">TV</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527119"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527117"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">TV t -&gt; TExp t -&gt; ImpM rep r op ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684527118"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1065"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1066"></span><span>    </span><span id="local-6989586621684527117"><span class="annot"><span class="annottext">t :: PrimType
</span><a href="#local-6989586621684527117"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimType
forall v. PrimExp v -&gt; PrimType
</span><a href="Futhark.Analysis.PrimExp.html#primExpType"><span class="hs-identifier hs-var">primExpType</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; PrimType) -&gt; PrimExp VName -&gt; PrimType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684527118"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1067"></span><span>
</span><span id="line-1068"></span><span id="local-6989586621684529845"><span id="local-6989586621684529846"><span id="local-6989586621684529847"><span id="local-6989586621684529848"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-type">dPrimV</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529848"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529847"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529846"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529845"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529848"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1069"></span><span id="dPrimV"><span class="annot"><span class="annottext">dPrimV :: forall t rep r op. [Char] -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var hs-var">dPrimV</span></a></span></span><span> </span><span id="local-6989586621684527112"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527112"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684527111"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684527111"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1070"></span><span>  </span><span id="local-6989586621684527110"><span class="annot"><span class="annottext">TV t
</span><a href="#local-6989586621684527110"><span class="hs-identifier hs-var">name'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; PrimType -&gt; ImpM rep r op (TV t)
forall rep r op t. [Char] -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527112"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ImpM rep r op (TV t))
-&gt; PrimType -&gt; ImpM rep r op (TV t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimType
forall v. PrimExp v -&gt; PrimType
</span><a href="Futhark.Analysis.PrimExp.html#primExpType"><span class="hs-identifier hs-var">primExpType</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; PrimType) -&gt; PrimExp VName -&gt; PrimType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684527111"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1071"></span><span>  </span><span class="annot"><span class="annottext">TV t
</span><a href="#local-6989586621684527110"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">TV t -&gt; TExp t -&gt; ImpM rep r op ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684527111"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1072"></span><span>  </span><span class="annot"><span class="annottext">TV t -&gt; ImpM rep r op (TV t)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">TV t
</span><a href="#local-6989586621684527110"><span class="hs-identifier hs-var">name'</span></a></span><span>
</span><span id="line-1073"></span><span>
</span><span id="line-1074"></span><span id="local-6989586621684529742"><span id="local-6989586621684529743"><span id="local-6989586621684529744"><span id="local-6989586621684529745"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-type">dPrimVE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529745"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529744"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529743"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529742"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529745"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1075"></span><span id="dPrimVE"><span class="annot"><span class="annottext">dPrimVE :: forall t rep r op. [Char] -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var hs-var">dPrimVE</span></a></span></span><span> </span><span id="local-6989586621684527106"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527106"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684527105"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684527105"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1076"></span><span>  </span><span id="local-6989586621684527104"><span class="annot"><span class="annottext">TV t
</span><a href="#local-6989586621684527104"><span class="hs-identifier hs-var">name'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; PrimType -&gt; ImpM rep r op (TV t)
forall rep r op t. [Char] -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684527106"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ImpM rep r op (TV t))
-&gt; PrimType -&gt; ImpM rep r op (TV t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimType
forall v. PrimExp v -&gt; PrimType
</span><a href="Futhark.Analysis.PrimExp.html#primExpType"><span class="hs-identifier hs-var">primExpType</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; PrimType) -&gt; PrimExp VName -&gt; PrimType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684527105"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1077"></span><span>  </span><span class="annot"><span class="annottext">TV t
</span><a href="#local-6989586621684527104"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">TV t -&gt; TExp t -&gt; ImpM rep r op ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684527105"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1078"></span><span>  </span><span class="annot"><span class="annottext">TExp t -&gt; ImpM rep r op (TExp t)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(TExp t -&gt; ImpM rep r op (TExp t))
-&gt; TExp t -&gt; ImpM rep r op (TExp t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV t -&gt; TExp t
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV t
</span><a href="#local-6989586621684527104"><span class="hs-identifier hs-var">name'</span></a></span><span>
</span><span id="line-1079"></span><span>
</span><span id="line-1080"></span><span id="local-6989586621684530271"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#memBoundToVarEntry"><span class="hs-identifier hs-type">memBoundToVarEntry</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1081"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530271"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1082"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#MemBound"><span class="hs-identifier hs-type">MemBound</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-type">NoUniqueness</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1083"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VarEntry"><span class="hs-identifier hs-type">VarEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530271"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-1084"></span><span id="memBoundToVarEntry"><span class="annot"><span class="annottext">memBoundToVarEntry :: forall rep. Maybe (Exp rep) -&gt; LParamMem -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#memBoundToVarEntry"><span class="hs-identifier hs-var hs-var">memBoundToVarEntry</span></a></span></span><span> </span><span id="local-6989586621684527102"><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684527102"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-type">MemPrim</span></a></span><span> </span><span id="local-6989586621684527101"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527101"><span class="hs-identifier hs-var">bt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1085"></span><span>  </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; ScalarEntry -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; ScalarEntry -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-var">ScalarVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684527102"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarEntry :: PrimType -&gt; ScalarEntry
</span><a href="Futhark.CodeGen.ImpGen.html#ScalarEntry"><span class="hs-identifier hs-type">ScalarEntry</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">entryScalarType :: PrimType
</span><a href="Futhark.CodeGen.ImpGen.html#entryScalarType"><span class="hs-identifier hs-var">entryScalarType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527101"><span class="hs-identifier hs-var">bt</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1086"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#memBoundToVarEntry"><span class="hs-identifier hs-var">memBoundToVarEntry</span></a></span><span> </span><span id="local-6989586621684527100"><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684527100"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-type">MemMem</span></a></span><span> </span><span id="local-6989586621684527099"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684527099"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1087"></span><span>  </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; MemEntry -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; MemEntry -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-var">MemVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684527100"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">(MemEntry -&gt; VarEntry rep) -&gt; MemEntry -&gt; VarEntry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#MemEntry"><span class="hs-identifier hs-var">MemEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684527099"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1088"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#memBoundToVarEntry"><span class="hs-identifier hs-var">memBoundToVarEntry</span></a></span><span> </span><span id="local-6989586621684527098"><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684527098"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-type">MemAcc</span></a></span><span> </span><span id="local-6989586621684527097"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527097"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684527096"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684527096"><span class="hs-identifier hs-var">ispace</span></a></span></span><span> </span><span id="local-6989586621684527095"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684527095"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1089"></span><span>  </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; (VName, Shape, [Type]) -&gt; VarEntry rep
forall rep.
Maybe (Exp rep) -&gt; (VName, Shape, [Type]) -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#AccVar"><span class="hs-identifier hs-var">AccVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684527098"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527097"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684527096"><span class="hs-identifier hs-var">ispace</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684527095"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1090"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#memBoundToVarEntry"><span class="hs-identifier hs-var">memBoundToVarEntry</span></a></span><span> </span><span id="local-6989586621684527094"><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684527094"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684527093"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527093"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span id="local-6989586621684527092"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684527092"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684527091"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527091"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684527090"><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684527090"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1091"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684527089"><span class="annot"><span class="annottext">location :: MemLoc
</span><a href="#local-6989586621684527089"><span class="hs-identifier hs-var hs-var">location</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [SubExp] -&gt; IxFun (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-var">MemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527091"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684527092"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684527090"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-1092"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; ArrayEntry -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; ArrayEntry -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#ArrayVar"><span class="hs-identifier hs-var">ArrayVar</span></a></span><span>
</span><span id="line-1093"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684527094"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1094"></span><span>        </span><span class="annot"><span class="annottext">ArrayEntry :: MemLoc -&gt; PrimType -&gt; ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#ArrayEntry"><span class="hs-identifier hs-type">ArrayEntry</span></a></span><span>
</span><span id="line-1095"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">entryArrayLoc :: MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var">entryArrayLoc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684527089"><span class="hs-identifier hs-var">location</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1096"></span><span>            </span><span class="annot"><span class="annottext">entryArrayElemType :: PrimType
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayElemType"><span class="hs-identifier hs-var">entryArrayElemType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684527093"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1097"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-1098"></span><span>
</span><span id="line-1099"></span><span id="local-6989586621684529735"><span id="local-6989586621684529736"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#infoDec"><span class="hs-identifier hs-type">infoDec</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1100"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529736"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529735"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1101"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#NameInfo"><span class="hs-identifier hs-type">NameInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529736"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1102"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#MemInfo"><span class="hs-identifier hs-type">MemInfo</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-type">NoUniqueness</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemBind"><span class="hs-identifier hs-type">MemBind</span></a></span></span></span><span>
</span><span id="line-1103"></span><span id="infoDec"><span class="annot"><span class="annottext">infoDec :: forall rep inner. Mem rep inner =&gt; NameInfo rep -&gt; LParamMem
</span><a href="Futhark.CodeGen.ImpGen.html#infoDec"><span class="hs-identifier hs-var hs-var">infoDec</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LetName"><span class="hs-identifier hs-type">LetName</span></a></span><span> </span><span id="local-6989586621684527074"><span class="annot"><span class="annottext">LetDec rep
</span><a href="#local-6989586621684527074"><span class="hs-identifier hs-var">dec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LetDec rep -&gt; LParamMem
forall t. HasLetDecMem t =&gt; t -&gt; LParamMem
</span><a href="Futhark.IR.Mem.html#letDecMem"><span class="hs-identifier hs-var">letDecMem</span></a></span><span> </span><span class="annot"><span class="annottext">LetDec rep
</span><a href="#local-6989586621684527074"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-1104"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#infoDec"><span class="hs-identifier hs-var">infoDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#FParamName"><span class="hs-identifier hs-type">FParamName</span></a></span><span> </span><span id="local-6989586621684527072"><span class="annot"><span class="annottext">FParamInfo rep
</span><a href="#local-6989586621684527072"><span class="hs-identifier hs-var">dec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FParamMem -&gt; LParamMem
forall d u r. MemInfo d u r -&gt; MemInfo d NoUniqueness r
</span><a href="Futhark.IR.Mem.html#noUniquenessReturns"><span class="hs-identifier hs-var">noUniquenessReturns</span></a></span><span> </span><span class="annot"><span class="annottext">FParamInfo rep
FParamMem
</span><a href="#local-6989586621684527072"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-1105"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#infoDec"><span class="hs-identifier hs-var">infoDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LParamName"><span class="hs-identifier hs-type">LParamName</span></a></span><span> </span><span id="local-6989586621684527070"><span class="annot"><span class="annottext">LParamInfo rep
</span><a href="#local-6989586621684527070"><span class="hs-identifier hs-var">dec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LParamInfo rep
LParamMem
</span><a href="#local-6989586621684527070"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-1106"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#infoDec"><span class="hs-identifier hs-var">infoDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#IndexName"><span class="hs-identifier hs-type">IndexName</span></a></span><span> </span><span id="local-6989586621684527068"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684527068"><span class="hs-identifier hs-var">it</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; LParamMem
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; LParamMem) -&gt; PrimType -&gt; LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684527068"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-1107"></span><span>
</span><span id="line-1108"></span><span id="local-6989586621684529726"><span id="local-6989586621684529727"><span id="local-6989586621684529728"><span id="local-6989586621684529729"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dInfo"><span class="hs-identifier hs-type">dInfo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1109"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529729"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529728"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1110"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529729"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1111"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1112"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#NameInfo"><span class="hs-identifier hs-type">NameInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529729"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1113"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529729"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529727"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529726"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1114"></span><span id="dInfo"><span class="annot"><span class="annottext">dInfo :: forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; VName -&gt; NameInfo rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dInfo"><span class="hs-identifier hs-var hs-var">dInfo</span></a></span></span><span> </span><span id="local-6989586621684527029"><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684527029"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684527028"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527028"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684527027"><span class="annot"><span class="annottext">NameInfo rep
</span><a href="#local-6989586621684527027"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1115"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684527026"><span class="annot"><span class="annottext">entry :: VarEntry rep
</span><a href="#local-6989586621684527026"><span class="hs-identifier hs-var hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; LParamMem -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; LParamMem -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#memBoundToVarEntry"><span class="hs-identifier hs-var">memBoundToVarEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684527029"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; VarEntry rep) -&gt; LParamMem -&gt; VarEntry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NameInfo rep -&gt; LParamMem
forall rep inner. Mem rep inner =&gt; NameInfo rep -&gt; LParamMem
</span><a href="Futhark.CodeGen.ImpGen.html#infoDec"><span class="hs-identifier hs-var">infoDec</span></a></span><span> </span><span class="annot"><span class="annottext">NameInfo rep
</span><a href="#local-6989586621684527027"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-1116"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684527026"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1117"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-type">MemVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684527025"><span class="annot"><span class="annottext">MemEntry
</span><a href="#local-6989586621684527025"><span class="hs-identifier hs-var">entry'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1118"></span><span>      </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; Code op
forall a. VName -&gt; Space -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DeclareMem"><span class="hs-identifier hs-var">Imp.DeclareMem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527028"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(Space -&gt; Code op) -&gt; Space -&gt; Code op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">MemEntry
</span><a href="#local-6989586621684527025"><span class="hs-identifier hs-var">entry'</span></a></span><span>
</span><span id="line-1119"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-type">ScalarVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684527024"><span class="annot"><span class="annottext">ScalarEntry
</span><a href="#local-6989586621684527024"><span class="hs-identifier hs-var">entry'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1120"></span><span>      </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Volatility -&gt; PrimType -&gt; Code op
forall a. VName -&gt; Volatility -&gt; PrimType -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DeclareScalar"><span class="hs-identifier hs-var">Imp.DeclareScalar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527028"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="Futhark.CodeGen.ImpCode.html#Nonvolatile"><span class="hs-identifier hs-var">Imp.Nonvolatile</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; Code op) -&gt; PrimType -&gt; Code op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarEntry -&gt; PrimType
</span><a href="Futhark.CodeGen.ImpGen.html#entryScalarType"><span class="hs-identifier hs-var hs-var">entryScalarType</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarEntry
</span><a href="#local-6989586621684527024"><span class="hs-identifier hs-var">entry'</span></a></span><span>
</span><span id="line-1121"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayVar"><span class="hs-identifier hs-type">ArrayVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ArrayEntry
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1122"></span><span>      </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1123"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#AccVar"><span class="hs-identifier hs-type">AccVar</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1124"></span><span>      </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1125"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addVar"><span class="hs-identifier hs-var">addVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684527028"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684527026"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-1126"></span><span>
</span><span id="line-1127"></span><span id="local-6989586621684529792"><span id="local-6989586621684529793"><span id="local-6989586621684529794"><span id="local-6989586621684529795"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dScope"><span class="hs-identifier hs-type">dScope</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1128"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529795"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529794"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1129"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529795"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1130"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529795"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1131"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529795"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529793"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529792"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1132"></span><span id="dScope"><span class="annot"><span class="annottext">dScope :: forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dScope"><span class="hs-identifier hs-var hs-var">dScope</span></a></span></span><span> </span><span id="local-6989586621684526987"><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684526987"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VName, NameInfo rep) -&gt; ImpM rep r op ())
-&gt; [(VName, NameInfo rep)] -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; NameInfo rep -&gt; ImpM rep r op ())
-&gt; (VName, NameInfo rep) -&gt; ImpM rep r op ()
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">((VName -&gt; NameInfo rep -&gt; ImpM rep r op ())
 -&gt; (VName, NameInfo rep) -&gt; ImpM rep r op ())
-&gt; (VName -&gt; NameInfo rep -&gt; ImpM rep r op ())
-&gt; (VName, NameInfo rep)
-&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; VName -&gt; NameInfo rep -&gt; ImpM rep r op ()
forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; VName -&gt; NameInfo rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dInfo"><span class="hs-identifier hs-var">dInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><a href="#local-6989586621684526987"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(VName, NameInfo rep)] -&gt; ImpM rep r op ())
-&gt; (Map VName (NameInfo rep) -&gt; [(VName, NameInfo rep)])
-&gt; Map VName (NameInfo rep)
-&gt; ImpM rep r op ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map VName (NameInfo rep) -&gt; [(VName, NameInfo rep)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span>
</span><span id="line-1133"></span><span>
</span><span id="line-1134"></span><span id="local-6989586621684529715"><span id="local-6989586621684529716"><span id="local-6989586621684529717"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dArray"><span class="hs-identifier hs-type">dArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ShapeBase"><span class="hs-identifier hs-type">ShapeBase</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529717"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529716"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529715"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1135"></span><span id="dArray"><span class="annot"><span class="annottext">dArray :: forall rep r op.
VName
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun (TExp Int64)
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dArray"><span class="hs-identifier hs-var hs-var">dArray</span></a></span></span><span> </span><span id="local-6989586621684526985"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526985"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684526984"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526984"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684526983"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526983"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684526982"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526982"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684526981"><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526981"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1136"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addVar"><span class="hs-identifier hs-var">addVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526985"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(VarEntry rep -&gt; ImpM rep r op ())
-&gt; VarEntry rep -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; ArrayEntry -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; ArrayEntry -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#ArrayVar"><span class="hs-identifier hs-var">ArrayVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(ArrayEntry -&gt; VarEntry rep) -&gt; ArrayEntry -&gt; VarEntry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MemLoc -&gt; PrimType -&gt; ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#ArrayEntry"><span class="hs-identifier hs-var">ArrayEntry</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526980"><span class="hs-identifier hs-var">location</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526984"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-1137"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1138"></span><span>    </span><span id="local-6989586621684526980"><span class="annot"><span class="annottext">location :: MemLoc
</span><a href="#local-6989586621684526980"><span class="hs-identifier hs-var hs-var">location</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1139"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; [SubExp] -&gt; IxFun (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-var">MemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526982"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526983"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526981"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-1140"></span><span>
</span><span id="line-1141"></span><span id="local-6989586621684529708"><span id="local-6989586621684529709"><span id="local-6989586621684529710"><span id="local-6989586621684529711"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-type">everythingVolatile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529711"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529710"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529709"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529708"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529711"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529710"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529709"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529708"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-1142"></span><span id="everythingVolatile"><span class="annot"><span class="annottext">everythingVolatile :: forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#everythingVolatile"><span class="hs-identifier hs-var hs-var">everythingVolatile</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Env rep r op)
-&gt; ImpM rep r op a -&gt; ImpM rep r op a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((Env rep r op -&gt; Env rep r op)
 -&gt; ImpM rep r op a -&gt; ImpM rep r op a)
-&gt; (Env rep r op -&gt; Env rep r op)
-&gt; ImpM rep r op a
-&gt; ImpM rep r op a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684526978"><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684526978"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684526978"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">envVolatility :: Volatility
</span><a href="Futhark.CodeGen.ImpGen.html#envVolatility"><span class="hs-identifier hs-var">envVolatility</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="Futhark.CodeGen.ImpCode.html#Volatile"><span class="hs-identifier hs-var">Imp.Volatile</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1143"></span><span>
</span><span id="line-1144"></span><span class="hs-comment">-- | Remove the array targets.</span><span>
</span><span id="line-1145"></span><span id="local-6989586621684529971"><span id="local-6989586621684529972"><span id="local-6989586621684529973"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#funcallTargets"><span class="hs-identifier hs-type">funcallTargets</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ValueDestination"><span class="hs-identifier hs-type">ValueDestination</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529973"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529972"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529971"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-1146"></span><span id="funcallTargets"><span class="annot"><span class="annottext">funcallTargets :: forall rep r op. [ValueDestination] -&gt; ImpM rep r op [VName]
</span><a href="Futhark.CodeGen.ImpGen.html#funcallTargets"><span class="hs-identifier hs-var hs-var">funcallTargets</span></a></span></span><span> </span><span id="local-6989586621684526972"><span class="annot"><span class="annottext">[ValueDestination]
</span><a href="#local-6989586621684526972"><span class="hs-identifier hs-var">dests</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1147"></span><span>  </span><span class="annot"><span class="annottext">[[VName]] -&gt; [VName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[VName]] -&gt; [VName])
-&gt; ImpM rep r op [[VName]] -&gt; ImpM rep r op [VName]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(ValueDestination -&gt; ImpM rep r op [VName])
-&gt; [ValueDestination] -&gt; ImpM rep r op [[VName]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">ValueDestination -&gt; ImpM rep r op [VName]
forall {m :: * -&gt; *}. Monad m =&gt; ValueDestination -&gt; m [VName]
</span><a href="#local-6989586621684526970"><span class="hs-identifier hs-var">funcallTarget</span></a></span><span> </span><span class="annot"><span class="annottext">[ValueDestination]
</span><a href="#local-6989586621684526972"><span class="hs-identifier hs-var">dests</span></a></span><span>
</span><span id="line-1148"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1149"></span><span>    </span><span id="local-6989586621684526970"><span class="annot"><span class="annottext">funcallTarget :: ValueDestination -&gt; m [VName]
</span><a href="#local-6989586621684526970"><span class="hs-identifier hs-var hs-var">funcallTarget</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarDestination"><span class="hs-identifier hs-type">ScalarDestination</span></a></span><span> </span><span id="local-6989586621684526965"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526965"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1150"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; m [VName]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526965"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1151"></span><span>    </span><span class="annot"><a href="#local-6989586621684526970"><span class="hs-identifier hs-var">funcallTarget</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDestination"><span class="hs-identifier hs-type">ArrayDestination</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe MemLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1152"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; m [VName]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1153"></span><span>    </span><span class="annot"><a href="#local-6989586621684526970"><span class="hs-identifier hs-var">funcallTarget</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemoryDestination"><span class="hs-identifier hs-type">MemoryDestination</span></a></span><span> </span><span id="local-6989586621684526964"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526964"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1154"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; m [VName]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526964"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1155"></span><span>
</span><span id="line-1156"></span><span class="hs-comment">-- | A typed variable, which we can turn into a typed expression, or</span><span>
</span><span id="line-1157"></span><span class="hs-comment">-- use as the target for an assignment.  This is used to aid in type</span><span>
</span><span id="line-1158"></span><span class="hs-comment">-- safety when doing code generation, by keeping the types straight.</span><span>
</span><span id="line-1159"></span><span class="hs-comment">-- It is still easy to cheat when you need to.</span><span>
</span><span id="line-1160"></span><span class="hs-keyword">data</span><span> </span><span id="TV"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-var">TV</span></a></span></span><span> </span><span id="local-6989586621684529769"><span class="annot"><a href="#local-6989586621684529769"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TV"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-var">TV</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span>
</span><span id="line-1161"></span><span>
</span><span id="line-1162"></span><span class="hs-comment">-- | Create a typed variable from a name and a dynamic type.  Note</span><span>
</span><span id="line-1163"></span><span class="hs-comment">-- that there is no guarantee that the dynamic type corresponds to the</span><span>
</span><span id="line-1164"></span><span class="hs-comment">-- inferred static type, but the latter will at least have to be used</span><span>
</span><span id="line-1165"></span><span class="hs-comment">-- consistently.</span><span>
</span><span id="line-1166"></span><span id="local-6989586621684526963"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#mkTV"><span class="hs-identifier hs-type">mkTV</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526963"><span class="hs-identifier hs-type">t</span></a></span></span><span>
</span><span id="line-1167"></span><span id="mkTV"><span class="annot"><span class="annottext">mkTV :: forall t. VName -&gt; PrimType -&gt; TV t
</span><a href="Futhark.CodeGen.ImpGen.html#mkTV"><span class="hs-identifier hs-var hs-var">mkTV</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; TV t
forall t. VName -&gt; PrimType -&gt; TV t
</span><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-var">TV</span></a></span><span>
</span><span id="line-1168"></span><span>
</span><span id="line-1169"></span><span class="hs-comment">-- | Convert a typed variable to a size (a SubExp).</span><span>
</span><span id="line-1170"></span><span id="local-6989586621684529696"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-type">tvSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529696"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#DimSize"><span class="hs-identifier hs-type">Imp.DimSize</span></a></span></span><span>
</span><span id="line-1171"></span><span id="tvSize"><span class="annot"><span class="annottext">tvSize :: forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var hs-var">tvSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; (TV t -&gt; VName) -&gt; TV t -&gt; SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TV t -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span>
</span><span id="line-1172"></span><span>
</span><span id="line-1173"></span><span class="hs-comment">-- | Convert a typed variable to a similarly typed expression.</span><span>
</span><span id="line-1174"></span><span id="local-6989586621684529896"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-type">tvExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529896"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529896"><span class="hs-identifier hs-type">t</span></a></span></span><span>
</span><span id="line-1175"></span><span id="tvExp"><span class="annot"><span class="annottext">tvExp :: forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var hs-var">tvExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span id="local-6989586621684526962"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526962"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684526961"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526961"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; TPrimExp t VName
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">Imp.TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; TPrimExp t VName)
-&gt; PrimExp VName -&gt; TPrimExp t VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526962"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526961"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1176"></span><span>
</span><span id="line-1177"></span><span class="hs-comment">-- | Extract the underlying variable name from a typed variable.</span><span>
</span><span id="line-1178"></span><span id="local-6989586621684529897"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-type">tvVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529897"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span><span>
</span><span id="line-1179"></span><span id="tvVar"><span class="annot"><span class="annottext">tvVar :: forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var hs-var">tvVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span id="local-6989586621684526960"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526960"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526960"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1180"></span><span>
</span><span id="line-1181"></span><span class="hs-comment">-- | Compile things to 'Imp.Exp'.</span><span>
</span><span id="line-1182"></span><span class="hs-keyword">class</span><span> </span><span id="ToExp"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ToExp"><span class="hs-identifier hs-var">ToExp</span></a></span></span><span> </span><span id="local-6989586621684530036"><span class="annot"><a href="#local-6989586621684530036"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1183"></span><span>  </span><span class="hs-comment">-- | Compile to an 'Imp.Exp', where the type (must must still be a</span><span>
</span><span id="line-1184"></span><span>  </span><span class="hs-comment">-- primitive) is deduced monadically.</span><span>
</span><span id="line-1185"></span><span>  </span><span id="local-6989586621684529945"><span id="local-6989586621684529946"><span id="local-6989586621684529947"><span id="toExp"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-type">toExp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621684530036"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529947"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529946"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529945"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Exp"><span class="hs-identifier hs-type">Imp.Exp</span></a></span></span></span></span><span>
</span><span id="line-1186"></span><span>
</span><span id="line-1187"></span><span>  </span><span class="hs-comment">-- | Compile where we know the type in advance.</span><span>
</span><span id="line-1188"></span><span>  </span><span id="toExp%27"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#toExp%27"><span class="hs-identifier hs-type">toExp'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684530036"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Exp"><span class="hs-identifier hs-type">Imp.Exp</span></a></span><span>
</span><span id="line-1189"></span><span>
</span><span id="line-1190"></span><span>  </span><span id="toInt64Exp"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-type">toInt64Exp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621684530036"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span>
</span><span id="line-1191"></span><span>  </span><span id="local-6989586621684526957"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var hs-var">toInt64Exp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; TExp Int64
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; TExp Int64)
-&gt; (a -&gt; PrimExp VName) -&gt; a -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; a -&gt; PrimExp VName
forall a. ToExp a =&gt; PrimType -&gt; a -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpGen.html#toExp%27"><span class="hs-identifier hs-var">toExp'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span></span><span>
</span><span id="line-1192"></span><span>
</span><span id="line-1193"></span><span>  </span><span id="toBoolExp"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#toBoolExp"><span class="hs-identifier hs-type">toBoolExp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621684530036"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1194"></span><span>  </span><span id="local-6989586621684526954"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#toBoolExp"><span class="hs-identifier hs-var hs-var">toBoolExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; TExp Bool
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; TExp Bool)
-&gt; (a -&gt; PrimExp VName) -&gt; a -&gt; TExp Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; a -&gt; PrimExp VName
forall a. ToExp a =&gt; PrimType -&gt; a -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpGen.html#toExp%27"><span class="hs-identifier hs-var">toExp'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Primitive.html#Bool"><span class="hs-identifier hs-var">Bool</span></a></span></span><span>
</span><span id="line-1195"></span><span>
</span><span id="line-1196"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684526947"><span id="local-6989586621684526949"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ToExp"><span class="hs-identifier hs-type">ToExp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1197"></span><span>  </span><span id="local-6989586621684526938"><span class="annot"><span class="annottext">toExp :: forall rep r op. SubExp -&gt; ImpM rep r op (PrimExp VName)
</span><a href="#local-6989586621684526938"><span class="hs-identifier hs-var hs-var hs-var hs-var">toExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684526937"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684526937"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1198"></span><span>    </span><span class="annot"><span class="annottext">PrimExp VName -&gt; ImpM rep r op (PrimExp VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; ImpM rep r op (PrimExp VName))
-&gt; PrimExp VName -&gt; ImpM rep r op (PrimExp VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; PrimExp VName
forall v. PrimValue -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#ValueExp"><span class="hs-identifier hs-var">Imp.ValueExp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684526937"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1199"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684526935"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526935"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1200"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op (VarEntry rep)
forall rep r op. VName -&gt; ImpM rep r op (VarEntry rep)
</span><a href="Futhark.CodeGen.ImpGen.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526935"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM rep r op (VarEntry rep)
-&gt; (VarEntry rep -&gt; ImpM rep r op (PrimExp VName))
-&gt; ImpM rep r op (PrimExp VName)
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;=</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-1201"></span><span>      </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-type">ScalarVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarEntry"><span class="hs-identifier hs-type">ScalarEntry</span></a></span><span> </span><span id="local-6989586621684526934"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526934"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1202"></span><span>        </span><span class="annot"><span class="annottext">PrimExp VName -&gt; ImpM rep r op (PrimExp VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; ImpM rep r op (PrimExp VName))
-&gt; PrimExp VName -&gt; ImpM rep r op (PrimExp VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526935"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526934"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-1203"></span><span>      </span><span class="annot"><span class="annottext">VarEntry rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op (PrimExp VName)
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op (PrimExp VName))
-&gt; [Char] -&gt; ImpM rep r op (PrimExp VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;toExp SubExp: SubExp is not a primitive type: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526935"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1204"></span><span>
</span><span id="line-1205"></span><span>  </span><span id="local-6989586621684526933"><span class="annot"><span class="annottext">toExp' :: PrimType -&gt; SubExp -&gt; PrimExp VName
</span><a href="#local-6989586621684526933"><span class="hs-identifier hs-var hs-var hs-var hs-var">toExp'</span></a></span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684526932"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684526932"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; PrimExp VName
forall v. PrimValue -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#ValueExp"><span class="hs-identifier hs-var">Imp.ValueExp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684526932"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1206"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#toExp%27"><span class="hs-identifier hs-var">toExp'</span></a></span><span> </span><span id="local-6989586621684526931"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526931"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684526930"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526930"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526930"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526931"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1207"></span><span>
</span><span id="line-1208"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684526924"><span id="local-6989586621684526926"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ToExp"><span class="hs-identifier hs-type">ToExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#PrimExp"><span class="hs-identifier hs-type">PrimExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1209"></span><span>  </span><span id="local-6989586621684526922"><span class="annot"><span class="annottext">toExp :: forall rep r op. PrimExp VName -&gt; ImpM rep r op (PrimExp VName)
</span><a href="#local-6989586621684526922"><span class="hs-identifier hs-var hs-var hs-var hs-var">toExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; ImpM rep r op (PrimExp VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-1210"></span><span>  </span><span id="local-6989586621684526921"><span class="annot"><span class="annottext">toExp' :: PrimType -&gt; PrimExp VName -&gt; PrimExp VName
</span><a href="#local-6989586621684526921"><span class="hs-identifier hs-var hs-var hs-var hs-var">toExp'</span></a></span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimExp VName
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-1211"></span><span>
</span><span id="line-1212"></span><span id="local-6989586621684529827"><span id="local-6989586621684529828"><span id="local-6989586621684529829"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#addVar"><span class="hs-identifier hs-type">addVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VarEntry"><span class="hs-identifier hs-type">VarEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529829"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529829"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529828"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529827"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1213"></span><span id="addVar"><span class="annot"><span class="annottext">addVar :: forall rep r op. VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addVar"><span class="hs-identifier hs-var hs-var">addVar</span></a></span></span><span> </span><span id="local-6989586621684526918"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526918"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684526917"><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526917"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1214"></span><span>  </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ())
-&gt; (ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684526916"><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684526916"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684526916"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateVTable :: VTable rep
</span><a href="Futhark.CodeGen.ImpGen.html#stateVTable"><span class="hs-identifier hs-var">stateVTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; VarEntry rep -&gt; VTable rep -&gt; VTable rep
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526918"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526917"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">(VTable rep -&gt; VTable rep) -&gt; VTable rep -&gt; VTable rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; VTable rep
forall rep r op. ImpState rep r op -&gt; VTable rep
</span><a href="Futhark.CodeGen.ImpGen.html#stateVTable"><span class="hs-identifier hs-var hs-var">stateVTable</span></a></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684526916"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1215"></span><span>
</span><span id="line-1216"></span><span id="local-6989586621684529677"><span id="local-6989586621684529678"><span id="local-6989586621684529679"><span id="local-6989586621684529680"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#localDefaultSpace"><span class="hs-identifier hs-type">localDefaultSpace</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Imp.Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529680"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529679"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529678"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529677"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529680"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529679"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529678"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529677"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-1217"></span><span id="localDefaultSpace"><span class="annot"><span class="annottext">localDefaultSpace :: forall rep r op a. Space -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localDefaultSpace"><span class="hs-identifier hs-var hs-var">localDefaultSpace</span></a></span></span><span> </span><span id="local-6989586621684526914"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526914"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Env rep r op)
-&gt; ImpM rep r op a -&gt; ImpM rep r op a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684526913"><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684526913"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684526913"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">envDefaultSpace :: Space
</span><a href="Futhark.CodeGen.ImpGen.html#envDefaultSpace"><span class="hs-identifier hs-var">envDefaultSpace</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526914"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-1218"></span><span>
</span><span id="line-1219"></span><span id="local-6989586621684529670"><span id="local-6989586621684529671"><span id="local-6989586621684529672"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#askFunction"><span class="hs-identifier hs-type">askFunction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529672"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529671"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529670"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1220"></span><span id="askFunction"><span class="annot"><span class="annottext">askFunction :: forall rep r op. ImpM rep r op (Maybe Name)
</span><a href="Futhark.CodeGen.ImpGen.html#askFunction"><span class="hs-identifier hs-var hs-var">askFunction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Maybe Name) -&gt; ImpM rep r op (Maybe Name)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; Maybe Name
forall rep r op. Env rep r op -&gt; Maybe Name
</span><a href="Futhark.CodeGen.ImpGen.html#envFunction"><span class="hs-identifier hs-var hs-var">envFunction</span></a></span><span>
</span><span id="line-1221"></span><span>
</span><span id="line-1222"></span><span class="hs-comment">-- | Generate a 'VName', prefixed with 'askFunction' if it exists.</span><span>
</span><span id="line-1223"></span><span id="local-6989586621684529835"><span id="local-6989586621684529836"><span id="local-6989586621684529837"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#newVNameForFun"><span class="hs-identifier hs-type">newVNameForFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529837"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529836"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529835"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span></span></span><span>
</span><span id="line-1224"></span><span id="newVNameForFun"><span class="annot"><span class="annottext">newVNameForFun :: forall rep r op. [Char] -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#newVNameForFun"><span class="hs-identifier hs-var hs-var">newVNameForFun</span></a></span></span><span> </span><span id="local-6989586621684526905"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526905"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1225"></span><span>  </span><span id="local-6989586621684526904"><span class="annot"><span class="annottext">Maybe [Char]
</span><a href="#local-6989586621684526904"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; [Char]) -&gt; Maybe Name -&gt; Maybe [Char]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [Char]
</span><a href="Language.Futhark.Core.html#nameToString"><span class="hs-identifier hs-var">nameToString</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Name -&gt; Maybe [Char])
-&gt; ImpM rep r op (Maybe Name) -&gt; ImpM rep r op (Maybe [Char])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM rep r op (Maybe Name)
forall rep r op. ImpM rep r op (Maybe Name)
</span><a href="Futhark.CodeGen.ImpGen.html#askFunction"><span class="hs-identifier hs-var">askFunction</span></a></span><span>
</span><span id="line-1226"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op VName) -&gt; [Char] -&gt; ImpM rep r op VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS -&gt; Maybe [Char] -&gt; [Char]
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;.&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe [Char]
</span><a href="#local-6989586621684526904"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526905"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1227"></span><span>
</span><span id="line-1228"></span><span class="hs-comment">-- | Generate a 'Name', prefixed with 'askFunction' if it exists.</span><span>
</span><span id="line-1229"></span><span id="local-6989586621684529659"><span id="local-6989586621684529660"><span id="local-6989586621684529661"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#nameForFun"><span class="hs-identifier hs-type">nameForFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529661"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529660"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529659"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span></span></span></span><span>
</span><span id="line-1230"></span><span id="nameForFun"><span class="annot"><span class="annottext">nameForFun :: forall rep r op. [Char] -&gt; ImpM rep r op Name
</span><a href="Futhark.CodeGen.ImpGen.html#nameForFun"><span class="hs-identifier hs-var hs-var">nameForFun</span></a></span></span><span> </span><span id="local-6989586621684526894"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526894"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1231"></span><span>  </span><span id="local-6989586621684526893"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684526893"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op (Maybe Name)
forall rep r op. ImpM rep r op (Maybe Name)
</span><a href="Futhark.CodeGen.ImpGen.html#askFunction"><span class="hs-identifier hs-var">askFunction</span></a></span><span>
</span><span id="line-1232"></span><span>  </span><span class="annot"><span class="annottext">Name -&gt; ImpM rep r op Name
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; ImpM rep r op Name) -&gt; Name -&gt; ImpM rep r op Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; (Name -&gt; Name) -&gt; Maybe Name -&gt; Name
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-string">&quot;.&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684526893"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Name
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526894"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1233"></span><span>
</span><span id="line-1234"></span><span id="local-6989586621684529653"><span id="local-6989586621684529654"><span id="local-6989586621684529655"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-type">askEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529655"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529654"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529653"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529654"><span class="hs-identifier hs-type">r</span></a></span></span></span></span><span>
</span><span id="line-1235"></span><span id="askEnv"><span class="annot"><span class="annottext">askEnv :: forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var hs-var">askEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; r) -&gt; ImpM rep r op r
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; r
forall rep r op. Env rep r op -&gt; r
</span><a href="Futhark.CodeGen.ImpGen.html#envEnv"><span class="hs-identifier hs-var hs-var">envEnv</span></a></span><span>
</span><span id="line-1236"></span><span>
</span><span id="line-1237"></span><span id="local-6989586621684529646"><span id="local-6989586621684529647"><span id="local-6989586621684529648"><span id="local-6989586621684529649"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#localEnv"><span class="hs-identifier hs-type">localEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684529649"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684529649"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529648"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529649"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529647"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529646"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529648"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529649"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529647"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529646"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-1238"></span><span id="localEnv"><span class="annot"><span class="annottext">localEnv :: forall r rep op a. (r -&gt; r) -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localEnv"><span class="hs-identifier hs-var hs-var">localEnv</span></a></span></span><span> </span><span id="local-6989586621684526889"><span class="annot"><span class="annottext">r -&gt; r
</span><a href="#local-6989586621684526889"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Env rep r op)
-&gt; ImpM rep r op a -&gt; ImpM rep r op a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((Env rep r op -&gt; Env rep r op)
 -&gt; ImpM rep r op a -&gt; ImpM rep r op a)
-&gt; (Env rep r op -&gt; Env rep r op)
-&gt; ImpM rep r op a
-&gt; ImpM rep r op a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684526888"><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684526888"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684526888"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">envEnv :: r
</span><a href="Futhark.CodeGen.ImpGen.html#envEnv"><span class="hs-identifier hs-var">envEnv</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">r -&gt; r
</span><a href="#local-6989586621684526889"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(r -&gt; r) -&gt; r -&gt; r
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; r
forall rep r op. Env rep r op -&gt; r
</span><a href="Futhark.CodeGen.ImpGen.html#envEnv"><span class="hs-identifier hs-var hs-var">envEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684526888"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1239"></span><span>
</span><span id="line-1240"></span><span class="hs-comment">-- | The active attributes, including those for the statement</span><span>
</span><span id="line-1241"></span><span class="hs-comment">-- currently being compiled.</span><span>
</span><span id="line-1242"></span><span id="local-6989586621684529956"><span id="local-6989586621684529957"><span id="local-6989586621684529958"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#askAttrs"><span class="hs-identifier hs-type">askAttrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529958"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529957"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529956"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Attrs"><span class="hs-identifier hs-type">Attrs</span></a></span></span></span></span><span>
</span><span id="line-1243"></span><span id="askAttrs"><span class="annot"><span class="annottext">askAttrs :: forall rep r op. ImpM rep r op Attrs
</span><a href="Futhark.CodeGen.ImpGen.html#askAttrs"><span class="hs-identifier hs-var hs-var">askAttrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Attrs) -&gt; ImpM rep r op Attrs
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; Attrs
forall rep r op. Env rep r op -&gt; Attrs
</span><a href="Futhark.CodeGen.ImpGen.html#envAttrs"><span class="hs-identifier hs-var hs-var">envAttrs</span></a></span><span>
</span><span id="line-1244"></span><span>
</span><span id="line-1245"></span><span class="hs-comment">-- | Add more attributes to what is returning by 'askAttrs'.</span><span>
</span><span id="line-1246"></span><span id="local-6989586621684530005"><span id="local-6989586621684530006"><span id="local-6989586621684530007"><span id="local-6989586621684530008"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#localAttrs"><span class="hs-identifier hs-type">localAttrs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Attrs"><span class="hs-identifier hs-type">Attrs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530008"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530007"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530006"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530005"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530008"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530007"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530006"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530005"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-1247"></span><span id="localAttrs"><span class="annot"><span class="annottext">localAttrs :: forall rep r op a. Attrs -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localAttrs"><span class="hs-identifier hs-var hs-var">localAttrs</span></a></span></span><span> </span><span id="local-6989586621684526883"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684526883"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Env rep r op)
-&gt; ImpM rep r op a -&gt; ImpM rep r op a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((Env rep r op -&gt; Env rep r op)
 -&gt; ImpM rep r op a -&gt; ImpM rep r op a)
-&gt; (Env rep r op -&gt; Env rep r op)
-&gt; ImpM rep r op a
-&gt; ImpM rep r op a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684526882"><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684526882"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684526882"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">envAttrs :: Attrs
</span><a href="Futhark.CodeGen.ImpGen.html#envAttrs"><span class="hs-identifier hs-var">envAttrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684526883"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs -&gt; Attrs -&gt; Attrs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; Attrs
forall rep r op. Env rep r op -&gt; Attrs
</span><a href="Futhark.CodeGen.ImpGen.html#envAttrs"><span class="hs-identifier hs-var hs-var">envAttrs</span></a></span><span> </span><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684526882"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1248"></span><span>
</span><span id="line-1249"></span><span id="local-6989586621684529631"><span id="local-6989586621684529632"><span id="local-6989586621684529633"><span id="local-6989586621684529634"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#localOps"><span class="hs-identifier hs-type">localOps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-type">Operations</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529634"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529633"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529632"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529634"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529633"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529632"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529631"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529634"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529633"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529632"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529631"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-1250"></span><span id="localOps"><span class="annot"><span class="annottext">localOps :: forall rep r op a.
Operations rep r op -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localOps"><span class="hs-identifier hs-var hs-var">localOps</span></a></span></span><span> </span><span id="local-6989586621684526880"><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684526880"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Env rep r op)
-&gt; ImpM rep r op a -&gt; ImpM rep r op a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((Env rep r op -&gt; Env rep r op)
 -&gt; ImpM rep r op a -&gt; ImpM rep r op a)
-&gt; (Env rep r op -&gt; Env rep r op)
-&gt; ImpM rep r op a
-&gt; ImpM rep r op a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684526879"><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684526879"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1251"></span><span>  </span><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684526879"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1252"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">envExpCompiler :: ExpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envExpCompiler"><span class="hs-identifier hs-var">envExpCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations rep r op -&gt; ExpCompiler rep r op
forall rep r op. Operations rep r op -&gt; ExpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsExpCompiler"><span class="hs-identifier hs-var hs-var">opsExpCompiler</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684526880"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1253"></span><span>      </span><span class="annot"><span class="annottext">envStmsCompiler :: StmsCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envStmsCompiler"><span class="hs-identifier hs-var">envStmsCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations rep r op -&gt; StmsCompiler rep r op
forall rep r op. Operations rep r op -&gt; StmsCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsStmsCompiler"><span class="hs-identifier hs-var hs-var">opsStmsCompiler</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684526880"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1254"></span><span>      </span><span class="annot"><span class="annottext">envCopyCompiler :: CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envCopyCompiler"><span class="hs-identifier hs-var">envCopyCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations rep r op -&gt; CopyCompiler rep r op
forall rep r op. Operations rep r op -&gt; CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsCopyCompiler"><span class="hs-identifier hs-var hs-var">opsCopyCompiler</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684526880"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1255"></span><span>      </span><span class="annot"><span class="annottext">envOpCompiler :: OpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envOpCompiler"><span class="hs-identifier hs-var">envOpCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations rep r op -&gt; OpCompiler rep r op
forall rep r op. Operations rep r op -&gt; OpCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#opsOpCompiler"><span class="hs-identifier hs-var hs-var">opsOpCompiler</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684526880"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1256"></span><span>      </span><span class="annot"><span class="annottext">envAllocCompilers :: Map Space (AllocCompiler rep r op)
</span><a href="Futhark.CodeGen.ImpGen.html#envAllocCompilers"><span class="hs-identifier hs-var">envAllocCompilers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Operations rep r op -&gt; Map Space (AllocCompiler rep r op)
forall rep r op.
Operations rep r op -&gt; Map Space (AllocCompiler rep r op)
</span><a href="Futhark.CodeGen.ImpGen.html#opsAllocCompilers"><span class="hs-identifier hs-var hs-var">opsAllocCompilers</span></a></span><span> </span><span class="annot"><span class="annottext">Operations rep r op
</span><a href="#local-6989586621684526880"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-1257"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-1258"></span><span>
</span><span id="line-1259"></span><span class="hs-comment">-- | Get the current symbol table.</span><span>
</span><span id="line-1260"></span><span id="local-6989586621684529624"><span id="local-6989586621684529625"><span id="local-6989586621684529626"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#getVTable"><span class="hs-identifier hs-type">getVTable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529626"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529625"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529624"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VTable"><span class="hs-identifier hs-type">VTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529626"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1261"></span><span id="getVTable"><span class="annot"><span class="annottext">getVTable :: forall rep r op. ImpM rep r op (VTable rep)
</span><a href="Futhark.CodeGen.ImpGen.html#getVTable"><span class="hs-identifier hs-var hs-var">getVTable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; VTable rep) -&gt; ImpM rep r op (VTable rep)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; VTable rep
forall rep r op. ImpState rep r op -&gt; VTable rep
</span><a href="Futhark.CodeGen.ImpGen.html#stateVTable"><span class="hs-identifier hs-var hs-var">stateVTable</span></a></span><span>
</span><span id="line-1262"></span><span>
</span><span id="line-1263"></span><span id="local-6989586621684529618"><span id="local-6989586621684529619"><span id="local-6989586621684529620"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#putVTable"><span class="hs-identifier hs-type">putVTable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VTable"><span class="hs-identifier hs-type">VTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529620"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529620"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529619"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529618"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1264"></span><span id="putVTable"><span class="annot"><span class="annottext">putVTable :: forall rep r op. VTable rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#putVTable"><span class="hs-identifier hs-var hs-var">putVTable</span></a></span></span><span> </span><span id="local-6989586621684526875"><span class="annot"><span class="annottext">VTable rep
</span><a href="#local-6989586621684526875"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ())
-&gt; (ImpState rep r op -&gt; ImpState rep r op) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684526874"><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684526874"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
</span><a href="#local-6989586621684526874"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stateVTable :: VTable rep
</span><a href="Futhark.CodeGen.ImpGen.html#stateVTable"><span class="hs-identifier hs-var">stateVTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VTable rep
</span><a href="#local-6989586621684526875"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1265"></span><span>
</span><span id="line-1266"></span><span class="hs-comment">-- | Run an action with a modified symbol table.  All changes to the</span><span>
</span><span id="line-1267"></span><span class="hs-comment">-- symbol table will be reverted once the action is done!</span><span>
</span><span id="line-1268"></span><span id="local-6989586621684529611"><span id="local-6989586621684529612"><span id="local-6989586621684529613"><span id="local-6989586621684529614"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#localVTable"><span class="hs-identifier hs-type">localVTable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VTable"><span class="hs-identifier hs-type">VTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529614"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VTable"><span class="hs-identifier hs-type">VTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529614"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529614"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529613"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529612"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529611"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529614"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529613"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529612"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529611"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-1269"></span><span id="localVTable"><span class="annot"><span class="annottext">localVTable :: forall rep r op a.
(VTable rep -&gt; VTable rep) -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localVTable"><span class="hs-identifier hs-var hs-var">localVTable</span></a></span></span><span> </span><span id="local-6989586621684526868"><span class="annot"><span class="annottext">VTable rep -&gt; VTable rep
</span><a href="#local-6989586621684526868"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684526867"><span class="annot"><span class="annottext">ImpM rep r op a
</span><a href="#local-6989586621684526867"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1270"></span><span>  </span><span id="local-6989586621684526866"><span class="annot"><span class="annottext">VTable rep
</span><a href="#local-6989586621684526866"><span class="hs-identifier hs-var">old_vtable</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op (VTable rep)
forall rep r op. ImpM rep r op (VTable rep)
</span><a href="Futhark.CodeGen.ImpGen.html#getVTable"><span class="hs-identifier hs-var">getVTable</span></a></span><span>
</span><span id="line-1271"></span><span>  </span><span class="annot"><span class="annottext">VTable rep -&gt; ImpM rep r op ()
forall rep r op. VTable rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#putVTable"><span class="hs-identifier hs-var">putVTable</span></a></span><span> </span><span class="annot"><span class="annottext">(VTable rep -&gt; ImpM rep r op ()) -&gt; VTable rep -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VTable rep -&gt; VTable rep
</span><a href="#local-6989586621684526868"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">VTable rep
</span><a href="#local-6989586621684526866"><span class="hs-identifier hs-var">old_vtable</span></a></span><span>
</span><span id="line-1272"></span><span>  </span><span id="local-6989586621684526865"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684526865"><span class="hs-identifier hs-var">a</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op a
</span><a href="#local-6989586621684526867"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1273"></span><span>  </span><span class="annot"><span class="annottext">VTable rep -&gt; ImpM rep r op ()
forall rep r op. VTable rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#putVTable"><span class="hs-identifier hs-var">putVTable</span></a></span><span> </span><span class="annot"><span class="annottext">VTable rep
</span><a href="#local-6989586621684526866"><span class="hs-identifier hs-var">old_vtable</span></a></span><span>
</span><span id="line-1274"></span><span>  </span><span class="annot"><span class="annottext">a -&gt; ImpM rep r op a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684526865"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1275"></span><span>
</span><span id="line-1276"></span><span id="local-6989586621684529687"><span id="local-6989586621684529688"><span id="local-6989586621684529689"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#lookupVar"><span class="hs-identifier hs-type">lookupVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529689"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529688"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529687"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#VarEntry"><span class="hs-identifier hs-type">VarEntry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529689"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1277"></span><span id="lookupVar"><span class="annot"><span class="annottext">lookupVar :: forall rep r op. VName -&gt; ImpM rep r op (VarEntry rep)
</span><a href="Futhark.CodeGen.ImpGen.html#lookupVar"><span class="hs-identifier hs-var hs-var">lookupVar</span></a></span></span><span> </span><span id="local-6989586621684526856"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526856"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1278"></span><span>  </span><span id="local-6989586621684526855"><span class="annot"><span class="annottext">Maybe (VarEntry rep)
</span><a href="#local-6989586621684526855"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op -&gt; Maybe (VarEntry rep))
-&gt; ImpM rep r op (Maybe (VarEntry rep))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">((ImpState rep r op -&gt; Maybe (VarEntry rep))
 -&gt; ImpM rep r op (Maybe (VarEntry rep)))
-&gt; (ImpState rep r op -&gt; Maybe (VarEntry rep))
-&gt; ImpM rep r op (Maybe (VarEntry rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName (VarEntry rep) -&gt; Maybe (VarEntry rep)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526856"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName (VarEntry rep) -&gt; Maybe (VarEntry rep))
-&gt; (ImpState rep r op -&gt; Map VName (VarEntry rep))
-&gt; ImpState rep r op
-&gt; Maybe (VarEntry rep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op -&gt; Map VName (VarEntry rep)
forall rep r op. ImpState rep r op -&gt; VTable rep
</span><a href="Futhark.CodeGen.ImpGen.html#stateVTable"><span class="hs-identifier hs-var hs-var">stateVTable</span></a></span><span>
</span><span id="line-1279"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (VarEntry rep)
</span><a href="#local-6989586621684526855"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1280"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526854"><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526854"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VarEntry rep -&gt; ImpM rep r op (VarEntry rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526854"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-1281"></span><span>    </span><span class="annot"><span class="annottext">Maybe (VarEntry rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op (VarEntry rep)
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op (VarEntry rep))
-&gt; [Char] -&gt; ImpM rep r op (VarEntry rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Unknown variable: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526856"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1282"></span><span>
</span><span id="line-1283"></span><span id="local-6989586621684529864"><span id="local-6989586621684529865"><span id="local-6989586621684529866"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#lookupArray"><span class="hs-identifier hs-type">lookupArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529866"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529865"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529864"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayEntry"><span class="hs-identifier hs-type">ArrayEntry</span></a></span></span></span></span><span>
</span><span id="line-1284"></span><span id="lookupArray"><span class="annot"><span class="annottext">lookupArray :: forall rep r op. VName -&gt; ImpM rep r op ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArray"><span class="hs-identifier hs-var hs-var">lookupArray</span></a></span></span><span> </span><span id="local-6989586621684526847"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526847"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1285"></span><span>  </span><span id="local-6989586621684526846"><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526846"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op (VarEntry rep)
forall rep r op. VName -&gt; ImpM rep r op (VarEntry rep)
</span><a href="Futhark.CodeGen.ImpGen.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526847"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1286"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526846"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1287"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayVar"><span class="hs-identifier hs-type">ArrayVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684526845"><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684526845"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ArrayEntry -&gt; ImpM rep r op ArrayEntry
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684526845"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-1288"></span><span>    </span><span class="annot"><span class="annottext">VarEntry rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ArrayEntry
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op ArrayEntry)
-&gt; [Char] -&gt; ImpM rep r op ArrayEntry
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;ImpGen.lookupArray: not an array: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526847"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1289"></span><span>
</span><span id="line-1290"></span><span id="local-6989586621684530122"><span id="local-6989586621684530123"><span id="local-6989586621684530124"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier hs-type">lookupMemory</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530124"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530123"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530122"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemEntry"><span class="hs-identifier hs-type">MemEntry</span></a></span></span></span></span><span>
</span><span id="line-1291"></span><span id="lookupMemory"><span class="annot"><span class="annottext">lookupMemory :: forall rep r op. VName -&gt; ImpM rep r op MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier hs-var hs-var">lookupMemory</span></a></span></span><span> </span><span id="local-6989586621684526838"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526838"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1292"></span><span>  </span><span id="local-6989586621684526837"><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526837"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op (VarEntry rep)
forall rep r op. VName -&gt; ImpM rep r op (VarEntry rep)
</span><a href="Futhark.CodeGen.ImpGen.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526838"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1293"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526837"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1294"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-type">MemVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684526836"><span class="annot"><span class="annottext">MemEntry
</span><a href="#local-6989586621684526836"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; ImpM rep r op MemEntry
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">MemEntry
</span><a href="#local-6989586621684526836"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-1295"></span><span>    </span><span class="annot"><span class="annottext">VarEntry rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op MemEntry
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op MemEntry)
-&gt; [Char] -&gt; ImpM rep r op MemEntry
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Unknown memory block: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526838"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1296"></span><span>
</span><span id="line-1297"></span><span id="local-6989586621684529595"><span id="local-6989586621684529596"><span id="local-6989586621684529597"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#lookupArraySpace"><span class="hs-identifier hs-type">lookupArraySpace</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529597"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529596"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529595"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span></span></span></span><span>
</span><span id="line-1298"></span><span id="lookupArraySpace"><span class="annot"><span class="annottext">lookupArraySpace :: forall rep r op. VName -&gt; ImpM rep r op Space
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArraySpace"><span class="hs-identifier hs-var hs-var">lookupArraySpace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1299"></span><span>  </span><span class="annot"><span class="annottext">(MemEntry -&gt; Space)
-&gt; ImpM rep r op MemEntry -&gt; ImpM rep r op Space
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op MemEntry -&gt; ImpM rep r op Space)
-&gt; (VName -&gt; ImpM rep r op MemEntry)
-&gt; VName
-&gt; ImpM rep r op Space
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op MemEntry
forall rep r op. VName -&gt; ImpM rep r op MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier hs-var">lookupMemory</span></a></span><span>
</span><span id="line-1300"></span><span>    </span><span class="annot"><span class="annottext">(VName -&gt; ImpM rep r op Space)
-&gt; (VName -&gt; ImpM rep r op VName) -&gt; VName -&gt; ImpM rep r op Space
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">(ArrayEntry -&gt; VName)
-&gt; ImpM rep r op ArrayEntry -&gt; ImpM rep r op VName
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#memLocName"><span class="hs-identifier hs-var hs-var">memLocName</span></a></span><span> </span><span class="annot"><span class="annottext">(MemLoc -&gt; VName) -&gt; (ArrayEntry -&gt; MemLoc) -&gt; ArrayEntry -&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ArrayEntry -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var hs-var">entryArrayLoc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op ArrayEntry -&gt; ImpM rep r op VName)
-&gt; (VName -&gt; ImpM rep r op ArrayEntry)
-&gt; VName
-&gt; ImpM rep r op VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op ArrayEntry
forall rep r op. VName -&gt; ImpM rep r op ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArray"><span class="hs-identifier hs-var">lookupArray</span></a></span><span>
</span><span id="line-1301"></span><span>
</span><span id="line-1302"></span><span class="hs-comment">-- | In the case of a histogram-like accumulator, also sets the index</span><span>
</span><span id="line-1303"></span><span class="hs-comment">-- parameters.</span><span>
</span><span id="line-1304"></span><span id="local-6989586621684529824"><span id="local-6989586621684529825"><span id="local-6989586621684529826"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#lookupAcc"><span class="hs-identifier hs-type">lookupAcc</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1305"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1306"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1307"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529826"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529825"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529824"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529826"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1308"></span><span id="lookupAcc"><span class="annot"><span class="annottext">lookupAcc :: forall rep r op.
VName
-&gt; [TExp Int64]
-&gt; ImpM
     rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep))
</span><a href="Futhark.CodeGen.ImpGen.html#lookupAcc"><span class="hs-identifier hs-var hs-var">lookupAcc</span></a></span></span><span> </span><span id="local-6989586621684526805"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526805"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684526804"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526804"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1309"></span><span>  </span><span id="local-6989586621684526803"><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526803"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op (VarEntry rep)
forall rep r op. VName -&gt; ImpM rep r op (VarEntry rep)
</span><a href="Futhark.CodeGen.ImpGen.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526805"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1310"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526803"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1311"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#AccVar"><span class="hs-identifier hs-type">AccVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526802"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526802"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526801"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526801"><span class="hs-identifier hs-var">ispace</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1312"></span><span>      </span><span id="local-6989586621684526800"><span class="annot"><span class="annottext">Maybe ([VName], Maybe (Lambda rep, [SubExp]))
</span><a href="#local-6989586621684526800"><span class="hs-identifier hs-var">acc'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(ImpState rep r op
 -&gt; Maybe ([VName], Maybe (Lambda rep, [SubExp])))
-&gt; ImpM rep r op (Maybe ([VName], Maybe (Lambda rep, [SubExp])))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">((ImpState rep r op
  -&gt; Maybe ([VName], Maybe (Lambda rep, [SubExp])))
 -&gt; ImpM rep r op (Maybe ([VName], Maybe (Lambda rep, [SubExp]))))
-&gt; (ImpState rep r op
    -&gt; Maybe ([VName], Maybe (Lambda rep, [SubExp])))
-&gt; ImpM rep r op (Maybe ([VName], Maybe (Lambda rep, [SubExp])))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
-&gt; Maybe ([VName], Maybe (Lambda rep, [SubExp]))
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526802"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName ([VName], Maybe (Lambda rep, [SubExp]))
 -&gt; Maybe ([VName], Maybe (Lambda rep, [SubExp])))
-&gt; (ImpState rep r op
    -&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp])))
-&gt; ImpState rep r op
-&gt; Maybe ([VName], Maybe (Lambda rep, [SubExp]))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ImpState rep r op
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
forall rep r op.
ImpState rep r op
-&gt; Map VName ([VName], Maybe (Lambda rep, [SubExp]))
</span><a href="Futhark.CodeGen.ImpGen.html#stateAccs"><span class="hs-identifier hs-var hs-var">stateAccs</span></a></span><span>
</span><span id="line-1313"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], Maybe (Lambda rep, [SubExp]))
</span><a href="#local-6989586621684526800"><span class="hs-identifier hs-var">acc'</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1314"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Lambda rep, [SubExp])
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1315"></span><span>          </span><span class="annot"><span class="annottext">[Char]
-&gt; ImpM
     rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep))
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char]
 -&gt; ImpM
      rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep)))
-&gt; [Char]
-&gt; ImpM
     rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Accumulator with no arrays: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526805"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1316"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526799"><span class="annot"><span class="annottext">arrs :: [VName]
</span><a href="#local-6989586621684526799"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621684526798"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526798"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526797"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684526797"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1317"></span><span>          </span><span id="local-6989586621684526796"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526796"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op Space
forall rep r op. VName -&gt; ImpM rep r op Space
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArraySpace"><span class="hs-identifier hs-var">lookupArraySpace</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526798"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1318"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526795"><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684526795"><span class="hs-identifier hs-var">i_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526794"><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684526794"><span class="hs-identifier hs-var">ps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [Param (LParamInfo rep)]
-&gt; ([Param (LParamInfo rep)], [Param (LParamInfo rep)])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526804"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param (LParamInfo rep)]
 -&gt; ([Param (LParamInfo rep)], [Param (LParamInfo rep)]))
-&gt; [Param (LParamInfo rep)]
-&gt; ([Param (LParamInfo rep)], [Param (LParamInfo rep)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep -&gt; [Param (LParamInfo rep)]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684526797"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-1319"></span><span>          </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64 -&gt; ImpM rep r op ())
-&gt; [VName] -&gt; [TExp Int64] -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; ImpM rep r op ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Param (LParamInfo rep) -&gt; VName)
-&gt; [Param (LParamInfo rep)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (LParamInfo rep) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684526795"><span class="hs-identifier hs-var">i_params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526804"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-1320"></span><span>          </span><span class="annot"><span class="annottext">(VName, Space, [VName], [TExp Int64], Maybe (Lambda rep))
-&gt; ImpM
     rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-1321"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526802"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1322"></span><span>              </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526796"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1323"></span><span>              </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684526799"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1324"></span><span>              </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526801"><span class="hs-identifier hs-var">ispace</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1325"></span><span>              </span><span class="annot"><span class="annottext">Lambda rep -&gt; Maybe (Lambda rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684526797"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaParams :: [Param (LParamInfo rep)]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var">lambdaParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684526794"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1326"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-1327"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526792"><span class="annot"><span class="annottext">arrs :: [VName]
</span><a href="#local-6989586621684526792"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621684526791"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526791"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Lambda rep, [SubExp])
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1328"></span><span>          </span><span id="local-6989586621684526790"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526790"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op Space
forall rep r op. VName -&gt; ImpM rep r op Space
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArraySpace"><span class="hs-identifier hs-var">lookupArraySpace</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526791"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1329"></span><span>          </span><span class="annot"><span class="annottext">(VName, Space, [VName], [TExp Int64], Maybe (Lambda rep))
-&gt; ImpM
     rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526802"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526790"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684526792"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526801"><span class="hs-identifier hs-var">ispace</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Lambda rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-1330"></span><span>        </span><span class="annot"><span class="annottext">Maybe ([VName], Maybe (Lambda rep, [SubExp]))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1331"></span><span>          </span><span class="annot"><span class="annottext">[Char]
-&gt; ImpM
     rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep))
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char]
 -&gt; ImpM
      rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep)))
-&gt; [Char]
-&gt; ImpM
     rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;ImpGen.lookupAcc: unlisted accumulator: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526805"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1332"></span><span>    </span><span class="annot"><span class="annottext">VarEntry rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char]
-&gt; ImpM
     rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep))
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char]
 -&gt; ImpM
      rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep)))
-&gt; [Char]
-&gt; ImpM
     rep r op (VName, Space, [VName], [TExp Int64], Maybe (Lambda rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;ImpGen.lookupAcc: not an accumulator: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526805"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1333"></span><span>
</span><span id="line-1334"></span><span id="local-6989586621684530065"><span id="local-6989586621684530066"><span id="local-6989586621684530067"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#destinationFromPat"><span class="hs-identifier hs-type">destinationFromPat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530067"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530067"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530066"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530065"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ValueDestination"><span class="hs-identifier hs-type">ValueDestination</span></a></span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-1335"></span><span id="destinationFromPat"><span class="annot"><span class="annottext">destinationFromPat :: forall rep r op. Pat rep -&gt; ImpM rep r op [ValueDestination]
</span><a href="Futhark.CodeGen.ImpGen.html#destinationFromPat"><span class="hs-identifier hs-var hs-var">destinationFromPat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PatElemT (LetDec rep) -&gt; ImpM rep r op ValueDestination)
-&gt; [PatElemT (LetDec rep)] -&gt; ImpM rep r op [ValueDestination]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; ImpM rep r op ValueDestination
forall {dec} {rep} {r} {op}.
PatElemT dec -&gt; ImpM rep r op ValueDestination
</span><a href="#local-6989586621684526787"><span class="hs-identifier hs-var">inspect</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT (LetDec rep)] -&gt; ImpM rep r op [ValueDestination])
-&gt; (PatT (LetDec rep) -&gt; [PatElemT (LetDec rep)])
-&gt; PatT (LetDec rep)
-&gt; ImpM rep r op [ValueDestination]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep) -&gt; [PatElemT (LetDec rep)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span>
</span><span id="line-1336"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1337"></span><span>    </span><span id="local-6989586621684526787"><span class="annot"><span class="annottext">inspect :: PatElemT dec -&gt; ImpM rep r op ValueDestination
</span><a href="#local-6989586621684526787"><span class="hs-identifier hs-var hs-var">inspect</span></a></span></span><span> </span><span id="local-6989586621684526781"><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684526781"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1338"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684526780"><span class="annot"><span class="annottext">name :: VName
</span><a href="#local-6989586621684526780"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatElemT dec -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT dec
</span><a href="#local-6989586621684526781"><span class="hs-identifier hs-var">pe</span></a></span><span>
</span><span id="line-1339"></span><span>      </span><span id="local-6989586621684526779"><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526779"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op (VarEntry rep)
forall rep r op. VName -&gt; ImpM rep r op (VarEntry rep)
</span><a href="Futhark.CodeGen.ImpGen.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526780"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1340"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526779"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1341"></span><span>        </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayVar"><span class="hs-identifier hs-type">ArrayVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayEntry"><span class="hs-identifier hs-type">ArrayEntry</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1342"></span><span>          </span><span class="annot"><span class="annottext">ValueDestination -&gt; ImpM rep r op ValueDestination
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ValueDestination -&gt; ImpM rep r op ValueDestination)
-&gt; ValueDestination -&gt; ImpM rep r op ValueDestination
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe MemLoc -&gt; ValueDestination
</span><a href="Futhark.CodeGen.ImpGen.html#ArrayDestination"><span class="hs-identifier hs-var">ArrayDestination</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe MemLoc
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1343"></span><span>        </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-type">MemVar</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1344"></span><span>          </span><span class="annot"><span class="annottext">ValueDestination -&gt; ImpM rep r op ValueDestination
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ValueDestination -&gt; ImpM rep r op ValueDestination)
-&gt; ValueDestination -&gt; ImpM rep r op ValueDestination
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ValueDestination
</span><a href="Futhark.CodeGen.ImpGen.html#MemoryDestination"><span class="hs-identifier hs-var">MemoryDestination</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526780"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1345"></span><span>        </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-type">ScalarVar</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1346"></span><span>          </span><span class="annot"><span class="annottext">ValueDestination -&gt; ImpM rep r op ValueDestination
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ValueDestination -&gt; ImpM rep r op ValueDestination)
-&gt; ValueDestination -&gt; ImpM rep r op ValueDestination
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ValueDestination
</span><a href="Futhark.CodeGen.ImpGen.html#ScalarDestination"><span class="hs-identifier hs-var">ScalarDestination</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526780"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1347"></span><span>        </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#AccVar"><span class="hs-identifier hs-type">AccVar</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1348"></span><span>          </span><span class="annot"><span class="annottext">ValueDestination -&gt; ImpM rep r op ValueDestination
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ValueDestination -&gt; ImpM rep r op ValueDestination)
-&gt; ValueDestination -&gt; ImpM rep r op ValueDestination
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe MemLoc -&gt; ValueDestination
</span><a href="Futhark.CodeGen.ImpGen.html#ArrayDestination"><span class="hs-identifier hs-var">ArrayDestination</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe MemLoc
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1349"></span><span>
</span><span id="line-1350"></span><span id="local-6989586621684529571"><span id="local-6989586621684529572"><span id="local-6989586621684529573"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray"><span class="hs-identifier hs-type">fullyIndexArray</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1351"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1352"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1353"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529573"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529572"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529571"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Imp.Space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Elements"><span class="hs-identifier hs-type">Elements</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1354"></span><span id="fullyIndexArray"><span class="annot"><span class="annottext">fullyIndexArray :: forall rep r op.
VName
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray"><span class="hs-identifier hs-var hs-var">fullyIndexArray</span></a></span></span><span> </span><span id="local-6989586621684526777"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526777"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684526776"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526776"><span class="hs-identifier hs-var">indices</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1355"></span><span>  </span><span id="local-6989586621684526775"><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684526775"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op ArrayEntry
forall rep r op. VName -&gt; ImpM rep r op ArrayEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupArray"><span class="hs-identifier hs-var">lookupArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526777"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1356"></span><span>  </span><span class="annot"><span class="annottext">MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
forall rep r op.
MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray%27"><span class="hs-identifier hs-var">fullyIndexArray'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayEntry -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var hs-var">entryArrayLoc</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684526775"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526776"><span class="hs-identifier hs-var">indices</span></a></span><span>
</span><span id="line-1357"></span><span>
</span><span id="line-1358"></span><span id="local-6989586621684529563"><span id="local-6989586621684529564"><span id="local-6989586621684529565"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray%27"><span class="hs-identifier hs-type">fullyIndexArray'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1359"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1360"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1361"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529565"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529564"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529563"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Imp.Space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Elements"><span class="hs-identifier hs-type">Elements</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1362"></span><span id="fullyIndexArray%27"><span class="annot"><span class="annottext">fullyIndexArray' :: forall rep r op.
MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray%27"><span class="hs-identifier hs-var hs-var">fullyIndexArray'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span id="local-6989586621684526769"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526769"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684526768"><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526768"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684526767"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526767"><span class="hs-identifier hs-var">indices</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1363"></span><span>  </span><span id="local-6989586621684526766"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526766"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(MemEntry -&gt; Space)
-&gt; ImpM rep r op MemEntry -&gt; ImpM rep r op Space
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op MemEntry
forall rep r op. VName -&gt; ImpM rep r op MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier hs-var">lookupMemory</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526769"><span class="hs-identifier hs-var">mem</span></a></span><span>
</span><span id="line-1364"></span><span>  </span><span class="annot"><span class="annottext">(VName, Space, Count Elements (TExp Int64))
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-1365"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526769"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1366"></span><span>      </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526766"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1367"></span><span>      </span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Elements (TExp Int64)
forall a. a -&gt; Count Elements a
</span><a href="Futhark.CodeGen.ImpCode.html#elements"><span class="hs-identifier hs-var">elements</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; Count Elements (TExp Int64))
-&gt; TExp Int64 -&gt; Count Elements (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64) -&gt; [TExp Int64] -&gt; TExp Int64
forall num.
(IntegralExp num, Eq num) =&gt;
IxFun num -&gt; Indices num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#index"><span class="hs-identifier hs-var">IxFun.index</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526768"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526767"><span class="hs-identifier hs-var">indices</span></a></span><span>
</span><span id="line-1368"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-1369"></span><span>
</span><span id="line-1370"></span><span class="hs-comment">-- More complicated read/write operations that use index functions.</span><span>
</span><span id="line-1371"></span><span>
</span><span id="line-1372"></span><span id="local-6989586621684526762"><span id="local-6989586621684526763"><span id="local-6989586621684526764"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#copy"><span class="hs-identifier hs-type">copy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#CopyCompiler"><span class="hs-identifier hs-type">CopyCompiler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526764"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526763"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526762"><span class="hs-identifier hs-type">op</span></a></span></span></span></span><span>
</span><span id="line-1373"></span><span id="copy"><span class="annot"><span class="annottext">copy :: forall rep r op. CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#copy"><span class="hs-identifier hs-var hs-var">copy</span></a></span></span><span> </span><span id="local-6989586621684526756"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526756"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span id="local-6989586621684526755"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526755"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span id="local-6989586621684526754"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526754"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1374"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span>
</span><span id="line-1375"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">MemLoc -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#memLocName"><span class="hs-identifier hs-var hs-var">memLocName</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526755"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">MemLoc -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#memLocName"><span class="hs-identifier hs-var hs-var">memLocName</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526754"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-1376"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">MemLoc -&gt; IxFun (TExp Int64)
</span><a href="Futhark.CodeGen.ImpGen.html#memLocIxFun"><span class="hs-identifier hs-var hs-var">memLocIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526755"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64) -&gt; IxFun (TExp Int64) -&gt; Bool
forall num. Eq num =&gt; IxFun num -&gt; IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#equivalent"><span class="hs-operator hs-var">`IxFun.equivalent`</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc -&gt; IxFun (TExp Int64)
</span><a href="Futhark.CodeGen.ImpGen.html#memLocIxFun"><span class="hs-identifier hs-var hs-var">memLocIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526754"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-1377"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-1378"></span><span>    </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1379"></span><span>      </span><span id="local-6989586621684526751"><span class="annot"><span class="annottext">CopyCompiler rep r op
</span><a href="#local-6989586621684526751"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; CopyCompiler rep r op)
-&gt; ImpM rep r op (CopyCompiler rep r op)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; CopyCompiler rep r op
forall rep r op. Env rep r op -&gt; CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#envCopyCompiler"><span class="hs-identifier hs-var hs-var">envCopyCompiler</span></a></span><span>
</span><span id="line-1380"></span><span>      </span><span class="annot"><span class="annottext">CopyCompiler rep r op
</span><a href="#local-6989586621684526751"><span class="hs-identifier hs-var">cc</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526756"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526755"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526754"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-1381"></span><span>
</span><span id="line-1382"></span><span class="hs-comment">-- | Is this copy really a mapping with transpose?</span><span>
</span><span id="line-1383"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#isMapTransposeCopy"><span class="hs-identifier hs-type">isMapTransposeCopy</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1384"></span><span>  </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1385"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1386"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1387"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span>
</span><span id="line-1388"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">,</span><span>
</span><span id="line-1389"></span><span>      </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">,</span><span>
</span><span id="line-1390"></span><span>      </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">,</span><span>
</span><span id="line-1391"></span><span>      </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">,</span><span>
</span><span id="line-1392"></span><span>      </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span>
</span><span id="line-1393"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-1394"></span><span id="isMapTransposeCopy"><span class="annot"><span class="annottext">isMapTransposeCopy :: PrimType
-&gt; MemLoc
-&gt; MemLoc
-&gt; Maybe
     (TExp Int64, TExp Int64, TExp Int64, TExp Int64, TExp Int64)
</span><a href="Futhark.CodeGen.ImpGen.html#isMapTransposeCopy"><span class="hs-identifier hs-var hs-var">isMapTransposeCopy</span></a></span></span><span> </span><span id="local-6989586621684526750"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526750"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684526749"><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526749"><span class="hs-identifier hs-var">destIxFun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684526748"><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526748"><span class="hs-identifier hs-var">srcIxFun</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1395"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526747"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526747"><span class="hs-identifier hs-var">dest_offset</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526746"><span class="annot"><span class="annottext">[(Int, TExp Int64)]
</span><a href="#local-6989586621684526746"><span class="hs-identifier hs-var">perm_and_destshape</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
-&gt; TExp Int64 -&gt; Maybe (TExp Int64, [(Int, TExp Int64)])
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; num -&gt; Maybe (num, [(Int, num)])
</span><a href="Futhark.IR.Mem.IxFun.html#rearrangeWithOffset"><span class="hs-identifier hs-var">IxFun.rearrangeWithOffset</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526749"><span class="hs-identifier hs-var">destIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526744"><span class="hs-identifier hs-var">bt_size</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1396"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684526743"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684526743"><span class="hs-identifier hs-var">perm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526742"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526742"><span class="hs-identifier hs-var">destshape</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Int, TExp Int64)] -&gt; ([Int], [TExp Int64])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Int, TExp Int64)]
</span><a href="#local-6989586621684526746"><span class="hs-identifier hs-var">perm_and_destshape</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1397"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526741"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526741"><span class="hs-identifier hs-var">src_offset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64) -&gt; TExp Int64 -&gt; Maybe (TExp Int64)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; num -&gt; Maybe num
</span><a href="Futhark.IR.Mem.IxFun.html#linearWithOffset"><span class="hs-identifier hs-var">IxFun.linearWithOffset</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526748"><span class="hs-identifier hs-var">srcIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526744"><span class="hs-identifier hs-var">bt_size</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1398"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526739"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526739"><span class="hs-identifier hs-var">r1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526738"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526738"><span class="hs-identifier hs-var">r2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Maybe (Int, Int, Int)
</span><a href="Futhark.IR.Prop.Rearrange.html#isMapTranspose"><span class="hs-identifier hs-var">isMapTranspose</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684526743"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1399"></span><span>    </span><span class="annot"><span class="annottext">[TExp Int64]
-&gt; (([TExp Int64], [TExp Int64]) -&gt; ([TExp Int64], [TExp Int64]))
-&gt; Int
-&gt; Int
-&gt; TExp Int64
-&gt; TExp Int64
-&gt; Maybe
     (TExp Int64, TExp Int64, TExp Int64, TExp Int64, TExp Int64)
forall {t :: * -&gt; *} {t :: * -&gt; *} {c} {d} {e} {m :: * -&gt; *} {a}
       {b}.
(Foldable t, Foldable t, Num c, Num d, Num e, Monad m) =&gt;
[c]
-&gt; (([c], [c]) -&gt; (t d, t e))
-&gt; Int
-&gt; Int
-&gt; a
-&gt; b
-&gt; m (a, b, c, d, e)
</span><a href="#local-6989586621684526736"><span class="hs-identifier hs-var">isOk</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526742"><span class="hs-identifier hs-var">destshape</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64], [TExp Int64]) -&gt; ([TExp Int64], [TExp Int64])
forall {b} {a}. (b, a) -&gt; (a, b)
</span><a href="#local-6989586621684526735"><span class="hs-identifier hs-var">swap</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526739"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526738"><span class="hs-identifier hs-var">r2</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526747"><span class="hs-identifier hs-var">dest_offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526741"><span class="hs-identifier hs-var">src_offset</span></a></span><span>
</span><span id="line-1400"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526734"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526734"><span class="hs-identifier hs-var">dest_offset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64) -&gt; TExp Int64 -&gt; Maybe (TExp Int64)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; num -&gt; Maybe num
</span><a href="Futhark.IR.Mem.IxFun.html#linearWithOffset"><span class="hs-identifier hs-var">IxFun.linearWithOffset</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526749"><span class="hs-identifier hs-var">destIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526744"><span class="hs-identifier hs-var">bt_size</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1401"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526733"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526733"><span class="hs-identifier hs-var">src_offset</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526732"><span class="annot"><span class="annottext">[(Int, TExp Int64)]
</span><a href="#local-6989586621684526732"><span class="hs-identifier hs-var">perm_and_srcshape</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
-&gt; TExp Int64 -&gt; Maybe (TExp Int64, [(Int, TExp Int64)])
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; num -&gt; Maybe (num, [(Int, num)])
</span><a href="Futhark.IR.Mem.IxFun.html#rearrangeWithOffset"><span class="hs-identifier hs-var">IxFun.rearrangeWithOffset</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526748"><span class="hs-identifier hs-var">srcIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526744"><span class="hs-identifier hs-var">bt_size</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1402"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684526731"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684526731"><span class="hs-identifier hs-var">perm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526730"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526730"><span class="hs-identifier hs-var">srcshape</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Int, TExp Int64)] -&gt; ([Int], [TExp Int64])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Int, TExp Int64)]
</span><a href="#local-6989586621684526732"><span class="hs-identifier hs-var">perm_and_srcshape</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1403"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526729"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526729"><span class="hs-identifier hs-var">r1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526728"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526728"><span class="hs-identifier hs-var">r2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Maybe (Int, Int, Int)
</span><a href="Futhark.IR.Prop.Rearrange.html#isMapTranspose"><span class="hs-identifier hs-var">isMapTranspose</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684526731"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1404"></span><span>    </span><span class="annot"><span class="annottext">[TExp Int64]
-&gt; (([TExp Int64], [TExp Int64]) -&gt; ([TExp Int64], [TExp Int64]))
-&gt; Int
-&gt; Int
-&gt; TExp Int64
-&gt; TExp Int64
-&gt; Maybe
     (TExp Int64, TExp Int64, TExp Int64, TExp Int64, TExp Int64)
forall {t :: * -&gt; *} {t :: * -&gt; *} {c} {d} {e} {m :: * -&gt; *} {a}
       {b}.
(Foldable t, Foldable t, Num c, Num d, Num e, Monad m) =&gt;
[c]
-&gt; (([c], [c]) -&gt; (t d, t e))
-&gt; Int
-&gt; Int
-&gt; a
-&gt; b
-&gt; m (a, b, c, d, e)
</span><a href="#local-6989586621684526736"><span class="hs-identifier hs-var">isOk</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526730"><span class="hs-identifier hs-var">srcshape</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64], [TExp Int64]) -&gt; ([TExp Int64], [TExp Int64])
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526729"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526728"><span class="hs-identifier hs-var">r2</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526734"><span class="hs-identifier hs-var">dest_offset</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526733"><span class="hs-identifier hs-var">src_offset</span></a></span><span>
</span><span id="line-1405"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1406"></span><span>    </span><span class="annot"><span class="annottext">Maybe (TExp Int64, TExp Int64, TExp Int64, TExp Int64, TExp Int64)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1407"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1408"></span><span>    </span><span id="local-6989586621684526744"><span class="annot"><span class="annottext">bt_size :: TExp Int64
</span><a href="#local-6989586621684526744"><span class="hs-identifier hs-var hs-var">bt_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TExp Int64
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526750"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1409"></span><span>    </span><span id="local-6989586621684526735"><span class="annot"><span class="annottext">swap :: (b, a) -&gt; (a, b)
</span><a href="#local-6989586621684526735"><span class="hs-identifier hs-var hs-var">swap</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526726"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684526726"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526725"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684526725"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684526725"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684526726"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1410"></span><span>
</span><span id="line-1411"></span><span>    </span><span id="local-6989586621684526736"><span class="annot"><span class="annottext">isOk :: [c]
-&gt; (([c], [c]) -&gt; (t d, t e))
-&gt; Int
-&gt; Int
-&gt; a
-&gt; b
-&gt; m (a, b, c, d, e)
</span><a href="#local-6989586621684526736"><span class="hs-identifier hs-var hs-var">isOk</span></a></span></span><span> </span><span id="local-6989586621684526712"><span class="annot"><span class="annottext">[c]
</span><a href="#local-6989586621684526712"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684526711"><span class="annot"><span class="annottext">([c], [c]) -&gt; (t d, t e)
</span><a href="#local-6989586621684526711"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684526710"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526710"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span id="local-6989586621684526709"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526709"><span class="hs-identifier hs-var">r2</span></a></span></span><span> </span><span id="local-6989586621684526708"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684526708"><span class="hs-identifier hs-var">dest_offset</span></a></span></span><span> </span><span id="local-6989586621684526707"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684526707"><span class="hs-identifier hs-var">src_offset</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1412"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526706"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621684526706"><span class="hs-identifier hs-var">num_arrays</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526705"><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684526705"><span class="hs-identifier hs-var">size_x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526704"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621684526704"><span class="hs-identifier hs-var">size_y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[c] -&gt; (([c], [c]) -&gt; (t d, t e)) -&gt; Int -&gt; Int -&gt; (c, d, e)
forall {t :: * -&gt; *} {t :: * -&gt; *} {a} {b} {c}.
(Foldable t, Foldable t, Num a, Num b, Num c) =&gt;
[a] -&gt; (([a], [a]) -&gt; (t b, t c)) -&gt; Int -&gt; Int -&gt; (a, b, c)
</span><a href="#local-6989586621684526703"><span class="hs-identifier hs-var">getSizes</span></a></span><span> </span><span class="annot"><span class="annottext">[c]
</span><a href="#local-6989586621684526712"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">([c], [c]) -&gt; (t d, t e)
</span><a href="#local-6989586621684526711"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526710"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526709"><span class="hs-identifier hs-var">r2</span></a></span><span>
</span><span id="line-1413"></span><span>      </span><span class="annot"><span class="annottext">(a, b, c, d, e) -&gt; m (a, b, c, d, e)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-1414"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684526708"><span class="hs-identifier hs-var">dest_offset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1415"></span><span>          </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684526707"><span class="hs-identifier hs-var">src_offset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1416"></span><span>          </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621684526706"><span class="hs-identifier hs-var">num_arrays</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1417"></span><span>          </span><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684526705"><span class="hs-identifier hs-var">size_x</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1418"></span><span>          </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621684526704"><span class="hs-identifier hs-var">size_y</span></a></span><span>
</span><span id="line-1419"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-1420"></span><span>
</span><span id="line-1421"></span><span>    </span><span id="local-6989586621684526703"><span class="annot"><span class="annottext">getSizes :: [a] -&gt; (([a], [a]) -&gt; (t b, t c)) -&gt; Int -&gt; Int -&gt; (a, b, c)
</span><a href="#local-6989586621684526703"><span class="hs-identifier hs-var hs-var">getSizes</span></a></span></span><span> </span><span id="local-6989586621684526691"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684526691"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684526690"><span class="annot"><span class="annottext">([a], [a]) -&gt; (t b, t c)
</span><a href="#local-6989586621684526690"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684526689"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526689"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span id="local-6989586621684526688"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526688"><span class="hs-identifier hs-var">r2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1422"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526687"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684526687"><span class="hs-identifier hs-var">mapped</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526686"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684526686"><span class="hs-identifier hs-var">notmapped</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; ([a], [a])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526689"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684526691"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-1423"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684526685"><span class="annot"><span class="annottext">t b
</span><a href="#local-6989586621684526685"><span class="hs-identifier hs-var">pretrans</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526684"><span class="annot"><span class="annottext">t c
</span><a href="#local-6989586621684526684"><span class="hs-identifier hs-var">posttrans</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([a], [a]) -&gt; (t b, t c)
</span><a href="#local-6989586621684526690"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(([a], [a]) -&gt; (t b, t c)) -&gt; ([a], [a]) -&gt; (t b, t c)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [a] -&gt; ([a], [a])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526688"><span class="hs-identifier hs-var">r2</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684526686"><span class="hs-identifier hs-var">notmapped</span></a></span><span>
</span><span id="line-1424"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a] -&gt; a
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684526687"><span class="hs-identifier hs-var">mapped</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">t b -&gt; b
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">t b
</span><a href="#local-6989586621684526685"><span class="hs-identifier hs-var">pretrans</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">t c -&gt; c
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">t c
</span><a href="#local-6989586621684526684"><span class="hs-identifier hs-var">posttrans</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1425"></span><span>
</span><span id="line-1426"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#mapTransposeName"><span class="hs-identifier hs-type">mapTransposeName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-1427"></span><span id="mapTransposeName"><span class="annot"><span class="annottext">mapTransposeName :: PrimType -&gt; [Char]
</span><a href="Futhark.CodeGen.ImpGen.html#mapTransposeName"><span class="hs-identifier hs-var hs-var">mapTransposeName</span></a></span></span><span> </span><span id="local-6989586621684526681"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526681"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;map_transpose_&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526681"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1428"></span><span>
</span><span id="line-1429"></span><span id="local-6989586621684529532"><span id="local-6989586621684529533"><span id="local-6989586621684529534"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#mapTransposeForType"><span class="hs-identifier hs-type">mapTransposeForType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529534"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529533"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529532"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span></span></span></span><span>
</span><span id="line-1430"></span><span id="mapTransposeForType"><span class="annot"><span class="annottext">mapTransposeForType :: forall rep r op. PrimType -&gt; ImpM rep r op Name
</span><a href="Futhark.CodeGen.ImpGen.html#mapTransposeForType"><span class="hs-identifier hs-var hs-var">mapTransposeForType</span></a></span></span><span> </span><span id="local-6989586621684526673"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526673"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1431"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684526672"><span class="annot"><span class="annottext">fname :: Name
</span><a href="#local-6989586621684526672"><span class="hs-identifier hs-var hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; Name) -&gt; [Char] -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;builtin#&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; [Char]
</span><a href="Futhark.CodeGen.ImpGen.html#mapTransposeName"><span class="hs-identifier hs-var">mapTransposeName</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526673"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1432"></span><span>
</span><span id="line-1433"></span><span>  </span><span id="local-6989586621684526671"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684526671"><span class="hs-identifier hs-var">exists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ImpM rep r op Bool
forall rep r op. Name -&gt; ImpM rep r op Bool
</span><a href="Futhark.CodeGen.ImpGen.html#hasFunction"><span class="hs-identifier hs-var">hasFunction</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684526672"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-1434"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684526671"><span class="hs-identifier hs-var">exists</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Function op -&gt; ImpM rep r op ()
forall op rep r. Name -&gt; Function op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emitFunction"><span class="hs-identifier hs-var">emitFunction</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684526672"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">(Function op -&gt; ImpM rep r op ())
-&gt; Function op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; PrimType -&gt; Function op
forall op. Name -&gt; PrimType -&gt; Function op
</span><a href="Futhark.CodeGen.ImpGen.Transpose.html#mapTransposeFunction"><span class="hs-identifier hs-var">mapTransposeFunction</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684526672"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526673"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1435"></span><span>
</span><span id="line-1436"></span><span>  </span><span class="annot"><span class="annottext">Name -&gt; ImpM rep r op Name
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684526672"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-1437"></span><span>
</span><span id="line-1438"></span><span class="hs-comment">-- | Use an 'Imp.Copy' if possible, otherwise 'copyElementWise'.</span><span>
</span><span id="line-1439"></span><span id="local-6989586621684530633"><span id="local-6989586621684530634"><span id="local-6989586621684530635"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#defaultCopy"><span class="hs-identifier hs-type">defaultCopy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#CopyCompiler"><span class="hs-identifier hs-type">CopyCompiler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530635"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530634"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530633"><span class="hs-identifier hs-type">op</span></a></span></span></span></span><span>
</span><span id="line-1440"></span><span id="defaultCopy"><span class="annot"><span class="annottext">defaultCopy :: forall rep r op. CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#defaultCopy"><span class="hs-identifier hs-var hs-var">defaultCopy</span></a></span></span><span> </span><span id="local-6989586621684526655"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526655"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684526654"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526654"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span id="local-6989586621684526653"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526653"><span class="hs-identifier hs-var">src</span></a></span></span><span>
</span><span id="line-1441"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526652"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526652"><span class="hs-identifier hs-var">destoffset</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526651"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526651"><span class="hs-identifier hs-var">srcoffset</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526650"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526650"><span class="hs-identifier hs-var">num_arrays</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526649"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526649"><span class="hs-identifier hs-var">size_x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526648"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526648"><span class="hs-identifier hs-var">size_y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1442"></span><span>      </span><span class="annot"><span class="annottext">PrimType
-&gt; MemLoc
-&gt; MemLoc
-&gt; Maybe
     (TExp Int64, TExp Int64, TExp Int64, TExp Int64, TExp Int64)
</span><a href="Futhark.CodeGen.ImpGen.html#isMapTransposeCopy"><span class="hs-identifier hs-var">isMapTransposeCopy</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526655"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526654"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526653"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1443"></span><span>    </span><span id="local-6989586621684526647"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684526647"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ImpM rep r op Name
forall rep r op. PrimType -&gt; ImpM rep r op Name
</span><a href="Futhark.CodeGen.ImpGen.html#mapTransposeForType"><span class="hs-identifier hs-var">mapTransposeForType</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526655"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-1444"></span><span>    </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1445"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; Name -&gt; [Arg] -&gt; Code op
forall a. [VName] -&gt; Name -&gt; [Arg] -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Call"><span class="hs-identifier hs-var">Imp.Call</span></a></span><span>
</span><span id="line-1446"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1447"></span><span>        </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684526647"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-1448"></span><span>        </span><span class="annot"><span class="annottext">([Arg] -&gt; Code op) -&gt; [Arg] -&gt; Code op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType
-&gt; VName
-&gt; Count Bytes (TExp Int64)
-&gt; VName
-&gt; Count Bytes (TExp Int64)
-&gt; TExp Int64
-&gt; TExp Int64
-&gt; TExp Int64
-&gt; [Arg]
</span><a href="Futhark.CodeGen.ImpGen.Transpose.html#transposeArgs"><span class="hs-identifier hs-var">transposeArgs</span></a></span><span>
</span><span id="line-1449"></span><span>          </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526655"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-1450"></span><span>          </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526645"><span class="hs-identifier hs-var">destmem</span></a></span><span>
</span><span id="line-1451"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a. a -&gt; Count Bytes a
</span><a href="Futhark.CodeGen.ImpCode.html#bytes"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526652"><span class="hs-identifier hs-var">destoffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1452"></span><span>          </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526644"><span class="hs-identifier hs-var">srcmem</span></a></span><span>
</span><span id="line-1453"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a. a -&gt; Count Bytes a
</span><a href="Futhark.CodeGen.ImpCode.html#bytes"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526651"><span class="hs-identifier hs-var">srcoffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1454"></span><span>          </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526650"><span class="hs-identifier hs-var">num_arrays</span></a></span><span>
</span><span id="line-1455"></span><span>          </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526649"><span class="hs-identifier hs-var">size_x</span></a></span><span>
</span><span id="line-1456"></span><span>          </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526648"><span class="hs-identifier hs-var">size_y</span></a></span><span>
</span><span id="line-1457"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526643"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526643"><span class="hs-identifier hs-var">destoffset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1458"></span><span>      </span><span class="annot"><span class="annottext">IxFun (TExp Int64) -&gt; TExp Int64 -&gt; Maybe (TExp Int64)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; num -&gt; Maybe num
</span><a href="Futhark.IR.Mem.IxFun.html#linearWithOffset"><span class="hs-identifier hs-var">IxFun.linearWithOffset</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526642"><span class="hs-identifier hs-var">dest_ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526641"><span class="hs-identifier hs-var">pt_size</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1459"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526640"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526640"><span class="hs-identifier hs-var">srcoffset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1460"></span><span>      </span><span class="annot"><span class="annottext">IxFun (TExp Int64) -&gt; TExp Int64 -&gt; Maybe (TExp Int64)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; num -&gt; Maybe num
</span><a href="Futhark.IR.Mem.IxFun.html#linearWithOffset"><span class="hs-identifier hs-var">IxFun.linearWithOffset</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526639"><span class="hs-identifier hs-var">src_ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526641"><span class="hs-identifier hs-var">pt_size</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1461"></span><span>    </span><span id="local-6989586621684526638"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526638"><span class="hs-identifier hs-var">srcspace</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(MemEntry -&gt; Space)
-&gt; ImpM rep r op MemEntry -&gt; ImpM rep r op Space
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op MemEntry
forall rep r op. VName -&gt; ImpM rep r op MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier hs-var">lookupMemory</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526644"><span class="hs-identifier hs-var">srcmem</span></a></span><span>
</span><span id="line-1462"></span><span>    </span><span id="local-6989586621684526637"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526637"><span class="hs-identifier hs-var">destspace</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(MemEntry -&gt; Space)
-&gt; ImpM rep r op MemEntry -&gt; ImpM rep r op Space
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op MemEntry
forall rep r op. VName -&gt; ImpM rep r op MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier hs-var">lookupMemory</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526645"><span class="hs-identifier hs-var">destmem</span></a></span><span>
</span><span id="line-1463"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Space -&gt; Bool
</span><a href="#local-6989586621684526636"><span class="hs-identifier hs-var">isScalarSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526638"><span class="hs-identifier hs-var">srcspace</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; Bool
</span><a href="#local-6989586621684526636"><span class="hs-identifier hs-var">isScalarSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526637"><span class="hs-identifier hs-var">destspace</span></a></span><span>
</span><span id="line-1464"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">CopyCompiler rep r op
forall rep r op. CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#copyElementWise"><span class="hs-identifier hs-var">copyElementWise</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526655"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526654"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526653"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-1465"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-1466"></span><span>        </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1467"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; Count Bytes (TExp Int64)
-&gt; Space
-&gt; VName
-&gt; Count Bytes (TExp Int64)
-&gt; Space
-&gt; Count Bytes (TExp Int64)
-&gt; Code op
forall a.
VName
-&gt; Count Bytes (TExp Int64)
-&gt; Space
-&gt; VName
-&gt; Count Bytes (TExp Int64)
-&gt; Space
-&gt; Count Bytes (TExp Int64)
-&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Copy"><span class="hs-identifier hs-var">Imp.Copy</span></a></span><span>
</span><span id="line-1468"></span><span>            </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526645"><span class="hs-identifier hs-var">destmem</span></a></span><span>
</span><span id="line-1469"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a. a -&gt; Count Bytes a
</span><a href="Futhark.CodeGen.ImpCode.html#bytes"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526643"><span class="hs-identifier hs-var">destoffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1470"></span><span>            </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526637"><span class="hs-identifier hs-var">destspace</span></a></span><span>
</span><span id="line-1471"></span><span>            </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526644"><span class="hs-identifier hs-var">srcmem</span></a></span><span>
</span><span id="line-1472"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a. a -&gt; Count Bytes a
</span><a href="Futhark.CodeGen.ImpCode.html#bytes"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526640"><span class="hs-identifier hs-var">srcoffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1473"></span><span>            </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526638"><span class="hs-identifier hs-var">srcspace</span></a></span><span>
</span><span id="line-1474"></span><span>            </span><span class="annot"><span class="annottext">(Count Bytes (TExp Int64) -&gt; Code op)
-&gt; Count Bytes (TExp Int64) -&gt; Code op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526633"><span class="hs-identifier hs-var">num_elems</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64) -&gt; PrimType -&gt; Count Bytes (TExp Int64)
</span><a href="Futhark.CodeGen.ImpCode.html#withElemType"><span class="hs-operator hs-var">`withElemType`</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526655"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-1475"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1476"></span><span>    </span><span class="annot"><span class="annottext">CopyCompiler rep r op
forall rep r op. CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#copyElementWise"><span class="hs-identifier hs-var">copyElementWise</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526655"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526654"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526653"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-1477"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1478"></span><span>    </span><span id="local-6989586621684526641"><span class="annot"><span class="annottext">pt_size :: TExp Int64
</span><a href="#local-6989586621684526641"><span class="hs-identifier hs-var hs-var">pt_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TExp Int64
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526655"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-1479"></span><span>    </span><span id="local-6989586621684526633"><span class="annot"><span class="annottext">num_elems :: Count Elements (TExp Int64)
</span><a href="#local-6989586621684526633"><span class="hs-identifier hs-var hs-var">num_elems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Elements (TExp Int64)
forall a. a -&gt; Count Elements a
</span><a href="Futhark.CodeGen.ImpCode.html#elements"><span class="hs-identifier hs-var">Imp.elements</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; Count Elements (TExp Int64))
-&gt; TExp Int64 -&gt; Count Elements (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; TExp Int64) -&gt; [TExp Int64] -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64) -&gt; [TExp Int64]
forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#shape"><span class="hs-identifier hs-var">IxFun.shape</span></a></span><span> </span><span class="annot"><span class="annottext">(IxFun (TExp Int64) -&gt; [TExp Int64])
-&gt; IxFun (TExp Int64) -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MemLoc -&gt; IxFun (TExp Int64)
</span><a href="Futhark.CodeGen.ImpGen.html#memLocIxFun"><span class="hs-identifier hs-var hs-var">memLocIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526653"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-1480"></span><span>
</span><span id="line-1481"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span id="local-6989586621684526645"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526645"><span class="hs-identifier hs-var">destmem</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684526642"><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526642"><span class="hs-identifier hs-var">dest_ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526654"><span class="hs-identifier hs-var">dest</span></a></span><span>
</span><span id="line-1482"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span id="local-6989586621684526644"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526644"><span class="hs-identifier hs-var">srcmem</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684526639"><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526639"><span class="hs-identifier hs-var">src_ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526653"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-1483"></span><span>
</span><span id="line-1484"></span><span>    </span><span id="local-6989586621684526636"><span class="annot"><span class="annottext">isScalarSpace :: Space -&gt; Bool
</span><a href="#local-6989586621684526636"><span class="hs-identifier hs-var hs-var">isScalarSpace</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ScalarSpace"><span class="hs-identifier hs-type">ScalarSpace</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1485"></span><span>    </span><span class="annot"><a href="#local-6989586621684526636"><span class="hs-identifier hs-var">isScalarSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1486"></span><span>
</span><span id="line-1487"></span><span id="local-6989586621684526628"><span id="local-6989586621684526629"><span id="local-6989586621684526630"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#copyElementWise"><span class="hs-identifier hs-type">copyElementWise</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#CopyCompiler"><span class="hs-identifier hs-type">CopyCompiler</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526630"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526629"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526628"><span class="hs-identifier hs-type">op</span></a></span></span></span></span><span>
</span><span id="line-1488"></span><span id="copyElementWise"><span class="annot"><span class="annottext">copyElementWise :: forall rep r op. CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#copyElementWise"><span class="hs-identifier hs-var hs-var">copyElementWise</span></a></span></span><span> </span><span id="local-6989586621684526613"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526613"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span id="local-6989586621684526612"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526612"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span id="local-6989586621684526611"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526611"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1489"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684526610"><span class="annot"><span class="annottext">bounds :: [TExp Int64]
</span><a href="#local-6989586621684526610"><span class="hs-identifier hs-var hs-var">bounds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64) -&gt; [TExp Int64]
forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#shape"><span class="hs-identifier hs-var">IxFun.shape</span></a></span><span> </span><span class="annot"><span class="annottext">(IxFun (TExp Int64) -&gt; [TExp Int64])
-&gt; IxFun (TExp Int64) -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MemLoc -&gt; IxFun (TExp Int64)
</span><a href="Futhark.CodeGen.ImpGen.html#memLocIxFun"><span class="hs-identifier hs-var hs-var">memLocIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526611"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-1490"></span><span>  </span><span id="local-6989586621684526609"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684526609"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ImpM rep r op VName -&gt; ImpM rep r op [VName]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526610"><span class="hs-identifier hs-var">bounds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;i&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-1491"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684526608"><span class="annot"><span class="annottext">ivars :: [TExp Int64]
</span><a href="#local-6989586621684526608"><span class="hs-identifier hs-var hs-var">ivars</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684526609"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-1492"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684526607"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526607"><span class="hs-identifier hs-var">destmem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526606"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526606"><span class="hs-identifier hs-var">destspace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526605"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526605"><span class="hs-identifier hs-var">destidx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
forall rep r op.
MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray%27"><span class="hs-identifier hs-var">fullyIndexArray'</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526612"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526608"><span class="hs-identifier hs-var">ivars</span></a></span><span>
</span><span id="line-1493"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684526604"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526604"><span class="hs-identifier hs-var">srcmem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526603"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526603"><span class="hs-identifier hs-var">srcspace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526602"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526602"><span class="hs-identifier hs-var">srcidx</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
forall rep r op.
MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray%27"><span class="hs-identifier hs-var">fullyIndexArray'</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526611"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526608"><span class="hs-identifier hs-var">ivars</span></a></span><span>
</span><span id="line-1494"></span><span>  </span><span id="local-6989586621684526601"><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526601"><span class="hs-identifier hs-var">vol</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Volatility) -&gt; ImpM rep r op Volatility
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; Volatility
forall rep r op. Env rep r op -&gt; Volatility
</span><a href="Futhark.CodeGen.ImpGen.html#envVolatility"><span class="hs-identifier hs-var hs-var">envVolatility</span></a></span><span>
</span><span id="line-1495"></span><span>  </span><span id="local-6989586621684526600"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526600"><span class="hs-identifier hs-var">tmp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;tmp&quot;</span></span><span>
</span><span id="line-1496"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1497"></span><span>    </span><span class="annot"><span class="annottext">((Code op -&gt; Code op)
 -&gt; (Code op -&gt; Code op) -&gt; Code op -&gt; Code op)
-&gt; (Code op -&gt; Code op)
-&gt; [Code op -&gt; Code op]
-&gt; Code op
-&gt; Code op
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; Code op) -&gt; (Code op -&gt; Code op) -&gt; Code op -&gt; Code op
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">(.)</span></span><span> </span><span class="annot"><span class="annottext">Code op -&gt; Code op
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; PrimExp VName -&gt; Code op -&gt; Code op)
-&gt; [VName] -&gt; [PrimExp VName] -&gt; [Code op -&gt; Code op]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; Code op -&gt; Code op
forall a. VName -&gt; PrimExp VName -&gt; Code a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#For"><span class="hs-identifier hs-var">Imp.For</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684526609"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">([PrimExp VName] -&gt; [Code op -&gt; Code op])
-&gt; [PrimExp VName] -&gt; [Code op -&gt; Code op]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; PrimExp VName) -&gt; [TExp Int64] -&gt; [PrimExp VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526610"><span class="hs-identifier hs-var">bounds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; Code op) -&gt; Code op -&gt; Code op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1498"></span><span>      </span><span class="annot"><span class="annottext">[Code op] -&gt; Code op
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span>
</span><span id="line-1499"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Volatility -&gt; PrimType -&gt; Code op
forall a. VName -&gt; Volatility -&gt; PrimType -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DeclareScalar"><span class="hs-identifier hs-var">Imp.DeclareScalar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526600"><span class="hs-identifier hs-var">tmp</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526601"><span class="hs-identifier hs-var">vol</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526613"><span class="hs-identifier hs-var">bt</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1500"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; Code op
forall a.
VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Read"><span class="hs-identifier hs-var">Imp.Read</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526600"><span class="hs-identifier hs-var">tmp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526604"><span class="hs-identifier hs-var">srcmem</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526602"><span class="hs-identifier hs-var">srcidx</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526613"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526603"><span class="hs-identifier hs-var">srcspace</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526601"><span class="hs-identifier hs-var">vol</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1501"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; PrimExp VName
-&gt; Code op
forall a.
VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; PrimExp VName
-&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Write"><span class="hs-identifier hs-var">Imp.Write</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526607"><span class="hs-identifier hs-var">destmem</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526605"><span class="hs-identifier hs-var">destidx</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526613"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526606"><span class="hs-identifier hs-var">destspace</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526601"><span class="hs-identifier hs-var">vol</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Code op) -&gt; PrimExp VName -&gt; Code op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526600"><span class="hs-identifier hs-var">tmp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526613"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1502"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-1503"></span><span>
</span><span id="line-1504"></span><span class="hs-comment">-- | Copy from here to there; both destination and source may be</span><span>
</span><span id="line-1505"></span><span class="hs-comment">-- indexeded.</span><span>
</span><span id="line-1506"></span><span id="local-6989586621684529516"><span id="local-6989586621684529517"><span id="local-6989586621684529518"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#copyArrayDWIM"><span class="hs-identifier hs-type">copyArrayDWIM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1507"></span><span>  </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1508"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1509"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimIndex"><span class="hs-identifier hs-type">DimIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1510"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1511"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimIndex"><span class="hs-identifier hs-type">DimIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1512"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529518"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529517"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529516"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529516"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1513"></span><span id="copyArrayDWIM"><span class="annot"><span class="annottext">copyArrayDWIM :: forall rep r op.
PrimType
-&gt; MemLoc
-&gt; [DimIndex (TExp Int64)]
-&gt; MemLoc
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#copyArrayDWIM"><span class="hs-identifier hs-var hs-var">copyArrayDWIM</span></a></span></span><span>
</span><span id="line-1514"></span><span>  </span><span id="local-6989586621684526557"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526557"><span class="hs-identifier hs-var">bt</span></a></span></span><span>
</span><span id="line-1515"></span><span>  </span><span id="local-6989586621684526556"><span class="annot"><span class="annottext">destlocation :: MemLoc
</span><a href="#local-6989586621684526556"><span class="hs-identifier hs-var">destlocation</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684526555"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684526555"><span class="hs-identifier hs-var">destshape</span></a></span></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1516"></span><span>  </span><span id="local-6989586621684526554"><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526554"><span class="hs-identifier hs-var">destslice</span></a></span></span><span>
</span><span id="line-1517"></span><span>  </span><span id="local-6989586621684526553"><span class="annot"><span class="annottext">srclocation :: MemLoc
</span><a href="#local-6989586621684526553"><span class="hs-identifier hs-var">srclocation</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684526552"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684526552"><span class="hs-identifier hs-var">srcshape</span></a></span></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1518"></span><span>  </span><span id="local-6989586621684526551"><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526551"><span class="hs-identifier hs-var">srcslice</span></a></span></span><span>
</span><span id="line-1519"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526550"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526550"><span class="hs-identifier hs-var">destis</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DimIndex (TExp Int64) -&gt; Maybe (TExp Int64))
-&gt; [DimIndex (TExp Int64)] -&gt; Maybe [TExp Int64]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DimIndex (TExp Int64) -&gt; Maybe (TExp Int64)
forall d. DimIndex d -&gt; Maybe d
</span><a href="Futhark.IR.Syntax.Core.html#dimFix"><span class="hs-identifier hs-var">dimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526554"><span class="hs-identifier hs-var">destslice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1520"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526548"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526548"><span class="hs-identifier hs-var">srcis</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DimIndex (TExp Int64) -&gt; Maybe (TExp Int64))
-&gt; [DimIndex (TExp Int64)] -&gt; Maybe [TExp Int64]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DimIndex (TExp Int64) -&gt; Maybe (TExp Int64)
forall d. DimIndex d -&gt; Maybe d
</span><a href="Futhark.IR.Syntax.Core.html#dimFix"><span class="hs-identifier hs-var">dimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526551"><span class="hs-identifier hs-var">srcslice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1521"></span><span>      </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526548"><span class="hs-identifier hs-var">srcis</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684526552"><span class="hs-identifier hs-var">srcshape</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1522"></span><span>      </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526550"><span class="hs-identifier hs-var">destis</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684526555"><span class="hs-identifier hs-var">destshape</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1523"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684526547"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526547"><span class="hs-identifier hs-var">targetmem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526546"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526546"><span class="hs-identifier hs-var">destspace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526545"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526545"><span class="hs-identifier hs-var">targetoffset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1524"></span><span>        </span><span class="annot"><span class="annottext">MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
forall rep r op.
MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray%27"><span class="hs-identifier hs-var">fullyIndexArray'</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526556"><span class="hs-identifier hs-var">destlocation</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526550"><span class="hs-identifier hs-var">destis</span></a></span><span>
</span><span id="line-1525"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684526544"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526544"><span class="hs-identifier hs-var">srcmem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526543"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526543"><span class="hs-identifier hs-var">srcspace</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526542"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526542"><span class="hs-identifier hs-var">srcoffset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1526"></span><span>        </span><span class="annot"><span class="annottext">MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
forall rep r op.
MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray%27"><span class="hs-identifier hs-var">fullyIndexArray'</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526553"><span class="hs-identifier hs-var">srclocation</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526548"><span class="hs-identifier hs-var">srcis</span></a></span><span>
</span><span id="line-1527"></span><span>      </span><span id="local-6989586621684526541"><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526541"><span class="hs-identifier hs-var">vol</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Volatility) -&gt; ImpM rep r op Volatility
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; Volatility
forall rep r op. Env rep r op -&gt; Volatility
</span><a href="Futhark.CodeGen.ImpGen.html#envVolatility"><span class="hs-identifier hs-var hs-var">envVolatility</span></a></span><span>
</span><span id="line-1528"></span><span>      </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op (Code op))
-&gt; ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1529"></span><span>        </span><span id="local-6989586621684526540"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526540"><span class="hs-identifier hs-var">tmp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">(TV Any -&gt; VName) -&gt; ImpM rep r op (TV Any) -&gt; ImpM rep r op VName
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; PrimType -&gt; ImpM rep r op (TV Any)
forall rep r op t. [Char] -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;tmp&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526557"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1530"></span><span>        </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; Code op
forall a.
VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Read"><span class="hs-identifier hs-var">Imp.Read</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526540"><span class="hs-identifier hs-var">tmp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526544"><span class="hs-identifier hs-var">srcmem</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526542"><span class="hs-identifier hs-var">srcoffset</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526557"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526543"><span class="hs-identifier hs-var">srcspace</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526541"><span class="hs-identifier hs-var">vol</span></a></span><span>
</span><span id="line-1531"></span><span>        </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; PrimExp VName
-&gt; Code op
forall a.
VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; PrimExp VName
-&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Write"><span class="hs-identifier hs-var">Imp.Write</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526547"><span class="hs-identifier hs-var">targetmem</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526545"><span class="hs-identifier hs-var">targetoffset</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526557"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526546"><span class="hs-identifier hs-var">destspace</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526541"><span class="hs-identifier hs-var">vol</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Code op) -&gt; PrimExp VName -&gt; Code op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526540"><span class="hs-identifier hs-var">tmp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526557"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1532"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1533"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684526539"><span class="annot"><span class="annottext">destslice' :: Slice (TExp Int64)
</span><a href="#local-6989586621684526539"><span class="hs-identifier hs-var hs-var">destslice'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall d. Num d =&gt; [d] -&gt; [DimIndex d] -&gt; Slice d
</span><a href="Futhark.Construct.html#fullSliceNum"><span class="hs-identifier hs-var">fullSliceNum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684526555"><span class="hs-identifier hs-var">destshape</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526554"><span class="hs-identifier hs-var">destslice</span></a></span><span>
</span><span id="line-1534"></span><span>          </span><span id="local-6989586621684526537"><span class="annot"><span class="annottext">srcslice' :: Slice (TExp Int64)
</span><a href="#local-6989586621684526537"><span class="hs-identifier hs-var hs-var">srcslice'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall d. Num d =&gt; [d] -&gt; [DimIndex d] -&gt; Slice d
</span><a href="Futhark.Construct.html#fullSliceNum"><span class="hs-identifier hs-var">fullSliceNum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684526552"><span class="hs-identifier hs-var">srcshape</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526551"><span class="hs-identifier hs-var">srcslice</span></a></span><span>
</span><span id="line-1535"></span><span>          </span><span id="local-6989586621684526536"><span class="annot"><span class="annottext">destrank :: Int
</span><a href="#local-6989586621684526536"><span class="hs-identifier hs-var hs-var">destrank</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; Int) -&gt; [TExp Int64] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [TExp Int64]
forall d. Slice d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#sliceDims"><span class="hs-identifier hs-var">sliceDims</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684526539"><span class="hs-identifier hs-var">destslice'</span></a></span><span>
</span><span id="line-1536"></span><span>          </span><span id="local-6989586621684526534"><span class="annot"><span class="annottext">srcrank :: Int
</span><a href="#local-6989586621684526534"><span class="hs-identifier hs-var hs-var">srcrank</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; Int) -&gt; [TExp Int64] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [TExp Int64]
forall d. Slice d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#sliceDims"><span class="hs-identifier hs-var">sliceDims</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684526537"><span class="hs-identifier hs-var">srcslice'</span></a></span><span>
</span><span id="line-1537"></span><span>          </span><span id="local-6989586621684526533"><span class="annot"><span class="annottext">destlocation' :: MemLoc
</span><a href="#local-6989586621684526533"><span class="hs-identifier hs-var hs-var">destlocation'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemLoc -&gt; Slice (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#sliceMemLoc"><span class="hs-identifier hs-var">sliceMemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526556"><span class="hs-identifier hs-var">destlocation</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684526539"><span class="hs-identifier hs-var">destslice'</span></a></span><span>
</span><span id="line-1538"></span><span>          </span><span id="local-6989586621684526532"><span class="annot"><span class="annottext">srclocation' :: MemLoc
</span><a href="#local-6989586621684526532"><span class="hs-identifier hs-var hs-var">srclocation'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemLoc -&gt; Slice (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#sliceMemLoc"><span class="hs-identifier hs-var">sliceMemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526553"><span class="hs-identifier hs-var">srclocation</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684526537"><span class="hs-identifier hs-var">srcslice'</span></a></span><span>
</span><span id="line-1539"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526536"><span class="hs-identifier hs-var">destrank</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526534"><span class="hs-identifier hs-var">srcrank</span></a></span><span>
</span><span id="line-1540"></span><span>        </span><span class="hs-keyword">then</span><span>
</span><span id="line-1541"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op (Code op)
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op (Code op))
-&gt; [Char] -&gt; ImpM rep r op (Code op)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1542"></span><span>            </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;copyArrayDWIM: cannot copy to &quot;</span></span><span>
</span><span id="line-1543"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#memLocName"><span class="hs-identifier hs-var hs-var">memLocName</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526556"><span class="hs-identifier hs-var">destlocation</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1544"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; from &quot;</span></span><span>
</span><span id="line-1545"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#memLocName"><span class="hs-identifier hs-var hs-var">memLocName</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526553"><span class="hs-identifier hs-var">srclocation</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1546"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; because ranks do not match (&quot;</span></span><span>
</span><span id="line-1547"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526536"><span class="hs-identifier hs-var">destrank</span></a></span><span>
</span><span id="line-1548"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; vs &quot;</span></span><span>
</span><span id="line-1549"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526534"><span class="hs-identifier hs-var">srcrank</span></a></span><span>
</span><span id="line-1550"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-1551"></span><span>        </span><span class="hs-keyword">else</span><span>
</span><span id="line-1552"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526533"><span class="hs-identifier hs-var">destlocation'</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc -&gt; MemLoc -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526532"><span class="hs-identifier hs-var">srclocation'</span></a></span><span>
</span><span id="line-1553"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op (Code op)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Code op
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-comment">-- Copy would be no-op.</span><span>
</span><span id="line-1554"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op (Code op))
-&gt; ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CopyCompiler rep r op
forall rep r op. CopyCompiler rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#copy"><span class="hs-identifier hs-var">copy</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526557"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526533"><span class="hs-identifier hs-var">destlocation'</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526532"><span class="hs-identifier hs-var">srclocation'</span></a></span><span>
</span><span id="line-1555"></span><span>
</span><span id="line-1556"></span><span class="hs-comment">-- | Like 'copyDWIM', but the target is a 'ValueDestination'</span><span>
</span><span id="line-1557"></span><span class="hs-comment">-- instead of a variable name.</span><span>
</span><span id="line-1558"></span><span id="local-6989586621684530075"><span id="local-6989586621684530076"><span id="local-6989586621684530077"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#copyDWIMDest"><span class="hs-identifier hs-type">copyDWIMDest</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1559"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ValueDestination"><span class="hs-identifier hs-type">ValueDestination</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1560"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimIndex"><span class="hs-identifier hs-type">DimIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1561"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1562"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimIndex"><span class="hs-identifier hs-type">DimIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1563"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530077"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530076"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530075"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1564"></span><span id="copyDWIMDest"><span class="annot"><span class="annottext">copyDWIMDest :: forall rep r op.
ValueDestination
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMDest"><span class="hs-identifier hs-var hs-var">copyDWIMDest</span></a></span></span><span> </span><span class="annot"><span class="annottext">ValueDestination
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684526460"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684526460"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DimIndex (TExp Int64)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1565"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op ()) -&gt; [Char] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1566"></span><span>    </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;copyDWIMDest: constant source&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684526460"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;cannot be indexed.&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-1567"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#copyDWIMDest"><span class="hs-identifier hs-var">copyDWIMDest</span></a></span><span> </span><span id="local-6989586621684526458"><span class="annot"><span class="annottext">ValueDestination
</span><a href="#local-6989586621684526458"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684526457"><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526457"><span class="hs-identifier hs-var">dest_slice</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684526456"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684526456"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1568"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(DimIndex (TExp Int64) -&gt; Maybe (TExp Int64))
-&gt; [DimIndex (TExp Int64)] -&gt; Maybe [TExp Int64]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DimIndex (TExp Int64) -&gt; Maybe (TExp Int64)
forall d. DimIndex d -&gt; Maybe d
</span><a href="Futhark.IR.Syntax.Core.html#dimFix"><span class="hs-identifier hs-var">dimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526457"><span class="hs-identifier hs-var">dest_slice</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1569"></span><span>    </span><span class="annot"><span class="annottext">Maybe [TExp Int64]
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1570"></span><span>      </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op ()) -&gt; [Char] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1571"></span><span>        </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;copyDWIMDest: constant source&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684526456"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;with slice destination.&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-1572"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526455"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526455"><span class="hs-identifier hs-var">dest_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1573"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ValueDestination
</span><a href="#local-6989586621684526458"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1574"></span><span>        </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarDestination"><span class="hs-identifier hs-type">ScalarDestination</span></a></span><span> </span><span id="local-6989586621684526454"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526454"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1575"></span><span>          </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; Code op
forall a. VName -&gt; PrimExp VName -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#SetScalar"><span class="hs-identifier hs-var">Imp.SetScalar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526454"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Code op) -&gt; PrimExp VName -&gt; Code op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; PrimExp VName
forall v. PrimValue -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#ValueExp"><span class="hs-identifier hs-var">Imp.ValueExp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684526456"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1576"></span><span>        </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemoryDestination"><span class="hs-identifier hs-type">MemoryDestination</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1577"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op ()) -&gt; [Char] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1578"></span><span>            </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;copyDWIMDest: constant source&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684526456"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;cannot be written to memory destination.&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-1579"></span><span>        </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDestination"><span class="hs-identifier hs-type">ArrayDestination</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526453"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526453"><span class="hs-identifier hs-var">dest_loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1580"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684526452"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526452"><span class="hs-identifier hs-var">dest_mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526451"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526451"><span class="hs-identifier hs-var">dest_space</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526450"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526450"><span class="hs-identifier hs-var">dest_i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1581"></span><span>            </span><span class="annot"><span class="annottext">MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
forall rep r op.
MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray%27"><span class="hs-identifier hs-var">fullyIndexArray'</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526453"><span class="hs-identifier hs-var">dest_loc</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526455"><span class="hs-identifier hs-var">dest_is</span></a></span><span>
</span><span id="line-1582"></span><span>          </span><span id="local-6989586621684526449"><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526449"><span class="hs-identifier hs-var">vol</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Volatility) -&gt; ImpM rep r op Volatility
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; Volatility
forall rep r op. Env rep r op -&gt; Volatility
</span><a href="Futhark.CodeGen.ImpGen.html#envVolatility"><span class="hs-identifier hs-var hs-var">envVolatility</span></a></span><span>
</span><span id="line-1583"></span><span>          </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; PrimExp VName
-&gt; Code op
forall a.
VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; PrimExp VName
-&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Write"><span class="hs-identifier hs-var">Imp.Write</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526452"><span class="hs-identifier hs-var">dest_mem</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526450"><span class="hs-identifier hs-var">dest_i</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526448"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526451"><span class="hs-identifier hs-var">dest_space</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526449"><span class="hs-identifier hs-var">vol</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Code op) -&gt; PrimExp VName -&gt; Code op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; PrimExp VName
forall v. PrimValue -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#ValueExp"><span class="hs-identifier hs-var">Imp.ValueExp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684526456"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1584"></span><span>        </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDestination"><span class="hs-identifier hs-type">ArrayDestination</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe MemLoc
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1585"></span><span>          </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;copyDWIMDest: ArrayDestination Nothing&quot;</span></span><span>
</span><span id="line-1586"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1587"></span><span>    </span><span id="local-6989586621684526448"><span class="annot"><span class="annottext">bt :: PrimType
</span><a href="#local-6989586621684526448"><span class="hs-identifier hs-var hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#primValueType"><span class="hs-identifier hs-var">primValueType</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684526456"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1588"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#copyDWIMDest"><span class="hs-identifier hs-var">copyDWIMDest</span></a></span><span> </span><span id="local-6989586621684526447"><span class="annot"><span class="annottext">ValueDestination
</span><a href="#local-6989586621684526447"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span id="local-6989586621684526446"><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526446"><span class="hs-identifier hs-var">dest_slice</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684526445"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526445"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684526444"><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526444"><span class="hs-identifier hs-var">src_slice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1589"></span><span>  </span><span id="local-6989586621684526443"><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526443"><span class="hs-identifier hs-var">src_entry</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op (VarEntry rep)
forall rep r op. VName -&gt; ImpM rep r op (VarEntry rep)
</span><a href="Futhark.CodeGen.ImpGen.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526445"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-1590"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValueDestination
</span><a href="#local-6989586621684526447"><span class="hs-identifier hs-var">dest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526443"><span class="hs-identifier hs-var">src_entry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1591"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemoryDestination"><span class="hs-identifier hs-type">MemoryDestination</span></a></span><span> </span><span id="local-6989586621684526442"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526442"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-type">MemVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemEntry"><span class="hs-identifier hs-type">MemEntry</span></a></span><span> </span><span id="local-6989586621684526441"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526441"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1592"></span><span>      </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Space -&gt; Code op
forall a. VName -&gt; VName -&gt; Space -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#SetMem"><span class="hs-identifier hs-var">Imp.SetMem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526442"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526445"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526441"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1593"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemoryDestination"><span class="hs-identifier hs-type">MemoryDestination</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarEntry rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1594"></span><span>      </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op ()) -&gt; [Char] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1595"></span><span>        </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;copyDWIMDest: cannot write&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526445"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;to memory destination.&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-1596"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValueDestination
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-type">MemVar</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1597"></span><span>      </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op ()) -&gt; [Char] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1598"></span><span>        </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;copyDWIMDest: source&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526445"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;is a memory block.&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-1599"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValueDestination
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-type">ScalarVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarEntry"><span class="hs-identifier hs-type">ScalarEntry</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1600"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526444"><span class="hs-identifier hs-var">src_slice</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1601"></span><span>        </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op ()) -&gt; [Char] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1602"></span><span>          </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;copyDWIMDest: prim-typed source&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526445"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;with slice&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526444"><span class="hs-identifier hs-var">src_slice</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1603"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarDestination"><span class="hs-identifier hs-type">ScalarDestination</span></a></span><span> </span><span id="local-6989586621684526439"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526439"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarEntry rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1604"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526446"><span class="hs-identifier hs-var">dest_slice</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1605"></span><span>        </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op ()) -&gt; [Char] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1606"></span><span>          </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
</span><span class="hs-identifier hs-var">unwords</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;copyDWIMDest: prim-typed target&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526439"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;with slice&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526446"><span class="hs-identifier hs-var">dest_slice</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1607"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarDestination"><span class="hs-identifier hs-type">ScalarDestination</span></a></span><span> </span><span id="local-6989586621684526438"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526438"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-type">ScalarVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarEntry"><span class="hs-identifier hs-type">ScalarEntry</span></a></span><span> </span><span id="local-6989586621684526437"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526437"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1608"></span><span>      </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; Code op
forall a. VName -&gt; PrimExp VName -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#SetScalar"><span class="hs-identifier hs-var">Imp.SetScalar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526438"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Code op) -&gt; PrimExp VName -&gt; Code op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526445"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526437"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-1609"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarDestination"><span class="hs-identifier hs-type">ScalarDestination</span></a></span><span> </span><span id="local-6989586621684526436"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526436"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayVar"><span class="hs-identifier hs-type">ArrayVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684526435"><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684526435"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1610"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526434"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526434"><span class="hs-identifier hs-var">src_is</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DimIndex (TExp Int64) -&gt; Maybe (TExp Int64))
-&gt; [DimIndex (TExp Int64)] -&gt; Maybe [TExp Int64]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DimIndex (TExp Int64) -&gt; Maybe (TExp Int64)
forall d. DimIndex d -&gt; Maybe d
</span><a href="Futhark.IR.Syntax.Core.html#dimFix"><span class="hs-identifier hs-var">dimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526444"><span class="hs-identifier hs-var">src_slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1611"></span><span>        </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526444"><span class="hs-identifier hs-var">src_slice</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayEntry -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayShape"><span class="hs-identifier hs-var">entryArrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684526435"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1612"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684526433"><span class="annot"><span class="annottext">bt :: PrimType
</span><a href="#local-6989586621684526433"><span class="hs-identifier hs-var hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayEntry -&gt; PrimType
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayElemType"><span class="hs-identifier hs-var hs-var">entryArrayElemType</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684526435"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-1613"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684526432"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526432"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526431"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526431"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526430"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526430"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1614"></span><span>          </span><span class="annot"><span class="annottext">MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
forall rep r op.
MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray%27"><span class="hs-identifier hs-var">fullyIndexArray'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayEntry -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var hs-var">entryArrayLoc</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684526435"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526434"><span class="hs-identifier hs-var">src_is</span></a></span><span>
</span><span id="line-1615"></span><span>        </span><span id="local-6989586621684526429"><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526429"><span class="hs-identifier hs-var">vol</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Volatility) -&gt; ImpM rep r op Volatility
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; Volatility
forall rep r op. Env rep r op -&gt; Volatility
</span><a href="Futhark.CodeGen.ImpGen.html#envVolatility"><span class="hs-identifier hs-var hs-var">envVolatility</span></a></span><span>
</span><span id="line-1616"></span><span>        </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; Code op
forall a.
VName
-&gt; VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Read"><span class="hs-identifier hs-var">Imp.Read</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526436"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526432"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526430"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526433"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526431"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526429"><span class="hs-identifier hs-var">vol</span></a></span><span>
</span><span id="line-1617"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1618"></span><span>        </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op ()) -&gt; [Char] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1619"></span><span>          </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
</span><span class="hs-identifier hs-var">unwords</span></span><span>
</span><span id="line-1620"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;copyDWIMDest: prim-typed target&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-1621"></span><span>              </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526436"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1622"></span><span>              </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;and array-typed source&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-1623"></span><span>              </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526445"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1624"></span><span>              </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;of shape&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-1625"></span><span>              </span><span class="annot"><span class="annottext">[SubExp] -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ArrayEntry -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayShape"><span class="hs-identifier hs-var">entryArrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684526435"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1626"></span><span>              </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;sliced with&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-1627"></span><span>              </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526444"><span class="hs-identifier hs-var">src_slice</span></a></span><span>
</span><span id="line-1628"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-1629"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDestination"><span class="hs-identifier hs-type">ArrayDestination</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526428"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526428"><span class="hs-identifier hs-var">dest_loc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayVar"><span class="hs-identifier hs-type">ArrayVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684526427"><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684526427"><span class="hs-identifier hs-var">src_arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1630"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684526426"><span class="annot"><span class="annottext">src_loc :: MemLoc
</span><a href="#local-6989586621684526426"><span class="hs-identifier hs-var hs-var">src_loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayEntry -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayLoc"><span class="hs-identifier hs-var hs-var">entryArrayLoc</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684526427"><span class="hs-identifier hs-var">src_arr</span></a></span><span>
</span><span id="line-1631"></span><span>          </span><span id="local-6989586621684526425"><span class="annot"><span class="annottext">bt :: PrimType
</span><a href="#local-6989586621684526425"><span class="hs-identifier hs-var hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ArrayEntry -&gt; PrimType
</span><a href="Futhark.CodeGen.ImpGen.html#entryArrayElemType"><span class="hs-identifier hs-var hs-var">entryArrayElemType</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayEntry
</span><a href="#local-6989586621684526427"><span class="hs-identifier hs-var">src_arr</span></a></span><span>
</span><span id="line-1632"></span><span>      </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ())
-&gt; ImpM rep r op (Code op) -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
-&gt; MemLoc
-&gt; [DimIndex (TExp Int64)]
-&gt; MemLoc
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op (Code op)
forall rep r op.
PrimType
-&gt; MemLoc
-&gt; [DimIndex (TExp Int64)]
-&gt; MemLoc
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#copyArrayDWIM"><span class="hs-identifier hs-var">copyArrayDWIM</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526425"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526428"><span class="hs-identifier hs-var">dest_loc</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526446"><span class="hs-identifier hs-var">dest_slice</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526426"><span class="hs-identifier hs-var">src_loc</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526444"><span class="hs-identifier hs-var">src_slice</span></a></span><span>
</span><span id="line-1633"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDestination"><span class="hs-identifier hs-type">ArrayDestination</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526423"><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526423"><span class="hs-identifier hs-var">dest_loc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-type">ScalarVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarEntry"><span class="hs-identifier hs-type">ScalarEntry</span></a></span><span> </span><span id="local-6989586621684526422"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526422"><span class="hs-identifier hs-var">bt</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1634"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526421"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526421"><span class="hs-identifier hs-var">dest_is</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DimIndex (TExp Int64) -&gt; Maybe (TExp Int64))
-&gt; [DimIndex (TExp Int64)] -&gt; Maybe [TExp Int64]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DimIndex (TExp Int64) -&gt; Maybe (TExp Int64)
forall d. DimIndex d -&gt; Maybe d
</span><a href="Futhark.IR.Syntax.Core.html#dimFix"><span class="hs-identifier hs-var">dimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526446"><span class="hs-identifier hs-var">dest_slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1635"></span><span>        </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526421"><span class="hs-identifier hs-var">dest_is</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemLoc -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.html#memLocShape"><span class="hs-identifier hs-var hs-var">memLocShape</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526423"><span class="hs-identifier hs-var">dest_loc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1636"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684526420"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526420"><span class="hs-identifier hs-var">dest_mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526419"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526419"><span class="hs-identifier hs-var">dest_space</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526418"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526418"><span class="hs-identifier hs-var">dest_i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
forall rep r op.
MemLoc
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray%27"><span class="hs-identifier hs-var">fullyIndexArray'</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684526423"><span class="hs-identifier hs-var">dest_loc</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526421"><span class="hs-identifier hs-var">dest_is</span></a></span><span>
</span><span id="line-1637"></span><span>        </span><span id="local-6989586621684526417"><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526417"><span class="hs-identifier hs-var">vol</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Volatility) -&gt; ImpM rep r op Volatility
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; Volatility
forall rep r op. Env rep r op -&gt; Volatility
</span><a href="Futhark.CodeGen.ImpGen.html#envVolatility"><span class="hs-identifier hs-var hs-var">envVolatility</span></a></span><span>
</span><span id="line-1638"></span><span>        </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; PrimExp VName
-&gt; Code op
forall a.
VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; PrimExp VName
-&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Write"><span class="hs-identifier hs-var">Imp.Write</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526420"><span class="hs-identifier hs-var">dest_mem</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526418"><span class="hs-identifier hs-var">dest_i</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526422"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526419"><span class="hs-identifier hs-var">dest_space</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526417"><span class="hs-identifier hs-var">vol</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526445"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526422"><span class="hs-identifier hs-var">bt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1639"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1640"></span><span>        </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op ()) -&gt; [Char] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1641"></span><span>          </span><span class="annot"><span class="annottext">[[Char]] -&gt; [Char]
</span><span class="hs-identifier hs-var">unwords</span></span><span>
</span><span id="line-1642"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;copyDWIMDest: array-typed target and prim-typed source&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-1643"></span><span>              </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526445"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1644"></span><span>              </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;with slice&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-1645"></span><span>              </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526446"><span class="hs-identifier hs-var">dest_slice</span></a></span><span>
</span><span id="line-1646"></span><span>            </span><span class="hs-special">]</span><span>
</span><span id="line-1647"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayDestination"><span class="hs-identifier hs-type">ArrayDestination</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe MemLoc
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VarEntry rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1648"></span><span>      </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Nothing to do; something else set some memory</span><span>
</span><span id="line-1649"></span><span>      </span><span class="hs-comment">-- somewhere.</span><span>
</span><span id="line-1650"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValueDestination
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#AccVar"><span class="hs-identifier hs-type">AccVar</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1651"></span><span>      </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Nothing to do; accumulators are phantoms.</span><span>
</span><span id="line-1652"></span><span>
</span><span id="line-1653"></span><span class="hs-comment">-- | Copy from here to there; both destination and source be</span><span>
</span><span id="line-1654"></span><span class="hs-comment">-- indexeded.  If so, they better be arrays of enough dimensions.</span><span>
</span><span id="line-1655"></span><span class="hs-comment">-- This function will generally just Do What I Mean, and Do The Right</span><span>
</span><span id="line-1656"></span><span class="hs-comment">-- Thing.  Both destination and source must be in scope.</span><span>
</span><span id="line-1657"></span><span id="local-6989586621684530054"><span id="local-6989586621684530055"><span id="local-6989586621684530056"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-type">copyDWIM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1658"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1659"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimIndex"><span class="hs-identifier hs-type">DimIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1660"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1661"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimIndex"><span class="hs-identifier hs-type">DimIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1662"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530056"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530055"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684530054"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1663"></span><span id="copyDWIM"><span class="annot"><span class="annottext">copyDWIM :: forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var hs-var">copyDWIM</span></a></span></span><span> </span><span id="local-6989586621684526415"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526415"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span id="local-6989586621684526414"><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526414"><span class="hs-identifier hs-var">dest_slice</span></a></span></span><span> </span><span id="local-6989586621684526413"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684526413"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621684526412"><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526412"><span class="hs-identifier hs-var">src_slice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1664"></span><span>  </span><span id="local-6989586621684526411"><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526411"><span class="hs-identifier hs-var">dest_entry</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op (VarEntry rep)
forall rep r op. VName -&gt; ImpM rep r op (VarEntry rep)
</span><a href="Futhark.CodeGen.ImpGen.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526415"><span class="hs-identifier hs-var">dest</span></a></span><span>
</span><span id="line-1665"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684526410"><span class="annot"><span class="annottext">dest_target :: ValueDestination
</span><a href="#local-6989586621684526410"><span class="hs-identifier hs-var hs-var">dest_target</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1666"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VarEntry rep
</span><a href="#local-6989586621684526411"><span class="hs-identifier hs-var">dest_entry</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1667"></span><span>          </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-type">ScalarVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ScalarEntry
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1668"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; ValueDestination
</span><a href="Futhark.CodeGen.ImpGen.html#ScalarDestination"><span class="hs-identifier hs-var">ScalarDestination</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526415"><span class="hs-identifier hs-var">dest</span></a></span><span>
</span><span id="line-1669"></span><span>          </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayVar"><span class="hs-identifier hs-type">ArrayVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ArrayEntry"><span class="hs-identifier hs-type">ArrayEntry</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span id="local-6989586621684526409"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526409"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684526408"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684526408"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684526407"><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526407"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1670"></span><span>            </span><span class="annot"><span class="annottext">Maybe MemLoc -&gt; ValueDestination
</span><a href="Futhark.CodeGen.ImpGen.html#ArrayDestination"><span class="hs-identifier hs-var">ArrayDestination</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe MemLoc -&gt; ValueDestination)
-&gt; Maybe MemLoc -&gt; ValueDestination
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MemLoc -&gt; Maybe MemLoc
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(MemLoc -&gt; Maybe MemLoc) -&gt; MemLoc -&gt; Maybe MemLoc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [SubExp] -&gt; IxFun (TExp Int64) -&gt; MemLoc
</span><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-var">MemLoc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526409"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684526408"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526407"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-1671"></span><span>          </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-type">MemVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">MemEntry
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1672"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; ValueDestination
</span><a href="Futhark.CodeGen.ImpGen.html#MemoryDestination"><span class="hs-identifier hs-var">MemoryDestination</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526415"><span class="hs-identifier hs-var">dest</span></a></span><span>
</span><span id="line-1673"></span><span>          </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#AccVar"><span class="hs-identifier hs-type">AccVar</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1674"></span><span>            </span><span class="hs-comment">-- Does not matter; accumulators are phantoms.</span><span>
</span><span id="line-1675"></span><span>            </span><span class="annot"><span class="annottext">Maybe MemLoc -&gt; ValueDestination
</span><a href="Futhark.CodeGen.ImpGen.html#ArrayDestination"><span class="hs-identifier hs-var">ArrayDestination</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe MemLoc
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1676"></span><span>  </span><span class="annot"><span class="annottext">ValueDestination
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
ValueDestination
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMDest"><span class="hs-identifier hs-var">copyDWIMDest</span></a></span><span> </span><span class="annot"><span class="annottext">ValueDestination
</span><a href="#local-6989586621684526410"><span class="hs-identifier hs-var">dest_target</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526414"><span class="hs-identifier hs-var">dest_slice</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684526413"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526412"><span class="hs-identifier hs-var">src_slice</span></a></span><span>
</span><span id="line-1677"></span><span>
</span><span id="line-1678"></span><span class="hs-comment">-- | As 'copyDWIM', but implicitly 'DimFix'es the indexes.</span><span>
</span><span id="line-1679"></span><span id="local-6989586621684529898"><span id="local-6989586621684529899"><span id="local-6989586621684529900"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-type">copyDWIMFix</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1680"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1681"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1682"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1683"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1684"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529900"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529899"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529898"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1685"></span><span id="copyDWIMFix"><span class="annot"><span class="annottext">copyDWIMFix :: forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var hs-var">copyDWIMFix</span></a></span></span><span> </span><span id="local-6989586621684526406"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526406"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span id="local-6989586621684526405"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526405"><span class="hs-identifier hs-var">dest_is</span></a></span></span><span> </span><span id="local-6989586621684526404"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684526404"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621684526403"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526403"><span class="hs-identifier hs-var">src_is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1686"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526406"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; [TExp Int64] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526405"><span class="hs-identifier hs-var">dest_is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684526404"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; [TExp Int64] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526403"><span class="hs-identifier hs-var">src_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1687"></span><span>
</span><span id="line-1688"></span><span class="hs-comment">-- | @compileAlloc pat size space@ allocates @n@ bytes of memory in @space@,</span><span>
</span><span id="line-1689"></span><span class="hs-comment">-- writing the result to @dest@, which must be a single</span><span>
</span><span id="line-1690"></span><span class="hs-comment">-- 'MemoryDestination',</span><span>
</span><span id="line-1691"></span><span id="local-6989586621684529489"><span id="local-6989586621684529490"><span id="local-6989586621684529491"><span id="local-6989586621684529492"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileAlloc"><span class="hs-identifier hs-type">compileAlloc</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1692"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529492"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529491"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529492"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529492"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529490"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529489"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1693"></span><span id="compileAlloc"><span class="annot"><span class="annottext">compileAlloc :: forall rep inner r op.
Mem rep inner =&gt;
Pat rep -&gt; SubExp -&gt; Space -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileAlloc"><span class="hs-identifier hs-var hs-var">compileAlloc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684526387"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684526387"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684526386"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684526386"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684526385"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526385"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1694"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684526384"><span class="annot"><span class="annottext">e' :: Count Bytes (TExp Int64)
</span><a href="#local-6989586621684526384"><span class="hs-identifier hs-var hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a. a -&gt; Count Bytes a
</span><a href="Futhark.CodeGen.ImpCode.html#bytes"><span class="hs-identifier hs-var">Imp.bytes</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; Count Bytes (TExp Int64))
-&gt; TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684526386"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1695"></span><span>  </span><span id="local-6989586621684526383"><span class="annot"><span class="annottext">Maybe (AllocCompiler rep r op)
</span><a href="#local-6989586621684526383"><span class="hs-identifier hs-var">allocator</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Maybe (AllocCompiler rep r op))
-&gt; ImpM rep r op (Maybe (AllocCompiler rep r op))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">((Env rep r op -&gt; Maybe (AllocCompiler rep r op))
 -&gt; ImpM rep r op (Maybe (AllocCompiler rep r op)))
-&gt; (Env rep r op -&gt; Maybe (AllocCompiler rep r op))
-&gt; ImpM rep r op (Maybe (AllocCompiler rep r op))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space
-&gt; Map Space (AllocCompiler rep r op)
-&gt; Maybe (AllocCompiler rep r op)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526385"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Space (AllocCompiler rep r op)
 -&gt; Maybe (AllocCompiler rep r op))
-&gt; (Env rep r op -&gt; Map Space (AllocCompiler rep r op))
-&gt; Env rep r op
-&gt; Maybe (AllocCompiler rep r op)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; Map Space (AllocCompiler rep r op)
forall rep r op. Env rep r op -&gt; Map Space (AllocCompiler rep r op)
</span><a href="Futhark.CodeGen.ImpGen.html#envAllocCompilers"><span class="hs-identifier hs-var hs-var">envAllocCompilers</span></a></span><span>
</span><span id="line-1696"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (AllocCompiler rep r op)
</span><a href="#local-6989586621684526383"><span class="hs-identifier hs-var">allocator</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1697"></span><span>    </span><span class="annot"><span class="annottext">Maybe (AllocCompiler rep r op)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Count Bytes (TExp Int64) -&gt; Space -&gt; Code op
forall a. VName -&gt; Count Bytes (TExp Int64) -&gt; Space -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Allocate"><span class="hs-identifier hs-var">Imp.Allocate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684526387"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Count Bytes (TExp Int64)
</span><a href="#local-6989586621684526384"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526385"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1698"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526381"><span class="annot"><span class="annottext">AllocCompiler rep r op
</span><a href="#local-6989586621684526381"><span class="hs-identifier hs-var">allocator'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AllocCompiler rep r op
</span><a href="#local-6989586621684526381"><span class="hs-identifier hs-var">allocator'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684526387"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Count Bytes (TExp Int64)
</span><a href="#local-6989586621684526384"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-1699"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileAlloc"><span class="hs-identifier hs-var">compileAlloc</span></a></span><span> </span><span id="local-6989586621684526380"><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><a href="#local-6989586621684526380"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1700"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op ()) -&gt; [Char] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;compileAlloc: Invalid pattern: &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep) -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><a href="#local-6989586621684526380"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-1701"></span><span>
</span><span id="line-1702"></span><span class="hs-comment">-- | The number of bytes needed to represent the array in a</span><span>
</span><span id="line-1703"></span><span class="hs-comment">-- straightforward contiguous format, as an t'Int64' expression.</span><span>
</span><span id="line-1704"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#typeSize"><span class="hs-identifier hs-type">typeSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Bytes"><span class="hs-identifier hs-type">Bytes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span>
</span><span id="line-1705"></span><span id="typeSize"><span class="annot"><span class="annottext">typeSize :: Type -&gt; Count Bytes (TExp Int64)
</span><a href="Futhark.CodeGen.ImpGen.html#typeSize"><span class="hs-identifier hs-var hs-var">typeSize</span></a></span></span><span> </span><span id="local-6989586621684526379"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684526379"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1706"></span><span>  </span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a. a -&gt; Count Bytes a
</span><a href="Futhark.CodeGen.ImpCode.html#bytes"><span class="hs-identifier hs-var">Imp.bytes</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; Count Bytes (TExp Int64))
-&gt; TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TExp Int64
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684526379"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684526379"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1707"></span><span>
</span><span id="line-1708"></span><span class="hs-comment">-- | Is this indexing in-bounds for an array of the given shape?  This</span><span>
</span><span id="line-1709"></span><span class="hs-comment">-- is useful for things like scatter, which ignores out-of-bounds</span><span>
</span><span id="line-1710"></span><span class="hs-comment">-- writes.</span><span>
</span><span id="line-1711"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#inBounds"><span class="hs-identifier hs-type">inBounds</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1712"></span><span id="inBounds"><span class="annot"><span class="annottext">inBounds :: Slice (TExp Int64) -&gt; [TExp Int64] -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.html#inBounds"><span class="hs-identifier hs-var hs-var">inBounds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span id="local-6989586621684526377"><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526377"><span class="hs-identifier hs-var">slice</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684526376"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526376"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1713"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684526365"><span class="annot"><span class="annottext">condInBounds :: DimIndex (TPrimExp t v) -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="#local-6989586621684526365"><span class="hs-identifier hs-var hs-var">condInBounds</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span id="local-6989586621684526364"><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684526364"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684526363"><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684526363"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1714"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp t v
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C%3D."><span class="hs-operator hs-var">.&lt;=.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684526364"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684526364"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684526363"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-1715"></span><span>      </span><span class="annot"><a href="#local-6989586621684526365"><span class="hs-identifier hs-var">condInBounds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-type">DimSlice</span></a></span><span> </span><span id="local-6989586621684526359"><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684526359"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684526358"><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684526358"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684526357"><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684526357"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684526356"><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684526356"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1716"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp t v
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C%3D."><span class="hs-operator hs-var">.&lt;=.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684526359"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684526359"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp t v
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684526358"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp t v
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp t v
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684526357"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684526356"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-1717"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(TExp Bool -&gt; TExp Bool -&gt; TExp Bool) -&gt; [TExp Bool] -&gt; TExp Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; a -&gt; a) -&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">foldl1</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">(.&amp;&amp;.)</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Bool] -&gt; TExp Bool) -&gt; [TExp Bool] -&gt; TExp Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DimIndex (TExp Int64) -&gt; TExp Int64 -&gt; TExp Bool)
-&gt; [DimIndex (TExp Int64)] -&gt; [TExp Int64] -&gt; [TExp Bool]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">DimIndex (TExp Int64) -&gt; TExp Int64 -&gt; TExp Bool
forall {t} {v}.
(NumExp t, Pretty v) =&gt;
DimIndex (TPrimExp t v) -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="#local-6989586621684526365"><span class="hs-identifier hs-var">condInBounds</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)]
</span><a href="#local-6989586621684526377"><span class="hs-identifier hs-var">slice</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526376"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-1718"></span><span>
</span><span id="line-1719"></span><span class="hs-comment">--- Building blocks for constructing code.</span><span>
</span><span id="line-1720"></span><span>
</span><span id="line-1721"></span><span id="local-6989586621684529938"><span id="local-6989586621684529939"><span id="local-6989586621684529940"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sFor%27"><span class="hs-identifier hs-type">sFor'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Exp"><span class="hs-identifier hs-type">Imp.Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529940"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529939"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529938"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529940"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529939"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529938"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1722"></span><span id="sFor%27"><span class="annot"><span class="annottext">sFor' :: forall rep r op.
VName -&gt; PrimExp VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor%27"><span class="hs-identifier hs-var hs-var">sFor'</span></a></span></span><span> </span><span id="local-6989586621684526345"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526345"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684526344"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684526344"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span id="local-6989586621684526343"><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684526343"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1723"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684526342"><span class="annot"><span class="annottext">it :: IntType
</span><a href="#local-6989586621684526342"><span class="hs-identifier hs-var hs-var">it</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimType
forall v. PrimExp v -&gt; PrimType
</span><a href="Futhark.Analysis.PrimExp.html#primExpType"><span class="hs-identifier hs-var">primExpType</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684526344"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1724"></span><span>        </span><span class="annot"><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-type">IntType</span></a></span><span> </span><span id="local-6989586621684526341"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684526341"><span class="hs-identifier hs-var">bound_t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684526341"><span class="hs-identifier hs-var">bound_t</span></a></span><span>
</span><span id="line-1725"></span><span>        </span><span id="local-6989586621684526340"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526340"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; IntType
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; IntType) -&gt; [Char] -&gt; IntType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;sFor': bound &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684526344"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; is of type &quot;</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526340"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1726"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; IntType -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; IntType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addLoopVar"><span class="hs-identifier hs-var">addLoopVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526345"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684526342"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-1727"></span><span>  </span><span id="local-6989586621684526339"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684526339"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684526343"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1728"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; Code op -&gt; Code op
forall a. VName -&gt; PrimExp VName -&gt; Code a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#For"><span class="hs-identifier hs-var">Imp.For</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526345"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684526344"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684526339"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-1729"></span><span>
</span><span id="line-1730"></span><span id="local-6989586621684529850"><span id="local-6989586621684529851"><span id="local-6989586621684529852"><span id="local-6989586621684529853"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-type">sFor</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529853"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529853"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529852"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529851"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529850"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529852"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529851"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529850"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1731"></span><span id="sFor"><span class="annot"><span class="annottext">sFor :: forall t rep r op.
[Char]
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var hs-var">sFor</span></a></span></span><span> </span><span id="local-6989586621684526336"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526336"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684526335"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684526335"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span id="local-6989586621684526334"><span class="annot"><span class="annottext">TExp t -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684526334"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1732"></span><span>  </span><span id="local-6989586621684526333"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526333"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526336"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-1733"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op.
VName -&gt; PrimExp VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor%27"><span class="hs-identifier hs-var">sFor'</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526333"><span class="hs-identifier hs-var">i'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp t -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684526335"><span class="hs-identifier hs-var">bound</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1734"></span><span>    </span><span class="annot"><span class="annottext">TExp t -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684526334"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp t -&gt; ImpM rep r op ()) -&gt; TExp t -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; TExp t
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; TExp t) -&gt; PrimExp VName -&gt; TExp t
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; PrimExp VName
</span><a href="Futhark.CodeGen.ImpCode.html#var"><span class="hs-identifier hs-var">Imp.var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526333"><span class="hs-identifier hs-var">i'</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; PrimExp VName) -&gt; PrimType -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimType
forall v. PrimExp v -&gt; PrimType
</span><a href="Futhark.Analysis.PrimExp.html#primExpType"><span class="hs-identifier hs-var">primExpType</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; PrimType) -&gt; PrimExp VName -&gt; PrimType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684526335"><span class="hs-identifier hs-var">bound</span></a></span><span>
</span><span id="line-1735"></span><span>
</span><span id="line-1736"></span><span id="local-6989586621684529935"><span id="local-6989586621684529936"><span id="local-6989586621684529937"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sWhile"><span class="hs-identifier hs-type">sWhile</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529937"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529936"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529935"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529937"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529936"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529935"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1737"></span><span id="sWhile"><span class="annot"><span class="annottext">sWhile :: forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhile"><span class="hs-identifier hs-var hs-var">sWhile</span></a></span></span><span> </span><span id="local-6989586621684526331"><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684526331"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684526330"><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684526330"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1738"></span><span>  </span><span id="local-6989586621684526329"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684526329"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684526330"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1739"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; Code op -&gt; Code op
forall a. TExp Bool -&gt; Code a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#While"><span class="hs-identifier hs-var">Imp.While</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684526331"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684526329"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-1740"></span><span>
</span><span id="line-1741"></span><span id="local-6989586621684526325"><span id="local-6989586621684526326"><span id="local-6989586621684526327"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-type">sComment</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526327"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526326"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526325"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526327"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526326"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526325"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1742"></span><span id="sComment"><span class="annot"><span class="annottext">sComment :: forall rep r op. [Char] -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var hs-var">sComment</span></a></span></span><span> </span><span id="local-6989586621684526323"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526323"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684526322"><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684526322"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1743"></span><span>  </span><span id="local-6989586621684526321"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684526321"><span class="hs-identifier hs-var">code'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684526322"><span class="hs-identifier hs-var">code</span></a></span><span>
</span><span id="line-1744"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Code op -&gt; Code op
forall a. [Char] -&gt; Code a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Comment"><span class="hs-identifier hs-var">Imp.Comment</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526323"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684526321"><span class="hs-identifier hs-var">code'</span></a></span><span>
</span><span id="line-1745"></span><span>
</span><span id="line-1746"></span><span id="local-6989586621684529976"><span id="local-6989586621684529977"><span id="local-6989586621684529978"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-type">sIf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529978"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529977"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529976"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529978"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529977"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529976"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529978"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529977"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529976"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1747"></span><span id="sIf"><span class="annot"><span class="annottext">sIf :: forall rep r op.
TExp Bool
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var hs-var">sIf</span></a></span></span><span> </span><span id="local-6989586621684526316"><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684526316"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684526315"><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684526315"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span> </span><span id="local-6989586621684526314"><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684526314"><span class="hs-identifier hs-var">fbranch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1748"></span><span>  </span><span id="local-6989586621684526313"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684526313"><span class="hs-identifier hs-var">tbranch'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684526315"><span class="hs-identifier hs-var">tbranch</span></a></span><span>
</span><span id="line-1749"></span><span>  </span><span id="local-6989586621684526312"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684526312"><span class="hs-identifier hs-var">fbranch'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684526314"><span class="hs-identifier hs-var">fbranch</span></a></span><span>
</span><span id="line-1750"></span><span>  </span><span class="hs-comment">-- Avoid generating branch if the condition is known statically.</span><span>
</span><span id="line-1751"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1752"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684526316"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool
forall v. TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#true"><span class="hs-identifier hs-var">true</span></a></span><span>
</span><span id="line-1753"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684526313"><span class="hs-identifier hs-var">tbranch'</span></a></span><span>
</span><span id="line-1754"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-1755"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684526316"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool
forall v. TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#false"><span class="hs-identifier hs-var">false</span></a></span><span>
</span><span id="line-1756"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684526312"><span class="hs-identifier hs-var">fbranch'</span></a></span><span>
</span><span id="line-1757"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; Code op -&gt; Code op -&gt; Code op
forall a. TExp Bool -&gt; Code a -&gt; Code a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#If"><span class="hs-identifier hs-var">Imp.If</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684526316"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684526313"><span class="hs-identifier hs-var">tbranch'</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684526312"><span class="hs-identifier hs-var">fbranch'</span></a></span><span>
</span><span id="line-1758"></span><span>
</span><span id="line-1759"></span><span id="local-6989586621684526306"><span id="local-6989586621684526307"><span id="local-6989586621684526308"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-type">sWhen</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526308"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526307"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526306"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526308"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526307"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526306"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1760"></span><span id="sWhen"><span class="annot"><span class="annottext">sWhen :: forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var hs-var">sWhen</span></a></span></span><span> </span><span id="local-6989586621684526304"><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684526304"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684526303"><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684526303"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Bool
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op.
TExp Bool
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684526304"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684526303"><span class="hs-identifier hs-var">tbranch</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1761"></span><span>
</span><span id="line-1762"></span><span id="local-6989586621684526300"><span id="local-6989586621684526301"><span id="local-6989586621684526302"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sUnless"><span class="hs-identifier hs-type">sUnless</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526302"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526301"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526300"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526302"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526301"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684526300"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1763"></span><span id="sUnless"><span class="annot"><span class="annottext">sUnless :: forall rep r op. TExp Bool -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sUnless"><span class="hs-identifier hs-var hs-var">sUnless</span></a></span></span><span> </span><span id="local-6989586621684526298"><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684526298"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Bool
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall rep r op.
TExp Bool
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684526298"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1764"></span><span>
</span><span id="line-1765"></span><span id="local-6989586621684529452"><span id="local-6989586621684529453"><span id="local-6989586621684529454"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-type">sOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621684529454"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529453"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529452"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529454"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1766"></span><span id="sOp"><span class="annot"><span class="annottext">sOp :: forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var hs-var">sOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ())
-&gt; (op -&gt; Code op) -&gt; op -&gt; ImpM rep r op ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">op -&gt; Code op
forall a. a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Op"><span class="hs-identifier hs-var">Imp.Op</span></a></span><span>
</span><span id="line-1767"></span><span>
</span><span id="line-1768"></span><span id="local-6989586621684529446"><span id="local-6989586621684529447"><span id="local-6989586621684529448"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sDeclareMem"><span class="hs-identifier hs-type">sDeclareMem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529448"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529447"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529446"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span></span></span><span>
</span><span id="line-1769"></span><span id="sDeclareMem"><span class="annot"><span class="annottext">sDeclareMem :: forall rep r op. [Char] -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sDeclareMem"><span class="hs-identifier hs-var hs-var">sDeclareMem</span></a></span></span><span> </span><span id="local-6989586621684526291"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526291"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684526290"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526290"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1770"></span><span>  </span><span id="local-6989586621684526289"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526289"><span class="hs-identifier hs-var">name'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526291"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1771"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; Code op
forall a. VName -&gt; Space -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DeclareMem"><span class="hs-identifier hs-var">Imp.DeclareMem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526289"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526290"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1772"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addVar"><span class="hs-identifier hs-var">addVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526289"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">(VarEntry rep -&gt; ImpM rep r op ())
-&gt; VarEntry rep -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; MemEntry -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; MemEntry -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-var">MemVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(MemEntry -&gt; VarEntry rep) -&gt; MemEntry -&gt; VarEntry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#MemEntry"><span class="hs-identifier hs-var">MemEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526290"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1773"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526289"><span class="hs-identifier hs-var">name'</span></a></span><span>
</span><span id="line-1774"></span><span>
</span><span id="line-1775"></span><span id="local-6989586621684529440"><span id="local-6989586621684529441"><span id="local-6989586621684529442"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sAlloc_"><span class="hs-identifier hs-type">sAlloc_</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Bytes"><span class="hs-identifier hs-type">Bytes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529442"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529441"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529440"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1776"></span><span id="sAlloc_"><span class="annot"><span class="annottext">sAlloc_ :: forall rep r op.
VName -&gt; Count Bytes (TExp Int64) -&gt; Space -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sAlloc_"><span class="hs-identifier hs-var hs-var">sAlloc_</span></a></span></span><span> </span><span id="local-6989586621684526285"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526285"><span class="hs-identifier hs-var">name'</span></a></span></span><span> </span><span id="local-6989586621684526284"><span class="annot"><span class="annottext">Count Bytes (TExp Int64)
</span><a href="#local-6989586621684526284"><span class="hs-identifier hs-var">size'</span></a></span></span><span> </span><span id="local-6989586621684526283"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526283"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1777"></span><span>  </span><span id="local-6989586621684526282"><span class="annot"><span class="annottext">Maybe (AllocCompiler rep r op)
</span><a href="#local-6989586621684526282"><span class="hs-identifier hs-var">allocator</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Maybe (AllocCompiler rep r op))
-&gt; ImpM rep r op (Maybe (AllocCompiler rep r op))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">((Env rep r op -&gt; Maybe (AllocCompiler rep r op))
 -&gt; ImpM rep r op (Maybe (AllocCompiler rep r op)))
-&gt; (Env rep r op -&gt; Maybe (AllocCompiler rep r op))
-&gt; ImpM rep r op (Maybe (AllocCompiler rep r op))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space
-&gt; Map Space (AllocCompiler rep r op)
-&gt; Maybe (AllocCompiler rep r op)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526283"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Space (AllocCompiler rep r op)
 -&gt; Maybe (AllocCompiler rep r op))
-&gt; (Env rep r op -&gt; Map Space (AllocCompiler rep r op))
-&gt; Env rep r op
-&gt; Maybe (AllocCompiler rep r op)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; Map Space (AllocCompiler rep r op)
forall rep r op. Env rep r op -&gt; Map Space (AllocCompiler rep r op)
</span><a href="Futhark.CodeGen.ImpGen.html#envAllocCompilers"><span class="hs-identifier hs-var hs-var">envAllocCompilers</span></a></span><span>
</span><span id="line-1778"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (AllocCompiler rep r op)
</span><a href="#local-6989586621684526282"><span class="hs-identifier hs-var">allocator</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1779"></span><span>    </span><span class="annot"><span class="annottext">Maybe (AllocCompiler rep r op)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Count Bytes (TExp Int64) -&gt; Space -&gt; Code op
forall a. VName -&gt; Count Bytes (TExp Int64) -&gt; Space -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Allocate"><span class="hs-identifier hs-var">Imp.Allocate</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526285"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">Count Bytes (TExp Int64)
</span><a href="#local-6989586621684526284"><span class="hs-identifier hs-var">size'</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526283"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1780"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684526281"><span class="annot"><span class="annottext">AllocCompiler rep r op
</span><a href="#local-6989586621684526281"><span class="hs-identifier hs-var">allocator'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">AllocCompiler rep r op
</span><a href="#local-6989586621684526281"><span class="hs-identifier hs-var">allocator'</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526285"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">Count Bytes (TExp Int64)
</span><a href="#local-6989586621684526284"><span class="hs-identifier hs-var">size'</span></a></span><span>
</span><span id="line-1781"></span><span>
</span><span id="line-1782"></span><span id="local-6989586621684529434"><span id="local-6989586621684529435"><span id="local-6989586621684529436"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sAlloc"><span class="hs-identifier hs-type">sAlloc</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Bytes"><span class="hs-identifier hs-type">Bytes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529436"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529435"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529434"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span></span></span><span>
</span><span id="line-1783"></span><span id="sAlloc"><span class="annot"><span class="annottext">sAlloc :: forall rep r op.
[Char] -&gt; Count Bytes (TExp Int64) -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAlloc"><span class="hs-identifier hs-var hs-var">sAlloc</span></a></span></span><span> </span><span id="local-6989586621684526277"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526277"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684526276"><span class="annot"><span class="annottext">Count Bytes (TExp Int64)
</span><a href="#local-6989586621684526276"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621684526275"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526275"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1784"></span><span>  </span><span id="local-6989586621684526274"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526274"><span class="hs-identifier hs-var">name'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Space -&gt; ImpM rep r op VName
forall rep r op. [Char] -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sDeclareMem"><span class="hs-identifier hs-var">sDeclareMem</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526277"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526275"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1785"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; Count Bytes (TExp Int64) -&gt; Space -&gt; ImpM rep r op ()
forall rep r op.
VName -&gt; Count Bytes (TExp Int64) -&gt; Space -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sAlloc_"><span class="hs-identifier hs-var">sAlloc_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526274"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">Count Bytes (TExp Int64)
</span><a href="#local-6989586621684526276"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526275"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1786"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526274"><span class="hs-identifier hs-var">name'</span></a></span><span>
</span><span id="line-1787"></span><span>
</span><span id="line-1788"></span><span id="local-6989586621684529428"><span id="local-6989586621684529429"><span id="local-6989586621684529430"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sArray"><span class="hs-identifier hs-type">sArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ShapeBase"><span class="hs-identifier hs-type">ShapeBase</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529430"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529429"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529428"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span></span></span><span>
</span><span id="line-1789"></span><span id="sArray"><span class="annot"><span class="annottext">sArray :: forall rep r op.
[Char]
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun (TExp Int64)
-&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArray"><span class="hs-identifier hs-var hs-var">sArray</span></a></span></span><span> </span><span id="local-6989586621684526269"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526269"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684526268"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526268"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span id="local-6989586621684526267"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526267"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684526266"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526266"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684526265"><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526265"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1790"></span><span>  </span><span id="local-6989586621684526264"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526264"><span class="hs-identifier hs-var">name'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526269"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1791"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun (TExp Int64)
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun (TExp Int64)
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dArray"><span class="hs-identifier hs-var">dArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526264"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526268"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526267"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526266"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526265"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-1792"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; ImpM rep r op VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526264"><span class="hs-identifier hs-var">name'</span></a></span><span>
</span><span id="line-1793"></span><span>
</span><span id="line-1794"></span><span class="hs-comment">-- | Declare an array in row-major order in the given memory block.</span><span>
</span><span id="line-1795"></span><span id="local-6989586621684529422"><span id="local-6989586621684529423"><span id="local-6989586621684529424"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sArrayInMem"><span class="hs-identifier hs-type">sArrayInMem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ShapeBase"><span class="hs-identifier hs-type">ShapeBase</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529424"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529423"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529422"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span></span></span><span>
</span><span id="line-1796"></span><span id="sArrayInMem"><span class="annot"><span class="annottext">sArrayInMem :: forall rep r op.
[Char] -&gt; PrimType -&gt; Shape -&gt; VName -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArrayInMem"><span class="hs-identifier hs-var hs-var">sArrayInMem</span></a></span></span><span> </span><span id="local-6989586621684526262"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526262"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684526261"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526261"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684526260"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526260"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684526259"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526259"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1797"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun (TExp Int64)
-&gt; ImpM rep r op VName
forall rep r op.
[Char]
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun (TExp Int64)
-&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArray"><span class="hs-identifier hs-var">sArray</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526262"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526261"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526260"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526259"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">(IxFun (TExp Int64) -&gt; ImpM rep r op VName)
-&gt; IxFun (TExp Int64) -&gt; ImpM rep r op VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1798"></span><span>    </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; IxFun (TExp Int64)
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; IxFun (TExp Int64))
-&gt; [TExp Int64] -&gt; IxFun (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp VName -&gt; TExp Int64
forall v. PrimExp v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#isInt64"><span class="hs-identifier hs-var">isInt64</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; TExp Int64)
-&gt; (SubExp -&gt; PrimExp VName) -&gt; SubExp -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; PrimExp VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#primExpFromSubExp"><span class="hs-identifier hs-var">primExpFromSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526260"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-1799"></span><span>
</span><span id="line-1800"></span><span class="hs-comment">-- | Like 'sAllocArray', but permute the in-memory representation of the indices as specified.</span><span>
</span><span id="line-1801"></span><span id="local-6989586621684529415"><span id="local-6989586621684529416"><span id="local-6989586621684529417"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sAllocArrayPerm"><span class="hs-identifier hs-type">sAllocArrayPerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ShapeBase"><span class="hs-identifier hs-type">ShapeBase</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529417"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529416"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529415"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span></span></span><span>
</span><span id="line-1802"></span><span id="sAllocArrayPerm"><span class="annot"><span class="annottext">sAllocArrayPerm :: forall rep r op.
[Char]
-&gt; PrimType -&gt; Shape -&gt; Space -&gt; [Int] -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArrayPerm"><span class="hs-identifier hs-var hs-var">sAllocArrayPerm</span></a></span></span><span> </span><span id="local-6989586621684526252"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526252"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684526251"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526251"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684526250"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526250"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684526249"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526249"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684526248"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684526248"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1803"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684526247"><span class="annot"><span class="annottext">permuted_dims :: [SubExp]
</span><a href="#local-6989586621684526247"><span class="hs-identifier hs-var hs-var">permuted_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [SubExp] -&gt; [SubExp]
forall a. [Int] -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeShape"><span class="hs-identifier hs-var">rearrangeShape</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684526248"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [SubExp]) -&gt; [SubExp] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526250"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-1804"></span><span>  </span><span id="local-6989586621684526245"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526245"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Count Bytes (TExp Int64) -&gt; Space -&gt; ImpM rep r op VName
forall rep r op.
[Char] -&gt; Count Bytes (TExp Int64) -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAlloc"><span class="hs-identifier hs-var">sAlloc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526252"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_mem&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Count Bytes (TExp Int64)
</span><a href="Futhark.CodeGen.ImpGen.html#typeSize"><span class="hs-identifier hs-var">typeSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; NoUniqueness -&gt; Type
forall shape u. PrimType -&gt; shape -&gt; u -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526251"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526250"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-var">NoUniqueness</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526249"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1805"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684526244"><span class="annot"><span class="annottext">iota_ixfun :: IxFun (TExp Int64)
</span><a href="#local-6989586621684526244"><span class="hs-identifier hs-var hs-var">iota_ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; IxFun (TExp Int64)
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; IxFun (TExp Int64))
-&gt; [TExp Int64] -&gt; IxFun (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp VName -&gt; TExp Int64
forall v. PrimExp v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#isInt64"><span class="hs-identifier hs-var">isInt64</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; TExp Int64)
-&gt; (SubExp -&gt; PrimExp VName) -&gt; SubExp -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; PrimExp VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#primExpFromSubExp"><span class="hs-identifier hs-var">primExpFromSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684526247"><span class="hs-identifier hs-var">permuted_dims</span></a></span><span>
</span><span id="line-1806"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun (TExp Int64)
-&gt; ImpM rep r op VName
forall rep r op.
[Char]
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun (TExp Int64)
-&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArray"><span class="hs-identifier hs-var">sArray</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526252"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526251"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526250"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526245"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">(IxFun (TExp Int64) -&gt; ImpM rep r op VName)
-&gt; IxFun (TExp Int64) -&gt; ImpM rep r op VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1807"></span><span>    </span><span class="annot"><span class="annottext">IxFun (TExp Int64) -&gt; [Int] -&gt; IxFun (TExp Int64)
forall num. IntegralExp num =&gt; IxFun num -&gt; [Int] -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#permute"><span class="hs-identifier hs-var">IxFun.permute</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684526244"><span class="hs-identifier hs-var">iota_ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; IxFun (TExp Int64)) -&gt; [Int] -&gt; IxFun (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int]
</span><a href="Futhark.IR.Prop.Rearrange.html#rearrangeInverse"><span class="hs-identifier hs-var">rearrangeInverse</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684526248"><span class="hs-identifier hs-var">perm</span></a></span><span>
</span><span id="line-1808"></span><span>
</span><span id="line-1809"></span><span class="hs-comment">-- | Uses linear/iota index function.</span><span>
</span><span id="line-1810"></span><span id="local-6989586621684529407"><span id="local-6989586621684529408"><span id="local-6989586621684529409"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-type">sAllocArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ShapeBase"><span class="hs-identifier hs-type">ShapeBase</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529409"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529408"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529407"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span></span></span><span>
</span><span id="line-1811"></span><span id="sAllocArray"><span class="annot"><span class="annottext">sAllocArray :: forall rep r op.
[Char] -&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var hs-var">sAllocArray</span></a></span></span><span> </span><span id="local-6989586621684526237"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526237"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684526236"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526236"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684526235"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526235"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684526234"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526234"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1812"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; PrimType -&gt; Shape -&gt; Space -&gt; [Int] -&gt; ImpM rep r op VName
forall rep r op.
[Char]
-&gt; PrimType -&gt; Shape -&gt; Space -&gt; [Int] -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArrayPerm"><span class="hs-identifier hs-var">sAllocArrayPerm</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526237"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526236"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526235"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526234"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Int
forall a. ArrayShape a =&gt; a -&gt; Int
</span><a href="Futhark.IR.Syntax.Core.html#shapeRank"><span class="hs-identifier hs-var">shapeRank</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526235"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-1813"></span><span>
</span><span id="line-1814"></span><span class="hs-comment">-- | Uses linear/iota index function.</span><span>
</span><span id="line-1815"></span><span id="local-6989586621684529400"><span id="local-6989586621684529401"><span id="local-6989586621684529402"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sStaticArray"><span class="hs-identifier hs-type">sStaticArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#ArrayContents"><span class="hs-identifier hs-type">Imp.ArrayContents</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529402"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529401"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529400"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span></span></span><span>
</span><span id="line-1816"></span><span id="sStaticArray"><span class="annot"><span class="annottext">sStaticArray :: forall rep r op.
[Char] -&gt; Space -&gt; PrimType -&gt; ArrayContents -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sStaticArray"><span class="hs-identifier hs-var hs-var">sStaticArray</span></a></span></span><span> </span><span id="local-6989586621684526221"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526221"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684526220"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526220"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684526219"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526219"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684526218"><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621684526218"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1817"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684526217"><span class="annot"><span class="annottext">num_elems :: Int
</span><a href="#local-6989586621684526217"><span class="hs-identifier hs-var hs-var">num_elems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621684526218"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1818"></span><span>        </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#ArrayValues"><span class="hs-identifier hs-type">Imp.ArrayValues</span></a></span><span> </span><span id="local-6989586621684526216"><span class="annot"><span class="annottext">[PrimValue]
</span><a href="#local-6989586621684526216"><span class="hs-identifier hs-var">vs'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[PrimValue] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[PrimValue]
</span><a href="#local-6989586621684526216"><span class="hs-identifier hs-var">vs'</span></a></span><span>
</span><span id="line-1819"></span><span>        </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#ArrayZeros"><span class="hs-identifier hs-type">Imp.ArrayZeros</span></a></span><span> </span><span id="local-6989586621684526214"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526214"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526214"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-1820"></span><span>      </span><span id="local-6989586621684526213"><span class="annot"><span class="annottext">shape :: Shape
</span><a href="#local-6989586621684526213"><span class="hs-identifier hs-var hs-var">shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">(Integer -&gt; SubExp) -&gt; Integer -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Integer
forall a. Integral a =&gt; a -&gt; Integer
</span><span class="hs-identifier hs-var">toInteger</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526217"><span class="hs-identifier hs-var">num_elems</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1821"></span><span>  </span><span id="local-6989586621684526212"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526212"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall rep r op. [Char] -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#newVNameForFun"><span class="hs-identifier hs-var">newVNameForFun</span></a></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; ImpM rep r op VName) -&gt; [Char] -&gt; ImpM rep r op VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526221"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;_mem&quot;</span></span><span>
</span><span id="line-1822"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; PrimType -&gt; ArrayContents -&gt; Code op
forall a. VName -&gt; Space -&gt; PrimType -&gt; ArrayContents -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DeclareArray"><span class="hs-identifier hs-var">Imp.DeclareArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526212"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526220"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526219"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">ArrayContents
</span><a href="#local-6989586621684526218"><span class="hs-identifier hs-var">vs</span></a></span><span>
</span><span id="line-1823"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addVar"><span class="hs-identifier hs-var">addVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526212"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">(VarEntry rep -&gt; ImpM rep r op ())
-&gt; VarEntry rep -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; MemEntry -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; MemEntry -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-var">MemVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(MemEntry -&gt; VarEntry rep) -&gt; MemEntry -&gt; VarEntry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#MemEntry"><span class="hs-identifier hs-var">MemEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526220"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1824"></span><span>  </span><span class="annot"><span class="annottext">[Char]
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun (TExp Int64)
-&gt; ImpM rep r op VName
forall rep r op.
[Char]
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun (TExp Int64)
-&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArray"><span class="hs-identifier hs-var">sArray</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526221"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526219"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684526213"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526212"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">(IxFun (TExp Int64) -&gt; ImpM rep r op VName)
-&gt; IxFun (TExp Int64) -&gt; ImpM rep r op VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; IxFun (TExp Int64)
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int -&gt; TExp Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684526217"><span class="hs-identifier hs-var">num_elems</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1825"></span><span>
</span><span id="line-1826"></span><span id="local-6989586621684529393"><span id="local-6989586621684529394"><span id="local-6989586621684529395"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sWrite"><span class="hs-identifier hs-type">sWrite</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Exp"><span class="hs-identifier hs-type">Imp.Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529395"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529394"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529393"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1827"></span><span id="sWrite"><span class="annot"><span class="annottext">sWrite :: forall rep r op.
VName -&gt; [TExp Int64] -&gt; PrimExp VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWrite"><span class="hs-identifier hs-var hs-var">sWrite</span></a></span></span><span> </span><span id="local-6989586621684526208"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526208"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684526207"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526207"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span id="local-6989586621684526206"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684526206"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1828"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684526205"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526205"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526204"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526204"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526203"><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526203"><span class="hs-identifier hs-var">offset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
forall rep r op.
VName
-&gt; [TExp Int64]
-&gt; ImpM rep r op (VName, Space, Count Elements (TExp Int64))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray"><span class="hs-identifier hs-var">fullyIndexArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526208"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526207"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-1829"></span><span>  </span><span id="local-6989586621684526202"><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526202"><span class="hs-identifier hs-var">vol</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Volatility) -&gt; ImpM rep r op Volatility
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; Volatility
forall rep r op. Env rep r op -&gt; Volatility
</span><a href="Futhark.CodeGen.ImpGen.html#envVolatility"><span class="hs-identifier hs-var hs-var">envVolatility</span></a></span><span>
</span><span id="line-1830"></span><span>  </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; PrimExp VName
-&gt; Code op
forall a.
VName
-&gt; Count Elements (TExp Int64)
-&gt; PrimType
-&gt; Space
-&gt; Volatility
-&gt; PrimExp VName
-&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Write"><span class="hs-identifier hs-var">Imp.Write</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526205"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684526203"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimType
forall v. PrimExp v -&gt; PrimType
</span><a href="Futhark.Analysis.PrimExp.html#primExpType"><span class="hs-identifier hs-var">primExpType</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684526206"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526204"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="#local-6989586621684526202"><span class="hs-identifier hs-var">vol</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684526206"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1831"></span><span>
</span><span id="line-1832"></span><span id="local-6989586621684529867"><span id="local-6989586621684529868"><span id="local-6989586621684529869"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sUpdate"><span class="hs-identifier hs-type">sUpdate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529869"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529868"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529867"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1833"></span><span id="sUpdate"><span class="annot"><span class="annottext">sUpdate :: forall rep r op.
VName -&gt; Slice (TExp Int64) -&gt; SubExp -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sUpdate"><span class="hs-identifier hs-var hs-var">sUpdate</span></a></span></span><span> </span><span id="local-6989586621684526201"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526201"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684526200"><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684526200"><span class="hs-identifier hs-var">slice</span></a></span></span><span> </span><span id="local-6989586621684526199"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684526199"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
forall rep r op.
VName
-&gt; [DimIndex (TExp Int64)]
-&gt; SubExp
-&gt; [DimIndex (TExp Int64)]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIM"><span class="hs-identifier hs-var">copyDWIM</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526201"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [DimIndex (TExp Int64)]
forall d. Slice d -&gt; [DimIndex d]
</span><a href="Futhark.IR.Syntax.Core.html#unSlice"><span class="hs-identifier hs-var hs-var">unSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64)
</span><a href="#local-6989586621684526200"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684526199"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1834"></span><span>
</span><span id="line-1835"></span><span id="local-6989586621684529906"><span id="local-6989586621684529907"><span id="local-6989586621684529908"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-type">sLoopNest</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1836"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1837"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529908"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529907"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529906"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1838"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529908"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529907"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529906"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1839"></span><span id="sLoopNest"><span class="annot"><span class="annottext">sLoopNest :: forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var hs-var">sLoopNest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
-&gt; [SubExp]
-&gt; ([TExp Int64] -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall {a} {rep} {r} {op}.
ToExp a =&gt;
[TExp Int64]
-&gt; [a] -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684526196"><span class="hs-identifier hs-var">sLoopNest'</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">([SubExp]
 -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ())
-&gt; (Shape -&gt; [SubExp])
-&gt; Shape
-&gt; ([TExp Int64] -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span>
</span><span id="line-1840"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1841"></span><span>    </span><span id="local-6989586621684526196"><span class="annot"><span class="annottext">sLoopNest' :: [TExp Int64]
-&gt; [a] -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684526196"><span class="hs-identifier hs-var hs-var">sLoopNest'</span></a></span></span><span> </span><span id="local-6989586621684526193"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526193"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684526192"><span class="annot"><span class="annottext">[TExp Int64] -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684526192"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684526192"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; ImpM rep r op ())
-&gt; [TExp Int64] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526193"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-1842"></span><span>    </span><span class="annot"><a href="#local-6989586621684526196"><span class="hs-identifier hs-var">sLoopNest'</span></a></span><span> </span><span id="local-6989586621684526190"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526190"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526189"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684526189"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684526188"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684526188"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684526187"><span class="annot"><span class="annottext">[TExp Int64] -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684526187"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1843"></span><span>      </span><span class="annot"><span class="annottext">[Char]
-&gt; TExp Int64
-&gt; (TExp Int64 -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall t rep r op.
[Char]
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;nest_i&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684526189"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((TExp Int64 -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ())
-&gt; (TExp Int64 -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684526186"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526186"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
-&gt; [a] -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684526196"><span class="hs-identifier hs-var">sLoopNest'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526186"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526190"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684526188"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684526187"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-1844"></span><span>
</span><span id="line-1845"></span><span class="hs-comment">-- | Untyped assignment.</span><span>
</span><span id="line-1846"></span><span id="local-6989586621684529879"><span id="local-6989586621684529880"><span id="local-6989586621684529881"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator hs-type">(&lt;~~)</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Exp"><span class="hs-identifier hs-type">Imp.Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529881"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529880"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529879"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1847"></span><span id="local-6989586621684526185"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526185"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="%3C~~"><span class="annot"><span class="annottext">&lt;~~ :: forall rep r op. VName -&gt; PrimExp VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator hs-var hs-var">&lt;~~</span></a></span></span><span> </span><span id="local-6989586621684526184"><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684526184"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; Code op
forall a. VName -&gt; PrimExp VName -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#SetScalar"><span class="hs-identifier hs-var">Imp.SetScalar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526185"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp VName
</span><a href="#local-6989586621684526184"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1848"></span><span>
</span><span id="line-1849"></span><span class="hs-keyword">infixl</span><span> </span><span class="hs-number">3</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#%3C~~"><span class="hs-operator hs-type">&lt;~~</span></a></span><span>
</span><span id="line-1850"></span><span>
</span><span id="line-1851"></span><span class="hs-comment">-- | Typed assignment.</span><span>
</span><span id="line-1852"></span><span id="local-6989586621684529839"><span id="local-6989586621684529840"><span id="local-6989586621684529841"><span id="local-6989586621684529842"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-type">(&lt;--)</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529842"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529842"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529841"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529840"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529839"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-1853"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span id="local-6989586621684526183"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526183"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span id="%3C--"><span class="annot"><span class="annottext">&lt;-- :: forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var hs-var">&lt;--</span></a></span></span><span> </span><span id="local-6989586621684526182"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684526182"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code op -&gt; ImpM rep r op ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code op -&gt; ImpM rep r op ()) -&gt; Code op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimExp VName -&gt; Code op
forall a. VName -&gt; PrimExp VName -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#SetScalar"><span class="hs-identifier hs-var">Imp.SetScalar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526183"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; Code op) -&gt; PrimExp VName -&gt; Code op
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684526182"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1854"></span><span>
</span><span id="line-1855"></span><span class="hs-keyword">infixl</span><span> </span><span class="hs-number">3</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-type">&lt;--</span></a></span><span>
</span><span id="line-1856"></span><span>
</span><span id="line-1857"></span><span class="hs-comment">-- | Constructing an ad-hoc function that does not</span><span>
</span><span id="line-1858"></span><span class="hs-comment">-- correspond to any of the IR functions in the input program.</span><span>
</span><span id="line-1859"></span><span id="local-6989586621684529369"><span id="local-6989586621684529370"><span id="local-6989586621684529371"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#function"><span class="hs-identifier hs-type">function</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1860"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1861"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Param"><span class="hs-identifier hs-type">Imp.Param</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1862"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Param"><span class="hs-identifier hs-type">Imp.Param</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1863"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529371"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529370"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529369"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1864"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529371"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529370"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529369"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1865"></span><span id="function"><span class="annot"><span class="annottext">function :: forall rep r op.
Name -&gt; [Param] -&gt; [Param] -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#function"><span class="hs-identifier hs-var hs-var">function</span></a></span></span><span> </span><span id="local-6989586621684526176"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684526176"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span id="local-6989586621684526175"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684526175"><span class="hs-identifier hs-var">outputs</span></a></span></span><span> </span><span id="local-6989586621684526174"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684526174"><span class="hs-identifier hs-var">inputs</span></a></span></span><span> </span><span id="local-6989586621684526173"><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684526173"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env rep r op -&gt; Env rep r op)
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">Env rep r op -&gt; Env rep r op
</span><a href="#local-6989586621684526172"><span class="hs-identifier hs-var">newFunction</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op ())
-&gt; ImpM rep r op () -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1866"></span><span>  </span><span id="local-6989586621684526171"><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684526171"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op () -&gt; ImpM rep r op (Code op))
-&gt; ImpM rep r op () -&gt; ImpM rep r op (Code op)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1867"></span><span>    </span><span class="annot"><span class="annottext">(Param -&gt; ImpM rep r op ()) -&gt; [Param] -&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">Param -&gt; ImpM rep r op ()
forall {rep} {r} {op}. Param -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684526170"><span class="hs-identifier hs-var">addParam</span></a></span><span> </span><span class="annot"><span class="annottext">([Param] -&gt; ImpM rep r op ()) -&gt; [Param] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684526175"><span class="hs-identifier hs-var">outputs</span></a></span><span> </span><span class="annot"><span class="annottext">[Param] -&gt; [Param] -&gt; [Param]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684526174"><span class="hs-identifier hs-var">inputs</span></a></span><span>
</span><span id="line-1868"></span><span>    </span><span class="annot"><span class="annottext">ImpM rep r op ()
</span><a href="#local-6989586621684526173"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-1869"></span><span>  </span><span class="annot"><span class="annottext">Name -&gt; Function op -&gt; ImpM rep r op ()
forall op rep r. Name -&gt; Function op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emitFunction"><span class="hs-identifier hs-var">emitFunction</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684526176"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">(Function op -&gt; ImpM rep r op ())
-&gt; Function op -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Name
-&gt; [Param]
-&gt; [Param]
-&gt; Code op
-&gt; [ExternalValue]
-&gt; [(Name, ExternalValue)]
-&gt; Function op
forall a.
Maybe Name
-&gt; [Param]
-&gt; [Param]
-&gt; Code a
-&gt; [ExternalValue]
-&gt; [(Name, ExternalValue)]
-&gt; FunctionT a
</span><a href="Futhark.CodeGen.ImpCode.html#Function"><span class="hs-identifier hs-var">Imp.Function</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684526175"><span class="hs-identifier hs-var">outputs</span></a></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684526174"><span class="hs-identifier hs-var">inputs</span></a></span><span> </span><span class="annot"><span class="annottext">Code op
</span><a href="#local-6989586621684526171"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-1870"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1871"></span><span>    </span><span id="local-6989586621684526170"><span class="annot"><span class="annottext">addParam :: Param -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684526170"><span class="hs-identifier hs-var hs-var">addParam</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#MemParam"><span class="hs-identifier hs-type">Imp.MemParam</span></a></span><span> </span><span id="local-6989586621684526169"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526169"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684526168"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526168"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1872"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addVar"><span class="hs-identifier hs-var">addVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526169"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(VarEntry rep -&gt; ImpM rep r op ())
-&gt; VarEntry rep -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; MemEntry -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; MemEntry -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#MemVar"><span class="hs-identifier hs-var">MemVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(MemEntry -&gt; VarEntry rep) -&gt; MemEntry -&gt; VarEntry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#MemEntry"><span class="hs-identifier hs-var">MemEntry</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684526168"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1873"></span><span>    </span><span class="annot"><a href="#local-6989586621684526170"><span class="hs-identifier hs-var">addParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#ScalarParam"><span class="hs-identifier hs-type">Imp.ScalarParam</span></a></span><span> </span><span id="local-6989586621684526167"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526167"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684526166"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526166"><span class="hs-identifier hs-var">bt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1874"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
forall rep r op. VName -&gt; VarEntry rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#addVar"><span class="hs-identifier hs-var">addVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526167"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(VarEntry rep -&gt; ImpM rep r op ())
-&gt; VarEntry rep -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep) -&gt; ScalarEntry -&gt; VarEntry rep
forall rep. Maybe (Exp rep) -&gt; ScalarEntry -&gt; VarEntry rep
</span><a href="Futhark.CodeGen.ImpGen.html#ScalarVar"><span class="hs-identifier hs-var">ScalarVar</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(ScalarEntry -&gt; VarEntry rep) -&gt; ScalarEntry -&gt; VarEntry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarEntry
</span><a href="Futhark.CodeGen.ImpGen.html#ScalarEntry"><span class="hs-identifier hs-var">ScalarEntry</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684526166"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-1875"></span><span>    </span><span id="local-6989586621684526172"><span class="annot"><span class="annottext">newFunction :: Env rep r op -&gt; Env rep r op
</span><a href="#local-6989586621684526172"><span class="hs-identifier hs-var hs-var">newFunction</span></a></span></span><span> </span><span id="local-6989586621684526165"><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684526165"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env rep r op
</span><a href="#local-6989586621684526165"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">envFunction :: Maybe Name
</span><a href="Futhark.CodeGen.ImpGen.html#envFunction"><span class="hs-identifier hs-var">envFunction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Maybe Name
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684526176"><span class="hs-identifier hs-var">fname</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-1876"></span><span>
</span><span id="line-1877"></span><span id="local-6989586621684529360"><span id="local-6989586621684529361"><span id="local-6989586621684529362"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dSlices"><span class="hs-identifier hs-type">dSlices</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529362"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529361"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529360"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-1878"></span><span id="dSlices"><span class="annot"><span class="annottext">dSlices :: forall rep r op. [TExp Int64] -&gt; ImpM rep r op [TExp Int64]
</span><a href="Futhark.CodeGen.ImpGen.html#dSlices"><span class="hs-identifier hs-var hs-var">dSlices</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((TExp Int64, [TExp Int64]) -&gt; [TExp Int64])
-&gt; ImpM rep r op (TExp Int64, [TExp Int64])
-&gt; ImpM rep r op [TExp Int64]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; [TExp Int64])
-&gt; ((TExp Int64, [TExp Int64]) -&gt; [TExp Int64])
-&gt; (TExp Int64, [TExp Int64])
-&gt; [TExp Int64]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64, [TExp Int64]) -&gt; [TExp Int64]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM rep r op (TExp Int64, [TExp Int64])
 -&gt; ImpM rep r op [TExp Int64])
-&gt; ([TExp Int64] -&gt; ImpM rep r op (TExp Int64, [TExp Int64]))
-&gt; [TExp Int64]
-&gt; ImpM rep r op [TExp Int64]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; ImpM rep r op (TExp Int64, [TExp Int64])
forall {t} {rep} {r} {op}.
NumExp t =&gt;
[TExp t] -&gt; ImpM rep r op (TExp t, [TExp t])
</span><a href="#local-6989586621684526161"><span class="hs-identifier hs-var">dSlices'</span></a></span><span>
</span><span id="line-1879"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1880"></span><span>    </span><span id="local-6989586621684526161"><span class="annot"><span class="annottext">dSlices' :: [TExp t] -&gt; ImpM rep r op (TExp t, [TExp t])
</span><a href="#local-6989586621684526161"><span class="hs-identifier hs-var hs-var">dSlices'</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TExp t, [TExp t]) -&gt; ImpM rep r op (TExp t, [TExp t])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp t
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp t
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1881"></span><span>    </span><span class="annot"><a href="#local-6989586621684526161"><span class="hs-identifier hs-var">dSlices'</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684526150"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684526150"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684526149"><span class="annot"><span class="annottext">[TExp t]
</span><a href="#local-6989586621684526149"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1882"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684526148"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684526148"><span class="hs-identifier hs-var">prod</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526147"><span class="annot"><span class="annottext">[TExp t]
</span><a href="#local-6989586621684526147"><span class="hs-identifier hs-var">ns'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TExp t] -&gt; ImpM rep r op (TExp t, [TExp t])
</span><a href="#local-6989586621684526161"><span class="hs-identifier hs-var">dSlices'</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp t]
</span><a href="#local-6989586621684526149"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-1883"></span><span>      </span><span id="local-6989586621684526146"><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684526146"><span class="hs-identifier hs-var">n'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; TExp t -&gt; ImpM rep r op (TExp t)
forall t rep r op. [Char] -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;slice&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp t -&gt; ImpM rep r op (TExp t))
-&gt; TExp t -&gt; ImpM rep r op (TExp t)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684526150"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; TExp t -&gt; TExp t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684526148"><span class="hs-identifier hs-var">prod</span></a></span><span>
</span><span id="line-1884"></span><span>      </span><span class="annot"><span class="annottext">(TExp t, [TExp t]) -&gt; ImpM rep r op (TExp t, [TExp t])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684526146"><span class="hs-identifier hs-var">n'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TExp t
</span><a href="#local-6989586621684526146"><span class="hs-identifier hs-var">n'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp t -&gt; [TExp t] -&gt; [TExp t]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[TExp t]
</span><a href="#local-6989586621684526147"><span class="hs-identifier hs-var">ns'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1885"></span><span>
</span><span id="line-1886"></span><span class="hs-comment">-- | @dIndexSpace f dims i@ computes a list of indices into an</span><span>
</span><span id="line-1887"></span><span class="hs-comment">-- array with dimension @dims@ given the flat index @i@.  The</span><span>
</span><span id="line-1888"></span><span class="hs-comment">-- resulting list will have the same size as @dims@.  Intermediate</span><span>
</span><span id="line-1889"></span><span class="hs-comment">-- results are passed to @f@.</span><span>
</span><span id="line-1890"></span><span id="local-6989586621684529350"><span id="local-6989586621684529351"><span id="local-6989586621684529352"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace"><span class="hs-identifier hs-type">dIndexSpace</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1891"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1892"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1893"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529352"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529351"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529350"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1894"></span><span id="dIndexSpace"><span class="annot"><span class="annottext">dIndexSpace :: forall rep r op.
[(VName, TExp Int64)] -&gt; TExp Int64 -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace"><span class="hs-identifier hs-var hs-var">dIndexSpace</span></a></span></span><span> </span><span id="local-6989586621684526144"><span class="annot"><span class="annottext">[(VName, TExp Int64)]
</span><a href="#local-6989586621684526144"><span class="hs-identifier hs-var">vs_ds</span></a></span></span><span> </span><span id="local-6989586621684526143"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526143"><span class="hs-identifier hs-var">j</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1895"></span><span>  </span><span id="local-6989586621684526142"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526142"><span class="hs-identifier hs-var">slices</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; ImpM rep r op [TExp Int64]
forall rep r op. [TExp Int64] -&gt; ImpM rep r op [TExp Int64]
</span><a href="Futhark.CodeGen.ImpGen.html#dSlices"><span class="hs-identifier hs-var">dSlices</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((VName, TExp Int64) -&gt; TExp Int64)
-&gt; [(VName, TExp Int64)] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, TExp Int64) -&gt; TExp Int64
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(VName, TExp Int64)]
</span><a href="#local-6989586621684526144"><span class="hs-identifier hs-var">vs_ds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1896"></span><span>  </span><span class="annot"><span class="annottext">[(VName, TExp Int64)] -&gt; TExp Int64 -&gt; ImpM rep r op ()
forall rep r op.
[(VName, TExp Int64)] -&gt; TExp Int64 -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684526141"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [TExp Int64] -&gt; [(VName, TExp Int64)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((VName, TExp Int64) -&gt; VName) -&gt; [(VName, TExp Int64)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, TExp Int64) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(VName, TExp Int64)]
</span><a href="#local-6989586621684526144"><span class="hs-identifier hs-var">vs_ds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526142"><span class="hs-identifier hs-var">slices</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526143"><span class="hs-identifier hs-var">j</span></a></span><span>
</span><span id="line-1897"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1898"></span><span>    </span><span id="local-6989586621684526141"><span class="annot"><span class="annottext">loop :: [(VName, TExp Int64)] -&gt; TExp Int64 -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684526141"><span class="hs-identifier hs-var hs-var">loop</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684526131"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526131"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684526130"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526130"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684526129"><span class="annot"><span class="annottext">[(VName, TExp Int64)]
</span><a href="#local-6989586621684526129"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684526128"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526128"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1899"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; ImpM rep r op ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526131"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526128"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526130"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1900"></span><span>      </span><span id="local-6989586621684526126"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526126"><span class="hs-identifier hs-var">i'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; TExp Int64 -&gt; ImpM rep r op (TExp Int64)
forall t rep r op. [Char] -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;remnant&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; ImpM rep r op (TExp Int64))
-&gt; TExp Int64 -&gt; ImpM rep r op (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526128"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684526131"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526130"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-1901"></span><span>      </span><span class="annot"><span class="annottext">[(VName, TExp Int64)] -&gt; TExp Int64 -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684526141"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, TExp Int64)]
</span><a href="#local-6989586621684526129"><span class="hs-identifier hs-var">rest</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526126"><span class="hs-identifier hs-var">i'</span></a></span><span>
</span><span id="line-1902"></span><span>    </span><span class="annot"><a href="#local-6989586621684526141"><span class="hs-identifier hs-var">loop</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, TExp Int64)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; ImpM rep r op ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1903"></span><span>
</span><span id="line-1904"></span><span class="hs-comment">-- | Like 'dIndexSpace', but invent some new names for the indexes</span><span>
</span><span id="line-1905"></span><span class="hs-comment">-- based on the given template.</span><span>
</span><span id="line-1906"></span><span id="local-6989586621684529340"><span id="local-6989586621684529341"><span id="local-6989586621684529342"><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace%27"><span class="hs-identifier hs-type">dIndexSpace'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1907"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1908"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1909"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1910"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ImpM"><span class="hs-identifier hs-type">ImpM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529342"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529341"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684529340"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-1911"></span><span id="dIndexSpace%27"><span class="annot"><span class="annottext">dIndexSpace' :: forall rep r op.
[Char] -&gt; [TExp Int64] -&gt; TExp Int64 -&gt; ImpM rep r op [TExp Int64]
</span><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace%27"><span class="hs-identifier hs-var hs-var">dIndexSpace'</span></a></span></span><span> </span><span id="local-6989586621684526119"><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526119"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684526118"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526118"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span id="local-6989586621684526117"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526117"><span class="hs-identifier hs-var">j</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1912"></span><span>  </span><span id="local-6989586621684526116"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684526116"><span class="hs-identifier hs-var">ivs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ImpM rep r op VName -&gt; ImpM rep r op [VName]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526118"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Char] -&gt; ImpM rep r op VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; [Char] -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><a href="#local-6989586621684526119"><span class="hs-identifier hs-var">desc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1913"></span><span>  </span><span class="annot"><span class="annottext">[(VName, TExp Int64)] -&gt; TExp Int64 -&gt; ImpM rep r op ()
forall rep r op.
[(VName, TExp Int64)] -&gt; TExp Int64 -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace"><span class="hs-identifier hs-var">dIndexSpace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [TExp Int64] -&gt; [(VName, TExp Int64)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684526116"><span class="hs-identifier hs-var">ivs</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684526118"><span class="hs-identifier hs-var">ds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684526117"><span class="hs-identifier hs-var">j</span></a></span><span>
</span><span id="line-1914"></span><span>  </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; ImpM rep r op [TExp Int64]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; ImpM rep r op [TExp Int64])
-&gt; [TExp Int64] -&gt; ImpM rep r op [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684526116"><span class="hs-identifier hs-var">ivs</span></a></span><span>
</span><span id="line-1915"></span></pre></body></html>