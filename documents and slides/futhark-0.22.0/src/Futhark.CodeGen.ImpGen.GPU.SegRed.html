<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-comment">-- | We generate code for non-segmented/single-segment SegRed using</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- the basic approach outlined in the paper &quot;Design and GPGPU</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- Performance of Futhark&#8217;s Redomap Construct&quot; (ARRAY '16).  The main</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- deviations are:</span><span>
</span><span id="line-8"></span><span class="hs-comment">--</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- * While we still use two-phase reduction, we use only a single</span><span>
</span><span id="line-10"></span><span class="hs-comment">--   kernel, with the final workgroup to write a result (tracked via</span><span>
</span><span id="line-11"></span><span class="hs-comment">--   an atomic counter) performing the final reduction as well.</span><span>
</span><span id="line-12"></span><span class="hs-comment">--</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- * Instead of depending on storage layout transformations to handle</span><span>
</span><span id="line-14"></span><span class="hs-comment">--   non-commutative reductions efficiently, we slide a</span><span>
</span><span id="line-15"></span><span class="hs-comment">--   @groupsize@-sized window over the input, and perform a parallel</span><span>
</span><span id="line-16"></span><span class="hs-comment">--   reduction for each window.  This sacrifices the notion of</span><span>
</span><span id="line-17"></span><span class="hs-comment">--   efficient sequentialisation, but is sometimes faster and</span><span>
</span><span id="line-18"></span><span class="hs-comment">--   definitely simpler and more predictable (and uses less auxiliary</span><span>
</span><span id="line-19"></span><span class="hs-comment">--   storage).</span><span>
</span><span id="line-20"></span><span class="hs-comment">--</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- For segmented reductions we use the approach from &quot;Strategies for</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- Regular Segmented Reductions on GPU&quot; (FHPC '17).  This involves</span><span>
</span><span id="line-23"></span><span class="hs-comment">-- having two different strategies, and dynamically deciding which one</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- to use based on the number of segments and segment size. We use the</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- (static) @group_size@ to decide which of the following two</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- strategies to choose:</span><span>
</span><span id="line-27"></span><span class="hs-comment">--</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- * Large: uses one or more groups to process a single segment. If</span><span>
</span><span id="line-29"></span><span class="hs-comment">--   multiple groups are used per segment, the intermediate reduction</span><span>
</span><span id="line-30"></span><span class="hs-comment">--   results must be recursively reduced, until there is only a single</span><span>
</span><span id="line-31"></span><span class="hs-comment">--   value per segment.</span><span>
</span><span id="line-32"></span><span class="hs-comment">--</span><span>
</span><span id="line-33"></span><span class="hs-comment">--   Each thread /can/ read multiple elements, which will greatly</span><span>
</span><span id="line-34"></span><span class="hs-comment">--   increase performance; however, if the reduction is</span><span>
</span><span id="line-35"></span><span class="hs-comment">--   non-commutative we will have to use a less efficient traversal</span><span>
</span><span id="line-36"></span><span class="hs-comment">--   (with interim group-wide reductions) to enable coalesced memory</span><span>
</span><span id="line-37"></span><span class="hs-comment">--   accesses, just as in the non-segmented case.</span><span>
</span><span id="line-38"></span><span class="hs-comment">--</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- * Small: is used to let each group process *multiple* segments</span><span>
</span><span id="line-40"></span><span class="hs-comment">--   within a group. We will only use this approach when we can</span><span>
</span><span id="line-41"></span><span class="hs-comment">--   process at least two segments within a single group. In those</span><span>
</span><span id="line-42"></span><span class="hs-comment">--   cases, we would allocate a /whole/ group per segment with the</span><span>
</span><span id="line-43"></span><span class="hs-comment">--   large strategy, but at most 50% of the threads in the group would</span><span>
</span><span id="line-44"></span><span class="hs-comment">--   have any element to read, which becomes highly inefficient.</span><span>
</span><span id="line-45"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.CodeGen.ImpGen.GPU.SegRed</span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#compileSegRed"><span class="hs-identifier">compileSegRed</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#compileSegRed%27"><span class="hs-identifier">compileSegRed'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#DoSegBody"><span class="hs-identifier">DoSegBody</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span class="hs-keyword">where</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">genericLength</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">zip7</span></span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html"><span class="hs-identifier">Futhark.CodeGen.ImpCode.GPU</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Imp</span></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen</span></a></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.GPU.Base</span></a></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Error.html"><span class="hs-identifier">Futhark.Error</span></a></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html"><span class="hs-identifier">Futhark.IR.GPUMem</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html"><span class="hs-identifier">Futhark.IR.Mem.IxFun</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IxFun</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html"><span class="hs-identifier">Futhark.Transform.Rename</span></a></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#chunks"><span class="hs-identifier">chunks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html"><span class="hs-identifier">Futhark.Util.IntegralExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-identifier">divUp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-identifier">quot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-identifier">rem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">quot</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">rem</span></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-comment">-- | The maximum number of operators we support in a single SegRed.</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- This limit arises out of the static allocation of counters.</span><span>
</span><span id="line-68"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#maxNumOps"><span class="hs-identifier hs-type">maxNumOps</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span>
</span><span id="line-69"></span><span id="maxNumOps"><span class="annot"><span class="annottext">maxNumOps :: Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#maxNumOps"><span class="hs-identifier hs-var hs-var">maxNumOps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-number">10</span></span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-comment">-- | Code generation for the body of the SegRed, taking a continuation</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- for saving the results of the body.  The results should be</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- represented as a pairing of a t'SubExp' along with a list of</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- indexes into that t'SubExp' for reading the result.</span><span>
</span><span id="line-75"></span><span class="hs-keyword">type</span><span> </span><span id="DoSegBody"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#DoSegBody"><span class="hs-identifier hs-var">DoSegBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-comment">-- | Compile 'SegRed' instance to host-level code with calls to</span><span>
</span><span id="line-78"></span><span class="hs-comment">-- various kernels.</span><span>
</span><span id="line-79"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#compileSegRed"><span class="hs-identifier hs-type">compileSegRed</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-80"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-81"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegLevel"><span class="hs-identifier hs-type">SegLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-82"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-84"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-85"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span id="compileSegRed"><span class="annot"><span class="annottext">compileSegRed :: Pat GPUMem
-&gt; SegLevel
-&gt; SegSpace
-&gt; [SegBinOp GPUMem]
-&gt; KernelBody GPUMem
-&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#compileSegRed"><span class="hs-identifier hs-var hs-var">compileSegRed</span></a></span></span><span> </span><span id="local-6989586621684542253"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684542253"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684542252"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684542252"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684542251"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542251"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684542250"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542250"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684542249"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684542249"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-87"></span><span>  </span><span class="annot"><span class="annottext">Pat GPUMem
-&gt; SegLevel
-&gt; SegSpace
-&gt; [SegBinOp GPUMem]
-&gt; DoSegBody
-&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#compileSegRed%27"><span class="hs-identifier hs-var">compileSegRed'</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684542253"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684542252"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542251"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542250"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">(DoSegBody -&gt; CallKernelGen ()) -&gt; DoSegBody -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684542248"><span class="annot"><span class="annottext">[(SubExp, [TPrimExp Int64 VName])] -&gt; InKernelGen ()
</span><a href="#local-6989586621684542248"><span class="hs-identifier hs-var">red_cont</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-88"></span><span>    </span><span class="annot"><span class="annottext">Names -&gt; Stms GPUMem -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Stms GPUMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684542249"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-89"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684542245"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684542245"><span class="hs-identifier hs-var">red_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542244"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684542244"><span class="hs-identifier hs-var">map_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp GPUMem] -&gt; Int
forall rep. [SegBinOp rep] -&gt; Int
</span><a href="Futhark.IR.SegOp.html#segBinOpResults"><span class="hs-identifier hs-var">segBinOpResults</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542250"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; ([KernelResult], [KernelResult]))
-&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684542249"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;save map-out results&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-92"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542239"><span class="annot"><span class="annottext">map_arrs :: [PatElemT LParamMem]
</span><a href="#local-6989586621684542239"><span class="hs-identifier hs-var hs-var">map_arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [PatElemT LParamMem] -&gt; [PatElemT LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp GPUMem] -&gt; Int
forall rep. [SegBinOp rep] -&gt; Int
</span><a href="Futhark.IR.SegOp.html#segBinOpResults"><span class="hs-identifier hs-var">segBinOpResults</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542250"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [PatElemT LParamMem])
-&gt; [PatElemT LParamMem] -&gt; [PatElemT LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LParamMem
</span><a href="#local-6989586621684542253"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-93"></span><span>        </span><span class="annot"><span class="annottext">(PatElemT LParamMem -&gt; KernelResult -&gt; InKernelGen ())
-&gt; [PatElemT LParamMem] -&gt; [KernelResult] -&gt; InKernelGen ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; PatElem GPUMem -&gt; KernelResult -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#compileThreadResult"><span class="hs-identifier hs-var">compileThreadResult</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542251"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684542239"><span class="hs-identifier hs-var">map_arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684542244"><span class="hs-identifier hs-var">map_res</span></a></span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span>      </span><span class="annot"><span class="annottext">[(SubExp, [TPrimExp Int64 VName])] -&gt; InKernelGen ()
</span><a href="#local-6989586621684542248"><span class="hs-identifier hs-var">red_cont</span></a></span><span> </span><span class="annot"><span class="annottext">([(SubExp, [TPrimExp Int64 VName])] -&gt; InKernelGen ())
-&gt; [(SubExp, [TPrimExp Int64 VName])] -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
-&gt; [[TPrimExp Int64 VName]] -&gt; [(SubExp, [TPrimExp Int64 VName])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(KernelResult -&gt; SubExp) -&gt; [KernelResult] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684542245"><span class="hs-identifier hs-var">red_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([[TPrimExp Int64 VName]] -&gt; [(SubExp, [TPrimExp Int64 VName])])
-&gt; [[TPrimExp Int64 VName]] -&gt; [(SubExp, [TPrimExp Int64 VName])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; [[TPrimExp Int64 VName]]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span class="hs-comment">-- | Like 'compileSegRed', but where the body is a monadic action.</span><span>
</span><span id="line-98"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#compileSegRed%27"><span class="hs-identifier hs-type">compileSegRed'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-99"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-100"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegLevel"><span class="hs-identifier hs-type">SegLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-101"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#DoSegBody"><span class="hs-identifier hs-type">DoSegBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-104"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span id="compileSegRed%27"><span class="annot"><span class="annottext">compileSegRed' :: Pat GPUMem
-&gt; SegLevel
-&gt; SegSpace
-&gt; [SegBinOp GPUMem]
-&gt; DoSegBody
-&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#compileSegRed%27"><span class="hs-identifier hs-var hs-var">compileSegRed'</span></a></span></span><span> </span><span id="local-6989586621684542232"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684542232"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684542231"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684542231"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684542230"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542230"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684542229"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542229"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684542228"><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684542228"><span class="hs-identifier hs-var">body</span></a></span></span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem] -&gt; Int32
forall i a. Num i =&gt; [a] -&gt; i
</span><span class="hs-identifier hs-var">genericLength</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542229"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">Int32 -&gt; Int32 -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#maxNumOps"><span class="hs-identifier hs-var">maxNumOps</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-107"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; CallKernelGen ()
forall a. String -&gt; a
</span><a href="Futhark.Error.html#compilerLimitationS"><span class="hs-identifier hs-var">compilerLimitationS</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; CallKernelGen ()) -&gt; String -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-108"></span><span>      </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;compileSegRed': at most &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int32 -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#maxNumOps"><span class="hs-identifier hs-var">maxNumOps</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; reduction operators are supported.&quot;</span></span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#IntValue"><span class="hs-identifier hs-type">IntValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#Int64Value"><span class="hs-identifier hs-type">Int64Value</span></a></span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(VName, SubExp)
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542230"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-110"></span><span>    </span><span class="annot"><span class="annottext">Pat GPUMem
-&gt; Count NumGroups SubExp
-&gt; Count GroupSize SubExp
-&gt; SegSpace
-&gt; [SegBinOp GPUMem]
-&gt; DoSegBody
-&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#nonsegmentedReduction"><span class="hs-identifier hs-var">nonsegmentedReduction</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684542232"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups SubExp
</span><a href="#local-6989586621684542219"><span class="hs-identifier hs-var">num_groups</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542218"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542230"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542229"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684542228"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-111"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-112"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542217"><span class="annot"><span class="annottext">group_size' :: TPrimExp Int64 VName
</span><a href="#local-6989586621684542217"><span class="hs-identifier hs-var hs-var">group_size'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName) -&gt; SubExp -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp -&gt; SubExp
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542218"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-113"></span><span>        </span><span id="local-6989586621684542214"><span class="annot"><span class="annottext">segment_size :: TPrimExp Int64 VName
</span><a href="#local-6989586621684542214"><span class="hs-identifier hs-var hs-var">segment_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName) -&gt; SubExp -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; SubExp
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; SubExp) -&gt; [SubExp] -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segSpaceDims"><span class="hs-identifier hs-var">segSpaceDims</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542230"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-114"></span><span>        </span><span id="local-6989586621684542211"><span class="annot"><span class="annottext">use_small_segments :: TPrimExp Bool VName
</span><a href="#local-6989586621684542211"><span class="hs-identifier hs-var hs-var">use_small_segments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542214"><span class="hs-identifier hs-var">segment_size</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">2</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542217"><span class="hs-identifier hs-var">group_size'</span></a></span><span>
</span><span id="line-115"></span><span>    </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; CallKernelGen () -&gt; CallKernelGen () -&gt; CallKernelGen ()
forall rep r op.
TPrimExp Bool VName
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span>
</span><span id="line-116"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Bool VName
</span><a href="#local-6989586621684542211"><span class="hs-identifier hs-var">use_small_segments</span></a></span><span>
</span><span id="line-117"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat GPUMem
-&gt; Count NumGroups SubExp
-&gt; Count GroupSize SubExp
-&gt; SegSpace
-&gt; [SegBinOp GPUMem]
-&gt; DoSegBody
-&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#smallSegmentsReduction"><span class="hs-identifier hs-var">smallSegmentsReduction</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684542232"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups SubExp
</span><a href="#local-6989586621684542219"><span class="hs-identifier hs-var">num_groups</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542218"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542230"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542229"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684542228"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat GPUMem
-&gt; Count NumGroups SubExp
-&gt; Count GroupSize SubExp
-&gt; SegSpace
-&gt; [SegBinOp GPUMem]
-&gt; DoSegBody
-&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#largeSegmentsReduction"><span class="hs-identifier hs-var">largeSegmentsReduction</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684542232"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups SubExp
</span><a href="#local-6989586621684542219"><span class="hs-identifier hs-var">num_groups</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542218"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542230"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542229"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684542228"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-119"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-120"></span><span>    </span><span id="local-6989586621684542219"><span class="annot"><span class="annottext">num_groups :: Count NumGroups SubExp
</span><a href="#local-6989586621684542219"><span class="hs-identifier hs-var hs-var">num_groups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegLevel -&gt; Count NumGroups SubExp
</span><a href="Futhark.IR.GPU.Op.html#segNumGroups"><span class="hs-identifier hs-var hs-var">segNumGroups</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684542231"><span class="hs-identifier hs-var">lvl</span></a></span><span>
</span><span id="line-121"></span><span>    </span><span id="local-6989586621684542218"><span class="annot"><span class="annottext">group_size :: Count GroupSize SubExp
</span><a href="#local-6989586621684542218"><span class="hs-identifier hs-var hs-var">group_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegLevel -&gt; Count GroupSize SubExp
</span><a href="Futhark.IR.GPU.Op.html#segGroupSize"><span class="hs-identifier hs-var hs-var">segGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684542231"><span class="hs-identifier hs-var">lvl</span></a></span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span class="hs-comment">-- | Prepare intermediate arrays for the reduction.  Prim-typed</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- arguments go in local memory (so we need to do the allocation of</span><span>
</span><span id="line-125"></span><span class="hs-comment">-- those arrays inside the kernel), while array-typed arguments go in</span><span>
</span><span id="line-126"></span><span class="hs-comment">-- global memory.  Allocations for the former have already been</span><span>
</span><span id="line-127"></span><span class="hs-comment">-- performed.  This policy is baked into how the allocations are done</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- in ExplicitAllocations.</span><span>
</span><span id="line-129"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#intermediateArrays"><span class="hs-identifier hs-type">intermediateArrays</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-130"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#GroupSize"><span class="hs-identifier hs-type">GroupSize</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-132"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-134"></span><span id="intermediateArrays"><span class="annot"><span class="annottext">intermediateArrays :: Count GroupSize SubExp
-&gt; SubExp -&gt; SegBinOp GPUMem -&gt; InKernelGen [VName]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#intermediateArrays"><span class="hs-identifier hs-var hs-var">intermediateArrays</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span id="local-6989586621684542201"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684542201"><span class="hs-identifier hs-var">group_size</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684542200"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684542200"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684542198"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684542198"><span class="hs-identifier hs-var">red_op</span></a></span></span><span> </span><span id="local-6989586621684542197"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542197"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542196"><span class="annot"><span class="annottext">red_op_params :: [LParam GPUMem]
</span><a href="#local-6989586621684542196"><span class="hs-identifier hs-var hs-var">red_op_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684542198"><span class="hs-identifier hs-var">red_op</span></a></span><span>
</span><span id="line-136"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684542194"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684542194"><span class="hs-identifier hs-var">red_acc_params</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542197"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param LParamMem]
</span><a href="#local-6989586621684542196"><span class="hs-identifier hs-var">red_op_params</span></a></span><span>
</span><span id="line-137"></span><span>  </span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; (Param LParamMem -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; InKernelGen [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684542194"><span class="hs-identifier hs-var">red_acc_params</span></a></span><span> </span><span class="annot"><span class="annottext">((Param LParamMem -&gt; ImpM GPUMem KernelEnv KernelOp VName)
 -&gt; InKernelGen [VName])
-&gt; (Param LParamMem -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; InKernelGen [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684542191"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684542191"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; LParamMem
forall dec. Param dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var hs-var">paramDec</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684542191"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-139"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684542188"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684542188"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684542187"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684542187"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684542185"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684542185"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="annot"><span class="annottext">IxFun
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-140"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542184"><span class="annot"><span class="annottext">shape' :: Shape
</span><a href="#local-6989586621684542184"><span class="hs-identifier hs-var hs-var">shape'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684542200"><span class="hs-identifier hs-var">num_threads</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Shape -&gt; Shape
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684542187"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-141"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; Shape
-&gt; VName
-&gt; IxFun
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String
-&gt; PrimType -&gt; Shape -&gt; VName -&gt; IxFun -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sArray"><span class="hs-identifier hs-var">sArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;red_arr&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684542188"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684542184"><span class="hs-identifier hs-var">shape'</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684542185"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">(IxFun -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; IxFun -&gt; ImpM GPUMem KernelEnv KernelOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-142"></span><span>          </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; IxFun
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; IxFun)
-&gt; [TPrimExp Int64 VName] -&gt; IxFun
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TPrimExp Int64 VName])
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684542184"><span class="hs-identifier hs-var">shape'</span></a></span><span>
</span><span id="line-143"></span><span>      </span><span class="annot"><span class="annottext">LParamMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-144"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542178"><span class="annot"><span class="annottext">pt :: PrimType
</span><a href="#local-6989586621684542178"><span class="hs-identifier hs-var hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; PrimType)
-&gt; TypeBase Shape NoUniqueness -&gt; PrimType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684542191"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-145"></span><span>            </span><span id="local-6989586621684542175"><span class="annot"><span class="annottext">shape :: Shape
</span><a href="#local-6989586621684542175"><span class="hs-identifier hs-var hs-var">shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684542201"><span class="hs-identifier hs-var">group_size</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-146"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; Shape
-&gt; Space
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String -&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var">sAllocArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;red_arr&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684542178"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684542175"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">(Space -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; Space -&gt; ImpM GPUMem KernelEnv KernelOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span>
</span><span id="line-147"></span><span>
</span><span id="line-148"></span><span class="hs-comment">-- | Arrays for storing group results.</span><span>
</span><span id="line-149"></span><span class="hs-comment">--</span><span>
</span><span id="line-150"></span><span class="hs-comment">-- The group-result arrays have an extra dimension because they are</span><span>
</span><span id="line-151"></span><span class="hs-comment">-- also used for keeping vectorised accumulators for first-stage</span><span>
</span><span id="line-152"></span><span class="hs-comment">-- reduction, if necessary.  If necessary, this dimension has size</span><span>
</span><span id="line-153"></span><span class="hs-comment">-- group_size, and otherwise 1.  When actually storing group results,</span><span>
</span><span id="line-154"></span><span class="hs-comment">-- the first index is set to 0.</span><span>
</span><span id="line-155"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#groupResultArrays"><span class="hs-identifier hs-type">groupResultArrays</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#NumGroups"><span class="hs-identifier hs-type">NumGroups</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-157"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#GroupSize"><span class="hs-identifier hs-type">GroupSize</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-158"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-159"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-160"></span><span id="groupResultArrays"><span class="annot"><span class="annottext">groupResultArrays :: Count NumGroups SubExp
-&gt; Count GroupSize SubExp
-&gt; [SegBinOp GPUMem]
-&gt; CallKernelGen [[VName]]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#groupResultArrays"><span class="hs-identifier hs-var hs-var">groupResultArrays</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span id="local-6989586621684542171"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684542171"><span class="hs-identifier hs-var">virt_num_groups</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span id="local-6989586621684542170"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684542170"><span class="hs-identifier hs-var">group_size</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684542169"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542169"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-161"></span><span>  </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
-&gt; (SegBinOp GPUMem -&gt; ImpM GPUMem HostEnv HostOp [VName])
-&gt; CallKernelGen [[VName]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542169"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">((SegBinOp GPUMem -&gt; ImpM GPUMem HostEnv HostOp [VName])
 -&gt; CallKernelGen [[VName]])
-&gt; (SegBinOp GPUMem -&gt; ImpM GPUMem HostEnv HostOp [VName])
-&gt; CallKernelGen [[VName]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684542168"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684542168"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684542167"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684542167"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><span class="annottext">[TypeBase Shape NoUniqueness]
-&gt; (TypeBase Shape NoUniqueness
    -&gt; ImpM GPUMem HostEnv HostOp VName)
-&gt; ImpM GPUMem HostEnv HostOp [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [TypeBase Shape NoUniqueness]
forall rep. LambdaT rep -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684542168"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((TypeBase Shape NoUniqueness -&gt; ImpM GPUMem HostEnv HostOp VName)
 -&gt; ImpM GPUMem HostEnv HostOp [VName])
-&gt; (TypeBase Shape NoUniqueness
    -&gt; ImpM GPUMem HostEnv HostOp VName)
-&gt; ImpM GPUMem HostEnv HostOp [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684542165"><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684542165"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-163"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542164"><span class="annot"><span class="annottext">pt :: PrimType
</span><a href="#local-6989586621684542164"><span class="hs-identifier hs-var hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684542165"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-164"></span><span>          </span><span id="local-6989586621684542163"><span class="annot"><span class="annottext">extra_dim :: SubExp
</span><a href="#local-6989586621684542163"><span class="hs-identifier hs-var hs-var">extra_dim</span></a></span></span><span>
</span><span id="line-165"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684542165"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Int
forall a. ArrayShape a =&gt; a -&gt; Int
</span><a href="Futhark.IR.Syntax.Core.html#shapeRank"><span class="hs-identifier hs-var">shapeRank</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684542167"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span>
</span><span id="line-166"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684542170"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-167"></span><span>          </span><span id="local-6989586621684542158"><span class="annot"><span class="annottext">full_shape :: Shape
</span><a href="#local-6989586621684542158"><span class="hs-identifier hs-var hs-var">full_shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684542163"><span class="hs-identifier hs-var">extra_dim</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684542171"><span class="hs-identifier hs-var">virt_num_groups</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Shape -&gt; Shape
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684542167"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Shape -&gt; Shape
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Shape
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684542165"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-168"></span><span>          </span><span class="hs-comment">-- Move the groupsize dimension last to ensure coalesced</span><span>
</span><span id="line-169"></span><span>          </span><span class="hs-comment">-- memory access.</span><span>
</span><span id="line-170"></span><span>          </span><span id="local-6989586621684542156"><span class="annot"><span class="annottext">perm :: [Int]
</span><a href="#local-6989586621684542156"><span class="hs-identifier hs-var hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Int
forall a. ArrayShape a =&gt; a -&gt; Int
</span><a href="Futhark.IR.Syntax.Core.html#shapeRank"><span class="hs-identifier hs-var">shapeRank</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684542158"><span class="hs-identifier hs-var">full_shape</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-171"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; Shape
-&gt; Space
-&gt; [Int]
-&gt; ImpM GPUMem HostEnv HostOp VName
forall rep r op.
String
-&gt; PrimType -&gt; Shape -&gt; Space -&gt; [Int] -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArrayPerm"><span class="hs-identifier hs-var">sAllocArrayPerm</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segred_tmp&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684542164"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684542158"><span class="hs-identifier hs-var">full_shape</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684542156"><span class="hs-identifier hs-var">perm</span></a></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#nonsegmentedReduction"><span class="hs-identifier hs-type">nonsegmentedReduction</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-175"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#NumGroups"><span class="hs-identifier hs-type">NumGroups</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-176"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#GroupSize"><span class="hs-identifier hs-type">GroupSize</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-177"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-178"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#DoSegBody"><span class="hs-identifier hs-type">DoSegBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-180"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span id="nonsegmentedReduction"><span class="annot"><span class="annottext">nonsegmentedReduction :: Pat GPUMem
-&gt; Count NumGroups SubExp
-&gt; Count GroupSize SubExp
-&gt; SegSpace
-&gt; [SegBinOp GPUMem]
-&gt; DoSegBody
-&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#nonsegmentedReduction"><span class="hs-identifier hs-var hs-var">nonsegmentedReduction</span></a></span></span><span> </span><span id="local-6989586621684542154"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684542154"><span class="hs-identifier hs-var">segred_pat</span></a></span></span><span> </span><span id="local-6989586621684542153"><span class="annot"><span class="annottext">Count NumGroups SubExp
</span><a href="#local-6989586621684542153"><span class="hs-identifier hs-var">num_groups</span></a></span></span><span> </span><span id="local-6989586621684542152"><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542152"><span class="hs-identifier hs-var">group_size</span></a></span></span><span> </span><span id="local-6989586621684542151"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542151"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684542150"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542150"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684542149"><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684542149"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684542148"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542148"><span class="hs-identifier hs-var">gtids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542147"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542147"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542151"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-183"></span><span>      </span><span id="local-6989586621684542145"><span class="annot"><span class="annottext">dims' :: [TPrimExp Int64 VName]
</span><a href="#local-6989586621684542145"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542147"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-184"></span><span>      </span><span id="local-6989586621684542144"><span class="annot"><span class="annottext">num_groups' :: Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542144"><span class="hs-identifier hs-var hs-var">num_groups'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; Count NumGroups SubExp -&gt; Count NumGroups (TPrimExp Int64 VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups SubExp
</span><a href="#local-6989586621684542153"><span class="hs-identifier hs-var">num_groups</span></a></span><span>
</span><span id="line-185"></span><span>      </span><span id="local-6989586621684542143"><span class="annot"><span class="annottext">group_size' :: Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542143"><span class="hs-identifier hs-var hs-var">group_size'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; Count GroupSize SubExp -&gt; Count GroupSize (TPrimExp Int64 VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542152"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-186"></span><span>      </span><span id="local-6989586621684542142"><span class="annot"><span class="annottext">global_tid :: TPrimExp Int64 VName
</span><a href="#local-6989586621684542142"><span class="hs-identifier hs-var hs-var">global_tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TPrimExp Int64 VName) -&gt; VName -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542151"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-187"></span><span>      </span><span id="local-6989586621684542139"><span class="annot"><span class="annottext">w :: TPrimExp Int64 VName
</span><a href="#local-6989586621684542139"><span class="hs-identifier hs-var hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542145"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-188"></span><span>
</span><span id="line-189"></span><span>  </span><span id="local-6989586621684542138"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684542138"><span class="hs-identifier hs-var">counter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-190"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; Space
-&gt; PrimType
-&gt; ArrayContents
-&gt; ImpM GPUMem HostEnv HostOp VName
forall rep r op.
String -&gt; Space -&gt; PrimType -&gt; ArrayContents -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sStaticArray"><span class="hs-identifier hs-var">sStaticArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;counter&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span> </span><span class="annot"><span class="annottext">(ArrayContents -&gt; ImpM GPUMem HostEnv HostOp VName)
-&gt; ArrayContents -&gt; ImpM GPUMem HostEnv HostOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-191"></span><span>      </span><span class="annot"><span class="annottext">[PrimValue] -&gt; ArrayContents
</span><a href="Futhark.CodeGen.ImpCode.html#ArrayValues"><span class="hs-identifier hs-var">Imp.ArrayValues</span></a></span><span> </span><span class="annot"><span class="annottext">([PrimValue] -&gt; ArrayContents) -&gt; [PrimValue] -&gt; ArrayContents
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; PrimValue -&gt; [PrimValue]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int32 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#maxNumOps"><span class="hs-identifier hs-var">maxNumOps</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PrimValue -&gt; [PrimValue]) -&gt; PrimValue -&gt; [PrimValue]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntValue -&gt; PrimValue
</span><a href="Futhark.IR.Primitive.html#IntValue"><span class="hs-identifier hs-var">IntValue</span></a></span><span> </span><span class="annot"><span class="annottext">(IntValue -&gt; PrimValue) -&gt; IntValue -&gt; PrimValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int32 -&gt; IntValue
</span><a href="Futhark.IR.Primitive.html#Int32Value"><span class="hs-identifier hs-var">Int32Value</span></a></span><span> </span><span class="annot"><span class="annottext">Int32
</span><span class="hs-number">0</span></span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span>  </span><span id="local-6989586621684542132"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684542132"><span class="hs-identifier hs-var">reds_group_res_arrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Count NumGroups SubExp
-&gt; Count GroupSize SubExp
-&gt; [SegBinOp GPUMem]
-&gt; CallKernelGen [[VName]]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#groupResultArrays"><span class="hs-identifier hs-var">groupResultArrays</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups SubExp
</span><a href="#local-6989586621684542153"><span class="hs-identifier hs-var">num_groups</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542152"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542150"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span>  </span><span id="local-6989586621684542131"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684542131"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_threads&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64))
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-197"></span><span>      </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542144"><span class="hs-identifier hs-var">num_groups'</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542143"><span class="hs-identifier hs-var">group_size'</span></a></span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n# SegRed&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; Count NumGroups (TPrimExp Int64 VName)
-&gt; Count GroupSize (TPrimExp Int64 VName)
-&gt; VName
-&gt; InKernelGen ()
-&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelThread"><span class="hs-identifier hs-var">sKernelThread</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segred_nonseg&quot;</span></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542144"><span class="hs-identifier hs-var">num_groups'</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542143"><span class="hs-identifier hs-var">group_size'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542151"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; CallKernelGen ())
-&gt; InKernelGen () -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-202"></span><span>    </span><span id="local-6989586621684542126"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684542126"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelConstants)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp KernelConstants
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-203"></span><span>    </span><span id="local-6989586621684542122"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684542122"><span class="hs-identifier hs-var">sync_arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; Shape
-&gt; Space
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String -&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var">sAllocArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;sync_arr&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Primitive.html#Bool"><span class="hs-identifier hs-var">Bool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Space -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; Space -&gt; ImpM GPUMem KernelEnv KernelOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span>
</span><span id="line-204"></span><span>    </span><span id="local-6989586621684542119"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684542119"><span class="hs-identifier hs-var">reds_arrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; InKernelGen [VName])
-&gt; [SegBinOp GPUMem] -&gt; ImpM GPUMem KernelEnv KernelOp [[VName]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count GroupSize SubExp
-&gt; SubExp -&gt; SegBinOp GPUMem -&gt; InKernelGen [VName]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#intermediateArrays"><span class="hs-identifier hs-var">intermediateArrays</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542152"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684542131"><span class="hs-identifier hs-var">num_threads</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542150"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span>    </span><span class="hs-comment">-- Since this is the nonsegmented case, all outer segment IDs must</span><span>
</span><span id="line-207"></span><span>    </span><span class="hs-comment">-- necessarily be 0.</span><span>
</span><span id="line-208"></span><span>    </span><span class="annot"><span class="annottext">[VName] -&gt; (VName -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542148"><span class="hs-identifier hs-var">gtids</span></a></span><span> </span><span class="annot"><span class="annottext">((VName -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; (VName -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684542115"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684542115"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName -&gt; InKernelGen ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684542115"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542113"><span class="annot"><span class="annottext">num_elements :: Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542113"><span class="hs-identifier hs-var hs-var">num_elements</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Count Elements (TPrimExp Int64 VName)
forall a. a -&gt; Count Elements a
</span><a href="Futhark.CodeGen.ImpCode.html#elements"><span class="hs-identifier hs-var">Imp.elements</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542139"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-211"></span><span>        </span><span id="local-6989586621684542111"><span class="annot"><span class="annottext">elems_per_thread :: Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542111"><span class="hs-identifier hs-var hs-var">elems_per_thread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-212"></span><span>          </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542113"><span class="hs-identifier hs-var">num_elements</span></a></span><span>
</span><span id="line-213"></span><span>            </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; Count Elements (TPrimExp Int64 VName)
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-operator hs-var">`divUp`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Count Elements (TPrimExp Int64 VName)
forall a. a -&gt; Count Elements a
</span><a href="Futhark.CodeGen.ImpCode.html#elements"><span class="hs-identifier hs-var">Imp.elements</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelNumThreads"><span class="hs-identifier hs-var hs-var">kernelNumThreads</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684542126"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span>    </span><span id="local-6989586621684542108"><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684542108"><span class="hs-identifier hs-var">slugs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-216"></span><span>      </span><span class="annot"><span class="annottext">((SegBinOp GPUMem, [VName], [VName])
 -&gt; ImpM GPUMem KernelEnv KernelOp SegBinOpSlug)
-&gt; [(SegBinOp GPUMem, [VName], [VName])]
-&gt; ImpM GPUMem KernelEnv KernelOp [SegBinOpSlug]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
-&gt; TExp Int32
-&gt; (SegBinOp GPUMem, [VName], [VName])
-&gt; ImpM GPUMem KernelEnv KernelOp SegBinOpSlug
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#segBinOpSlug"><span class="hs-identifier hs-var">segBinOpSlug</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684542126"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupId"><span class="hs-identifier hs-var hs-var">kernelGroupId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684542126"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(SegBinOp GPUMem, [VName], [VName])]
 -&gt; ImpM GPUMem KernelEnv KernelOp [SegBinOpSlug])
-&gt; [(SegBinOp GPUMem, [VName], [VName])]
-&gt; ImpM GPUMem KernelEnv KernelOp [SegBinOpSlug]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-217"></span><span>        </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
-&gt; [[VName]] -&gt; [[VName]] -&gt; [(SegBinOp GPUMem, [VName], [VName])]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542150"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684542119"><span class="hs-identifier hs-var">reds_arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684542132"><span class="hs-identifier hs-var">reds_group_res_arrs</span></a></span><span>
</span><span id="line-218"></span><span>    </span><span id="local-6989586621684542103"><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684542103"><span class="hs-identifier hs-var">reds_op_renamed</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-219"></span><span>      </span><span class="annot"><span class="annottext">KernelConstants
-&gt; [(VName, TPrimExp Int64 VName)]
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; VName
-&gt; [SegBinOpSlug]
-&gt; DoSegBody
-&gt; InKernelGen [Lambda GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#reductionStageOne"><span class="hs-identifier hs-var">reductionStageOne</span></a></span><span>
</span><span id="line-220"></span><span>        </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684542126"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-221"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
-&gt; [TPrimExp Int64 VName] -&gt; [(VName, TPrimExp Int64 VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542148"><span class="hs-identifier hs-var">gtids</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542145"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>        </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542113"><span class="hs-identifier hs-var">num_elements</span></a></span><span>
</span><span id="line-223"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542142"><span class="hs-identifier hs-var">global_tid</span></a></span><span>
</span><span id="line-224"></span><span>        </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542111"><span class="hs-identifier hs-var">elems_per_thread</span></a></span><span>
</span><span id="line-225"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684542131"><span class="hs-identifier hs-var">num_threads</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>        </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684542108"><span class="hs-identifier hs-var">slugs</span></a></span><span>
</span><span id="line-227"></span><span>        </span><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684542149"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-228"></span><span>
</span><span id="line-229"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542100"><span class="annot"><span class="annottext">segred_pes :: [[PatElemT LParamMem]]
</span><a href="#local-6989586621684542100"><span class="hs-identifier hs-var hs-var">segred_pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-230"></span><span>          </span><span class="annot"><span class="annottext">[Int] -&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall a. [Int] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.Util.html#chunks"><span class="hs-identifier hs-var">chunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; Int) -&gt; [SegBinOp GPUMem] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int)
-&gt; (SegBinOp GPUMem -&gt; [SubExp]) -&gt; SegBinOp GPUMem -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542150"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [[PatElemT LParamMem]])
-&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-231"></span><span>            </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LParamMem
</span><a href="#local-6989586621684542154"><span class="hs-identifier hs-var">segred_pat</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span class="annot"><span class="annottext">[(SegBinOp GPUMem, [VName], [VName], [PatElemT LParamMem],
  SegBinOpSlug, Lambda GPUMem, Integer)]
-&gt; ((SegBinOp GPUMem, [VName], [VName], [PatElemT LParamMem],
     SegBinOpSlug, Lambda GPUMem, Integer)
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
-&gt; [[VName]]
-&gt; [[VName]]
-&gt; [[PatElemT LParamMem]]
-&gt; [SegBinOpSlug]
-&gt; [Lambda GPUMem]
-&gt; [Integer]
-&gt; [(SegBinOp GPUMem, [VName], [VName], [PatElemT LParamMem],
     SegBinOpSlug, Lambda GPUMem, Integer)]
forall a b c d e f g.
[a]
-&gt; [b]
-&gt; [c]
-&gt; [d]
-&gt; [e]
-&gt; [f]
-&gt; [g]
-&gt; [(a, b, c, d, e, f, g)]
</span><span class="hs-identifier hs-var">zip7</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542150"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684542119"><span class="hs-identifier hs-var">reds_arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684542132"><span class="hs-identifier hs-var">reds_group_res_arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684542100"><span class="hs-identifier hs-var">segred_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684542108"><span class="hs-identifier hs-var">slugs</span></a></span><span> </span><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684542103"><span class="hs-identifier hs-var">reds_op_renamed</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SegBinOp GPUMem, [VName], [VName], [PatElemT LParamMem],
   SegBinOpSlug, Lambda GPUMem, Integer)
  -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((SegBinOp GPUMem, [VName], [VName], [PatElemT LParamMem],
     SegBinOpSlug, Lambda GPUMem, Integer)
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-233"></span><span>      </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684542097"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684542097"><span class="hs-identifier hs-var">red_op</span></a></span></span><span> </span><span id="local-6989586621684542096"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542096"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542095"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542095"><span class="hs-identifier hs-var">red_arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542094"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542094"><span class="hs-identifier hs-var">group_res_arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542093"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684542093"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542092"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684542092"><span class="hs-identifier hs-var">slug</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542091"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684542091"><span class="hs-identifier hs-var">red_op_renamed</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542090"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684542090"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-234"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684542089"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684542089"><span class="hs-identifier hs-var">red_x_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542088"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684542088"><span class="hs-identifier hs-var">red_y_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542096"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem]))
-&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684542097"><span class="hs-identifier hs-var">red_op</span></a></span><span>
</span><span id="line-235"></span><span>        </span><span class="annot"><span class="annottext">KernelConstants
-&gt; [PatElem GPUMem]
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; [TPrimExp Int64 VName]
-&gt; TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName
-&gt; SegBinOpSlug
-&gt; [LParam GPUMem]
-&gt; [LParam GPUMem]
-&gt; Lambda GPUMem
-&gt; [SubExp]
-&gt; TExp Int32
-&gt; VName
-&gt; TExp Int32
-&gt; VName
-&gt; [VName]
-&gt; [VName]
-&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#reductionStageTwo"><span class="hs-identifier hs-var">reductionStageTwo</span></a></span><span>
</span><span id="line-236"></span><span>          </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684542126"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-237"></span><span>          </span><span class="annot"><span class="annottext">[PatElem GPUMem]
[PatElemT LParamMem]
</span><a href="#local-6989586621684542093"><span class="hs-identifier hs-var">pes</span></a></span><span>
</span><span id="line-238"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupId"><span class="hs-identifier hs-var hs-var">kernelGroupId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684542126"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>          </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span>
</span><span id="line-240"></span><span>          </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-241"></span><span>          </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span>
</span><span id="line-242"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelNumGroups"><span class="hs-identifier hs-var hs-var">kernelNumGroups</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684542126"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>          </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684542092"><span class="hs-identifier hs-var">slug</span></a></span><span>
</span><span id="line-244"></span><span>          </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param LParamMem]
</span><a href="#local-6989586621684542089"><span class="hs-identifier hs-var">red_x_params</span></a></span><span>
</span><span id="line-245"></span><span>          </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param LParamMem]
</span><a href="#local-6989586621684542088"><span class="hs-identifier hs-var">red_y_params</span></a></span><span>
</span><span id="line-246"></span><span>          </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684542091"><span class="hs-identifier hs-var">red_op_renamed</span></a></span><span>
</span><span id="line-247"></span><span>          </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542096"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-248"></span><span>          </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span>
</span><span id="line-249"></span><span>          </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684542138"><span class="hs-identifier hs-var">counter</span></a></span><span>
</span><span id="line-250"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; TExp Int32
forall a. Num a =&gt; Integer -&gt; a
</span><span class="hs-identifier hs-var">fromInteger</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684542090"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>          </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684542122"><span class="hs-identifier hs-var">sync_arr</span></a></span><span>
</span><span id="line-252"></span><span>          </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542094"><span class="hs-identifier hs-var">group_res_arrs</span></a></span><span>
</span><span id="line-253"></span><span>          </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542095"><span class="hs-identifier hs-var">red_arrs</span></a></span><span>
</span><span id="line-254"></span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#smallSegmentsReduction"><span class="hs-identifier hs-type">smallSegmentsReduction</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#NumGroups"><span class="hs-identifier hs-type">NumGroups</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-260"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#GroupSize"><span class="hs-identifier hs-type">GroupSize</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-261"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-262"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-263"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#DoSegBody"><span class="hs-identifier hs-type">DoSegBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-265"></span><span id="smallSegmentsReduction"><span class="annot"><span class="annottext">smallSegmentsReduction :: Pat GPUMem
-&gt; Count NumGroups SubExp
-&gt; Count GroupSize SubExp
-&gt; SegSpace
-&gt; [SegBinOp GPUMem]
-&gt; DoSegBody
-&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#smallSegmentsReduction"><span class="hs-identifier hs-var hs-var">smallSegmentsReduction</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span id="local-6989586621684542084"><span class="annot"><span class="annottext">[PatElem GPUMem]
</span><a href="#local-6989586621684542084"><span class="hs-identifier hs-var">segred_pes</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684542083"><span class="annot"><span class="annottext">Count NumGroups SubExp
</span><a href="#local-6989586621684542083"><span class="hs-identifier hs-var">num_groups</span></a></span></span><span> </span><span id="local-6989586621684542082"><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542082"><span class="hs-identifier hs-var">group_size</span></a></span></span><span> </span><span id="local-6989586621684542081"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542081"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684542080"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542080"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684542079"><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684542079"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684542078"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542078"><span class="hs-identifier hs-var">gtids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542077"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542077"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542081"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-267"></span><span>      </span><span id="local-6989586621684542076"><span class="annot"><span class="annottext">dims' :: [TPrimExp Int64 VName]
</span><a href="#local-6989586621684542076"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542077"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-268"></span><span>      </span><span id="local-6989586621684542075"><span class="annot"><span class="annottext">segment_size :: TPrimExp Int64 VName
</span><a href="#local-6989586621684542075"><span class="hs-identifier hs-var hs-var">segment_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542076"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-comment">-- Careful to avoid division by zero now.</span><span>
</span><span id="line-271"></span><span>  </span><span id="local-6989586621684542074"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542074"><span class="hs-identifier hs-var">segment_size_nonzero</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-272"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem HostEnv HostOp (TPrimExp Int64 VName)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segment_size_nonzero&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; ImpM GPUMem HostEnv HostOp (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem HostEnv HostOp (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall v. TPrimExp Int64 v -&gt; TPrimExp Int64 v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sMax64"><span class="hs-identifier hs-var">sMax64</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542075"><span class="hs-identifier hs-var">segment_size</span></a></span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542071"><span class="annot"><span class="annottext">num_groups' :: Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542071"><span class="hs-identifier hs-var hs-var">num_groups'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; Count NumGroups SubExp -&gt; Count NumGroups (TPrimExp Int64 VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups SubExp
</span><a href="#local-6989586621684542083"><span class="hs-identifier hs-var">num_groups</span></a></span><span>
</span><span id="line-275"></span><span>      </span><span id="local-6989586621684542070"><span class="annot"><span class="annottext">group_size' :: Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542070"><span class="hs-identifier hs-var hs-var">group_size'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; Count GroupSize SubExp -&gt; Count GroupSize (TPrimExp Int64 VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542082"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-276"></span><span>  </span><span id="local-6989586621684542069"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684542069"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_threads&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64))
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542071"><span class="hs-identifier hs-var">num_groups'</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542070"><span class="hs-identifier hs-var">group_size'</span></a></span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542068"><span class="annot"><span class="annottext">num_segments :: TPrimExp Int64 VName
</span><a href="#local-6989586621684542068"><span class="hs-identifier hs-var hs-var">num_segments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542076"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-278"></span><span>      </span><span id="local-6989586621684542065"><span class="annot"><span class="annottext">segments_per_group :: TPrimExp Int64 VName
</span><a href="#local-6989586621684542065"><span class="hs-identifier hs-var hs-var">segments_per_group</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542070"><span class="hs-identifier hs-var">group_size'</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542074"><span class="hs-identifier hs-var">segment_size_nonzero</span></a></span><span>
</span><span id="line-279"></span><span>      </span><span id="local-6989586621684542064"><span class="annot"><span class="annottext">required_groups :: TExp Int32
</span><a href="#local-6989586621684542064"><span class="hs-identifier hs-var hs-var">required_groups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; TExp Int32)
-&gt; TPrimExp Int64 VName -&gt; TExp Int32
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542068"><span class="hs-identifier hs-var">num_segments</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-operator hs-var">`divUp`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542065"><span class="hs-identifier hs-var">segments_per_group</span></a></span><span>
</span><span id="line-280"></span><span>
</span><span id="line-281"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n# SegRed-small&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-282"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_segments&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542068"><span class="hs-identifier hs-var">num_segments</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segment_size&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542075"><span class="hs-identifier hs-var">segment_size</span></a></span><span>
</span><span id="line-284"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segments_per_group&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542065"><span class="hs-identifier hs-var">segments_per_group</span></a></span><span>
</span><span id="line-285"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;required_groups&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684542064"><span class="hs-identifier hs-var">required_groups</span></a></span><span>
</span><span id="line-286"></span><span>
</span><span id="line-287"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; Count NumGroups (TPrimExp Int64 VName)
-&gt; Count GroupSize (TPrimExp Int64 VName)
-&gt; VName
-&gt; InKernelGen ()
-&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelThread"><span class="hs-identifier hs-var">sKernelThread</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segred_small&quot;</span></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542071"><span class="hs-identifier hs-var">num_groups'</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542070"><span class="hs-identifier hs-var">group_size'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542081"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; CallKernelGen ())
-&gt; InKernelGen () -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>    </span><span id="local-6989586621684542061"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684542061"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelConstants)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp KernelConstants
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-289"></span><span>    </span><span id="local-6989586621684542060"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684542060"><span class="hs-identifier hs-var">reds_arrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; InKernelGen [VName])
-&gt; [SegBinOp GPUMem] -&gt; ImpM GPUMem KernelEnv KernelOp [[VName]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count GroupSize SubExp
-&gt; SubExp -&gt; SegBinOp GPUMem -&gt; InKernelGen [VName]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#intermediateArrays"><span class="hs-identifier hs-var">intermediateArrays</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542082"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684542069"><span class="hs-identifier hs-var">num_threads</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542080"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span>    </span><span class="hs-comment">-- We probably do not have enough actual workgroups to cover the</span><span>
</span><span id="line-292"></span><span>    </span><span class="hs-comment">-- entire iteration space.  Some groups thus have to perform double</span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-comment">-- duty; we put an outer loop to accomplish this.</span><span>
</span><span id="line-294"></span><span>    </span><span class="annot"><span class="annottext">SegVirt
-&gt; TExp Int32 -&gt; (TExp Int32 -&gt; InKernelGen ()) -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#virtualiseGroups"><span class="hs-identifier hs-var">virtualiseGroups</span></a></span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><a href="Futhark.IR.SegOp.html#SegVirt"><span class="hs-identifier hs-var">SegVirt</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684542064"><span class="hs-identifier hs-var">required_groups</span></a></span><span> </span><span class="annot"><span class="annottext">((TExp Int32 -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; (TExp Int32 -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684542056"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684542056"><span class="hs-identifier hs-var">group_id'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-295"></span><span>      </span><span class="hs-comment">-- Compute the 'n' input indices.  The outer 'n-1' correspond to</span><span>
</span><span id="line-296"></span><span>      </span><span class="hs-comment">-- the segment ID, and are computed from the group id.  The inner</span><span>
</span><span id="line-297"></span><span>      </span><span class="hs-comment">-- is computed from the local thread id, and may be out-of-bounds.</span><span>
</span><span id="line-298"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542055"><span class="annot"><span class="annottext">ltid :: TPrimExp Int64 VName
</span><a href="#local-6989586621684542055"><span class="hs-identifier hs-var hs-var">ltid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TPrimExp Int64 VName)
-&gt; TExp Int32 -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684542061"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-299"></span><span>          </span><span id="local-6989586621684542054"><span class="annot"><span class="annottext">segment_index :: TPrimExp Int64 VName
</span><a href="#local-6989586621684542054"><span class="hs-identifier hs-var hs-var">segment_index</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-300"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542055"><span class="hs-identifier hs-var">ltid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542074"><span class="hs-identifier hs-var">segment_size_nonzero</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>              </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684542056"><span class="hs-identifier hs-var">group_id'</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542065"><span class="hs-identifier hs-var">segments_per_group</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-302"></span><span>          </span><span id="local-6989586621684542052"><span class="annot"><span class="annottext">index_within_segment :: TPrimExp Int64 VName
</span><a href="#local-6989586621684542052"><span class="hs-identifier hs-var hs-var">index_within_segment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542055"><span class="hs-identifier hs-var">ltid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542075"><span class="hs-identifier hs-var">segment_size</span></a></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span>      </span><span class="annot"><span class="annottext">[(VName, TPrimExp Int64 VName)]
-&gt; TPrimExp Int64 VName -&gt; InKernelGen ()
forall rep r op.
[(VName, TPrimExp Int64 VName)]
-&gt; TPrimExp Int64 VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace"><span class="hs-identifier hs-var">dIndexSpace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
-&gt; [TPrimExp Int64 VName] -&gt; [(VName, TPrimExp Int64 VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542078"><span class="hs-identifier hs-var">gtids</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542076"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542054"><span class="hs-identifier hs-var">segment_index</span></a></span><span>
</span><span id="line-305"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName -&gt; InKernelGen ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; VName
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542078"><span class="hs-identifier hs-var">gtids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542052"><span class="hs-identifier hs-var">index_within_segment</span></a></span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542050"><span class="annot"><span class="annottext">out_of_bounds :: InKernelGen ()
</span><a href="#local-6989586621684542050"><span class="hs-identifier hs-var hs-var">out_of_bounds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-308"></span><span>            </span><span class="annot"><span class="annottext">[(SegBinOp GPUMem, [VName])]
-&gt; ((SegBinOp GPUMem, [VName]) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp GPUMem] -&gt; [[VName]] -&gt; [(SegBinOp GPUMem, [VName])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542080"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684542060"><span class="hs-identifier hs-var">reds_arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SegBinOp GPUMem, [VName]) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((SegBinOp GPUMem, [VName]) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684542049"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542049"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542048"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542048"><span class="hs-identifier hs-var">red_arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-309"></span><span>              </span><span class="annot"><span class="annottext">[(VName, SubExp)]
-&gt; ((VName, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542048"><span class="hs-identifier hs-var">red_arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542049"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((VName, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684542047"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684542047"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542046"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684542046"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-310"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684542047"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542055"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684542046"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-311"></span><span>
</span><span id="line-312"></span><span>          </span><span id="local-6989586621684542044"><span class="annot"><span class="annottext">in_bounds :: InKernelGen ()
</span><a href="#local-6989586621684542044"><span class="hs-identifier hs-var hs-var">in_bounds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-313"></span><span>            </span><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684542079"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">DoSegBody -&gt; DoSegBody
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684542043"><span class="annot"><span class="annottext">[(SubExp, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684542043"><span class="hs-identifier hs-var">red_res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-314"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;save results to be reduced&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-315"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542042"><span class="annot"><span class="annottext">red_dests :: [(VName, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684542042"><span class="hs-identifier hs-var hs-var">red_dests</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; [[TPrimExp Int64 VName]] -&gt; [(VName, [TPrimExp Int64 VName])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[VName]] -&gt; [VName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684542060"><span class="hs-identifier hs-var">reds_arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([[TPrimExp Int64 VName]] -&gt; [(VName, [TPrimExp Int64 VName])])
-&gt; [[TPrimExp Int64 VName]] -&gt; [(VName, [TPrimExp Int64 VName])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; [[TPrimExp Int64 VName]]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542055"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-316"></span><span>                </span><span class="annot"><span class="annottext">[((VName, [TPrimExp Int64 VName]),
  (SubExp, [TPrimExp Int64 VName]))]
-&gt; (((VName, [TPrimExp Int64 VName]),
     (SubExp, [TPrimExp Int64 VName]))
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(VName, [TPrimExp Int64 VName])]
-&gt; [(SubExp, [TPrimExp Int64 VName])]
-&gt; [((VName, [TPrimExp Int64 VName]),
     (SubExp, [TPrimExp Int64 VName]))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[(VName, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684542042"><span class="hs-identifier hs-var">red_dests</span></a></span><span> </span><span class="annot"><span class="annottext">[(SubExp, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684542043"><span class="hs-identifier hs-var">red_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((((VName, [TPrimExp Int64 VName]),
   (SubExp, [TPrimExp Int64 VName]))
  -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; (((VName, [TPrimExp Int64 VName]),
     (SubExp, [TPrimExp Int64 VName]))
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684542040"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684542040"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542039"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542039"><span class="hs-identifier hs-var">d_is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684542038"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684542038"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542037"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542037"><span class="hs-identifier hs-var">res_is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-317"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684542040"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542039"><span class="hs-identifier hs-var">d_is</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684542038"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542037"><span class="hs-identifier hs-var">res_is</span></a></span><span>
</span><span id="line-318"></span><span>
</span><span id="line-319"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;apply map function if in bounds&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-320"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; InKernelGen () -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
TPrimExp Bool VName
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span>
</span><span id="line-321"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542075"><span class="hs-identifier hs-var">segment_size</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3E."><span class="hs-operator hs-var">.&gt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span>
</span><span id="line-322"></span><span>              </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; TPrimExp Bool VName -&gt; TPrimExp Bool VName
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; TPrimExp Bool VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#isActive"><span class="hs-identifier hs-var">isActive</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; [(VName, SubExp)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; [(VName, SubExp)])
-&gt; [(VName, SubExp)] -&gt; [(VName, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542078"><span class="hs-identifier hs-var">gtids</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542077"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>              </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; TPrimExp Bool VName -&gt; TPrimExp Bool VName
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542055"><span class="hs-identifier hs-var">ltid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542075"><span class="hs-identifier hs-var">segment_size</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542065"><span class="hs-identifier hs-var">segments_per_group</span></a></span><span>
</span><span id="line-324"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>          </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684542044"><span class="hs-identifier hs-var">in_bounds</span></a></span><span>
</span><span id="line-326"></span><span>          </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684542050"><span class="hs-identifier hs-var">out_of_bounds</span></a></span><span>
</span><span id="line-327"></span><span>
</span><span id="line-328"></span><span>      </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#ErrorSync"><span class="hs-identifier hs-var">Imp.ErrorSync</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span> </span><span class="hs-comment">-- Also implicitly barrier.</span><span>
</span><span id="line-329"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542030"><span class="annot"><span class="annottext">crossesSegment :: TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
</span><a href="#local-6989586621684542030"><span class="hs-identifier hs-var hs-var">crossesSegment</span></a></span></span><span> </span><span id="local-6989586621684542029"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684542029"><span class="hs-identifier hs-var">from</span></a></span></span><span> </span><span id="local-6989586621684542028"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684542028"><span class="hs-identifier hs-var">to</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-330"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684542028"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684542029"><span class="hs-identifier hs-var">from</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3E."><span class="hs-operator hs-var">.&gt;.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684542028"><span class="hs-identifier hs-var">to</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542075"><span class="hs-identifier hs-var">segment_size</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542075"><span class="hs-identifier hs-var">segment_size</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3E."><span class="hs-operator hs-var">.&gt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-332"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;perform segmented scan to imitate reduction&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-333"></span><span>          </span><span class="annot"><span class="annottext">[(SegBinOp GPUMem, [VName])]
-&gt; ((SegBinOp GPUMem, [VName]) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp GPUMem] -&gt; [[VName]] -&gt; [(SegBinOp GPUMem, [VName])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542080"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684542060"><span class="hs-identifier hs-var">reds_arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SegBinOp GPUMem, [VName]) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((SegBinOp GPUMem, [VName]) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684542026"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684542026"><span class="hs-identifier hs-var">red_op</span></a></span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542025"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542025"><span class="hs-identifier hs-var">red_arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-334"></span><span>            </span><span class="annot"><span class="annottext">Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName)
-&gt; TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName
-&gt; Lambda GPUMem
-&gt; [VName]
-&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupScan"><span class="hs-identifier hs-var">groupScan</span></a></span><span>
</span><span id="line-335"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName)
-&gt; Maybe (TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
</span><a href="#local-6989586621684542030"><span class="hs-identifier hs-var">crossesSegment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684542069"><span class="hs-identifier hs-var">num_threads</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542075"><span class="hs-identifier hs-var">segment_size</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542065"><span class="hs-identifier hs-var">segments_per_group</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span>              </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684542026"><span class="hs-identifier hs-var">red_op</span></a></span><span>
</span><span id="line-339"></span><span>              </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542025"><span class="hs-identifier hs-var">red_arrs</span></a></span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>      </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-342"></span><span>
</span><span id="line-343"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;save final values of segments&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-344"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span>
</span><span id="line-345"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684542056"><span class="hs-identifier hs-var">group_id'</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542065"><span class="hs-identifier hs-var">segments_per_group</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542055"><span class="hs-identifier hs-var">ltid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542068"><span class="hs-identifier hs-var">num_segments</span></a></span><span>
</span><span id="line-346"></span><span>              </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; TPrimExp Bool VName -&gt; TPrimExp Bool VName
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542055"><span class="hs-identifier hs-var">ltid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542065"><span class="hs-identifier hs-var">segments_per_group</span></a></span><span>
</span><span id="line-347"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>          </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, VName)]
-&gt; ((PatElemT LParamMem, VName) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; [VName] -&gt; [(PatElemT LParamMem, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElem GPUMem]
[PatElemT LParamMem]
</span><a href="#local-6989586621684542084"><span class="hs-identifier hs-var">segred_pes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[VName]] -&gt; [VName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684542060"><span class="hs-identifier hs-var">reds_arrs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((PatElemT LParamMem, VName) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684542021"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684542021"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542020"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684542020"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-349"></span><span>            </span><span class="hs-comment">-- Figure out which segment result this thread should write...</span><span>
</span><span id="line-350"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684542019"><span class="annot"><span class="annottext">flat_segment_index :: TPrimExp Int64 VName
</span><a href="#local-6989586621684542019"><span class="hs-identifier hs-var hs-var">flat_segment_index</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-351"></span><span>                  </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684542056"><span class="hs-identifier hs-var">group_id'</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542065"><span class="hs-identifier hs-var">segments_per_group</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542055"><span class="hs-identifier hs-var">ltid</span></a></span><span>
</span><span id="line-352"></span><span>                </span><span id="local-6989586621684542018"><span class="annot"><span class="annottext">gtids' :: [TPrimExp Int64 VName]
</span><a href="#local-6989586621684542018"><span class="hs-identifier hs-var hs-var">gtids'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-353"></span><span>                  </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; TPrimExp Int64 VName -&gt; [TPrimExp Int64 VName]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542076"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542019"><span class="hs-identifier hs-var">flat_segment_index</span></a></span><span>
</span><span id="line-354"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span>
</span><span id="line-355"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684542021"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-356"></span><span>              </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542018"><span class="hs-identifier hs-var">gtids'</span></a></span><span>
</span><span id="line-357"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684542020"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>              </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542055"><span class="hs-identifier hs-var">ltid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542074"><span class="hs-identifier hs-var">segment_size_nonzero</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span>      </span><span class="hs-comment">-- Finally another barrier, because we will be writing to the</span><span>
</span><span id="line-361"></span><span>      </span><span class="hs-comment">-- local memory array first thing in the next iteration.</span><span>
</span><span id="line-362"></span><span>      </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-365"></span><span>
</span><span id="line-366"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#largeSegmentsReduction"><span class="hs-identifier hs-type">largeSegmentsReduction</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-367"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-368"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#NumGroups"><span class="hs-identifier hs-type">NumGroups</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-369"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#GroupSize"><span class="hs-identifier hs-type">GroupSize</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-370"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-371"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-372"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#DoSegBody"><span class="hs-identifier hs-type">DoSegBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-373"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span id="largeSegmentsReduction"><span class="annot"><span class="annottext">largeSegmentsReduction :: Pat GPUMem
-&gt; Count NumGroups SubExp
-&gt; Count GroupSize SubExp
-&gt; SegSpace
-&gt; [SegBinOp GPUMem]
-&gt; DoSegBody
-&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#largeSegmentsReduction"><span class="hs-identifier hs-var hs-var">largeSegmentsReduction</span></a></span></span><span> </span><span id="local-6989586621684542015"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684542015"><span class="hs-identifier hs-var">segred_pat</span></a></span></span><span> </span><span id="local-6989586621684542014"><span class="annot"><span class="annottext">Count NumGroups SubExp
</span><a href="#local-6989586621684542014"><span class="hs-identifier hs-var">num_groups</span></a></span></span><span> </span><span id="local-6989586621684542013"><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542013"><span class="hs-identifier hs-var">group_size</span></a></span></span><span> </span><span id="local-6989586621684542012"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542012"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684542011"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542011"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684542010"><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684542010"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-375"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684542009"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542009"><span class="hs-identifier hs-var">gtids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542008"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542008"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542012"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-376"></span><span>      </span><span id="local-6989586621684542007"><span class="annot"><span class="annottext">dims' :: [TPrimExp Int64 VName]
</span><a href="#local-6989586621684542007"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542008"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-377"></span><span>      </span><span id="local-6989586621684542006"><span class="annot"><span class="annottext">num_segments :: TPrimExp Int64 VName
</span><a href="#local-6989586621684542006"><span class="hs-identifier hs-var hs-var">num_segments</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542007"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-378"></span><span>      </span><span id="local-6989586621684542005"><span class="annot"><span class="annottext">segment_size :: TPrimExp Int64 VName
</span><a href="#local-6989586621684542005"><span class="hs-identifier hs-var hs-var">segment_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542007"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-379"></span><span>      </span><span id="local-6989586621684542004"><span class="annot"><span class="annottext">num_groups' :: Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542004"><span class="hs-identifier hs-var hs-var">num_groups'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; Count NumGroups SubExp -&gt; Count NumGroups (TPrimExp Int64 VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups SubExp
</span><a href="#local-6989586621684542014"><span class="hs-identifier hs-var">num_groups</span></a></span><span>
</span><span id="line-380"></span><span>      </span><span id="local-6989586621684542003"><span class="annot"><span class="annottext">group_size' :: Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542003"><span class="hs-identifier hs-var hs-var">group_size'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; Count GroupSize SubExp -&gt; Count GroupSize (TPrimExp Int64 VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542013"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684542002"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542002"><span class="hs-identifier hs-var">groups_per_segment</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684542001"><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542001"><span class="hs-identifier hs-var">elems_per_thread</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-383"></span><span>    </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName
-&gt; Count NumGroups (TPrimExp Int64 VName)
-&gt; Count GroupSize (TPrimExp Int64 VName)
-&gt; CallKernelGen
     (TPrimExp Int64 VName, Count Elements (TPrimExp Int64 VName))
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#groupsPerSegmentAndElementsPerThread"><span class="hs-identifier hs-var">groupsPerSegmentAndElementsPerThread</span></a></span><span>
</span><span id="line-384"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542005"><span class="hs-identifier hs-var">segment_size</span></a></span><span>
</span><span id="line-385"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542006"><span class="hs-identifier hs-var">num_segments</span></a></span><span>
</span><span id="line-386"></span><span>      </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542004"><span class="hs-identifier hs-var">num_groups'</span></a></span><span>
</span><span id="line-387"></span><span>      </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542003"><span class="hs-identifier hs-var">group_size'</span></a></span><span>
</span><span id="line-388"></span><span>  </span><span id="local-6989586621684541999"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541999"><span class="hs-identifier hs-var">virt_num_groups</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-389"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;virt_num_groups&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64))
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-390"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542002"><span class="hs-identifier hs-var">groups_per_segment</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542006"><span class="hs-identifier hs-var">num_segments</span></a></span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span>  </span><span id="local-6989586621684541998"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541998"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-393"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_threads&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64))
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-394"></span><span>      </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542004"><span class="hs-identifier hs-var">num_groups'</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542003"><span class="hs-identifier hs-var">group_size'</span></a></span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span>  </span><span id="local-6989586621684541997"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541997"><span class="hs-identifier hs-var">threads_per_segment</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-397"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV"><span class="hs-identifier hs-var">dPrimV</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;threads_per_segment&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64))
-&gt; TPrimExp Int64 VName -&gt; ImpM GPUMem HostEnv HostOp (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-398"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542002"><span class="hs-identifier hs-var">groups_per_segment</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542003"><span class="hs-identifier hs-var">group_size'</span></a></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\n# SegRed-large&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-401"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_segments&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542006"><span class="hs-identifier hs-var">num_segments</span></a></span><span>
</span><span id="line-402"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segment_size&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542005"><span class="hs-identifier hs-var">segment_size</span></a></span><span>
</span><span id="line-403"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;virt_num_groups&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; Exp) -&gt; TPrimExp Int64 VName -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541999"><span class="hs-identifier hs-var">virt_num_groups</span></a></span><span>
</span><span id="line-404"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_groups&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; Exp) -&gt; TPrimExp Int64 VName -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542004"><span class="hs-identifier hs-var">num_groups'</span></a></span><span>
</span><span id="line-405"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;group_size&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; Exp) -&gt; TPrimExp Int64 VName -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542003"><span class="hs-identifier hs-var">group_size'</span></a></span><span>
</span><span id="line-406"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;elems_per_thread&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; Exp) -&gt; TPrimExp Int64 VName -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542001"><span class="hs-identifier hs-var">elems_per_thread</span></a></span><span>
</span><span id="line-407"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;groups_per_segment&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Code HostOp) -&gt; Maybe Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; Maybe Exp
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Maybe Exp) -&gt; Exp -&gt; Maybe Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542002"><span class="hs-identifier hs-var">groups_per_segment</span></a></span><span>
</span><span id="line-408"></span><span>
</span><span id="line-409"></span><span>  </span><span id="local-6989586621684541996"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684541996"><span class="hs-identifier hs-var">reds_group_res_arrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Count NumGroups SubExp
-&gt; Count GroupSize SubExp
-&gt; [SegBinOp GPUMem]
-&gt; CallKernelGen [[VName]]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#groupResultArrays"><span class="hs-identifier hs-var">groupResultArrays</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Count NumGroups SubExp
forall u e. e -&gt; Count u e
</span><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-var">Count</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541999"><span class="hs-identifier hs-var">virt_num_groups</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542013"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542011"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-comment">-- In principle we should have a counter for every segment.  Since</span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-comment">-- the number of segments is a dynamic quantity, we would have to</span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-comment">-- allocate and zero out an array here, which is expensive.</span><span>
</span><span id="line-414"></span><span>  </span><span class="hs-comment">-- However, we exploit the fact that the number of segments being</span><span>
</span><span id="line-415"></span><span>  </span><span class="hs-comment">-- reduced at any point in time is limited by the number of</span><span>
</span><span id="line-416"></span><span>  </span><span class="hs-comment">-- workgroups. If we bound the number of workgroups, we can get away</span><span>
</span><span id="line-417"></span><span>  </span><span class="hs-comment">-- with using that many counters.  FIXME: Is this limit checked</span><span>
</span><span id="line-418"></span><span>  </span><span class="hs-comment">-- anywhere?  There are other places in the compiler that will fail</span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-comment">-- if the group count exceeds the maximum group size, which is at</span><span>
</span><span id="line-420"></span><span>  </span><span class="hs-comment">-- most 1024 anyway.</span><span>
</span><span id="line-421"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684541991"><span class="annot"><span class="annottext">num_counters :: Int
</span><a href="#local-6989586621684541991"><span class="hs-identifier hs-var hs-var">num_counters</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int32 -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#maxNumOps"><span class="hs-identifier hs-var">maxNumOps</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1024</span></span><span>
</span><span id="line-422"></span><span>  </span><span id="local-6989586621684541990"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541990"><span class="hs-identifier hs-var">counter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-423"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; Space
-&gt; PrimType
-&gt; ArrayContents
-&gt; ImpM GPUMem HostEnv HostOp VName
forall rep r op.
String -&gt; Space -&gt; PrimType -&gt; ArrayContents -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sStaticArray"><span class="hs-identifier hs-var">sStaticArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;counter&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span> </span><span class="annot"><span class="annottext">(ArrayContents -&gt; ImpM GPUMem HostEnv HostOp VName)
-&gt; ArrayContents -&gt; ImpM GPUMem HostEnv HostOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-424"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; ArrayContents
</span><a href="Futhark.CodeGen.ImpCode.html#ArrayZeros"><span class="hs-identifier hs-var">Imp.ArrayZeros</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684541991"><span class="hs-identifier hs-var">num_counters</span></a></span><span>
</span><span id="line-425"></span><span>
</span><span id="line-426"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; Count NumGroups (TPrimExp Int64 VName)
-&gt; Count GroupSize (TPrimExp Int64 VName)
-&gt; VName
-&gt; InKernelGen ()
-&gt; CallKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sKernelThread"><span class="hs-identifier hs-var">sKernelThread</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segred_large&quot;</span></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542004"><span class="hs-identifier hs-var">num_groups'</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542003"><span class="hs-identifier hs-var">group_size'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684542012"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; CallKernelGen ())
-&gt; InKernelGen () -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-427"></span><span>    </span><span id="local-6989586621684541988"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684541988"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelEnv -&gt; KernelConstants
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelConstants"><span class="hs-identifier hs-var hs-var">kernelConstants</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelEnv -&gt; KernelConstants)
-&gt; ImpM GPUMem KernelEnv KernelOp KernelEnv
-&gt; ImpM GPUMem KernelEnv KernelOp KernelConstants
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem KernelEnv KernelOp KernelEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-428"></span><span>    </span><span id="local-6989586621684541987"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684541987"><span class="hs-identifier hs-var">reds_arrs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; InKernelGen [VName])
-&gt; [SegBinOp GPUMem] -&gt; ImpM GPUMem KernelEnv KernelOp [[VName]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count GroupSize SubExp
-&gt; SubExp -&gt; SegBinOp GPUMem -&gt; InKernelGen [VName]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#intermediateArrays"><span class="hs-identifier hs-var">intermediateArrays</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize SubExp
</span><a href="#local-6989586621684542013"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541998"><span class="hs-identifier hs-var">num_threads</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542011"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-429"></span><span>    </span><span id="local-6989586621684541986"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541986"><span class="hs-identifier hs-var">sync_arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; PrimType
-&gt; Shape
-&gt; Space
-&gt; ImpM GPUMem KernelEnv KernelOp VName
forall rep r op.
String -&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var">sAllocArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;sync_arr&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Primitive.html#Bool"><span class="hs-identifier hs-var">Bool</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Space -&gt; ImpM GPUMem KernelEnv KernelOp VName)
-&gt; Space -&gt; ImpM GPUMem KernelEnv KernelOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span>
</span><span id="line-430"></span><span>
</span><span id="line-431"></span><span>    </span><span class="hs-comment">-- We probably do not have enough actual workgroups to cover the</span><span>
</span><span id="line-432"></span><span>    </span><span class="hs-comment">-- entire iteration space.  Some groups thus have to perform double</span><span>
</span><span id="line-433"></span><span>    </span><span class="hs-comment">-- duty; we put an outer loop to accomplish this.</span><span>
</span><span id="line-434"></span><span>    </span><span class="annot"><span class="annottext">SegVirt
-&gt; TExp Int32 -&gt; (TExp Int32 -&gt; InKernelGen ()) -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#virtualiseGroups"><span class="hs-identifier hs-var">virtualiseGroups</span></a></span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><a href="Futhark.IR.SegOp.html#SegVirt"><span class="hs-identifier hs-var">SegVirt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541999"><span class="hs-identifier hs-var">virt_num_groups</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((TExp Int32 -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; (TExp Int32 -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684541985"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541985"><span class="hs-identifier hs-var">group_id</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-435"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684541984"><span class="annot"><span class="annottext">segment_gtids :: [VName]
</span><a href="#local-6989586621684541984"><span class="hs-identifier hs-var hs-var">segment_gtids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542009"><span class="hs-identifier hs-var">gtids</span></a></span><span>
</span><span id="line-436"></span><span>          </span><span id="local-6989586621684541983"><span class="annot"><span class="annottext">w :: SubExp
</span><a href="#local-6989586621684541983"><span class="hs-identifier hs-var hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; SubExp
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684542008"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-437"></span><span>          </span><span id="local-6989586621684541982"><span class="annot"><span class="annottext">local_tid :: TExp Int32
</span><a href="#local-6989586621684541982"><span class="hs-identifier hs-var hs-var">local_tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684541988"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-438"></span><span>
</span><span id="line-439"></span><span>      </span><span id="local-6989586621684541981"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541981"><span class="hs-identifier hs-var">flat_segment_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-440"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;flat_segment_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32))
-&gt; TExp Int32 -&gt; ImpM GPUMem KernelEnv KernelOp (TExp Int32)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-441"></span><span>          </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541985"><span class="hs-identifier hs-var">group_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542002"><span class="hs-identifier hs-var">groups_per_segment</span></a></span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span>      </span><span id="local-6989586621684541980"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541980"><span class="hs-identifier hs-var">global_tid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-444"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;global_tid&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-445"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541985"><span class="hs-identifier hs-var">group_id</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542003"><span class="hs-identifier hs-var">group_size'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541982"><span class="hs-identifier hs-var">local_tid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-446"></span><span>            </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542003"><span class="hs-identifier hs-var">group_size'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542002"><span class="hs-identifier hs-var">groups_per_segment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>
</span><span id="line-448"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684541979"><span class="annot"><span class="annottext">first_group_for_segment :: TPrimExp Int64 VName
</span><a href="#local-6989586621684541979"><span class="hs-identifier hs-var hs-var">first_group_for_segment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541981"><span class="hs-identifier hs-var">flat_segment_id</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542002"><span class="hs-identifier hs-var">groups_per_segment</span></a></span><span>
</span><span id="line-449"></span><span>      </span><span class="annot"><span class="annottext">[(VName, TPrimExp Int64 VName)]
-&gt; TPrimExp Int64 VName -&gt; InKernelGen ()
forall rep r op.
[(VName, TPrimExp Int64 VName)]
-&gt; TPrimExp Int64 VName -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dIndexSpace"><span class="hs-identifier hs-var">dIndexSpace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
-&gt; [TPrimExp Int64 VName] -&gt; [(VName, TPrimExp Int64 VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541984"><span class="hs-identifier hs-var">segment_gtids</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542007"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; InKernelGen ())
-&gt; TPrimExp Int64 VName -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541981"><span class="hs-identifier hs-var">flat_segment_id</span></a></span><span>
</span><span id="line-450"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; InKernelGen ()
forall rep r op. VName -&gt; PrimType -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim_"><span class="hs-identifier hs-var">dPrim_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; VName
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542009"><span class="hs-identifier hs-var">gtids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-451"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684541976"><span class="annot"><span class="annottext">num_elements :: Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541976"><span class="hs-identifier hs-var hs-var">num_elements</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Count Elements (TPrimExp Int64 VName)
forall a. a -&gt; Count Elements a
</span><a href="Futhark.CodeGen.ImpCode.html#elements"><span class="hs-identifier hs-var">Imp.elements</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; Count Elements (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName -&gt; Count Elements (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
forall a. ToExp a =&gt; a -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684541983"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span>      </span><span id="local-6989586621684541975"><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541975"><span class="hs-identifier hs-var">slugs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-454"></span><span>        </span><span class="annot"><span class="annottext">((SegBinOp GPUMem, [VName], [VName])
 -&gt; ImpM GPUMem KernelEnv KernelOp SegBinOpSlug)
-&gt; [(SegBinOp GPUMem, [VName], [VName])]
-&gt; ImpM GPUMem KernelEnv KernelOp [SegBinOpSlug]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
-&gt; TExp Int32
-&gt; (SegBinOp GPUMem, [VName], [VName])
-&gt; ImpM GPUMem KernelEnv KernelOp SegBinOpSlug
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#segBinOpSlug"><span class="hs-identifier hs-var">segBinOpSlug</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541982"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541985"><span class="hs-identifier hs-var">group_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(SegBinOp GPUMem, [VName], [VName])]
 -&gt; ImpM GPUMem KernelEnv KernelOp [SegBinOpSlug])
-&gt; [(SegBinOp GPUMem, [VName], [VName])]
-&gt; ImpM GPUMem KernelEnv KernelOp [SegBinOpSlug]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-455"></span><span>          </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
-&gt; [[VName]] -&gt; [[VName]] -&gt; [(SegBinOp GPUMem, [VName], [VName])]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542011"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684541987"><span class="hs-identifier hs-var">reds_arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684541996"><span class="hs-identifier hs-var">reds_group_res_arrs</span></a></span><span>
</span><span id="line-456"></span><span>      </span><span id="local-6989586621684541974"><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684541974"><span class="hs-identifier hs-var">reds_op_renamed</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-457"></span><span>        </span><span class="annot"><span class="annottext">KernelConstants
-&gt; [(VName, TPrimExp Int64 VName)]
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; VName
-&gt; [SegBinOpSlug]
-&gt; DoSegBody
-&gt; InKernelGen [Lambda GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#reductionStageOne"><span class="hs-identifier hs-var">reductionStageOne</span></a></span><span>
</span><span id="line-458"></span><span>          </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684541988"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-459"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
-&gt; [TPrimExp Int64 VName] -&gt; [(VName, TPrimExp Int64 VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684542009"><span class="hs-identifier hs-var">gtids</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684542007"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-460"></span><span>          </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541976"><span class="hs-identifier hs-var">num_elements</span></a></span><span>
</span><span id="line-461"></span><span>          </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541980"><span class="hs-identifier hs-var">global_tid</span></a></span><span>
</span><span id="line-462"></span><span>          </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684542001"><span class="hs-identifier hs-var">elems_per_thread</span></a></span><span>
</span><span id="line-463"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541997"><span class="hs-identifier hs-var">threads_per_segment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>          </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541975"><span class="hs-identifier hs-var">slugs</span></a></span><span>
</span><span id="line-465"></span><span>          </span><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684542010"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-466"></span><span>
</span><span id="line-467"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684541973"><span class="annot"><span class="annottext">segred_pes :: [[PatElemT LParamMem]]
</span><a href="#local-6989586621684541973"><span class="hs-identifier hs-var hs-var">segred_pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-468"></span><span>            </span><span class="annot"><span class="annottext">[Int] -&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall a. [Int] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.Util.html#chunks"><span class="hs-identifier hs-var">chunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; Int) -&gt; [SegBinOp GPUMem] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int)
-&gt; (SegBinOp GPUMem -&gt; [SubExp]) -&gt; SegBinOp GPUMem -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542011"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [[PatElemT LParamMem]])
-&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-469"></span><span>              </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LParamMem
</span><a href="#local-6989586621684542015"><span class="hs-identifier hs-var">segred_pat</span></a></span><span>
</span><span id="line-470"></span><span>
</span><span id="line-471"></span><span>          </span><span id="local-6989586621684541972"><span class="annot"><span class="annottext">multiple_groups_per_segment :: InKernelGen ()
</span><a href="#local-6989586621684541972"><span class="hs-identifier hs-var hs-var">multiple_groups_per_segment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-472"></span><span>            </span><span class="annot"><span class="annottext">[(SegBinOp GPUMem, [VName], [VName], [PatElemT LParamMem],
  SegBinOpSlug, Lambda GPUMem, Integer)]
-&gt; ((SegBinOp GPUMem, [VName], [VName], [PatElemT LParamMem],
     SegBinOpSlug, Lambda GPUMem, Integer)
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
-&gt; [[VName]]
-&gt; [[VName]]
-&gt; [[PatElemT LParamMem]]
-&gt; [SegBinOpSlug]
-&gt; [Lambda GPUMem]
-&gt; [Integer]
-&gt; [(SegBinOp GPUMem, [VName], [VName], [PatElemT LParamMem],
     SegBinOpSlug, Lambda GPUMem, Integer)]
forall a b c d e f g.
[a]
-&gt; [b]
-&gt; [c]
-&gt; [d]
-&gt; [e]
-&gt; [f]
-&gt; [g]
-&gt; [(a, b, c, d, e, f, g)]
</span><span class="hs-identifier hs-var">zip7</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684542011"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684541987"><span class="hs-identifier hs-var">reds_arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684541996"><span class="hs-identifier hs-var">reds_group_res_arrs</span></a></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684541973"><span class="hs-identifier hs-var">segred_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541975"><span class="hs-identifier hs-var">slugs</span></a></span><span> </span><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684541974"><span class="hs-identifier hs-var">reds_op_renamed</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SegBinOp GPUMem, [VName], [VName], [PatElemT LParamMem],
   SegBinOpSlug, Lambda GPUMem, Integer)
  -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((SegBinOp GPUMem, [VName], [VName], [PatElemT LParamMem],
     SegBinOpSlug, Lambda GPUMem, Integer)
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-473"></span><span>              </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684541971"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684541971"><span class="hs-identifier hs-var">red_op</span></a></span></span><span> </span><span id="local-6989586621684541970"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684541970"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541969"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541969"><span class="hs-identifier hs-var">red_arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541968"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541968"><span class="hs-identifier hs-var">group_res_arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541967"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684541967"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541966"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541966"><span class="hs-identifier hs-var">slug</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541965"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684541965"><span class="hs-identifier hs-var">red_op_renamed</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541964"><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684541964"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-474"></span><span>                </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684541963"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684541963"><span class="hs-identifier hs-var">red_x_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541962"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684541962"><span class="hs-identifier hs-var">red_y_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-475"></span><span>                      </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684541970"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem]))
-&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684541971"><span class="hs-identifier hs-var">red_op</span></a></span><span>
</span><span id="line-476"></span><span>                </span><span class="annot"><span class="annottext">KernelConstants
-&gt; [PatElem GPUMem]
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; [TPrimExp Int64 VName]
-&gt; TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName
-&gt; SegBinOpSlug
-&gt; [LParam GPUMem]
-&gt; [LParam GPUMem]
-&gt; Lambda GPUMem
-&gt; [SubExp]
-&gt; TExp Int32
-&gt; VName
-&gt; TExp Int32
-&gt; VName
-&gt; [VName]
-&gt; [VName]
-&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#reductionStageTwo"><span class="hs-identifier hs-var">reductionStageTwo</span></a></span><span>
</span><span id="line-477"></span><span>                  </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684541988"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-478"></span><span>                  </span><span class="annot"><span class="annottext">[PatElem GPUMem]
[PatElemT LParamMem]
</span><a href="#local-6989586621684541967"><span class="hs-identifier hs-var">pes</span></a></span><span>
</span><span id="line-479"></span><span>                  </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541985"><span class="hs-identifier hs-var">group_id</span></a></span><span>
</span><span id="line-480"></span><span>                  </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541981"><span class="hs-identifier hs-var">flat_segment_id</span></a></span><span>
</span><span id="line-481"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TPrimExp Int64 VName)
-&gt; [VName] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541984"><span class="hs-identifier hs-var">segment_gtids</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541979"><span class="hs-identifier hs-var">first_group_for_segment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-483"></span><span>                  </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542002"><span class="hs-identifier hs-var">groups_per_segment</span></a></span><span>
</span><span id="line-484"></span><span>                  </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541966"><span class="hs-identifier hs-var">slug</span></a></span><span>
</span><span id="line-485"></span><span>                  </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param LParamMem]
</span><a href="#local-6989586621684541963"><span class="hs-identifier hs-var">red_x_params</span></a></span><span>
</span><span id="line-486"></span><span>                  </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param LParamMem]
</span><a href="#local-6989586621684541962"><span class="hs-identifier hs-var">red_y_params</span></a></span><span>
</span><span id="line-487"></span><span>                  </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684541965"><span class="hs-identifier hs-var">red_op_renamed</span></a></span><span>
</span><span id="line-488"></span><span>                  </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684541970"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-489"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; TExp Int32
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684541991"><span class="hs-identifier hs-var">num_counters</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-490"></span><span>                  </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541990"><span class="hs-identifier hs-var">counter</span></a></span><span>
</span><span id="line-491"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Integer -&gt; TExp Int32
forall a. Num a =&gt; Integer -&gt; a
</span><span class="hs-identifier hs-var">fromInteger</span></span><span> </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684541964"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-492"></span><span>                  </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541986"><span class="hs-identifier hs-var">sync_arr</span></a></span><span>
</span><span id="line-493"></span><span>                  </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541968"><span class="hs-identifier hs-var">group_res_arrs</span></a></span><span>
</span><span id="line-494"></span><span>                  </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541969"><span class="hs-identifier hs-var">red_arrs</span></a></span><span>
</span><span id="line-495"></span><span>
</span><span id="line-496"></span><span>          </span><span id="local-6989586621684541961"><span class="annot"><span class="annottext">one_group_per_segment :: InKernelGen ()
</span><a href="#local-6989586621684541961"><span class="hs-identifier hs-var hs-var">one_group_per_segment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-497"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#comment"><span class="hs-identifier hs-var">comment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;first thread in group saves final result to memory&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-498"></span><span>              </span><span class="annot"><span class="annottext">[(SegBinOpSlug, [PatElemT LParamMem])]
-&gt; ((SegBinOpSlug, [PatElemT LParamMem]) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOpSlug]
-&gt; [[PatElemT LParamMem]] -&gt; [(SegBinOpSlug, [PatElemT LParamMem])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541975"><span class="hs-identifier hs-var">slugs</span></a></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684541973"><span class="hs-identifier hs-var">segred_pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SegBinOpSlug, [PatElemT LParamMem]) -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((SegBinOpSlug, [PatElemT LParamMem]) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684541959"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541959"><span class="hs-identifier hs-var">slug</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541958"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684541958"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-499"></span><span>                </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541982"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-500"></span><span>                  </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, (VName, [TPrimExp Int64 VName]))]
-&gt; ((PatElemT LParamMem, (VName, [TPrimExp Int64 VName]))
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem]
-&gt; [(VName, [TPrimExp Int64 VName])]
-&gt; [(PatElemT LParamMem, (VName, [TPrimExp Int64 VName]))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684541958"><span class="hs-identifier hs-var">pes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [(VName, [TPrimExp Int64 VName])]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugAccs"><span class="hs-identifier hs-var hs-var">slugAccs</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541959"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, (VName, [TPrimExp Int64 VName]))
  -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((PatElemT LParamMem, (VName, [TPrimExp Int64 VName]))
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684541955"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684541955"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684541954"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541954"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541953"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541953"><span class="hs-identifier hs-var">acc_is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-501"></span><span>                    </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684541955"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TPrimExp Int64 VName)
-&gt; [VName] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541984"><span class="hs-identifier hs-var">segment_gtids</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541954"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541953"><span class="hs-identifier hs-var">acc_is</span></a></span><span>
</span><span id="line-502"></span><span>
</span><span id="line-503"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; InKernelGen () -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
TPrimExp Bool VName
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684542002"><span class="hs-identifier hs-var">groups_per_segment</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684541961"><span class="hs-identifier hs-var">one_group_per_segment</span></a></span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684541972"><span class="hs-identifier hs-var">multiple_groups_per_segment</span></a></span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; CallKernelGen ())
-&gt; Code HostOp -&gt; CallKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code HostOp
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-506"></span><span>
</span><span id="line-507"></span><span class="hs-comment">-- Careful to avoid division by zero here.  We have at least one group</span><span>
</span><span id="line-508"></span><span class="hs-comment">-- per segment.</span><span>
</span><span id="line-509"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#groupsPerSegmentAndElementsPerThread"><span class="hs-identifier hs-type">groupsPerSegmentAndElementsPerThread</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-510"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-511"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-512"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#NumGroups"><span class="hs-identifier hs-type">NumGroups</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-513"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#GroupSize"><span class="hs-identifier hs-type">GroupSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-514"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span>
</span><span id="line-515"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">,</span><span>
</span><span id="line-516"></span><span>      </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Imp.Count</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Elements"><span class="hs-identifier hs-type">Imp.Elements</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span>
</span><span id="line-517"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-518"></span><span id="groupsPerSegmentAndElementsPerThread"><span class="annot"><span class="annottext">groupsPerSegmentAndElementsPerThread :: TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName
-&gt; Count NumGroups (TPrimExp Int64 VName)
-&gt; Count GroupSize (TPrimExp Int64 VName)
-&gt; CallKernelGen
     (TPrimExp Int64 VName, Count Elements (TPrimExp Int64 VName))
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#groupsPerSegmentAndElementsPerThread"><span class="hs-identifier hs-var hs-var">groupsPerSegmentAndElementsPerThread</span></a></span></span><span> </span><span id="local-6989586621684541952"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541952"><span class="hs-identifier hs-var">segment_size</span></a></span></span><span> </span><span id="local-6989586621684541951"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541951"><span class="hs-identifier hs-var">num_segments</span></a></span></span><span> </span><span id="local-6989586621684541950"><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541950"><span class="hs-identifier hs-var">num_groups_hint</span></a></span></span><span> </span><span id="local-6989586621684541949"><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541949"><span class="hs-identifier hs-var">group_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-519"></span><span>  </span><span id="local-6989586621684541948"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541948"><span class="hs-identifier hs-var">groups_per_segment</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-520"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem HostEnv HostOp (TPrimExp Int64 VName)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;groups_per_segment&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; ImpM GPUMem HostEnv HostOp (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem HostEnv HostOp (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-521"></span><span>      </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541950"><span class="hs-identifier hs-var">num_groups_hint</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-operator hs-var">`divUp`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall v. TPrimExp Int64 v -&gt; TPrimExp Int64 v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sMax64"><span class="hs-identifier hs-var">sMax64</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541951"><span class="hs-identifier hs-var">num_segments</span></a></span><span>
</span><span id="line-522"></span><span>  </span><span id="local-6989586621684541947"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541947"><span class="hs-identifier hs-var">elements_per_thread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-523"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem HostEnv HostOp (TPrimExp Int64 VName)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;elements_per_thread&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; ImpM GPUMem HostEnv HostOp (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem HostEnv HostOp (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-524"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541952"><span class="hs-identifier hs-var">segment_size</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-operator hs-var">`divUp`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541949"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541948"><span class="hs-identifier hs-var">groups_per_segment</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-525"></span><span>  </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName, Count Elements (TPrimExp Int64 VName))
-&gt; CallKernelGen
     (TPrimExp Int64 VName, Count Elements (TPrimExp Int64 VName))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541948"><span class="hs-identifier hs-var">groups_per_segment</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Count Elements (TPrimExp Int64 VName)
forall a. a -&gt; Count Elements a
</span><a href="Futhark.CodeGen.ImpCode.html#elements"><span class="hs-identifier hs-var">Imp.elements</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541947"><span class="hs-identifier hs-var">elements_per_thread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-526"></span><span>
</span><span id="line-527"></span><span class="hs-comment">-- | A SegBinOp with auxiliary information.</span><span>
</span><span id="line-528"></span><span class="hs-keyword">data</span><span> </span><span id="SegBinOpSlug"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-var">SegBinOpSlug</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SegBinOpSlug"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-var">SegBinOpSlug</span></a></span></span><span>
</span><span id="line-529"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="slugOp"><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp GPUMem
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-530"></span><span>    </span><span class="hs-comment">-- | The arrays used for computing the intra-group reduction</span><span>
</span><span id="line-531"></span><span>    </span><span class="hs-comment">-- (either local or global memory).</span><span>
</span><span id="line-532"></span><span>    </span><span id="slugArrs"><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [VName]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugArrs"><span class="hs-identifier hs-var hs-var">slugArrs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-533"></span><span>    </span><span class="hs-comment">-- | Places to store accumulator in stage 1 reduction.</span><span>
</span><span id="line-534"></span><span>    </span><span id="slugAccs"><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [(VName, [TPrimExp Int64 VName])]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugAccs"><span class="hs-identifier hs-var hs-var">slugAccs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-535"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-536"></span><span>
</span><span id="line-537"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugBody"><span class="hs-identifier hs-type">slugBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span>
</span><span id="line-538"></span><span id="slugBody"><span class="annot"><span class="annottext">slugBody :: SegBinOpSlug -&gt; Body GPUMem
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugBody"><span class="hs-identifier hs-var hs-var">slugBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda GPUMem -&gt; Body GPUMem)
-&gt; (SegBinOpSlug -&gt; Lambda GPUMem) -&gt; SegBinOpSlug -&gt; Body GPUMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; Lambda GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; Lambda GPUMem)
-&gt; (SegBinOpSlug -&gt; SegBinOp GPUMem)
-&gt; SegBinOpSlug
-&gt; Lambda GPUMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp GPUMem
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span>
</span><span id="line-539"></span><span>
</span><span id="line-540"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugParams"><span class="hs-identifier hs-type">slugParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-541"></span><span id="slugParams"><span class="annot"><span class="annottext">slugParams :: SegBinOpSlug -&gt; [LParam GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugParams"><span class="hs-identifier hs-var hs-var">slugParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [Param LParamMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda GPUMem -&gt; [Param LParamMem])
-&gt; (SegBinOpSlug -&gt; Lambda GPUMem)
-&gt; SegBinOpSlug
-&gt; [Param LParamMem]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; Lambda GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; Lambda GPUMem)
-&gt; (SegBinOpSlug -&gt; SegBinOp GPUMem)
-&gt; SegBinOpSlug
-&gt; Lambda GPUMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp GPUMem
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span>
</span><span id="line-542"></span><span>
</span><span id="line-543"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugNeutral"><span class="hs-identifier hs-type">slugNeutral</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-544"></span><span id="slugNeutral"><span class="annot"><span class="annottext">slugNeutral :: SegBinOpSlug -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugNeutral"><span class="hs-identifier hs-var hs-var">slugNeutral</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; [SubExp]
forall rep. SegBinOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segBinOpNeutral"><span class="hs-identifier hs-var hs-var">segBinOpNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; [SubExp])
-&gt; (SegBinOpSlug -&gt; SegBinOp GPUMem) -&gt; SegBinOpSlug -&gt; [SubExp]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp GPUMem
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugShape"><span class="hs-identifier hs-type">slugShape</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span>
</span><span id="line-547"></span><span id="slugShape"><span class="annot"><span class="annottext">slugShape :: SegBinOpSlug -&gt; Shape
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugShape"><span class="hs-identifier hs-var hs-var">slugShape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; Shape)
-&gt; (SegBinOpSlug -&gt; SegBinOp GPUMem) -&gt; SegBinOpSlug -&gt; Shape
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp GPUMem
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span>
</span><span id="line-548"></span><span>
</span><span id="line-549"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugsComm"><span class="hs-identifier hs-type">slugsComm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Commutativity"><span class="hs-identifier hs-type">Commutativity</span></a></span><span>
</span><span id="line-550"></span><span id="slugsComm"><span class="annot"><span class="annottext">slugsComm :: [SegBinOpSlug] -&gt; Commutativity
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugsComm"><span class="hs-identifier hs-var hs-var">slugsComm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Commutativity] -&gt; Commutativity
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Commutativity] -&gt; Commutativity)
-&gt; ([SegBinOpSlug] -&gt; [Commutativity])
-&gt; [SegBinOpSlug]
-&gt; Commutativity
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SegBinOpSlug -&gt; Commutativity)
-&gt; [SegBinOpSlug] -&gt; [Commutativity]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; Commutativity
forall rep. SegBinOp rep -&gt; Commutativity
</span><a href="Futhark.IR.SegOp.html#segBinOpComm"><span class="hs-identifier hs-var hs-var">segBinOpComm</span></a></span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; Commutativity)
-&gt; (SegBinOpSlug -&gt; SegBinOp GPUMem)
-&gt; SegBinOpSlug
-&gt; Commutativity
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp GPUMem
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-551"></span><span>
</span><span id="line-552"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#accParams"><span class="hs-identifier hs-type">accParams</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#nextParams"><span class="hs-identifier hs-type">nextParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-553"></span><span id="accParams"><span class="annot"><span class="annottext">accParams :: SegBinOpSlug -&gt; [LParam GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#accParams"><span class="hs-identifier hs-var hs-var">accParams</span></a></span></span><span> </span><span id="local-6989586621684541932"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541932"><span class="hs-identifier hs-var">slug</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugNeutral"><span class="hs-identifier hs-var">slugNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541932"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; [Param LParamMem])
-&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugParams"><span class="hs-identifier hs-var">slugParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541932"><span class="hs-identifier hs-var">slug</span></a></span><span>
</span><span id="line-554"></span><span id="nextParams"><span class="annot"><span class="annottext">nextParams :: SegBinOpSlug -&gt; [LParam GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#nextParams"><span class="hs-identifier hs-var hs-var">nextParams</span></a></span></span><span> </span><span id="local-6989586621684541930"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541930"><span class="hs-identifier hs-var">slug</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugNeutral"><span class="hs-identifier hs-var">slugNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541930"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; [Param LParamMem])
-&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugParams"><span class="hs-identifier hs-var">slugParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541930"><span class="hs-identifier hs-var">slug</span></a></span><span>
</span><span id="line-555"></span><span>
</span><span id="line-556"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#segBinOpSlug"><span class="hs-identifier hs-type">segBinOpSlug</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span>
</span><span id="line-557"></span><span id="segBinOpSlug"><span class="annot"><span class="annottext">segBinOpSlug :: TExp Int32
-&gt; TExp Int32
-&gt; (SegBinOp GPUMem, [VName], [VName])
-&gt; ImpM GPUMem KernelEnv KernelOp SegBinOpSlug
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#segBinOpSlug"><span class="hs-identifier hs-var hs-var">segBinOpSlug</span></a></span></span><span> </span><span id="local-6989586621684541929"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541929"><span class="hs-identifier hs-var">local_tid</span></a></span></span><span> </span><span id="local-6989586621684541928"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541928"><span class="hs-identifier hs-var">group_id</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684541927"><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684541927"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541926"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541926"><span class="hs-identifier hs-var">group_res_arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541925"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541925"><span class="hs-identifier hs-var">param_arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-558"></span><span>  </span><span class="annot"><span class="annottext">SegBinOp GPUMem
-&gt; [VName] -&gt; [(VName, [TPrimExp Int64 VName])] -&gt; SegBinOpSlug
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-var">SegBinOpSlug</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684541927"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541926"><span class="hs-identifier hs-var">group_res_arrs</span></a></span><span>
</span><span id="line-559"></span><span>    </span><span class="annot"><span class="annottext">([(VName, [TPrimExp Int64 VName])] -&gt; SegBinOpSlug)
-&gt; ImpM GPUMem KernelEnv KernelOp [(VName, [TPrimExp Int64 VName])]
-&gt; ImpM GPUMem KernelEnv KernelOp SegBinOpSlug
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Param LParamMem
 -&gt; VName
 -&gt; ImpM GPUMem KernelEnv KernelOp (VName, [TPrimExp Int64 VName]))
-&gt; [Param LParamMem]
-&gt; [VName]
-&gt; ImpM GPUMem KernelEnv KernelOp [(VName, [TPrimExp Int64 VName])]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
-&gt; VName
-&gt; ImpM GPUMem KernelEnv KernelOp (VName, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684541923"><span class="hs-identifier hs-var">mkAcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; Lambda GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684541927"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541925"><span class="hs-identifier hs-var">param_arrs</span></a></span><span>
</span><span id="line-560"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-561"></span><span>    </span><span id="local-6989586621684541923"><span class="annot"><span class="annottext">mkAcc :: Param LParamMem
-&gt; VName
-&gt; ImpM GPUMem KernelEnv KernelOp (VName, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684541923"><span class="hs-identifier hs-var hs-var">mkAcc</span></a></span></span><span> </span><span id="local-6989586621684541922"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541922"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684541921"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541921"><span class="hs-identifier hs-var">param_arr</span></a></span></span><span>
</span><span id="line-562"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684541919"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684541919"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541922"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-563"></span><span>        </span><span class="annot"><span class="annottext">Shape -&gt; Int
forall a. ArrayShape a =&gt; a -&gt; Int
</span><a href="Futhark.IR.Syntax.Core.html#shapeRank"><span class="hs-identifier hs-var">shapeRank</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; Shape
forall rep. SegBinOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#segBinOpShape"><span class="hs-identifier hs-var hs-var">segBinOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684541927"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-564"></span><span>        </span><span id="local-6989586621684541918"><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684541918"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Any)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541922"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_acc&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684541919"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-565"></span><span>        </span><span class="annot"><span class="annottext">(VName, [TPrimExp Int64 VName])
-&gt; ImpM GPUMem KernelEnv KernelOp (VName, [TPrimExp Int64 VName])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Any -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Any
</span><a href="#local-6989586621684541918"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-566"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-567"></span><span>        </span><span class="annot"><span class="annottext">(VName, [TPrimExp Int64 VName])
-&gt; ImpM GPUMem KernelEnv KernelOp (VName, [TPrimExp Int64 VName])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541921"><span class="hs-identifier hs-var">param_arr</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541929"><span class="hs-identifier hs-var">local_tid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541928"><span class="hs-identifier hs-var">group_id</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-568"></span><span>
</span><span id="line-569"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#reductionStageZero"><span class="hs-identifier hs-type">reductionStageZero</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-570"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier hs-type">KernelConstants</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-571"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-572"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Imp.Count</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Elements"><span class="hs-identifier hs-type">Imp.Elements</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-573"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-574"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Imp.Count</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Elements"><span class="hs-identifier hs-type">Imp.Elements</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-575"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-576"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-577"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#DoSegBody"><span class="hs-identifier hs-type">DoSegBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-578"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-579"></span><span id="reductionStageZero"><span class="annot"><span class="annottext">reductionStageZero :: KernelConstants
-&gt; [(VName, TPrimExp Int64 VName)]
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; VName
-&gt; [SegBinOpSlug]
-&gt; DoSegBody
-&gt; InKernelGen ([Lambda GPUMem], InKernelGen ())
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#reductionStageZero"><span class="hs-identifier hs-var hs-var">reductionStageZero</span></a></span></span><span> </span><span id="local-6989586621684541913"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684541913"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span id="local-6989586621684541912"><span class="annot"><span class="annottext">[(VName, TPrimExp Int64 VName)]
</span><a href="#local-6989586621684541912"><span class="hs-identifier hs-var">ispace</span></a></span></span><span> </span><span id="local-6989586621684541911"><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541911"><span class="hs-identifier hs-var">num_elements</span></a></span></span><span> </span><span id="local-6989586621684541910"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541910"><span class="hs-identifier hs-var">global_tid</span></a></span></span><span> </span><span id="local-6989586621684541909"><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541909"><span class="hs-identifier hs-var">elems_per_thread</span></a></span></span><span> </span><span id="local-6989586621684541908"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541908"><span class="hs-identifier hs-var">threads_per_segment</span></a></span></span><span> </span><span id="local-6989586621684541907"><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541907"><span class="hs-identifier hs-var">slugs</span></a></span></span><span> </span><span id="local-6989586621684541906"><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684541906"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-580"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684541905"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541905"><span class="hs-identifier hs-var">gtids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541904"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541904"><span class="hs-identifier hs-var">_dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, TPrimExp Int64 VName)]
-&gt; ([VName], [TPrimExp Int64 VName])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(VName, TPrimExp Int64 VName)]
</span><a href="#local-6989586621684541912"><span class="hs-identifier hs-var">ispace</span></a></span><span>
</span><span id="line-581"></span><span>      </span><span id="local-6989586621684541903"><span class="annot"><span class="annottext">gtid :: TV Int64
</span><a href="#local-6989586621684541903"><span class="hs-identifier hs-var hs-var">gtid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; TV Int64
forall t. VName -&gt; PrimType -&gt; TV t
</span><a href="Futhark.CodeGen.ImpGen.html#mkTV"><span class="hs-identifier hs-var">mkTV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; VName
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541905"><span class="hs-identifier hs-var">gtids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-582"></span><span>      </span><span id="local-6989586621684541901"><span class="annot"><span class="annottext">local_tid :: TPrimExp Int64 VName
</span><a href="#local-6989586621684541901"><span class="hs-identifier hs-var hs-var">local_tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TPrimExp Int64 VName)
-&gt; TExp Int32 -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684541913"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-583"></span><span>
</span><span id="line-584"></span><span>  </span><span class="hs-comment">-- Figure out how many elements this thread should process.</span><span>
</span><span id="line-585"></span><span>  </span><span id="local-6989586621684541900"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541900"><span class="hs-identifier hs-var">chunk_size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;chunk_size&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-586"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684541899"><span class="annot"><span class="annottext">ordering :: SplitOrdering
</span><a href="#local-6989586621684541899"><span class="hs-identifier hs-var hs-var">ordering</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug] -&gt; Commutativity
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugsComm"><span class="hs-identifier hs-var">slugsComm</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541907"><span class="hs-identifier hs-var">slugs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-587"></span><span>        </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SplitOrdering
</span><a href="Futhark.IR.SegOp.html#SplitStrided"><span class="hs-identifier hs-var">SplitStrided</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SplitOrdering) -&gt; SubExp -&gt; SplitOrdering
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541908"><span class="hs-identifier hs-var">threads_per_segment</span></a></span><span>
</span><span id="line-588"></span><span>        </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Noncommutative"><span class="hs-identifier hs-var">Noncommutative</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SplitOrdering
</span><a href="Futhark.IR.SegOp.html#SplitContiguous"><span class="hs-identifier hs-var">SplitContiguous</span></a></span><span>
</span><span id="line-589"></span><span>  </span><span class="annot"><span class="annottext">SplitOrdering
-&gt; TPrimExp Int64 VName
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; TV Int64
-&gt; InKernelGen ()
forall rep r op.
SplitOrdering
-&gt; TPrimExp Int64 VName
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; TV Int64
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#computeThreadChunkSize"><span class="hs-identifier hs-var">computeThreadChunkSize</span></a></span><span> </span><span class="annot"><span class="annottext">SplitOrdering
</span><a href="#local-6989586621684541899"><span class="hs-identifier hs-var">ordering</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541910"><span class="hs-identifier hs-var">global_tid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541909"><span class="hs-identifier hs-var">elems_per_thread</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541911"><span class="hs-identifier hs-var">num_elements</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541900"><span class="hs-identifier hs-var">chunk_size</span></a></span><span>
</span><span id="line-590"></span><span>
</span><span id="line-591"></span><span>  </span><span class="annot"><span class="annottext">Maybe (Exp GPUMem) -&gt; Scope GPUMem -&gt; InKernelGen ()
forall rep inner r op.
Mem rep inner =&gt;
Maybe (Exp rep) -&gt; Scope rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dScope"><span class="hs-identifier hs-var">dScope</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Exp GPUMem)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(Scope GPUMem -&gt; InKernelGen ()) -&gt; Scope GPUMem -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; Scope GPUMem
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; Scope GPUMem)
-&gt; [Param LParamMem] -&gt; Scope GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SegBinOpSlug -&gt; [Param LParamMem])
-&gt; [SegBinOpSlug] -&gt; [Param LParamMem]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam GPUMem]
SegBinOpSlug -&gt; [Param LParamMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugParams"><span class="hs-identifier hs-var">slugParams</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541907"><span class="hs-identifier hs-var">slugs</span></a></span><span>
</span><span id="line-592"></span><span>
</span><span id="line-593"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;neutral-initialise the accumulators&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-594"></span><span>    </span><span class="annot"><span class="annottext">[SegBinOpSlug]
-&gt; (SegBinOpSlug -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541907"><span class="hs-identifier hs-var">slugs</span></a></span><span> </span><span class="annot"><span class="annottext">((SegBinOpSlug -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; (SegBinOpSlug -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684541890"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541890"><span class="hs-identifier hs-var">slug</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-595"></span><span>      </span><span class="annot"><span class="annottext">[((VName, [TPrimExp Int64 VName]), SubExp)]
-&gt; (((VName, [TPrimExp Int64 VName]), SubExp) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(VName, [TPrimExp Int64 VName])]
-&gt; [SubExp] -&gt; [((VName, [TPrimExp Int64 VName]), SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [(VName, [TPrimExp Int64 VName])]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugAccs"><span class="hs-identifier hs-var hs-var">slugAccs</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541890"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugNeutral"><span class="hs-identifier hs-var">slugNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541890"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((((VName, [TPrimExp Int64 VName]), SubExp) -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; (((VName, [TPrimExp Int64 VName]), SubExp) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684541889"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541889"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541888"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541888"><span class="hs-identifier hs-var">acc_is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541887"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684541887"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-596"></span><span>        </span><span class="annot"><span class="annottext">Shape
-&gt; ([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall rep r op.
Shape
-&gt; ([TPrimExp Int64 VName] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Shape
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugShape"><span class="hs-identifier hs-var">slugShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541890"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684541885"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541885"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-597"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541889"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541888"><span class="hs-identifier hs-var">acc_is</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541885"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684541887"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-598"></span><span>
</span><span id="line-599"></span><span>  </span><span id="local-6989586621684541884"><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684541884"><span class="hs-identifier hs-var">slugs_op_renamed</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SegBinOpSlug -&gt; ImpM GPUMem KernelEnv KernelOp (Lambda GPUMem))
-&gt; [SegBinOpSlug] -&gt; InKernelGen [Lambda GPUMem]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; ImpM GPUMem KernelEnv KernelOp (Lambda GPUMem)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Lambda rep -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.Rename.html#renameLambda"><span class="hs-identifier hs-var">renameLambda</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda GPUMem -&gt; ImpM GPUMem KernelEnv KernelOp (Lambda GPUMem))
-&gt; (SegBinOpSlug -&gt; Lambda GPUMem)
-&gt; SegBinOpSlug
-&gt; ImpM GPUMem KernelEnv KernelOp (Lambda GPUMem)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; Lambda GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; Lambda GPUMem)
-&gt; (SegBinOpSlug -&gt; SegBinOp GPUMem)
-&gt; SegBinOpSlug
-&gt; Lambda GPUMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; SegBinOp GPUMem
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugOp"><span class="hs-identifier hs-var hs-var">slugOp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541907"><span class="hs-identifier hs-var">slugs</span></a></span><span>
</span><span id="line-600"></span><span>
</span><span id="line-601"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684541882"><span class="annot"><span class="annottext">doTheReduction :: InKernelGen ()
</span><a href="#local-6989586621684541882"><span class="hs-identifier hs-var hs-var">doTheReduction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-602"></span><span>        </span><span class="annot"><span class="annottext">[(Lambda GPUMem, SegBinOpSlug)]
-&gt; ((Lambda GPUMem, SegBinOpSlug) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Lambda GPUMem]
-&gt; [SegBinOpSlug] -&gt; [(Lambda GPUMem, SegBinOpSlug)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684541884"><span class="hs-identifier hs-var">slugs_op_renamed</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541907"><span class="hs-identifier hs-var">slugs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Lambda GPUMem, SegBinOpSlug) -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((Lambda GPUMem, SegBinOpSlug) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684541881"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684541881"><span class="hs-identifier hs-var">slug_op_renamed</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541880"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541880"><span class="hs-identifier hs-var">slug</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-603"></span><span>          </span><span class="annot"><span class="annottext">Shape
-&gt; ([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall rep r op.
Shape
-&gt; ([TPrimExp Int64 VName] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Shape
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugShape"><span class="hs-identifier hs-var">slugShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541880"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684541879"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541879"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-604"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#comment"><span class="hs-identifier hs-var">comment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;to reduce current chunk, first store our result in memory&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-605"></span><span>              </span><span class="annot"><span class="annottext">[(Param LParamMem, (VName, [TPrimExp Int64 VName]))]
-&gt; ((Param LParamMem, (VName, [TPrimExp Int64 VName]))
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [(VName, [TPrimExp Int64 VName])]
-&gt; [(Param LParamMem, (VName, [TPrimExp Int64 VName]))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugParams"><span class="hs-identifier hs-var">slugParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541880"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [(VName, [TPrimExp Int64 VName])]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugAccs"><span class="hs-identifier hs-var hs-var">slugAccs</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541880"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, (VName, [TPrimExp Int64 VName]))
  -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((Param LParamMem, (VName, [TPrimExp Int64 VName]))
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684541878"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541878"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684541877"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541877"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541876"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541876"><span class="hs-identifier hs-var">acc_is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-606"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541878"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541877"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541876"><span class="hs-identifier hs-var">acc_is</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541879"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-607"></span><span>
</span><span id="line-608"></span><span>              </span><span class="annot"><span class="annottext">[(VName, Param LParamMem)]
-&gt; ((VName, Param LParamMem) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [Param LParamMem] -&gt; [(VName, Param LParamMem)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [VName]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugArrs"><span class="hs-identifier hs-var hs-var">slugArrs</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541880"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugParams"><span class="hs-identifier hs-var">slugParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541880"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, Param LParamMem) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((VName, Param LParamMem) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684541875"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541875"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541874"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541874"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-609"></span><span>                </span><span class="annot"><span class="annottext">Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; Bool)
-&gt; TypeBase Shape NoUniqueness -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541874"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-610"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541875"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541901"><span class="hs-identifier hs-var">local_tid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541874"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-611"></span><span>
</span><span id="line-612"></span><span>            </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#ErrorSync"><span class="hs-identifier hs-var">Imp.ErrorSync</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span> </span><span class="hs-comment">-- Also implicitly barrier.</span><span>
</span><span id="line-613"></span><span>            </span><span class="annot"><span class="annottext">TExp Int32 -&gt; Lambda GPUMem -&gt; [VName] -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupReduce"><span class="hs-identifier hs-var">groupReduce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelConstants -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684541913"><span class="hs-identifier hs-var">constants</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684541881"><span class="hs-identifier hs-var">slug_op_renamed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [VName]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugArrs"><span class="hs-identifier hs-var hs-var">slugArrs</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541880"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-614"></span><span>
</span><span id="line-615"></span><span>            </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-616"></span><span>
</span><span id="line-617"></span><span>            </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;first thread saves the result in accumulator&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-618"></span><span>              </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541901"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-619"></span><span>                </span><span class="annot"><span class="annottext">[((VName, [TPrimExp Int64 VName]), Param LParamMem)]
-&gt; (((VName, [TPrimExp Int64 VName]), Param LParamMem)
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(VName, [TPrimExp Int64 VName])]
-&gt; [Param LParamMem]
-&gt; [((VName, [TPrimExp Int64 VName]), Param LParamMem)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [(VName, [TPrimExp Int64 VName])]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugAccs"><span class="hs-identifier hs-var hs-var">slugAccs</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541880"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684541881"><span class="hs-identifier hs-var">slug_op_renamed</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((((VName, [TPrimExp Int64 VName]), Param LParamMem)
  -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; (((VName, [TPrimExp Int64 VName]), Param LParamMem)
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684541870"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541870"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541869"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541869"><span class="hs-identifier hs-var">acc_is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541868"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541868"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-620"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541870"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541869"><span class="hs-identifier hs-var">acc_is</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541879"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541868"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-621"></span><span>
</span><span id="line-622"></span><span>  </span><span class="hs-comment">-- If this is a non-commutative reduction, each thread must run the</span><span>
</span><span id="line-623"></span><span>  </span><span class="hs-comment">-- loop the same number of iterations, because we will be performing</span><span>
</span><span id="line-624"></span><span>  </span><span class="hs-comment">-- a group-wide reduction in there.</span><span>
</span><span id="line-625"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684541867"><span class="annot"><span class="annottext">comm :: Commutativity
</span><a href="#local-6989586621684541867"><span class="hs-identifier hs-var hs-var">comm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug] -&gt; Commutativity
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugsComm"><span class="hs-identifier hs-var">slugsComm</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541907"><span class="hs-identifier hs-var">slugs</span></a></span><span>
</span><span id="line-626"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684541866"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541866"><span class="hs-identifier hs-var">bound</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541865"><span class="annot"><span class="annottext">InKernelGen () -&gt; InKernelGen ()
</span><a href="#local-6989586621684541865"><span class="hs-identifier hs-var">check_bounds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-627"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684541867"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-628"></span><span>          </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541900"><span class="hs-identifier hs-var">chunk_size</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InKernelGen () -&gt; InKernelGen ()
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span class="hs-special">)</span><span>
</span><span id="line-629"></span><span>          </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Noncommutative"><span class="hs-identifier hs-var">Noncommutative</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-630"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541909"><span class="hs-identifier hs-var">elems_per_thread</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-631"></span><span>              </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541903"><span class="hs-identifier hs-var">gtid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541911"><span class="hs-identifier hs-var">num_elements</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-632"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-633"></span><span>
</span><span id="line-634"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; (TPrimExp Int64 VName -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541866"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">((TPrimExp Int64 VName -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; (TPrimExp Int64 VName -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684541862"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541862"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-635"></span><span>    </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541903"><span class="hs-identifier hs-var">gtid</span></a></span><span>
</span><span id="line-636"></span><span>      </span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName -&gt; InKernelGen ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684541867"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-637"></span><span>        </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-638"></span><span>          </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541910"><span class="hs-identifier hs-var">global_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541908"><span class="hs-identifier hs-var">threads_per_segment</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541862"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-639"></span><span>        </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Noncommutative"><span class="hs-identifier hs-var">Noncommutative</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-640"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684541860"><span class="annot"><span class="annottext">index_in_segment :: TPrimExp Int64 VName
</span><a href="#local-6989586621684541860"><span class="hs-identifier hs-var hs-var">index_in_segment</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541910"><span class="hs-identifier hs-var">global_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684541913"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-641"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541901"><span class="hs-identifier hs-var">local_tid</span></a></span><span>
</span><span id="line-642"></span><span>                </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541860"><span class="hs-identifier hs-var">index_in_segment</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName) -&gt; TPrimExp Int64 VName
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">Imp.unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541909"><span class="hs-identifier hs-var">elems_per_thread</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541862"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-643"></span><span>                </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684541913"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-644"></span><span>
</span><span id="line-645"></span><span>    </span><span class="annot"><span class="annottext">InKernelGen () -&gt; InKernelGen ()
</span><a href="#local-6989586621684541865"><span class="hs-identifier hs-var">check_bounds</span></a></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-646"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;apply map function&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-647"></span><span>        </span><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684541906"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">DoSegBody -&gt; DoSegBody
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684541859"><span class="annot"><span class="annottext">[(SubExp, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684541859"><span class="hs-identifier hs-var">all_red_res</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-648"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684541858"><span class="annot"><span class="annottext">slugs_res :: [[(SubExp, [TPrimExp Int64 VName])]]
</span><a href="#local-6989586621684541858"><span class="hs-identifier hs-var hs-var">slugs_res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int]
-&gt; [(SubExp, [TPrimExp Int64 VName])]
-&gt; [[(SubExp, [TPrimExp Int64 VName])]]
forall a. [Int] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.Util.html#chunks"><span class="hs-identifier hs-var">chunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegBinOpSlug -&gt; Int) -&gt; [SegBinOpSlug] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int)
-&gt; (SegBinOpSlug -&gt; [SubExp]) -&gt; SegBinOpSlug -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugNeutral"><span class="hs-identifier hs-var">slugNeutral</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541907"><span class="hs-identifier hs-var">slugs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(SubExp, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684541859"><span class="hs-identifier hs-var">all_red_res</span></a></span><span>
</span><span id="line-649"></span><span>
</span><span id="line-650"></span><span>          </span><span class="annot"><span class="annottext">[(SegBinOpSlug, [(SubExp, [TPrimExp Int64 VName])])]
-&gt; ((SegBinOpSlug, [(SubExp, [TPrimExp Int64 VName])])
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SegBinOpSlug]
-&gt; [[(SubExp, [TPrimExp Int64 VName])]]
-&gt; [(SegBinOpSlug, [(SubExp, [TPrimExp Int64 VName])])]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541907"><span class="hs-identifier hs-var">slugs</span></a></span><span> </span><span class="annot"><span class="annottext">[[(SubExp, [TPrimExp Int64 VName])]]
</span><a href="#local-6989586621684541858"><span class="hs-identifier hs-var">slugs_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((SegBinOpSlug, [(SubExp, [TPrimExp Int64 VName])])
  -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((SegBinOpSlug, [(SubExp, [TPrimExp Int64 VName])])
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684541857"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541857"><span class="hs-identifier hs-var">slug</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541856"><span class="annot"><span class="annottext">[(SubExp, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684541856"><span class="hs-identifier hs-var">red_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-651"></span><span>            </span><span class="annot"><span class="annottext">Shape
-&gt; ([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall rep r op.
Shape
-&gt; ([TPrimExp Int64 VName] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Shape
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugShape"><span class="hs-identifier hs-var">slugShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541857"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684541855"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541855"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-652"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;load accumulator&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-653"></span><span>                </span><span class="annot"><span class="annottext">[(Param LParamMem, (VName, [TPrimExp Int64 VName]))]
-&gt; ((Param LParamMem, (VName, [TPrimExp Int64 VName]))
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [(VName, [TPrimExp Int64 VName])]
-&gt; [(Param LParamMem, (VName, [TPrimExp Int64 VName]))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#accParams"><span class="hs-identifier hs-var">accParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541857"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [(VName, [TPrimExp Int64 VName])]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugAccs"><span class="hs-identifier hs-var hs-var">slugAccs</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541857"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, (VName, [TPrimExp Int64 VName]))
  -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((Param LParamMem, (VName, [TPrimExp Int64 VName]))
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684541854"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541854"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684541853"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541853"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541852"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541852"><span class="hs-identifier hs-var">acc_is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-654"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541854"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541853"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541852"><span class="hs-identifier hs-var">acc_is</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541855"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-655"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;load new values&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-656"></span><span>                </span><span class="annot"><span class="annottext">[(Param LParamMem, (SubExp, [TPrimExp Int64 VName]))]
-&gt; ((Param LParamMem, (SubExp, [TPrimExp Int64 VName]))
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
-&gt; [(SubExp, [TPrimExp Int64 VName])]
-&gt; [(Param LParamMem, (SubExp, [TPrimExp Int64 VName]))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [LParam GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#nextParams"><span class="hs-identifier hs-var">nextParams</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541857"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(SubExp, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684541856"><span class="hs-identifier hs-var">red_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, (SubExp, [TPrimExp Int64 VName]))
  -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((Param LParamMem, (SubExp, [TPrimExp Int64 VName]))
    -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684541851"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541851"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684541850"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684541850"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541849"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541849"><span class="hs-identifier hs-var">res_is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-657"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541851"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684541850"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541849"><span class="hs-identifier hs-var">res_is</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541855"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-658"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;apply reduction operator&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-659"></span><span>                </span><span class="annot"><span class="annottext">Names -&gt; Stms GPUMem -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; Stms GPUMem) -&gt; Body GPUMem -&gt; Stms GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Body GPUMem
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugBody"><span class="hs-identifier hs-var">slugBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541857"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-660"></span><span>                  </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;store in accumulator&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-661"></span><span>                    </span><span class="annot"><span class="annottext">[((VName, [TPrimExp Int64 VName]), SubExp)]
-&gt; (((VName, [TPrimExp Int64 VName]), SubExp) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span>
</span><span id="line-662"></span><span>                      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[(VName, [TPrimExp Int64 VName])]
-&gt; [SubExp] -&gt; [((VName, [TPrimExp Int64 VName]), SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span>
</span><span id="line-663"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [(VName, [TPrimExp Int64 VName])]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugAccs"><span class="hs-identifier hs-var hs-var">slugAccs</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541857"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-664"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; [SubExpRes]) -&gt; Body GPUMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Body GPUMem
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugBody"><span class="hs-identifier hs-var">slugBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541857"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-665"></span><span>                      </span><span class="hs-special">)</span><span>
</span><span id="line-666"></span><span>                      </span><span class="annot"><span class="annottext">((((VName, [TPrimExp Int64 VName]), SubExp) -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; (((VName, [TPrimExp Int64 VName]), SubExp) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684541845"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541845"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541844"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541844"><span class="hs-identifier hs-var">acc_is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541843"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684541843"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-667"></span><span>                        </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541845"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541844"><span class="hs-identifier hs-var">acc_is</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541855"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684541843"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-668"></span><span>
</span><span id="line-669"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684541867"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-670"></span><span>      </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Noncommutative"><span class="hs-identifier hs-var">Noncommutative</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-671"></span><span>        </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684541882"><span class="hs-identifier hs-var">doTheReduction</span></a></span><span>
</span><span id="line-672"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;first thread keeps accumulator; others reset to neutral element&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-673"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684541842"><span class="annot"><span class="annottext">reset_to_neutral :: InKernelGen ()
</span><a href="#local-6989586621684541842"><span class="hs-identifier hs-var hs-var">reset_to_neutral</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-674"></span><span>                </span><span class="annot"><span class="annottext">[SegBinOpSlug]
-&gt; (SegBinOpSlug -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541907"><span class="hs-identifier hs-var">slugs</span></a></span><span> </span><span class="annot"><span class="annottext">((SegBinOpSlug -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; (SegBinOpSlug -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684541841"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541841"><span class="hs-identifier hs-var">slug</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-675"></span><span>                  </span><span class="annot"><span class="annottext">[((VName, [TPrimExp Int64 VName]), SubExp)]
-&gt; (((VName, [TPrimExp Int64 VName]), SubExp) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(VName, [TPrimExp Int64 VName])]
-&gt; [SubExp] -&gt; [((VName, [TPrimExp Int64 VName]), SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [(VName, [TPrimExp Int64 VName])]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugAccs"><span class="hs-identifier hs-var hs-var">slugAccs</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541841"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [SubExp]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugNeutral"><span class="hs-identifier hs-var">slugNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541841"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((((VName, [TPrimExp Int64 VName]), SubExp) -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; (((VName, [TPrimExp Int64 VName]), SubExp) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684541840"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541840"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541839"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541839"><span class="hs-identifier hs-var">acc_is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541838"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684541838"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-676"></span><span>                    </span><span class="annot"><span class="annottext">Shape
-&gt; ([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall rep r op.
Shape
-&gt; ([TPrimExp Int64 VName] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Shape
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugShape"><span class="hs-identifier hs-var">slugShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541841"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684541837"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541837"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-677"></span><span>                      </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541840"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541839"><span class="hs-identifier hs-var">acc_is</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541837"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684541838"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-678"></span><span>          </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sUnless"><span class="hs-identifier hs-var">sUnless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541901"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684541842"><span class="hs-identifier hs-var">reset_to_neutral</span></a></span><span>
</span><span id="line-679"></span><span>      </span><span class="annot"><span class="annottext">Commutativity
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; InKernelGen ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-680"></span><span>
</span><span id="line-681"></span><span>  </span><span class="annot"><span class="annottext">([Lambda GPUMem], InKernelGen ())
-&gt; InKernelGen ([Lambda GPUMem], InKernelGen ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684541884"><span class="hs-identifier hs-var">slugs_op_renamed</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684541882"><span class="hs-identifier hs-var">doTheReduction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-682"></span><span>
</span><span id="line-683"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#reductionStageOne"><span class="hs-identifier hs-type">reductionStageOne</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-684"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier hs-type">KernelConstants</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-685"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-686"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Imp.Count</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Elements"><span class="hs-identifier hs-type">Imp.Elements</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-687"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-688"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Imp.Count</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#Elements"><span class="hs-identifier hs-type">Imp.Elements</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-689"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-690"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-691"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#DoSegBody"><span class="hs-identifier hs-type">DoSegBody</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-692"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-693"></span><span id="reductionStageOne"><span class="annot"><span class="annottext">reductionStageOne :: KernelConstants
-&gt; [(VName, TPrimExp Int64 VName)]
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; VName
-&gt; [SegBinOpSlug]
-&gt; DoSegBody
-&gt; InKernelGen [Lambda GPUMem]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#reductionStageOne"><span class="hs-identifier hs-var hs-var">reductionStageOne</span></a></span></span><span> </span><span id="local-6989586621684541835"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684541835"><span class="hs-identifier hs-var">constants</span></a></span></span><span> </span><span id="local-6989586621684541834"><span class="annot"><span class="annottext">[(VName, TPrimExp Int64 VName)]
</span><a href="#local-6989586621684541834"><span class="hs-identifier hs-var">ispace</span></a></span></span><span> </span><span id="local-6989586621684541833"><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541833"><span class="hs-identifier hs-var">num_elements</span></a></span></span><span> </span><span id="local-6989586621684541832"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541832"><span class="hs-identifier hs-var">global_tid</span></a></span></span><span> </span><span id="local-6989586621684541831"><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541831"><span class="hs-identifier hs-var">elems_per_thread</span></a></span></span><span> </span><span id="local-6989586621684541830"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541830"><span class="hs-identifier hs-var">threads_per_segment</span></a></span></span><span> </span><span id="local-6989586621684541829"><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541829"><span class="hs-identifier hs-var">slugs</span></a></span></span><span> </span><span id="local-6989586621684541828"><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684541828"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-694"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684541827"><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684541827"><span class="hs-identifier hs-var">slugs_op_renamed</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541826"><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684541826"><span class="hs-identifier hs-var">doTheReduction</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-695"></span><span>    </span><span class="annot"><span class="annottext">KernelConstants
-&gt; [(VName, TPrimExp Int64 VName)]
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; VName
-&gt; [SegBinOpSlug]
-&gt; DoSegBody
-&gt; InKernelGen ([Lambda GPUMem], InKernelGen ())
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#reductionStageZero"><span class="hs-identifier hs-var">reductionStageZero</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684541835"><span class="hs-identifier hs-var">constants</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, TPrimExp Int64 VName)]
</span><a href="#local-6989586621684541834"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541833"><span class="hs-identifier hs-var">num_elements</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541832"><span class="hs-identifier hs-var">global_tid</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541831"><span class="hs-identifier hs-var">elems_per_thread</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541830"><span class="hs-identifier hs-var">threads_per_segment</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541829"><span class="hs-identifier hs-var">slugs</span></a></span><span> </span><span class="annot"><span class="annottext">DoSegBody
</span><a href="#local-6989586621684541828"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-696"></span><span>
</span><span id="line-697"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug] -&gt; Commutativity
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugsComm"><span class="hs-identifier hs-var">slugsComm</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOpSlug]
</span><a href="#local-6989586621684541829"><span class="hs-identifier hs-var">slugs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-698"></span><span>    </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Noncommutative"><span class="hs-identifier hs-var">Noncommutative</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; InKernelGen ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-699"></span><span>    </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">InKernelGen ()
</span><a href="#local-6989586621684541826"><span class="hs-identifier hs-var">doTheReduction</span></a></span><span>
</span><span id="line-700"></span><span>
</span><span id="line-701"></span><span>  </span><span class="annot"><span class="annottext">[Lambda GPUMem] -&gt; InKernelGen [Lambda GPUMem]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684541827"><span class="hs-identifier hs-var">slugs_op_renamed</span></a></span><span>
</span><span id="line-702"></span><span>
</span><span id="line-703"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#reductionStageTwo"><span class="hs-identifier hs-type">reductionStageTwo</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-704"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#KernelConstants"><span class="hs-identifier hs-type">KernelConstants</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-705"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#PatElem"><span class="hs-identifier hs-type">PatElem</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-706"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-707"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-708"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-709"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-710"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-711"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#SegBinOpSlug"><span class="hs-identifier hs-type">SegBinOpSlug</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-712"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-713"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-714"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-715"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-716"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-717"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-718"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-719"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-720"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-721"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-722"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#InKernelGen"><span class="hs-identifier hs-type">InKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-723"></span><span id="reductionStageTwo"><span class="annot"><span class="annottext">reductionStageTwo :: KernelConstants
-&gt; [PatElem GPUMem]
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; [TPrimExp Int64 VName]
-&gt; TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName
-&gt; SegBinOpSlug
-&gt; [LParam GPUMem]
-&gt; [LParam GPUMem]
-&gt; Lambda GPUMem
-&gt; [SubExp]
-&gt; TExp Int32
-&gt; VName
-&gt; TExp Int32
-&gt; VName
-&gt; [VName]
-&gt; [VName]
-&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#reductionStageTwo"><span class="hs-identifier hs-var hs-var">reductionStageTwo</span></a></span></span><span>
</span><span id="line-724"></span><span>  </span><span id="local-6989586621684541825"><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684541825"><span class="hs-identifier hs-var">constants</span></a></span></span><span>
</span><span id="line-725"></span><span>  </span><span id="local-6989586621684541824"><span class="annot"><span class="annottext">[PatElem GPUMem]
</span><a href="#local-6989586621684541824"><span class="hs-identifier hs-var">segred_pes</span></a></span></span><span>
</span><span id="line-726"></span><span>  </span><span id="local-6989586621684541823"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541823"><span class="hs-identifier hs-var">group_id</span></a></span></span><span>
</span><span id="line-727"></span><span>  </span><span id="local-6989586621684541822"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541822"><span class="hs-identifier hs-var">flat_segment_id</span></a></span></span><span>
</span><span id="line-728"></span><span>  </span><span id="local-6989586621684541821"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541821"><span class="hs-identifier hs-var">segment_gtids</span></a></span></span><span>
</span><span id="line-729"></span><span>  </span><span id="local-6989586621684541820"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541820"><span class="hs-identifier hs-var">first_group_for_segment</span></a></span></span><span>
</span><span id="line-730"></span><span>  </span><span id="local-6989586621684541819"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541819"><span class="hs-identifier hs-var">groups_per_segment</span></a></span></span><span>
</span><span id="line-731"></span><span>  </span><span id="local-6989586621684541818"><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541818"><span class="hs-identifier hs-var">slug</span></a></span></span><span>
</span><span id="line-732"></span><span>  </span><span id="local-6989586621684541817"><span class="annot"><span class="annottext">[LParam GPUMem]
</span><a href="#local-6989586621684541817"><span class="hs-identifier hs-var">red_x_params</span></a></span></span><span>
</span><span id="line-733"></span><span>  </span><span id="local-6989586621684541816"><span class="annot"><span class="annottext">[LParam GPUMem]
</span><a href="#local-6989586621684541816"><span class="hs-identifier hs-var">red_y_params</span></a></span></span><span>
</span><span id="line-734"></span><span>  </span><span id="local-6989586621684541815"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684541815"><span class="hs-identifier hs-var">red_op_renamed</span></a></span></span><span>
</span><span id="line-735"></span><span>  </span><span id="local-6989586621684541814"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684541814"><span class="hs-identifier hs-var">nes</span></a></span></span><span>
</span><span id="line-736"></span><span>  </span><span id="local-6989586621684541813"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541813"><span class="hs-identifier hs-var">num_counters</span></a></span></span><span>
</span><span id="line-737"></span><span>  </span><span id="local-6989586621684541812"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541812"><span class="hs-identifier hs-var">counter</span></a></span></span><span>
</span><span id="line-738"></span><span>  </span><span id="local-6989586621684541811"><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541811"><span class="hs-identifier hs-var">counter_i</span></a></span></span><span>
</span><span id="line-739"></span><span>  </span><span id="local-6989586621684541810"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541810"><span class="hs-identifier hs-var">sync_arr</span></a></span></span><span>
</span><span id="line-740"></span><span>  </span><span id="local-6989586621684541809"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541809"><span class="hs-identifier hs-var">group_res_arrs</span></a></span></span><span>
</span><span id="line-741"></span><span>  </span><span id="local-6989586621684541808"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541808"><span class="hs-identifier hs-var">red_arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-742"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684541807"><span class="annot"><span class="annottext">local_tid :: TExp Int32
</span><a href="#local-6989586621684541807"><span class="hs-identifier hs-var hs-var">local_tid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TExp Int32
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelLocalThreadId"><span class="hs-identifier hs-var hs-var">kernelLocalThreadId</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684541825"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-743"></span><span>        </span><span id="local-6989586621684541806"><span class="annot"><span class="annottext">group_size :: TPrimExp Int64 VName
</span><a href="#local-6989586621684541806"><span class="hs-identifier hs-var hs-var">group_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelConstants -&gt; TPrimExp Int64 VName
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#kernelGroupSize"><span class="hs-identifier hs-var hs-var">kernelGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelConstants
</span><a href="#local-6989586621684541825"><span class="hs-identifier hs-var">constants</span></a></span><span>
</span><span id="line-744"></span><span>    </span><span id="local-6989586621684541805"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541805"><span class="hs-identifier hs-var">old_counter</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Int64)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;old_counter&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-745"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684541804"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541804"><span class="hs-identifier hs-var">counter_mem</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541803"><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541803"><span class="hs-identifier hs-var">counter_offset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-746"></span><span>      </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM
     GPUMem
     KernelEnv
     KernelOp
     (VName, Space, Count Elements (TPrimExp Int64 VName))
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM
     rep r op (VName, Space, Count Elements (TPrimExp Int64 VName))
</span><a href="Futhark.CodeGen.ImpGen.html#fullyIndexArray"><span class="hs-identifier hs-var">fullyIndexArray</span></a></span><span>
</span><span id="line-747"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541812"><span class="hs-identifier hs-var">counter</span></a></span><span>
</span><span id="line-748"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int32 -&gt; TPrimExp Int64 VName)
-&gt; TExp Int32 -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-749"></span><span>            </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541811"><span class="hs-identifier hs-var">counter_i</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541813"><span class="hs-identifier hs-var">num_counters</span></a></span><span>
</span><span id="line-750"></span><span>              </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541822"><span class="hs-identifier hs-var">flat_segment_id</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TExp Int32
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541813"><span class="hs-identifier hs-var">num_counters</span></a></span><span>
</span><span id="line-751"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-752"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#comment"><span class="hs-identifier hs-var">comment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;first thread in group saves group result to global memory&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-753"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541807"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-754"></span><span>        </span><span class="annot"><span class="annottext">[(VName, (VName, [TPrimExp Int64 VName]))]
-&gt; ((VName, (VName, [TPrimExp Int64 VName])) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
-&gt; [(VName, (VName, [TPrimExp Int64 VName]))]
-&gt; [(VName, (VName, [TPrimExp Int64 VName]))]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684541814"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(VName, (VName, [TPrimExp Int64 VName]))]
 -&gt; [(VName, (VName, [TPrimExp Int64 VName]))])
-&gt; [(VName, (VName, [TPrimExp Int64 VName]))]
-&gt; [(VName, (VName, [TPrimExp Int64 VName]))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; [(VName, [TPrimExp Int64 VName])]
-&gt; [(VName, (VName, [TPrimExp Int64 VName]))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541809"><span class="hs-identifier hs-var">group_res_arrs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; [(VName, [TPrimExp Int64 VName])]
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugAccs"><span class="hs-identifier hs-var hs-var">slugAccs</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541818"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, (VName, [TPrimExp Int64 VName])) -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((VName, (VName, [TPrimExp Int64 VName])) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684541801"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541801"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684541800"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541800"><span class="hs-identifier hs-var">acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541799"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541799"><span class="hs-identifier hs-var">acc_is</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-755"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541801"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541823"><span class="hs-identifier hs-var">group_id</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541800"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541799"><span class="hs-identifier hs-var">acc_is</span></a></span><span>
</span><span id="line-756"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#MemFence"><span class="hs-identifier hs-var">Imp.MemFence</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceGlobal"><span class="hs-identifier hs-var">Imp.FenceGlobal</span></a></span><span>
</span><span id="line-757"></span><span>        </span><span class="hs-comment">-- Increment the counter, thus stating that our result is</span><span>
</span><span id="line-758"></span><span>        </span><span class="hs-comment">-- available.</span><span>
</span><span id="line-759"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-760"></span><span>          </span><span class="annot"><span class="annottext">Space -&gt; AtomicOp -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Atomic"><span class="hs-identifier hs-var">Imp.Atomic</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(AtomicOp -&gt; KernelOp) -&gt; AtomicOp -&gt; KernelOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-761"></span><span>            </span><span class="annot"><span class="annottext">IntType
-&gt; VName
-&gt; VName
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; Exp
-&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicAdd"><span class="hs-identifier hs-var">Imp.AtomicAdd</span></a></span><span>
</span><span id="line-762"></span><span>              </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span>
</span><span id="line-763"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541805"><span class="hs-identifier hs-var">old_counter</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-764"></span><span>              </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541804"><span class="hs-identifier hs-var">counter_mem</span></a></span><span>
</span><span id="line-765"></span><span>              </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541803"><span class="hs-identifier hs-var">counter_offset</span></a></span><span>
</span><span id="line-766"></span><span>              </span><span class="annot"><span class="annottext">(Exp -&gt; AtomicOp) -&gt; Exp -&gt; AtomicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span class="hs-special">)</span><span>
</span><span id="line-767"></span><span>        </span><span class="hs-comment">-- Now check if we were the last group to write our result.  If</span><span>
</span><span id="line-768"></span><span>        </span><span class="hs-comment">-- so, it is our responsibility to produce the final result.</span><span>
</span><span id="line-769"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; [TPrimExp Int64 VName] -&gt; Exp -&gt; InKernelGen ()
forall rep r op.
VName -&gt; [TPrimExp Int64 VName] -&gt; Exp -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWrite"><span class="hs-identifier hs-var">sWrite</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541810"><span class="hs-identifier hs-var">sync_arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; InKernelGen ()) -&gt; Exp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Bool VName -&gt; Exp) -&gt; TPrimExp Bool VName -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TPrimExp Int64 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541805"><span class="hs-identifier hs-var">old_counter</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541819"><span class="hs-identifier hs-var">groups_per_segment</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span>
</span><span id="line-770"></span><span>
</span><span id="line-771"></span><span>    </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceGlobal"><span class="hs-identifier hs-var">Imp.FenceGlobal</span></a></span><span>
</span><span id="line-772"></span><span>
</span><span id="line-773"></span><span>    </span><span id="local-6989586621684541792"><span class="annot"><span class="annottext">TV Bool
</span><a href="#local-6989586621684541792"><span class="hs-identifier hs-var">is_last_group</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem KernelEnv KernelOp (TV Bool)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;is_last_group&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Primitive.html#Bool"><span class="hs-identifier hs-var">Bool</span></a></span><span>
</span><span id="line-774"></span><span>    </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Bool -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Bool
</span><a href="#local-6989586621684541792"><span class="hs-identifier hs-var">is_last_group</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541810"><span class="hs-identifier hs-var">sync_arr</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-775"></span><span>    </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Bool -&gt; TPrimExp Bool VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Bool
</span><a href="#local-6989586621684541792"><span class="hs-identifier hs-var">is_last_group</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-776"></span><span>      </span><span class="hs-comment">-- The final group has written its result (and it was</span><span>
</span><span id="line-777"></span><span>      </span><span class="hs-comment">-- us!), so read in all the group results and perform the</span><span>
</span><span id="line-778"></span><span>      </span><span class="hs-comment">-- final stage of the reduction.  But first, we reset the</span><span>
</span><span id="line-779"></span><span>      </span><span class="hs-comment">-- counter so it is ready for next time.  This is done</span><span>
</span><span id="line-780"></span><span>      </span><span class="hs-comment">-- with an atomic to avoid warnings about write/write</span><span>
</span><span id="line-781"></span><span>      </span><span class="hs-comment">-- races in oclgrind.</span><span>
</span><span id="line-782"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541807"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-783"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-784"></span><span>          </span><span class="annot"><span class="annottext">Space -&gt; AtomicOp -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Atomic"><span class="hs-identifier hs-var">Imp.Atomic</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(AtomicOp -&gt; KernelOp) -&gt; AtomicOp -&gt; KernelOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-785"></span><span>            </span><span class="annot"><span class="annottext">IntType
-&gt; VName
-&gt; VName
-&gt; Count Elements (TPrimExp Int64 VName)
-&gt; Exp
-&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicAdd"><span class="hs-identifier hs-var">Imp.AtomicAdd</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684541805"><span class="hs-identifier hs-var">old_counter</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541804"><span class="hs-identifier hs-var">counter_mem</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TPrimExp Int64 VName)
</span><a href="#local-6989586621684541803"><span class="hs-identifier hs-var">counter_offset</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; AtomicOp) -&gt; Exp -&gt; AtomicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-786"></span><span>              </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; Exp) -&gt; TPrimExp Int64 VName -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a
</span><span class="hs-identifier hs-var">negate</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541819"><span class="hs-identifier hs-var">groups_per_segment</span></a></span><span>
</span><span id="line-787"></span><span>
</span><span id="line-788"></span><span>      </span><span class="annot"><span class="annottext">Shape
-&gt; ([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall rep r op.
Shape
-&gt; ([TPrimExp Int64 VName] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Shape
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugShape"><span class="hs-identifier hs-var">slugShape</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541818"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ([TPrimExp Int64 VName] -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684541791"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541791"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-789"></span><span>        </span><span class="hs-comment">-- There is no guarantee that the number of workgroups for the</span><span>
</span><span id="line-790"></span><span>        </span><span class="hs-comment">-- segment is less than the workgroup size, so each thread may</span><span>
</span><span id="line-791"></span><span>        </span><span class="hs-comment">-- have to read multiple elements.  We do this in a sequential</span><span>
</span><span id="line-792"></span><span>        </span><span class="hs-comment">-- way that may induce non-coalesced accesses, but the total</span><span>
</span><span id="line-793"></span><span>        </span><span class="hs-comment">-- number of accesses should be tiny here.</span><span>
</span><span id="line-794"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#comment"><span class="hs-identifier hs-var">comment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;read in the per-group-results&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-795"></span><span>          </span><span id="local-6989586621684541790"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541790"><span class="hs-identifier hs-var">read_per_thread</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-796"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;read_per_thread&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-797"></span><span>              </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541819"><span class="hs-identifier hs-var">groups_per_segment</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-operator hs-var">`divUp`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541806"><span class="hs-identifier hs-var">group_size</span></a></span><span>
</span><span id="line-798"></span><span>
</span><span id="line-799"></span><span>          </span><span class="annot"><span class="annottext">[(Param LParamMem, SubExp)]
-&gt; ((Param LParamMem, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [SubExp] -&gt; [(Param LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param LParamMem]
</span><a href="#local-6989586621684541817"><span class="hs-identifier hs-var">red_x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684541814"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((Param LParamMem, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684541789"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541789"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541788"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684541788"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-800"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541789"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684541788"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-801"></span><span>
</span><span id="line-802"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; (TPrimExp Int64 VName -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541790"><span class="hs-identifier hs-var">read_per_thread</span></a></span><span> </span><span class="annot"><span class="annottext">((TPrimExp Int64 VName -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; (TPrimExp Int64 VName -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684541787"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541787"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-803"></span><span>            </span><span id="local-6989586621684541786"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541786"><span class="hs-identifier hs-var">group_res_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-804"></span><span>              </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;group_res_id&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-805"></span><span>                </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541807"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541790"><span class="hs-identifier hs-var">read_per_thread</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541787"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-806"></span><span>            </span><span id="local-6989586621684541785"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541785"><span class="hs-identifier hs-var">index_of_group_res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-807"></span><span>              </span><span class="annot"><span class="annottext">String
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall t rep r op. String -&gt; TExp t -&gt; ImpM rep r op (TExp t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimVE"><span class="hs-identifier hs-var">dPrimVE</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;index_of_group_res&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName
-&gt; ImpM GPUMem KernelEnv KernelOp (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-808"></span><span>                </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541820"><span class="hs-identifier hs-var">first_group_for_segment</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541786"><span class="hs-identifier hs-var">group_res_id</span></a></span><span>
</span><span id="line-809"></span><span>
</span><span id="line-810"></span><span>            </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541786"><span class="hs-identifier hs-var">group_res_id</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TPrimExp Int64 VName -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541819"><span class="hs-identifier hs-var">groups_per_segment</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-811"></span><span>              </span><span class="annot"><span class="annottext">[(Param LParamMem, VName)]
-&gt; ((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [VName] -&gt; [(Param LParamMem, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param LParamMem]
</span><a href="#local-6989586621684541816"><span class="hs-identifier hs-var">red_y_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541809"><span class="hs-identifier hs-var">group_res_arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-812"></span><span>                </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684541784"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541784"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541783"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541783"><span class="hs-identifier hs-var">group_res_arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-813"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span>
</span><span id="line-814"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541784"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-815"></span><span>                    </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-816"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541783"><span class="hs-identifier hs-var">group_res_arr</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-817"></span><span>                    </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541785"><span class="hs-identifier hs-var">index_of_group_res</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541791"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-818"></span><span>
</span><span id="line-819"></span><span>              </span><span class="annot"><span class="annottext">Names -&gt; Stms GPUMem -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; Stms GPUMem) -&gt; Body GPUMem -&gt; Stms GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Body GPUMem
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugBody"><span class="hs-identifier hs-var">slugBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541818"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-820"></span><span>                </span><span class="annot"><span class="annottext">[(Param LParamMem, SubExp)]
-&gt; ((Param LParamMem, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [SubExp] -&gt; [(Param LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param LParamMem]
</span><a href="#local-6989586621684541817"><span class="hs-identifier hs-var">red_x_params</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(Param LParamMem, SubExp)])
-&gt; [SubExp] -&gt; [(Param LParamMem, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; [SubExpRes]) -&gt; Body GPUMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug -&gt; Body GPUMem
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#slugBody"><span class="hs-identifier hs-var">slugBody</span></a></span><span> </span><span class="annot"><span class="annottext">SegBinOpSlug
</span><a href="#local-6989586621684541818"><span class="hs-identifier hs-var">slug</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((Param LParamMem, SubExp) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684541782"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541782"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541781"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684541781"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-821"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541782"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684541781"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-822"></span><span>
</span><span id="line-823"></span><span>        </span><span class="annot"><span class="annottext">[(Param LParamMem, VName)]
-&gt; ((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [VName] -&gt; [(Param LParamMem, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param LParamMem]
</span><a href="#local-6989586621684541817"><span class="hs-identifier hs-var">red_x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541808"><span class="hs-identifier hs-var">red_arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ())
-&gt; ((Param LParamMem, VName) -&gt; InKernelGen ()) -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684541780"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541780"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541779"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541779"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-824"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; InKernelGen () -&gt; InKernelGen ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; Bool)
-&gt; TypeBase Shape NoUniqueness -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541780"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-825"></span><span>            </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684541779"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int32 -&gt; TPrimExp Int64 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541807"><span class="hs-identifier hs-var">local_tid</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541780"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-826"></span><span>
</span><span id="line-827"></span><span>        </span><span class="annot"><span class="annottext">KernelOp -&gt; InKernelGen ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; InKernelGen ()) -&gt; KernelOp -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Fence -&gt; KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#Barrier"><span class="hs-identifier hs-var">Imp.Barrier</span></a></span><span> </span><span class="annot"><span class="annottext">Fence
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#FenceLocal"><span class="hs-identifier hs-var">Imp.FenceLocal</span></a></span><span>
</span><span id="line-828"></span><span>
</span><span id="line-829"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reduce the per-group results&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-830"></span><span>          </span><span class="annot"><span class="annottext">TExp Int32 -&gt; Lambda GPUMem -&gt; [VName] -&gt; InKernelGen ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#groupReduce"><span class="hs-identifier hs-var">groupReduce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; TExp Int32
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684541806"><span class="hs-identifier hs-var">group_size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684541815"><span class="hs-identifier hs-var">red_op_renamed</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684541808"><span class="hs-identifier hs-var">red_arrs</span></a></span><span>
</span><span id="line-831"></span><span>
</span><span id="line-832"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;and back to memory with the final result&quot;</span></span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-833"></span><span>            </span><span class="annot"><span class="annottext">TPrimExp Bool VName -&gt; InKernelGen () -&gt; InKernelGen ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684541807"><span class="hs-identifier hs-var">local_tid</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int32 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(InKernelGen () -&gt; InKernelGen ())
-&gt; InKernelGen () -&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-834"></span><span>              </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, Param LParamMem)]
-&gt; ((PatElemT LParamMem, Param LParamMem) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem]
-&gt; [Param LParamMem] -&gt; [(PatElemT LParamMem, Param LParamMem)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElem GPUMem]
[PatElemT LParamMem]
</span><a href="#local-6989586621684541824"><span class="hs-identifier hs-var">segred_pes</span></a></span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; [(PatElemT LParamMem, Param LParamMem)])
-&gt; [Param LParamMem] -&gt; [(PatElemT LParamMem, Param LParamMem)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684541815"><span class="hs-identifier hs-var">red_op_renamed</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, Param LParamMem) -&gt; InKernelGen ())
 -&gt; InKernelGen ())
-&gt; ((PatElemT LParamMem, Param LParamMem) -&gt; InKernelGen ())
-&gt; InKernelGen ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684541778"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684541778"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684541777"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541777"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-835"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; InKernelGen ()
forall rep r op.
VName
-&gt; [TPrimExp Int64 VName]
-&gt; SubExp
-&gt; [TPrimExp Int64 VName]
-&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span>
</span><span id="line-836"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684541778"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-837"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541821"><span class="hs-identifier hs-var">segment_gtids</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684541791"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-838"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684541777"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-839"></span><span>                  </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-840"></span></pre></body></html>