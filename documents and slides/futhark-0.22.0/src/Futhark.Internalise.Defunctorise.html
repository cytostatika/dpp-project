<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE Trustworthy #-}</span><span>
</span><span id="line-3"></span><span>
</span><span id="line-4"></span><span class="hs-comment">-- | Partially evaluate all modules away from a source Futhark</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- program.  This is implemented as a source-to-source transformation.</span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Internalise.Defunctorise</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#transformProg"><span class="hs-identifier">transformProg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Identity</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.RWS.Strict</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.DList</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">DL</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html"><span class="hs-identifier">Futhark.MonadFreshNames</span></a></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.html"><span class="hs-identifier">Language.Futhark</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.Semantic.html"><span class="hs-identifier">Language.Futhark.Semantic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Semantic.html#FileModule"><span class="hs-identifier">FileModule</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Semantic.html#Imports"><span class="hs-identifier">Imports</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.Traversals.html"><span class="hs-identifier">Language.Futhark.Traversals</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">abs</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mod</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span>
</span><span id="line-20"></span><span class="hs-comment">-- | A substitution from names in the original program to names in the</span><span>
</span><span id="line-21"></span><span class="hs-comment">-- generated/residual program.</span><span>
</span><span id="line-22"></span><span class="hs-keyword">type</span><span> </span><span id="Substitutions"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Substitutions"><span class="hs-identifier hs-var">Substitutions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-23"></span><span>
</span><span id="line-24"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#lookupSubst"><span class="hs-identifier hs-type">lookupSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Substitutions"><span class="hs-identifier hs-type">Substitutions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-25"></span><span id="lookupSubst"><span class="annot"><span class="annottext">lookupSubst :: VName -&gt; Map VName VName -&gt; VName
</span><a href="Futhark.Internalise.Defunctorise.html#lookupSubst"><span class="hs-identifier hs-var hs-var">lookupSubst</span></a></span></span><span> </span><span id="local-6989586621684522373"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522373"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684522372"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522372"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName VName -&gt; Maybe VName
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522373"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522372"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-26"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684522370"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522370"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522370"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522373"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName VName -&gt; VName
</span><a href="Futhark.Internalise.Defunctorise.html#lookupSubst"><span class="hs-identifier hs-var">lookupSubst</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522370"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522372"><span class="hs-identifier hs-var">substs</span></a></span><span>
</span><span id="line-27"></span><span>  </span><span class="annot"><span class="annottext">Maybe VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522373"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">data</span><span> </span><span id="Mod"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Mod"><span class="hs-identifier hs-var">Mod</span></a></span></span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="hs-comment">-- | A pairing of a lexical closure and a module function.</span><span>
</span><span id="line-31"></span><span>    </span><span id="ModFun"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#ModFun"><span class="hs-identifier hs-var">ModFun</span></a></span></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TySet"><span class="hs-identifier hs-type">TySet</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.html#ModParam"><span class="hs-identifier hs-type">ModParam</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.html#ModExp"><span class="hs-identifier hs-type">ModExp</span></a></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | A non-parametric module.</span><span>
</span><span id="line-33"></span><span>    </span><span id="ModMod"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#ModMod"><span class="hs-identifier hs-var">ModMod</span></a></span></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684522348"><span id="local-6989586621684522350"><span id="local-6989586621684522365"><span class="annot"><span class="annottext">Int -&gt; Mod -&gt; ShowS
[Mod] -&gt; ShowS
Mod -&gt; String
(Int -&gt; Mod -&gt; ShowS)
-&gt; (Mod -&gt; String) -&gt; ([Mod] -&gt; ShowS) -&gt; Show Mod
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Mod] -&gt; ShowS
$cshowList :: [Mod] -&gt; ShowS
show :: Mod -&gt; String
$cshow :: Mod -&gt; String
showsPrec :: Int -&gt; Mod -&gt; ShowS
$cshowsPrec :: Int -&gt; Mod -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#modScope"><span class="hs-identifier hs-type">modScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Mod"><span class="hs-identifier hs-type">Mod</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span>
</span><span id="line-37"></span><span id="modScope"><span class="annot"><span class="annottext">modScope :: Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#modScope"><span class="hs-identifier hs-var hs-var">modScope</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#ModMod"><span class="hs-identifier hs-type">ModMod</span></a></span><span> </span><span id="local-6989586621684522343"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522343"><span class="hs-identifier hs-var">scope</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522343"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-38"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#modScope"><span class="hs-identifier hs-var">modScope</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#ModFun"><span class="hs-identifier hs-type">ModFun</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scope
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-keyword">data</span><span> </span><span id="Scope"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Scope"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span></span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="scopeSubsts"><span class="annot"><span class="annottext">Scope -&gt; Map VName VName
</span><a href="Futhark.Internalise.Defunctorise.html#scopeSubsts"><span class="hs-identifier hs-var hs-var">scopeSubsts</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Substitutions"><span class="hs-identifier hs-type">Substitutions</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span id="scopeMods"><span class="annot"><span class="annottext">Scope -&gt; Map VName Mod
</span><a href="Futhark.Internalise.Defunctorise.html#scopeMods"><span class="hs-identifier hs-var hs-var">scopeMods</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Mod"><span class="hs-identifier hs-type">Mod</span></a></span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684522327"><span id="local-6989586621684522329"><span id="local-6989586621684522338"><span class="annot"><span class="annottext">Int -&gt; Scope -&gt; ShowS
[Scope] -&gt; ShowS
Scope -&gt; String
(Int -&gt; Scope -&gt; ShowS)
-&gt; (Scope -&gt; String) -&gt; ([Scope] -&gt; ShowS) -&gt; Show Scope
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Scope] -&gt; ShowS
$cshowList :: [Scope] -&gt; ShowS
show :: Scope -&gt; String
$cshow :: Scope -&gt; String
showsPrec :: Int -&gt; Scope -&gt; ShowS
$cshowsPrec :: Int -&gt; Scope -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#lookupSubstInScope"><span class="hs-identifier hs-type">lookupSubstInScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span id="lookupSubstInScope"><span class="annot"><span class="annottext">lookupSubstInScope :: QualName VName -&gt; Scope -&gt; (QualName VName, Scope)
</span><a href="Futhark.Internalise.Defunctorise.html#lookupSubstInScope"><span class="hs-identifier hs-var hs-var">lookupSubstInScope</span></a></span></span><span> </span><span id="local-6989586621684522325"><span class="annot"><span class="annottext">qn :: QualName VName
</span><a href="#local-6989586621684522325"><span class="hs-identifier hs-var">qn</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span id="local-6989586621684522323"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522323"><span class="hs-identifier hs-var">quals</span></a></span></span><span> </span><span id="local-6989586621684522322"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522322"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522321"><span class="annot"><span class="annottext">scope :: Scope
</span><a href="#local-6989586621684522321"><span class="hs-identifier hs-var">scope</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span id="local-6989586621684522320"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522320"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span id="local-6989586621684522319"><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684522319"><span class="hs-identifier hs-var">mods</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522323"><span class="hs-identifier hs-var">quals</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-49"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; QualName VName) -&gt; VName -&gt; QualName VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName VName -&gt; VName
</span><a href="Futhark.Internalise.Defunctorise.html#lookupSubst"><span class="hs-identifier hs-var">lookupSubst</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522322"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522320"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522321"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>    </span><span id="local-6989586621684522317"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522317"><span class="hs-identifier hs-var">q</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684522316"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522316"><span class="hs-identifier hs-var">qs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-51"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684522315"><span class="annot"><span class="annottext">q' :: VName
</span><a href="#local-6989586621684522315"><span class="hs-identifier hs-var hs-var">q'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName VName -&gt; VName
</span><a href="Futhark.Internalise.Defunctorise.html#lookupSubst"><span class="hs-identifier hs-var">lookupSubst</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522317"><span class="hs-identifier hs-var">q</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522320"><span class="hs-identifier hs-var">substs</span></a></span><span>
</span><span id="line-52"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName Mod -&gt; Maybe Mod
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522315"><span class="hs-identifier hs-var">q'</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684522319"><span class="hs-identifier hs-var">mods</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-53"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#ModMod"><span class="hs-identifier hs-type">ModMod</span></a></span><span> </span><span id="local-6989586621684522314"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522314"><span class="hs-identifier hs-var">mod_scope</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; Scope -&gt; (QualName VName, Scope)
</span><a href="Futhark.Internalise.Defunctorise.html#lookupSubstInScope"><span class="hs-identifier hs-var">lookupSubstInScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; VName -&gt; QualName VName
forall vn. [vn] -&gt; vn -&gt; QualName vn
</span><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-var">QualName</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522316"><span class="hs-identifier hs-var">qs</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522322"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522314"><span class="hs-identifier hs-var">mod_scope</span></a></span><span>
</span><span id="line-54"></span><span>            </span><span class="annot"><span class="annottext">Maybe Mod
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684522325"><span class="hs-identifier hs-var">qn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522321"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684522309"><span id="local-6989586621684522311"><span class="annot"><span class="hs-identifier hs-type">Semigroup</span></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-57"></span><span>  </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span id="local-6989586621684522305"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522305"><span class="hs-identifier hs-var">ss1</span></a></span></span><span> </span><span id="local-6989586621684522304"><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684522304"><span class="hs-identifier hs-var">mt1</span></a></span></span><span> </span><span id="local-6989586621684522303"><span class="annot"><span class="annottext">&lt;&gt; :: Scope -&gt; Scope -&gt; Scope
</span><span class="hs-operator hs-var hs-var hs-var hs-var">&lt;&gt;</span></span></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span id="local-6989586621684522302"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522302"><span class="hs-identifier hs-var">ss2</span></a></span></span><span> </span><span id="local-6989586621684522301"><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684522301"><span class="hs-identifier hs-var">mt2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522305"><span class="hs-identifier hs-var">ss1</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName VName -&gt; Map VName VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522302"><span class="hs-identifier hs-var">ss2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684522304"><span class="hs-identifier hs-var">mt1</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Mod -&gt; Map VName Mod -&gt; Map VName Mod
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684522301"><span class="hs-identifier hs-var">mt2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684522294"><span id="local-6989586621684522296"><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-60"></span><span>  </span><span id="local-6989586621684522290"><span class="annot"><span class="annottext">mempty :: Scope
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">mempty</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Map VName Mod
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="hs-keyword">type</span><span> </span><span id="TySet"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TySet"><span class="hs-identifier hs-var">TySet</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-keyword">data</span><span> </span><span id="Env"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Env"><span class="hs-identifier hs-var">Env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Env"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Env"><span class="hs-identifier hs-var">Env</span></a></span></span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="envScope"><span class="annot"><span class="annottext">Env -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#envScope"><span class="hs-identifier hs-var hs-var">envScope</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-66"></span><span>    </span><span id="envGenerating"><span class="annot"><span class="annottext">Env -&gt; Bool
</span><a href="Futhark.Internalise.Defunctorise.html#envGenerating"><span class="hs-identifier hs-var hs-var">envGenerating</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span>
</span><span id="line-67"></span><span>    </span><span id="envImports"><span class="annot"><span class="annottext">Env -&gt; Map String Scope
</span><a href="Futhark.Internalise.Defunctorise.html#envImports"><span class="hs-identifier hs-var hs-var">envImports</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>    </span><span id="envAbs"><span class="annot"><span class="annottext">Env -&gt; TySet
</span><a href="Futhark.Internalise.Defunctorise.html#envAbs"><span class="hs-identifier hs-var hs-var">envAbs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TySet"><span class="hs-identifier hs-type">TySet</span></a></span><span>
</span><span id="line-69"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span class="hs-keyword">newtype</span><span> </span><span id="TransformM"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-var">TransformM</span></a></span></span><span> </span><span id="local-6989586621684522284"><span class="annot"><a href="#local-6989586621684522284"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TransformM"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-var">TransformM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">RWS</span></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DL.DList</span></span><span> </span><span class="annot"><a href="Language.Futhark.html#Dec"><span class="hs-identifier hs-type">Dec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522284"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-73"></span><span>    </span><span class="hs-special">(</span><span> </span><span id="local-6989586621684522250"><span id="local-6989586621684522257"><span id="local-6989586621684522264"><span id="local-6989586621684522271"><span id="local-6989586621684522279"><span class="annot"><span class="annottext">Functor TransformM
Functor TransformM
-&gt; (forall a. a -&gt; TransformM a)
-&gt; (forall a b.
    TransformM (a -&gt; b) -&gt; TransformM a -&gt; TransformM b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c) -&gt; TransformM a -&gt; TransformM b -&gt; TransformM c)
-&gt; (forall a b. TransformM a -&gt; TransformM b -&gt; TransformM b)
-&gt; (forall a b. TransformM a -&gt; TransformM b -&gt; TransformM a)
-&gt; Applicative TransformM
forall a. a -&gt; TransformM a
forall a b. TransformM a -&gt; TransformM b -&gt; TransformM a
forall a b. TransformM a -&gt; TransformM b -&gt; TransformM b
forall a b. TransformM (a -&gt; b) -&gt; TransformM a -&gt; TransformM b
forall a b c.
(a -&gt; b -&gt; c) -&gt; TransformM a -&gt; TransformM b -&gt; TransformM c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: forall a b. TransformM a -&gt; TransformM b -&gt; TransformM a
$c&lt;* :: forall a b. TransformM a -&gt; TransformM b -&gt; TransformM a
*&gt; :: forall a b. TransformM a -&gt; TransformM b -&gt; TransformM b
$c*&gt; :: forall a b. TransformM a -&gt; TransformM b -&gt; TransformM b
liftA2 :: forall a b c.
(a -&gt; b -&gt; c) -&gt; TransformM a -&gt; TransformM b -&gt; TransformM c
$cliftA2 :: forall a b c.
(a -&gt; b -&gt; c) -&gt; TransformM a -&gt; TransformM b -&gt; TransformM c
&lt;*&gt; :: forall a b. TransformM (a -&gt; b) -&gt; TransformM a -&gt; TransformM b
$c&lt;*&gt; :: forall a b. TransformM (a -&gt; b) -&gt; TransformM a -&gt; TransformM b
pure :: forall a. a -&gt; TransformM a
$cpure :: forall a. a -&gt; TransformM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-74"></span><span>      </span><span id="local-6989586621684522233"><span id="local-6989586621684522239"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; TransformM a -&gt; TransformM b)
-&gt; (forall a b. a -&gt; TransformM b -&gt; TransformM a)
-&gt; Functor TransformM
forall a b. a -&gt; TransformM b -&gt; TransformM a
forall a b. (a -&gt; b) -&gt; TransformM a -&gt; TransformM b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: forall a b. a -&gt; TransformM b -&gt; TransformM a
$c&lt;$ :: forall a b. a -&gt; TransformM b -&gt; TransformM a
fmap :: forall a b. (a -&gt; b) -&gt; TransformM a -&gt; TransformM b
$cfmap :: forall a b. (a -&gt; b) -&gt; TransformM a -&gt; TransformM b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-75"></span><span>      </span><span id="local-6989586621684522212"><span id="local-6989586621684522218"><span id="local-6989586621684522225"><span class="annot"><span class="annottext">Applicative TransformM
Applicative TransformM
-&gt; (forall a b.
    TransformM a -&gt; (a -&gt; TransformM b) -&gt; TransformM b)
-&gt; (forall a b. TransformM a -&gt; TransformM b -&gt; TransformM b)
-&gt; (forall a. a -&gt; TransformM a)
-&gt; Monad TransformM
forall a. a -&gt; TransformM a
forall a b. TransformM a -&gt; TransformM b -&gt; TransformM b
forall a b. TransformM a -&gt; (a -&gt; TransformM b) -&gt; TransformM b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: forall a. a -&gt; TransformM a
$creturn :: forall a. a -&gt; TransformM a
&gt;&gt; :: forall a b. TransformM a -&gt; TransformM b -&gt; TransformM b
$c&gt;&gt; :: forall a b. TransformM a -&gt; TransformM b -&gt; TransformM b
&gt;&gt;= :: forall a b. TransformM a -&gt; (a -&gt; TransformM b) -&gt; TransformM b
$c&gt;&gt;= :: forall a b. TransformM a -&gt; (a -&gt; TransformM b) -&gt; TransformM b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-76"></span><span>      </span><span id="local-6989586621684522193"><span id="local-6989586621684522201"><span class="annot"><span class="annottext">Monad TransformM
Applicative TransformM
TransformM VNameSource
Applicative TransformM
-&gt; Monad TransformM
-&gt; TransformM VNameSource
-&gt; (VNameSource -&gt; TransformM ())
-&gt; MonadFreshNames TransformM
VNameSource -&gt; TransformM ()
forall (m :: * -&gt; *).
Applicative m
-&gt; Monad m
-&gt; m VNameSource
-&gt; (VNameSource -&gt; m ())
-&gt; MonadFreshNames m
putNameSource :: VNameSource -&gt; TransformM ()
$cputNameSource :: VNameSource -&gt; TransformM ()
getNameSource :: TransformM VNameSource
$cgetNameSource :: TransformM VNameSource
</span><a href="Futhark.MonadFreshNames.html#C%3AMonadFreshNames"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">MonadFreshNames</span></a></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-77"></span><span>      </span><span id="local-6989586621684522169"><span id="local-6989586621684522175"><span id="local-6989586621684522182"><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-78"></span><span>      </span><span id="local-6989586621684522139"><span id="local-6989586621684522145"><span id="local-6989586621684522151"><span id="local-6989586621684522158"><span class="annot"><span class="hs-identifier hs-type">MonadWriter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">DL.DList</span></span><span> </span><span class="annot"><a href="Language.Futhark.html#Dec"><span class="hs-identifier hs-type">Dec</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-79"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#emit"><span class="hs-identifier hs-type">emit</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#Dec"><span class="hs-identifier hs-type">Dec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span id="emit"><span class="annot"><span class="annottext">emit :: Dec -&gt; TransformM ()
</span><a href="Futhark.Internalise.Defunctorise.html#emit"><span class="hs-identifier hs-var hs-var">emit</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DList Dec -&gt; TransformM ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">(DList Dec -&gt; TransformM ())
-&gt; (Dec -&gt; DList Dec) -&gt; Dec -&gt; TransformM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Dec -&gt; DList Dec
forall a. a -&gt; DList a
</span><span class="hs-identifier hs-var">DL.singleton</span></span><span>
</span><span id="line-83"></span><span>
</span><span id="line-84"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#askScope"><span class="hs-identifier hs-type">askScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span>
</span><span id="line-85"></span><span id="askScope"><span class="annot"><span class="annottext">askScope :: TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#askScope"><span class="hs-identifier hs-var hs-var">askScope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env -&gt; Scope) -&gt; TransformM Scope
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#envScope"><span class="hs-identifier hs-var hs-var">envScope</span></a></span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span id="local-6989586621684522676"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#localScope"><span class="hs-identifier hs-type">localScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522676"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522676"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-88"></span><span id="localScope"><span class="annot"><span class="annottext">localScope :: forall a. (Scope -&gt; Scope) -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#localScope"><span class="hs-identifier hs-var hs-var">localScope</span></a></span></span><span> </span><span id="local-6989586621684522125"><span class="annot"><span class="annottext">Scope -&gt; Scope
</span><a href="#local-6989586621684522125"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env -&gt; Env) -&gt; TransformM a -&gt; TransformM a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((Env -&gt; Env) -&gt; TransformM a -&gt; TransformM a)
-&gt; (Env -&gt; Env) -&gt; TransformM a -&gt; TransformM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684522123"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522123"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522123"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">envScope :: Scope
</span><a href="Futhark.Internalise.Defunctorise.html#envScope"><span class="hs-identifier hs-var">envScope</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Scope
</span><a href="#local-6989586621684522125"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Scope) -&gt; Scope -&gt; Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#envScope"><span class="hs-identifier hs-var hs-var">envScope</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522123"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span id="local-6989586621684522674"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#extendScope"><span class="hs-identifier hs-type">extendScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522674"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522674"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-91"></span><span id="extendScope"><span class="annot"><span class="annottext">extendScope :: forall a. Scope -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#extendScope"><span class="hs-identifier hs-var hs-var">extendScope</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span id="local-6989586621684522118"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522118"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span id="local-6989586621684522117"><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684522117"><span class="hs-identifier hs-var">mods</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Scope) -&gt; TransformM a -&gt; TransformM a
forall a. (Scope -&gt; Scope) -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">((Scope -&gt; Scope) -&gt; TransformM a -&gt; TransformM a)
-&gt; (Scope -&gt; Scope) -&gt; TransformM a -&gt; TransformM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684522116"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522116"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522116"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-93"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">scopeSubsts :: Map VName VName
</span><a href="Futhark.Internalise.Defunctorise.html#scopeSubsts"><span class="hs-identifier hs-var">scopeSubsts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; VName) -&gt; Map VName VName -&gt; Map VName VName
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName VName -&gt; VName -&gt; VName
forall {k}. Ord k =&gt; Map k k -&gt; k -&gt; k
</span><a href="#local-6989586621684522114"><span class="hs-identifier hs-var">forward</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; Map VName VName
</span><a href="Futhark.Internalise.Defunctorise.html#scopeSubsts"><span class="hs-identifier hs-var hs-var">scopeSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522116"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522118"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName VName -&gt; Map VName VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Map VName VName
</span><a href="Futhark.Internalise.Defunctorise.html#scopeSubsts"><span class="hs-identifier hs-var hs-var">scopeSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522116"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-94"></span><span>      </span><span class="annot"><span class="annottext">scopeMods :: Map VName Mod
</span><a href="Futhark.Internalise.Defunctorise.html#scopeMods"><span class="hs-identifier hs-var">scopeMods</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684522117"><span class="hs-identifier hs-var">mods</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Mod -&gt; Map VName Mod -&gt; Map VName Mod
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Map VName Mod
</span><a href="Futhark.Internalise.Defunctorise.html#scopeMods"><span class="hs-identifier hs-var hs-var">scopeMods</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522116"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-95"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-97"></span><span>    </span><span id="local-6989586621684522114"><span class="annot"><span class="annottext">forward :: Map k k -&gt; k -&gt; k
</span><a href="#local-6989586621684522114"><span class="hs-identifier hs-var hs-var">forward</span></a></span></span><span> </span><span id="local-6989586621684522111"><span class="annot"><span class="annottext">Map k k
</span><a href="#local-6989586621684522111"><span class="hs-identifier hs-var">old_substs</span></a></span></span><span> </span><span id="local-6989586621684522110"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684522110"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">k -&gt; Maybe k -&gt; k
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684522110"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe k -&gt; k) -&gt; Maybe k -&gt; k
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">k -&gt; Map k k -&gt; Maybe k
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684522110"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map k k
</span><a href="#local-6989586621684522111"><span class="hs-identifier hs-var">old_substs</span></a></span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span id="local-6989586621684522667"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#substituting"><span class="hs-identifier hs-type">substituting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Substitutions"><span class="hs-identifier hs-type">Substitutions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522667"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522667"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-100"></span><span id="substituting"><span class="annot"><span class="annottext">substituting :: forall a. Map VName VName -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#substituting"><span class="hs-identifier hs-var hs-var">substituting</span></a></span></span><span> </span><span id="local-6989586621684522106"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522106"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scope -&gt; TransformM a -&gt; TransformM a
forall a. Scope -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#extendScope"><span class="hs-identifier hs-var">extendScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">scopeSubsts :: Map VName VName
</span><a href="Futhark.Internalise.Defunctorise.html#scopeSubsts"><span class="hs-identifier hs-var">scopeSubsts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522106"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#boundName"><span class="hs-identifier hs-type">boundName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-103"></span><span id="boundName"><span class="annot"><span class="annottext">boundName :: VName -&gt; TransformM VName
</span><a href="Futhark.Internalise.Defunctorise.html#boundName"><span class="hs-identifier hs-var hs-var">boundName</span></a></span></span><span> </span><span id="local-6989586621684522104"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522104"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-104"></span><span>  </span><span id="local-6989586621684522103"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684522103"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env -&gt; Bool) -&gt; TransformM Bool
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Bool
</span><a href="Futhark.Internalise.Defunctorise.html#envGenerating"><span class="hs-identifier hs-var hs-var">envGenerating</span></a></span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684522103"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TransformM VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; VName -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newName"><span class="hs-identifier hs-var">newName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522104"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TransformM VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522104"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#bindingNames"><span class="hs-identifier hs-type">bindingNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span>
</span><span id="line-108"></span><span id="bindingNames"><span class="annot"><span class="annottext">bindingNames :: [VName] -&gt; TransformM Scope -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#bindingNames"><span class="hs-identifier hs-var hs-var">bindingNames</span></a></span></span><span> </span><span id="local-6989586621684522100"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522100"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span id="local-6989586621684522099"><span class="annot"><span class="annottext">TransformM Scope
</span><a href="#local-6989586621684522099"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-109"></span><span>  </span><span id="local-6989586621684522098"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522098"><span class="hs-identifier hs-var">names'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TransformM VName) -&gt; [VName] -&gt; TransformM [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TransformM VName
</span><a href="Futhark.Internalise.Defunctorise.html#boundName"><span class="hs-identifier hs-var">boundName</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522100"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-110"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684522095"><span class="annot"><span class="annottext">substs :: Map VName VName
</span><a href="#local-6989586621684522095"><span class="hs-identifier hs-var hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, VName)] -&gt; Map VName VName
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [(VName, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522100"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522098"><span class="hs-identifier hs-var">names'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span>  </span><span class="annot"><span class="annottext">Map VName VName -&gt; TransformM Scope -&gt; TransformM Scope
forall a. Map VName VName -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#substituting"><span class="hs-identifier hs-var">substituting</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522095"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">(TransformM Scope -&gt; TransformM Scope)
-&gt; TransformM Scope -&gt; TransformM Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Scope -&gt; Scope
forall a. Monoid a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">mappend</span></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Scope -&gt; Scope)
-&gt; TransformM Scope -&gt; TransformM (Scope -&gt; Scope)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TransformM Scope
</span><a href="#local-6989586621684522099"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TransformM (Scope -&gt; Scope) -&gt; TransformM Scope -&gt; TransformM Scope
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; TransformM Scope
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522095"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Mod
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span id="local-6989586621684522653"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#generating"><span class="hs-identifier hs-type">generating</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522653"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522653"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-114"></span><span id="generating"><span class="annot"><span class="annottext">generating :: forall a. TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#generating"><span class="hs-identifier hs-var hs-var">generating</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env -&gt; Env) -&gt; TransformM a -&gt; TransformM a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((Env -&gt; Env) -&gt; TransformM a -&gt; TransformM a)
-&gt; (Env -&gt; Env) -&gt; TransformM a -&gt; TransformM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684522090"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522090"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522090"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">envGenerating :: Bool
</span><a href="Futhark.Internalise.Defunctorise.html#envGenerating"><span class="hs-identifier hs-var">envGenerating</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">}</span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span id="local-6989586621684522651"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#bindingImport"><span class="hs-identifier hs-type">bindingImport</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522651"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522651"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-117"></span><span id="bindingImport"><span class="annot"><span class="annottext">bindingImport :: forall a. String -&gt; Scope -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#bindingImport"><span class="hs-identifier hs-var hs-var">bindingImport</span></a></span></span><span> </span><span id="local-6989586621684522086"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684522086"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684522085"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522085"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env -&gt; Env) -&gt; TransformM a -&gt; TransformM a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((Env -&gt; Env) -&gt; TransformM a -&gt; TransformM a)
-&gt; (Env -&gt; Env) -&gt; TransformM a -&gt; TransformM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684522084"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522084"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-118"></span><span>  </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522084"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">envImports :: Map String Scope
</span><a href="Futhark.Internalise.Defunctorise.html#envImports"><span class="hs-identifier hs-var">envImports</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Scope -&gt; Map String Scope -&gt; Map String Scope
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684522086"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522085"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">(Map String Scope -&gt; Map String Scope)
-&gt; Map String Scope -&gt; Map String Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Map String Scope
</span><a href="Futhark.Internalise.Defunctorise.html#envImports"><span class="hs-identifier hs-var hs-var">envImports</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522084"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-119"></span><span>
</span><span id="line-120"></span><span id="local-6989586621684522647"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#bindingAbs"><span class="hs-identifier hs-type">bindingAbs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TySet"><span class="hs-identifier hs-type">TySet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522647"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522647"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-121"></span><span id="bindingAbs"><span class="annot"><span class="annottext">bindingAbs :: forall a. TySet -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#bindingAbs"><span class="hs-identifier hs-var hs-var">bindingAbs</span></a></span></span><span> </span><span id="local-6989586621684522079"><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684522079"><span class="hs-identifier hs-var">abs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env -&gt; Env) -&gt; TransformM a -&gt; TransformM a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((Env -&gt; Env) -&gt; TransformM a -&gt; TransformM a)
-&gt; (Env -&gt; Env) -&gt; TransformM a -&gt; TransformM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684522078"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522078"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-122"></span><span>  </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522078"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">envAbs :: TySet
</span><a href="Futhark.Internalise.Defunctorise.html#envAbs"><span class="hs-identifier hs-var">envAbs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684522079"><span class="hs-identifier hs-var">abs</span></a></span><span> </span><span class="annot"><span class="annottext">TySet -&gt; TySet -&gt; TySet
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; TySet
</span><a href="Futhark.Internalise.Defunctorise.html#envAbs"><span class="hs-identifier hs-var hs-var">envAbs</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522078"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#lookupImport"><span class="hs-identifier hs-type">lookupImport</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span>
</span><span id="line-125"></span><span id="lookupImport"><span class="annot"><span class="annottext">lookupImport :: String -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#lookupImport"><span class="hs-identifier hs-var hs-var">lookupImport</span></a></span></span><span> </span><span id="local-6989586621684522076"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684522076"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TransformM Scope
-&gt; (Scope -&gt; TransformM Scope) -&gt; Maybe Scope -&gt; TransformM Scope
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">TransformM Scope
forall {a}. a
</span><a href="#local-6989586621684522074"><span class="hs-identifier hs-var">bad</span></a></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; TransformM Scope
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Scope -&gt; TransformM Scope)
-&gt; TransformM (Maybe Scope) -&gt; TransformM Scope
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">(Env -&gt; Maybe Scope) -&gt; TransformM (Maybe Scope)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Map String Scope -&gt; Maybe Scope
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684522076"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(Map String Scope -&gt; Maybe Scope)
-&gt; (Env -&gt; Map String Scope) -&gt; Env -&gt; Maybe Scope
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Map String Scope
</span><a href="Futhark.Internalise.Defunctorise.html#envImports"><span class="hs-identifier hs-var hs-var">envImports</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-127"></span><span>    </span><span id="local-6989586621684522074"><span class="annot"><span class="annottext">bad :: a
</span><a href="#local-6989586621684522074"><span class="hs-identifier hs-var hs-var">bad</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; a
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; a) -&gt; String -&gt; a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unknown import: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684522076"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#lookupMod%27"><span class="hs-identifier hs-type">lookupMod'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Mod"><span class="hs-identifier hs-type">Mod</span></a></span><span>
</span><span id="line-130"></span><span id="lookupMod%27"><span class="annot"><span class="annottext">lookupMod' :: QualName VName -&gt; Scope -&gt; Either String Mod
</span><a href="Futhark.Internalise.Defunctorise.html#lookupMod%27"><span class="hs-identifier hs-var hs-var">lookupMod'</span></a></span></span><span> </span><span id="local-6989586621684522068"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684522068"><span class="hs-identifier hs-var">mname</span></a></span></span><span> </span><span id="local-6989586621684522067"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522067"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-131"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684522066"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684522066"><span class="hs-identifier hs-var">mname'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522065"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522065"><span class="hs-identifier hs-var">scope'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; Scope -&gt; (QualName VName, Scope)
</span><a href="Futhark.Internalise.Defunctorise.html#lookupSubstInScope"><span class="hs-identifier hs-var">lookupSubstInScope</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684522068"><span class="hs-identifier hs-var">mname</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522067"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-132"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Either String Mod
-&gt; (Mod -&gt; Either String Mod) -&gt; Maybe Mod -&gt; Either String Mod
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Either String Mod
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Either String Mod) -&gt; String -&gt; Either String Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; String
forall {a}. Pretty a =&gt; a -&gt; String
</span><a href="#local-6989586621684522064"><span class="hs-identifier hs-var">bad</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684522066"><span class="hs-identifier hs-var">mname'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Mod -&gt; Either String Mod
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Mod -&gt; Either String Mod) -&gt; Maybe Mod -&gt; Either String Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName Mod -&gt; Maybe Mod
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684522066"><span class="hs-identifier hs-var">mname'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map VName Mod -&gt; Maybe Mod) -&gt; Map VName Mod -&gt; Maybe Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Map VName Mod
</span><a href="Futhark.Internalise.Defunctorise.html#scopeMods"><span class="hs-identifier hs-var hs-var">scopeMods</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684522065"><span class="hs-identifier hs-var">scope'</span></a></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-134"></span><span>    </span><span id="local-6989586621684522064"><span class="annot"><span class="annottext">bad :: a -&gt; String
</span><a href="#local-6989586621684522064"><span class="hs-identifier hs-var hs-var">bad</span></a></span></span><span> </span><span id="local-6989586621684522058"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684522058"><span class="hs-identifier hs-var">mname'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unknown module: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; String
forall {a}. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684522068"><span class="hs-identifier hs-var">mname</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; (&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; String
forall {a}. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684522058"><span class="hs-identifier hs-var">mname'</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;)&quot;</span></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#lookupMod"><span class="hs-identifier hs-type">lookupMod</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Mod"><span class="hs-identifier hs-type">Mod</span></a></span><span>
</span><span id="line-137"></span><span id="lookupMod"><span class="annot"><span class="annottext">lookupMod :: QualName VName -&gt; TransformM Mod
</span><a href="Futhark.Internalise.Defunctorise.html#lookupMod"><span class="hs-identifier hs-var hs-var">lookupMod</span></a></span></span><span> </span><span id="local-6989586621684522055"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684522055"><span class="hs-identifier hs-var">mname</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; TransformM Mod)
-&gt; (Mod -&gt; TransformM Mod) -&gt; Either String Mod -&gt; TransformM Mod
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; TransformM Mod
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">Mod -&gt; TransformM Mod
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Either String Mod -&gt; TransformM Mod)
-&gt; (Scope -&gt; Either String Mod) -&gt; Scope -&gt; TransformM Mod
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; Scope -&gt; Either String Mod
</span><a href="Futhark.Internalise.Defunctorise.html#lookupMod%27"><span class="hs-identifier hs-var">lookupMod'</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684522055"><span class="hs-identifier hs-var">mname</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; TransformM Mod) -&gt; TransformM Scope -&gt; TransformM Mod
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span id="local-6989586621684522630"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#runTransformM"><span class="hs-identifier hs-type">runTransformM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522630"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684522630"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">DL.DList</span></span><span> </span><span class="annot"><a href="Language.Futhark.html#Dec"><span class="hs-identifier hs-type">Dec</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-140"></span><span id="runTransformM"><span class="annot"><span class="annottext">runTransformM :: forall a.
VNameSource -&gt; TransformM a -&gt; (a, VNameSource, DList Dec)
</span><a href="Futhark.Internalise.Defunctorise.html#runTransformM"><span class="hs-identifier hs-var hs-var">runTransformM</span></a></span></span><span> </span><span id="local-6989586621684522052"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684522052"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span id="local-6989586621684522051"><span class="annot"><span class="annottext">RWS Env (DList Dec) VNameSource a
</span><a href="#local-6989586621684522051"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RWS Env (DList Dec) VNameSource a
-&gt; Env -&gt; VNameSource -&gt; (a, VNameSource, DList Dec)
forall r w s a. RWS r w s a -&gt; r -&gt; s -&gt; (a, s, w)
</span><span class="hs-identifier hs-var">runRWS</span></span><span> </span><span class="annot"><span class="annottext">RWS Env (DList Dec) VNameSource a
</span><a href="#local-6989586621684522051"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522049"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684522052"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-142"></span><span>    </span><span id="local-6989586621684522049"><span class="annot"><span class="annottext">env :: Env
</span><a href="#local-6989586621684522049"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Bool -&gt; Map String Scope -&gt; TySet -&gt; Env
</span><a href="Futhark.Internalise.Defunctorise.html#Env"><span class="hs-identifier hs-var">Env</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">Map String Scope
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">TySet
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-143"></span><span>
</span><span id="line-144"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#maybeAscript"><span class="hs-identifier hs-type">maybeAscript</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-145"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-146"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.html#SigExp"><span class="hs-identifier hs-type">SigExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-147"></span><span>  </span><span class="annot"><a href="Language.Futhark.html#ModExp"><span class="hs-identifier hs-type">ModExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-148"></span><span>  </span><span class="annot"><a href="Language.Futhark.html#ModExp"><span class="hs-identifier hs-type">ModExp</span></a></span><span>
</span><span id="line-149"></span><span id="maybeAscript"><span class="annot"><span class="annottext">maybeAscript :: SrcLoc
-&gt; Maybe (SigExp, Info (Map VName VName)) -&gt; ModExp -&gt; ModExp
</span><a href="Futhark.Internalise.Defunctorise.html#maybeAscript"><span class="hs-identifier hs-var hs-var">maybeAscript</span></a></span></span><span> </span><span id="local-6989586621684522040"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522040"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684522039"><span class="annot"><span class="annottext">SigExp
</span><a href="#local-6989586621684522039"><span class="hs-identifier hs-var">mtye</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522038"><span class="annot"><span class="annottext">Info (Map VName VName)
</span><a href="#local-6989586621684522038"><span class="hs-identifier hs-var">substs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522037"><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684522037"><span class="hs-identifier hs-var">me</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModExp -&gt; SigExp -&gt; Info (Map VName VName) -&gt; SrcLoc -&gt; ModExp
forall (f :: * -&gt; *) vn.
ModExpBase f vn
-&gt; SigExpBase f vn
-&gt; f (Map VName VName)
-&gt; SrcLoc
-&gt; ModExpBase f vn
</span><a href="Language.Futhark.Syntax.html#ModAscript"><span class="hs-identifier hs-var">ModAscript</span></a></span><span> </span><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684522037"><span class="hs-identifier hs-var">me</span></a></span><span> </span><span class="annot"><span class="annottext">SigExp
</span><a href="#local-6989586621684522039"><span class="hs-identifier hs-var">mtye</span></a></span><span> </span><span class="annot"><span class="annottext">Info (Map VName VName)
</span><a href="#local-6989586621684522038"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522040"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-150"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#maybeAscript"><span class="hs-identifier hs-var">maybeAscript</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SigExp, Info (Map VName VName))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span id="local-6989586621684522035"><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684522035"><span class="hs-identifier hs-var">me</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684522035"><span class="hs-identifier hs-var">me</span></a></span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#substituteInMod"><span class="hs-identifier hs-type">substituteInMod</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Substitutions"><span class="hs-identifier hs-type">Substitutions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Mod"><span class="hs-identifier hs-type">Mod</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Mod"><span class="hs-identifier hs-type">Mod</span></a></span><span>
</span><span id="line-153"></span><span id="substituteInMod"><span class="annot"><span class="annottext">substituteInMod :: Map VName VName -&gt; Mod -&gt; Mod
</span><a href="Futhark.Internalise.Defunctorise.html#substituteInMod"><span class="hs-identifier hs-var hs-var">substituteInMod</span></a></span></span><span> </span><span id="local-6989586621684522033"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522033"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#ModMod"><span class="hs-identifier hs-type">ModMod</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span id="local-6989586621684522032"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522032"><span class="hs-identifier hs-var">mod_substs</span></a></span></span><span> </span><span id="local-6989586621684522031"><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684522031"><span class="hs-identifier hs-var">mod_mods</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-comment">-- Forward all substitutions.</span><span>
</span><span id="line-155"></span><span>  </span><span class="annot"><span class="annottext">Scope -&gt; Mod
</span><a href="Futhark.Internalise.Defunctorise.html#ModMod"><span class="hs-identifier hs-var">ModMod</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Mod) -&gt; Scope -&gt; Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522030"><span class="hs-identifier hs-var">substs'</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName Mod -&gt; Scope) -&gt; Map VName Mod -&gt; Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Mod -&gt; Mod) -&gt; Map VName Mod -&gt; Map VName Mod
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName VName -&gt; Mod -&gt; Mod
</span><a href="Futhark.Internalise.Defunctorise.html#substituteInMod"><span class="hs-identifier hs-var">substituteInMod</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522033"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684522031"><span class="hs-identifier hs-var">mod_mods</span></a></span><span>
</span><span id="line-156"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-157"></span><span>    </span><span id="local-6989586621684522027"><span class="annot"><span class="annottext">forward :: VName -&gt; VName
</span><a href="#local-6989586621684522027"><span class="hs-identifier hs-var hs-var">forward</span></a></span></span><span> </span><span id="local-6989586621684522026"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522026"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName VName -&gt; VName
</span><a href="Futhark.Internalise.Defunctorise.html#lookupSubst"><span class="hs-identifier hs-var">lookupSubst</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522026"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName VName -&gt; VName) -&gt; Map VName VName -&gt; VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522032"><span class="hs-identifier hs-var">mod_substs</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName VName -&gt; Map VName VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522033"><span class="hs-identifier hs-var">substs</span></a></span><span>
</span><span id="line-158"></span><span>    </span><span id="local-6989586621684522030"><span class="annot"><span class="annottext">substs' :: Map VName VName
</span><a href="#local-6989586621684522030"><span class="hs-identifier hs-var hs-var">substs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; VName) -&gt; Map VName VName -&gt; Map VName VName
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName
</span><a href="#local-6989586621684522027"><span class="hs-identifier hs-var">forward</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522033"><span class="hs-identifier hs-var">substs</span></a></span><span>
</span><span id="line-159"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#substituteInMod"><span class="hs-identifier hs-var">substituteInMod</span></a></span><span> </span><span id="local-6989586621684522025"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522025"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#ModFun"><span class="hs-identifier hs-type">ModFun</span></a></span><span> </span><span id="local-6989586621684522024"><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684522024"><span class="hs-identifier hs-var">abs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span id="local-6989586621684522023"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522023"><span class="hs-identifier hs-var">mod_substs</span></a></span></span><span> </span><span id="local-6989586621684522022"><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684522022"><span class="hs-identifier hs-var">mod_mods</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522021"><span class="annot"><span class="annottext">ModParam
</span><a href="#local-6989586621684522021"><span class="hs-identifier hs-var">mparam</span></a></span></span><span> </span><span id="local-6989586621684522020"><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684522020"><span class="hs-identifier hs-var">mbody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-160"></span><span>  </span><span class="annot"><span class="annottext">TySet -&gt; Scope -&gt; ModParam -&gt; ModExp -&gt; Mod
</span><a href="Futhark.Internalise.Defunctorise.html#ModFun"><span class="hs-identifier hs-var">ModFun</span></a></span><span> </span><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684522024"><span class="hs-identifier hs-var">abs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522019"><span class="hs-identifier hs-var">substs'</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName VName -&gt; Map VName VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522023"><span class="hs-identifier hs-var">mod_substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684522022"><span class="hs-identifier hs-var">mod_mods</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ModParam
</span><a href="#local-6989586621684522021"><span class="hs-identifier hs-var">mparam</span></a></span><span> </span><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684522020"><span class="hs-identifier hs-var">mbody</span></a></span><span>
</span><span id="line-161"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-162"></span><span>    </span><span id="local-6989586621684522018"><span class="annot"><span class="annottext">forward :: VName -&gt; VName
</span><a href="#local-6989586621684522018"><span class="hs-identifier hs-var hs-var">forward</span></a></span></span><span> </span><span id="local-6989586621684522017"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522017"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName VName -&gt; VName
</span><a href="Futhark.Internalise.Defunctorise.html#lookupSubst"><span class="hs-identifier hs-var">lookupSubst</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522017"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522023"><span class="hs-identifier hs-var">mod_substs</span></a></span><span>
</span><span id="line-163"></span><span>    </span><span id="local-6989586621684522019"><span class="annot"><span class="annottext">substs' :: Map VName VName
</span><a href="#local-6989586621684522019"><span class="hs-identifier hs-var hs-var">substs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; VName) -&gt; Map VName VName -&gt; Map VName VName
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName
</span><a href="#local-6989586621684522018"><span class="hs-identifier hs-var">forward</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522025"><span class="hs-identifier hs-var">substs</span></a></span><span>
</span><span id="line-164"></span><span>
</span><span id="line-165"></span><span id="local-6989586621684522016"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#extendAbsTypes"><span class="hs-identifier hs-type">extendAbsTypes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Substitutions"><span class="hs-identifier hs-type">Substitutions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522016"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522016"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-166"></span><span id="extendAbsTypes"><span class="annot"><span class="annottext">extendAbsTypes :: forall a. Map VName VName -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#extendAbsTypes"><span class="hs-identifier hs-var hs-var">extendAbsTypes</span></a></span></span><span> </span><span id="local-6989586621684522012"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522012"><span class="hs-identifier hs-var">ascript_substs</span></a></span></span><span> </span><span id="local-6989586621684522011"><span class="annot"><span class="annottext">TransformM a
</span><a href="#local-6989586621684522011"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-167"></span><span>  </span><span id="local-6989586621684522010"><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684522010"><span class="hs-identifier hs-var">abs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env -&gt; TySet) -&gt; TransformM TySet
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; TySet
</span><a href="Futhark.Internalise.Defunctorise.html#envAbs"><span class="hs-identifier hs-var hs-var">envAbs</span></a></span><span>
</span><span id="line-168"></span><span>  </span><span class="hs-comment">-- Some abstract types may have a different name on the inside, and</span><span>
</span><span id="line-169"></span><span>  </span><span class="hs-comment">-- we need to make them visible, because substitutions involving</span><span>
</span><span id="line-170"></span><span>  </span><span class="hs-comment">-- abstract types must be lifted out in transformModBind.</span><span>
</span><span id="line-171"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684522007"><span class="annot"><span class="annottext">subst_abs :: TySet
</span><a href="#local-6989586621684522007"><span class="hs-identifier hs-var hs-var">subst_abs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-172"></span><span>        </span><span class="annot"><span class="annottext">[VName] -&gt; TySet
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; TySet)
-&gt; ([(VName, VName)] -&gt; [VName]) -&gt; [(VName, VName)] -&gt; TySet
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((VName, VName) -&gt; VName) -&gt; [(VName, VName)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, VName) -&gt; VName
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([(VName, VName)] -&gt; [VName])
-&gt; ([(VName, VName)] -&gt; [(VName, VName)])
-&gt; [(VName, VName)]
-&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((VName, VName) -&gt; Bool) -&gt; [(VName, VName)] -&gt; [(VName, VName)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; TySet -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684522010"><span class="hs-identifier hs-var">abs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; ((VName, VName) -&gt; VName) -&gt; (VName, VName) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VName, VName) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(VName, VName)] -&gt; TySet) -&gt; [(VName, VName)] -&gt; TySet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-173"></span><span>          </span><span class="annot"><span class="annottext">Map VName VName -&gt; [(VName, VName)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684522012"><span class="hs-identifier hs-var">ascript_substs</span></a></span><span>
</span><span id="line-174"></span><span>  </span><span class="annot"><span class="annottext">TySet -&gt; TransformM a -&gt; TransformM a
forall a. TySet -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#bindingAbs"><span class="hs-identifier hs-var">bindingAbs</span></a></span><span> </span><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684522007"><span class="hs-identifier hs-var">subst_abs</span></a></span><span> </span><span class="annot"><span class="annottext">TransformM a
</span><a href="#local-6989586621684522011"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-type">evalModExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#ModExp"><span class="hs-identifier hs-type">ModExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Mod"><span class="hs-identifier hs-type">Mod</span></a></span><span>
</span><span id="line-177"></span><span id="evalModExp"><span class="annot"><span class="annottext">evalModExp :: ModExp -&gt; TransformM Mod
</span><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-var hs-var">evalModExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ModVar"><span class="hs-identifier hs-type">ModVar</span></a></span><span> </span><span id="local-6989586621684522001"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684522001"><span class="hs-identifier hs-var">qn</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; TransformM Mod
</span><a href="Futhark.Internalise.Defunctorise.html#lookupMod"><span class="hs-identifier hs-var">lookupMod</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684522001"><span class="hs-identifier hs-var">qn</span></a></span><span>
</span><span id="line-178"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-var">evalModExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ModParens"><span class="hs-identifier hs-type">ModParens</span></a></span><span> </span><span id="local-6989586621684521999"><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521999"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModExp -&gt; TransformM Mod
</span><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-var">evalModExp</span></a></span><span> </span><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521999"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-179"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-var">evalModExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ModDecs"><span class="hs-identifier hs-type">ModDecs</span></a></span><span> </span><span id="local-6989586621684521997"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521997"><span class="hs-identifier hs-var">decs</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Mod
</span><a href="Futhark.Internalise.Defunctorise.html#ModMod"><span class="hs-identifier hs-var">ModMod</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Mod) -&gt; TransformM Scope -&gt; TransformM Mod
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#transformDecs"><span class="hs-identifier hs-var">transformDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521997"><span class="hs-identifier hs-var">decs</span></a></span><span>
</span><span id="line-180"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-var">evalModExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ModImport"><span class="hs-identifier hs-type">ModImport</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684521993"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684521993"><span class="hs-identifier hs-var">fpath</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Mod
</span><a href="Futhark.Internalise.Defunctorise.html#ModMod"><span class="hs-identifier hs-var">ModMod</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Mod) -&gt; TransformM Scope -&gt; TransformM Mod
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#lookupImport"><span class="hs-identifier hs-var">lookupImport</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684521993"><span class="hs-identifier hs-var">fpath</span></a></span><span>
</span><span id="line-181"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-var">evalModExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ModAscript"><span class="hs-identifier hs-type">ModAscript</span></a></span><span> </span><span id="local-6989586621684521992"><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521992"><span class="hs-identifier hs-var">me</span></a></span></span><span> </span><span class="annot"><span class="annottext">SigExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684521991"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521991"><span class="hs-identifier hs-var">ascript_substs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><span class="annottext">Map VName VName -&gt; TransformM Mod -&gt; TransformM Mod
forall a. Map VName VName -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#extendAbsTypes"><span class="hs-identifier hs-var">extendAbsTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521991"><span class="hs-identifier hs-var">ascript_substs</span></a></span><span> </span><span class="annot"><span class="annottext">(TransformM Mod -&gt; TransformM Mod)
-&gt; TransformM Mod -&gt; TransformM Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-183"></span><span>    </span><span class="annot"><span class="annottext">Map VName VName -&gt; Mod -&gt; Mod
</span><a href="Futhark.Internalise.Defunctorise.html#substituteInMod"><span class="hs-identifier hs-var">substituteInMod</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521991"><span class="hs-identifier hs-var">ascript_substs</span></a></span><span> </span><span class="annot"><span class="annottext">(Mod -&gt; Mod) -&gt; TransformM Mod -&gt; TransformM Mod
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ModExp -&gt; TransformM Mod
</span><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-var">evalModExp</span></a></span><span> </span><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521992"><span class="hs-identifier hs-var">me</span></a></span><span>
</span><span id="line-184"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-var">evalModExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ModApply"><span class="hs-identifier hs-type">ModApply</span></a></span><span> </span><span id="local-6989586621684521989"><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521989"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684521988"><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521988"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684521987"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521987"><span class="hs-identifier hs-var">p_substs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684521986"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521986"><span class="hs-identifier hs-var">b_substs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684521985"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684521985"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>  </span><span id="local-6989586621684521984"><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521984"><span class="hs-identifier hs-var">f_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ModExp -&gt; TransformM Mod
</span><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-var">evalModExp</span></a></span><span> </span><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521989"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-186"></span><span>  </span><span id="local-6989586621684521983"><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521983"><span class="hs-identifier hs-var">arg_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ModExp -&gt; TransformM Mod
</span><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-var">evalModExp</span></a></span><span> </span><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521988"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521984"><span class="hs-identifier hs-var">f_mod</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-188"></span><span>    </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#ModMod"><span class="hs-identifier hs-type">ModMod</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-189"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; TransformM Mod
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; TransformM Mod) -&gt; String -&gt; TransformM Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot apply non-parametric module at &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; String
forall a. Located a =&gt; a -&gt; String
</span><a href="Language.Futhark.Core.html#locStr"><span class="hs-identifier hs-var">locStr</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684521985"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-190"></span><span>    </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#ModFun"><span class="hs-identifier hs-type">ModFun</span></a></span><span> </span><span id="local-6989586621684521981"><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684521981"><span class="hs-identifier hs-var">f_abs</span></a></span></span><span> </span><span id="local-6989586621684521980"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521980"><span class="hs-identifier hs-var">f_closure</span></a></span></span><span> </span><span id="local-6989586621684521979"><span class="annot"><span class="annottext">ModParam
</span><a href="#local-6989586621684521979"><span class="hs-identifier hs-var">f_p</span></a></span></span><span> </span><span id="local-6989586621684521978"><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521978"><span class="hs-identifier hs-var">f_body</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-191"></span><span>      </span><span class="annot"><span class="annottext">TySet -&gt; TransformM Mod -&gt; TransformM Mod
forall a. TySet -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#bindingAbs"><span class="hs-identifier hs-var">bindingAbs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684521981"><span class="hs-identifier hs-var">f_abs</span></a></span><span> </span><span class="annot"><span class="annottext">TySet -&gt; TySet -&gt; TySet
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; TySet
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Info [VName] -&gt; [VName]
forall a. Info a -&gt; a
</span><a href="Language.Futhark.Syntax.html#unInfo"><span class="hs-identifier hs-var hs-var">unInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModParam -&gt; Info [VName]
forall (f :: * -&gt; *) vn. ModParamBase f vn -&gt; f [VName]
</span><a href="Language.Futhark.Syntax.html#modParamAbs"><span class="hs-identifier hs-var hs-var">modParamAbs</span></a></span><span> </span><span class="annot"><span class="annottext">ModParam
</span><a href="#local-6989586621684521979"><span class="hs-identifier hs-var">f_p</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>        </span><span class="annot"><span class="annottext">(TransformM Mod -&gt; TransformM Mod)
-&gt; (TransformM Mod -&gt; TransformM Mod)
-&gt; TransformM Mod
-&gt; TransformM Mod
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; TransformM Mod -&gt; TransformM Mod
forall a. Map VName VName -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#extendAbsTypes"><span class="hs-identifier hs-var">extendAbsTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521986"><span class="hs-identifier hs-var">b_substs</span></a></span><span>
</span><span id="line-193"></span><span>        </span><span class="annot"><span class="annottext">(TransformM Mod -&gt; TransformM Mod)
-&gt; (TransformM Mod -&gt; TransformM Mod)
-&gt; TransformM Mod
-&gt; TransformM Mod
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Scope) -&gt; TransformM Mod -&gt; TransformM Mod
forall a. (Scope -&gt; Scope) -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; Scope -&gt; Scope
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521980"><span class="hs-identifier hs-var">f_closure</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- Start afresh.</span><span>
</span><span id="line-194"></span><span>        </span><span class="annot"><span class="annottext">(TransformM Mod -&gt; TransformM Mod)
-&gt; (TransformM Mod -&gt; TransformM Mod)
-&gt; TransformM Mod
-&gt; TransformM Mod
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TransformM Mod -&gt; TransformM Mod
forall a. TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#generating"><span class="hs-identifier hs-var">generating</span></a></span><span>
</span><span id="line-195"></span><span>        </span><span class="annot"><span class="annottext">(TransformM Mod -&gt; TransformM Mod)
-&gt; TransformM Mod -&gt; TransformM Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-196"></span><span>          </span><span id="local-6989586621684521974"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521974"><span class="hs-identifier hs-var">outer_substs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Map VName VName
</span><a href="Futhark.Internalise.Defunctorise.html#scopeSubsts"><span class="hs-identifier hs-var hs-var">scopeSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Map VName VName)
-&gt; TransformM Scope -&gt; TransformM (Map VName VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-197"></span><span>          </span><span id="local-6989586621684521973"><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684521973"><span class="hs-identifier hs-var">abs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env -&gt; TySet) -&gt; TransformM TySet
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; TySet
</span><a href="Futhark.Internalise.Defunctorise.html#envAbs"><span class="hs-identifier hs-var hs-var">envAbs</span></a></span><span>
</span><span id="line-198"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684521972"><span class="annot"><span class="annottext">forward :: (VName, b) -&gt; (VName, b)
</span><a href="#local-6989586621684521972"><span class="hs-identifier hs-var hs-var">forward</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684521971"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521971"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684521970"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684521970"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Map VName VName -&gt; VName
</span><a href="Futhark.Internalise.Defunctorise.html#lookupSubst"><span class="hs-identifier hs-var">lookupSubst</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521971"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521974"><span class="hs-identifier hs-var">outer_substs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684521970"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>              </span><span id="local-6989586621684521968"><span class="annot"><span class="annottext">p_substs' :: Map VName VName
</span><a href="#local-6989586621684521968"><span class="hs-identifier hs-var hs-var">p_substs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, VName)] -&gt; Map VName VName
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, VName)] -&gt; Map VName VName)
-&gt; [(VName, VName)] -&gt; Map VName VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((VName, VName) -&gt; (VName, VName))
-&gt; [(VName, VName)] -&gt; [(VName, VName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, VName) -&gt; (VName, VName)
forall {b}. (VName, b) -&gt; (VName, b)
</span><a href="#local-6989586621684521972"><span class="hs-identifier hs-var">forward</span></a></span><span> </span><span class="annot"><span class="annottext">([(VName, VName)] -&gt; [(VName, VName)])
-&gt; [(VName, VName)] -&gt; [(VName, VName)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; [(VName, VName)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521987"><span class="hs-identifier hs-var">p_substs</span></a></span><span>
</span><span id="line-200"></span><span>              </span><span id="local-6989586621684521965"><span class="annot"><span class="annottext">keep :: VName -&gt; p -&gt; Bool
</span><a href="#local-6989586621684521965"><span class="hs-identifier hs-var hs-var">keep</span></a></span></span><span> </span><span id="local-6989586621684521964"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521964"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521964"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName VName -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-operator hs-var">`M.member`</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521968"><span class="hs-identifier hs-var">p_substs'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521964"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TySet -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684521973"><span class="hs-identifier hs-var">abs</span></a></span><span>
</span><span id="line-201"></span><span>              </span><span id="local-6989586621684521958"><span class="annot"><span class="annottext">abs_substs :: Map VName VName
</span><a href="#local-6989586621684521958"><span class="hs-identifier hs-var hs-var">abs_substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-202"></span><span>                </span><span class="annot"><span class="annottext">(VName -&gt; VName -&gt; Bool) -&gt; Map VName VName -&gt; Map VName VName
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.filterWithKey</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall {p}. VName -&gt; p -&gt; Bool
</span><a href="#local-6989586621684521965"><span class="hs-identifier hs-var">keep</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName VName -&gt; Map VName VName)
-&gt; Map VName VName -&gt; Map VName VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-203"></span><span>                  </span><span class="annot"><span class="annottext">(VName -&gt; VName) -&gt; Map VName VName -&gt; Map VName VName
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Map VName VName -&gt; VName
</span><a href="Futhark.Internalise.Defunctorise.html#lookupSubst"><span class="hs-operator hs-var">`lookupSubst`</span></a></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Map VName VName
</span><a href="Futhark.Internalise.Defunctorise.html#scopeSubsts"><span class="hs-identifier hs-var hs-var">scopeSubsts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#modScope"><span class="hs-identifier hs-var">modScope</span></a></span><span> </span><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521983"><span class="hs-identifier hs-var">arg_mod</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521968"><span class="hs-identifier hs-var">p_substs'</span></a></span><span>
</span><span id="line-204"></span><span>                    </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName VName -&gt; Map VName VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Map VName VName
</span><a href="Futhark.Internalise.Defunctorise.html#scopeSubsts"><span class="hs-identifier hs-var hs-var">scopeSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521980"><span class="hs-identifier hs-var">f_closure</span></a></span><span>
</span><span id="line-205"></span><span>                    </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName VName -&gt; Map VName VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Map VName VName
</span><a href="Futhark.Internalise.Defunctorise.html#scopeSubsts"><span class="hs-identifier hs-var hs-var">scopeSubsts</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#modScope"><span class="hs-identifier hs-var">modScope</span></a></span><span> </span><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521983"><span class="hs-identifier hs-var">arg_mod</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>          </span><span class="annot"><span class="annottext">Scope -&gt; TransformM Mod -&gt; TransformM Mod
forall a. Scope -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#extendScope"><span class="hs-identifier hs-var">extendScope</span></a></span><span>
</span><span id="line-207"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span><span>
</span><span id="line-208"></span><span>                </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521958"><span class="hs-identifier hs-var">abs_substs</span></a></span><span>
</span><span id="line-209"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Mod -&gt; Map VName Mod
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModParam -&gt; VName
forall (f :: * -&gt; *) vn. ModParamBase f vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#modParamName"><span class="hs-identifier hs-var hs-var">modParamName</span></a></span><span> </span><span class="annot"><span class="annottext">ModParam
</span><a href="#local-6989586621684521979"><span class="hs-identifier hs-var">f_p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Mod -&gt; Map VName Mod) -&gt; Mod -&gt; Map VName Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-210"></span><span>                    </span><span class="annot"><span class="annottext">Map VName VName -&gt; Mod -&gt; Mod
</span><a href="Futhark.Internalise.Defunctorise.html#substituteInMod"><span class="hs-identifier hs-var">substituteInMod</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521968"><span class="hs-identifier hs-var">p_substs'</span></a></span><span> </span><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521983"><span class="hs-identifier hs-var">arg_mod</span></a></span><span>
</span><span id="line-211"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-213"></span><span>            </span><span class="annot"><span class="annottext">(TransformM Mod -&gt; TransformM Mod)
-&gt; TransformM Mod -&gt; TransformM Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-214"></span><span>              </span><span id="local-6989586621684521954"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521954"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Map VName VName
</span><a href="Futhark.Internalise.Defunctorise.html#scopeSubsts"><span class="hs-identifier hs-var hs-var">scopeSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Map VName VName)
-&gt; TransformM Scope -&gt; TransformM (Map VName VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-215"></span><span>              </span><span id="local-6989586621684521953"><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521953"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ModExp -&gt; TransformM Mod
</span><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-var">evalModExp</span></a></span><span> </span><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521978"><span class="hs-identifier hs-var">f_body</span></a></span><span>
</span><span id="line-216"></span><span>              </span><span class="annot"><span class="annottext">Mod -&gt; TransformM Mod
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Mod -&gt; TransformM Mod) -&gt; Mod -&gt; TransformM Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-217"></span><span>                </span><span class="annot"><span class="annottext">TySet -&gt; Map VName VName -&gt; Mod -&gt; Mod
</span><a href="#local-6989586621684521952"><span class="hs-identifier hs-var">addSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684521973"><span class="hs-identifier hs-var">abs</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521958"><span class="hs-identifier hs-var">abs_substs</span></a></span><span> </span><span class="annot"><span class="annottext">(Mod -&gt; Mod) -&gt; Mod -&gt; Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-218"></span><span>                  </span><span class="hs-comment">-- The next one is dubious, but is necessary to</span><span>
</span><span id="line-219"></span><span>                  </span><span class="hs-comment">-- propagate substitutions from the argument (see</span><span>
</span><span id="line-220"></span><span>                  </span><span class="hs-comment">-- modules/functor24.fut).</span><span>
</span><span id="line-221"></span><span>                  </span><span class="annot"><span class="annottext">Map VName VName -&gt; Mod -&gt; Mod
</span><a href="#local-6989586621684521951"><span class="hs-identifier hs-var">addSubstsModMod</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; Map VName VName
</span><a href="Futhark.Internalise.Defunctorise.html#scopeSubsts"><span class="hs-identifier hs-var hs-var">scopeSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Map VName VName) -&gt; Scope -&gt; Map VName VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#modScope"><span class="hs-identifier hs-var">modScope</span></a></span><span> </span><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521983"><span class="hs-identifier hs-var">arg_mod</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Mod -&gt; Mod) -&gt; Mod -&gt; Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-222"></span><span>                    </span><span class="annot"><span class="annottext">Map VName VName -&gt; Mod -&gt; Mod
</span><a href="Futhark.Internalise.Defunctorise.html#substituteInMod"><span class="hs-identifier hs-var">substituteInMod</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521986"><span class="hs-identifier hs-var">b_substs</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName VName -&gt; Map VName VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521954"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521953"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-224"></span><span>    </span><span id="local-6989586621684521952"><span class="annot"><span class="annottext">addSubsts :: TySet -&gt; Map VName VName -&gt; Mod -&gt; Mod
</span><a href="#local-6989586621684521952"><span class="hs-identifier hs-var hs-var">addSubsts</span></a></span></span><span> </span><span id="local-6989586621684521946"><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684521946"><span class="hs-identifier hs-var">abs</span></a></span></span><span> </span><span id="local-6989586621684521945"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521945"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#ModFun"><span class="hs-identifier hs-type">ModFun</span></a></span><span> </span><span id="local-6989586621684521944"><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684521944"><span class="hs-identifier hs-var">mabs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span id="local-6989586621684521943"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521943"><span class="hs-identifier hs-var">msubsts</span></a></span></span><span> </span><span id="local-6989586621684521942"><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684521942"><span class="hs-identifier hs-var">mods</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684521941"><span class="annot"><span class="annottext">ModParam
</span><a href="#local-6989586621684521941"><span class="hs-identifier hs-var">mp</span></a></span></span><span> </span><span id="local-6989586621684521940"><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521940"><span class="hs-identifier hs-var">me</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-225"></span><span>      </span><span class="annot"><span class="annottext">TySet -&gt; Scope -&gt; ModParam -&gt; ModExp -&gt; Mod
</span><a href="Futhark.Internalise.Defunctorise.html#ModFun"><span class="hs-identifier hs-var">ModFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684521946"><span class="hs-identifier hs-var">abs</span></a></span><span> </span><span class="annot"><span class="annottext">TySet -&gt; TySet -&gt; TySet
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684521944"><span class="hs-identifier hs-var">mabs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521945"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName VName -&gt; Map VName VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521943"><span class="hs-identifier hs-var">msubsts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684521942"><span class="hs-identifier hs-var">mods</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ModParam
</span><a href="#local-6989586621684521941"><span class="hs-identifier hs-var">mp</span></a></span><span> </span><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521940"><span class="hs-identifier hs-var">me</span></a></span><span>
</span><span id="line-226"></span><span>    </span><span class="annot"><a href="#local-6989586621684521952"><span class="hs-identifier hs-var">addSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">TySet
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684521939"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521939"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#ModMod"><span class="hs-identifier hs-type">ModMod</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span id="local-6989586621684521938"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521938"><span class="hs-identifier hs-var">msubsts</span></a></span></span><span> </span><span id="local-6989586621684521937"><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684521937"><span class="hs-identifier hs-var">mods</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-227"></span><span>      </span><span class="annot"><span class="annottext">Scope -&gt; Mod
</span><a href="Futhark.Internalise.Defunctorise.html#ModMod"><span class="hs-identifier hs-var">ModMod</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Mod) -&gt; Scope -&gt; Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521939"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName VName -&gt; Map VName VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521938"><span class="hs-identifier hs-var">msubsts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684521937"><span class="hs-identifier hs-var">mods</span></a></span><span>
</span><span id="line-228"></span><span>    </span><span id="local-6989586621684521951"><span class="annot"><span class="annottext">addSubstsModMod :: Map VName VName -&gt; Mod -&gt; Mod
</span><a href="#local-6989586621684521951"><span class="hs-identifier hs-var hs-var">addSubstsModMod</span></a></span></span><span> </span><span id="local-6989586621684521934"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521934"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#ModMod"><span class="hs-identifier hs-type">ModMod</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span id="local-6989586621684521933"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521933"><span class="hs-identifier hs-var">msubsts</span></a></span></span><span> </span><span id="local-6989586621684521932"><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684521932"><span class="hs-identifier hs-var">mods</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-229"></span><span>      </span><span class="annot"><span class="annottext">Scope -&gt; Mod
</span><a href="Futhark.Internalise.Defunctorise.html#ModMod"><span class="hs-identifier hs-var">ModMod</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Mod) -&gt; Scope -&gt; Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521934"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName VName -&gt; Map VName VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684521933"><span class="hs-identifier hs-var">msubsts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName Mod
</span><a href="#local-6989586621684521932"><span class="hs-identifier hs-var">mods</span></a></span><span>
</span><span id="line-230"></span><span>    </span><span class="annot"><a href="#local-6989586621684521951"><span class="hs-identifier hs-var">addSubstsModMod</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684521931"><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521931"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521931"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-231"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-var">evalModExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ModLambda"><span class="hs-identifier hs-type">ModLambda</span></a></span><span> </span><span id="local-6989586621684521929"><span class="annot"><span class="annottext">ModParam
</span><a href="#local-6989586621684521929"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684521928"><span class="annot"><span class="annottext">Maybe (SigExp, Info (Map VName VName))
</span><a href="#local-6989586621684521928"><span class="hs-identifier hs-var">ascript</span></a></span></span><span> </span><span id="local-6989586621684521927"><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521927"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684521926"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684521926"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-232"></span><span>  </span><span id="local-6989586621684521925"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521925"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-233"></span><span>  </span><span id="local-6989586621684521924"><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684521924"><span class="hs-identifier hs-var">abs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env -&gt; TySet) -&gt; TransformM TySet
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; TySet
</span><a href="Futhark.Internalise.Defunctorise.html#envAbs"><span class="hs-identifier hs-var hs-var">envAbs</span></a></span><span>
</span><span id="line-234"></span><span>  </span><span class="annot"><span class="annottext">Mod -&gt; TransformM Mod
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Mod -&gt; TransformM Mod) -&gt; Mod -&gt; TransformM Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TySet -&gt; Scope -&gt; ModParam -&gt; ModExp -&gt; Mod
</span><a href="Futhark.Internalise.Defunctorise.html#ModFun"><span class="hs-identifier hs-var">ModFun</span></a></span><span> </span><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684521924"><span class="hs-identifier hs-var">abs</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521925"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">ModParam
</span><a href="#local-6989586621684521929"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">(ModExp -&gt; Mod) -&gt; ModExp -&gt; Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
-&gt; Maybe (SigExp, Info (Map VName VName)) -&gt; ModExp -&gt; ModExp
</span><a href="Futhark.Internalise.Defunctorise.html#maybeAscript"><span class="hs-identifier hs-var">maybeAscript</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684521926"><span class="hs-identifier hs-var">loc</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SigExp, Info (Map VName VName))
</span><a href="#local-6989586621684521928"><span class="hs-identifier hs-var">ascript</span></a></span><span> </span><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521927"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#transformName"><span class="hs-identifier hs-type">transformName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-237"></span><span id="transformName"><span class="annot"><span class="annottext">transformName :: VName -&gt; TransformM VName
</span><a href="Futhark.Internalise.Defunctorise.html#transformName"><span class="hs-identifier hs-var hs-var">transformName</span></a></span></span><span> </span><span id="local-6989586621684521922"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521922"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName VName -&gt; VName
</span><a href="Futhark.Internalise.Defunctorise.html#lookupSubst"><span class="hs-identifier hs-var">lookupSubst</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521922"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName VName -&gt; VName)
-&gt; (Scope -&gt; Map VName VName) -&gt; Scope -&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Map VName VName
</span><a href="Futhark.Internalise.Defunctorise.html#scopeSubsts"><span class="hs-identifier hs-var hs-var">scopeSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; VName) -&gt; TransformM Scope -&gt; TransformM VName
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-238"></span><span>
</span><span id="line-239"></span><span class="hs-comment">-- | A general-purpose substitution of names.</span><span>
</span><span id="line-240"></span><span id="local-6989586621684522592"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#transformNames"><span class="hs-identifier hs-type">transformNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Traversals.html#ASTMappable"><span class="hs-identifier hs-type">ASTMappable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522592"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684522592"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522592"><span class="hs-identifier hs-type">x</span></a></span></span><span>
</span><span id="line-241"></span><span id="transformNames"><span class="annot"><span class="annottext">transformNames :: forall x. ASTMappable x =&gt; x -&gt; TransformM x
</span><a href="Futhark.Internalise.Defunctorise.html#transformNames"><span class="hs-identifier hs-var hs-var">transformNames</span></a></span></span><span> </span><span id="local-6989586621684521914"><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621684521914"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-242"></span><span>  </span><span id="local-6989586621684521913"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521913"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-243"></span><span>  </span><span class="annot"><span class="annottext">x -&gt; TransformM x
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(x -&gt; TransformM x) -&gt; x -&gt; TransformM x
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Identity x -&gt; x
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity x -&gt; x) -&gt; Identity x -&gt; x
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ASTMapper Identity -&gt; x -&gt; Identity x
forall x (m :: * -&gt; *).
(ASTMappable x, Monad m) =&gt;
ASTMapper m -&gt; x -&gt; m x
</span><a href="Language.Futhark.Traversals.html#astMap"><span class="hs-identifier hs-var">astMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; ASTMapper Identity
forall {m :: * -&gt; *}. Monad m =&gt; Scope -&gt; ASTMapper m
</span><a href="#local-6989586621684521910"><span class="hs-identifier hs-var">substituter</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521913"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">x
</span><a href="#local-6989586621684521914"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-245"></span><span>    </span><span id="local-6989586621684521910"><span class="annot"><span class="annottext">substituter :: Scope -&gt; ASTMapper m
</span><a href="#local-6989586621684521910"><span class="hs-identifier hs-var hs-var">substituter</span></a></span></span><span> </span><span id="local-6989586621684521888"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521888"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-246"></span><span>      </span><span class="annot"><span class="annottext">ASTMapper :: forall (m :: * -&gt; *).
(Exp -&gt; m Exp)
-&gt; (VName -&gt; m VName)
-&gt; (QualName VName -&gt; m (QualName VName))
-&gt; (StructType -&gt; m StructType)
-&gt; (PatType -&gt; m PatType)
-&gt; (StructRetType -&gt; m StructRetType)
-&gt; (PatRetType -&gt; m PatRetType)
-&gt; ASTMapper m
</span><a href="Language.Futhark.Traversals.html#ASTMapper"><span class="hs-identifier hs-type">ASTMapper</span></a></span><span>
</span><span id="line-247"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnExp :: Exp -&gt; m Exp
</span><a href="Language.Futhark.Traversals.html#mapOnExp"><span class="hs-identifier hs-var">mapOnExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Exp -&gt; m Exp
</span><a href="#local-6989586621684521885"><span class="hs-identifier hs-var">onExp</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521888"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-248"></span><span>          </span><span class="annot"><span class="annottext">mapOnName :: VName -&gt; m VName
</span><a href="Language.Futhark.Traversals.html#mapOnName"><span class="hs-identifier hs-var">mapOnName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684521883"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521883"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-249"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; m VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; m VName) -&gt; VName -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; VName) -&gt; QualName VName -&gt; VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(QualName VName, Scope) -&gt; QualName VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((QualName VName, Scope) -&gt; QualName VName)
-&gt; (QualName VName, Scope) -&gt; QualName VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; Scope -&gt; (QualName VName, Scope)
</span><a href="Futhark.Internalise.Defunctorise.html#lookupSubstInScope"><span class="hs-identifier hs-var">lookupSubstInScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521883"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521888"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-250"></span><span>          </span><span class="annot"><span class="annottext">mapOnQualName :: QualName VName -&gt; m (QualName VName)
</span><a href="Language.Futhark.Traversals.html#mapOnQualName"><span class="hs-identifier hs-var">mapOnQualName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684521881"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684521881"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-251"></span><span>            </span><span class="annot"><span class="annottext">QualName VName -&gt; m (QualName VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; m (QualName VName))
-&gt; QualName VName -&gt; m (QualName VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(QualName VName, Scope) -&gt; QualName VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((QualName VName, Scope) -&gt; QualName VName)
-&gt; (QualName VName, Scope) -&gt; QualName VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; Scope -&gt; (QualName VName, Scope)
</span><a href="Futhark.Internalise.Defunctorise.html#lookupSubstInScope"><span class="hs-identifier hs-var">lookupSubstInScope</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684521881"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521888"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-252"></span><span>          </span><span class="annot"><span class="annottext">mapOnStructType :: StructType -&gt; m StructType
</span><a href="Language.Futhark.Traversals.html#mapOnStructType"><span class="hs-identifier hs-var">mapOnStructType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ASTMapper m -&gt; StructType -&gt; m StructType
forall x (m :: * -&gt; *).
(ASTMappable x, Monad m) =&gt;
ASTMapper m -&gt; x -&gt; m x
</span><a href="Language.Futhark.Traversals.html#astMap"><span class="hs-identifier hs-var">astMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; ASTMapper m
</span><a href="#local-6989586621684521910"><span class="hs-identifier hs-var">substituter</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521888"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-253"></span><span>          </span><span class="annot"><span class="annottext">mapOnPatType :: PatType -&gt; m PatType
</span><a href="Language.Futhark.Traversals.html#mapOnPatType"><span class="hs-identifier hs-var">mapOnPatType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ASTMapper m -&gt; PatType -&gt; m PatType
forall x (m :: * -&gt; *).
(ASTMappable x, Monad m) =&gt;
ASTMapper m -&gt; x -&gt; m x
</span><a href="Language.Futhark.Traversals.html#astMap"><span class="hs-identifier hs-var">astMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; ASTMapper m
</span><a href="#local-6989586621684521910"><span class="hs-identifier hs-var">substituter</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521888"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-254"></span><span>          </span><span class="annot"><span class="annottext">mapOnStructRetType :: StructRetType -&gt; m StructRetType
</span><a href="Language.Futhark.Traversals.html#mapOnStructRetType"><span class="hs-identifier hs-var">mapOnStructRetType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ASTMapper m -&gt; StructRetType -&gt; m StructRetType
forall x (m :: * -&gt; *).
(ASTMappable x, Monad m) =&gt;
ASTMapper m -&gt; x -&gt; m x
</span><a href="Language.Futhark.Traversals.html#astMap"><span class="hs-identifier hs-var">astMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; ASTMapper m
</span><a href="#local-6989586621684521910"><span class="hs-identifier hs-var">substituter</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521888"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-255"></span><span>          </span><span class="annot"><span class="annottext">mapOnPatRetType :: PatRetType -&gt; m PatRetType
</span><a href="Language.Futhark.Traversals.html#mapOnPatRetType"><span class="hs-identifier hs-var">mapOnPatRetType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ASTMapper m -&gt; PatRetType -&gt; m PatRetType
forall x (m :: * -&gt; *).
(ASTMappable x, Monad m) =&gt;
ASTMapper m -&gt; x -&gt; m x
</span><a href="Language.Futhark.Traversals.html#astMap"><span class="hs-identifier hs-var">astMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; ASTMapper m
</span><a href="#local-6989586621684521910"><span class="hs-identifier hs-var">substituter</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521888"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-256"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-257"></span><span>    </span><span id="local-6989586621684521885"><span class="annot"><span class="annottext">onExp :: Scope -&gt; Exp -&gt; m Exp
</span><a href="#local-6989586621684521885"><span class="hs-identifier hs-var hs-var">onExp</span></a></span></span><span> </span><span id="local-6989586621684521876"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521876"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621684521875"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684521875"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-258"></span><span>      </span><span class="hs-comment">-- One expression is tricky, because it interacts with scoping rules.</span><span>
</span><span id="line-259"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684521875"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-260"></span><span>        </span><span class="annot"><a href="Language.Futhark.Syntax.html#QualParens"><span class="hs-identifier hs-type">QualParens</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684521873"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684521873"><span class="hs-identifier hs-var">mn</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684521872"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684521872"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-261"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; Scope -&gt; Either String Mod
</span><a href="Futhark.Internalise.Defunctorise.html#lookupMod%27"><span class="hs-identifier hs-var">lookupMod'</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684521873"><span class="hs-identifier hs-var">mn</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521876"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-262"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621684521871"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684521871"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m Exp
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684521871"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-263"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621684521870"><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521870"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-264"></span><span>              </span><span class="annot"><span class="annottext">ASTMapper m -&gt; Exp -&gt; m Exp
forall x (m :: * -&gt; *).
(ASTMappable x, Monad m) =&gt;
ASTMapper m -&gt; x -&gt; m x
</span><a href="Language.Futhark.Traversals.html#astMap"><span class="hs-identifier hs-var">astMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; ASTMapper m
</span><a href="#local-6989586621684521910"><span class="hs-identifier hs-var">substituter</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; ASTMapper m) -&gt; Scope -&gt; ASTMapper m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#modScope"><span class="hs-identifier hs-var">modScope</span></a></span><span> </span><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521870"><span class="hs-identifier hs-var">mod</span></a></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Scope -&gt; Scope
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521876"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684521872"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-265"></span><span>        </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">ASTMapper m -&gt; Exp -&gt; m Exp
forall x (m :: * -&gt; *).
(ASTMappable x, Monad m) =&gt;
ASTMapper m -&gt; x -&gt; m x
</span><a href="Language.Futhark.Traversals.html#astMap"><span class="hs-identifier hs-var">astMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; ASTMapper m
</span><a href="#local-6989586621684521910"><span class="hs-identifier hs-var">substituter</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521876"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684521875"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-266"></span><span>
</span><span id="line-267"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#transformTypeExp"><span class="hs-identifier hs-type">transformTypeExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeExp"><span class="hs-identifier hs-type">TypeExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeExp"><span class="hs-identifier hs-type">TypeExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span id="transformTypeExp"><span class="annot"><span class="annottext">transformTypeExp :: TypeExp VName -&gt; TransformM (TypeExp VName)
</span><a href="Futhark.Internalise.Defunctorise.html#transformTypeExp"><span class="hs-identifier hs-var hs-var">transformTypeExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeExp VName -&gt; TransformM (TypeExp VName)
forall x. ASTMappable x =&gt; x -&gt; TransformM x
</span><a href="Futhark.Internalise.Defunctorise.html#transformNames"><span class="hs-identifier hs-var">transformNames</span></a></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#transformStructType"><span class="hs-identifier hs-type">transformStructType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span>
</span><span id="line-271"></span><span id="transformStructType"><span class="annot"><span class="annottext">transformStructType :: StructType -&gt; TransformM StructType
</span><a href="Futhark.Internalise.Defunctorise.html#transformStructType"><span class="hs-identifier hs-var hs-var">transformStructType</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StructType -&gt; TransformM StructType
forall x. ASTMappable x =&gt; x -&gt; TransformM x
</span><a href="Futhark.Internalise.Defunctorise.html#transformNames"><span class="hs-identifier hs-var">transformNames</span></a></span><span>
</span><span id="line-272"></span><span>
</span><span id="line-273"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#transformExp"><span class="hs-identifier hs-type">transformExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span>
</span><span id="line-274"></span><span id="transformExp"><span class="annot"><span class="annottext">transformExp :: Exp -&gt; TransformM Exp
</span><a href="Futhark.Internalise.Defunctorise.html#transformExp"><span class="hs-identifier hs-var hs-var">transformExp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TransformM Exp
forall x. ASTMappable x =&gt; x -&gt; TransformM x
</span><a href="Futhark.Internalise.Defunctorise.html#transformNames"><span class="hs-identifier hs-var">transformNames</span></a></span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#transformValBind"><span class="hs-identifier hs-type">transformValBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#ValBind"><span class="hs-identifier hs-type">ValBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-277"></span><span id="transformValBind"><span class="annot"><span class="annottext">transformValBind :: ValBind -&gt; TransformM ()
</span><a href="Futhark.Internalise.Defunctorise.html#transformValBind"><span class="hs-identifier hs-var hs-var">transformValBind</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ValBind"><span class="hs-identifier hs-type">ValBind</span></a></span><span> </span><span id="local-6989586621684521864"><span class="annot"><span class="annottext">Maybe (Info EntryPoint)
</span><a href="#local-6989586621684521864"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span id="local-6989586621684521863"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521863"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684521862"><span class="annot"><span class="annottext">Maybe (TypeExp VName)
</span><a href="#local-6989586621684521862"><span class="hs-identifier hs-var">tdecl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684521860"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684521860"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684521859"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684521859"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684521858"><span class="annot"><span class="annottext">[TypeParamBase VName]
</span><a href="#local-6989586621684521858"><span class="hs-identifier hs-var">tparams</span></a></span></span><span> </span><span id="local-6989586621684521857"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684521857"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684521856"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684521856"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684521855"><span class="annot"><span class="annottext">Maybe DocComment
</span><a href="#local-6989586621684521855"><span class="hs-identifier hs-var">doc</span></a></span></span><span> </span><span id="local-6989586621684521854"><span class="annot"><span class="annottext">[AttrInfo VName]
</span><a href="#local-6989586621684521854"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684521853"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684521853"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-278"></span><span>  </span><span id="local-6989586621684521852"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521852"><span class="hs-identifier hs-var">name'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TransformM VName
</span><a href="Futhark.Internalise.Defunctorise.html#transformName"><span class="hs-identifier hs-var">transformName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521863"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-279"></span><span>  </span><span id="local-6989586621684521851"><span class="annot"><span class="annottext">Maybe (TypeExp VName)
</span><a href="#local-6989586621684521851"><span class="hs-identifier hs-var">tdecl'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TypeExp VName -&gt; TransformM (TypeExp VName))
-&gt; Maybe (TypeExp VName) -&gt; TransformM (Maybe (TypeExp VName))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">TypeExp VName -&gt; TransformM (TypeExp VName)
</span><a href="Futhark.Internalise.Defunctorise.html#transformTypeExp"><span class="hs-identifier hs-var">transformTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TypeExp VName)
</span><a href="#local-6989586621684521862"><span class="hs-identifier hs-var">tdecl</span></a></span><span>
</span><span id="line-280"></span><span>  </span><span id="local-6989586621684521849"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684521849"><span class="hs-identifier hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StructType -&gt; TransformM StructType
</span><a href="Futhark.Internalise.Defunctorise.html#transformStructType"><span class="hs-identifier hs-var">transformStructType</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684521859"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-281"></span><span>  </span><span id="local-6989586621684521848"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684521848"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; TransformM Exp
</span><a href="Futhark.Internalise.Defunctorise.html#transformExp"><span class="hs-identifier hs-var">transformExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684521856"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-282"></span><span>  </span><span id="local-6989586621684521847"><span class="annot"><span class="annottext">[TypeParamBase VName]
</span><a href="#local-6989586621684521847"><span class="hs-identifier hs-var">tparams'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TypeParamBase VName -&gt; TransformM (TypeParamBase VName))
-&gt; [TypeParamBase VName] -&gt; TransformM [TypeParamBase VName]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">TypeParamBase VName -&gt; TransformM (TypeParamBase VName)
forall x. ASTMappable x =&gt; x -&gt; TransformM x
</span><a href="Futhark.Internalise.Defunctorise.html#transformNames"><span class="hs-identifier hs-var">transformNames</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParamBase VName]
</span><a href="#local-6989586621684521858"><span class="hs-identifier hs-var">tparams</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span id="local-6989586621684521846"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684521846"><span class="hs-identifier hs-var">params'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; TransformM (PatBase Info VName))
-&gt; [PatBase Info VName] -&gt; TransformM [PatBase Info VName]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; TransformM (PatBase Info VName)
forall x. ASTMappable x =&gt; x -&gt; TransformM x
</span><a href="Futhark.Internalise.Defunctorise.html#transformNames"><span class="hs-identifier hs-var">transformNames</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684521857"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-284"></span><span>  </span><span class="annot"><span class="annottext">Dec -&gt; TransformM ()
</span><a href="Futhark.Internalise.Defunctorise.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Dec -&gt; TransformM ()) -&gt; Dec -&gt; TransformM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ValBind -&gt; Dec
forall (f :: * -&gt; *) vn. ValBindBase f vn -&gt; DecBase f vn
</span><a href="Language.Futhark.Syntax.html#ValDec"><span class="hs-identifier hs-var">ValDec</span></a></span><span> </span><span class="annot"><span class="annottext">(ValBind -&gt; Dec) -&gt; ValBind -&gt; Dec
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Info EntryPoint)
-&gt; VName
-&gt; Maybe (TypeExp VName)
-&gt; Info StructRetType
-&gt; [TypeParamBase VName]
-&gt; [PatBase Info VName]
-&gt; Exp
-&gt; Maybe DocComment
-&gt; [AttrInfo VName]
-&gt; SrcLoc
-&gt; ValBind
forall (f :: * -&gt; *) vn.
Maybe (f EntryPoint)
-&gt; vn
-&gt; Maybe (TypeExp vn)
-&gt; f StructRetType
-&gt; [TypeParamBase vn]
-&gt; [PatBase f vn]
-&gt; ExpBase f vn
-&gt; Maybe DocComment
-&gt; [AttrInfo vn]
-&gt; SrcLoc
-&gt; ValBindBase f vn
</span><a href="Language.Futhark.Syntax.html#ValBind"><span class="hs-identifier hs-var">ValBind</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Info EntryPoint)
</span><a href="#local-6989586621684521864"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521852"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TypeExp VName)
</span><a href="#local-6989586621684521851"><span class="hs-identifier hs-var">tdecl'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructRetType -&gt; Info StructRetType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684521860"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684521849"><span class="hs-identifier hs-var">t'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TypeParamBase VName]
</span><a href="#local-6989586621684521847"><span class="hs-identifier hs-var">tparams'</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684521846"><span class="hs-identifier hs-var">params'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684521848"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe DocComment
</span><a href="#local-6989586621684521855"><span class="hs-identifier hs-var">doc</span></a></span><span> </span><span class="annot"><span class="annottext">[AttrInfo VName]
</span><a href="#local-6989586621684521854"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684521853"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#transformTypeBind"><span class="hs-identifier hs-type">transformTypeBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#TypeBind"><span class="hs-identifier hs-type">TypeBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-287"></span><span id="transformTypeBind"><span class="annot"><span class="annottext">transformTypeBind :: TypeBind -&gt; TransformM ()
</span><a href="Futhark.Internalise.Defunctorise.html#transformTypeBind"><span class="hs-identifier hs-var hs-var">transformTypeBind</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBind"><span class="hs-identifier hs-type">TypeBind</span></a></span><span> </span><span id="local-6989586621684521842"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521842"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684521841"><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684521841"><span class="hs-identifier hs-var">l</span></a></span></span><span> </span><span id="local-6989586621684521840"><span class="annot"><span class="annottext">[TypeParamBase VName]
</span><a href="#local-6989586621684521840"><span class="hs-identifier hs-var">tparams</span></a></span></span><span> </span><span id="local-6989586621684521839"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684521839"><span class="hs-identifier hs-var">te</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684521838"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684521838"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684521837"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684521837"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684521836"><span class="annot"><span class="annottext">Maybe DocComment
</span><a href="#local-6989586621684521836"><span class="hs-identifier hs-var">doc</span></a></span></span><span> </span><span id="local-6989586621684521835"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684521835"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-288"></span><span>  </span><span id="local-6989586621684521834"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521834"><span class="hs-identifier hs-var">name'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TransformM VName
</span><a href="Futhark.Internalise.Defunctorise.html#transformName"><span class="hs-identifier hs-var">transformName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521842"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-289"></span><span>  </span><span class="annot"><span class="annottext">Dec -&gt; TransformM ()
</span><a href="Futhark.Internalise.Defunctorise.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Dec -&gt; TransformM ())
-&gt; (TypeBind -&gt; Dec) -&gt; TypeBind -&gt; TransformM ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TypeBind -&gt; Dec
forall (f :: * -&gt; *) vn. TypeBindBase f vn -&gt; DecBase f vn
</span><a href="Language.Futhark.Syntax.html#TypeDec"><span class="hs-identifier hs-var">TypeDec</span></a></span><span>
</span><span id="line-290"></span><span>    </span><span class="annot"><span class="annottext">(TypeBind -&gt; TransformM ()) -&gt; TransformM TypeBind -&gt; TransformM ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; Liftedness
-&gt; [TypeParamBase VName]
-&gt; TypeExp VName
-&gt; Info StructRetType
-&gt; Maybe DocComment
-&gt; SrcLoc
-&gt; TypeBind
forall (f :: * -&gt; *) vn.
vn
-&gt; Liftedness
-&gt; [TypeParamBase vn]
-&gt; TypeExp vn
-&gt; f StructRetType
-&gt; Maybe DocComment
-&gt; SrcLoc
-&gt; TypeBindBase f vn
</span><a href="Language.Futhark.Syntax.html#TypeBind"><span class="hs-identifier hs-var">TypeBind</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521834"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">Liftedness
</span><a href="#local-6989586621684521841"><span class="hs-identifier hs-var">l</span></a></span><span> </span><span class="annot"><span class="annottext">([TypeParamBase VName]
 -&gt; TypeExp VName
 -&gt; Info StructRetType
 -&gt; Maybe DocComment
 -&gt; SrcLoc
 -&gt; TypeBind)
-&gt; TransformM [TypeParamBase VName]
-&gt; TransformM
     (TypeExp VName
      -&gt; Info StructRetType -&gt; Maybe DocComment -&gt; SrcLoc -&gt; TypeBind)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(TypeParamBase VName -&gt; TransformM (TypeParamBase VName))
-&gt; [TypeParamBase VName] -&gt; TransformM [TypeParamBase VName]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">TypeParamBase VName -&gt; TransformM (TypeParamBase VName)
forall x. ASTMappable x =&gt; x -&gt; TransformM x
</span><a href="Futhark.Internalise.Defunctorise.html#transformNames"><span class="hs-identifier hs-var">transformNames</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParamBase VName]
</span><a href="#local-6989586621684521840"><span class="hs-identifier hs-var">tparams</span></a></span><span>
</span><span id="line-291"></span><span>            </span><span class="annot"><span class="annottext">TransformM
  (TypeExp VName
   -&gt; Info StructRetType -&gt; Maybe DocComment -&gt; SrcLoc -&gt; TypeBind)
-&gt; TransformM (TypeExp VName)
-&gt; TransformM
     (Info StructRetType -&gt; Maybe DocComment -&gt; SrcLoc -&gt; TypeBind)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypeExp VName -&gt; TransformM (TypeExp VName)
</span><a href="Futhark.Internalise.Defunctorise.html#transformTypeExp"><span class="hs-identifier hs-var">transformTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684521839"><span class="hs-identifier hs-var">te</span></a></span><span>
</span><span id="line-292"></span><span>            </span><span class="annot"><span class="annottext">TransformM
  (Info StructRetType -&gt; Maybe DocComment -&gt; SrcLoc -&gt; TypeBind)
-&gt; TransformM (Info StructRetType)
-&gt; TransformM (Maybe DocComment -&gt; SrcLoc -&gt; TypeBind)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructRetType -&gt; Info StructRetType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">(StructRetType -&gt; Info StructRetType)
-&gt; (StructType -&gt; StructRetType)
-&gt; StructType
-&gt; Info StructRetType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684521838"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; Info StructRetType)
-&gt; TransformM StructType -&gt; TransformM (Info StructRetType)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; TransformM StructType
</span><a href="Futhark.Internalise.Defunctorise.html#transformStructType"><span class="hs-identifier hs-var">transformStructType</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684521837"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-293"></span><span>            </span><span class="annot"><span class="annottext">TransformM (Maybe DocComment -&gt; SrcLoc -&gt; TypeBind)
-&gt; TransformM (Maybe DocComment) -&gt; TransformM (SrcLoc -&gt; TypeBind)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe DocComment -&gt; TransformM (Maybe DocComment)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe DocComment
</span><a href="#local-6989586621684521836"><span class="hs-identifier hs-var">doc</span></a></span><span>
</span><span id="line-294"></span><span>            </span><span class="annot"><span class="annottext">TransformM (SrcLoc -&gt; TypeBind)
-&gt; TransformM SrcLoc -&gt; TransformM TypeBind
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; TransformM SrcLoc
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684521835"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-295"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#transformModBind"><span class="hs-identifier hs-type">transformModBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#ModBind"><span class="hs-identifier hs-type">ModBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span>
</span><span id="line-298"></span><span id="transformModBind"><span class="annot"><span class="annottext">transformModBind :: ModBind -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#transformModBind"><span class="hs-identifier hs-var hs-var">transformModBind</span></a></span></span><span> </span><span id="local-6989586621684521831"><span class="annot"><span class="annottext">ModBind
</span><a href="#local-6989586621684521831"><span class="hs-identifier hs-var">mb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-299"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684521828"><span class="annot"><span class="annottext">addParam :: ModParamBase f vn -&gt; ModExpBase f vn -&gt; ModExpBase f vn
</span><a href="#local-6989586621684521828"><span class="hs-identifier hs-var hs-var">addParam</span></a></span></span><span> </span><span id="local-6989586621684521827"><span class="annot"><span class="annottext">ModParamBase f vn
</span><a href="#local-6989586621684521827"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684521826"><span class="annot"><span class="annottext">ModExpBase f vn
</span><a href="#local-6989586621684521826"><span class="hs-identifier hs-var">me</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ModParamBase f vn
-&gt; Maybe (SigExpBase f vn, f (Map VName VName))
-&gt; ModExpBase f vn
-&gt; SrcLoc
-&gt; ModExpBase f vn
forall (f :: * -&gt; *) vn.
ModParamBase f vn
-&gt; Maybe (SigExpBase f vn, f (Map VName VName))
-&gt; ModExpBase f vn
-&gt; SrcLoc
-&gt; ModExpBase f vn
</span><a href="Language.Futhark.Syntax.html#ModLambda"><span class="hs-identifier hs-var">ModLambda</span></a></span><span> </span><span class="annot"><span class="annottext">ModParamBase f vn
</span><a href="#local-6989586621684521827"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SigExpBase f vn, f (Map VName VName))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">ModExpBase f vn
</span><a href="#local-6989586621684521826"><span class="hs-identifier hs-var">me</span></a></span><span> </span><span class="annot"><span class="annottext">(SrcLoc -&gt; ModExpBase f vn) -&gt; SrcLoc -&gt; ModExpBase f vn
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ModExpBase f vn -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">ModExpBase f vn
</span><a href="#local-6989586621684521826"><span class="hs-identifier hs-var">me</span></a></span><span>
</span><span id="line-300"></span><span>  </span><span id="local-6989586621684521824"><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521824"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-301"></span><span>    </span><span class="annot"><span class="annottext">ModExp -&gt; TransformM Mod
</span><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-var">evalModExp</span></a></span><span> </span><span class="annot"><span class="annottext">(ModExp -&gt; TransformM Mod) -&gt; ModExp -&gt; TransformM Mod
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-302"></span><span>      </span><span class="annot"><span class="annottext">(ModParam -&gt; ModExp -&gt; ModExp) -&gt; ModExp -&gt; [ModParam] -&gt; ModExp
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span>
</span><span id="line-303"></span><span>        </span><span class="annot"><span class="annottext">ModParam -&gt; ModExp -&gt; ModExp
forall {f :: * -&gt; *} {vn}.
ModParamBase f vn -&gt; ModExpBase f vn -&gt; ModExpBase f vn
</span><a href="#local-6989586621684521828"><span class="hs-identifier hs-var">addParam</span></a></span><span>
</span><span id="line-304"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SrcLoc
-&gt; Maybe (SigExp, Info (Map VName VName)) -&gt; ModExp -&gt; ModExp
</span><a href="Futhark.Internalise.Defunctorise.html#maybeAscript"><span class="hs-identifier hs-var">maybeAscript</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModBind -&gt; SrcLoc
forall a. Located a =&gt; a -&gt; SrcLoc
</span><span class="hs-identifier hs-var">srclocOf</span></span><span> </span><span class="annot"><span class="annottext">ModBind
</span><a href="#local-6989586621684521831"><span class="hs-identifier hs-var">mb</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModBind -&gt; Maybe (SigExp, Info (Map VName VName))
forall (f :: * -&gt; *) vn.
ModBindBase f vn -&gt; Maybe (SigExpBase f vn, f (Map VName VName))
</span><a href="Language.Futhark.Syntax.html#modSignature"><span class="hs-identifier hs-var hs-var">modSignature</span></a></span><span> </span><span class="annot"><span class="annottext">ModBind
</span><a href="#local-6989586621684521831"><span class="hs-identifier hs-var">mb</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ModExp -&gt; ModExp) -&gt; ModExp -&gt; ModExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ModBind -&gt; ModExp
forall (f :: * -&gt; *) vn. ModBindBase f vn -&gt; ModExpBase f vn
</span><a href="Language.Futhark.Syntax.html#modExp"><span class="hs-identifier hs-var hs-var">modExp</span></a></span><span> </span><span class="annot"><span class="annottext">ModBind
</span><a href="#local-6989586621684521831"><span class="hs-identifier hs-var">mb</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>        </span><span class="annot"><span class="annottext">([ModParam] -&gt; ModExp) -&gt; [ModParam] -&gt; ModExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ModBind -&gt; [ModParam]
forall (f :: * -&gt; *) vn. ModBindBase f vn -&gt; [ModParamBase f vn]
</span><a href="Language.Futhark.Syntax.html#modParams"><span class="hs-identifier hs-var hs-var">modParams</span></a></span><span> </span><span class="annot"><span class="annottext">ModBind
</span><a href="#local-6989586621684521831"><span class="hs-identifier hs-var">mb</span></a></span><span>
</span><span id="line-306"></span><span>  </span><span id="local-6989586621684521819"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521819"><span class="hs-identifier hs-var">mname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TransformM VName
</span><a href="Futhark.Internalise.Defunctorise.html#transformName"><span class="hs-identifier hs-var">transformName</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TransformM VName) -&gt; VName -&gt; TransformM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ModBind -&gt; VName
forall (f :: * -&gt; *) vn. ModBindBase f vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#modName"><span class="hs-identifier hs-var hs-var">modName</span></a></span><span> </span><span class="annot"><span class="annottext">ModBind
</span><a href="#local-6989586621684521831"><span class="hs-identifier hs-var">mb</span></a></span><span>
</span><span id="line-307"></span><span>  </span><span class="annot"><span class="annottext">Scope -&gt; TransformM Scope
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; TransformM Scope) -&gt; Scope -&gt; TransformM Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; Map VName Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-var">Scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope -&gt; Map VName VName
</span><a href="Futhark.Internalise.Defunctorise.html#scopeSubsts"><span class="hs-identifier hs-var hs-var">scopeSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Map VName VName) -&gt; Scope -&gt; Map VName VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#modScope"><span class="hs-identifier hs-var">modScope</span></a></span><span> </span><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521824"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Map VName Mod -&gt; Scope) -&gt; Map VName Mod -&gt; Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Mod -&gt; Map VName Mod
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684521819"><span class="hs-identifier hs-var">mname</span></a></span><span> </span><span class="annot"><span class="annottext">Mod
</span><a href="#local-6989586621684521824"><span class="hs-identifier hs-var">mod</span></a></span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#transformDecs"><span class="hs-identifier hs-type">transformDecs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#Dec"><span class="hs-identifier hs-type">Dec</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span>
</span><span id="line-310"></span><span id="transformDecs"><span class="annot"><span class="annottext">transformDecs :: [Dec] -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#transformDecs"><span class="hs-identifier hs-var hs-var">transformDecs</span></a></span></span><span> </span><span id="local-6989586621684521817"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521817"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-311"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521817"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-312"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-313"></span><span>      </span><span class="annot"><span class="annottext">Scope -&gt; TransformM Scope
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Scope
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-314"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#LocalDec"><span class="hs-identifier hs-type">LocalDec</span></a></span><span> </span><span id="local-6989586621684521815"><span class="annot"><span class="annottext">Dec
</span><a href="#local-6989586621684521815"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684521814"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521814"><span class="hs-identifier hs-var">ds'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-315"></span><span>      </span><span class="annot"><span class="annottext">[Dec] -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#transformDecs"><span class="hs-identifier hs-var">transformDecs</span></a></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; TransformM Scope) -&gt; [Dec] -&gt; TransformM Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Dec
</span><a href="#local-6989586621684521815"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Dec -&gt; [Dec] -&gt; [Dec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521814"><span class="hs-identifier hs-var">ds'</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#ValDec"><span class="hs-identifier hs-type">ValDec</span></a></span><span> </span><span id="local-6989586621684521813"><span class="annot"><span class="annottext">ValBind
</span><a href="#local-6989586621684521813"><span class="hs-identifier hs-var">fdec</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684521812"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521812"><span class="hs-identifier hs-var">ds'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-317"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; TransformM Scope -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#bindingNames"><span class="hs-identifier hs-var">bindingNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ValBind -&gt; VName
forall (f :: * -&gt; *) vn. ValBindBase f vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#valBindName"><span class="hs-identifier hs-var hs-var">valBindName</span></a></span><span> </span><span class="annot"><span class="annottext">ValBind
</span><a href="#local-6989586621684521813"><span class="hs-identifier hs-var">fdec</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(TransformM Scope -&gt; TransformM Scope)
-&gt; TransformM Scope -&gt; TransformM Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-318"></span><span>        </span><span class="annot"><span class="annottext">ValBind -&gt; TransformM ()
</span><a href="Futhark.Internalise.Defunctorise.html#transformValBind"><span class="hs-identifier hs-var">transformValBind</span></a></span><span> </span><span class="annot"><span class="annottext">ValBind
</span><a href="#local-6989586621684521813"><span class="hs-identifier hs-var">fdec</span></a></span><span>
</span><span id="line-319"></span><span>        </span><span class="annot"><span class="annottext">[Dec] -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#transformDecs"><span class="hs-identifier hs-var">transformDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521812"><span class="hs-identifier hs-var">ds'</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeDec"><span class="hs-identifier hs-type">TypeDec</span></a></span><span> </span><span id="local-6989586621684521810"><span class="annot"><span class="annottext">TypeBind
</span><a href="#local-6989586621684521810"><span class="hs-identifier hs-var">tb</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684521809"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521809"><span class="hs-identifier hs-var">ds'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-321"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; TransformM Scope -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#bindingNames"><span class="hs-identifier hs-var">bindingNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TypeBind -&gt; VName
forall (f :: * -&gt; *) vn. TypeBindBase f vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#typeAlias"><span class="hs-identifier hs-var hs-var">typeAlias</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBind
</span><a href="#local-6989586621684521810"><span class="hs-identifier hs-var">tb</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(TransformM Scope -&gt; TransformM Scope)
-&gt; TransformM Scope -&gt; TransformM Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-322"></span><span>        </span><span class="annot"><span class="annottext">TypeBind -&gt; TransformM ()
</span><a href="Futhark.Internalise.Defunctorise.html#transformTypeBind"><span class="hs-identifier hs-var">transformTypeBind</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBind
</span><a href="#local-6989586621684521810"><span class="hs-identifier hs-var">tb</span></a></span><span>
</span><span id="line-323"></span><span>        </span><span class="annot"><span class="annottext">[Dec] -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#transformDecs"><span class="hs-identifier hs-var">transformDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521809"><span class="hs-identifier hs-var">ds'</span></a></span><span>
</span><span id="line-324"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#SigDec"><span class="hs-identifier hs-type">SigDec</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684521806"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521806"><span class="hs-identifier hs-var">ds'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-325"></span><span>      </span><span class="annot"><span class="annottext">[Dec] -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#transformDecs"><span class="hs-identifier hs-var">transformDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521806"><span class="hs-identifier hs-var">ds'</span></a></span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#ModDec"><span class="hs-identifier hs-type">ModDec</span></a></span><span> </span><span id="local-6989586621684521804"><span class="annot"><span class="annottext">ModBind
</span><a href="#local-6989586621684521804"><span class="hs-identifier hs-var">mb</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684521803"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521803"><span class="hs-identifier hs-var">ds'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-327"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; TransformM Scope -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#bindingNames"><span class="hs-identifier hs-var">bindingNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">ModBind -&gt; VName
forall (f :: * -&gt; *) vn. ModBindBase f vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#modName"><span class="hs-identifier hs-var hs-var">modName</span></a></span><span> </span><span class="annot"><span class="annottext">ModBind
</span><a href="#local-6989586621684521804"><span class="hs-identifier hs-var">mb</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(TransformM Scope -&gt; TransformM Scope)
-&gt; TransformM Scope -&gt; TransformM Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>        </span><span id="local-6989586621684521802"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521802"><span class="hs-identifier hs-var">mod_scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ModBind -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#transformModBind"><span class="hs-identifier hs-var">transformModBind</span></a></span><span> </span><span class="annot"><span class="annottext">ModBind
</span><a href="#local-6989586621684521804"><span class="hs-identifier hs-var">mb</span></a></span><span>
</span><span id="line-329"></span><span>        </span><span class="annot"><span class="annottext">Scope -&gt; TransformM Scope -&gt; TransformM Scope
forall a. Scope -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#extendScope"><span class="hs-identifier hs-var">extendScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521802"><span class="hs-identifier hs-var">mod_scope</span></a></span><span> </span><span class="annot"><span class="annottext">(TransformM Scope -&gt; TransformM Scope)
-&gt; TransformM Scope -&gt; TransformM Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Scope -&gt; Scope
forall a. Monoid a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">mappend</span></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Scope -&gt; Scope)
-&gt; TransformM Scope -&gt; TransformM (Scope -&gt; Scope)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#transformDecs"><span class="hs-identifier hs-var">transformDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521803"><span class="hs-identifier hs-var">ds'</span></a></span><span> </span><span class="annot"><span class="annottext">TransformM (Scope -&gt; Scope) -&gt; TransformM Scope -&gt; TransformM Scope
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; TransformM Scope
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521802"><span class="hs-identifier hs-var">mod_scope</span></a></span><span>
</span><span id="line-330"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#OpenDec"><span class="hs-identifier hs-type">OpenDec</span></a></span><span> </span><span id="local-6989586621684521800"><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521800"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684521799"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521799"><span class="hs-identifier hs-var">ds'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-331"></span><span>      </span><span id="local-6989586621684521798"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521798"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Mod -&gt; Scope
</span><a href="Futhark.Internalise.Defunctorise.html#modScope"><span class="hs-identifier hs-var">modScope</span></a></span><span> </span><span class="annot"><span class="annottext">(Mod -&gt; Scope) -&gt; TransformM Mod -&gt; TransformM Scope
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ModExp -&gt; TransformM Mod
</span><a href="Futhark.Internalise.Defunctorise.html#evalModExp"><span class="hs-identifier hs-var">evalModExp</span></a></span><span> </span><span class="annot"><span class="annottext">ModExp
</span><a href="#local-6989586621684521800"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-332"></span><span>      </span><span class="annot"><span class="annottext">Scope -&gt; TransformM Scope -&gt; TransformM Scope
forall a. Scope -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#extendScope"><span class="hs-identifier hs-var">extendScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521798"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">(TransformM Scope -&gt; TransformM Scope)
-&gt; TransformM Scope -&gt; TransformM Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; Scope -&gt; Scope
forall a. Monoid a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">mappend</span></span><span> </span><span class="annot"><span class="annottext">(Scope -&gt; Scope -&gt; Scope)
-&gt; TransformM Scope -&gt; TransformM (Scope -&gt; Scope)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#transformDecs"><span class="hs-identifier hs-var">transformDecs</span></a></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521799"><span class="hs-identifier hs-var">ds'</span></a></span><span> </span><span class="annot"><span class="annottext">TransformM (Scope -&gt; Scope) -&gt; TransformM Scope -&gt; TransformM Scope
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope -&gt; TransformM Scope
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521798"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-333"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#ImportDec"><span class="hs-identifier hs-type">ImportDec</span></a></span><span> </span><span id="local-6989586621684521796"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684521796"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684521795"><span class="annot"><span class="annottext">Info String
</span><a href="#local-6989586621684521795"><span class="hs-identifier hs-var">name'</span></a></span></span><span> </span><span id="local-6989586621684521794"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684521794"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684521793"><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521793"><span class="hs-identifier hs-var">ds'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-334"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684521792"><span class="annot"><span class="annottext">d :: DecBase Info vn
</span><a href="#local-6989586621684521792"><span class="hs-identifier hs-var hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DecBase Info vn -&gt; SrcLoc -&gt; DecBase Info vn
forall (f :: * -&gt; *) vn. DecBase f vn -&gt; SrcLoc -&gt; DecBase f vn
</span><a href="Language.Futhark.Syntax.html#LocalDec"><span class="hs-identifier hs-var">LocalDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ModExpBase Info vn -&gt; SrcLoc -&gt; DecBase Info vn
forall (f :: * -&gt; *) vn. ModExpBase f vn -&gt; SrcLoc -&gt; DecBase f vn
</span><a href="Language.Futhark.Syntax.html#OpenDec"><span class="hs-identifier hs-var">OpenDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Info String -&gt; SrcLoc -&gt; ModExpBase Info vn
forall (f :: * -&gt; *) vn.
String -&gt; f String -&gt; SrcLoc -&gt; ModExpBase f vn
</span><a href="Language.Futhark.Syntax.html#ModImport"><span class="hs-identifier hs-var">ModImport</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684521796"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Info String
</span><a href="#local-6989586621684521795"><span class="hs-identifier hs-var">name'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684521794"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684521794"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684521794"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-335"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#transformDecs"><span class="hs-identifier hs-var">transformDecs</span></a></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; TransformM Scope) -&gt; [Dec] -&gt; TransformM Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Dec
forall {vn}. DecBase Info vn
</span><a href="#local-6989586621684521792"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Dec -&gt; [Dec] -&gt; [Dec]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Dec]
</span><a href="#local-6989586621684521793"><span class="hs-identifier hs-var">ds'</span></a></span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#transformImports"><span class="hs-identifier hs-type">transformImports</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Semantic.html#Imports"><span class="hs-identifier hs-type">Imports</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#TransformM"><span class="hs-identifier hs-type">TransformM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-338"></span><span id="transformImports"><span class="annot"><span class="annottext">transformImports :: Imports -&gt; TransformM ()
</span><a href="Futhark.Internalise.Defunctorise.html#transformImports"><span class="hs-identifier hs-var hs-var">transformImports</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; TransformM ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#transformImports"><span class="hs-identifier hs-var">transformImports</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684521790"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684521790"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684521789"><span class="annot"><span class="annottext">FileModule
</span><a href="#local-6989586621684521789"><span class="hs-identifier hs-var">imp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684521788"><span class="annot"><span class="annottext">Imports
</span><a href="#local-6989586621684521788"><span class="hs-identifier hs-var">imps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-340"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684521786"><span class="annot"><span class="annottext">abs :: TySet
</span><a href="#local-6989586621684521786"><span class="hs-identifier hs-var hs-var">abs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; TySet
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; TySet) -&gt; [VName] -&gt; TySet
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; VName) -&gt; [QualName VName] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">([QualName VName] -&gt; [VName]) -&gt; [QualName VName] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map (QualName VName) Liftedness -&gt; [QualName VName]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">(Map (QualName VName) Liftedness -&gt; [QualName VName])
-&gt; Map (QualName VName) Liftedness -&gt; [QualName VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FileModule -&gt; Map (QualName VName) Liftedness
</span><a href="Language.Futhark.Semantic.html#fileAbs"><span class="hs-identifier hs-var hs-var">fileAbs</span></a></span><span> </span><span class="annot"><span class="annottext">FileModule
</span><a href="#local-6989586621684521789"><span class="hs-identifier hs-var">imp</span></a></span><span>
</span><span id="line-341"></span><span>  </span><span id="local-6989586621684521783"><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521783"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-342"></span><span>    </span><span class="annot"><span class="annottext">(DList Dec -&gt; DList Dec) -&gt; TransformM Scope -&gt; TransformM Scope
forall w (m :: * -&gt; *) a. MonadWriter w m =&gt; (w -&gt; w) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">censor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Dec -&gt; Dec) -&gt; DList Dec -&gt; DList Dec
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Dec -&gt; Dec
forall {f :: * -&gt; *} {vn}. DecBase f vn -&gt; DecBase f vn
</span><a href="#local-6989586621684521781"><span class="hs-identifier hs-var">maybeHideEntryPoint</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TransformM Scope -&gt; TransformM Scope)
-&gt; TransformM Scope -&gt; TransformM Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-343"></span><span>      </span><span class="annot"><span class="annottext">TySet -&gt; TransformM Scope -&gt; TransformM Scope
forall a. TySet -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#bindingAbs"><span class="hs-identifier hs-var">bindingAbs</span></a></span><span> </span><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684521786"><span class="hs-identifier hs-var">abs</span></a></span><span> </span><span class="annot"><span class="annottext">(TransformM Scope -&gt; TransformM Scope)
-&gt; TransformM Scope -&gt; TransformM Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Dec] -&gt; TransformM Scope
</span><a href="Futhark.Internalise.Defunctorise.html#transformDecs"><span class="hs-identifier hs-var">transformDecs</span></a></span><span> </span><span class="annot"><span class="annottext">([Dec] -&gt; TransformM Scope) -&gt; [Dec] -&gt; TransformM Scope
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ProgBase Info VName -&gt; [Dec]
forall (f :: * -&gt; *) vn. ProgBase f vn -&gt; [DecBase f vn]
</span><a href="Language.Futhark.Syntax.html#progDecs"><span class="hs-identifier hs-var hs-var">progDecs</span></a></span><span> </span><span class="annot"><span class="annottext">(ProgBase Info VName -&gt; [Dec]) -&gt; ProgBase Info VName -&gt; [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FileModule -&gt; ProgBase Info VName
</span><a href="Language.Futhark.Semantic.html#fileProg"><span class="hs-identifier hs-var hs-var">fileProg</span></a></span><span> </span><span class="annot"><span class="annottext">FileModule
</span><a href="#local-6989586621684521789"><span class="hs-identifier hs-var">imp</span></a></span><span>
</span><span id="line-344"></span><span>  </span><span class="annot"><span class="annottext">TySet -&gt; TransformM () -&gt; TransformM ()
forall a. TySet -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#bindingAbs"><span class="hs-identifier hs-var">bindingAbs</span></a></span><span> </span><span class="annot"><span class="annottext">TySet
</span><a href="#local-6989586621684521786"><span class="hs-identifier hs-var">abs</span></a></span><span> </span><span class="annot"><span class="annottext">(TransformM () -&gt; TransformM ()) -&gt; TransformM () -&gt; TransformM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Scope -&gt; TransformM () -&gt; TransformM ()
forall a. String -&gt; Scope -&gt; TransformM a -&gt; TransformM a
</span><a href="Futhark.Internalise.Defunctorise.html#bindingImport"><span class="hs-identifier hs-var">bindingImport</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684521790"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Scope
</span><a href="#local-6989586621684521783"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">(TransformM () -&gt; TransformM ()) -&gt; TransformM () -&gt; TransformM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Imports -&gt; TransformM ()
</span><a href="Futhark.Internalise.Defunctorise.html#transformImports"><span class="hs-identifier hs-var">transformImports</span></a></span><span> </span><span class="annot"><span class="annottext">Imports
</span><a href="#local-6989586621684521788"><span class="hs-identifier hs-var">imps</span></a></span><span>
</span><span id="line-345"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-346"></span><span>    </span><span class="hs-comment">-- Only the &quot;main&quot; file (last import) is allowed to have entry points.</span><span>
</span><span id="line-347"></span><span>    </span><span id="local-6989586621684521777"><span class="annot"><span class="annottext">permit_entry_points :: Bool
</span><a href="#local-6989586621684521777"><span class="hs-identifier hs-var hs-var">permit_entry_points</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Imports -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">Imports
</span><a href="#local-6989586621684521788"><span class="hs-identifier hs-var">imps</span></a></span><span>
</span><span id="line-348"></span><span>
</span><span id="line-349"></span><span>    </span><span id="local-6989586621684521781"><span class="annot"><span class="annottext">maybeHideEntryPoint :: DecBase f vn -&gt; DecBase f vn
</span><a href="#local-6989586621684521781"><span class="hs-identifier hs-var hs-var">maybeHideEntryPoint</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ValDec"><span class="hs-identifier hs-type">ValDec</span></a></span><span> </span><span id="local-6989586621684521775"><span class="annot"><span class="annottext">ValBindBase f vn
</span><a href="#local-6989586621684521775"><span class="hs-identifier hs-var">vdec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-350"></span><span>      </span><span class="annot"><span class="annottext">ValBindBase f vn -&gt; DecBase f vn
forall (f :: * -&gt; *) vn. ValBindBase f vn -&gt; DecBase f vn
</span><a href="Language.Futhark.Syntax.html#ValDec"><span class="hs-identifier hs-var">ValDec</span></a></span><span>
</span><span id="line-351"></span><span>        </span><span class="annot"><span class="annottext">ValBindBase f vn
</span><a href="#local-6989586621684521775"><span class="hs-identifier hs-var">vdec</span></a></span><span>
</span><span id="line-352"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">valBindEntryPoint :: Maybe (f EntryPoint)
</span><a href="Language.Futhark.Syntax.html#valBindEntryPoint"><span class="hs-identifier hs-var">valBindEntryPoint</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-353"></span><span>              </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684521777"><span class="hs-identifier hs-var">permit_entry_points</span></a></span><span>
</span><span id="line-354"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">ValBindBase f vn -&gt; Maybe (f EntryPoint)
forall (f :: * -&gt; *) vn. ValBindBase f vn -&gt; Maybe (f EntryPoint)
</span><a href="Language.Futhark.Syntax.html#valBindEntryPoint"><span class="hs-identifier hs-var hs-var">valBindEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">ValBindBase f vn
</span><a href="#local-6989586621684521775"><span class="hs-identifier hs-var">vdec</span></a></span><span>
</span><span id="line-355"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Maybe (f EntryPoint)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-356"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-357"></span><span>    </span><span class="annot"><a href="#local-6989586621684521781"><span class="hs-identifier hs-var">maybeHideEntryPoint</span></a></span><span> </span><span id="local-6989586621684521773"><span class="annot"><span class="annottext">DecBase f vn
</span><a href="#local-6989586621684521773"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DecBase f vn
</span><a href="#local-6989586621684521773"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span><span class="hs-comment">-- | Perform defunctorisation.</span><span>
</span><span id="line-360"></span><span id="local-6989586621684522533"><span class="annot"><a href="Futhark.Internalise.Defunctorise.html#transformProg"><span class="hs-identifier hs-type">transformProg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684522533"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Semantic.html#Imports"><span class="hs-identifier hs-type">Imports</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684522533"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#Dec"><span class="hs-identifier hs-type">Dec</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-361"></span><span id="transformProg"><span class="annot"><span class="annottext">transformProg :: forall (m :: * -&gt; *). MonadFreshNames m =&gt; Imports -&gt; m [Dec]
</span><a href="Futhark.Internalise.Defunctorise.html#transformProg"><span class="hs-identifier hs-var hs-var">transformProg</span></a></span></span><span> </span><span id="local-6989586621684521770"><span class="annot"><span class="annottext">Imports
</span><a href="#local-6989586621684521770"><span class="hs-identifier hs-var">prog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VNameSource -&gt; ([Dec], VNameSource)) -&gt; m [Dec]
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
(VNameSource -&gt; (a, VNameSource)) -&gt; m a
</span><a href="Futhark.MonadFreshNames.html#modifyNameSource"><span class="hs-identifier hs-var">modifyNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">((VNameSource -&gt; ([Dec], VNameSource)) -&gt; m [Dec])
-&gt; (VNameSource -&gt; ([Dec], VNameSource)) -&gt; m [Dec]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684521768"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684521768"><span class="hs-identifier hs-var">namesrc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-362"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684521767"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684521767"><span class="hs-identifier hs-var">namesrc'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684521766"><span class="annot"><span class="annottext">DList Dec
</span><a href="#local-6989586621684521766"><span class="hs-identifier hs-var">prog'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VNameSource -&gt; TransformM () -&gt; ((), VNameSource, DList Dec)
forall a.
VNameSource -&gt; TransformM a -&gt; (a, VNameSource, DList Dec)
</span><a href="Futhark.Internalise.Defunctorise.html#runTransformM"><span class="hs-identifier hs-var">runTransformM</span></a></span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684521768"><span class="hs-identifier hs-var">namesrc</span></a></span><span> </span><span class="annot"><span class="annottext">(TransformM () -&gt; ((), VNameSource, DList Dec))
-&gt; TransformM () -&gt; ((), VNameSource, DList Dec)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Imports -&gt; TransformM ()
</span><a href="Futhark.Internalise.Defunctorise.html#transformImports"><span class="hs-identifier hs-var">transformImports</span></a></span><span> </span><span class="annot"><span class="annottext">Imports
</span><a href="#local-6989586621684521770"><span class="hs-identifier hs-var">prog</span></a></span><span>
</span><span id="line-363"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DList Dec -&gt; [Dec]
forall a. DList a -&gt; [a]
</span><span class="hs-identifier hs-var">DL.toList</span></span><span> </span><span class="annot"><span class="annottext">DList Dec
</span><a href="#local-6989586621684521766"><span class="hs-identifier hs-var">prog'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684521767"><span class="hs-identifier hs-var">namesrc'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-364"></span></pre></body></html>