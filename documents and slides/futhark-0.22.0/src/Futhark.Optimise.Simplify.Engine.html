<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE Strict #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-12"></span><span class="hs-comment">--</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- Perform general rule-based simplification based on data dependency</span><span>
</span><span id="line-14"></span><span class="hs-comment">-- information.  This module will:</span><span>
</span><span id="line-15"></span><span class="hs-comment">--</span><span>
</span><span id="line-16"></span><span class="hs-comment">--    * Perform common-subexpression elimination (CSE).</span><span>
</span><span id="line-17"></span><span class="hs-comment">--</span><span>
</span><span id="line-18"></span><span class="hs-comment">--    * Hoist expressions out of loops (including lambdas) and</span><span>
</span><span id="line-19"></span><span class="hs-comment">--    branches.  This is done as aggressively as possible.</span><span>
</span><span id="line-20"></span><span class="hs-comment">--</span><span>
</span><span id="line-21"></span><span class="hs-comment">--    * Apply simplification rules (see</span><span>
</span><span id="line-22"></span><span class="hs-comment">--    &quot;Futhark.Optimise.Simplification.Rules&quot;).</span><span>
</span><span id="line-23"></span><span class="hs-comment">--</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- If you just want to run the simplifier as simply as possible, you</span><span>
</span><span id="line-25"></span><span class="hs-comment">-- may prefer to use the &quot;Futhark.Optimise.Simplify&quot; module.</span><span>
</span><span id="line-26"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Optimise.Simplify.Engine</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-comment">-- * Monadic interface</span></span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier">SimpleM</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#runSimpleM"><span class="hs-identifier">runSimpleM</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleOps"><span class="hs-identifier">SimpleOps</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifyOp"><span class="hs-identifier">SimplifyOp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#bindableSimpleOps"><span class="hs-identifier">bindableSimpleOps</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-33"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Env"><span class="hs-identifier">Env</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#envHoistBlockers"><span class="hs-identifier">envHoistBlockers</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#envRules"><span class="hs-identifier">envRules</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-34"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#emptyEnv"><span class="hs-identifier">emptyEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-35"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#HoistBlockers"><span class="hs-identifier">HoistBlockers</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-36"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#neverBlocks"><span class="hs-identifier">neverBlocks</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#noExtraHoistBlockers"><span class="hs-identifier">noExtraHoistBlockers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#neverHoist"><span class="hs-identifier">neverHoist</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier">BlockPred</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#orIf"><span class="hs-identifier">orIf</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#hasFree"><span class="hs-identifier">hasFree</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#isConsumed"><span class="hs-identifier">isConsumed</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#isFalse"><span class="hs-identifier">isFalse</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#isOp"><span class="hs-identifier">isOp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#isNotSafe"><span class="hs-identifier">isNotSafe</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#asksEngineEnv"><span class="hs-identifier">asksEngineEnv</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#askVtable"><span class="hs-identifier">askVtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#localVtable"><span class="hs-identifier">localVtable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Building blocks</span></span><span>
</span><span id="line-51"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier">SimplifiableRep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-52"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier">Simplifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-53"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyFun"><span class="hs-identifier">simplifyFun</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-54"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyStms"><span class="hs-identifier">simplifyStms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyStmsWithUsage"><span class="hs-identifier">simplifyStmsWithUsage</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambda"><span class="hs-identifier">simplifyLambda</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambdaNoHoisting"><span class="hs-identifier">simplifyLambdaNoHoisting</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-58"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#bindLParams"><span class="hs-identifier">bindLParams</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-59"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyBody"><span class="hs-identifier">simplifyBody</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#SymbolTable"><span class="hs-identifier">ST.SymbolTable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#hoistStms"><span class="hs-identifier">hoistStms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#blockIf"><span class="hs-identifier">blockIf</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#enterLoop"><span class="hs-identifier">enterLoop</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-64"></span><span>    </span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">where</span><span>
</span><span id="line-67"></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State.Strict</span></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Either</span></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">find</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">foldl'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mapAccumL</span></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html"><span class="hs-identifier">Futhark.Analysis.SymbolTable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ST</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html"><span class="hs-identifier">Futhark.Analysis.UsageTable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UT</span></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Construct.html"><span class="hs-identifier">Futhark.Construct</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.html"><span class="hs-identifier">Futhark.IR</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html"><span class="hs-identifier">Futhark.IR.Prop.Aliases</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rep</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rule</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#nubOrd"><span class="hs-identifier">nubOrd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span>
</span><span id="line-83"></span><span class="hs-keyword">data</span><span> </span><span id="HoistBlockers"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#HoistBlockers"><span class="hs-identifier hs-var">HoistBlockers</span></a></span></span><span> </span><span id="local-6989586621684371448"><span class="annot"><a href="#local-6989586621684371448"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="HoistBlockers"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#HoistBlockers"><span class="hs-identifier hs-var">HoistBlockers</span></a></span></span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | Blocker for hoisting out of parallel loops.</span><span>
</span><span id="line-85"></span><span>    </span><span id="blockHoistPar"><span class="annot"><span class="annottext">forall rep. HoistBlockers rep -&gt; BlockPred (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockHoistPar"><span class="hs-identifier hs-var hs-var">blockHoistPar</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371448"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-comment">-- | Blocker for hoisting out of sequential loops.</span><span>
</span><span id="line-87"></span><span>    </span><span id="blockHoistSeq"><span class="annot"><span class="annottext">forall rep. HoistBlockers rep -&gt; BlockPred (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockHoistSeq"><span class="hs-identifier hs-var hs-var">blockHoistSeq</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371448"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-88"></span><span>    </span><span class="hs-comment">-- | Blocker for hoisting out of branches.</span><span>
</span><span id="line-89"></span><span>    </span><span id="blockHoistBranch"><span class="annot"><span class="annottext">forall rep. HoistBlockers rep -&gt; BlockPred (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockHoistBranch"><span class="hs-identifier hs-var hs-var">blockHoistBranch</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371448"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-90"></span><span>    </span><span id="isAllocation"><span class="annot"><span class="annottext">forall rep. HoistBlockers rep -&gt; Stm (Wise rep) -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Engine.html#isAllocation"><span class="hs-identifier hs-var hs-var">isAllocation</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371448"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-91"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span id="local-6989586621684371440"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#noExtraHoistBlockers"><span class="hs-identifier hs-type">noExtraHoistBlockers</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#HoistBlockers"><span class="hs-identifier hs-type">HoistBlockers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371440"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-94"></span><span id="noExtraHoistBlockers"><span class="annot"><span class="annottext">noExtraHoistBlockers :: forall rep. HoistBlockers rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#noExtraHoistBlockers"><span class="hs-identifier hs-var hs-var">noExtraHoistBlockers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-95"></span><span>  </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; BlockPred (Wise rep)
-&gt; BlockPred (Wise rep)
-&gt; (Stm (Wise rep) -&gt; Bool)
-&gt; HoistBlockers rep
forall rep.
BlockPred (Wise rep)
-&gt; BlockPred (Wise rep)
-&gt; BlockPred (Wise rep)
-&gt; (Stm (Wise rep) -&gt; Bool)
-&gt; HoistBlockers rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#HoistBlockers"><span class="hs-identifier hs-var">HoistBlockers</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep. BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#neverBlocks"><span class="hs-identifier hs-var">neverBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep. BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#neverBlocks"><span class="hs-identifier hs-var">neverBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep. BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#neverBlocks"><span class="hs-identifier hs-var">neverBlocks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Stm (Wise rep) -&gt; Bool
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>
</span><span id="line-97"></span><span id="local-6989586621684370756"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#neverHoist"><span class="hs-identifier hs-type">neverHoist</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#HoistBlockers"><span class="hs-identifier hs-type">HoistBlockers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370756"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-98"></span><span id="neverHoist"><span class="annot"><span class="annottext">neverHoist :: forall rep. HoistBlockers rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#neverHoist"><span class="hs-identifier hs-var hs-var">neverHoist</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-99"></span><span>  </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; BlockPred (Wise rep)
-&gt; BlockPred (Wise rep)
-&gt; (Stm (Wise rep) -&gt; Bool)
-&gt; HoistBlockers rep
forall rep.
BlockPred (Wise rep)
-&gt; BlockPred (Wise rep)
-&gt; BlockPred (Wise rep)
-&gt; (Stm (Wise rep) -&gt; Bool)
-&gt; HoistBlockers rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#HoistBlockers"><span class="hs-identifier hs-var">HoistBlockers</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep. BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#alwaysBlocks"><span class="hs-identifier hs-var">alwaysBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep. BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#alwaysBlocks"><span class="hs-identifier hs-var">alwaysBlocks</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep. BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#alwaysBlocks"><span class="hs-identifier hs-var">alwaysBlocks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Stm (Wise rep) -&gt; Bool
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span class="hs-keyword">data</span><span> </span><span id="Env"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Env"><span class="hs-identifier hs-var">Env</span></a></span></span><span> </span><span id="local-6989586621684371434"><span class="annot"><a href="#local-6989586621684371434"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Env"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Env"><span class="hs-identifier hs-var">Env</span></a></span></span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="envRules"><span class="annot"><span class="annottext">forall rep. Env rep -&gt; RuleBook (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#envRules"><span class="hs-identifier hs-var hs-var">envRules</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#RuleBook"><span class="hs-identifier hs-type">RuleBook</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371434"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-103"></span><span>    </span><span id="envHoistBlockers"><span class="annot"><span class="annottext">forall rep. Env rep -&gt; HoistBlockers rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#envHoistBlockers"><span class="hs-identifier hs-var hs-var">envHoistBlockers</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#HoistBlockers"><span class="hs-identifier hs-type">HoistBlockers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371434"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-104"></span><span>    </span><span id="envVtable"><span class="annot"><span class="annottext">forall rep. Env rep -&gt; SymbolTable (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#envVtable"><span class="hs-identifier hs-var hs-var">envVtable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#SymbolTable"><span class="hs-identifier hs-type">ST.SymbolTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371434"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span id="local-6989586621684371427"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#emptyEnv"><span class="hs-identifier hs-type">emptyEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#RuleBook"><span class="hs-identifier hs-type">RuleBook</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371427"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#HoistBlockers"><span class="hs-identifier hs-type">HoistBlockers</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371427"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371427"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-108"></span><span id="emptyEnv"><span class="annot"><span class="annottext">emptyEnv :: forall rep. RuleBook (Wise rep) -&gt; HoistBlockers rep -&gt; Env rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#emptyEnv"><span class="hs-identifier hs-var hs-var">emptyEnv</span></a></span></span><span> </span><span id="local-6989586621684370750"><span class="annot"><span class="annottext">RuleBook (Wise rep)
</span><a href="#local-6989586621684370750"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span id="local-6989586621684370749"><span class="annot"><span class="annottext">HoistBlockers rep
</span><a href="#local-6989586621684370749"><span class="hs-identifier hs-var">blockers</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><span class="annottext">Env :: forall rep.
RuleBook (Wise rep)
-&gt; HoistBlockers rep -&gt; SymbolTable (Wise rep) -&gt; Env rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span>
</span><span id="line-110"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">envRules :: RuleBook (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#envRules"><span class="hs-identifier hs-var">envRules</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RuleBook (Wise rep)
</span><a href="#local-6989586621684370750"><span class="hs-identifier hs-var">rules</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-111"></span><span>      </span><span class="annot"><span class="annottext">envHoistBlockers :: HoistBlockers rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#envHoistBlockers"><span class="hs-identifier hs-var">envHoistBlockers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HoistBlockers rep
</span><a href="#local-6989586621684370749"><span class="hs-identifier hs-var">blockers</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-112"></span><span>      </span><span class="annot"><span class="annottext">envVtable :: SymbolTable (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#envVtable"><span class="hs-identifier hs-var">envVtable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-113"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span class="hs-keyword">type</span><span> </span><span id="Protect"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Protect"><span class="hs-identifier hs-var">Protect</span></a></span></span><span> </span><span id="local-6989586621684370748"><span class="annot"><a href="#local-6989586621684370748"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370748"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370748"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684370748"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-116"></span><span>
</span><span id="line-117"></span><span class="hs-keyword">type</span><span> </span><span id="SimplifyOp"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifyOp"><span class="hs-identifier hs-var">SimplifyOp</span></a></span></span><span> </span><span id="local-6989586621684370747"><span class="annot"><a href="#local-6989586621684370747"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684370746"><span class="annot"><a href="#local-6989586621684370746"><span class="hs-identifier hs-type">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621684370746"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370747"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684370746"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370747"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span class="hs-keyword">data</span><span> </span><span id="SimpleOps"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleOps"><span class="hs-identifier hs-var">SimpleOps</span></a></span></span><span> </span><span id="local-6989586621684371423"><span class="annot"><a href="#local-6989586621684371423"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="SimpleOps"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleOps"><span class="hs-identifier hs-var">SimpleOps</span></a></span></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="mkExpDecS"><span class="annot"><span class="annottext">forall rep.
SimpleOps rep
-&gt; SymbolTable (Wise rep)
-&gt; Pat (Wise rep)
-&gt; Exp (Wise rep)
-&gt; SimpleM rep (ExpDec (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#mkExpDecS"><span class="hs-identifier hs-var hs-var">mkExpDecS</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-121"></span><span>      </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#SymbolTable"><span class="hs-identifier hs-type">ST.SymbolTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371423"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-122"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371423"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-123"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371423"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-124"></span><span>      </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371423"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#ExpDec"><span class="hs-identifier hs-type">ExpDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371423"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-125"></span><span>    </span><span id="mkBodyS"><span class="annot"><span class="annottext">forall rep.
SimpleOps rep
-&gt; SymbolTable (Wise rep)
-&gt; Stms (Wise rep)
-&gt; Result
-&gt; SimpleM rep (Body (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#mkBodyS"><span class="hs-identifier hs-var hs-var">mkBodyS</span></a></span></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-126"></span><span>      </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#SymbolTable"><span class="hs-identifier hs-type">ST.SymbolTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371423"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-127"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371423"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-128"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.html#Result"><span class="hs-identifier hs-type">Result</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-129"></span><span>      </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371423"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371423"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-130"></span><span>    </span><span class="hs-comment">-- | Make a hoisted Op safe.  The SubExp is a boolean</span><span>
</span><span id="line-131"></span><span>    </span><span class="hs-comment">-- that is true when the value of the statement will</span><span>
</span><span id="line-132"></span><span>    </span><span class="hs-comment">-- actually be used.</span><span>
</span><span id="line-133"></span><span>    </span><span id="protectHoistedOpS"><span class="annot"><span class="annottext">forall rep. SimpleOps rep -&gt; Protect (Builder (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#protectHoistedOpS"><span class="hs-identifier hs-var hs-var">protectHoistedOpS</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Protect"><span class="hs-identifier hs-type">Protect</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.html#Builder"><span class="hs-identifier hs-type">Builder</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371423"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-134"></span><span>    </span><span id="opUsageS"><span class="annot"><span class="annottext">forall rep. SimpleOps rep -&gt; Op (Wise rep) -&gt; UsageTable
</span><a href="Futhark.Optimise.Simplify.Engine.html#opUsageS"><span class="hs-identifier hs-var hs-var">opUsageS</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371423"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-135"></span><span>    </span><span id="simplifyOpS"><span class="annot"><span class="annottext">forall rep. SimpleOps rep -&gt; SimplifyOp rep (Op (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyOpS"><span class="hs-identifier hs-var hs-var">simplifyOpS</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifyOp"><span class="hs-identifier hs-type">SimplifyOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371423"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371423"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span id="local-6989586621684371407"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#bindableSimpleOps"><span class="hs-identifier hs-type">bindableSimpleOps</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371407"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#Buildable"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371407"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-140"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifyOp"><span class="hs-identifier hs-type">SimplifyOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371407"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371407"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-141"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleOps"><span class="hs-identifier hs-type">SimpleOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371407"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-142"></span><span id="bindableSimpleOps"><span class="annot"><span class="annottext">bindableSimpleOps :: forall rep.
(SimplifiableRep rep, Buildable rep) =&gt;
SimplifyOp rep (Op (Wise rep)) -&gt; SimpleOps rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#bindableSimpleOps"><span class="hs-identifier hs-var hs-var">bindableSimpleOps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-143"></span><span>  </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep)
 -&gt; Pat (Wise rep)
 -&gt; Exp (Wise rep)
 -&gt; SimpleM rep (ExpDec (Wise rep)))
-&gt; (SymbolTable (Wise rep)
    -&gt; Stms (Wise rep) -&gt; Result -&gt; SimpleM rep (Body (Wise rep)))
-&gt; Protect (Builder (Wise rep))
-&gt; (Op (Wise rep) -&gt; UsageTable)
-&gt; SimplifyOp rep (Op (Wise rep))
-&gt; SimpleOps rep
forall rep.
(SymbolTable (Wise rep)
 -&gt; Pat (Wise rep)
 -&gt; Exp (Wise rep)
 -&gt; SimpleM rep (ExpDec (Wise rep)))
-&gt; (SymbolTable (Wise rep)
    -&gt; Stms (Wise rep) -&gt; Result -&gt; SimpleM rep (Body (Wise rep)))
-&gt; Protect (Builder (Wise rep))
-&gt; (Op (Wise rep) -&gt; UsageTable)
-&gt; SimplifyOp rep (Op (Wise rep))
-&gt; SimpleOps rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#SimpleOps"><span class="hs-identifier hs-var">SimpleOps</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
-&gt; Pat (Wise rep)
-&gt; Exp (Wise rep)
-&gt; SimpleM rep (ExpDec (Wise rep))
forall {m :: * -&gt; *} {rep} {p}.
(Monad m, Buildable rep) =&gt;
p -&gt; PatT (LetDec rep) -&gt; Exp rep -&gt; m (ExpDec rep)
</span><a href="#local-6989586621684370723"><span class="hs-identifier hs-var">mkExpDecS'</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
-&gt; Stms (Wise rep) -&gt; Result -&gt; SimpleM rep (Body (Wise rep))
forall {m :: * -&gt; *} {rep} {p}.
(Monad m, Buildable rep) =&gt;
p -&gt; Stms rep -&gt; Result -&gt; m (Body rep)
</span><a href="#local-6989586621684370722"><span class="hs-identifier hs-var">mkBodyS'</span></a></span><span> </span><span class="annot"><span class="annottext">Protect (Builder (Wise rep))
forall {p} {p} {p} {a}. p -&gt; p -&gt; p -&gt; Maybe a
</span><a href="#local-6989586621684370721"><span class="hs-identifier hs-var">protectHoistedOpS'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">UsageTable -&gt; OpWithWisdom (Op rep) -&gt; UsageTable
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-145"></span><span>    </span><span id="local-6989586621684370723"><span class="annot"><span class="annottext">mkExpDecS' :: p -&gt; PatT (LetDec rep) -&gt; Exp rep -&gt; m (ExpDec rep)
</span><a href="#local-6989586621684370723"><span class="hs-identifier hs-var hs-var">mkExpDecS'</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684370716"><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><a href="#local-6989586621684370716"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684370715"><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684370715"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpDec rep -&gt; m (ExpDec rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ExpDec rep -&gt; m (ExpDec rep)) -&gt; ExpDec rep -&gt; m (ExpDec rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep) -&gt; Exp rep -&gt; ExpDec rep
forall rep. Buildable rep =&gt; Pat rep -&gt; Exp rep -&gt; ExpDec rep
</span><a href="Futhark.Builder.Class.html#mkExpDec"><span class="hs-identifier hs-var">mkExpDec</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><a href="#local-6989586621684370716"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684370715"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-146"></span><span>    </span><span id="local-6989586621684370722"><span class="annot"><span class="annottext">mkBodyS' :: p -&gt; Stms rep -&gt; Result -&gt; m (Body rep)
</span><a href="#local-6989586621684370722"><span class="hs-identifier hs-var hs-var">mkBodyS'</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684370709"><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684370709"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684370708"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684370708"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Body rep -&gt; m (Body rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Body rep -&gt; m (Body rep)) -&gt; Body rep -&gt; m (Body rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms rep -&gt; Result -&gt; Body rep
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">Stms rep
</span><a href="#local-6989586621684370709"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684370708"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-147"></span><span>    </span><span id="local-6989586621684370721"><span class="annot"><span class="annottext">protectHoistedOpS' :: p -&gt; p -&gt; p -&gt; Maybe a
</span><a href="#local-6989586621684370721"><span class="hs-identifier hs-var hs-var">protectHoistedOpS'</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span class="hs-keyword">newtype</span><span> </span><span id="SimpleM"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-var">SimpleM</span></a></span></span><span> </span><span id="local-6989586621684371391"><span class="annot"><a href="#local-6989586621684371391"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684370706"><span class="annot"><a href="#local-6989586621684370706"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="SimpleM"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-var">SimpleM</span></a></span></span><span>
</span><span id="line-151"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span>
</span><span id="line-152"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleOps"><span class="hs-identifier hs-type">SimpleOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371391"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371391"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>          </span><span class="annot"><a href="#local-6989586621684370706"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-155"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-156"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-special">(</span><span> </span><span id="local-6989586621684370679"><span id="local-6989586621684370684"><span id="local-6989586621684370689"><span id="local-6989586621684370694"><span id="local-6989586621684370700"><span class="annot"><span class="annottext">Functor (SimpleM rep)
Functor (SimpleM rep)
-&gt; (forall a. a -&gt; SimpleM rep a)
-&gt; (forall a b.
    SimpleM rep (a -&gt; b) -&gt; SimpleM rep a -&gt; SimpleM rep b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c) -&gt; SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep c)
-&gt; (forall a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep b)
-&gt; (forall a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep a)
-&gt; Applicative (SimpleM rep)
forall {rep}. Functor (SimpleM rep)
forall a. a -&gt; SimpleM rep a
forall rep a. a -&gt; SimpleM rep a
forall a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep a
forall a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep b
forall a b. SimpleM rep (a -&gt; b) -&gt; SimpleM rep a -&gt; SimpleM rep b
forall rep a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep a
forall rep a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep b
forall rep a b.
SimpleM rep (a -&gt; b) -&gt; SimpleM rep a -&gt; SimpleM rep b
forall a b c.
(a -&gt; b -&gt; c) -&gt; SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep c
forall rep a b c.
(a -&gt; b -&gt; c) -&gt; SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: forall a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep a
$c&lt;* :: forall rep a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep a
*&gt; :: forall a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep b
$c*&gt; :: forall rep a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep b
liftA2 :: forall a b c.
(a -&gt; b -&gt; c) -&gt; SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep c
$cliftA2 :: forall rep a b c.
(a -&gt; b -&gt; c) -&gt; SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep c
&lt;*&gt; :: forall a b. SimpleM rep (a -&gt; b) -&gt; SimpleM rep a -&gt; SimpleM rep b
$c&lt;*&gt; :: forall rep a b.
SimpleM rep (a -&gt; b) -&gt; SimpleM rep a -&gt; SimpleM rep b
pure :: forall a. a -&gt; SimpleM rep a
$cpure :: forall rep a. a -&gt; SimpleM rep a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-158"></span><span>      </span><span id="local-6989586621684370653"><span id="local-6989586621684370659"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; SimpleM rep a -&gt; SimpleM rep b)
-&gt; (forall a b. a -&gt; SimpleM rep b -&gt; SimpleM rep a)
-&gt; Functor (SimpleM rep)
forall a b. a -&gt; SimpleM rep b -&gt; SimpleM rep a
forall a b. (a -&gt; b) -&gt; SimpleM rep a -&gt; SimpleM rep b
forall rep a b. a -&gt; SimpleM rep b -&gt; SimpleM rep a
forall rep a b. (a -&gt; b) -&gt; SimpleM rep a -&gt; SimpleM rep b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: forall a b. a -&gt; SimpleM rep b -&gt; SimpleM rep a
$c&lt;$ :: forall rep a b. a -&gt; SimpleM rep b -&gt; SimpleM rep a
fmap :: forall a b. (a -&gt; b) -&gt; SimpleM rep a -&gt; SimpleM rep b
$cfmap :: forall rep a b. (a -&gt; b) -&gt; SimpleM rep a -&gt; SimpleM rep b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-159"></span><span>      </span><span id="local-6989586621684370631"><span id="local-6989586621684370636"><span id="local-6989586621684370642"><span class="annot"><span class="annottext">Applicative (SimpleM rep)
Applicative (SimpleM rep)
-&gt; (forall a b.
    SimpleM rep a -&gt; (a -&gt; SimpleM rep b) -&gt; SimpleM rep b)
-&gt; (forall a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep b)
-&gt; (forall a. a -&gt; SimpleM rep a)
-&gt; Monad (SimpleM rep)
forall rep. Applicative (SimpleM rep)
forall a. a -&gt; SimpleM rep a
forall rep a. a -&gt; SimpleM rep a
forall a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep b
forall a b. SimpleM rep a -&gt; (a -&gt; SimpleM rep b) -&gt; SimpleM rep b
forall rep a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep b
forall rep a b.
SimpleM rep a -&gt; (a -&gt; SimpleM rep b) -&gt; SimpleM rep b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: forall a. a -&gt; SimpleM rep a
$creturn :: forall rep a. a -&gt; SimpleM rep a
&gt;&gt; :: forall a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep b
$c&gt;&gt; :: forall rep a b. SimpleM rep a -&gt; SimpleM rep b -&gt; SimpleM rep b
&gt;&gt;= :: forall a b. SimpleM rep a -&gt; (a -&gt; SimpleM rep b) -&gt; SimpleM rep b
$c&gt;&gt;= :: forall rep a b.
SimpleM rep a -&gt; (a -&gt; SimpleM rep b) -&gt; SimpleM rep b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-160"></span><span>      </span><span id="local-6989586621684370608"><span id="local-6989586621684370613"><span id="local-6989586621684370619"><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleOps"><span class="hs-identifier hs-type">SimpleOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371391"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371391"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-161"></span><span>      </span><span id="local-6989586621684370585"><span id="local-6989586621684370590"><span id="local-6989586621684370596"><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-162"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span>
</span><span id="line-164"></span><span id="local-6989586621684371288"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371288"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-165"></span><span>  </span><span id="local-6989586621684370566"><span class="annot"><span class="annottext">putNameSource :: VNameSource -&gt; SimpleM rep ()
</span><a href="Futhark.MonadFreshNames.html#putNameSource"><span class="hs-identifier hs-var hs-var hs-var hs-var">putNameSource</span></a></span></span><span> </span><span id="local-6989586621684370564"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684370564"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VNameSource, Bool, Certs) -&gt; (VNameSource, Bool, Certs))
-&gt; SimpleM rep ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">(((VNameSource, Bool, Certs) -&gt; (VNameSource, Bool, Certs))
 -&gt; SimpleM rep ())
-&gt; ((VNameSource, Bool, Certs) -&gt; (VNameSource, Bool, Certs))
-&gt; SimpleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VNameSource
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370562"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684370562"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370561"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370561"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684370564"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684370562"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370561"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>  </span><span id="local-6989586621684370559"><span class="annot"><span class="annottext">getNameSource :: SimpleM rep VNameSource
</span><a href="Futhark.MonadFreshNames.html#getNameSource"><span class="hs-identifier hs-var hs-var hs-var hs-var">getNameSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VNameSource, Bool, Certs) -&gt; VNameSource)
-&gt; SimpleM rep VNameSource
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">(((VNameSource, Bool, Certs) -&gt; VNameSource)
 -&gt; SimpleM rep VNameSource)
-&gt; ((VNameSource, Bool, Certs) -&gt; VNameSource)
-&gt; SimpleM rep VNameSource
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684370556"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684370556"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684370556"><span class="hs-identifier hs-var">a</span></a></span></span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span id="local-6989586621684371273"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684370546"><span id="local-6989586621684370549"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371273"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371273"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371273"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-169"></span><span>  </span><span id="local-6989586621684370543"><span class="annot"><span class="annottext">askScope :: SimpleM rep (Scope (Wise rep))
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var hs-var hs-var hs-var">askScope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep) -&gt; Scope (Wise rep)
forall rep. SymbolTable rep -&gt; Scope rep
</span><a href="Futhark.Analysis.SymbolTable.html#toScope"><span class="hs-identifier hs-var">ST.toScope</span></a></span><span> </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; Scope (Wise rep))
-&gt; SimpleM rep (SymbolTable (Wise rep))
-&gt; SimpleM rep (Scope (Wise rep))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (SymbolTable (Wise rep))
forall rep. SimpleM rep (SymbolTable (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#askVtable"><span class="hs-identifier hs-var">askVtable</span></a></span><span>
</span><span id="line-170"></span><span>  </span><span id="local-6989586621684370532"><span class="annot"><span class="annottext">lookupType :: VName -&gt; SimpleM rep Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var hs-var hs-var hs-var">lookupType</span></a></span></span><span> </span><span id="local-6989586621684370530"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684370530"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>    </span><span id="local-6989586621684370529"><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684370529"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleM rep (SymbolTable (Wise rep))
forall rep. SimpleM rep (SymbolTable (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#askVtable"><span class="hs-identifier hs-var">askVtable</span></a></span><span>
</span><span id="line-172"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SymbolTable (Wise rep) -&gt; Maybe Type
forall rep. ASTRep rep =&gt; VName -&gt; SymbolTable rep -&gt; Maybe Type
</span><a href="Futhark.Analysis.SymbolTable.html#lookupType"><span class="hs-identifier hs-var">ST.lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684370530"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684370529"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-173"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684370527"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684370527"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Type -&gt; SimpleM rep Type
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684370527"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-174"></span><span>      </span><span class="annot"><span class="annottext">Maybe Type
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-175"></span><span>        </span><span class="annot"><span class="annottext">[Char] -&gt; SimpleM rep Type
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">([Char] -&gt; SimpleM rep Type) -&gt; [Char] -&gt; SimpleM rep Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-176"></span><span>          </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;SimpleM.lookupType: cannot find variable &quot;</span></span><span>
</span><span id="line-177"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [Char]
forall a. Pretty a =&gt; a -&gt; [Char]
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684370530"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-178"></span><span>            </span><span class="annot"><span class="annottext">[Char] -&gt; [Char] -&gt; [Char]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot; in symbol table.&quot;</span></span></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span id="local-6989586621684371255"><span class="hs-keyword">instance</span><span>
</span><span id="line-181"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371255"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-182"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371255"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371255"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-184"></span><span>  </span><span id="local-6989586621684370503"><span class="annot"><span class="annottext">localScope :: forall a. Scope (Wise rep) -&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var hs-var hs-var hs-var">localScope</span></a></span></span><span> </span><span id="local-6989586621684370501"><span class="annot"><span class="annottext">Scope (Wise rep)
</span><a href="#local-6989586621684370501"><span class="hs-identifier hs-var">types</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
forall rep a.
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#localVtable"><span class="hs-identifier hs-var">localVtable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
-&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope (Wise rep) -&gt; SymbolTable (Wise rep)
forall rep. ASTRep rep =&gt; Scope rep -&gt; SymbolTable rep
</span><a href="Futhark.Analysis.SymbolTable.html#fromScope"><span class="hs-identifier hs-var">ST.fromScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope (Wise rep)
</span><a href="#local-6989586621684370501"><span class="hs-identifier hs-var">types</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span id="local-6989586621684371247"><span id="local-6989586621684371248"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#runSimpleM"><span class="hs-identifier hs-type">runSimpleM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-187"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371248"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371247"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-188"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleOps"><span class="hs-identifier hs-type">SimpleOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371248"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371248"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-190"></span><span>  </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-191"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684371247"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-192"></span><span id="runSimpleM"><span class="annot"><span class="annottext">runSimpleM :: forall rep a.
SimpleM rep a
-&gt; SimpleOps rep
-&gt; Env rep
-&gt; VNameSource
-&gt; ((a, Bool), VNameSource)
</span><a href="Futhark.Optimise.Simplify.Engine.html#runSimpleM"><span class="hs-identifier hs-var hs-var">runSimpleM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span id="local-6989586621684370497"><span class="annot"><span class="annottext">ReaderT
  (SimpleOps rep, Env rep) (State (VNameSource, Bool, Certs)) a
</span><a href="#local-6989586621684370497"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684370496"><span class="annot"><span class="annottext">SimpleOps rep
</span><a href="#local-6989586621684370496"><span class="hs-identifier hs-var">simpl</span></a></span></span><span> </span><span id="local-6989586621684370495"><span class="annot"><span class="annottext">Env rep
</span><a href="#local-6989586621684370495"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621684370494"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684370494"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684370493"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684370493"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684370492"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684370492"><span class="hs-identifier hs-var">src'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370491"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684370491"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State (VNameSource, Bool, Certs) a
-&gt; (VNameSource, Bool, Certs) -&gt; (a, (VNameSource, Bool, Certs))
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT
  (SimpleOps rep, Env rep) (State (VNameSource, Bool, Certs)) a
-&gt; (SimpleOps rep, Env rep) -&gt; State (VNameSource, Bool, Certs) a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT
  (SimpleOps rep, Env rep) (State (VNameSource, Bool, Certs)) a
</span><a href="#local-6989586621684370497"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimpleOps rep
</span><a href="#local-6989586621684370496"><span class="hs-identifier hs-var">simpl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Env rep
</span><a href="#local-6989586621684370495"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684370494"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-194"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684370493"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684370491"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684370492"><span class="hs-identifier hs-var">src'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span id="local-6989586621684371239"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#askEngineEnv"><span class="hs-identifier hs-type">askEngineEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371239"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371239"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-197"></span><span id="askEngineEnv"><span class="annot"><span class="annottext">askEngineEnv :: forall rep. SimpleM rep (Env rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#askEngineEnv"><span class="hs-identifier hs-var hs-var">askEngineEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((SimpleOps rep, Env rep) -&gt; Env rep) -&gt; SimpleM rep (Env rep)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">(SimpleOps rep, Env rep) -&gt; Env rep
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span id="local-6989586621684371231"><span id="local-6989586621684371232"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#asksEngineEnv"><span class="hs-identifier hs-type">asksEngineEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371232"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684371231"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371232"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371231"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-200"></span><span id="asksEngineEnv"><span class="annot"><span class="annottext">asksEngineEnv :: forall rep a. (Env rep -&gt; a) -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#asksEngineEnv"><span class="hs-identifier hs-var hs-var">asksEngineEnv</span></a></span></span><span> </span><span id="local-6989586621684370484"><span class="annot"><span class="annottext">Env rep -&gt; a
</span><a href="#local-6989586621684370484"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env rep -&gt; a
</span><a href="#local-6989586621684370484"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(Env rep -&gt; a) -&gt; SimpleM rep (Env rep) -&gt; SimpleM rep a
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (Env rep)
forall rep. SimpleM rep (Env rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#askEngineEnv"><span class="hs-identifier hs-var">askEngineEnv</span></a></span><span>
</span><span id="line-201"></span><span>
</span><span id="line-202"></span><span id="local-6989586621684371268"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#askVtable"><span class="hs-identifier hs-type">askVtable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371268"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#SymbolTable"><span class="hs-identifier hs-type">ST.SymbolTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371268"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-203"></span><span id="askVtable"><span class="annot"><span class="annottext">askVtable :: forall rep. SimpleM rep (SymbolTable (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#askVtable"><span class="hs-identifier hs-var hs-var">askVtable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Env rep -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep (SymbolTable (Wise rep))
forall rep a. (Env rep -&gt; a) -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#asksEngineEnv"><span class="hs-identifier hs-var">asksEngineEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env rep -&gt; SymbolTable (Wise rep)
forall rep. Env rep -&gt; SymbolTable (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#envVtable"><span class="hs-identifier hs-var hs-var">envVtable</span></a></span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span id="local-6989586621684371251"><span id="local-6989586621684371252"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#localVtable"><span class="hs-identifier hs-type">localVtable</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#SymbolTable"><span class="hs-identifier hs-type">ST.SymbolTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371252"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#SymbolTable"><span class="hs-identifier hs-type">ST.SymbolTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371252"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371252"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371251"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-208"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371252"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371251"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-209"></span><span id="localVtable"><span class="annot"><span class="annottext">localVtable :: forall rep a.
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#localVtable"><span class="hs-identifier hs-var hs-var">localVtable</span></a></span></span><span> </span><span id="local-6989586621684370482"><span class="annot"><span class="annottext">SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
</span><a href="#local-6989586621684370482"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((SimpleOps rep, Env rep) -&gt; (SimpleOps rep, Env rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">(((SimpleOps rep, Env rep) -&gt; (SimpleOps rep, Env rep))
 -&gt; SimpleM rep a -&gt; SimpleM rep a)
-&gt; ((SimpleOps rep, Env rep) -&gt; (SimpleOps rep, Env rep))
-&gt; SimpleM rep a
-&gt; SimpleM rep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684370480"><span class="annot"><span class="annottext">SimpleOps rep
</span><a href="#local-6989586621684370480"><span class="hs-identifier hs-var">ops</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370479"><span class="annot"><span class="annottext">Env rep
</span><a href="#local-6989586621684370479"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SimpleOps rep
</span><a href="#local-6989586621684370480"><span class="hs-identifier hs-var">ops</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Env rep
</span><a href="#local-6989586621684370479"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">envVtable :: SymbolTable (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#envVtable"><span class="hs-identifier hs-var">envVtable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
</span><a href="#local-6989586621684370482"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Env rep -&gt; SymbolTable (Wise rep)
forall rep. Env rep -&gt; SymbolTable (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#envVtable"><span class="hs-identifier hs-var hs-var">envVtable</span></a></span><span> </span><span class="annot"><span class="annottext">Env rep
</span><a href="#local-6989586621684370479"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span id="local-6989586621684371224"><span id="local-6989586621684371225"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#collectCerts"><span class="hs-identifier hs-type">collectCerts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371225"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371224"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371225"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684371224"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-212"></span><span id="collectCerts"><span class="annot"><span class="annottext">collectCerts :: forall rep a. SimpleM rep a -&gt; SimpleM rep (a, Certs)
</span><a href="Futhark.Optimise.Simplify.Engine.html#collectCerts"><span class="hs-identifier hs-var hs-var">collectCerts</span></a></span></span><span> </span><span id="local-6989586621684370470"><span class="annot"><span class="annottext">SimpleM rep a
</span><a href="#local-6989586621684370470"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-213"></span><span>  </span><span id="local-6989586621684370469"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684370469"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleM rep a
</span><a href="#local-6989586621684370470"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684370468"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684370468"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370467"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684370467"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370466"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370466"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleM rep (VNameSource, Bool, Certs)
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-215"></span><span>  </span><span class="annot"><span class="annottext">(VNameSource, Bool, Certs) -&gt; SimpleM rep ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684370468"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684370467"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><span class="annottext">(a, Certs) -&gt; SimpleM rep (a, Certs)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684370469"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370466"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="hs-comment">-- | Mark that we have changed something and it would be a good idea</span><span>
</span><span id="line-219"></span><span class="hs-comment">-- to re-run the simplifier.</span><span>
</span><span id="line-220"></span><span id="local-6989586621684371221"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#changed"><span class="hs-identifier hs-type">changed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371221"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-221"></span><span id="changed"><span class="annot"><span class="annottext">changed :: forall rep. SimpleM rep ()
</span><a href="Futhark.Optimise.Simplify.Engine.html#changed"><span class="hs-identifier hs-var hs-var">changed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VNameSource, Bool, Certs) -&gt; (VNameSource, Bool, Certs))
-&gt; SimpleM rep ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">(((VNameSource, Bool, Certs) -&gt; (VNameSource, Bool, Certs))
 -&gt; SimpleM rep ())
-&gt; ((VNameSource, Bool, Certs) -&gt; (VNameSource, Bool, Certs))
-&gt; SimpleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684370461"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684370461"><span class="hs-identifier hs-var">src</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370460"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370460"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684370461"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370460"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span id="local-6989586621684371219"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#usedCerts"><span class="hs-identifier hs-type">usedCerts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371219"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-224"></span><span id="usedCerts"><span class="annot"><span class="annottext">usedCerts :: forall rep. Certs -&gt; SimpleM rep ()
</span><a href="Futhark.Optimise.Simplify.Engine.html#usedCerts"><span class="hs-identifier hs-var hs-var">usedCerts</span></a></span></span><span> </span><span id="local-6989586621684370455"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370455"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VNameSource, Bool, Certs) -&gt; (VNameSource, Bool, Certs))
-&gt; SimpleM rep ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">(((VNameSource, Bool, Certs) -&gt; (VNameSource, Bool, Certs))
 -&gt; SimpleM rep ())
-&gt; ((VNameSource, Bool, Certs) -&gt; (VNameSource, Bool, Certs))
-&gt; SimpleM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684370454"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684370454"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370453"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684370453"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370452"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370452"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684370454"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684370453"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370455"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370452"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span class="hs-comment">-- | Indicate in the symbol table that we have descended into a loop.</span><span>
</span><span id="line-227"></span><span id="local-6989586621684371216"><span id="local-6989586621684371217"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#enterLoop"><span class="hs-identifier hs-type">enterLoop</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371217"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371216"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371217"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371216"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-228"></span><span id="enterLoop"><span class="annot"><span class="annottext">enterLoop :: forall rep a. SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#enterLoop"><span class="hs-identifier hs-var hs-var">enterLoop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
forall rep a.
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#localVtable"><span class="hs-identifier hs-var">localVtable</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
forall rep. SymbolTable rep -&gt; SymbolTable rep
</span><a href="Futhark.Analysis.SymbolTable.html#deepen"><span class="hs-identifier hs-var">ST.deepen</span></a></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span id="local-6989586621684371210"><span id="local-6989586621684371212"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#bindFParams"><span class="hs-identifier hs-type">bindFParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371212"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371212"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371212"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371210"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371212"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371210"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-231"></span><span id="bindFParams"><span class="annot"><span class="annottext">bindFParams :: forall rep a.
SimplifiableRep rep =&gt;
[FParam (Wise rep)] -&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#bindFParams"><span class="hs-identifier hs-var hs-var">bindFParams</span></a></span></span><span> </span><span id="local-6989586621684370445"><span class="annot"><span class="annottext">[FParam (Wise rep)]
</span><a href="#local-6989586621684370445"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-232"></span><span>  </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
forall rep a.
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#localVtable"><span class="hs-identifier hs-var">localVtable</span></a></span><span> </span><span class="annot"><span class="annottext">((SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
 -&gt; SimpleM rep a -&gt; SimpleM rep a)
-&gt; (SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a
-&gt; SimpleM rep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[FParam (Wise rep)]
-&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
forall rep.
ASTRep rep =&gt;
[FParam rep] -&gt; SymbolTable rep -&gt; SymbolTable rep
</span><a href="Futhark.Analysis.SymbolTable.html#insertFParams"><span class="hs-identifier hs-var">ST.insertFParams</span></a></span><span> </span><span class="annot"><span class="annottext">[FParam (Wise rep)]
</span><a href="#local-6989586621684370445"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span id="local-6989586621684371204"><span id="local-6989586621684371206"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#bindLParams"><span class="hs-identifier hs-type">bindLParams</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371206"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371206"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371206"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371204"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371206"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371204"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-235"></span><span id="bindLParams"><span class="annot"><span class="annottext">bindLParams :: forall rep a.
SimplifiableRep rep =&gt;
[LParam (Wise rep)] -&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#bindLParams"><span class="hs-identifier hs-var hs-var">bindLParams</span></a></span></span><span> </span><span id="local-6989586621684370436"><span class="annot"><span class="annottext">[LParam (Wise rep)]
</span><a href="#local-6989586621684370436"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-236"></span><span>  </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
forall rep a.
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#localVtable"><span class="hs-identifier hs-var">localVtable</span></a></span><span> </span><span class="annot"><span class="annottext">((SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
 -&gt; SimpleM rep a -&gt; SimpleM rep a)
-&gt; (SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a
-&gt; SimpleM rep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684370435"><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684370435"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Param (LParamInfo rep)
 -&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SymbolTable (Wise rep)
-&gt; [Param (LParamInfo rep)]
-&gt; SymbolTable (Wise rep)
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldr</span></span><span> </span><span class="annot"><span class="annottext">Param (LParamInfo rep)
-&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
forall rep.
ASTRep rep =&gt;
LParam rep -&gt; SymbolTable rep -&gt; SymbolTable rep
</span><a href="Futhark.Analysis.SymbolTable.html#insertLParam"><span class="hs-identifier hs-var">ST.insertLParam</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684370435"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
[LParam (Wise rep)]
</span><a href="#local-6989586621684370436"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span id="local-6989586621684370431"><span id="local-6989586621684370432"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#bindArrayLParams"><span class="hs-identifier hs-type">bindArrayLParams</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370432"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370432"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370432"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370431"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-242"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370432"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370431"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-243"></span><span id="bindArrayLParams"><span class="annot"><span class="annottext">bindArrayLParams :: forall rep a.
SimplifiableRep rep =&gt;
[LParam (Wise rep)] -&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#bindArrayLParams"><span class="hs-identifier hs-var hs-var">bindArrayLParams</span></a></span></span><span> </span><span id="local-6989586621684370423"><span class="annot"><span class="annottext">[LParam (Wise rep)]
</span><a href="#local-6989586621684370423"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-244"></span><span>  </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
forall rep a.
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#localVtable"><span class="hs-identifier hs-var">localVtable</span></a></span><span> </span><span class="annot"><span class="annottext">((SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
 -&gt; SimpleM rep a -&gt; SimpleM rep a)
-&gt; (SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a
-&gt; SimpleM rep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684370422"><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684370422"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep)
 -&gt; Param (LParamInfo rep) -&gt; SymbolTable (Wise rep))
-&gt; SymbolTable (Wise rep)
-&gt; [Param (LParamInfo rep)]
-&gt; SymbolTable (Wise rep)
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Param (LParamInfo rep)
 -&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SymbolTable (Wise rep)
-&gt; Param (LParamInfo rep)
-&gt; SymbolTable (Wise rep)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">Param (LParamInfo rep)
-&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
forall rep.
ASTRep rep =&gt;
LParam rep -&gt; SymbolTable rep -&gt; SymbolTable rep
</span><a href="Futhark.Analysis.SymbolTable.html#insertLParam"><span class="hs-identifier hs-var">ST.insertLParam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684370422"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
[LParam (Wise rep)]
</span><a href="#local-6989586621684370423"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-245"></span><span>
</span><span id="line-246"></span><span id="local-6989586621684371186"><span id="local-6989586621684371189"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#bindMerge"><span class="hs-identifier hs-type">bindMerge</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-247"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371189"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371189"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-249"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371189"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371186"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371189"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371186"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-251"></span><span id="bindMerge"><span class="annot"><span class="annottext">bindMerge :: forall rep a.
SimplifiableRep rep =&gt;
[(FParam (Wise rep), SubExp, SubExpRes)]
-&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#bindMerge"><span class="hs-identifier hs-var hs-var">bindMerge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
forall rep a.
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#localVtable"><span class="hs-identifier hs-var">localVtable</span></a></span><span> </span><span class="annot"><span class="annottext">((SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
 -&gt; SimpleM rep a -&gt; SimpleM rep a)
-&gt; ([(Param (FParamInfo rep), SubExp, SubExpRes)]
    -&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; [(Param (FParamInfo rep), SubExp, SubExpRes)]
-&gt; SimpleM rep a
-&gt; SimpleM rep a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(Param (FParamInfo rep), SubExp, SubExpRes)]
-&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
forall rep.
ASTRep rep =&gt;
[(FParam rep, SubExp, SubExpRes)]
-&gt; SymbolTable rep -&gt; SymbolTable rep
</span><a href="Futhark.Analysis.SymbolTable.html#insertLoopMerge"><span class="hs-identifier hs-var">ST.insertLoopMerge</span></a></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span id="local-6989586621684371177"><span id="local-6989586621684371179"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#bindLoopVar"><span class="hs-identifier hs-type">bindLoopVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371179"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-type">IntType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371179"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371177"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371179"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371177"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-254"></span><span id="bindLoopVar"><span class="annot"><span class="annottext">bindLoopVar :: forall rep a.
SimplifiableRep rep =&gt;
VName -&gt; IntType -&gt; SubExp -&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#bindLoopVar"><span class="hs-identifier hs-var hs-var">bindLoopVar</span></a></span></span><span> </span><span id="local-6989586621684370407"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684370407"><span class="hs-identifier hs-var">var</span></a></span></span><span> </span><span id="local-6989586621684370406"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370406"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span id="local-6989586621684370405"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370405"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
forall rep a.
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#localVtable"><span class="hs-identifier hs-var">localVtable</span></a></span><span> </span><span class="annot"><span class="annottext">((SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
 -&gt; SimpleM rep a -&gt; SimpleM rep a)
-&gt; (SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a
-&gt; SimpleM rep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; IntType
-&gt; SubExp
-&gt; SymbolTable (Wise rep)
-&gt; SymbolTable (Wise rep)
forall rep.
ASTRep rep =&gt;
VName -&gt; IntType -&gt; SubExp -&gt; SymbolTable rep -&gt; SymbolTable rep
</span><a href="Futhark.Analysis.SymbolTable.html#insertLoopVar"><span class="hs-identifier hs-var">ST.insertLoopVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684370407"><span class="hs-identifier hs-var">var</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370406"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370405"><span class="hs-identifier hs-var">bound</span></a></span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span class="hs-comment">-- | We are willing to hoist potentially unsafe statements out of</span><span>
</span><span id="line-258"></span><span class="hs-comment">-- branches, but they most be protected by adding a branch on top of</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- them.  (This means such hoisting is not worth it unless they are in</span><span>
</span><span id="line-260"></span><span class="hs-comment">-- turn hoisted out of a loop somewhere.)</span><span>
</span><span id="line-261"></span><span id="local-6989586621684371172"><span id="local-6989586621684371173"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#protectIfHoisted"><span class="hs-identifier hs-type">protectIfHoisted</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-262"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371173"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-263"></span><span>  </span><span class="hs-comment">-- | Branch condition.</span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-265"></span><span>  </span><span class="hs-comment">-- | Which side of the branch are we</span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-comment">-- protecting here?</span><span>
</span><span id="line-267"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-268"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371173"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371173"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684371172"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371173"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371173"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684371172"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-270"></span><span id="protectIfHoisted"><span class="annot"><span class="annottext">protectIfHoisted :: forall rep a.
SimplifiableRep rep =&gt;
SubExp
-&gt; Bool
-&gt; SimpleM rep (Stms (Wise rep), a)
-&gt; SimpleM rep (Stms (Wise rep), a)
</span><a href="Futhark.Optimise.Simplify.Engine.html#protectIfHoisted"><span class="hs-identifier hs-var hs-var">protectIfHoisted</span></a></span></span><span> </span><span id="local-6989586621684370354"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370354"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684370353"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684370353"><span class="hs-identifier hs-var">side</span></a></span></span><span> </span><span id="local-6989586621684370352"><span class="annot"><span class="annottext">SimpleM rep (Stms (Wise rep), a)
</span><a href="#local-6989586621684370352"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684370351"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684370351"><span class="hs-identifier hs-var">hoisted</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370350"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684370350"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleM rep (Stms (Wise rep), a)
</span><a href="#local-6989586621684370352"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-272"></span><span>  </span><span id="local-6989586621684370349"><span class="annot"><span class="annottext">SubExp
-&gt; PatT (VarWisdom, LetDec rep)
-&gt; OpWithWisdom (Op rep)
-&gt; Maybe (Builder (Wise rep) ())
</span><a href="#local-6989586621684370349"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((SimpleOps rep, Env rep)
 -&gt; SubExp
 -&gt; PatT (VarWisdom, LetDec rep)
 -&gt; OpWithWisdom (Op rep)
 -&gt; Maybe (Builder (Wise rep) ()))
-&gt; SimpleM
     rep
     (SubExp
      -&gt; PatT (VarWisdom, LetDec rep)
      -&gt; OpWithWisdom (Op rep)
      -&gt; Maybe (Builder (Wise rep) ()))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">(((SimpleOps rep, Env rep)
  -&gt; SubExp
  -&gt; PatT (VarWisdom, LetDec rep)
  -&gt; OpWithWisdom (Op rep)
  -&gt; Maybe (Builder (Wise rep) ()))
 -&gt; SimpleM
      rep
      (SubExp
       -&gt; PatT (VarWisdom, LetDec rep)
       -&gt; OpWithWisdom (Op rep)
       -&gt; Maybe (Builder (Wise rep) ())))
-&gt; ((SimpleOps rep, Env rep)
    -&gt; SubExp
    -&gt; PatT (VarWisdom, LetDec rep)
    -&gt; OpWithWisdom (Op rep)
    -&gt; Maybe (Builder (Wise rep) ()))
-&gt; SimpleM
     rep
     (SubExp
      -&gt; PatT (VarWisdom, LetDec rep)
      -&gt; OpWithWisdom (Op rep)
      -&gt; Maybe (Builder (Wise rep) ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SimpleOps rep
-&gt; SubExp
-&gt; PatT (VarWisdom, LetDec rep)
-&gt; OpWithWisdom (Op rep)
-&gt; Maybe (Builder (Wise rep) ())
forall rep. SimpleOps rep -&gt; Protect (Builder (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#protectHoistedOpS"><span class="hs-identifier hs-var hs-var">protectHoistedOpS</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleOps rep
 -&gt; SubExp
 -&gt; PatT (VarWisdom, LetDec rep)
 -&gt; OpWithWisdom (Op rep)
 -&gt; Maybe (Builder (Wise rep) ()))
-&gt; ((SimpleOps rep, Env rep) -&gt; SimpleOps rep)
-&gt; (SimpleOps rep, Env rep)
-&gt; SubExp
-&gt; PatT (VarWisdom, LetDec rep)
-&gt; OpWithWisdom (Op rep)
-&gt; Maybe (Builder (Wise rep) ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SimpleOps rep, Env rep) -&gt; SimpleOps rep
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span>
</span><span id="line-273"></span><span>  </span><span id="local-6989586621684370348"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684370348"><span class="hs-identifier hs-var">hoisted'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Builder (Wise rep) () -&gt; SimpleM rep (Stms (Wise rep))
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilder_"><span class="hs-identifier hs-var">runBuilder_</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder (Wise rep) () -&gt; SimpleM rep (Stms (Wise rep)))
-&gt; Builder (Wise rep) () -&gt; SimpleM rep (Stms (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; Bool) -&gt; Stms (Wise rep) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp (Wise rep) -&gt; Bool
forall rep. IsOp (Op rep) =&gt; Exp rep -&gt; Bool
</span><a href="Futhark.IR.Prop.html#safeExp"><span class="hs-identifier hs-var">safeExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Wise rep) -&gt; Bool)
-&gt; (Stm (Wise rep) -&gt; Exp (Wise rep)) -&gt; Stm (Wise rep) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; Exp (Wise rep)
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684370351"><span class="hs-identifier hs-var">hoisted</span></a></span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-276"></span><span>        </span><span id="local-6989586621684370342"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370342"><span class="hs-identifier hs-var">cond'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-277"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684370353"><span class="hs-identifier hs-var">side</span></a></span><span>
</span><span id="line-278"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BuilderT (Wise rep) (State VNameSource) SubExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370354"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-279"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[Char]
-&gt; Exp (Rep (BuilderT (Wise rep) (State VNameSource)))
-&gt; BuilderT (Wise rep) (State VNameSource) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;cond_neg&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT (Wise rep) (State VNameSource)))
 -&gt; BuilderT (Wise rep) (State VNameSource) SubExp)
-&gt; Exp (Rep (BuilderT (Wise rep) (State VNameSource)))
-&gt; BuilderT (Wise rep) (State VNameSource) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Wise rep)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Wise rep)) -&gt; BasicOp -&gt; Exp (Wise rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UnOp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#UnOp"><span class="hs-identifier hs-var">UnOp</span></a></span><span> </span><span class="annot"><span class="annottext">UnOp
</span><a href="Futhark.IR.Primitive.html#Not"><span class="hs-identifier hs-var">Not</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370354"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-280"></span><span>        </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; Builder (Wise rep) ())
-&gt; Stms (Wise rep) -&gt; Builder (Wise rep) ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Protect (BuilderT (Wise rep) (State VNameSource))
-&gt; (Exp (Rep (BuilderT (Wise rep) (State VNameSource))) -&gt; Bool)
-&gt; SubExp
-&gt; Stm (Rep (BuilderT (Wise rep) (State VNameSource)))
-&gt; Builder (Wise rep) ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Protect m -&gt; (Exp (Rep m) -&gt; Bool) -&gt; SubExp -&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Optimise.Simplify.Engine.html#protectIf"><span class="hs-identifier hs-var">protectIf</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
-&gt; PatT (VarWisdom, LetDec rep)
-&gt; OpWithWisdom (Op rep)
-&gt; Maybe (Builder (Wise rep) ())
Protect (BuilderT (Wise rep) (State VNameSource))
</span><a href="#local-6989586621684370349"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">Exp (Rep (BuilderT (Wise rep) (State VNameSource))) -&gt; Bool
forall {rep}. ASTRep rep =&gt; Exp rep -&gt; Bool
</span><a href="#local-6989586621684370335"><span class="hs-identifier hs-var">unsafeOrCostly</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370342"><span class="hs-identifier hs-var">cond'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684370351"><span class="hs-identifier hs-var">hoisted</span></a></span><span>
</span><span id="line-281"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT (Wise rep) (State VNameSource)))
-&gt; Builder (Wise rep) ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT (Wise rep) (State VNameSource)))
Stms (Wise rep)
</span><a href="#local-6989586621684370351"><span class="hs-identifier hs-var">hoisted</span></a></span><span>
</span><span id="line-282"></span><span>  </span><span class="annot"><span class="annottext">(Stms (Wise rep), a) -&gt; SimpleM rep (Stms (Wise rep), a)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684370348"><span class="hs-identifier hs-var">hoisted'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684370350"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-284"></span><span>    </span><span id="local-6989586621684370335"><span class="annot"><span class="annottext">unsafeOrCostly :: Exp rep -&gt; Bool
</span><a href="#local-6989586621684370335"><span class="hs-identifier hs-var hs-var">unsafeOrCostly</span></a></span></span><span> </span><span id="local-6989586621684370324"><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684370324"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp rep -&gt; Bool
forall rep. IsOp (Op rep) =&gt; Exp rep -&gt; Bool
</span><a href="Futhark.IR.Prop.html#safeExp"><span class="hs-identifier hs-var">safeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684370324"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp rep -&gt; Bool
forall {rep}. ASTRep rep =&gt; Exp rep -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-var">cheapExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684370324"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span class="hs-comment">-- | We are willing to hoist potentially unsafe statements out of</span><span>
</span><span id="line-287"></span><span class="hs-comment">-- loops, but they most be protected by adding a branch on top of</span><span>
</span><span id="line-288"></span><span class="hs-comment">-- them.</span><span>
</span><span id="line-289"></span><span id="local-6989586621684371129"><span id="local-6989586621684371130"><span id="local-6989586621684371132"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#protectLoopHoisted"><span class="hs-identifier hs-type">protectLoopHoisted</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-290"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371132"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-291"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371132"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-292"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#LoopForm"><span class="hs-identifier hs-type">LoopForm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371132"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-293"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371132"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684371130"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684371129"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371132"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-294"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371132"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684371130"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684371129"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371132"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-295"></span><span id="protectLoopHoisted"><span class="annot"><span class="annottext">protectLoopHoisted :: forall rep a b.
SimplifiableRep rep =&gt;
[(FParam (Wise rep), SubExp)]
-&gt; LoopForm (Wise rep)
-&gt; SimpleM rep (a, b, Stms (Wise rep))
-&gt; SimpleM rep (a, b, Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#protectLoopHoisted"><span class="hs-identifier hs-var hs-var">protectLoopHoisted</span></a></span></span><span> </span><span id="local-6989586621684370273"><span class="annot"><span class="annottext">[(FParam (Wise rep), SubExp)]
</span><a href="#local-6989586621684370273"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684370272"><span class="annot"><span class="annottext">LoopForm (Wise rep)
</span><a href="#local-6989586621684370272"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684370271"><span class="annot"><span class="annottext">SimpleM rep (a, b, Stms (Wise rep))
</span><a href="#local-6989586621684370271"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684370270"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684370270"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370269"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684370269"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370268"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684370268"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleM rep (a, b, Stms (Wise rep))
</span><a href="#local-6989586621684370271"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-297"></span><span>  </span><span id="local-6989586621684370267"><span class="annot"><span class="annottext">SubExp
-&gt; PatT (VarWisdom, LetDec rep)
-&gt; OpWithWisdom (Op rep)
-&gt; Maybe (Builder (Wise rep) ())
</span><a href="#local-6989586621684370267"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((SimpleOps rep, Env rep)
 -&gt; SubExp
 -&gt; PatT (VarWisdom, LetDec rep)
 -&gt; OpWithWisdom (Op rep)
 -&gt; Maybe (Builder (Wise rep) ()))
-&gt; SimpleM
     rep
     (SubExp
      -&gt; PatT (VarWisdom, LetDec rep)
      -&gt; OpWithWisdom (Op rep)
      -&gt; Maybe (Builder (Wise rep) ()))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">(((SimpleOps rep, Env rep)
  -&gt; SubExp
  -&gt; PatT (VarWisdom, LetDec rep)
  -&gt; OpWithWisdom (Op rep)
  -&gt; Maybe (Builder (Wise rep) ()))
 -&gt; SimpleM
      rep
      (SubExp
       -&gt; PatT (VarWisdom, LetDec rep)
       -&gt; OpWithWisdom (Op rep)
       -&gt; Maybe (Builder (Wise rep) ())))
-&gt; ((SimpleOps rep, Env rep)
    -&gt; SubExp
    -&gt; PatT (VarWisdom, LetDec rep)
    -&gt; OpWithWisdom (Op rep)
    -&gt; Maybe (Builder (Wise rep) ()))
-&gt; SimpleM
     rep
     (SubExp
      -&gt; PatT (VarWisdom, LetDec rep)
      -&gt; OpWithWisdom (Op rep)
      -&gt; Maybe (Builder (Wise rep) ()))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SimpleOps rep
-&gt; SubExp
-&gt; PatT (VarWisdom, LetDec rep)
-&gt; OpWithWisdom (Op rep)
-&gt; Maybe (Builder (Wise rep) ())
forall rep. SimpleOps rep -&gt; Protect (Builder (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#protectHoistedOpS"><span class="hs-identifier hs-var hs-var">protectHoistedOpS</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleOps rep
 -&gt; SubExp
 -&gt; PatT (VarWisdom, LetDec rep)
 -&gt; OpWithWisdom (Op rep)
 -&gt; Maybe (Builder (Wise rep) ()))
-&gt; ((SimpleOps rep, Env rep) -&gt; SimpleOps rep)
-&gt; (SimpleOps rep, Env rep)
-&gt; SubExp
-&gt; PatT (VarWisdom, LetDec rep)
-&gt; OpWithWisdom (Op rep)
-&gt; Maybe (Builder (Wise rep) ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SimpleOps rep, Env rep) -&gt; SimpleOps rep
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span>
</span><span id="line-298"></span><span>  </span><span id="local-6989586621684370266"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684370266"><span class="hs-identifier hs-var">stms'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Builder (Wise rep) () -&gt; SimpleM rep (Stms (Wise rep))
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilder_"><span class="hs-identifier hs-var">runBuilder_</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder (Wise rep) () -&gt; SimpleM rep (Stms (Wise rep)))
-&gt; Builder (Wise rep) () -&gt; SimpleM rep (Stms (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; Bool) -&gt; Stms (Wise rep) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp (Wise rep) -&gt; Bool
forall rep. IsOp (Op rep) =&gt; Exp rep -&gt; Bool
</span><a href="Futhark.IR.Prop.html#safeExp"><span class="hs-identifier hs-var">safeExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Wise rep) -&gt; Bool)
-&gt; (Stm (Wise rep) -&gt; Exp (Wise rep)) -&gt; Stm (Wise rep) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; Exp (Wise rep)
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684370268"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-300"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-301"></span><span>        </span><span id="local-6989586621684370265"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370265"><span class="hs-identifier hs-var">is_nonempty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BuilderT (Wise rep) (State VNameSource) SubExp
</span><a href="#local-6989586621684370264"><span class="hs-identifier hs-var">checkIfNonEmpty</span></a></span><span>
</span><span id="line-302"></span><span>        </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; Builder (Wise rep) ())
-&gt; Stms (Wise rep) -&gt; Builder (Wise rep) ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Protect (BuilderT (Wise rep) (State VNameSource))
-&gt; (Exp (Rep (BuilderT (Wise rep) (State VNameSource))) -&gt; Bool)
-&gt; SubExp
-&gt; Stm (Rep (BuilderT (Wise rep) (State VNameSource)))
-&gt; Builder (Wise rep) ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Protect m -&gt; (Exp (Rep m) -&gt; Bool) -&gt; SubExp -&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Optimise.Simplify.Engine.html#protectIf"><span class="hs-identifier hs-var">protectIf</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
-&gt; PatT (VarWisdom, LetDec rep)
-&gt; OpWithWisdom (Op rep)
-&gt; Maybe (Builder (Wise rep) ())
Protect (BuilderT (Wise rep) (State VNameSource))
</span><a href="#local-6989586621684370267"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; (Exp (Wise rep) -&gt; Bool) -&gt; Exp (Wise rep) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Exp (Wise rep) -&gt; Bool
forall rep. IsOp (Op rep) =&gt; Exp rep -&gt; Bool
</span><a href="Futhark.IR.Prop.html#safeExp"><span class="hs-identifier hs-var">safeExp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370265"><span class="hs-identifier hs-var">is_nonempty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684370268"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-303"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT (Wise rep) (State VNameSource)))
-&gt; Builder (Wise rep) ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT (Wise rep) (State VNameSource)))
Stms (Wise rep)
</span><a href="#local-6989586621684370268"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-304"></span><span>  </span><span class="annot"><span class="annottext">(a, b, Stms (Wise rep)) -&gt; SimpleM rep (a, b, Stms (Wise rep))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684370270"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684370269"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684370266"><span class="hs-identifier hs-var">stms'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621684370264"><span class="annot"><span class="annottext">checkIfNonEmpty :: BuilderT (Wise rep) (State VNameSource) SubExp
</span><a href="#local-6989586621684370264"><span class="hs-identifier hs-var hs-var">checkIfNonEmpty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-307"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LoopForm (Wise rep)
</span><a href="#local-6989586621684370272"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-308"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.html#WhileLoop"><span class="hs-identifier hs-type">WhileLoop</span></a></span><span> </span><span id="local-6989586621684370262"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684370262"><span class="hs-identifier hs-var">cond</span></a></span></span><span>
</span><span id="line-309"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (FParamInfo rep)
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370261"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370261"><span class="hs-identifier hs-var">cond_init</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-310"></span><span>              </span><span class="annot"><span class="annottext">((Param (FParamInfo rep), SubExp) -&gt; Bool)
-&gt; [(Param (FParamInfo rep), SubExp)]
-&gt; Maybe (Param (FParamInfo rep), SubExp)
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684370262"><span class="hs-identifier hs-var">cond</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; ((Param (FParamInfo rep), SubExp) -&gt; VName)
-&gt; (Param (FParamInfo rep), SubExp)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param (FParamInfo rep) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">(Param (FParamInfo rep) -&gt; VName)
-&gt; ((Param (FParamInfo rep), SubExp) -&gt; Param (FParamInfo rep))
-&gt; (Param (FParamInfo rep), SubExp)
-&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Param (FParamInfo rep), SubExp) -&gt; Param (FParamInfo rep)
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Param (FParamInfo rep), SubExp)]
[(FParam (Wise rep), SubExp)]
</span><a href="#local-6989586621684370273"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-311"></span><span>            </span><span class="annot"><span class="annottext">SubExp -&gt; BuilderT (Wise rep) (State VNameSource) SubExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370261"><span class="hs-identifier hs-var">cond_init</span></a></span><span>
</span><span id="line-312"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BuilderT (Wise rep) (State VNameSource) SubExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BuilderT (Wise rep) (State VNameSource) SubExp)
-&gt; SubExp -&gt; BuilderT (Wise rep) (State VNameSource) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; SubExp
forall v. IsValue v =&gt; v -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#constant"><span class="hs-identifier hs-var">constant</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- infinite loop</span><span>
</span><span id="line-313"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.html#ForLoop"><span class="hs-identifier hs-type">ForLoop</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684370257"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370257"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span id="local-6989586621684370256"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370256"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span class="annot"><span class="annottext">[(LParam (Wise rep), VName)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-314"></span><span>          </span><span class="annot"><span class="annottext">[Char]
-&gt; Exp (Rep (BuilderT (Wise rep) (State VNameSource)))
-&gt; BuilderT (Wise rep) (State VNameSource) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;loop_nonempty&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT (Wise rep) (State VNameSource)))
 -&gt; BuilderT (Wise rep) (State VNameSource) SubExp)
-&gt; Exp (Rep (BuilderT (Wise rep) (State VNameSource)))
-&gt; BuilderT (Wise rep) (State VNameSource) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-315"></span><span>            </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Wise rep)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Wise rep)) -&gt; BasicOp -&gt; Exp (Wise rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">CmpOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#CmpOp"><span class="hs-identifier hs-var">CmpOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; CmpOp
</span><a href="Futhark.IR.Primitive.html#CmpSlt"><span class="hs-identifier hs-var">CmpSlt</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370257"><span class="hs-identifier hs-var">it</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370257"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370256"><span class="hs-identifier hs-var">bound</span></a></span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span id="local-6989586621684371135"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#protectIf"><span class="hs-identifier hs-type">protectIf</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-318"></span><span>  </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371135"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-319"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Protect"><span class="hs-identifier hs-type">Protect</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371135"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-320"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371135"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-321"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-322"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371135"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-323"></span><span>  </span><span class="annot"><a href="#local-6989586621684371135"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-324"></span><span id="protectIf"><span class="annot"><span class="annottext">protectIf :: forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Protect m -&gt; (Exp (Rep m) -&gt; Bool) -&gt; SubExp -&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Optimise.Simplify.Engine.html#protectIf"><span class="hs-identifier hs-var hs-var">protectIf</span></a></span></span><span> </span><span class="annot"><span class="annottext">Protect m
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Exp (Rep m) -&gt; Bool
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684370203"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370203"><span class="hs-identifier hs-var">taken</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684370201"><span class="annot"><span class="annottext">Pat (Rep m)
</span><a href="#local-6989586621684370201"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684370200"><span class="annot"><span class="annottext">StmAux (ExpDec (Rep m))
</span><a href="#local-6989586621684370200"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span id="local-6989586621684370198"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370198"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684370197"><span class="annot"><span class="annottext">BodyT (Rep m)
</span><a href="#local-6989586621684370197"><span class="hs-identifier hs-var">taken_body</span></a></span></span><span> </span><span id="local-6989586621684370196"><span class="annot"><span class="annottext">BodyT (Rep m)
</span><a href="#local-6989586621684370196"><span class="hs-identifier hs-var">untaken_body</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-type">IfDec</span></a></span><span> </span><span id="local-6989586621684370194"><span class="annot"><span class="annottext">[BranchType (Rep m)]
</span><a href="#local-6989586621684370194"><span class="hs-identifier hs-var">if_ts</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="Futhark.IR.Syntax.html#IfFallback"><span class="hs-identifier hs-var">IfFallback</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-325"></span><span>  </span><span id="local-6989586621684370192"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370192"><span class="hs-identifier hs-var">cond'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;protect_cond_conj&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m SubExp) -&gt; Exp (Rep m) -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="Futhark.IR.Primitive.html#LogAnd"><span class="hs-identifier hs-var">LogAnd</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370203"><span class="hs-identifier hs-var">taken</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370198"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-326"></span><span>  </span><span class="annot"><span class="annottext">StmAux (ExpDec (Rep m)) -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec (Rep m))
</span><a href="#local-6989586621684370200"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; (Exp (Rep m) -&gt; m ()) -&gt; Exp (Rep m) -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m)
</span><a href="#local-6989586621684370201"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m ()) -&gt; Exp (Rep m) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><span class="annottext">SubExp
-&gt; BodyT (Rep m)
-&gt; BodyT (Rep m)
-&gt; IfDec (BranchType (Rep m))
-&gt; Exp (Rep m)
forall rep.
SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370192"><span class="hs-identifier hs-var">cond'</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Rep m)
</span><a href="#local-6989586621684370197"><span class="hs-identifier hs-var">taken_body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Rep m)
</span><a href="#local-6989586621684370196"><span class="hs-identifier hs-var">untaken_body</span></a></span><span> </span><span class="annot"><span class="annottext">(IfDec (BranchType (Rep m)) -&gt; Exp (Rep m))
-&gt; IfDec (BranchType (Rep m)) -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[BranchType (Rep m)] -&gt; IfSort -&gt; IfDec (BranchType (Rep m))
forall rt. [rt] -&gt; IfSort -&gt; IfDec rt
</span><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-var">IfDec</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType (Rep m)]
</span><a href="#local-6989586621684370194"><span class="hs-identifier hs-var">if_ts</span></a></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="Futhark.IR.Syntax.html#IfFallback"><span class="hs-identifier hs-var">IfFallback</span></a></span><span>
</span><span id="line-328"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#protectIf"><span class="hs-identifier hs-var">protectIf</span></a></span><span> </span><span class="annot"><span class="annottext">Protect m
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Exp (Rep m) -&gt; Bool
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684370187"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370187"><span class="hs-identifier hs-var">taken</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684370186"><span class="annot"><span class="annottext">Pat (Rep m)
</span><a href="#local-6989586621684370186"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684370185"><span class="annot"><span class="annottext">StmAux (ExpDec (Rep m))
</span><a href="#local-6989586621684370185"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Assert"><span class="hs-identifier hs-type">Assert</span></a></span><span> </span><span id="local-6989586621684370183"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370183"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684370182"><span class="annot"><span class="annottext">ErrorMsg SubExp
</span><a href="#local-6989586621684370182"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span id="local-6989586621684370181"><span class="annot"><span class="annottext">(SrcLoc, [SrcLoc])
</span><a href="#local-6989586621684370181"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-329"></span><span>  </span><span id="local-6989586621684370180"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370180"><span class="hs-identifier hs-var">not_taken</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;loop_not_taken&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m SubExp) -&gt; Exp (Rep m) -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UnOp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#UnOp"><span class="hs-identifier hs-var">UnOp</span></a></span><span> </span><span class="annot"><span class="annottext">UnOp
</span><a href="Futhark.IR.Primitive.html#Not"><span class="hs-identifier hs-var">Not</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370187"><span class="hs-identifier hs-var">taken</span></a></span><span>
</span><span id="line-330"></span><span>  </span><span id="local-6989586621684370179"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370179"><span class="hs-identifier hs-var">cond'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Char] -&gt; Exp (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[Char] -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;protect_assert_disj&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m SubExp) -&gt; Exp (Rep m) -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="Futhark.IR.Primitive.html#LogOr"><span class="hs-identifier hs-var">LogOr</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370180"><span class="hs-identifier hs-var">not_taken</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370183"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-331"></span><span>  </span><span class="annot"><span class="annottext">StmAux (ExpDec (Rep m)) -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec (Rep m))
</span><a href="#local-6989586621684370185"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m)
</span><a href="#local-6989586621684370186"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m ()) -&gt; Exp (Rep m) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ErrorMsg SubExp -&gt; (SrcLoc, [SrcLoc]) -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Assert"><span class="hs-identifier hs-var">Assert</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370179"><span class="hs-identifier hs-var">cond'</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorMsg SubExp
</span><a href="#local-6989586621684370182"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="annot"><span class="annottext">(SrcLoc, [SrcLoc])
</span><a href="#local-6989586621684370181"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-332"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#protectIf"><span class="hs-identifier hs-var">protectIf</span></a></span><span> </span><span id="local-6989586621684370177"><span class="annot"><span class="annottext">Protect m
</span><a href="#local-6989586621684370177"><span class="hs-identifier hs-var">protect</span></a></span></span><span> </span><span class="annot"><span class="annottext">Exp (Rep m) -&gt; Bool
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684370176"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370176"><span class="hs-identifier hs-var">taken</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684370175"><span class="annot"><span class="annottext">Pat (Rep m)
</span><a href="#local-6989586621684370175"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684370174"><span class="annot"><span class="annottext">StmAux (ExpDec (Rep m))
</span><a href="#local-6989586621684370174"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span id="local-6989586621684370172"><span class="annot"><span class="annottext">Op (Rep m)
</span><a href="#local-6989586621684370172"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684370171"><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621684370171"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Protect m
</span><a href="#local-6989586621684370177"><span class="hs-identifier hs-var">protect</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370176"><span class="hs-identifier hs-var">taken</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m)
</span><a href="#local-6989586621684370175"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Op (Rep m)
</span><a href="#local-6989586621684370172"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-334"></span><span>    </span><span class="annot"><span class="annottext">StmAux (ExpDec (Rep m)) -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec (Rep m))
</span><a href="#local-6989586621684370174"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">m ()
</span><a href="#local-6989586621684370171"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-335"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#protectIf"><span class="hs-identifier hs-var">protectIf</span></a></span><span> </span><span class="annot"><span class="annottext">Protect m
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684370170"><span class="annot"><span class="annottext">Exp (Rep m) -&gt; Bool
</span><a href="#local-6989586621684370170"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684370169"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370169"><span class="hs-identifier hs-var">taken</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684370168"><span class="annot"><span class="annottext">Pat (Rep m)
</span><a href="#local-6989586621684370168"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684370167"><span class="annot"><span class="annottext">StmAux (ExpDec (Rep m))
</span><a href="#local-6989586621684370167"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684370166"><span class="annot"><span class="annottext">Exp (Rep m)
</span><a href="#local-6989586621684370166"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Exp (Rep m) -&gt; Bool
</span><a href="#local-6989586621684370170"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Exp (Rep m)
</span><a href="#local-6989586621684370166"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-337"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Exp (Rep m) -&gt; Maybe (Exp (Rep m))
forall rep. Exp rep -&gt; Maybe (Exp rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#makeSafe"><span class="hs-identifier hs-var">makeSafe</span></a></span><span> </span><span class="annot"><span class="annottext">Exp (Rep m)
</span><a href="#local-6989586621684370166"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-338"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684370164"><span class="annot"><span class="annottext">Exp (Rep m)
</span><a href="#local-6989586621684370164"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-339"></span><span>        </span><span class="annot"><span class="annottext">StmAux (ExpDec (Rep m)) -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec (Rep m))
</span><a href="#local-6989586621684370167"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m)
</span><a href="#local-6989586621684370168"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Exp (Rep m)
</span><a href="#local-6989586621684370164"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-340"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Exp (Rep m))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-341"></span><span>        </span><span id="local-6989586621684370163"><span class="annot"><span class="annottext">BodyT (Rep m)
</span><a href="#local-6989586621684370163"><span class="hs-identifier hs-var">taken_body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[m (Exp (Rep m))] -&gt; m (BodyT (Rep m))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[m (Exp (Rep m))] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#eBody"><span class="hs-identifier hs-var">eBody</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Exp (Rep m) -&gt; m (Exp (Rep m))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Exp (Rep m)
</span><a href="#local-6989586621684370166"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-342"></span><span>        </span><span id="local-6989586621684370161"><span class="annot"><span class="annottext">BodyT (Rep m)
</span><a href="#local-6989586621684370161"><span class="hs-identifier hs-var">untaken_body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-343"></span><span>          </span><span class="annot"><span class="annottext">[m (Exp (Rep m))] -&gt; m (BodyT (Rep m))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[m (Exp (Rep m))] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#eBody"><span class="hs-identifier hs-var">eBody</span></a></span><span> </span><span class="annot"><span class="annottext">([m (Exp (Rep m))] -&gt; m (BodyT (Rep m)))
-&gt; [m (Exp (Rep m))] -&gt; m (BodyT (Rep m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; m (Exp (Rep m))) -&gt; [Type] -&gt; [m (Exp (Rep m))]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Type -&gt; m (Exp (Rep m))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Type -&gt; m (Exp (Rep m))
</span><a href="Futhark.Optimise.Simplify.Engine.html#emptyOfType"><span class="hs-identifier hs-var">emptyOfType</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Type -&gt; m (Exp (Rep m)))
-&gt; [VName] -&gt; Type -&gt; m (Exp (Rep m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m)
</span><a href="#local-6989586621684370168"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat (Rep m) -&gt; [Type]
forall dec. Typed dec =&gt; PatT dec -&gt; [Type]
</span><a href="Futhark.IR.Prop.Patterns.html#patTypes"><span class="hs-identifier hs-var">patTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m)
</span><a href="#local-6989586621684370168"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-344"></span><span>        </span><span id="local-6989586621684370157"><span class="annot"><span class="annottext">[BranchType (Rep m)]
</span><a href="#local-6989586621684370157"><span class="hs-identifier hs-var">if_ts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat (Rep m) -&gt; m [BranchType (Rep m)]
forall rep (m :: * -&gt; *).
(ASTRep rep, HasScope rep m, Monad m) =&gt;
Pat rep -&gt; m [BranchType rep]
</span><a href="Futhark.IR.Prop.html#expTypesFromPat"><span class="hs-identifier hs-var">expTypesFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m)
</span><a href="#local-6989586621684370168"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-345"></span><span>        </span><span class="annot"><span class="annottext">StmAux (ExpDec (Rep m)) -&gt; m () -&gt; m ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec (Rep m))
</span><a href="#local-6989586621684370167"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; (Exp (Rep m) -&gt; m ()) -&gt; Exp (Rep m) -&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m)
</span><a href="#local-6989586621684370168"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m ()) -&gt; Exp (Rep m) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-346"></span><span>          </span><span class="annot"><span class="annottext">SubExp
-&gt; BodyT (Rep m)
-&gt; BodyT (Rep m)
-&gt; IfDec (BranchType (Rep m))
-&gt; Exp (Rep m)
forall rep.
SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370169"><span class="hs-identifier hs-var">taken</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Rep m)
</span><a href="#local-6989586621684370163"><span class="hs-identifier hs-var">taken_body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Rep m)
</span><a href="#local-6989586621684370161"><span class="hs-identifier hs-var">untaken_body</span></a></span><span> </span><span class="annot"><span class="annottext">(IfDec (BranchType (Rep m)) -&gt; Exp (Rep m))
-&gt; IfDec (BranchType (Rep m)) -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[BranchType (Rep m)] -&gt; IfSort -&gt; IfDec (BranchType (Rep m))
forall rt. [rt] -&gt; IfSort -&gt; IfDec rt
</span><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-var">IfDec</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType (Rep m)]
</span><a href="#local-6989586621684370157"><span class="hs-identifier hs-var">if_ts</span></a></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="Futhark.IR.Syntax.html#IfFallback"><span class="hs-identifier hs-var">IfFallback</span></a></span><span>
</span><span id="line-347"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#protectIf"><span class="hs-identifier hs-var">protectIf</span></a></span><span> </span><span class="annot"><span class="annottext">Protect m
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Exp (Rep m) -&gt; Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684370155"><span class="annot"><span class="annottext">Stm (Rep m)
</span><a href="#local-6989586621684370155"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-348"></span><span>  </span><span class="annot"><span class="annottext">Stm (Rep m) -&gt; m ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStm"><span class="hs-identifier hs-var">addStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Rep m)
</span><a href="#local-6989586621684370155"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span id="local-6989586621684371103"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#makeSafe"><span class="hs-identifier hs-type">makeSafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371103"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371103"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-351"></span><span id="makeSafe"><span class="annot"><span class="annottext">makeSafe :: forall rep. Exp rep -&gt; Maybe (Exp rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#makeSafe"><span class="hs-identifier hs-var hs-var">makeSafe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#SDiv"><span class="hs-identifier hs-type">SDiv</span></a></span><span> </span><span id="local-6989586621684370152"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370152"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">Safety
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684370151"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370151"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684370150"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370150"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-352"></span><span>  </span><span class="annot"><span class="annottext">ExpT rep -&gt; Maybe (ExpT rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Maybe (ExpT rep)) -&gt; ExpT rep -&gt; Maybe (ExpT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Safety -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SDiv"><span class="hs-identifier hs-var">SDiv</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370152"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Safe"><span class="hs-identifier hs-var">Safe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370151"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370150"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#makeSafe"><span class="hs-identifier hs-var">makeSafe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#SDivUp"><span class="hs-identifier hs-type">SDivUp</span></a></span><span> </span><span id="local-6989586621684370147"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370147"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">Safety
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684370146"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370146"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684370145"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370145"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-354"></span><span>  </span><span class="annot"><span class="annottext">ExpT rep -&gt; Maybe (ExpT rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Maybe (ExpT rep)) -&gt; ExpT rep -&gt; Maybe (ExpT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Safety -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SDivUp"><span class="hs-identifier hs-var">SDivUp</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370147"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Safe"><span class="hs-identifier hs-var">Safe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370146"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370145"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#makeSafe"><span class="hs-identifier hs-var">makeSafe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#SQuot"><span class="hs-identifier hs-type">SQuot</span></a></span><span> </span><span id="local-6989586621684370143"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370143"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">Safety
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684370142"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370142"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684370141"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370141"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-356"></span><span>  </span><span class="annot"><span class="annottext">ExpT rep -&gt; Maybe (ExpT rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Maybe (ExpT rep)) -&gt; ExpT rep -&gt; Maybe (ExpT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Safety -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SQuot"><span class="hs-identifier hs-var">SQuot</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370143"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Safe"><span class="hs-identifier hs-var">Safe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370142"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370141"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#makeSafe"><span class="hs-identifier hs-var">makeSafe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#UDiv"><span class="hs-identifier hs-type">UDiv</span></a></span><span> </span><span id="local-6989586621684370139"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370139"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">Safety
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684370138"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370138"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684370137"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370137"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-358"></span><span>  </span><span class="annot"><span class="annottext">ExpT rep -&gt; Maybe (ExpT rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Maybe (ExpT rep)) -&gt; ExpT rep -&gt; Maybe (ExpT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Safety -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#UDiv"><span class="hs-identifier hs-var">UDiv</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370139"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Safe"><span class="hs-identifier hs-var">Safe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370138"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370137"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#makeSafe"><span class="hs-identifier hs-var">makeSafe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#UDivUp"><span class="hs-identifier hs-type">UDivUp</span></a></span><span> </span><span id="local-6989586621684370135"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370135"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">Safety
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684370134"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370134"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684370133"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370133"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-360"></span><span>  </span><span class="annot"><span class="annottext">ExpT rep -&gt; Maybe (ExpT rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Maybe (ExpT rep)) -&gt; ExpT rep -&gt; Maybe (ExpT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Safety -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#UDivUp"><span class="hs-identifier hs-var">UDivUp</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370135"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Safe"><span class="hs-identifier hs-var">Safe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370134"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370133"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#makeSafe"><span class="hs-identifier hs-var">makeSafe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#SMod"><span class="hs-identifier hs-type">SMod</span></a></span><span> </span><span id="local-6989586621684370131"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370131"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">Safety
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684370130"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370130"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684370129"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370129"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-362"></span><span>  </span><span class="annot"><span class="annottext">ExpT rep -&gt; Maybe (ExpT rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Maybe (ExpT rep)) -&gt; ExpT rep -&gt; Maybe (ExpT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Safety -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SMod"><span class="hs-identifier hs-var">SMod</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370131"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Safe"><span class="hs-identifier hs-var">Safe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370130"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370129"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#makeSafe"><span class="hs-identifier hs-var">makeSafe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#SRem"><span class="hs-identifier hs-type">SRem</span></a></span><span> </span><span id="local-6989586621684370127"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370127"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">Safety
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684370126"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370126"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684370125"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370125"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-364"></span><span>  </span><span class="annot"><span class="annottext">ExpT rep -&gt; Maybe (ExpT rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Maybe (ExpT rep)) -&gt; ExpT rep -&gt; Maybe (ExpT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Safety -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SRem"><span class="hs-identifier hs-var">SRem</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370127"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Safe"><span class="hs-identifier hs-var">Safe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370126"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370125"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-365"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#makeSafe"><span class="hs-identifier hs-var">makeSafe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Primitive.html#UMod"><span class="hs-identifier hs-type">UMod</span></a></span><span> </span><span id="local-6989586621684370123"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370123"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">Safety
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684370122"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370122"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684370121"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370121"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-366"></span><span>  </span><span class="annot"><span class="annottext">ExpT rep -&gt; Maybe (ExpT rep)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(ExpT rep -&gt; Maybe (ExpT rep)) -&gt; ExpT rep -&gt; Maybe (ExpT rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Safety -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#UMod"><span class="hs-identifier hs-var">UMod</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684370123"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Safe"><span class="hs-identifier hs-var">Safe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370122"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370121"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-367"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#makeSafe"><span class="hs-identifier hs-var">makeSafe</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-368"></span><span>  </span><span class="annot"><span class="annottext">Maybe (ExpT rep)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-369"></span><span>
</span><span id="line-370"></span><span id="local-6989586621684371099"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#emptyOfType"><span class="hs-identifier hs-type">emptyOfType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371099"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684371099"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371099"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-371"></span><span id="emptyOfType"><span class="annot"><span class="annottext">emptyOfType :: forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Type -&gt; m (Exp (Rep m))
</span><a href="Futhark.Optimise.Simplify.Engine.html#emptyOfType"><span class="hs-identifier hs-var hs-var">emptyOfType</span></a></span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-372"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; m (ExpT (Rep m))
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;emptyOfType: Cannot hoist non-existential memory.&quot;</span></span><span>
</span><span id="line-373"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#emptyOfType"><span class="hs-identifier hs-var">emptyOfType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-374"></span><span>  </span><span class="annot"><span class="annottext">[Char] -&gt; m (ExpT (Rep m))
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;emptyOfType: Cannot hoist accumulator.&quot;</span></span><span>
</span><span id="line-375"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#emptyOfType"><span class="hs-identifier hs-var">emptyOfType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684370105"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684370105"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-376"></span><span>  </span><span class="annot"><span class="annottext">ExpT (Rep m) -&gt; m (ExpT (Rep m))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ExpT (Rep m) -&gt; m (ExpT (Rep m)))
-&gt; ExpT (Rep m) -&gt; m (ExpT (Rep m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT (Rep m)) -&gt; BasicOp -&gt; ExpT (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-var">Constant</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimValue -&gt; SubExp) -&gt; PrimValue -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; PrimValue
</span><a href="Futhark.IR.Primitive.html#blankPrimValue"><span class="hs-identifier hs-var">blankPrimValue</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684370105"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-377"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#emptyOfType"><span class="hs-identifier hs-var">emptyOfType</span></a></span><span> </span><span id="local-6989586621684370101"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684370101"><span class="hs-identifier hs-var">ctx_names</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684370099"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684370099"><span class="hs-identifier hs-var">et</span></a></span></span><span> </span><span id="local-6989586621684370098"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684370098"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-378"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684370097"><span class="annot"><span class="annottext">dims :: [SubExp]
</span><a href="#local-6989586621684370097"><span class="hs-identifier hs-var hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExp) -&gt; [SubExp] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp
</span><a href="#local-6989586621684370096"><span class="hs-identifier hs-var">zeroIfContext</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [SubExp]) -&gt; [SubExp] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684370098"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-379"></span><span>  </span><span class="annot"><span class="annottext">ExpT (Rep m) -&gt; m (ExpT (Rep m))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ExpT (Rep m) -&gt; m (ExpT (Rep m)))
-&gt; ExpT (Rep m) -&gt; m (ExpT (Rep m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT (Rep m)) -&gt; BasicOp -&gt; ExpT (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; [SubExp] -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Scratch"><span class="hs-identifier hs-var">Scratch</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684370099"><span class="hs-identifier hs-var">et</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684370097"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-380"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-381"></span><span>    </span><span id="local-6989586621684370096"><span class="annot"><span class="annottext">zeroIfContext :: SubExp -&gt; SubExp
</span><a href="#local-6989586621684370096"><span class="hs-identifier hs-var hs-var">zeroIfContext</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684370092"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684370092"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684370092"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684370101"><span class="hs-identifier hs-var">ctx_names</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span>
</span><span id="line-382"></span><span>    </span><span class="annot"><a href="#local-6989586621684370096"><span class="hs-identifier hs-var">zeroIfContext</span></a></span><span> </span><span id="local-6989586621684370089"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370089"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684370089"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span class="hs-comment">-- | Statements that are not worth hoisting out of loops, because they</span><span>
</span><span id="line-385"></span><span class="hs-comment">-- are unsafe, and added safety (by 'protectLoopHoisted') may inhibit</span><span>
</span><span id="line-386"></span><span class="hs-comment">-- further optimisation..</span><span>
</span><span id="line-387"></span><span id="local-6989586621684371085"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#notWorthHoisting"><span class="hs-identifier hs-type">notWorthHoisting</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371085"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371085"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-388"></span><span id="notWorthHoisting"><span class="annot"><span class="annottext">notWorthHoisting :: forall rep. ASTRep rep =&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#notWorthHoisting"><span class="hs-identifier hs-var hs-var">notWorthHoisting</span></a></span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684370070"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684370070"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684370069"><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684370069"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-389"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp rep -&gt; Bool
forall rep. IsOp (Op rep) =&gt; Exp rep -&gt; Bool
</span><a href="Futhark.IR.Prop.html#safeExp"><span class="hs-identifier hs-var">safeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684370069"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Bool) -&gt; [Type] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Bool) -&gt; (Type -&gt; Int) -&gt; Type -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [Type]
forall dec. Typed dec =&gt; PatT dec -&gt; [Type]
</span><a href="Futhark.IR.Prop.Patterns.html#patTypes"><span class="hs-identifier hs-var">patTypes</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684370070"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-390"></span><span>
</span><span id="line-391"></span><span class="hs-comment">-- Top-down simplify a statement (including copy propagation into the</span><span>
</span><span id="line-392"></span><span class="hs-comment">-- pattern and such).  Does not recurse into any sub-Bodies or Ops.</span><span>
</span><span id="line-393"></span><span id="local-6989586621684371078"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#nonrecSimplifyStm"><span class="hs-identifier hs-type">nonrecSimplifyStm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-394"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371078"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-395"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371078"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-396"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371078"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371078"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-397"></span><span id="nonrecSimplifyStm"><span class="annot"><span class="annottext">nonrecSimplifyStm :: forall rep.
SimplifiableRep rep =&gt;
Stm (Wise rep) -&gt; SimpleM rep (Stm (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#nonrecSimplifyStm"><span class="hs-identifier hs-var hs-var">nonrecSimplifyStm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684370035"><span class="annot"><span class="annottext">Pat (Wise rep)
</span><a href="#local-6989586621684370035"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684370033"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370033"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684370032"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684370032"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpWisdom
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370031"><span class="annot"><span class="annottext">ExpDec rep
</span><a href="#local-6989586621684370031"><span class="hs-identifier hs-var">dec</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684370030"><span class="annot"><span class="annottext">Exp (Wise rep)
</span><a href="#local-6989586621684370030"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-398"></span><span>  </span><span id="local-6989586621684370029"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370029"><span class="hs-identifier hs-var">cs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; SimpleM rep Certs
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370033"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-399"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684370027"><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><a href="#local-6989586621684370027"><span class="hs-identifier hs-var">pat'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684370026"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370026"><span class="hs-identifier hs-var">pat_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleM rep (PatT (LetDec rep))
-&gt; SimpleM rep (PatT (LetDec rep), Certs)
forall rep a. SimpleM rep a -&gt; SimpleM rep (a, Certs)
</span><a href="Futhark.Optimise.Simplify.Engine.html#collectCerts"><span class="hs-identifier hs-var">collectCerts</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep (PatT (LetDec rep))
 -&gt; SimpleM rep (PatT (LetDec rep), Certs))
-&gt; SimpleM rep (PatT (LetDec rep))
-&gt; SimpleM rep (PatT (LetDec rep), Certs)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep) -&gt; SimpleM rep (PatT (LetDec rep))
forall rep dec.
(SimplifiableRep rep, Simplifiable dec) =&gt;
PatT dec -&gt; SimpleM rep (PatT dec)
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyPat"><span class="hs-identifier hs-var">simplifyPat</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT (LetDec rep) -&gt; SimpleM rep (PatT (LetDec rep)))
-&gt; PatT (LetDec rep) -&gt; SimpleM rep (PatT (LetDec rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDec rep) -&gt; PatT (LetDec rep)
forall a. PatT (VarWisdom, a) -&gt; PatT a
</span><a href="Futhark.Optimise.Simplify.Rep.html#removePatWisdom"><span class="hs-identifier hs-var">removePatWisdom</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDec rep)
Pat (Wise rep)
</span><a href="#local-6989586621684370035"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-400"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684370023"><span class="annot"><span class="annottext">aux' :: StmAux (ExpDec rep)
</span><a href="#local-6989586621684370023"><span class="hs-identifier hs-var hs-var">aux'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Attrs -&gt; ExpDec rep -&gt; StmAux (ExpDec rep)
forall dec. Certs -&gt; Attrs -&gt; dec -&gt; StmAux dec
</span><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-var">StmAux</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370029"><span class="hs-identifier hs-var">cs'</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370026"><span class="hs-identifier hs-var">pat_cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684370032"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">ExpDec rep
</span><a href="#local-6989586621684370031"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-401"></span><span>  </span><span class="annot"><span class="annottext">PatT (LetDec rep)
-&gt; StmAux (ExpDec rep) -&gt; Exp (Wise rep) -&gt; Stm (Wise rep)
forall rep.
(ASTRep rep, CanBeWise (Op rep)) =&gt;
Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp (Wise rep) -&gt; Stm (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Rep.html#mkWiseLetStm"><span class="hs-identifier hs-var">mkWiseLetStm</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep)
</span><a href="#local-6989586621684370027"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684370023"><span class="hs-identifier hs-var">aux'</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Wise rep) -&gt; Stm (Wise rep))
-&gt; SimpleM rep (Exp (Wise rep)) -&gt; SimpleM rep (Stm (Wise rep))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Exp (Wise rep) -&gt; SimpleM rep (Exp (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
Exp (Wise rep) -&gt; SimpleM rep (Exp (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyExpBase"><span class="hs-identifier hs-var">simplifyExpBase</span></a></span><span> </span><span class="annot"><span class="annottext">Exp (Wise rep)
</span><a href="#local-6989586621684370030"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-402"></span><span>
</span><span id="line-403"></span><span class="hs-comment">-- Bottom-up simplify a statement.  Recurses into sub-Bodies and Ops.</span><span>
</span><span id="line-404"></span><span class="hs-comment">-- Does not copy-propagate into the pattern and similar, as it is</span><span>
</span><span id="line-405"></span><span class="hs-comment">-- assumed 'nonrecSimplifyStm' has already touched it (and worst case,</span><span>
</span><span id="line-406"></span><span class="hs-comment">-- it'll get it on the next round of the overall fixpoint iteration.)</span><span>
</span><span id="line-407"></span><span id="local-6989586621684371065"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#recSimplifyStm"><span class="hs-identifier hs-type">recSimplifyStm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-408"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371065"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-409"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371065"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-410"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-411"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371065"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371065"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371065"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-412"></span><span id="recSimplifyStm"><span class="annot"><span class="annottext">recSimplifyStm :: forall rep.
SimplifiableRep rep =&gt;
Stm (Wise rep)
-&gt; UsageTable -&gt; SimpleM rep (Stms (Wise rep), Stm (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#recSimplifyStm"><span class="hs-identifier hs-var hs-var">recSimplifyStm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684370001"><span class="annot"><span class="annottext">Pat (Wise rep)
</span><a href="#local-6989586621684370001"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684370000"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370000"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684369999"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684369999"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpWisdom
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369998"><span class="annot"><span class="annottext">ExpDec rep
</span><a href="#local-6989586621684369998"><span class="hs-identifier hs-var">dec</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684369997"><span class="annot"><span class="annottext">Exp (Wise rep)
</span><a href="#local-6989586621684369997"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684369996"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369996"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684369995"><span class="annot"><span class="annottext">Exp (Wise rep)
</span><a href="#local-6989586621684369995"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369994"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369994"><span class="hs-identifier hs-var">e_hoisted</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369993"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684369993"><span class="hs-identifier hs-var">e_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleM rep (Exp (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep ((Exp (Wise rep), Stms (Wise rep)), Certs)
forall rep a. SimpleM rep a -&gt; SimpleM rep (a, Certs)
</span><a href="Futhark.Optimise.Simplify.Engine.html#collectCerts"><span class="hs-identifier hs-var">collectCerts</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep (Exp (Wise rep), Stms (Wise rep))
 -&gt; SimpleM rep ((Exp (Wise rep), Stms (Wise rep)), Certs))
-&gt; SimpleM rep (Exp (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep ((Exp (Wise rep), Stms (Wise rep)), Certs)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
-&gt; Pat (Wise rep)
-&gt; Exp (Wise rep)
-&gt; SimpleM rep (Exp (Wise rep), Stms (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
UsageTable
-&gt; Pat (Wise rep)
-&gt; Exp (Wise rep)
-&gt; SimpleM rep (Exp (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyExp"><span class="hs-identifier hs-var">simplifyExp</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369996"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Wise rep)
</span><a href="#local-6989586621684370001"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Exp (Wise rep)
</span><a href="#local-6989586621684369997"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-414"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684369991"><span class="annot"><span class="annottext">aux' :: StmAux (ExpDec rep)
</span><a href="#local-6989586621684369991"><span class="hs-identifier hs-var hs-var">aux'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Attrs -&gt; ExpDec rep -&gt; StmAux (ExpDec rep)
forall dec. Certs -&gt; Attrs -&gt; dec -&gt; StmAux dec
</span><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-var">StmAux</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684370000"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684369993"><span class="hs-identifier hs-var">e_cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684369999"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">ExpDec rep
</span><a href="#local-6989586621684369998"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-415"></span><span>  </span><span class="annot"><span class="annottext">(Stms (Wise rep), Stm (Wise rep))
-&gt; SimpleM rep (Stms (Wise rep), Stm (Wise rep))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369994"><span class="hs-identifier hs-var">e_hoisted</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp (Wise rep) -&gt; Stm (Wise rep)
forall rep.
(ASTRep rep, CanBeWise (Op rep)) =&gt;
Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp (Wise rep) -&gt; Stm (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Rep.html#mkWiseLetStm"><span class="hs-identifier hs-var">mkWiseLetStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDec rep) -&gt; Pat rep
forall a. PatT (VarWisdom, a) -&gt; PatT a
</span><a href="Futhark.Optimise.Simplify.Rep.html#removePatWisdom"><span class="hs-identifier hs-var">removePatWisdom</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDec rep)
Pat (Wise rep)
</span><a href="#local-6989586621684370001"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><a href="#local-6989586621684369991"><span class="hs-identifier hs-var">aux'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp (Wise rep)
</span><a href="#local-6989586621684369995"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-416"></span><span>
</span><span id="line-417"></span><span id="local-6989586621684371061"><span id="local-6989586621684371062"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#hoistStms"><span class="hs-identifier hs-type">hoistStms</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-418"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371062"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-419"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rule.html#RuleBook"><span class="hs-identifier hs-type">RuleBook</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371062"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-420"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371062"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-421"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371062"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-422"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371062"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684371061"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-423"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371062"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684371061"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371062"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371062"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-424"></span><span id="hoistStms"><span class="annot"><span class="annottext">hoistStms :: forall rep a.
SimplifiableRep rep =&gt;
RuleBook (Wise rep)
-&gt; BlockPred (Wise rep)
-&gt; Stms (Wise rep)
-&gt; SimpleM rep (a, UsageTable)
-&gt; SimpleM rep (a, Stms (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#hoistStms"><span class="hs-identifier hs-var hs-var">hoistStms</span></a></span></span><span> </span><span id="local-6989586621684369919"><span class="annot"><span class="annottext">RuleBook (Wise rep)
</span><a href="#local-6989586621684369919"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span id="local-6989586621684369918"><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684369918"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span id="local-6989586621684369917"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369917"><span class="hs-identifier hs-var">orig_stms</span></a></span></span><span> </span><span id="local-6989586621684369916"><span class="annot"><span class="annottext">SimpleM rep (a, UsageTable)
</span><a href="#local-6989586621684369916"><span class="hs-identifier hs-var">final</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-425"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684369915"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369915"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369914"><span class="annot"><span class="annottext">[Stm (Wise rep)]
</span><a href="#local-6989586621684369914"><span class="hs-identifier hs-var">blocked</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369913"><span class="annot"><span class="annottext">[Stm (Wise rep)]
</span><a href="#local-6989586621684369913"><span class="hs-identifier hs-var">hoisted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
-&gt; SimpleM rep (a, [Stm (Wise rep)], [Stm (Wise rep)])
</span><a href="#local-6989586621684369912"><span class="hs-identifier hs-var">simplifyStmsBottomUp</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369917"><span class="hs-identifier hs-var">orig_stms</span></a></span><span>
</span><span id="line-426"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; SimpleM rep () -&gt; SimpleM rep ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stm (Wise rep)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[Stm (Wise rep)]
</span><a href="#local-6989586621684369913"><span class="hs-identifier hs-var">hoisted</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimpleM rep ()
forall rep. SimpleM rep ()
</span><a href="Futhark.Optimise.Simplify.Engine.html#changed"><span class="hs-identifier hs-var">changed</span></a></span><span>
</span><span id="line-427"></span><span>  </span><span class="annot"><span class="annottext">(a, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (a, Stms (Wise rep), Stms (Wise rep))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369915"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Stm (Wise rep)] -&gt; Stms (Wise rep)
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm (Wise rep)]
</span><a href="#local-6989586621684369914"><span class="hs-identifier hs-var">blocked</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Stm (Wise rep)] -&gt; Stms (Wise rep)
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm (Wise rep)]
</span><a href="#local-6989586621684369913"><span class="hs-identifier hs-var">hoisted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-429"></span><span>    </span><span id="local-6989586621684369912"><span class="annot"><span class="annottext">simplifyStmsBottomUp :: Stms (Wise rep)
-&gt; SimpleM rep (a, [Stm (Wise rep)], [Stm (Wise rep)])
</span><a href="#local-6989586621684369912"><span class="hs-identifier hs-var hs-var">simplifyStmsBottomUp</span></a></span></span><span> </span><span id="local-6989586621684369908"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369908"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-430"></span><span>      </span><span id="local-6989586621684369907"><span class="annot"><span class="annottext">OpWithWisdom (Op rep) -&gt; UsageTable
</span><a href="#local-6989586621684369907"><span class="hs-identifier hs-var">opUsage</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((SimpleOps rep, Env rep) -&gt; OpWithWisdom (Op rep) -&gt; UsageTable)
-&gt; SimpleM rep (OpWithWisdom (Op rep) -&gt; UsageTable)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">(((SimpleOps rep, Env rep) -&gt; OpWithWisdom (Op rep) -&gt; UsageTable)
 -&gt; SimpleM rep (OpWithWisdom (Op rep) -&gt; UsageTable))
-&gt; ((SimpleOps rep, Env rep)
    -&gt; OpWithWisdom (Op rep) -&gt; UsageTable)
-&gt; SimpleM rep (OpWithWisdom (Op rep) -&gt; UsageTable)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SimpleOps rep -&gt; OpWithWisdom (Op rep) -&gt; UsageTable
forall rep. SimpleOps rep -&gt; Op (Wise rep) -&gt; UsageTable
</span><a href="Futhark.Optimise.Simplify.Engine.html#opUsageS"><span class="hs-identifier hs-var hs-var">opUsageS</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleOps rep -&gt; OpWithWisdom (Op rep) -&gt; UsageTable)
-&gt; ((SimpleOps rep, Env rep) -&gt; SimpleOps rep)
-&gt; (SimpleOps rep, Env rep)
-&gt; OpWithWisdom (Op rep)
-&gt; UsageTable
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SimpleOps rep, Env rep) -&gt; SimpleOps rep
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span>
</span><span id="line-431"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684369906"><span class="annot"><span class="annottext">usageInStm :: Stm (Wise rep) -&gt; UsageTable
</span><a href="#local-6989586621684369906"><span class="hs-identifier hs-var hs-var">usageInStm</span></a></span></span><span> </span><span id="local-6989586621684369905"><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369905"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-432"></span><span>            </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; UsageTable
forall rep. (ASTRep rep, Aliased rep) =&gt; Stm rep -&gt; UsageTable
</span><a href="Futhark.Analysis.UsageTable.html#usageInStm"><span class="hs-identifier hs-var">UT.usageInStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369905"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-433"></span><span>              </span><span class="annot"><span class="annottext">UsageTable -&gt; UsageTable -&gt; UsageTable
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; Exp (Wise rep)
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369905"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-434"></span><span>                </span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span id="local-6989586621684369903"><span class="annot"><span class="annottext">Op (Wise rep)
</span><a href="#local-6989586621684369903"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">OpWithWisdom (Op rep) -&gt; UsageTable
</span><a href="#local-6989586621684369907"><span class="hs-identifier hs-var">opUsage</span></a></span><span> </span><span class="annot"><span class="annottext">Op (Wise rep)
OpWithWisdom (Op rep)
</span><a href="#local-6989586621684369903"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-435"></span><span>                </span><span class="annot"><span class="annottext">Exp (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">UsageTable
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-436"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684369902"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369902"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369901"><span class="annot"><span class="annottext">[Either (Stm (Wise rep)) (Stm (Wise rep))]
</span><a href="#local-6989586621684369901"><span class="hs-identifier hs-var">stms'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; UsageTable)
-&gt; Stms (Wise rep)
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
</span><a href="#local-6989586621684369900"><span class="hs-identifier hs-var">hoistableStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; UsageTable
</span><a href="#local-6989586621684369906"><span class="hs-identifier hs-var">usageInStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369908"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-437"></span><span>      </span><span class="hs-comment">-- We need to do a final pass to ensure that nothing is</span><span>
</span><span id="line-438"></span><span>      </span><span class="hs-comment">-- hoisted past something that it depends on.</span><span>
</span><span id="line-439"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684369899"><span class="annot"><span class="annottext">[Stm (Wise rep)]
</span><a href="#local-6989586621684369899"><span class="hs-identifier hs-var">blocked</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369898"><span class="annot"><span class="annottext">[Stm (Wise rep)]
</span><a href="#local-6989586621684369898"><span class="hs-identifier hs-var">hoisted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Either (Stm (Wise rep)) (Stm (Wise rep))]
-&gt; ([Stm (Wise rep)], [Stm (Wise rep)])
forall a b. [Either a b] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">partitionEithers</span></span><span> </span><span class="annot"><span class="annottext">([Either (Stm (Wise rep)) (Stm (Wise rep))]
 -&gt; ([Stm (Wise rep)], [Stm (Wise rep)]))
-&gt; [Either (Stm (Wise rep)) (Stm (Wise rep))]
-&gt; ([Stm (Wise rep)], [Stm (Wise rep)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Either (Stm (Wise rep)) (Stm (Wise rep))]
-&gt; [Either (Stm (Wise rep)) (Stm (Wise rep))]
forall rep.
ASTRep rep =&gt;
[Either (Stm rep) (Stm rep)] -&gt; [Either (Stm rep) (Stm rep)]
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockUnhoistedDeps"><span class="hs-identifier hs-var">blockUnhoistedDeps</span></a></span><span> </span><span class="annot"><span class="annottext">[Either (Stm (Wise rep)) (Stm (Wise rep))]
</span><a href="#local-6989586621684369901"><span class="hs-identifier hs-var">stms'</span></a></span><span>
</span><span id="line-440"></span><span>      </span><span class="annot"><span class="annottext">(a, [Stm (Wise rep)], [Stm (Wise rep)])
-&gt; SimpleM rep (a, [Stm (Wise rep)], [Stm (Wise rep)])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369902"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Stm (Wise rep)]
</span><a href="#local-6989586621684369899"><span class="hs-identifier hs-var">blocked</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Stm (Wise rep)]
</span><a href="#local-6989586621684369898"><span class="hs-identifier hs-var">hoisted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span>    </span><span id="local-6989586621684369895"><span class="annot"><span class="annottext">descend :: (Stm (Wise rep) -&gt; UsageTable)
-&gt; Stms (Wise rep)
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
</span><a href="#local-6989586621684369895"><span class="hs-identifier hs-var hs-var">descend</span></a></span></span><span> </span><span id="local-6989586621684369894"><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; UsageTable
</span><a href="#local-6989586621684369894"><span class="hs-identifier hs-var">usageInStm</span></a></span></span><span> </span><span id="local-6989586621684369893"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369893"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684369892"><span class="annot"><span class="annottext">SimpleM
  rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
</span><a href="#local-6989586621684369892"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-443"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep) -&gt; Maybe (Stm (Wise rep), Stms (Wise rep))
forall rep. Stms rep -&gt; Maybe (Stm rep, Stms rep)
</span><a href="Futhark.IR.Syntax.html#stmsHead"><span class="hs-identifier hs-var">stmsHead</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369893"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-444"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Stm (Wise rep), Stms (Wise rep))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SimpleM
  rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
</span><a href="#local-6989586621684369892"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-445"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684369890"><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369890"><span class="hs-identifier hs-var">stms_h</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369889"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369889"><span class="hs-identifier hs-var">stms_t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
forall rep a.
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#localVtable"><span class="hs-identifier hs-var">localVtable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
forall rep.
(ASTRep rep, IndexOp (Op rep), Aliased rep) =&gt;
Stm rep -&gt; SymbolTable rep -&gt; SymbolTable rep
</span><a href="Futhark.Analysis.SymbolTable.html#insertStm"><span class="hs-identifier hs-var">ST.insertStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369890"><span class="hs-identifier hs-var">stms_h</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimpleM
   rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
 -&gt; SimpleM
      rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))]))
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-446"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684369887"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369887"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369886"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369886"><span class="hs-identifier hs-var">usage</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369885"><span class="annot"><span class="annottext">[Either (Stm (Wise rep)) (Stm (Wise rep))]
</span><a href="#local-6989586621684369885"><span class="hs-identifier hs-var">stms_t'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; UsageTable)
-&gt; Stms (Wise rep)
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
</span><a href="#local-6989586621684369895"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; UsageTable
</span><a href="#local-6989586621684369894"><span class="hs-identifier hs-var">usageInStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369889"><span class="hs-identifier hs-var">stms_t</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM
  rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
</span><a href="#local-6989586621684369892"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-447"></span><span>          </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; UsageTable)
-&gt; Stm (Wise rep)
-&gt; [Either (Stm (Wise rep)) (Stm (Wise rep))]
-&gt; UsageTable
-&gt; a
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
</span><a href="#local-6989586621684369884"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; UsageTable
</span><a href="#local-6989586621684369894"><span class="hs-identifier hs-var">usageInStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369890"><span class="hs-identifier hs-var">stms_h</span></a></span><span> </span><span class="annot"><span class="annottext">[Either (Stm (Wise rep)) (Stm (Wise rep))]
</span><a href="#local-6989586621684369885"><span class="hs-identifier hs-var">stms_t'</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369886"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369887"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-448"></span><span>
</span><span id="line-449"></span><span>    </span><span id="local-6989586621684369884"><span class="annot"><span class="annottext">process :: (Stm (Wise rep) -&gt; UsageTable)
-&gt; Stm (Wise rep)
-&gt; [Either (Stm (Wise rep)) (Stm (Wise rep))]
-&gt; UsageTable
-&gt; a
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
</span><a href="#local-6989586621684369884"><span class="hs-identifier hs-var hs-var">process</span></a></span></span><span> </span><span id="local-6989586621684369883"><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; UsageTable
</span><a href="#local-6989586621684369883"><span class="hs-identifier hs-var">usageInStm</span></a></span></span><span> </span><span id="local-6989586621684369882"><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369882"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span id="local-6989586621684369881"><span class="annot"><span class="annottext">[Either (Stm (Wise rep)) (Stm (Wise rep))]
</span><a href="#local-6989586621684369881"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684369880"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369880"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span id="local-6989586621684369879"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369879"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-450"></span><span>      </span><span id="local-6989586621684369878"><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684369878"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleM rep (SymbolTable (Wise rep))
forall rep. SimpleM rep (SymbolTable (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#askVtable"><span class="hs-identifier hs-var">askVtable</span></a></span><span>
</span><span id="line-451"></span><span>      </span><span id="local-6989586621684369877"><span class="annot"><span class="annottext">Maybe (Stms (Wise rep))
</span><a href="#local-6989586621684369877"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleBook (Wise rep)
-&gt; (SymbolTable (Wise rep), UsageTable)
-&gt; Stm (Wise rep)
-&gt; SimpleM rep (Maybe (Stms (Wise rep)))
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, HasScope rep m) =&gt;
RuleBook rep
-&gt; (SymbolTable rep, UsageTable) -&gt; Stm rep -&gt; m (Maybe (Stms rep))
</span><a href="Futhark.Optimise.Simplify.Rule.html#bottomUpSimplifyStm"><span class="hs-identifier hs-var">bottomUpSimplifyStm</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBook (Wise rep)
</span><a href="#local-6989586621684369919"><span class="hs-identifier hs-var">rules</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684369878"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369880"><span class="hs-identifier hs-var">usage</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369882"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-452"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Stms (Wise rep))
</span><a href="#local-6989586621684369877"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-453"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Stms (Wise rep))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-comment">-- Nothing to optimise - see if hoistable.</span><span>
</span><span id="line-454"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684369918"><span class="hs-identifier hs-var">block</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684369878"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369880"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369882"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-455"></span><span>            </span><span class="hs-comment">-- No, not hoistable.</span><span>
</span><span id="line-456"></span><span>            </span><span class="annot"><span class="annottext">(a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-457"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369879"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-458"></span><span>                </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; UsageTable)
-&gt; SymbolTable (Wise rep)
-&gt; UsageTable
-&gt; Stm (Wise rep)
-&gt; UsageTable
forall rep.
(ASTRep rep, Aliased rep) =&gt;
(Stm rep -&gt; UsageTable)
-&gt; SymbolTable rep -&gt; UsageTable -&gt; Stm rep -&gt; UsageTable
</span><a href="Futhark.Optimise.Simplify.Engine.html#expandUsage"><span class="hs-identifier hs-var">expandUsage</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; UsageTable
</span><a href="#local-6989586621684369883"><span class="hs-identifier hs-var">usageInStm</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684369878"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369880"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369882"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-459"></span><span>                  </span><span class="annot"><span class="annottext">UsageTable -&gt; [VName] -&gt; UsageTable
</span><a href="Futhark.Analysis.UsageTable.html#without"><span class="hs-operator hs-var">`UT.without`</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; [VName]
forall rep. Stm rep -&gt; [VName]
</span><a href="Futhark.Optimise.Simplify.Engine.html#provides"><span class="hs-identifier hs-var">provides</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369882"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-460"></span><span>                </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; Either (Stm (Wise rep)) (Stm (Wise rep))
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369882"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">Either (Stm (Wise rep)) (Stm (Wise rep))
-&gt; [Either (Stm (Wise rep)) (Stm (Wise rep))]
-&gt; [Either (Stm (Wise rep)) (Stm (Wise rep))]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Either (Stm (Wise rep)) (Stm (Wise rep))]
</span><a href="#local-6989586621684369881"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-461"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-463"></span><span>            </span><span class="hs-comment">-- Yes, hoistable.</span><span>
</span><span id="line-464"></span><span>            </span><span class="annot"><span class="annottext">(a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-465"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369879"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-466"></span><span>                </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; UsageTable)
-&gt; SymbolTable (Wise rep)
-&gt; UsageTable
-&gt; Stm (Wise rep)
-&gt; UsageTable
forall rep.
(ASTRep rep, Aliased rep) =&gt;
(Stm rep -&gt; UsageTable)
-&gt; SymbolTable rep -&gt; UsageTable -&gt; Stm rep -&gt; UsageTable
</span><a href="Futhark.Optimise.Simplify.Engine.html#expandUsage"><span class="hs-identifier hs-var">expandUsage</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; UsageTable
</span><a href="#local-6989586621684369883"><span class="hs-identifier hs-var">usageInStm</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684369878"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369880"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369882"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-467"></span><span>                </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; Either (Stm (Wise rep)) (Stm (Wise rep))
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369882"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">Either (Stm (Wise rep)) (Stm (Wise rep))
-&gt; [Either (Stm (Wise rep)) (Stm (Wise rep))]
-&gt; [Either (Stm (Wise rep)) (Stm (Wise rep))]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Either (Stm (Wise rep)) (Stm (Wise rep))]
</span><a href="#local-6989586621684369881"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-468"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684369872"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369872"><span class="hs-identifier hs-var">optimstms</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-470"></span><span>          </span><span class="annot"><span class="annottext">SimpleM rep ()
forall rep. SimpleM rep ()
</span><a href="Futhark.Optimise.Simplify.Engine.html#changed"><span class="hs-identifier hs-var">changed</span></a></span><span>
</span><span id="line-471"></span><span>          </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; UsageTable)
-&gt; Stms (Wise rep)
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
</span><a href="#local-6989586621684369895"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; UsageTable
</span><a href="#local-6989586621684369883"><span class="hs-identifier hs-var">usageInStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369872"><span class="hs-identifier hs-var">optimstms</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleM
   rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
 -&gt; SimpleM
      rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))]))
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369879"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369880"><span class="hs-identifier hs-var">usage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Either (Stm (Wise rep)) (Stm (Wise rep))]
</span><a href="#local-6989586621684369881"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-472"></span><span>
</span><span id="line-473"></span><span>    </span><span id="local-6989586621684369900"><span class="annot"><span class="annottext">hoistableStms :: (Stm (Wise rep) -&gt; UsageTable)
-&gt; Stms (Wise rep)
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
</span><a href="#local-6989586621684369900"><span class="hs-identifier hs-var hs-var">hoistableStms</span></a></span></span><span> </span><span id="local-6989586621684369871"><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; UsageTable
</span><a href="#local-6989586621684369871"><span class="hs-identifier hs-var">usageInStm</span></a></span></span><span> </span><span id="local-6989586621684369870"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369870"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-474"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep) -&gt; Maybe (Stm (Wise rep), Stms (Wise rep))
forall rep. Stms rep -&gt; Maybe (Stm rep, Stms rep)
</span><a href="Futhark.IR.Syntax.html#stmsHead"><span class="hs-identifier hs-var">stmsHead</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369870"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-475"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Stm (Wise rep), Stms (Wise rep))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-476"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684369869"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369869"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369868"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369868"><span class="hs-identifier hs-var">usage</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleM rep (a, UsageTable)
</span><a href="#local-6989586621684369916"><span class="hs-identifier hs-var">final</span></a></span><span>
</span><span id="line-477"></span><span>          </span><span class="annot"><span class="annottext">(a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369869"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369868"><span class="hs-identifier hs-var">usage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Either (Stm (Wise rep)) (Stm (Wise rep))]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684369867"><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369867"><span class="hs-identifier hs-var">stms_h</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369866"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369866"><span class="hs-identifier hs-var">stms_t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-479"></span><span>          </span><span id="local-6989586621684369865"><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369865"><span class="hs-identifier hs-var">stms_h'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; SimpleM rep (Stm (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
Stm (Wise rep) -&gt; SimpleM rep (Stm (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#nonrecSimplifyStm"><span class="hs-identifier hs-var">nonrecSimplifyStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369867"><span class="hs-identifier hs-var">stms_h</span></a></span><span>
</span><span id="line-480"></span><span>
</span><span id="line-481"></span><span>          </span><span id="local-6989586621684369864"><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684369864"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleM rep (SymbolTable (Wise rep))
forall rep. SimpleM rep (SymbolTable (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#askVtable"><span class="hs-identifier hs-var">askVtable</span></a></span><span>
</span><span id="line-482"></span><span>          </span><span id="local-6989586621684369863"><span class="annot"><span class="annottext">Maybe (Stms (Wise rep))
</span><a href="#local-6989586621684369863"><span class="hs-identifier hs-var">simplified</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">RuleBook (Wise rep)
-&gt; SymbolTable (Wise rep)
-&gt; Stm (Wise rep)
-&gt; SimpleM rep (Maybe (Stms (Wise rep)))
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, HasScope rep m) =&gt;
RuleBook rep -&gt; SymbolTable rep -&gt; Stm rep -&gt; m (Maybe (Stms rep))
</span><a href="Futhark.Optimise.Simplify.Rule.html#topDownSimplifyStm"><span class="hs-identifier hs-var">topDownSimplifyStm</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBook (Wise rep)
</span><a href="#local-6989586621684369919"><span class="hs-identifier hs-var">rules</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684369864"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369865"><span class="hs-identifier hs-var">stms_h'</span></a></span><span>
</span><span id="line-483"></span><span>
</span><span id="line-484"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Stms (Wise rep))
</span><a href="#local-6989586621684369863"><span class="hs-identifier hs-var">simplified</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-485"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684369861"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369861"><span class="hs-identifier hs-var">newstms</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-486"></span><span>              </span><span class="annot"><span class="annottext">SimpleM rep ()
forall rep. SimpleM rep ()
</span><a href="Futhark.Optimise.Simplify.Engine.html#changed"><span class="hs-identifier hs-var">changed</span></a></span><span>
</span><span id="line-487"></span><span>              </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; UsageTable)
-&gt; Stms (Wise rep)
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
</span><a href="#local-6989586621684369900"><span class="hs-identifier hs-var">hoistableStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; UsageTable
</span><a href="#local-6989586621684369871"><span class="hs-identifier hs-var">usageInStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369861"><span class="hs-identifier hs-var">newstms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep) -&gt; Stms (Wise rep) -&gt; Stms (Wise rep)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369866"><span class="hs-identifier hs-var">stms_t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-488"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Stms (Wise rep))
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-489"></span><span>              </span><span class="hs-special">(</span><span id="local-6989586621684369860"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369860"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369859"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369859"><span class="hs-identifier hs-var">usage</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369858"><span class="annot"><span class="annottext">[Either (Stm (Wise rep)) (Stm (Wise rep))]
</span><a href="#local-6989586621684369858"><span class="hs-identifier hs-var">stms_t'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-490"></span><span>                </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
forall rep a.
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#localVtable"><span class="hs-identifier hs-var">localVtable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
forall rep.
(ASTRep rep, IndexOp (Op rep), Aliased rep) =&gt;
Stm rep -&gt; SymbolTable rep -&gt; SymbolTable rep
</span><a href="Futhark.Analysis.SymbolTable.html#insertStm"><span class="hs-identifier hs-var">ST.insertStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369865"><span class="hs-identifier hs-var">stms_h'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimpleM
   rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
 -&gt; SimpleM
      rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))]))
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-491"></span><span>                  </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; UsageTable)
-&gt; Stms (Wise rep)
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
</span><a href="#local-6989586621684369900"><span class="hs-identifier hs-var">hoistableStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; UsageTable
</span><a href="#local-6989586621684369871"><span class="hs-identifier hs-var">usageInStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369866"><span class="hs-identifier hs-var">stms_t</span></a></span><span>
</span><span id="line-492"></span><span>              </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#isUsedDirectly"><span class="hs-operator hs-var">`UT.isUsedDirectly`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369859"><span class="hs-identifier hs-var">usage</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Bool) -&gt; [VName] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; [VName]
forall rep. Stm rep -&gt; [VName]
</span><a href="Futhark.Optimise.Simplify.Engine.html#provides"><span class="hs-identifier hs-var">provides</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369865"><span class="hs-identifier hs-var">stms_h'</span></a></span><span>
</span><span id="line-493"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="hs-comment">-- Dead statement.</span><span>
</span><span id="line-494"></span><span>                  </span><span class="annot"><span class="annottext">(a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369860"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369859"><span class="hs-identifier hs-var">usage</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Either (Stm (Wise rep)) (Stm (Wise rep))]
</span><a href="#local-6989586621684369858"><span class="hs-identifier hs-var">stms_t'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-495"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-496"></span><span>                  </span><span class="hs-special">(</span><span id="local-6989586621684369856"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369856"><span class="hs-identifier hs-var">stms_h_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369855"><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369855"><span class="hs-identifier hs-var">stms_h''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
-&gt; UsageTable -&gt; SimpleM rep (Stms (Wise rep), Stm (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
Stm (Wise rep)
-&gt; UsageTable -&gt; SimpleM rep (Stms (Wise rep), Stm (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#recSimplifyStm"><span class="hs-identifier hs-var">recSimplifyStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369865"><span class="hs-identifier hs-var">stms_h'</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369859"><span class="hs-identifier hs-var">usage</span></a></span><span>
</span><span id="line-497"></span><span>                  </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; UsageTable)
-&gt; Stms (Wise rep)
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
</span><a href="#local-6989586621684369895"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; UsageTable
</span><a href="#local-6989586621684369871"><span class="hs-identifier hs-var">usageInStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369856"><span class="hs-identifier hs-var">stms_h_stms</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleM
   rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
 -&gt; SimpleM
      rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))]))
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-498"></span><span>                    </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; UsageTable)
-&gt; Stm (Wise rep)
-&gt; [Either (Stm (Wise rep)) (Stm (Wise rep))]
-&gt; UsageTable
-&gt; a
-&gt; SimpleM
     rep (a, UsageTable, [Either (Stm (Wise rep)) (Stm (Wise rep))])
</span><a href="#local-6989586621684369884"><span class="hs-identifier hs-var">process</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; UsageTable
</span><a href="#local-6989586621684369871"><span class="hs-identifier hs-var">usageInStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369855"><span class="hs-identifier hs-var">stms_h''</span></a></span><span> </span><span class="annot"><span class="annottext">[Either (Stm (Wise rep)) (Stm (Wise rep))]
</span><a href="#local-6989586621684369858"><span class="hs-identifier hs-var">stms_t'</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369859"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369860"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-499"></span><span>
</span><span id="line-500"></span><span id="local-6989586621684371047"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#blockUnhoistedDeps"><span class="hs-identifier hs-type">blockUnhoistedDeps</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-501"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371047"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-502"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371047"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371047"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-503"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371047"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371047"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-504"></span><span id="blockUnhoistedDeps"><span class="annot"><span class="annottext">blockUnhoistedDeps :: forall rep.
ASTRep rep =&gt;
[Either (Stm rep) (Stm rep)] -&gt; [Either (Stm rep) (Stm rep)]
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockUnhoistedDeps"><span class="hs-identifier hs-var hs-var">blockUnhoistedDeps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Names, [Either (Stm rep) (Stm rep)])
-&gt; [Either (Stm rep) (Stm rep)]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((Names, [Either (Stm rep) (Stm rep)])
 -&gt; [Either (Stm rep) (Stm rep)])
-&gt; ([Either (Stm rep) (Stm rep)]
    -&gt; (Names, [Either (Stm rep) (Stm rep)]))
-&gt; [Either (Stm rep) (Stm rep)]
-&gt; [Either (Stm rep) (Stm rep)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Names
 -&gt; Either (Stm rep) (Stm rep)
 -&gt; (Names, Either (Stm rep) (Stm rep)))
-&gt; Names
-&gt; [Either (Stm rep) (Stm rep)]
-&gt; (Names, [Either (Stm rep) (Stm rep)])
forall (t :: * -&gt; *) a b c.
Traversable t =&gt;
(a -&gt; b -&gt; (a, c)) -&gt; a -&gt; t b -&gt; (a, t c)
</span><span class="hs-identifier hs-var">mapAccumL</span></span><span> </span><span class="annot"><span class="annottext">Names
-&gt; Either (Stm rep) (Stm rep)
-&gt; (Names, Either (Stm rep) (Stm rep))
forall {rep}.
(FreeDec (ExpDec rep), FreeDec (BodyDec rep),
 FreeIn (FParamInfo rep), FreeIn (LParamInfo rep),
 FreeIn (LetDec rep), FreeIn (RetType rep), FreeIn (BranchType rep),
 FreeIn (Op rep)) =&gt;
Names
-&gt; Either (Stm rep) (Stm rep)
-&gt; (Names, Either (Stm rep) (Stm rep))
</span><a href="#local-6989586621684369806"><span class="hs-identifier hs-var">block</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-505"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-506"></span><span>    </span><span id="local-6989586621684369806"><span class="annot"><span class="annottext">block :: Names
-&gt; Either (Stm rep) (Stm rep)
-&gt; (Names, Either (Stm rep) (Stm rep))
</span><a href="#local-6989586621684369806"><span class="hs-identifier hs-var hs-var">block</span></a></span></span><span> </span><span id="local-6989586621684369760"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369760"><span class="hs-identifier hs-var">blocked</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621684369759"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369759"><span class="hs-identifier hs-var">need</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-507"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369760"><span class="hs-identifier hs-var">blocked</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm rep -&gt; [VName]
forall rep. Stm rep -&gt; [VName]
</span><a href="Futhark.Optimise.Simplify.Engine.html#provides"><span class="hs-identifier hs-var">provides</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369759"><span class="hs-identifier hs-var">need</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Either (Stm rep) (Stm rep)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369759"><span class="hs-identifier hs-var">need</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-508"></span><span>    </span><span class="annot"><a href="#local-6989586621684369806"><span class="hs-identifier hs-var">block</span></a></span><span> </span><span id="local-6989586621684369757"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369757"><span class="hs-identifier hs-var">blocked</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621684369756"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369756"><span class="hs-identifier hs-var">need</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-509"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369757"><span class="hs-identifier hs-var">blocked</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#namesIntersect"><span class="hs-operator hs-var">`namesIntersect`</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369756"><span class="hs-identifier hs-var">need</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-510"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369757"><span class="hs-identifier hs-var">blocked</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm rep -&gt; [VName]
forall rep. Stm rep -&gt; [VName]
</span><a href="Futhark.Optimise.Simplify.Engine.html#provides"><span class="hs-identifier hs-var">provides</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369756"><span class="hs-identifier hs-var">need</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Either (Stm rep) (Stm rep)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369756"><span class="hs-identifier hs-var">need</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-511"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-512"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369757"><span class="hs-identifier hs-var">blocked</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Either (Stm rep) (Stm rep)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369756"><span class="hs-identifier hs-var">need</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span id="local-6989586621684371041"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#provides"><span class="hs-identifier hs-type">provides</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371041"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-515"></span><span id="provides"><span class="annot"><span class="annottext">provides :: forall rep. Stm rep -&gt; [VName]
</span><a href="Futhark.Optimise.Simplify.Engine.html#provides"><span class="hs-identifier hs-var hs-var">provides</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT (LetDec rep) -&gt; [VName])
-&gt; (Stm rep -&gt; PatT (LetDec rep)) -&gt; Stm rep -&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; PatT (LetDec rep)
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span id="local-6989586621684371042"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#expandUsage"><span class="hs-identifier hs-type">expandUsage</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-518"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371042"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371042"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-519"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371042"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-520"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#SymbolTable"><span class="hs-identifier hs-type">ST.SymbolTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371042"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-521"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-522"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371042"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-523"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span></span><span>
</span><span id="line-524"></span><span id="expandUsage"><span class="annot"><span class="annottext">expandUsage :: forall rep.
(ASTRep rep, Aliased rep) =&gt;
(Stm rep -&gt; UsageTable)
-&gt; SymbolTable rep -&gt; UsageTable -&gt; Stm rep -&gt; UsageTable
</span><a href="Futhark.Optimise.Simplify.Engine.html#expandUsage"><span class="hs-identifier hs-var hs-var">expandUsage</span></a></span></span><span> </span><span id="local-6989586621684369699"><span class="annot"><span class="annottext">Stm rep -&gt; UsageTable
</span><a href="#local-6989586621684369699"><span class="hs-identifier hs-var">usageInStm</span></a></span></span><span> </span><span id="local-6989586621684369698"><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684369698"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684369697"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369697"><span class="hs-identifier hs-var">utable</span></a></span></span><span> </span><span id="local-6989586621684369696"><span class="annot"><span class="annottext">stm :: Stm rep
</span><a href="#local-6989586621684369696"><span class="hs-identifier hs-var">stm</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684369695"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684369695"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684369694"><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684369694"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-525"></span><span>  </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369693"><span class="hs-identifier hs-var">stmUsages</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable -&gt; UsageTable -&gt; UsageTable
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369697"><span class="hs-identifier hs-var">utable</span></a></span><span>
</span><span id="line-526"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-527"></span><span>    </span><span id="local-6989586621684369693"><span class="annot"><span class="annottext">stmUsages :: UsageTable
</span><a href="#local-6989586621684369693"><span class="hs-identifier hs-var hs-var">stmUsages</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-528"></span><span>      </span><span class="annot"><span class="annottext">(VName -&gt; Names) -&gt; UsageTable -&gt; UsageTable
</span><a href="Futhark.Analysis.UsageTable.html#expand"><span class="hs-identifier hs-var">UT.expand</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SymbolTable rep -&gt; Names
forall rep. VName -&gt; SymbolTable rep -&gt; Names
</span><a href="Futhark.Analysis.SymbolTable.html#lookupAliases"><span class="hs-operator hs-var">`ST.lookupAliases`</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684369698"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm rep -&gt; UsageTable
</span><a href="#local-6989586621684369699"><span class="hs-identifier hs-var">usageInStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369696"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable -&gt; UsageTable -&gt; UsageTable
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369690"><span class="hs-identifier hs-var">usageThroughAliases</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>        </span><span class="annot"><span class="annottext">UsageTable -&gt; UsageTable -&gt; UsageTable
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#isSize"><span class="hs-operator hs-var">`UT.isSize`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369697"><span class="hs-identifier hs-var">utable</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684369695"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-530"></span><span>               </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Names -&gt; UsageTable
</span><a href="Futhark.Analysis.UsageTable.html#sizeUsages"><span class="hs-identifier hs-var">UT.sizeUsages</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp rep -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684369694"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-531"></span><span>               </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">UsageTable
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-532"></span><span>           </span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>    </span><span id="local-6989586621684369690"><span class="annot"><span class="annottext">usageThroughAliases :: UsageTable
</span><a href="#local-6989586621684369690"><span class="hs-identifier hs-var hs-var">usageThroughAliases</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-534"></span><span>      </span><span class="annot"><span class="annottext">[UsageTable] -&gt; UsageTable
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([UsageTable] -&gt; UsageTable)
-&gt; ([(VName, Names)] -&gt; [UsageTable])
-&gt; [(VName, Names)]
-&gt; UsageTable
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((VName, Names) -&gt; Maybe UsageTable)
-&gt; [(VName, Names)] -&gt; [UsageTable]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">(VName, Names) -&gt; Maybe UsageTable
</span><a href="#local-6989586621684369686"><span class="hs-identifier hs-var">usageThroughBindeeAliases</span></a></span><span> </span><span class="annot"><span class="annottext">([(VName, Names)] -&gt; UsageTable) -&gt; [(VName, Names)] -&gt; UsageTable
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-535"></span><span>        </span><span class="annot"><span class="annottext">[VName] -&gt; [Names] -&gt; [(VName, Names)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684369695"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat rep -&gt; [Names]
forall dec. AliasesOf dec =&gt; PatT dec -&gt; [Names]
</span><a href="Futhark.IR.Prop.Aliases.html#patAliases"><span class="hs-identifier hs-var">patAliases</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684369695"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-536"></span><span>    </span><span id="local-6989586621684369686"><span class="annot"><span class="annottext">usageThroughBindeeAliases :: (VName, Names) -&gt; Maybe UsageTable
</span><a href="#local-6989586621684369686"><span class="hs-identifier hs-var hs-var">usageThroughBindeeAliases</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684369684"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369684"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369683"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369683"><span class="hs-identifier hs-var">aliases</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-537"></span><span>      </span><span id="local-6989586621684369682"><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621684369682"><span class="hs-identifier hs-var">uses</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Maybe Usages
</span><a href="Futhark.Analysis.UsageTable.html#lookup"><span class="hs-identifier hs-var">UT.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369684"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369697"><span class="hs-identifier hs-var">utable</span></a></span><span>
</span><span id="line-538"></span><span>      </span><span class="annot"><span class="annottext">UsageTable -&gt; Maybe UsageTable
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(UsageTable -&gt; Maybe UsageTable)
-&gt; ([UsageTable] -&gt; UsageTable) -&gt; [UsageTable] -&gt; Maybe UsageTable
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[UsageTable] -&gt; UsageTable
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([UsageTable] -&gt; Maybe UsageTable)
-&gt; [UsageTable] -&gt; Maybe UsageTable
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-539"></span><span>        </span><span class="annot"><span class="annottext">(VName -&gt; UsageTable) -&gt; [VName] -&gt; [UsageTable]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Usages -&gt; UsageTable
</span><a href="Futhark.Analysis.UsageTable.html#usage"><span class="hs-operator hs-var">`UT.usage`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621684369682"><span class="hs-identifier hs-var">uses</span></a></span><span> </span><span class="annot"><span class="annottext">Usages -&gt; Usages -&gt; Usages
</span><a href="Futhark.Analysis.UsageTable.html#withoutU"><span class="hs-operator hs-var">`UT.withoutU`</span></a></span><span> </span><span class="annot"><span class="annottext">Usages
</span><a href="Futhark.Analysis.UsageTable.html#presentU"><span class="hs-identifier hs-var">UT.presentU</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [UsageTable]) -&gt; [VName] -&gt; [UsageTable]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369683"><span class="hs-identifier hs-var">aliases</span></a></span><span>
</span><span id="line-540"></span><span>
</span><span id="line-541"></span><span class="hs-keyword">type</span><span> </span><span id="BlockPred"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-var">BlockPred</span></a></span></span><span> </span><span id="local-6989586621684369676"><span class="annot"><a href="#local-6989586621684369676"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#SymbolTable"><span class="hs-identifier hs-type">ST.SymbolTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684369676"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684369676"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-542"></span><span>
</span><span id="line-543"></span><span id="local-6989586621684371438"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#neverBlocks"><span class="hs-identifier hs-type">neverBlocks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371438"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-544"></span><span id="neverBlocks"><span class="annot"><span class="annottext">neverBlocks :: forall rep. BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#neverBlocks"><span class="hs-identifier hs-var hs-var">neverBlocks</span></a></span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-545"></span><span>
</span><span id="line-546"></span><span id="local-6989586621684369675"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#alwaysBlocks"><span class="hs-identifier hs-type">alwaysBlocks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684369675"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-547"></span><span id="alwaysBlocks"><span class="annot"><span class="annottext">alwaysBlocks :: forall rep. BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#alwaysBlocks"><span class="hs-identifier hs-var hs-var">alwaysBlocks</span></a></span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-548"></span><span>
</span><span id="line-549"></span><span id="local-6989586621684371002"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#isFalse"><span class="hs-identifier hs-type">isFalse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371002"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-550"></span><span id="isFalse"><span class="annot"><span class="annottext">isFalse :: forall rep. Bool -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isFalse"><span class="hs-identifier hs-var hs-var">isFalse</span></a></span></span><span> </span><span id="local-6989586621684369674"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684369674"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684369674"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-551"></span><span>
</span><span id="line-552"></span><span id="local-6989586621684371000"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#orIf"><span class="hs-identifier hs-type">orIf</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371000"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371000"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371000"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-553"></span><span id="orIf"><span class="annot"><span class="annottext">orIf :: forall rep. BlockPred rep -&gt; BlockPred rep -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#orIf"><span class="hs-identifier hs-var hs-var">orIf</span></a></span></span><span> </span><span id="local-6989586621684369673"><span class="annot"><span class="annottext">BlockPred rep
</span><a href="#local-6989586621684369673"><span class="hs-identifier hs-var">p1</span></a></span></span><span> </span><span id="local-6989586621684369672"><span class="annot"><span class="annottext">BlockPred rep
</span><a href="#local-6989586621684369672"><span class="hs-identifier hs-var">p2</span></a></span></span><span> </span><span id="local-6989586621684369671"><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684369671"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621684369670"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369670"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684369669"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369669"><span class="hs-identifier hs-var">need</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockPred rep
</span><a href="#local-6989586621684369673"><span class="hs-identifier hs-var">p1</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684369671"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369670"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369669"><span class="hs-identifier hs-var">need</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">BlockPred rep
</span><a href="#local-6989586621684369672"><span class="hs-identifier hs-var">p2</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684369671"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369670"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369669"><span class="hs-identifier hs-var">need</span></a></span><span>
</span><span id="line-554"></span><span>
</span><span id="line-555"></span><span id="local-6989586621684369668"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#andAlso"><span class="hs-identifier hs-type">andAlso</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684369668"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684369668"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684369668"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-556"></span><span id="andAlso"><span class="annot"><span class="annottext">andAlso :: forall rep. BlockPred rep -&gt; BlockPred rep -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#andAlso"><span class="hs-identifier hs-var hs-var">andAlso</span></a></span></span><span> </span><span id="local-6989586621684369666"><span class="annot"><span class="annottext">BlockPred rep
</span><a href="#local-6989586621684369666"><span class="hs-identifier hs-var">p1</span></a></span></span><span> </span><span id="local-6989586621684369665"><span class="annot"><span class="annottext">BlockPred rep
</span><a href="#local-6989586621684369665"><span class="hs-identifier hs-var">p2</span></a></span></span><span> </span><span id="local-6989586621684369664"><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684369664"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621684369663"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369663"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684369662"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369662"><span class="hs-identifier hs-var">need</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BlockPred rep
</span><a href="#local-6989586621684369666"><span class="hs-identifier hs-var">p1</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684369664"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369663"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369662"><span class="hs-identifier hs-var">need</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">BlockPred rep
</span><a href="#local-6989586621684369665"><span class="hs-identifier hs-var">p2</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684369664"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369663"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369662"><span class="hs-identifier hs-var">need</span></a></span><span>
</span><span id="line-557"></span><span>
</span><span id="line-558"></span><span id="local-6989586621684369661"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#isConsumed"><span class="hs-identifier hs-type">isConsumed</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684369661"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-559"></span><span id="isConsumed"><span class="annot"><span class="annottext">isConsumed :: forall rep. BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isConsumed"><span class="hs-identifier hs-var hs-var">isConsumed</span></a></span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684369659"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369659"><span class="hs-identifier hs-var">utable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#isConsumed"><span class="hs-operator hs-var">`UT.isConsumed`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369659"><span class="hs-identifier hs-var">utable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Bool) -&gt; (Stm rep -&gt; [VName]) -&gt; Stm rep -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec rep) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT (LetDec rep) -&gt; [VName])
-&gt; (Stm rep -&gt; PatT (LetDec rep)) -&gt; Stm rep -&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; PatT (LetDec rep)
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span>
</span><span id="line-560"></span><span>
</span><span id="line-561"></span><span id="local-6989586621684369657"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#isOp"><span class="hs-identifier hs-type">isOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684369657"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-562"></span><span id="isOp"><span class="annot"><span class="annottext">isOp :: forall rep. BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isOp"><span class="hs-identifier hs-var hs-var">isOp</span></a></span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-563"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#isOp"><span class="hs-identifier hs-var">isOp</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-564"></span><span>
</span><span id="line-565"></span><span id="local-6989586621684370995"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#constructBody"><span class="hs-identifier hs-type">constructBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-566"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370995"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-567"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370995"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-568"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Result"><span class="hs-identifier hs-type">Result</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-569"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370995"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370995"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-570"></span><span id="constructBody"><span class="annot"><span class="annottext">constructBody :: forall rep.
SimplifiableRep rep =&gt;
Stms (Wise rep) -&gt; Result -&gt; SimpleM rep (Body (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#constructBody"><span class="hs-identifier hs-var hs-var">constructBody</span></a></span></span><span> </span><span id="local-6989586621684369627"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369627"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684369626"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369626"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-571"></span><span>  </span><span class="annot"><span class="annottext">((Body (Wise rep), Stms (Wise rep)) -&gt; Body (Wise rep))
-&gt; SimpleM rep (Body (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Body (Wise rep))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(Body (Wise rep), Stms (Wise rep)) -&gt; Body (Wise rep)
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep (Body (Wise rep), Stms (Wise rep))
 -&gt; SimpleM rep (Body (Wise rep)))
-&gt; (BuilderT (Wise rep) (State VNameSource) Result
    -&gt; SimpleM rep (Body (Wise rep), Stms (Wise rep)))
-&gt; BuilderT (Wise rep) (State VNameSource) Result
-&gt; SimpleM rep (Body (Wise rep))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Builder (Wise rep) (Body (Wise rep))
-&gt; SimpleM rep (Body (Wise rep), Stms (Wise rep))
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilder"><span class="hs-identifier hs-var">runBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder (Wise rep) (Body (Wise rep))
 -&gt; SimpleM rep (Body (Wise rep), Stms (Wise rep)))
-&gt; (BuilderT (Wise rep) (State VNameSource) Result
    -&gt; Builder (Wise rep) (Body (Wise rep)))
-&gt; BuilderT (Wise rep) (State VNameSource) Result
-&gt; SimpleM rep (Body (Wise rep), Stms (Wise rep))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BuilderT (Wise rep) (State VNameSource) Result
-&gt; Builder (Wise rep) (Body (Wise rep))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
m Result -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#buildBody_"><span class="hs-identifier hs-var">buildBody_</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT (Wise rep) (State VNameSource) Result
 -&gt; SimpleM rep (Body (Wise rep)))
-&gt; BuilderT (Wise rep) (State VNameSource) Result
-&gt; SimpleM rep (Body (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-572"></span><span>    </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT (Wise rep) (State VNameSource)))
-&gt; BuilderT (Wise rep) (State VNameSource) ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Rep (BuilderT (Wise rep) (State VNameSource)))
Stms (Wise rep)
</span><a href="#local-6989586621684369627"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-573"></span><span>    </span><span class="annot"><span class="annottext">Result -&gt; BuilderT (Wise rep) (State VNameSource) Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369626"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-574"></span><span>
</span><span id="line-575"></span><span id="local-6989586621684370987"><span id="local-6989586621684370988"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#blockIf"><span class="hs-identifier hs-type">blockIf</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-576"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370988"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-577"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370988"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-578"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370988"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-579"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370988"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684370987"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-580"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370988"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684370987"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370988"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370988"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-581"></span><span id="blockIf"><span class="annot"><span class="annottext">blockIf :: forall rep a.
SimplifiableRep rep =&gt;
BlockPred (Wise rep)
-&gt; Stms (Wise rep)
-&gt; SimpleM rep (a, UsageTable)
-&gt; SimpleM rep (a, Stms (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockIf"><span class="hs-identifier hs-var hs-var">blockIf</span></a></span></span><span> </span><span id="local-6989586621684369613"><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684369613"><span class="hs-identifier hs-var">block</span></a></span></span><span> </span><span id="local-6989586621684369612"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369612"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684369611"><span class="annot"><span class="annottext">SimpleM rep (a, UsageTable)
</span><a href="#local-6989586621684369611"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-582"></span><span>  </span><span id="local-6989586621684369610"><span class="annot"><span class="annottext">RuleBook (Wise rep)
</span><a href="#local-6989586621684369610"><span class="hs-identifier hs-var">rules</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep -&gt; RuleBook (Wise rep))
-&gt; SimpleM rep (RuleBook (Wise rep))
forall rep a. (Env rep -&gt; a) -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#asksEngineEnv"><span class="hs-identifier hs-var">asksEngineEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env rep -&gt; RuleBook (Wise rep)
forall rep. Env rep -&gt; RuleBook (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#envRules"><span class="hs-identifier hs-var hs-var">envRules</span></a></span><span>
</span><span id="line-583"></span><span>  </span><span class="annot"><span class="annottext">RuleBook (Wise rep)
-&gt; BlockPred (Wise rep)
-&gt; Stms (Wise rep)
-&gt; SimpleM rep (a, UsageTable)
-&gt; SimpleM rep (a, Stms (Wise rep), Stms (Wise rep))
forall rep a.
SimplifiableRep rep =&gt;
RuleBook (Wise rep)
-&gt; BlockPred (Wise rep)
-&gt; Stms (Wise rep)
-&gt; SimpleM rep (a, UsageTable)
-&gt; SimpleM rep (a, Stms (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#hoistStms"><span class="hs-identifier hs-var">hoistStms</span></a></span><span> </span><span class="annot"><span class="annottext">RuleBook (Wise rep)
</span><a href="#local-6989586621684369610"><span class="hs-identifier hs-var">rules</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684369613"><span class="hs-identifier hs-var">block</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369612"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (a, UsageTable)
</span><a href="#local-6989586621684369611"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-584"></span><span>
</span><span id="line-585"></span><span id="local-6989586621684370984"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#hasFree"><span class="hs-identifier hs-type">hasFree</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370984"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370984"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-586"></span><span id="hasFree"><span class="annot"><span class="annottext">hasFree :: forall rep. ASTRep rep =&gt; Names -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#hasFree"><span class="hs-identifier hs-var hs-var">hasFree</span></a></span></span><span> </span><span id="local-6989586621684369573"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369573"><span class="hs-identifier hs-var">ks</span></a></span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684369572"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369572"><span class="hs-identifier hs-var">need</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369573"><span class="hs-identifier hs-var">ks</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#namesIntersect"><span class="hs-operator hs-var">`namesIntersect`</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684369572"><span class="hs-identifier hs-var">need</span></a></span><span>
</span><span id="line-587"></span><span>
</span><span id="line-588"></span><span id="local-6989586621684369571"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#isNotSafe"><span class="hs-identifier hs-type">isNotSafe</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684369571"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684369571"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-589"></span><span id="isNotSafe"><span class="annot"><span class="annottext">isNotSafe :: forall rep. ASTRep rep =&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isNotSafe"><span class="hs-identifier hs-var hs-var">isNotSafe</span></a></span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (Stm rep -&gt; Bool) -&gt; Stm rep -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Exp rep -&gt; Bool
forall rep. IsOp (Op rep) =&gt; Exp rep -&gt; Bool
</span><a href="Futhark.IR.Prop.html#safeExp"><span class="hs-identifier hs-var">safeExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Bool) -&gt; (Stm rep -&gt; Exp rep) -&gt; Stm rep -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Exp rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span>
</span><span id="line-590"></span><span>
</span><span id="line-591"></span><span id="local-6989586621684370981"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#isConsuming"><span class="hs-identifier hs-type">isConsuming</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#Aliased"><span class="hs-identifier hs-type">Aliased</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370981"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370981"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-592"></span><span id="isConsuming"><span class="annot"><span class="annottext">isConsuming :: forall rep. Aliased rep =&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isConsuming"><span class="hs-identifier hs-var hs-var">isConsuming</span></a></span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp rep -&gt; Bool
forall {rep}. Aliased rep =&gt; Exp rep -&gt; Bool
</span><a href="#local-6989586621684369562"><span class="hs-identifier hs-var">isUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Bool) -&gt; (Stm rep -&gt; Exp rep) -&gt; Stm rep -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Exp rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span>
</span><span id="line-593"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-594"></span><span>    </span><span id="local-6989586621684369562"><span class="annot"><span class="annottext">isUpdate :: Exp rep -&gt; Bool
</span><a href="#local-6989586621684369562"><span class="hs-identifier hs-var hs-var">isUpdate</span></a></span></span><span> </span><span id="local-6989586621684369556"><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684369556"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp rep -&gt; Names
forall rep. Aliased rep =&gt; Exp rep -&gt; Names
</span><a href="Futhark.IR.Prop.Aliases.html#consumedInExp"><span class="hs-identifier hs-var">consumedInExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684369556"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span id="local-6989586621684369553"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#isNotCheap"><span class="hs-identifier hs-type">isNotCheap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684369553"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684369553"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-597"></span><span id="isNotCheap"><span class="annot"><span class="annottext">isNotCheap :: forall rep. ASTRep rep =&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isNotCheap"><span class="hs-identifier hs-var hs-var">isNotCheap</span></a></span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (Stm rep -&gt; Bool) -&gt; Stm rep -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Bool
forall rep. ASTRep rep =&gt; Stm rep -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Engine.html#cheapStm"><span class="hs-identifier hs-var">cheapStm</span></a></span><span>
</span><span id="line-598"></span><span>
</span><span id="line-599"></span><span id="local-6989586621684370976"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#cheapStm"><span class="hs-identifier hs-type">cheapStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370976"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370976"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-600"></span><span id="cheapStm"><span class="annot"><span class="annottext">cheapStm :: forall rep. ASTRep rep =&gt; Stm rep -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Engine.html#cheapStm"><span class="hs-identifier hs-var hs-var">cheapStm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp rep -&gt; Bool
forall {rep}. ASTRep rep =&gt; Exp rep -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-var">cheapExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Bool) -&gt; (Stm rep -&gt; Exp rep) -&gt; Stm rep -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Exp rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span>
</span><span id="line-601"></span><span>
</span><span id="line-602"></span><span id="local-6989586621684369546"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-type">cheapExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684369546"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684369546"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-603"></span><span id="cheapExp"><span class="annot"><span class="annottext">cheapExp :: forall {rep}. ASTRep rep =&gt; Exp rep -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-var hs-var">cheapExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-604"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-var">cheapExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-605"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-var">cheapExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#UnOp"><span class="hs-identifier hs-type">UnOp</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-606"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-var">cheapExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#CmpOp"><span class="hs-identifier hs-type">CmpOp</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-607"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-var">cheapExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#ConvOp"><span class="hs-identifier hs-type">ConvOp</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-608"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-var">cheapExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-type">Copy</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-609"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-var">cheapExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-610"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-var">cheapExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Manifest"><span class="hs-identifier hs-type">Manifest</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-611"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-var">cheapExp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-612"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-var">cheapExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684369531"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684369531"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span> </span><span id="local-6989586621684369530"><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684369530"><span class="hs-identifier hs-var">fbranch</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfDec (BranchType rep)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-613"></span><span>  </span><span class="annot"><span class="annottext">(Stm rep -&gt; Bool) -&gt; Seq (Stm rep) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Bool
forall rep. ASTRep rep =&gt; Stm rep -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Engine.html#cheapStm"><span class="hs-identifier hs-var">cheapStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT rep -&gt; Seq (Stm rep)
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684369531"><span class="hs-identifier hs-var">tbranch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-614"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; Bool) -&gt; Seq (Stm rep) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Bool
forall rep. ASTRep rep =&gt; Stm rep -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Engine.html#cheapStm"><span class="hs-identifier hs-var">cheapStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT rep -&gt; Seq (Stm rep)
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT rep
</span><a href="#local-6989586621684369530"><span class="hs-identifier hs-var">fbranch</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-615"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-var">cheapExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span id="local-6989586621684369528"><span class="annot"><span class="annottext">Op rep
</span><a href="#local-6989586621684369528"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Op rep -&gt; Bool
forall op. IsOp op =&gt; op -&gt; Bool
</span><a href="Futhark.IR.Prop.html#cheapOp"><span class="hs-identifier hs-var">cheapOp</span></a></span><span> </span><span class="annot"><span class="annottext">Op rep
</span><a href="#local-6989586621684369528"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-616"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#cheapExp"><span class="hs-identifier hs-var">cheapExp</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-comment">-- Used to be False, but</span><span>
</span><span id="line-617"></span><span class="hs-comment">-- let's try it out.</span><span>
</span><span id="line-618"></span><span>
</span><span id="line-619"></span><span id="local-6989586621684370972"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#stmIs"><span class="hs-identifier hs-type">stmIs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370972"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370972"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-620"></span><span id="stmIs"><span class="annot"><span class="annottext">stmIs :: forall rep. (Stm rep -&gt; Bool) -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#stmIs"><span class="hs-identifier hs-var hs-var">stmIs</span></a></span></span><span> </span><span id="local-6989586621684369525"><span class="annot"><span class="annottext">Stm rep -&gt; Bool
</span><a href="#local-6989586621684369525"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Bool
</span><a href="#local-6989586621684369525"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-621"></span><span>
</span><span id="line-622"></span><span id="local-6989586621684370970"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#loopInvariantStm"><span class="hs-identifier hs-type">loopInvariantStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370970"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#SymbolTable"><span class="hs-identifier hs-type">ST.SymbolTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370970"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370970"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-623"></span><span id="loopInvariantStm"><span class="annot"><span class="annottext">loopInvariantStm :: forall rep. ASTRep rep =&gt; SymbolTable rep -&gt; Stm rep -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Engine.html#loopInvariantStm"><span class="hs-identifier hs-var hs-var">loopInvariantStm</span></a></span></span><span> </span><span id="local-6989586621684369486"><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684369486"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-624"></span><span>  </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep -&gt; Names
forall rep. SymbolTable rep -&gt; Names
</span><a href="Futhark.Analysis.SymbolTable.html#availableAtClosestLoop"><span class="hs-identifier hs-var hs-var">ST.availableAtClosestLoop</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable rep
</span><a href="#local-6989586621684369486"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Bool) -&gt; (Stm rep -&gt; [VName]) -&gt; Stm rep -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; [VName]) -&gt; (Stm rep -&gt; Names) -&gt; Stm rep -&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span>
</span><span id="line-625"></span><span>
</span><span id="line-626"></span><span id="local-6989586621684370967"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#hoistCommon"><span class="hs-identifier hs-type">hoistCommon</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-627"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370967"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-628"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-629"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#Usages"><span class="hs-identifier hs-type">UT.Usages</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-630"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-631"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#IfSort"><span class="hs-identifier hs-type">IfSort</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-632"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-633"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-634"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span>
</span><span id="line-635"></span><span>    </span><span class="annot"><a href="#local-6989586621684370967"><span class="hs-identifier hs-type">rep</span></a></span><span>
</span><span id="line-636"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-637"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-638"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-639"></span><span>    </span><span class="hs-special">)</span></span><span>
</span><span id="line-640"></span><span id="hoistCommon"><span class="annot"><span class="annottext">hoistCommon :: forall rep.
SimplifiableRep rep =&gt;
UsageTable
-&gt; [Usages]
-&gt; SubExp
-&gt; IfSort
-&gt; Body (Wise rep)
-&gt; Body (Wise rep)
-&gt; SimpleM rep (Body (Wise rep), Body (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#hoistCommon"><span class="hs-identifier hs-var hs-var">hoistCommon</span></a></span></span><span> </span><span id="local-6989586621684369444"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369444"><span class="hs-identifier hs-var">res_usage</span></a></span></span><span> </span><span id="local-6989586621684369443"><span class="annot"><span class="annottext">[Usages]
</span><a href="#local-6989586621684369443"><span class="hs-identifier hs-var">res_usages</span></a></span></span><span> </span><span id="local-6989586621684369442"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369442"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684369441"><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684369441"><span class="hs-identifier hs-var">ifsort</span></a></span></span><span> </span><span id="local-6989586621684369440"><span class="annot"><span class="annottext">Body (Wise rep)
</span><a href="#local-6989586621684369440"><span class="hs-identifier hs-var">body1</span></a></span></span><span> </span><span id="local-6989586621684369439"><span class="annot"><span class="annottext">Body (Wise rep)
</span><a href="#local-6989586621684369439"><span class="hs-identifier hs-var">body2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-641"></span><span>  </span><span id="local-6989586621684369438"><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; Bool
</span><a href="#local-6989586621684369438"><span class="hs-identifier hs-var">is_alloc_fun</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep -&gt; Stm (Wise rep) -&gt; Bool)
-&gt; SimpleM rep (Stm (Wise rep) -&gt; Bool)
forall rep a. (Env rep -&gt; a) -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#asksEngineEnv"><span class="hs-identifier hs-var">asksEngineEnv</span></a></span><span> </span><span class="annot"><span class="annottext">((Env rep -&gt; Stm (Wise rep) -&gt; Bool)
 -&gt; SimpleM rep (Stm (Wise rep) -&gt; Bool))
-&gt; (Env rep -&gt; Stm (Wise rep) -&gt; Bool)
-&gt; SimpleM rep (Stm (Wise rep) -&gt; Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HoistBlockers rep -&gt; Stm (Wise rep) -&gt; Bool
forall rep. HoistBlockers rep -&gt; Stm (Wise rep) -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Engine.html#isAllocation"><span class="hs-identifier hs-var hs-var">isAllocation</span></a></span><span> </span><span class="annot"><span class="annottext">(HoistBlockers rep -&gt; Stm (Wise rep) -&gt; Bool)
-&gt; (Env rep -&gt; HoistBlockers rep)
-&gt; Env rep
-&gt; Stm (Wise rep)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Env rep -&gt; HoistBlockers rep
forall rep. Env rep -&gt; HoistBlockers rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#envHoistBlockers"><span class="hs-identifier hs-var hs-var">envHoistBlockers</span></a></span><span>
</span><span id="line-642"></span><span>  </span><span id="local-6989586621684369437"><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684369437"><span class="hs-identifier hs-var">branch_blocker</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep -&gt; BlockPred (Wise rep))
-&gt; SimpleM rep (BlockPred (Wise rep))
forall rep a. (Env rep -&gt; a) -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#asksEngineEnv"><span class="hs-identifier hs-var">asksEngineEnv</span></a></span><span> </span><span class="annot"><span class="annottext">((Env rep -&gt; BlockPred (Wise rep))
 -&gt; SimpleM rep (BlockPred (Wise rep)))
-&gt; (Env rep -&gt; BlockPred (Wise rep))
-&gt; SimpleM rep (BlockPred (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HoistBlockers rep -&gt; BlockPred (Wise rep)
forall rep. HoistBlockers rep -&gt; BlockPred (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockHoistBranch"><span class="hs-identifier hs-var hs-var">blockHoistBranch</span></a></span><span> </span><span class="annot"><span class="annottext">(HoistBlockers rep -&gt; BlockPred (Wise rep))
-&gt; (Env rep -&gt; HoistBlockers rep)
-&gt; Env rep
-&gt; BlockPred (Wise rep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Env rep -&gt; HoistBlockers rep
forall rep. Env rep -&gt; HoistBlockers rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#envHoistBlockers"><span class="hs-identifier hs-var hs-var">envHoistBlockers</span></a></span><span>
</span><span id="line-643"></span><span>  </span><span id="local-6989586621684369436"><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684369436"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleM rep (SymbolTable (Wise rep))
forall rep. SimpleM rep (SymbolTable (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#askVtable"><span class="hs-identifier hs-var">askVtable</span></a></span><span>
</span><span id="line-644"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- We are unwilling to hoist things that are unsafe or costly,</span><span>
</span><span id="line-645"></span><span>      </span><span class="hs-comment">-- except if they are invariant to the most enclosing loop,</span><span>
</span><span id="line-646"></span><span>      </span><span class="hs-comment">-- because in that case they will also be hoisted past that</span><span>
</span><span id="line-647"></span><span>      </span><span class="hs-comment">-- loop.</span><span>
</span><span id="line-648"></span><span>      </span><span class="hs-comment">--</span><span>
</span><span id="line-649"></span><span>      </span><span class="hs-comment">-- We also try very hard to hoist allocations or anything that</span><span>
</span><span id="line-650"></span><span>      </span><span class="hs-comment">-- contributes to memory or array size, because that will allow</span><span>
</span><span id="line-651"></span><span>      </span><span class="hs-comment">-- allocations to be hoisted.</span><span>
</span><span id="line-652"></span><span>      </span><span id="local-6989586621684369435"><span class="annot"><span class="annottext">cond_loop_invariant :: Bool
</span><a href="#local-6989586621684369435"><span class="hs-identifier hs-var hs-var">cond_loop_invariant</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-653"></span><span>        </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep) -&gt; Names
forall rep. SymbolTable rep -&gt; Names
</span><a href="Futhark.Analysis.SymbolTable.html#availableAtClosestLoop"><span class="hs-identifier hs-var hs-var">ST.availableAtClosestLoop</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684369436"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Bool) -&gt; [VName] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; [VName]) -&gt; Names -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369442"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-654"></span><span>
</span><span id="line-655"></span><span>      </span><span id="local-6989586621684369434"><span class="annot"><span class="annottext">desirableToHoist :: Stm (Wise rep) -&gt; Bool
</span><a href="#local-6989586621684369434"><span class="hs-identifier hs-var hs-var">desirableToHoist</span></a></span></span><span> </span><span id="local-6989586621684369433"><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369433"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-656"></span><span>        </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; Bool
</span><a href="#local-6989586621684369438"><span class="hs-identifier hs-var">is_alloc_fun</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369433"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-657"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep) -&gt; Int
forall rep. SymbolTable rep -&gt; Int
</span><a href="Futhark.Analysis.SymbolTable.html#loopDepth"><span class="hs-identifier hs-var hs-var">ST.loopDepth</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684369436"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-658"></span><span>                 </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684369435"><span class="hs-identifier hs-var">cond_loop_invariant</span></a></span><span>
</span><span id="line-659"></span><span>                 </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684369441"><span class="hs-identifier hs-var">ifsort</span></a></span><span> </span><span class="annot"><span class="annottext">IfSort -&gt; IfSort -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="Futhark.IR.Syntax.html#IfFallback"><span class="hs-identifier hs-var">IfFallback</span></a></span><span>
</span><span id="line-660"></span><span>                 </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep) -&gt; Stm (Wise rep) -&gt; Bool
forall rep. ASTRep rep =&gt; SymbolTable rep -&gt; Stm rep -&gt; Bool
</span><a href="Futhark.Optimise.Simplify.Engine.html#loopInvariantStm"><span class="hs-identifier hs-var">loopInvariantStm</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684369436"><span class="hs-identifier hs-var">vtable</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369433"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-661"></span><span>             </span><span class="hs-special">)</span><span>
</span><span id="line-662"></span><span>
</span><span id="line-663"></span><span>      </span><span class="hs-comment">-- No matter what, we always want to hoist constants as much as</span><span>
</span><span id="line-664"></span><span>      </span><span class="hs-comment">-- possible.</span><span>
</span><span id="line-665"></span><span>      </span><span id="local-6989586621684369431"><span class="annot"><span class="annottext">isNotHoistableBnd :: BlockPred (Wise rep)
</span><a href="#local-6989586621684369431"><span class="hs-identifier hs-var hs-var">isNotHoistableBnd</span></a></span></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec (Wise rep))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#ArrayLit"><span class="hs-identifier hs-type">ArrayLit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-666"></span><span>      </span><span class="annot"><a href="#local-6989586621684369431"><span class="hs-identifier hs-var">isNotHoistableBnd</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec (Wise rep))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-667"></span><span>      </span><span class="annot"><a href="#local-6989586621684369431"><span class="hs-identifier hs-var">isNotHoistableBnd</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684369429"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369429"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684369428"><span class="annot"><span class="annottext">Pat (Wise rep)
</span><a href="#local-6989586621684369428"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec (Wise rep))
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExpT (Wise rep)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-668"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Bool
</span><a href="Futhark.Analysis.UsageTable.html#isSize"><span class="hs-operator hs-var">`UT.isSize`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369429"><span class="hs-identifier hs-var">usage</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Bool) -&gt; [VName] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDec rep) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDec rep)
Pat (Wise rep)
</span><a href="#local-6989586621684369428"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-669"></span><span>          </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-670"></span><span>      </span><span class="annot"><a href="#local-6989586621684369431"><span class="hs-identifier hs-var">isNotHoistableBnd</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684369427"><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369427"><span class="hs-identifier hs-var">stm</span></a></span></span><span>
</span><span id="line-671"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; Bool
</span><a href="#local-6989586621684369438"><span class="hs-identifier hs-var">is_alloc_fun</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><a href="#local-6989586621684369427"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-672"></span><span>      </span><span class="annot"><a href="#local-6989586621684369431"><span class="hs-identifier hs-var">isNotHoistableBnd</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-673"></span><span>        </span><span class="hs-comment">-- Hoist aggressively out of versioning branches.</span><span>
</span><span id="line-674"></span><span>        </span><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684369441"><span class="hs-identifier hs-var">ifsort</span></a></span><span> </span><span class="annot"><span class="annottext">IfSort -&gt; IfSort -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="Futhark.IR.Syntax.html#IfEquiv"><span class="hs-identifier hs-var">IfEquiv</span></a></span><span>
</span><span id="line-675"></span><span>
</span><span id="line-676"></span><span>      </span><span id="local-6989586621684369425"><span class="annot"><span class="annottext">block :: BlockPred (Wise rep)
</span><a href="#local-6989586621684369425"><span class="hs-identifier hs-var hs-var">block</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-677"></span><span>        </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684369437"><span class="hs-identifier hs-var">branch_blocker</span></a></span><span>
</span><span id="line-678"></span><span>          </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; BlockPred (Wise rep) -&gt; BlockPred (Wise rep)
forall rep. BlockPred rep -&gt; BlockPred rep -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#orIf"><span class="hs-operator hs-var">`orIf`</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep. ASTRep rep =&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isNotSafe"><span class="hs-identifier hs-var">isNotSafe</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; BlockPred (Wise rep) -&gt; BlockPred (Wise rep)
forall rep. BlockPred rep -&gt; BlockPred rep -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#orIf"><span class="hs-operator hs-var">`orIf`</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep. ASTRep rep =&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isNotCheap"><span class="hs-identifier hs-var">isNotCheap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; BlockPred (Wise rep) -&gt; BlockPred (Wise rep)
forall rep. BlockPred rep -&gt; BlockPred rep -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#andAlso"><span class="hs-operator hs-var">`andAlso`</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; Bool) -&gt; BlockPred (Wise rep)
forall rep. (Stm rep -&gt; Bool) -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#stmIs"><span class="hs-identifier hs-var">stmIs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; (Stm (Wise rep) -&gt; Bool) -&gt; Stm (Wise rep) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; Bool
</span><a href="#local-6989586621684369434"><span class="hs-identifier hs-var">desirableToHoist</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span>          </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; BlockPred (Wise rep) -&gt; BlockPred (Wise rep)
forall rep. BlockPred rep -&gt; BlockPred rep -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#orIf"><span class="hs-operator hs-var">`orIf`</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep. Aliased rep =&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isConsuming"><span class="hs-identifier hs-var">isConsuming</span></a></span><span>
</span><span id="line-680"></span><span>          </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; BlockPred (Wise rep) -&gt; BlockPred (Wise rep)
forall rep. BlockPred rep -&gt; BlockPred rep -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#orIf"><span class="hs-operator hs-var">`orIf`</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684369431"><span class="hs-identifier hs-var">isNotHoistableBnd</span></a></span><span>
</span><span id="line-681"></span><span>
</span><span id="line-682"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684369424"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369424"><span class="hs-identifier hs-var">hoisted1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369423"><span class="annot"><span class="annottext">Body (Wise rep)
</span><a href="#local-6989586621684369423"><span class="hs-identifier hs-var">body1'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-683"></span><span>    </span><span class="annot"><span class="annottext">SubExp
-&gt; Bool
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
forall rep a.
SimplifiableRep rep =&gt;
SubExp
-&gt; Bool
-&gt; SimpleM rep (Stms (Wise rep), a)
-&gt; SimpleM rep (Stms (Wise rep), a)
</span><a href="Futhark.Optimise.Simplify.Engine.html#protectIfHoisted"><span class="hs-identifier hs-var">protectIfHoisted</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369442"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep (Stms (Wise rep), Body (Wise rep))
 -&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep)))
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-684"></span><span>      </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; UsageTable
-&gt; [Usages]
-&gt; Body (Wise rep)
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
BlockPred (Wise rep)
-&gt; UsageTable
-&gt; [Usages]
-&gt; Body (Wise rep)
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyBody"><span class="hs-identifier hs-var">simplifyBody</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684369425"><span class="hs-identifier hs-var">block</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369444"><span class="hs-identifier hs-var">res_usage</span></a></span><span> </span><span class="annot"><span class="annottext">[Usages]
</span><a href="#local-6989586621684369443"><span class="hs-identifier hs-var">res_usages</span></a></span><span> </span><span class="annot"><span class="annottext">Body (Wise rep)
</span><a href="#local-6989586621684369440"><span class="hs-identifier hs-var">body1</span></a></span><span>
</span><span id="line-685"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684369422"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369422"><span class="hs-identifier hs-var">hoisted2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369421"><span class="annot"><span class="annottext">Body (Wise rep)
</span><a href="#local-6989586621684369421"><span class="hs-identifier hs-var">body2'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-686"></span><span>    </span><span class="annot"><span class="annottext">SubExp
-&gt; Bool
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
forall rep a.
SimplifiableRep rep =&gt;
SubExp
-&gt; Bool
-&gt; SimpleM rep (Stms (Wise rep), a)
-&gt; SimpleM rep (Stms (Wise rep), a)
</span><a href="Futhark.Optimise.Simplify.Engine.html#protectIfHoisted"><span class="hs-identifier hs-var">protectIfHoisted</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369442"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep (Stms (Wise rep), Body (Wise rep))
 -&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep)))
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-687"></span><span>      </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; UsageTable
-&gt; [Usages]
-&gt; Body (Wise rep)
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
BlockPred (Wise rep)
-&gt; UsageTable
-&gt; [Usages]
-&gt; Body (Wise rep)
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyBody"><span class="hs-identifier hs-var">simplifyBody</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684369425"><span class="hs-identifier hs-var">block</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369444"><span class="hs-identifier hs-var">res_usage</span></a></span><span> </span><span class="annot"><span class="annottext">[Usages]
</span><a href="#local-6989586621684369443"><span class="hs-identifier hs-var">res_usages</span></a></span><span> </span><span class="annot"><span class="annottext">Body (Wise rep)
</span><a href="#local-6989586621684369439"><span class="hs-identifier hs-var">body2</span></a></span><span>
</span><span id="line-688"></span><span>  </span><span class="annot"><span class="annottext">(Body (Wise rep), Body (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Body (Wise rep), Body (Wise rep), Stms (Wise rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body (Wise rep)
</span><a href="#local-6989586621684369423"><span class="hs-identifier hs-var">body1'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Body (Wise rep)
</span><a href="#local-6989586621684369421"><span class="hs-identifier hs-var">body2'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369424"><span class="hs-identifier hs-var">hoisted1</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep) -&gt; Stms (Wise rep) -&gt; Stms (Wise rep)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369422"><span class="hs-identifier hs-var">hoisted2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-689"></span><span>
</span><span id="line-690"></span><span class="hs-comment">-- | Simplify a single body.</span><span>
</span><span id="line-691"></span><span id="local-6989586621684370965"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyBody"><span class="hs-identifier hs-type">simplifyBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-692"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370965"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-693"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370965"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-694"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-695"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#Usages"><span class="hs-identifier hs-type">UT.Usages</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-696"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370965"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-697"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370965"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370965"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370965"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-698"></span><span id="simplifyBody"><span class="annot"><span class="annottext">simplifyBody :: forall rep.
SimplifiableRep rep =&gt;
BlockPred (Wise rep)
-&gt; UsageTable
-&gt; [Usages]
-&gt; Body (Wise rep)
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyBody"><span class="hs-identifier hs-var hs-var">simplifyBody</span></a></span></span><span> </span><span id="local-6989586621684369403"><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684369403"><span class="hs-identifier hs-var">blocker</span></a></span></span><span> </span><span id="local-6989586621684369402"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369402"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span id="local-6989586621684369401"><span class="annot"><span class="annottext">[Usages]
</span><a href="#local-6989586621684369401"><span class="hs-identifier hs-var">res_usages</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec (Wise rep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684369399"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369399"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684369398"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369398"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-699"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684369397"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369397"><span class="hs-identifier hs-var">res'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369396"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369396"><span class="hs-identifier hs-var">stms'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369395"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369395"><span class="hs-identifier hs-var">hoisted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-700"></span><span>    </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; Stms (Wise rep)
-&gt; SimpleM rep (Result, UsageTable)
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall rep a.
SimplifiableRep rep =&gt;
BlockPred (Wise rep)
-&gt; Stms (Wise rep)
-&gt; SimpleM rep (a, UsageTable)
-&gt; SimpleM rep (a, Stms (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockIf"><span class="hs-identifier hs-var">blockIf</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684369403"><span class="hs-identifier hs-var">blocker</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369399"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep (Result, UsageTable)
 -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; SimpleM rep (Result, UsageTable)
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-701"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684369394"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369394"><span class="hs-identifier hs-var">res'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369393"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369393"><span class="hs-identifier hs-var">res_usage</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Usages] -&gt; Result -&gt; SimpleM rep (Result, UsageTable)
forall rep.
SimplifiableRep rep =&gt;
[Usages] -&gt; Result -&gt; SimpleM rep (Result, UsageTable)
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyResult"><span class="hs-identifier hs-var">simplifyResult</span></a></span><span> </span><span class="annot"><span class="annottext">[Usages]
</span><a href="#local-6989586621684369401"><span class="hs-identifier hs-var">res_usages</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369398"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-702"></span><span>      </span><span class="annot"><span class="annottext">(Result, UsageTable) -&gt; SimpleM rep (Result, UsageTable)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369394"><span class="hs-identifier hs-var">res'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369393"><span class="hs-identifier hs-var">res_usage</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable -&gt; UsageTable -&gt; UsageTable
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369402"><span class="hs-identifier hs-var">usage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-703"></span><span>  </span><span id="local-6989586621684369391"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369391"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep) -&gt; Result -&gt; SimpleM rep (BodyT (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
Stms (Wise rep) -&gt; Result -&gt; SimpleM rep (Body (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#constructBody"><span class="hs-identifier hs-var">constructBody</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369396"><span class="hs-identifier hs-var">stms'</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369397"><span class="hs-identifier hs-var">res'</span></a></span><span>
</span><span id="line-704"></span><span>  </span><span class="annot"><span class="annottext">(Stms (Wise rep), BodyT (Wise rep))
-&gt; SimpleM rep (Stms (Wise rep), BodyT (Wise rep))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369395"><span class="hs-identifier hs-var">hoisted</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369391"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-705"></span><span>
</span><span id="line-706"></span><span class="hs-comment">-- | Simplify a single body.</span><span>
</span><span id="line-707"></span><span id="local-6989586621684370962"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyBodyNoHoisting"><span class="hs-identifier hs-type">simplifyBodyNoHoisting</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-708"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370962"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-709"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-710"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#Usages"><span class="hs-identifier hs-type">UT.Usages</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-711"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370962"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-712"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370962"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370962"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-713"></span><span id="simplifyBodyNoHoisting"><span class="annot"><span class="annottext">simplifyBodyNoHoisting :: forall rep.
SimplifiableRep rep =&gt;
UsageTable
-&gt; [Usages] -&gt; Body (Wise rep) -&gt; SimpleM rep (Body (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyBodyNoHoisting"><span class="hs-identifier hs-var hs-var">simplifyBodyNoHoisting</span></a></span></span><span> </span><span id="local-6989586621684369379"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369379"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span id="local-6989586621684369378"><span class="annot"><span class="annottext">[Usages]
</span><a href="#local-6989586621684369378"><span class="hs-identifier hs-var">res_usages</span></a></span></span><span> </span><span id="local-6989586621684369377"><span class="annot"><span class="annottext">Body (Wise rep)
</span><a href="#local-6989586621684369377"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-714"></span><span>  </span><span class="annot"><span class="annottext">(Stms (Wise rep), Body (Wise rep)) -&gt; Body (Wise rep)
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((Stms (Wise rep), Body (Wise rep)) -&gt; Body (Wise rep))
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
-&gt; SimpleM rep (Body (Wise rep))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; UsageTable
-&gt; [Usages]
-&gt; Body (Wise rep)
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
BlockPred (Wise rep)
-&gt; UsageTable
-&gt; [Usages]
-&gt; Body (Wise rep)
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyBody"><span class="hs-identifier hs-var">simplifyBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; BlockPred (Wise rep)
forall rep. Bool -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isFalse"><span class="hs-identifier hs-var">isFalse</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369379"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">[Usages]
</span><a href="#local-6989586621684369378"><span class="hs-identifier hs-var">res_usages</span></a></span><span> </span><span class="annot"><span class="annottext">Body (Wise rep)
</span><a href="#local-6989586621684369377"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-715"></span><span>
</span><span id="line-716"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#usageFromDiet"><span class="hs-identifier hs-type">usageFromDiet</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Diet"><span class="hs-identifier hs-type">Diet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#Usages"><span class="hs-identifier hs-type">UT.Usages</span></a></span><span>
</span><span id="line-717"></span><span id="usageFromDiet"><span class="annot"><span class="annottext">usageFromDiet :: Diet -&gt; Usages
</span><a href="Futhark.Optimise.Simplify.Engine.html#usageFromDiet"><span class="hs-identifier hs-var hs-var">usageFromDiet</span></a></span></span><span> </span><span class="annot"><span class="annottext">Diet
</span><a href="Futhark.IR.Syntax.Core.html#Consume"><span class="hs-identifier hs-var">Consume</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Usages
</span><a href="Futhark.Analysis.UsageTable.html#consumedU"><span class="hs-identifier hs-var">UT.consumedU</span></a></span><span>
</span><span id="line-718"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#usageFromDiet"><span class="hs-identifier hs-var">usageFromDiet</span></a></span><span> </span><span class="annot"><span class="annottext">Diet
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Usages
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-719"></span><span>
</span><span id="line-720"></span><span class="hs-comment">-- | Simplify a single 'Result'.</span><span>
</span><span id="line-721"></span><span id="local-6989586621684370963"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyResult"><span class="hs-identifier hs-type">simplifyResult</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-722"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370963"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#Usages"><span class="hs-identifier hs-type">UT.Usages</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Result"><span class="hs-identifier hs-type">Result</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370963"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Result"><span class="hs-identifier hs-type">Result</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-723"></span><span id="simplifyResult"><span class="annot"><span class="annottext">simplifyResult :: forall rep.
SimplifiableRep rep =&gt;
[Usages] -&gt; Result -&gt; SimpleM rep (Result, UsageTable)
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyResult"><span class="hs-identifier hs-var hs-var">simplifyResult</span></a></span></span><span> </span><span id="local-6989586621684369347"><span class="annot"><span class="annottext">[Usages]
</span><a href="#local-6989586621684369347"><span class="hs-identifier hs-var">usages</span></a></span></span><span> </span><span id="local-6989586621684369346"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369346"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-724"></span><span>  </span><span id="local-6989586621684369345"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369345"><span class="hs-identifier hs-var">res'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SimpleM rep SubExpRes)
-&gt; Result -&gt; SimpleM rep Result
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SimpleM rep SubExpRes
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369346"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-725"></span><span>  </span><span id="local-6989586621684369343"><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684369343"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleM rep (SymbolTable (Wise rep))
forall rep. SimpleM rep (SymbolTable (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#askVtable"><span class="hs-identifier hs-var">askVtable</span></a></span><span>
</span><span id="line-726"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684369342"><span class="annot"><span class="annottext">more_usages :: UsageTable
</span><a href="#local-6989586621684369342"><span class="hs-identifier hs-var hs-var">more_usages</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[UsageTable] -&gt; UsageTable
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([UsageTable] -&gt; UsageTable) -&gt; [UsageTable] -&gt; UsageTable
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-727"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684369341"><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621684369341"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684369340"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369340"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Usages] -&gt; [SubExp] -&gt; [(Usages, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Usages]
</span><a href="#local-6989586621684369347"><span class="hs-identifier hs-var">usages</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(Usages, SubExp)]) -&gt; [SubExp] -&gt; [(Usages, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; Result -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369346"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-728"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684369338"><span class="annot"><span class="annottext">als_usages :: [UsageTable]
</span><a href="#local-6989586621684369338"><span class="hs-identifier hs-var hs-var">als_usages</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-729"></span><span>              </span><span class="annot"><span class="annottext">(VName -&gt; UsageTable) -&gt; [VName] -&gt; [UsageTable]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span>
</span><span id="line-730"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Usages -&gt; UsageTable
</span><a href="Futhark.Analysis.UsageTable.html#usage"><span class="hs-operator hs-var">`UT.usage`</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621684369341"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">Usages -&gt; Usages -&gt; Usages
</span><a href="Futhark.Analysis.UsageTable.html#withoutU"><span class="hs-operator hs-var">`UT.withoutU`</span></a></span><span> </span><span class="annot"><span class="annottext">Usages
</span><a href="Futhark.Analysis.UsageTable.html#presentU"><span class="hs-identifier hs-var">UT.presentU</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-731"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SymbolTable (Wise rep) -&gt; Names
forall rep. VName -&gt; SymbolTable rep -&gt; Names
</span><a href="Futhark.Analysis.SymbolTable.html#lookupAliases"><span class="hs-identifier hs-var">ST.lookupAliases</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369340"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
</span><a href="#local-6989586621684369343"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-732"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; Usages -&gt; UsageTable
</span><a href="Futhark.Analysis.UsageTable.html#usage"><span class="hs-identifier hs-var">UT.usage</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369340"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Usages
</span><a href="#local-6989586621684369341"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable -&gt; [UsageTable] -&gt; [UsageTable]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[UsageTable]
</span><a href="#local-6989586621684369338"><span class="hs-identifier hs-var">als_usages</span></a></span><span>
</span><span id="line-733"></span><span>  </span><span class="annot"><span class="annottext">(Result, UsageTable) -&gt; SimpleM rep (Result, UsageTable)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369345"><span class="hs-identifier hs-var">res'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Names -&gt; UsageTable
</span><a href="Futhark.Analysis.UsageTable.html#usages"><span class="hs-identifier hs-var">UT.usages</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369345"><span class="hs-identifier hs-var">res'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UsageTable -&gt; UsageTable -&gt; UsageTable
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369342"><span class="hs-identifier hs-var">more_usages</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-734"></span><span>
</span><span id="line-735"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#isDoLoopResult"><span class="hs-identifier hs-type">isDoLoopResult</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Result"><span class="hs-identifier hs-type">Result</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span>
</span><span id="line-736"></span><span id="isDoLoopResult"><span class="annot"><span class="annottext">isDoLoopResult :: Result -&gt; UsageTable
</span><a href="Futhark.Optimise.Simplify.Engine.html#isDoLoopResult"><span class="hs-identifier hs-var hs-var">isDoLoopResult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[UsageTable] -&gt; UsageTable
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([UsageTable] -&gt; UsageTable)
-&gt; (Result -&gt; [UsageTable]) -&gt; Result -&gt; UsageTable
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; UsageTable) -&gt; Result -&gt; [UsageTable]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; UsageTable
</span><a href="#local-6989586621684369335"><span class="hs-identifier hs-var">checkForVar</span></a></span><span>
</span><span id="line-737"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-738"></span><span>    </span><span id="local-6989586621684369335"><span class="annot"><span class="annottext">checkForVar :: SubExpRes -&gt; UsageTable
</span><a href="#local-6989586621684369335"><span class="hs-identifier hs-var hs-var">checkForVar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684369332"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369332"><span class="hs-identifier hs-var">ident</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; UsageTable
</span><a href="Futhark.Analysis.UsageTable.html#inResultUsage"><span class="hs-identifier hs-var">UT.inResultUsage</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369332"><span class="hs-identifier hs-var">ident</span></a></span><span>
</span><span id="line-739"></span><span>    </span><span class="annot"><a href="#local-6989586621684369335"><span class="hs-identifier hs-var">checkForVar</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">UsageTable
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-740"></span><span>
</span><span id="line-741"></span><span id="local-6989586621684370953"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyStms"><span class="hs-identifier hs-type">simplifyStms</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-742"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370953"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-743"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370953"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-744"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370953"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370953"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-745"></span><span id="simplifyStms"><span class="annot"><span class="annottext">simplifyStms :: forall rep.
SimplifiableRep rep =&gt;
Stms (Wise rep) -&gt; SimpleM rep (Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyStms"><span class="hs-identifier hs-var hs-var">simplifyStms</span></a></span></span><span> </span><span id="local-6989586621684369319"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369319"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-746"></span><span>  </span><span class="annot"><span class="annottext">UsageTable -&gt; Stms (Wise rep) -&gt; SimpleM rep (Stms (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
UsageTable -&gt; Stms (Wise rep) -&gt; SimpleM rep (Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyStmsWithUsage"><span class="hs-identifier hs-var">simplifyStmsWithUsage</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369318"><span class="hs-identifier hs-var">all_used</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369319"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-747"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-748"></span><span>    </span><span id="local-6989586621684369318"><span class="annot"><span class="annottext">all_used :: UsageTable
</span><a href="#local-6989586621684369318"><span class="hs-identifier hs-var hs-var">all_used</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-749"></span><span>      </span><span class="annot"><span class="annottext">Names -&gt; UsageTable
</span><a href="Futhark.Analysis.UsageTable.html#usages"><span class="hs-identifier hs-var">UT.usages</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName (NameInfo (Wise rep)) -&gt; [VName]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms (Wise rep) -&gt; Map VName (NameInfo (Wise rep))
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369319"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-750"></span><span>
</span><span id="line-751"></span><span id="local-6989586621684370949"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyStmsWithUsage"><span class="hs-identifier hs-type">simplifyStmsWithUsage</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-752"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370949"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-753"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-754"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370949"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-755"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370949"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370949"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-756"></span><span id="simplifyStmsWithUsage"><span class="annot"><span class="annottext">simplifyStmsWithUsage :: forall rep.
SimplifiableRep rep =&gt;
UsageTable -&gt; Stms (Wise rep) -&gt; SimpleM rep (Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyStmsWithUsage"><span class="hs-identifier hs-var hs-var">simplifyStmsWithUsage</span></a></span></span><span> </span><span id="local-6989586621684369303"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369303"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span id="local-6989586621684369302"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369302"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-757"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369301"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369301"><span class="hs-identifier hs-var">stms'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; Stms (Wise rep)
-&gt; SimpleM rep ((), UsageTable)
-&gt; SimpleM rep ((), Stms (Wise rep), Stms (Wise rep))
forall rep a.
SimplifiableRep rep =&gt;
BlockPred (Wise rep)
-&gt; Stms (Wise rep)
-&gt; SimpleM rep (a, UsageTable)
-&gt; SimpleM rep (a, Stms (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockIf"><span class="hs-identifier hs-var">blockIf</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; BlockPred (Wise rep)
forall rep. Bool -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isFalse"><span class="hs-identifier hs-var">isFalse</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369302"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep ((), UsageTable)
 -&gt; SimpleM rep ((), Stms (Wise rep), Stms (Wise rep)))
-&gt; SimpleM rep ((), UsageTable)
-&gt; SimpleM rep ((), Stms (Wise rep), Stms (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((), UsageTable) -&gt; SimpleM rep ((), UsageTable)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369303"><span class="hs-identifier hs-var">usage</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-758"></span><span>  </span><span class="annot"><span class="annottext">Stms (Wise rep) -&gt; SimpleM rep (Stms (Wise rep))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369301"><span class="hs-identifier hs-var">stms'</span></a></span><span>
</span><span id="line-759"></span><span>
</span><span id="line-760"></span><span id="local-6989586621684370942"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyOp"><span class="hs-identifier hs-type">simplifyOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370942"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370942"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370942"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370942"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-761"></span><span id="simplifyOp"><span class="annot"><span class="annottext">simplifyOp :: forall rep.
Op (Wise rep) -&gt; SimpleM rep (Op (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyOp"><span class="hs-identifier hs-var hs-var">simplifyOp</span></a></span></span><span> </span><span id="local-6989586621684369297"><span class="annot"><span class="annottext">Op (Wise rep)
</span><a href="#local-6989586621684369297"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-762"></span><span>  </span><span id="local-6989586621684369296"><span class="annot"><span class="annottext">OpWithWisdom (Op rep)
-&gt; SimpleM rep (OpWithWisdom (Op rep), Stms (Wise rep))
</span><a href="#local-6989586621684369296"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((SimpleOps rep, Env rep)
 -&gt; OpWithWisdom (Op rep)
 -&gt; SimpleM rep (OpWithWisdom (Op rep), Stms (Wise rep)))
-&gt; SimpleM
     rep
     (OpWithWisdom (Op rep)
      -&gt; SimpleM rep (OpWithWisdom (Op rep), Stms (Wise rep)))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">(((SimpleOps rep, Env rep)
  -&gt; OpWithWisdom (Op rep)
  -&gt; SimpleM rep (OpWithWisdom (Op rep), Stms (Wise rep)))
 -&gt; SimpleM
      rep
      (OpWithWisdom (Op rep)
       -&gt; SimpleM rep (OpWithWisdom (Op rep), Stms (Wise rep))))
-&gt; ((SimpleOps rep, Env rep)
    -&gt; OpWithWisdom (Op rep)
    -&gt; SimpleM rep (OpWithWisdom (Op rep), Stms (Wise rep)))
-&gt; SimpleM
     rep
     (OpWithWisdom (Op rep)
      -&gt; SimpleM rep (OpWithWisdom (Op rep), Stms (Wise rep)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SimpleOps rep
-&gt; OpWithWisdom (Op rep)
-&gt; SimpleM rep (OpWithWisdom (Op rep), Stms (Wise rep))
forall rep. SimpleOps rep -&gt; SimplifyOp rep (Op (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyOpS"><span class="hs-identifier hs-var hs-var">simplifyOpS</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleOps rep
 -&gt; OpWithWisdom (Op rep)
 -&gt; SimpleM rep (OpWithWisdom (Op rep), Stms (Wise rep)))
-&gt; ((SimpleOps rep, Env rep) -&gt; SimpleOps rep)
-&gt; (SimpleOps rep, Env rep)
-&gt; OpWithWisdom (Op rep)
-&gt; SimpleM rep (OpWithWisdom (Op rep), Stms (Wise rep))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SimpleOps rep, Env rep) -&gt; SimpleOps rep
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span>
</span><span id="line-763"></span><span>  </span><span class="annot"><span class="annottext">OpWithWisdom (Op rep)
-&gt; SimpleM rep (OpWithWisdom (Op rep), Stms (Wise rep))
</span><a href="#local-6989586621684369296"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Op (Wise rep)
OpWithWisdom (Op rep)
</span><a href="#local-6989586621684369297"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-764"></span><span>
</span><span id="line-765"></span><span id="local-6989586621684371063"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyExp"><span class="hs-identifier hs-type">simplifyExp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-766"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371063"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-767"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-768"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371063"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-769"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371063"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-770"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371063"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371063"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371063"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-771"></span><span id="simplifyExp"><span class="annot"><span class="annottext">simplifyExp :: forall rep.
SimplifiableRep rep =&gt;
UsageTable
-&gt; Pat (Wise rep)
-&gt; Exp (Wise rep)
-&gt; SimpleM rep (Exp (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyExp"><span class="hs-identifier hs-var hs-var">simplifyExp</span></a></span></span><span> </span><span id="local-6989586621684369165"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369165"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span id="local-6989586621684369163"><span class="annot"><span class="annottext">[PatElemT (LetDec (Wise rep))]
</span><a href="#local-6989586621684369163"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span id="local-6989586621684369162"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369162"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684369161"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369161"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span> </span><span id="local-6989586621684369160"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369160"><span class="hs-identifier hs-var">fbranch</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-type">IfDec</span></a></span><span> </span><span id="local-6989586621684369159"><span class="annot"><span class="annottext">[BranchType (Wise rep)]
</span><a href="#local-6989586621684369159"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684369158"><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684369158"><span class="hs-identifier hs-var">ifsort</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-772"></span><span>  </span><span class="hs-comment">-- Here, we have to check whether 'cond' puts a bound on some free</span><span>
</span><span id="line-773"></span><span>  </span><span class="hs-comment">-- variable, and if so, chomp it.  We should also try to do CSE</span><span>
</span><span id="line-774"></span><span>  </span><span class="hs-comment">-- across branches.</span><span>
</span><span id="line-775"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684369157"><span class="annot"><span class="annottext">pes_usages :: [Usages]
</span><a href="#local-6989586621684369157"><span class="hs-identifier hs-var hs-var">pes_usages</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PatElemT (VarWisdom, LetDec rep) -&gt; Usages)
-&gt; [PatElemT (VarWisdom, LetDec rep)] -&gt; [Usages]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Usages -&gt; Maybe Usages -&gt; Usages
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Usages
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Usages -&gt; Usages)
-&gt; (PatElemT (VarWisdom, LetDec rep) -&gt; Maybe Usages)
-&gt; PatElemT (VarWisdom, LetDec rep)
-&gt; Usages
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; UsageTable -&gt; Maybe Usages
</span><a href="Futhark.Analysis.UsageTable.html#lookup"><span class="hs-operator hs-var">`UT.lookup`</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369165"><span class="hs-identifier hs-var">usage</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Maybe Usages)
-&gt; (PatElemT (VarWisdom, LetDec rep) -&gt; VName)
-&gt; PatElemT (VarWisdom, LetDec rep)
-&gt; Maybe Usages
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarWisdom, LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT (VarWisdom, LetDec rep)]
[PatElemT (LetDec (Wise rep))]
</span><a href="#local-6989586621684369163"><span class="hs-identifier hs-var">pes</span></a></span><span>
</span><span id="line-776"></span><span>  </span><span id="local-6989586621684369154"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369154"><span class="hs-identifier hs-var">cond'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SimpleM rep SubExp
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369162"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-777"></span><span>  </span><span id="local-6989586621684369153"><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684369153"><span class="hs-identifier hs-var">ts'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(BranchType rep -&gt; SimpleM rep (BranchType rep))
-&gt; [BranchType rep] -&gt; SimpleM rep [BranchType rep]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">BranchType rep -&gt; SimpleM rep (BranchType rep)
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType rep]
[BranchType (Wise rep)]
</span><a href="#local-6989586621684369159"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-778"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684369152"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369152"><span class="hs-identifier hs-var">tbranch'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369151"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369151"><span class="hs-identifier hs-var">fbranch'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369150"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369150"><span class="hs-identifier hs-var">hoisted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-779"></span><span>    </span><span class="annot"><span class="annottext">UsageTable
-&gt; [Usages]
-&gt; SubExp
-&gt; IfSort
-&gt; BodyT (Wise rep)
-&gt; BodyT (Wise rep)
-&gt; SimpleM
     rep (BodyT (Wise rep), BodyT (Wise rep), Stms (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
UsageTable
-&gt; [Usages]
-&gt; SubExp
-&gt; IfSort
-&gt; Body (Wise rep)
-&gt; Body (Wise rep)
-&gt; SimpleM rep (Body (Wise rep), Body (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#hoistCommon"><span class="hs-identifier hs-var">hoistCommon</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369165"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">[Usages]
</span><a href="#local-6989586621684369157"><span class="hs-identifier hs-var">pes_usages</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369154"><span class="hs-identifier hs-var">cond'</span></a></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684369158"><span class="hs-identifier hs-var">ifsort</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369161"><span class="hs-identifier hs-var">tbranch</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369160"><span class="hs-identifier hs-var">fbranch</span></a></span><span>
</span><span id="line-780"></span><span>  </span><span class="annot"><span class="annottext">(ExpT (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (ExpT (Wise rep), Stms (Wise rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
-&gt; BodyT (Wise rep)
-&gt; BodyT (Wise rep)
-&gt; IfDec (BranchType (Wise rep))
-&gt; ExpT (Wise rep)
forall rep.
SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369154"><span class="hs-identifier hs-var">cond'</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369152"><span class="hs-identifier hs-var">tbranch'</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369151"><span class="hs-identifier hs-var">fbranch'</span></a></span><span> </span><span class="annot"><span class="annottext">(IfDec (BranchType (Wise rep)) -&gt; ExpT (Wise rep))
-&gt; IfDec (BranchType (Wise rep)) -&gt; ExpT (Wise rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[BranchType rep] -&gt; IfSort -&gt; IfDec (BranchType rep)
forall rt. [rt] -&gt; IfSort -&gt; IfDec rt
</span><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-var">IfDec</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType rep]
</span><a href="#local-6989586621684369153"><span class="hs-identifier hs-var">ts'</span></a></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684369158"><span class="hs-identifier hs-var">ifsort</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369150"><span class="hs-identifier hs-var">hoisted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-781"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyExp"><span class="hs-identifier hs-var">simplifyExp</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec (Wise rep))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span id="local-6989586621684369149"><span class="annot"><span class="annottext">[(FParam (Wise rep), SubExp)]
</span><a href="#local-6989586621684369149"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684369148"><span class="annot"><span class="annottext">LoopForm (Wise rep)
</span><a href="#local-6989586621684369148"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684369147"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369147"><span class="hs-identifier hs-var">loopbody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-782"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684369146"><span class="annot"><span class="annottext">[Param (FParamInfo rep)]
</span><a href="#local-6989586621684369146"><span class="hs-identifier hs-var">params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369145"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684369145"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Param (FParamInfo rep), SubExp)]
-&gt; ([Param (FParamInfo rep)], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Param (FParamInfo rep), SubExp)]
[(FParam (Wise rep), SubExp)]
</span><a href="#local-6989586621684369149"><span class="hs-identifier hs-var">merge</span></a></span><span>
</span><span id="line-783"></span><span>  </span><span id="local-6989586621684369143"><span class="annot"><span class="annottext">[Param (FParamInfo rep)]
</span><a href="#local-6989586621684369143"><span class="hs-identifier hs-var">params'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Param (FParamInfo rep) -&gt; SimpleM rep (Param (FParamInfo rep)))
-&gt; [Param (FParamInfo rep)] -&gt; SimpleM rep [Param (FParamInfo rep)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FParamInfo rep -&gt; SimpleM rep (FParamInfo rep))
-&gt; Param (FParamInfo rep) -&gt; SimpleM rep (Param (FParamInfo rep))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">FParamInfo rep -&gt; SimpleM rep (FParamInfo rep)
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param (FParamInfo rep)]
</span><a href="#local-6989586621684369146"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-784"></span><span>  </span><span id="local-6989586621684369141"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684369141"><span class="hs-identifier hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SimpleM rep SubExp) -&gt; [SubExp] -&gt; SimpleM rep [SubExp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SimpleM rep SubExp
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684369145"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-785"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684369140"><span class="annot"><span class="annottext">merge' :: [(Param (FParamInfo rep), SubExp)]
</span><a href="#local-6989586621684369140"><span class="hs-identifier hs-var hs-var">merge'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param (FParamInfo rep)]
-&gt; [SubExp] -&gt; [(Param (FParamInfo rep), SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param (FParamInfo rep)]
</span><a href="#local-6989586621684369143"><span class="hs-identifier hs-var">params'</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684369141"><span class="hs-identifier hs-var">args'</span></a></span><span>
</span><span id="line-786"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684369139"><span class="annot"><span class="annottext">LoopForm (Wise rep)
</span><a href="#local-6989586621684369139"><span class="hs-identifier hs-var">form'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369138"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369138"><span class="hs-identifier hs-var">boundnames</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369137"><span class="annot"><span class="annottext">SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
</span><a href="#local-6989586621684369137"><span class="hs-identifier hs-var">wrapbody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LoopForm (Wise rep)
</span><a href="#local-6989586621684369148"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-787"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#ForLoop"><span class="hs-identifier hs-type">ForLoop</span></a></span><span> </span><span id="local-6989586621684369136"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369136"><span class="hs-identifier hs-var">loopvar</span></a></span></span><span> </span><span id="local-6989586621684369135"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684369135"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span id="local-6989586621684369134"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369134"><span class="hs-identifier hs-var">boundexp</span></a></span></span><span> </span><span id="local-6989586621684369133"><span class="annot"><span class="annottext">[(LParam (Wise rep), VName)]
</span><a href="#local-6989586621684369133"><span class="hs-identifier hs-var">loopvars</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-788"></span><span>      </span><span id="local-6989586621684369132"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369132"><span class="hs-identifier hs-var">boundexp'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SimpleM rep SubExp
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369134"><span class="hs-identifier hs-var">boundexp</span></a></span><span>
</span><span id="line-789"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684369131"><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684369131"><span class="hs-identifier hs-var">loop_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369130"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684369130"><span class="hs-identifier hs-var">loop_arrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Param (LParamInfo rep), VName)]
-&gt; ([Param (LParamInfo rep)], [VName])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Param (LParamInfo rep), VName)]
[(LParam (Wise rep), VName)]
</span><a href="#local-6989586621684369133"><span class="hs-identifier hs-var">loopvars</span></a></span><span>
</span><span id="line-790"></span><span>      </span><span id="local-6989586621684369129"><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684369129"><span class="hs-identifier hs-var">loop_params'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Param (LParamInfo rep) -&gt; SimpleM rep (Param (LParamInfo rep)))
-&gt; [Param (LParamInfo rep)] -&gt; SimpleM rep [Param (LParamInfo rep)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LParamInfo rep -&gt; SimpleM rep (LParamInfo rep))
-&gt; Param (LParamInfo rep) -&gt; SimpleM rep (Param (LParamInfo rep))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">LParamInfo rep -&gt; SimpleM rep (LParamInfo rep)
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684369131"><span class="hs-identifier hs-var">loop_params</span></a></span><span>
</span><span id="line-791"></span><span>      </span><span id="local-6989586621684369128"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684369128"><span class="hs-identifier hs-var">loop_arrs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SimpleM rep VName) -&gt; [VName] -&gt; SimpleM rep [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SimpleM rep VName
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684369130"><span class="hs-identifier hs-var">loop_arrs</span></a></span><span>
</span><span id="line-792"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684369127"><span class="annot"><span class="annottext">form' :: LoopForm (Wise rep)
</span><a href="#local-6989586621684369127"><span class="hs-identifier hs-var hs-var">form'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; IntType
-&gt; SubExp
-&gt; [(LParam (Wise rep), VName)]
-&gt; LoopForm (Wise rep)
forall rep.
VName -&gt; IntType -&gt; SubExp -&gt; [(LParam rep, VName)] -&gt; LoopForm rep
</span><a href="Futhark.IR.Syntax.html#ForLoop"><span class="hs-identifier hs-var">ForLoop</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369136"><span class="hs-identifier hs-var">loopvar</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684369135"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369132"><span class="hs-identifier hs-var">boundexp'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
-&gt; [VName] -&gt; [(Param (LParamInfo rep), VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684369129"><span class="hs-identifier hs-var">loop_params'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684369128"><span class="hs-identifier hs-var">loop_arrs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-793"></span><span>      </span><span class="annot"><span class="annottext">(LoopForm (Wise rep), Names,
 SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
 -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; SimpleM
     rep
     (LoopForm (Wise rep), Names,
      SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
      -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-794"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">LoopForm (Wise rep)
</span><a href="#local-6989586621684369127"><span class="hs-identifier hs-var">form'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-795"></span><span>          </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369136"><span class="hs-identifier hs-var">loopvar</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">(Param (LParamInfo rep) -&gt; VName)
-&gt; [Param (LParamInfo rep)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (LParamInfo rep) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684369129"><span class="hs-identifier hs-var">loop_params'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369126"><span class="hs-identifier hs-var">fparamnames</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-796"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; IntType
-&gt; SubExp
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall rep a.
SimplifiableRep rep =&gt;
VName -&gt; IntType -&gt; SubExp -&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#bindLoopVar"><span class="hs-identifier hs-var">bindLoopVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369136"><span class="hs-identifier hs-var">loopvar</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684369135"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369132"><span class="hs-identifier hs-var">boundexp'</span></a></span><span>
</span><span id="line-797"></span><span>            </span><span class="annot"><span class="annottext">(SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
 -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; (SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
    -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(FParam (Wise rep), SubExp)]
-&gt; LoopForm (Wise rep)
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall rep a b.
SimplifiableRep rep =&gt;
[(FParam (Wise rep), SubExp)]
-&gt; LoopForm (Wise rep)
-&gt; SimpleM rep (a, b, Stms (Wise rep))
-&gt; SimpleM rep (a, b, Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#protectLoopHoisted"><span class="hs-identifier hs-var">protectLoopHoisted</span></a></span><span> </span><span class="annot"><span class="annottext">[(Param (FParamInfo rep), SubExp)]
[(FParam (Wise rep), SubExp)]
</span><a href="#local-6989586621684369140"><span class="hs-identifier hs-var">merge'</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm (Wise rep)
</span><a href="#local-6989586621684369127"><span class="hs-identifier hs-var">form'</span></a></span><span>
</span><span id="line-798"></span><span>            </span><span class="annot"><span class="annottext">(SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
 -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; (SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
    -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[LParam (Wise rep)]
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall rep a.
SimplifiableRep rep =&gt;
[LParam (Wise rep)] -&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#bindArrayLParams"><span class="hs-identifier hs-var">bindArrayLParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
[LParam (Wise rep)]
</span><a href="#local-6989586621684369129"><span class="hs-identifier hs-var">loop_params'</span></a></span><span>
</span><span id="line-799"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-800"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#WhileLoop"><span class="hs-identifier hs-type">WhileLoop</span></a></span><span> </span><span id="local-6989586621684369125"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369125"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-801"></span><span>      </span><span id="local-6989586621684369124"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369124"><span class="hs-identifier hs-var">cond'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SimpleM rep VName
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369125"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-802"></span><span>      </span><span class="annot"><span class="annottext">(LoopForm (Wise rep), Names,
 SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
 -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; SimpleM
     rep
     (LoopForm (Wise rep), Names,
      SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
      -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-803"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">VName -&gt; LoopForm (Wise rep)
forall rep. VName -&gt; LoopForm rep
</span><a href="Futhark.IR.Syntax.html#WhileLoop"><span class="hs-identifier hs-var">WhileLoop</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369124"><span class="hs-identifier hs-var">cond'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-804"></span><span>          </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369126"><span class="hs-identifier hs-var">fparamnames</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-805"></span><span>          </span><span class="annot"><span class="annottext">[(FParam (Wise rep), SubExp)]
-&gt; LoopForm (Wise rep)
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall rep a b.
SimplifiableRep rep =&gt;
[(FParam (Wise rep), SubExp)]
-&gt; LoopForm (Wise rep)
-&gt; SimpleM rep (a, b, Stms (Wise rep))
-&gt; SimpleM rep (a, b, Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#protectLoopHoisted"><span class="hs-identifier hs-var">protectLoopHoisted</span></a></span><span> </span><span class="annot"><span class="annottext">[(Param (FParamInfo rep), SubExp)]
[(FParam (Wise rep), SubExp)]
</span><a href="#local-6989586621684369140"><span class="hs-identifier hs-var">merge'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; LoopForm (Wise rep)
forall rep. VName -&gt; LoopForm rep
</span><a href="Futhark.IR.Syntax.html#WhileLoop"><span class="hs-identifier hs-var">WhileLoop</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684369124"><span class="hs-identifier hs-var">cond'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-806"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-807"></span><span>  </span><span id="local-6989586621684369123"><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684369123"><span class="hs-identifier hs-var">seq_blocker</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep -&gt; BlockPred (Wise rep))
-&gt; SimpleM rep (BlockPred (Wise rep))
forall rep a. (Env rep -&gt; a) -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#asksEngineEnv"><span class="hs-identifier hs-var">asksEngineEnv</span></a></span><span> </span><span class="annot"><span class="annottext">((Env rep -&gt; BlockPred (Wise rep))
 -&gt; SimpleM rep (BlockPred (Wise rep)))
-&gt; (Env rep -&gt; BlockPred (Wise rep))
-&gt; SimpleM rep (BlockPred (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HoistBlockers rep -&gt; BlockPred (Wise rep)
forall rep. HoistBlockers rep -&gt; BlockPred (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockHoistSeq"><span class="hs-identifier hs-var hs-var">blockHoistSeq</span></a></span><span> </span><span class="annot"><span class="annottext">(HoistBlockers rep -&gt; BlockPred (Wise rep))
-&gt; (Env rep -&gt; HoistBlockers rep)
-&gt; Env rep
-&gt; BlockPred (Wise rep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Env rep -&gt; HoistBlockers rep
forall rep. Env rep -&gt; HoistBlockers rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#envHoistBlockers"><span class="hs-identifier hs-var hs-var">envHoistBlockers</span></a></span><span>
</span><span id="line-808"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684369122"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369122"><span class="hs-identifier hs-var">loopres</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369121"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369121"><span class="hs-identifier hs-var">loopstms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369120"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369120"><span class="hs-identifier hs-var">hoisted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-809"></span><span>    </span><span class="annot"><span class="annottext">SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall rep a. SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#enterLoop"><span class="hs-identifier hs-var">enterLoop</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
 -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; (SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
    -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
</span><a href="#local-6989586621684369119"><span class="hs-identifier hs-var">consumeMerge</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
 -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-810"></span><span>      </span><span class="annot"><span class="annottext">[(FParam (Wise rep), SubExp, SubExpRes)]
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall rep a.
SimplifiableRep rep =&gt;
[(FParam (Wise rep), SubExp, SubExpRes)]
-&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#bindMerge"><span class="hs-identifier hs-var">bindMerge</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Param (FParamInfo rep), SubExp)
 -&gt; SubExpRes -&gt; (Param (FParamInfo rep), SubExp, SubExpRes))
-&gt; [(Param (FParamInfo rep), SubExp)]
-&gt; Result
-&gt; [(Param (FParamInfo rep), SubExp, SubExpRes)]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">(Param (FParamInfo rep), SubExp)
-&gt; SubExpRes -&gt; (Param (FParamInfo rep), SubExp, SubExpRes)
forall {a} {b} {c}. (a, b) -&gt; c -&gt; (a, b, c)
</span><a href="#local-6989586621684369117"><span class="hs-identifier hs-var">withRes</span></a></span><span> </span><span class="annot"><span class="annottext">[(Param (FParamInfo rep), SubExp)]
</span><a href="#local-6989586621684369140"><span class="hs-identifier hs-var">merge'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT (Wise rep) -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369147"><span class="hs-identifier hs-var">loopbody</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
 -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; (SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
    -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
</span><a href="#local-6989586621684369137"><span class="hs-identifier hs-var">wrapbody</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
 -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-811"></span><span>        </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; Stms (Wise rep)
-&gt; SimpleM rep (Result, UsageTable)
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall rep a.
SimplifiableRep rep =&gt;
BlockPred (Wise rep)
-&gt; Stms (Wise rep)
-&gt; SimpleM rep (a, UsageTable)
-&gt; SimpleM rep (a, Stms (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockIf"><span class="hs-identifier hs-var">blockIf</span></a></span><span>
</span><span id="line-812"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Names -&gt; BlockPred (Wise rep)
forall rep. ASTRep rep =&gt; Names -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#hasFree"><span class="hs-identifier hs-var">hasFree</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369138"><span class="hs-identifier hs-var">boundnames</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; BlockPred (Wise rep) -&gt; BlockPred (Wise rep)
forall rep. BlockPred rep -&gt; BlockPred rep -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#orIf"><span class="hs-operator hs-var">`orIf`</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep. BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isConsumed"><span class="hs-identifier hs-var">isConsumed</span></a></span><span>
</span><span id="line-813"></span><span>              </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; BlockPred (Wise rep) -&gt; BlockPred (Wise rep)
forall rep. BlockPred rep -&gt; BlockPred rep -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#orIf"><span class="hs-operator hs-var">`orIf`</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684369123"><span class="hs-identifier hs-var">seq_blocker</span></a></span><span>
</span><span id="line-814"></span><span>              </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; BlockPred (Wise rep) -&gt; BlockPred (Wise rep)
forall rep. BlockPred rep -&gt; BlockPred rep -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#orIf"><span class="hs-operator hs-var">`orIf`</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep. ASTRep rep =&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#notWorthHoisting"><span class="hs-identifier hs-var">notWorthHoisting</span></a></span><span>
</span><span id="line-815"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-816"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyT (Wise rep) -&gt; Stms (Wise rep)
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369147"><span class="hs-identifier hs-var">loopbody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-817"></span><span>          </span><span class="annot"><span class="annottext">(SimpleM rep (Result, UsageTable)
 -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; SimpleM rep (Result, UsageTable)
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-818"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684369115"><span class="annot"><span class="annottext">params_usages :: [Usages]
</span><a href="#local-6989586621684369115"><span class="hs-identifier hs-var hs-var">params_usages</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-819"></span><span>                  </span><span class="annot"><span class="annottext">(Param (FParamInfo rep) -&gt; Usages)
-&gt; [Param (FParamInfo rep)] -&gt; [Usages]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span>
</span><span id="line-820"></span><span>                    </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684369114"><span class="annot"><span class="annottext">Param (FParamInfo rep)
</span><a href="#local-6989586621684369114"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">TypeBase Shape Uniqueness -&gt; Bool
forall shape. TypeBase shape Uniqueness -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#unique"><span class="hs-identifier hs-var">unique</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (FParamInfo rep) -&gt; TypeBase Shape Uniqueness
forall dec. DeclTyped dec =&gt; Param dec -&gt; TypeBase Shape Uniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramDeclType"><span class="hs-identifier hs-var">paramDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">Param (FParamInfo rep)
</span><a href="#local-6989586621684369114"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Usages
</span><a href="Futhark.Analysis.UsageTable.html#consumedU"><span class="hs-identifier hs-var">UT.consumedU</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Usages
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-821"></span><span>                    </span><span class="annot"><span class="annottext">[Param (FParamInfo rep)]
</span><a href="#local-6989586621684369143"><span class="hs-identifier hs-var">params'</span></a></span><span>
</span><span id="line-822"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684369111"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369111"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369110"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369110"><span class="hs-identifier hs-var">uses</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Usages] -&gt; Result -&gt; SimpleM rep (Result, UsageTable)
forall rep.
SimplifiableRep rep =&gt;
[Usages] -&gt; Result -&gt; SimpleM rep (Result, UsageTable)
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyResult"><span class="hs-identifier hs-var">simplifyResult</span></a></span><span> </span><span class="annot"><span class="annottext">[Usages]
</span><a href="#local-6989586621684369115"><span class="hs-identifier hs-var">params_usages</span></a></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; SimpleM rep (Result, UsageTable))
-&gt; Result -&gt; SimpleM rep (Result, UsageTable)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep) -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369147"><span class="hs-identifier hs-var">loopbody</span></a></span><span>
</span><span id="line-823"></span><span>            </span><span class="annot"><span class="annottext">(Result, UsageTable) -&gt; SimpleM rep (Result, UsageTable)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369111"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369110"><span class="hs-identifier hs-var">uses</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable -&gt; UsageTable -&gt; UsageTable
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; UsageTable
</span><a href="Futhark.Optimise.Simplify.Engine.html#isDoLoopResult"><span class="hs-identifier hs-var">isDoLoopResult</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369111"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-824"></span><span>  </span><span id="local-6989586621684369109"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369109"><span class="hs-identifier hs-var">loopbody'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep) -&gt; Result -&gt; SimpleM rep (BodyT (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
Stms (Wise rep) -&gt; Result -&gt; SimpleM rep (Body (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#constructBody"><span class="hs-identifier hs-var">constructBody</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369121"><span class="hs-identifier hs-var">loopstms</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684369122"><span class="hs-identifier hs-var">loopres</span></a></span><span>
</span><span id="line-825"></span><span>  </span><span class="annot"><span class="annottext">(ExpT (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (ExpT (Wise rep), Stms (Wise rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(FParam (Wise rep), SubExp)]
-&gt; LoopForm (Wise rep) -&gt; BodyT (Wise rep) -&gt; ExpT (Wise rep)
forall rep.
[(FParam rep, SubExp)] -&gt; LoopForm rep -&gt; BodyT rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-var">DoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">[(Param (FParamInfo rep), SubExp)]
[(FParam (Wise rep), SubExp)]
</span><a href="#local-6989586621684369140"><span class="hs-identifier hs-var">merge'</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm (Wise rep)
</span><a href="#local-6989586621684369139"><span class="hs-identifier hs-var">form'</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684369109"><span class="hs-identifier hs-var">loopbody'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369120"><span class="hs-identifier hs-var">hoisted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-826"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-827"></span><span>    </span><span id="local-6989586621684369126"><span class="annot"><span class="annottext">fparamnames :: Names
</span><a href="#local-6989586621684369126"><span class="hs-identifier hs-var hs-var">fparamnames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-828"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Param (FParamInfo rep), SubExp) -&gt; VName)
-&gt; [(Param (FParamInfo rep), SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (FParamInfo rep) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">(Param (FParamInfo rep) -&gt; VName)
-&gt; ((Param (FParamInfo rep), SubExp) -&gt; Param (FParamInfo rep))
-&gt; (Param (FParamInfo rep), SubExp)
-&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Param (FParamInfo rep), SubExp) -&gt; Param (FParamInfo rep)
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Param (FParamInfo rep), SubExp)]
[(FParam (Wise rep), SubExp)]
</span><a href="#local-6989586621684369149"><span class="hs-identifier hs-var">merge</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-829"></span><span>    </span><span id="local-6989586621684369119"><span class="annot"><span class="annottext">consumeMerge :: SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
</span><a href="#local-6989586621684369119"><span class="hs-identifier hs-var hs-var">consumeMerge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-830"></span><span>      </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall rep a.
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#localVtable"><span class="hs-identifier hs-var">localVtable</span></a></span><span> </span><span class="annot"><span class="annottext">((SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
 -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
 -&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep)))
-&gt; (SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Result, Stms (Wise rep), Stms (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; [VName] -&gt; SymbolTable (Wise rep))
-&gt; [VName] -&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; VName -&gt; SymbolTable (Wise rep))
-&gt; SymbolTable (Wise rep) -&gt; [VName] -&gt; SymbolTable (Wise rep)
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SymbolTable (Wise rep) -&gt; VName -&gt; SymbolTable (Wise rep)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
forall rep. VName -&gt; SymbolTable rep -&gt; SymbolTable rep
</span><a href="Futhark.Analysis.SymbolTable.html#consume"><span class="hs-identifier hs-var">ST.consume</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; [VName] -&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684369107"><span class="hs-identifier hs-var">consumed_by_merge</span></a></span><span>
</span><span id="line-831"></span><span>    </span><span id="local-6989586621684369107"><span class="annot"><span class="annottext">consumed_by_merge :: Names
</span><a href="#local-6989586621684369107"><span class="hs-identifier hs-var hs-var">consumed_by_merge</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-832"></span><span>      </span><span class="annot"><span class="annottext">[SubExp] -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Names) -&gt; [SubExp] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Param (FParamInfo rep), SubExp) -&gt; SubExp)
-&gt; [(Param (FParamInfo rep), SubExp)] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param (FParamInfo rep), SubExp) -&gt; SubExp
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([(Param (FParamInfo rep), SubExp)] -&gt; [SubExp])
-&gt; [(Param (FParamInfo rep), SubExp)] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Param (FParamInfo rep), SubExp) -&gt; Bool)
-&gt; [(Param (FParamInfo rep), SubExp)]
-&gt; [(Param (FParamInfo rep), SubExp)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape Uniqueness -&gt; Bool
forall shape. TypeBase shape Uniqueness -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#unique"><span class="hs-identifier hs-var">unique</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape Uniqueness -&gt; Bool)
-&gt; ((Param (FParamInfo rep), SubExp) -&gt; TypeBase Shape Uniqueness)
-&gt; (Param (FParamInfo rep), SubExp)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param (FParamInfo rep) -&gt; TypeBase Shape Uniqueness
forall dec. DeclTyped dec =&gt; Param dec -&gt; TypeBase Shape Uniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramDeclType"><span class="hs-identifier hs-var">paramDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">(Param (FParamInfo rep) -&gt; TypeBase Shape Uniqueness)
-&gt; ((Param (FParamInfo rep), SubExp) -&gt; Param (FParamInfo rep))
-&gt; (Param (FParamInfo rep), SubExp)
-&gt; TypeBase Shape Uniqueness
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Param (FParamInfo rep), SubExp) -&gt; Param (FParamInfo rep)
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Param (FParamInfo rep), SubExp)]
[(FParam (Wise rep), SubExp)]
</span><a href="#local-6989586621684369149"><span class="hs-identifier hs-var">merge</span></a></span><span>
</span><span id="line-833"></span><span>    </span><span id="local-6989586621684369117"><span class="annot"><span class="annottext">withRes :: (a, b) -&gt; c -&gt; (a, b, c)
</span><a href="#local-6989586621684369117"><span class="hs-identifier hs-var hs-var">withRes</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684369106"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369106"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369105"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684369105"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684369104"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621684369104"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684369106"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684369105"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621684369104"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-834"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyExp"><span class="hs-identifier hs-var">simplifyExp</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec (Wise rep))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span id="local-6989586621684369103"><span class="annot"><span class="annottext">Op (Wise rep)
</span><a href="#local-6989586621684369103"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-835"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684369102"><span class="annot"><span class="annottext">OpWithWisdom (Op rep)
</span><a href="#local-6989586621684369102"><span class="hs-identifier hs-var">op'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369101"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369101"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Op (Wise rep) -&gt; SimpleM rep (Op (Wise rep), Stms (Wise rep))
forall rep.
Op (Wise rep) -&gt; SimpleM rep (Op (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyOp"><span class="hs-identifier hs-var">simplifyOp</span></a></span><span> </span><span class="annot"><span class="annottext">Op (Wise rep)
</span><a href="#local-6989586621684369103"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-836"></span><span>  </span><span class="annot"><span class="annottext">(ExpT (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (ExpT (Wise rep), Stms (Wise rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Op (Wise rep) -&gt; ExpT (Wise rep)
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">Op (Wise rep)
OpWithWisdom (Op rep)
</span><a href="#local-6989586621684369102"><span class="hs-identifier hs-var">op'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369101"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-837"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyExp"><span class="hs-identifier hs-var">simplifyExp</span></a></span><span> </span><span id="local-6989586621684369100"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369100"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec (Wise rep))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-type">WithAcc</span></a></span><span> </span><span id="local-6989586621684369098"><span class="annot"><span class="annottext">[WithAccInput (Wise rep)]
</span><a href="#local-6989586621684369098"><span class="hs-identifier hs-var">inputs</span></a></span></span><span> </span><span id="local-6989586621684369097"><span class="annot"><span class="annottext">Lambda (Wise rep)
</span><a href="#local-6989586621684369097"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-838"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684369096"><span class="annot"><span class="annottext">[WithAccInput (Wise rep)]
</span><a href="#local-6989586621684369096"><span class="hs-identifier hs-var">inputs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369095"><span class="annot"><span class="annottext">[Stms (Wise rep)]
</span><a href="#local-6989586621684369095"><span class="hs-identifier hs-var">inputs_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([(WithAccInput (Wise rep), Stms (Wise rep))]
 -&gt; ([WithAccInput (Wise rep)], [Stms (Wise rep)]))
-&gt; SimpleM rep [(WithAccInput (Wise rep), Stms (Wise rep))]
-&gt; SimpleM rep ([WithAccInput (Wise rep)], [Stms (Wise rep)])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[(WithAccInput (Wise rep), Stms (Wise rep))]
-&gt; ([WithAccInput (Wise rep)], [Stms (Wise rep)])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep [(WithAccInput (Wise rep), Stms (Wise rep))]
 -&gt; SimpleM rep ([WithAccInput (Wise rep)], [Stms (Wise rep)]))
-&gt; ((WithAccInput (Wise rep)
     -&gt; SimpleM rep (WithAccInput (Wise rep), Stms (Wise rep)))
    -&gt; SimpleM rep [(WithAccInput (Wise rep), Stms (Wise rep))])
-&gt; (WithAccInput (Wise rep)
    -&gt; SimpleM rep (WithAccInput (Wise rep), Stms (Wise rep)))
-&gt; SimpleM rep ([WithAccInput (Wise rep)], [Stms (Wise rep)])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[WithAccInput (Wise rep)]
-&gt; (WithAccInput (Wise rep)
    -&gt; SimpleM rep (WithAccInput (Wise rep), Stms (Wise rep)))
-&gt; SimpleM rep [(WithAccInput (Wise rep), Stms (Wise rep))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[WithAccInput (Wise rep)]
</span><a href="#local-6989586621684369098"><span class="hs-identifier hs-var">inputs</span></a></span><span> </span><span class="annot"><span class="annottext">((WithAccInput (Wise rep)
  -&gt; SimpleM rep (WithAccInput (Wise rep), Stms (Wise rep)))
 -&gt; SimpleM rep ([WithAccInput (Wise rep)], [Stms (Wise rep)]))
-&gt; (WithAccInput (Wise rep)
    -&gt; SimpleM rep (WithAccInput (Wise rep), Stms (Wise rep)))
-&gt; SimpleM rep ([WithAccInput (Wise rep)], [Stms (Wise rep)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684369093"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684369093"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369092"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684369092"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369091"><span class="annot"><span class="annottext">Maybe (Lambda (Wise rep), [SubExp])
</span><a href="#local-6989586621684369091"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-839"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684369090"><span class="annot"><span class="annottext">Maybe (Lambda (Wise rep), [SubExp])
</span><a href="#local-6989586621684369090"><span class="hs-identifier hs-var">op'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369089"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369089"><span class="hs-identifier hs-var">op_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (Lambda (Wise rep), [SubExp])
</span><a href="#local-6989586621684369091"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-840"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Lambda (Wise rep), [SubExp])
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-841"></span><span>        </span><span class="annot"><span class="annottext">(Maybe (Lambda (Wise rep), [SubExp]), Stms (Wise rep))
-&gt; SimpleM
     rep (Maybe (Lambda (Wise rep), [SubExp]), Stms (Wise rep))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe (Lambda (Wise rep), [SubExp])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-842"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684369088"><span class="annot"><span class="annottext">Lambda (Wise rep)
</span><a href="#local-6989586621684369088"><span class="hs-identifier hs-var">op_lam</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369087"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684369087"><span class="hs-identifier hs-var">nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-843"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684369086"><span class="annot"><span class="annottext">Lambda (Wise rep)
</span><a href="#local-6989586621684369086"><span class="hs-identifier hs-var">op_lam'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369085"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369085"><span class="hs-identifier hs-var">op_lam_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda (Wise rep)
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
Lambda (Wise rep)
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambda"><span class="hs-identifier hs-var">simplifyLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Wise rep)
</span><a href="#local-6989586621684369088"><span class="hs-identifier hs-var">op_lam</span></a></span><span>
</span><span id="line-844"></span><span>        </span><span id="local-6989586621684369084"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684369084"><span class="hs-identifier hs-var">nes'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; SimpleM rep [SubExp]
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684369087"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-845"></span><span>        </span><span class="annot"><span class="annottext">(Maybe (Lambda (Wise rep), [SubExp]), Stms (Wise rep))
-&gt; SimpleM
     rep (Maybe (Lambda (Wise rep), [SubExp]), Stms (Wise rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Lambda (Wise rep), [SubExp])
-&gt; Maybe (Lambda (Wise rep), [SubExp])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda (Wise rep)
</span><a href="#local-6989586621684369086"><span class="hs-identifier hs-var">op_lam'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684369084"><span class="hs-identifier hs-var">nes'</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369085"><span class="hs-identifier hs-var">op_lam_stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-846"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369089"><span class="hs-identifier hs-var">op_stms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(WithAccInput (Wise rep)
 -&gt; (WithAccInput (Wise rep), Stms (Wise rep)))
-&gt; SimpleM rep (WithAccInput (Wise rep))
-&gt; SimpleM rep (WithAccInput (Wise rep), Stms (Wise rep))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="annot"><span class="hs-special">,</span></span><span class="annot"><span class="annottext">Maybe (Lambda (Wise rep), [SubExp])
</span><a href="#local-6989586621684369090"><span class="hs-identifier hs-var">op'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Shape -&gt; [VName] -&gt; WithAccInput (Wise rep))
-&gt; SimpleM rep Shape
-&gt; SimpleM rep ([VName] -&gt; WithAccInput (Wise rep))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; SimpleM rep Shape
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684369093"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM rep ([VName] -&gt; WithAccInput (Wise rep))
-&gt; SimpleM rep [VName] -&gt; SimpleM rep (WithAccInput (Wise rep))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; SimpleM rep [VName]
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684369092"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-847"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684369083"><span class="annot"><span class="annottext">noteAcc :: SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
</span><a href="#local-6989586621684369083"><span class="hs-identifier hs-var hs-var">noteAcc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, WithAccInput (Wise rep))]
-&gt; SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
forall rep.
[(VName, WithAccInput rep)] -&gt; SymbolTable rep -&gt; SymbolTable rep
</span><a href="Futhark.Analysis.SymbolTable.html#noteAccTokens"><span class="hs-identifier hs-var">ST.noteAccTokens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
-&gt; [WithAccInput (Wise rep)] -&gt; [(VName, WithAccInput (Wise rep))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Param (LParamInfo rep) -&gt; VName)
-&gt; [Param (LParamInfo rep)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (LParamInfo rep) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda (Wise rep) -&gt; [LParam (Wise rep)]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Wise rep)
</span><a href="#local-6989586621684369097"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[WithAccInput (Wise rep)]
</span><a href="#local-6989586621684369096"><span class="hs-identifier hs-var">inputs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-848"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684369080"><span class="annot"><span class="annottext">Lambda (Wise rep)
</span><a href="#local-6989586621684369080"><span class="hs-identifier hs-var">lam'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684369079"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369079"><span class="hs-identifier hs-var">lam_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; BlockPred (Wise rep)
-&gt; UsageTable
-&gt; Lambda (Wise rep)
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; BlockPred (Wise rep)
-&gt; UsageTable
-&gt; Lambda (Wise rep)
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambdaWith"><span class="hs-identifier hs-var">simplifyLambdaWith</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
</span><a href="#local-6989586621684369083"><span class="hs-identifier hs-var">noteAcc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; BlockPred (Wise rep)
forall rep. Bool -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isFalse"><span class="hs-identifier hs-var">isFalse</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684369100"><span class="hs-identifier hs-var">usage</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Wise rep)
</span><a href="#local-6989586621684369097"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-849"></span><span>  </span><span class="annot"><span class="annottext">(ExpT (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (ExpT (Wise rep), Stms (Wise rep))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[WithAccInput (Wise rep)] -&gt; Lambda (Wise rep) -&gt; ExpT (Wise rep)
forall rep. [WithAccInput rep] -&gt; Lambda rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-var">WithAcc</span></a></span><span> </span><span class="annot"><span class="annottext">[WithAccInput (Wise rep)]
</span><a href="#local-6989586621684369096"><span class="hs-identifier hs-var">inputs'</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Wise rep)
</span><a href="#local-6989586621684369080"><span class="hs-identifier hs-var">lam'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Stms (Wise rep)] -&gt; Stms (Wise rep)
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[Stms (Wise rep)]
</span><a href="#local-6989586621684369095"><span class="hs-identifier hs-var">inputs_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep) -&gt; Stms (Wise rep) -&gt; Stms (Wise rep)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684369079"><span class="hs-identifier hs-var">lam_stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-850"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyExp"><span class="hs-identifier hs-var">simplifyExp</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec (Wise rep))
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684369077"><span class="annot"><span class="annottext">ExpT (Wise rep)
</span><a href="#local-6989586621684369077"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-851"></span><span>  </span><span id="local-6989586621684369076"><span class="annot"><span class="annottext">ExpT (Wise rep)
</span><a href="#local-6989586621684369076"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExpT (Wise rep) -&gt; SimpleM rep (ExpT (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
Exp (Wise rep) -&gt; SimpleM rep (Exp (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyExpBase"><span class="hs-identifier hs-var">simplifyExpBase</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT (Wise rep)
</span><a href="#local-6989586621684369077"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-852"></span><span>  </span><span class="annot"><span class="annottext">(ExpT (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (ExpT (Wise rep), Stms (Wise rep))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpT (Wise rep)
</span><a href="#local-6989586621684369076"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-853"></span><span>
</span><span id="line-854"></span><span class="hs-comment">-- The simple nonrecursive case that we can perform without bottom-up</span><span>
</span><span id="line-855"></span><span class="hs-comment">-- information.</span><span>
</span><span id="line-856"></span><span id="local-6989586621684371066"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyExpBase"><span class="hs-identifier hs-type">simplifyExpBase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371066"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371066"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371066"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371066"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-857"></span><span class="hs-comment">-- Special case for simplification of commutative BinOps where we</span><span>
</span><span id="line-858"></span><span class="hs-comment">-- arrange the operands in sorted order.  This can make expressions</span><span>
</span><span id="line-859"></span><span class="hs-comment">-- more identical, which helps CSE.</span><span>
</span><span id="line-860"></span><span id="simplifyExpBase"><span class="annot"><span class="annottext">simplifyExpBase :: forall rep.
SimplifiableRep rep =&gt;
Exp (Wise rep) -&gt; SimpleM rep (Exp (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyExpBase"><span class="hs-identifier hs-var hs-var">simplifyExpBase</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span id="local-6989586621684369034"><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684369034"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621684369033"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369033"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684369032"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369032"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-861"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; Bool
</span><a href="Futhark.IR.Primitive.html#commutativeBinOp"><span class="hs-identifier hs-var">commutativeBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684369034"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-862"></span><span>    </span><span id="local-6989586621684369030"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369030"><span class="hs-identifier hs-var">x'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SimpleM rep SubExp
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369033"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-863"></span><span>    </span><span id="local-6989586621684369029"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369029"><span class="hs-identifier hs-var">y'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SimpleM rep SubExp
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369032"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-864"></span><span>    </span><span class="annot"><span class="annottext">ExpT (Wise rep) -&gt; SimpleM rep (ExpT (Wise rep))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ExpT (Wise rep) -&gt; SimpleM rep (ExpT (Wise rep)))
-&gt; ExpT (Wise rep) -&gt; SimpleM rep (ExpT (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT (Wise rep)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT (Wise rep)) -&gt; BasicOp -&gt; ExpT (Wise rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="annot"><span class="annottext">BinOp
</span><a href="#local-6989586621684369034"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">min</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369030"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369029"><span class="hs-identifier hs-var">y'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp
forall a. Ord a =&gt; a -&gt; a -&gt; a
</span><span class="hs-identifier hs-var">max</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369030"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684369029"><span class="hs-identifier hs-var">y'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-865"></span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyExpBase"><span class="hs-identifier hs-var">simplifyExpBase</span></a></span><span> </span><span id="local-6989586621684369026"><span class="annot"><span class="annottext">ExpT (Wise rep)
</span><a href="#local-6989586621684369026"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Mapper (Wise rep) (Wise rep) (SimpleM rep)
-&gt; ExpT (Wise rep) -&gt; SimpleM rep (ExpT (Wise rep))
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
Mapper frep trep m -&gt; Exp frep -&gt; m (Exp trep)
</span><a href="Futhark.IR.Traversals.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a></span><span> </span><span class="annot"><span class="annottext">Mapper (Wise rep) (Wise rep) (SimpleM rep)
</span><a href="#local-6989586621684369024"><span class="hs-identifier hs-var">hoist</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT (Wise rep)
</span><a href="#local-6989586621684369026"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-866"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-867"></span><span>    </span><span id="local-6989586621684369024"><span class="annot"><span class="annottext">hoist :: Mapper (Wise rep) (Wise rep) (SimpleM rep)
</span><a href="#local-6989586621684369024"><span class="hs-identifier hs-var hs-var">hoist</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-868"></span><span>      </span><span class="annot"><span class="annottext">Mapper (Wise rep) (Wise rep) (SimpleM rep)
forall (m :: * -&gt; *) rep. Monad m =&gt; Mapper rep rep m
</span><a href="Futhark.IR.Traversals.html#identityMapper"><span class="hs-identifier hs-var">identityMapper</span></a></span><span>
</span><span id="line-869"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnSubExp :: SubExp -&gt; SimpleM rep SubExp
</span><a href="Futhark.IR.Traversals.html#mapOnSubExp"><span class="hs-identifier hs-var">mapOnSubExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SimpleM rep SubExp
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-870"></span><span>          </span><span class="annot"><span class="annottext">mapOnVName :: VName -&gt; SimpleM rep VName
</span><a href="Futhark.IR.Traversals.html#mapOnVName"><span class="hs-identifier hs-var">mapOnVName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SimpleM rep VName
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-871"></span><span>          </span><span class="annot"><span class="annottext">mapOnRetType :: RetType (Wise rep) -&gt; SimpleM rep (RetType (Wise rep))
</span><a href="Futhark.IR.Traversals.html#mapOnRetType"><span class="hs-identifier hs-var">mapOnRetType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetType (Wise rep) -&gt; SimpleM rep (RetType (Wise rep))
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-872"></span><span>          </span><span class="annot"><span class="annottext">mapOnBranchType :: BranchType (Wise rep) -&gt; SimpleM rep (BranchType (Wise rep))
</span><a href="Futhark.IR.Traversals.html#mapOnBranchType"><span class="hs-identifier hs-var">mapOnBranchType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchType (Wise rep) -&gt; SimpleM rep (BranchType (Wise rep))
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span>
</span><span id="line-873"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-874"></span><span>
</span><span id="line-875"></span><span class="hs-keyword">type</span><span> </span><span id="SimplifiableRep"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-var">SimplifiableRep</span></a></span></span><span> </span><span id="local-6989586621684368967"><span class="annot"><a href="#local-6989586621684368967"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-876"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-877"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-878"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#FParamInfo"><span class="hs-identifier hs-type">FParamInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-879"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#LParamInfo"><span class="hs-identifier hs-type">LParamInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-880"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-881"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#BranchType"><span class="hs-identifier hs-type">BranchType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-882"></span><span>    </span><span class="annot"><a href="Futhark.IR.Traversals.html#TraverseOpStms"><span class="hs-identifier hs-type">TraverseOpStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-883"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#CanBeWise"><span class="hs-identifier hs-type">CanBeWise</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-884"></span><span>    </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#IndexOp"><span class="hs-identifier hs-type">ST.IndexOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#OpWithWisdom"><span class="hs-identifier hs-type">OpWithWisdom</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-885"></span><span>    </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-886"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.html#IsOp"><span class="hs-identifier hs-type">IsOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684368967"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-887"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-888"></span><span>
</span><span id="line-889"></span><span class="hs-keyword">class</span><span> </span><span id="Simplifiable"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-var">Simplifiable</span></a></span></span><span> </span><span id="local-6989586621684371073"><span class="annot"><a href="#local-6989586621684371073"><span class="hs-identifier hs-type">e</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-890"></span><span>  </span><span id="local-6989586621684371072"><span id="simplify"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-type">simplify</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371072"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684371073"><span class="hs-identifier hs-type">e</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371072"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371073"><span class="hs-identifier hs-type">e</span></a></span></span><span>
</span><span id="line-891"></span><span>
</span><span id="line-892"></span><span id="local-6989586621684370893"><span id="local-6989586621684370894"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370894"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370893"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684370894"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684370893"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-893"></span><span>  </span><span id="local-6989586621684368947"><span class="annot"><span class="annottext">simplify :: forall rep. SimplifiableRep rep =&gt; (a, b) -&gt; SimpleM rep (a, b)
</span><a href="#local-6989586621684368947"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684368946"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684368946"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684368945"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684368945"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(a -&gt; b -&gt; (a, b)) -&gt; SimpleM rep a -&gt; SimpleM rep (b -&gt; (a, b))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; SimpleM rep a
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684368946"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (b -&gt; (a, b)) -&gt; SimpleM rep b -&gt; SimpleM rep (a, b)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SimpleM rep b
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684368945"><span class="hs-identifier hs-var">y</span></a></span></span></span><span>
</span><span id="line-894"></span><span>
</span><span id="line-895"></span><span id="local-6989586621684370885"><span id="local-6989586621684370886"><span id="local-6989586621684370887"><span class="hs-keyword">instance</span><span>
</span><span id="line-896"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370887"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370886"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370885"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-897"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684370887"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684370886"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684370885"><span class="hs-identifier hs-type">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-898"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-899"></span><span>  </span><span id="local-6989586621684368922"><span class="annot"><span class="annottext">simplify :: forall rep.
SimplifiableRep rep =&gt;
(a, b, c) -&gt; SimpleM rep (a, b, c)
</span><a href="#local-6989586621684368922"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684368921"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684368921"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684368920"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684368920"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684368919"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621684368919"><span class="hs-identifier hs-var">z</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(a -&gt; b -&gt; c -&gt; (a, b, c))
-&gt; SimpleM rep a -&gt; SimpleM rep (b -&gt; c -&gt; (a, b, c))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; SimpleM rep a
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684368921"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (b -&gt; c -&gt; (a, b, c))
-&gt; SimpleM rep b -&gt; SimpleM rep (c -&gt; (a, b, c))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; SimpleM rep b
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684368920"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (c -&gt; (a, b, c))
-&gt; SimpleM rep c -&gt; SimpleM rep (a, b, c)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">c -&gt; SimpleM rep c
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621684368919"><span class="hs-identifier hs-var">z</span></a></span></span></span></span><span>
</span><span id="line-900"></span><span>
</span><span id="line-901"></span><span class="hs-comment">-- Convenient for Scatter.</span><span>
</span><span id="line-902"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-903"></span><span>  </span><span id="local-6989586621684368914"><span class="annot"><span class="annottext">simplify :: forall rep. SimplifiableRep rep =&gt; Int -&gt; SimpleM rep Int
</span><a href="#local-6989586621684368914"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SimpleM rep Int
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-904"></span><span>
</span><span id="line-905"></span><span id="local-6989586621684370880"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370880"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621684370880"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-906"></span><span>  </span><span id="local-6989586621684368898"><span class="annot"><span class="annottext">simplify :: forall rep. SimplifiableRep rep =&gt; Maybe a -&gt; SimpleM rep (Maybe a)
</span><a href="#local-6989586621684368898"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a -&gt; SimpleM rep (Maybe a)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-907"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684368897"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684368897"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Maybe a) -&gt; SimpleM rep a -&gt; SimpleM rep (Maybe a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; SimpleM rep a
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684368897"><span class="hs-identifier hs-var">x</span></a></span></span><span>
</span><span id="line-908"></span><span>
</span><span id="line-909"></span><span id="local-6989586621684370936"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370936"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684370936"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-910"></span><span>  </span><span id="local-6989586621684368882"><span class="annot"><span class="annottext">simplify :: forall rep. SimplifiableRep rep =&gt; [a] -&gt; SimpleM rep [a]
</span><a href="#local-6989586621684368882"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(a -&gt; SimpleM rep a) -&gt; [a] -&gt; SimpleM rep [a]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; SimpleM rep a
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span></span><span>
</span><span id="line-911"></span><span>
</span><span id="line-912"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-913"></span><span>  </span><span id="local-6989586621684368869"><span class="annot"><span class="annottext">simplify :: forall rep. SimplifiableRep rep =&gt; SubExp -&gt; SimpleM rep SubExp
</span><a href="#local-6989586621684368869"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684368868"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368868"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-914"></span><span>    </span><span id="local-6989586621684368867"><span class="annot"><span class="annottext">Maybe (SubExp, Certs)
</span><a href="#local-6989586621684368867"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SymbolTable (Wise rep) -&gt; Maybe (SubExp, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (SubExp, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupSubExp"><span class="hs-identifier hs-var">ST.lookupSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368868"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; Maybe (SubExp, Certs))
-&gt; SimpleM rep (SymbolTable (Wise rep))
-&gt; SimpleM rep (Maybe (SubExp, Certs))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (SymbolTable (Wise rep))
forall rep. SimpleM rep (SymbolTable (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#askVtable"><span class="hs-identifier hs-var">askVtable</span></a></span><span>
</span><span id="line-915"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (SubExp, Certs)
</span><a href="#local-6989586621684368867"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-916"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684368865"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684368865"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684368864"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684368864"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-917"></span><span>        </span><span class="annot"><span class="annottext">SimpleM rep ()
forall rep. SimpleM rep ()
</span><a href="Futhark.Optimise.Simplify.Engine.html#changed"><span class="hs-identifier hs-var">changed</span></a></span><span>
</span><span id="line-918"></span><span>        </span><span class="annot"><span class="annottext">Certs -&gt; SimpleM rep ()
forall rep. Certs -&gt; SimpleM rep ()
</span><a href="Futhark.Optimise.Simplify.Engine.html#usedCerts"><span class="hs-identifier hs-var">usedCerts</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684368864"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-919"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; SimpleM rep SubExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SimpleM rep SubExp) -&gt; SubExp -&gt; SimpleM rep SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-var">Constant</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684368865"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-920"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684368863"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368863"><span class="hs-identifier hs-var">id'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684368862"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684368862"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-921"></span><span>        </span><span class="annot"><span class="annottext">SimpleM rep ()
forall rep. SimpleM rep ()
</span><a href="Futhark.Optimise.Simplify.Engine.html#changed"><span class="hs-identifier hs-var">changed</span></a></span><span>
</span><span id="line-922"></span><span>        </span><span class="annot"><span class="annottext">Certs -&gt; SimpleM rep ()
forall rep. Certs -&gt; SimpleM rep ()
</span><a href="Futhark.Optimise.Simplify.Engine.html#usedCerts"><span class="hs-identifier hs-var">usedCerts</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684368862"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-923"></span><span>        </span><span class="annot"><span class="annottext">SubExp -&gt; SimpleM rep SubExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SimpleM rep SubExp) -&gt; SubExp -&gt; SimpleM rep SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368863"><span class="hs-identifier hs-var">id'</span></a></span><span>
</span><span id="line-924"></span><span>      </span><span class="annot"><span class="annottext">Maybe (SubExp, Certs)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SimpleM rep SubExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SimpleM rep SubExp) -&gt; SubExp -&gt; SimpleM rep SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368868"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-925"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684368861"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684368861"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-926"></span><span>    </span><span class="annot"><span class="annottext">SubExp -&gt; SimpleM rep SubExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SimpleM rep SubExp) -&gt; SubExp -&gt; SimpleM rep SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-var">Constant</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684368861"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-927"></span><span>
</span><span id="line-928"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-929"></span><span>  </span><span id="local-6989586621684368843"><span class="annot"><span class="annottext">simplify :: forall rep.
SimplifiableRep rep =&gt;
SubExpRes -&gt; SimpleM rep SubExpRes
</span><a href="#local-6989586621684368843"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684368842"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684368842"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684368841"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684368841"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-930"></span><span>    </span><span id="local-6989586621684368840"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684368840"><span class="hs-identifier hs-var">cs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Certs -&gt; SimpleM rep Certs
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684368842"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-931"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684368839"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684368839"><span class="hs-identifier hs-var">se'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684368838"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684368838"><span class="hs-identifier hs-var">se_cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SimpleM rep SubExp -&gt; SimpleM rep (SubExp, Certs)
forall rep a. SimpleM rep a -&gt; SimpleM rep (a, Certs)
</span><a href="Futhark.Optimise.Simplify.Engine.html#collectCerts"><span class="hs-identifier hs-var">collectCerts</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep SubExp -&gt; SimpleM rep (SubExp, Certs))
-&gt; SimpleM rep SubExp -&gt; SimpleM rep (SubExp, Certs)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SimpleM rep SubExp
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684368841"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-932"></span><span>    </span><span class="annot"><span class="annottext">SubExpRes -&gt; SimpleM rep SubExpRes
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SimpleM rep SubExpRes)
-&gt; SubExpRes -&gt; SimpleM rep SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; SubExp -&gt; SubExpRes
</span><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-var">SubExpRes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684368838"><span class="hs-identifier hs-var">se_cs</span></a></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684368840"><span class="hs-identifier hs-var">cs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684368839"><span class="hs-identifier hs-var">se'</span></a></span><span>
</span><span id="line-933"></span><span>
</span><span id="line-934"></span><span id="local-6989586621684371070"><span id="local-6989586621684371071"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyPat"><span class="hs-identifier hs-type">simplifyPat</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-935"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371071"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371070"><span class="hs-identifier hs-type">dec</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-936"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371070"><span class="hs-identifier hs-type">dec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-937"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371071"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684371070"><span class="hs-identifier hs-type">dec</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-938"></span><span id="simplifyPat"><span class="annot"><span class="annottext">simplifyPat :: forall rep dec.
(SimplifiableRep rep, Simplifiable dec) =&gt;
PatT dec -&gt; SimpleM rep (PatT dec)
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyPat"><span class="hs-identifier hs-var hs-var">simplifyPat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span id="local-6989586621684368797"><span class="annot"><span class="annottext">[PatElemT dec]
</span><a href="#local-6989586621684368797"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-939"></span><span>  </span><span class="annot"><span class="annottext">[PatElemT dec] -&gt; PatT dec
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT dec] -&gt; PatT dec)
-&gt; SimpleM rep [PatElemT dec] -&gt; SimpleM rep (PatT dec)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT dec -&gt; SimpleM rep (PatElemT dec))
-&gt; [PatElemT dec] -&gt; SimpleM rep [PatElemT dec]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">PatElemT dec -&gt; SimpleM rep (PatElemT dec)
forall {rep} {a}.
(ASTRep rep, Simplifiable a, Simplifiable (LetDec rep),
 Simplifiable (FParamInfo rep), Simplifiable (LParamInfo rep),
 Simplifiable (RetType rep), Simplifiable (BranchType rep),
 TraverseOpStms (Wise rep), CanBeWise (Op rep),
 IndexOp (OpWithWisdom (Op rep)), BuilderOps (Wise rep)) =&gt;
PatElemT a -&gt; SimpleM rep (PatElemT a)
</span><a href="#local-6989586621684368796"><span class="hs-identifier hs-var">inspect</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT dec]
</span><a href="#local-6989586621684368797"><span class="hs-identifier hs-var">xs</span></a></span><span>
</span><span id="line-940"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-941"></span><span>    </span><span id="local-6989586621684368796"><span class="annot"><span class="annottext">inspect :: PatElemT a -&gt; SimpleM rep (PatElemT a)
</span><a href="#local-6989586621684368796"><span class="hs-identifier hs-var hs-var">inspect</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-type">PatElem</span></a></span><span> </span><span id="local-6989586621684368736"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368736"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684368735"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684368735"><span class="hs-identifier hs-var">rep</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; a -&gt; PatElemT a
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368736"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(a -&gt; PatElemT a) -&gt; SimpleM rep a -&gt; SimpleM rep (PatElemT a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; SimpleM rep a
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684368735"><span class="hs-identifier hs-var">rep</span></a></span><span>
</span><span id="line-942"></span><span>
</span><span id="line-943"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-944"></span><span>  </span><span id="local-6989586621684368730"><span class="annot"><span class="annottext">simplify :: forall rep. SimplifiableRep rep =&gt; () -&gt; SimpleM rep ()
</span><a href="#local-6989586621684368730"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; SimpleM rep ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-945"></span><span>
</span><span id="line-946"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-947"></span><span>  </span><span id="local-6989586621684368721"><span class="annot"><span class="annottext">simplify :: forall rep. SimplifiableRep rep =&gt; VName -&gt; SimpleM rep VName
</span><a href="#local-6989586621684368721"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span id="local-6989586621684368720"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368720"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-948"></span><span>    </span><span id="local-6989586621684368719"><span class="annot"><span class="annottext">Maybe (SubExp, Certs)
</span><a href="#local-6989586621684368719"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SymbolTable (Wise rep) -&gt; Maybe (SubExp, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (SubExp, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupSubExp"><span class="hs-identifier hs-var">ST.lookupSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368720"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; Maybe (SubExp, Certs))
-&gt; SimpleM rep (SymbolTable (Wise rep))
-&gt; SimpleM rep (Maybe (SubExp, Certs))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (SymbolTable (Wise rep))
forall rep. SimpleM rep (SymbolTable (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#askVtable"><span class="hs-identifier hs-var">askVtable</span></a></span><span>
</span><span id="line-949"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (SubExp, Certs)
</span><a href="#local-6989586621684368719"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-950"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684368718"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368718"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684368717"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684368717"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-951"></span><span>        </span><span class="annot"><span class="annottext">SimpleM rep ()
forall rep. SimpleM rep ()
</span><a href="Futhark.Optimise.Simplify.Engine.html#changed"><span class="hs-identifier hs-var">changed</span></a></span><span>
</span><span id="line-952"></span><span>        </span><span class="annot"><span class="annottext">Certs -&gt; SimpleM rep ()
forall rep. Certs -&gt; SimpleM rep ()
</span><a href="Futhark.Optimise.Simplify.Engine.html#usedCerts"><span class="hs-identifier hs-var">usedCerts</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684368717"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-953"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; SimpleM rep VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368718"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-954"></span><span>      </span><span class="annot"><span class="annottext">Maybe (SubExp, Certs)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SimpleM rep VName
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368720"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-955"></span><span>
</span><span id="line-956"></span><span id="local-6989586621684370937"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370937"><span class="hs-identifier hs-type">d</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ShapeBase"><span class="hs-identifier hs-type">ShapeBase</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370937"><span class="hs-identifier hs-type">d</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-957"></span><span>  </span><span id="local-6989586621684368703"><span class="annot"><span class="annottext">simplify :: forall rep.
SimplifiableRep rep =&gt;
ShapeBase d -&gt; SimpleM rep (ShapeBase d)
</span><a href="#local-6989586621684368703"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([d] -&gt; ShapeBase d)
-&gt; SimpleM rep [d] -&gt; SimpleM rep (ShapeBase d)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[d] -&gt; ShapeBase d
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep [d] -&gt; SimpleM rep (ShapeBase d))
-&gt; (ShapeBase d -&gt; SimpleM rep [d])
-&gt; ShapeBase d
-&gt; SimpleM rep (ShapeBase d)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[d] -&gt; SimpleM rep [d]
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">([d] -&gt; SimpleM rep [d])
-&gt; (ShapeBase d -&gt; [d]) -&gt; ShapeBase d -&gt; SimpleM rep [d]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ShapeBase d -&gt; [d]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span></span><span>
</span><span id="line-958"></span><span>
</span><span id="line-959"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ExtSize"><span class="hs-identifier hs-type">ExtSize</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-960"></span><span>  </span><span id="local-6989586621684368687"><span class="annot"><span class="annottext">simplify :: forall rep. SimplifiableRep rep =&gt; ExtSize -&gt; SimpleM rep ExtSize
</span><a href="#local-6989586621684368687"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-type">Free</span></a></span><span> </span><span id="local-6989586621684368685"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684368685"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ExtSize
forall a. a -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-var">Free</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; ExtSize) -&gt; SimpleM rep SubExp -&gt; SimpleM rep ExtSize
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SimpleM rep SubExp
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684368685"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-961"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span id="local-6989586621684368683"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684368683"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExtSize -&gt; SimpleM rep ExtSize
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ExtSize -&gt; SimpleM rep ExtSize) -&gt; ExtSize -&gt; SimpleM rep ExtSize
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ExtSize
forall a. Int -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-var">Ext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684368683"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-962"></span><span>
</span><span id="line-963"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-964"></span><span>  </span><span id="local-6989586621684368665"><span class="annot"><span class="annottext">simplify :: forall rep. SimplifiableRep rep =&gt; Space -&gt; SimpleM rep Space
</span><a href="#local-6989586621684368665"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ScalarSpace"><span class="hs-identifier hs-type">ScalarSpace</span></a></span><span> </span><span id="local-6989586621684368663"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684368663"><span class="hs-identifier hs-var">ds</span></a></span></span><span> </span><span id="local-6989586621684368662"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684368662"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; PrimType -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#ScalarSpace"><span class="hs-identifier hs-var">ScalarSpace</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; PrimType -&gt; Space)
-&gt; SimpleM rep [SubExp] -&gt; SimpleM rep (PrimType -&gt; Space)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; SimpleM rep [SubExp]
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684368663"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (PrimType -&gt; Space)
-&gt; SimpleM rep PrimType -&gt; SimpleM rep Space
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SimpleM rep PrimType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684368662"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-965"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span id="local-6989586621684368661"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684368661"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space -&gt; SimpleM rep Space
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684368661"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-966"></span><span>
</span><span id="line-967"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-968"></span><span>  </span><span id="local-6989586621684368656"><span class="annot"><span class="annottext">simplify :: forall rep. SimplifiableRep rep =&gt; PrimType -&gt; SimpleM rep PrimType
</span><a href="#local-6989586621684368656"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SimpleM rep PrimType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-969"></span><span>
</span><span id="line-970"></span><span id="local-6989586621684370854"><span id="local-6989586621684370855"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370855"><span class="hs-identifier hs-type">shape</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370855"><span class="hs-identifier hs-type">shape</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370854"><span class="hs-identifier hs-type">u</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-971"></span><span>  </span><span id="local-6989586621684368619"><span class="annot"><span class="annottext">simplify :: forall rep.
SimplifiableRep rep =&gt;
TypeBase shape u -&gt; SimpleM rep (TypeBase shape u)
</span><a href="#local-6989586621684368619"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684368618"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684368618"><span class="hs-identifier hs-var">et</span></a></span></span><span> </span><span id="local-6989586621684368617"><span class="annot"><span class="annottext">shape
</span><a href="#local-6989586621684368617"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684368616"><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684368616"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-972"></span><span>    </span><span class="annot"><span class="annottext">PrimType -&gt; shape -&gt; u -&gt; TypeBase shape u
forall shape u. PrimType -&gt; shape -&gt; u -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; shape -&gt; u -&gt; TypeBase shape u)
-&gt; SimpleM rep PrimType
-&gt; SimpleM rep (shape -&gt; u -&gt; TypeBase shape u)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SimpleM rep PrimType
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684368618"><span class="hs-identifier hs-var">et</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (shape -&gt; u -&gt; TypeBase shape u)
-&gt; SimpleM rep shape -&gt; SimpleM rep (u -&gt; TypeBase shape u)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">shape -&gt; SimpleM rep shape
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">shape
</span><a href="#local-6989586621684368617"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (u -&gt; TypeBase shape u)
-&gt; SimpleM rep u -&gt; SimpleM rep (TypeBase shape u)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">u -&gt; SimpleM rep u
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684368616"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-973"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span id="local-6989586621684368615"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368615"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684368614"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684368614"><span class="hs-identifier hs-var">ispace</span></a></span></span><span> </span><span id="local-6989586621684368613"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684368613"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684368612"><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684368612"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-974"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; Shape -&gt; [Type] -&gt; u -&gt; TypeBase shape u
forall shape u. VName -&gt; Shape -&gt; [Type] -&gt; u -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-var">Acc</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Shape -&gt; [Type] -&gt; u -&gt; TypeBase shape u)
-&gt; SimpleM rep VName
-&gt; SimpleM rep (Shape -&gt; [Type] -&gt; u -&gt; TypeBase shape u)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SimpleM rep VName
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368615"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (Shape -&gt; [Type] -&gt; u -&gt; TypeBase shape u)
-&gt; SimpleM rep Shape
-&gt; SimpleM rep ([Type] -&gt; u -&gt; TypeBase shape u)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; SimpleM rep Shape
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684368614"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM rep ([Type] -&gt; u -&gt; TypeBase shape u)
-&gt; SimpleM rep [Type] -&gt; SimpleM rep (u -&gt; TypeBase shape u)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; SimpleM rep [Type]
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684368613"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (u -&gt; TypeBase shape u)
-&gt; SimpleM rep u -&gt; SimpleM rep (TypeBase shape u)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">u -&gt; SimpleM rep u
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684368612"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-975"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684368611"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684368611"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-976"></span><span>    </span><span class="annot"><span class="annottext">Space -&gt; TypeBase shape u
forall shape u. Space -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-var">Mem</span></a></span><span> </span><span class="annot"><span class="annottext">(Space -&gt; TypeBase shape u)
-&gt; SimpleM rep Space -&gt; SimpleM rep (TypeBase shape u)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; SimpleM rep Space
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684368611"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-977"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684368610"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684368610"><span class="hs-identifier hs-var">bt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-978"></span><span>    </span><span class="annot"><span class="annottext">TypeBase shape u -&gt; SimpleM rep (TypeBase shape u)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase shape u -&gt; SimpleM rep (TypeBase shape u))
-&gt; TypeBase shape u -&gt; SimpleM rep (TypeBase shape u)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TypeBase shape u
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684368610"><span class="hs-identifier hs-var">bt</span></a></span></span></span><span>
</span><span id="line-979"></span><span>
</span><span id="line-980"></span><span id="local-6989586621684370848"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370848"><span class="hs-identifier hs-type">d</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimIndex"><span class="hs-identifier hs-type">DimIndex</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370848"><span class="hs-identifier hs-type">d</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-981"></span><span>  </span><span id="local-6989586621684368586"><span class="annot"><span class="annottext">simplify :: forall rep.
SimplifiableRep rep =&gt;
DimIndex d -&gt; SimpleM rep (DimIndex d)
</span><a href="#local-6989586621684368586"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span id="local-6989586621684368584"><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684368584"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">d -&gt; DimIndex d
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(d -&gt; DimIndex d) -&gt; SimpleM rep d -&gt; SimpleM rep (DimIndex d)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">d -&gt; SimpleM rep d
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684368584"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-982"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-type">DimSlice</span></a></span><span> </span><span id="local-6989586621684368582"><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684368582"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684368581"><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684368581"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684368580"><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684368580"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">d -&gt; d -&gt; d -&gt; DimIndex d
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">(d -&gt; d -&gt; d -&gt; DimIndex d)
-&gt; SimpleM rep d -&gt; SimpleM rep (d -&gt; d -&gt; DimIndex d)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">d -&gt; SimpleM rep d
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684368582"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (d -&gt; d -&gt; DimIndex d)
-&gt; SimpleM rep d -&gt; SimpleM rep (d -&gt; DimIndex d)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">d -&gt; SimpleM rep d
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684368581"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (d -&gt; DimIndex d)
-&gt; SimpleM rep d -&gt; SimpleM rep (DimIndex d)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">d -&gt; SimpleM rep d
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684368580"><span class="hs-identifier hs-var">s</span></a></span></span><span>
</span><span id="line-983"></span><span>
</span><span id="line-984"></span><span id="local-6989586621684370843"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370843"><span class="hs-identifier hs-type">d</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370843"><span class="hs-identifier hs-type">d</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-985"></span><span>  </span><span id="local-6989586621684368563"><span class="annot"><span class="annottext">simplify :: forall rep. SimplifiableRep rep =&gt; Slice d -&gt; SimpleM rep (Slice d)
</span><a href="#local-6989586621684368563"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(d -&gt; SimpleM rep d) -&gt; Slice d -&gt; SimpleM rep (Slice d)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">d -&gt; SimpleM rep d
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span></span><span>
</span><span id="line-986"></span><span>
</span><span id="line-987"></span><span id="local-6989586621684370909"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambda"><span class="hs-identifier hs-type">simplifyLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-988"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370909"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-989"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370909"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-990"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370909"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370909"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370909"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-991"></span><span id="simplifyLambda"><span class="annot"><span class="annottext">simplifyLambda :: forall rep.
SimplifiableRep rep =&gt;
Lambda (Wise rep)
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambda"><span class="hs-identifier hs-var hs-var">simplifyLambda</span></a></span></span><span> </span><span id="local-6989586621684368551"><span class="annot"><span class="annottext">Lambda (Wise rep)
</span><a href="#local-6989586621684368551"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-992"></span><span>  </span><span id="local-6989586621684368550"><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684368550"><span class="hs-identifier hs-var">par_blocker</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Env rep -&gt; BlockPred (Wise rep))
-&gt; SimpleM rep (BlockPred (Wise rep))
forall rep a. (Env rep -&gt; a) -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#asksEngineEnv"><span class="hs-identifier hs-var">asksEngineEnv</span></a></span><span> </span><span class="annot"><span class="annottext">((Env rep -&gt; BlockPred (Wise rep))
 -&gt; SimpleM rep (BlockPred (Wise rep)))
-&gt; (Env rep -&gt; BlockPred (Wise rep))
-&gt; SimpleM rep (BlockPred (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HoistBlockers rep -&gt; BlockPred (Wise rep)
forall rep. HoistBlockers rep -&gt; BlockPred (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Engine.html#blockHoistPar"><span class="hs-identifier hs-var hs-var">blockHoistPar</span></a></span><span> </span><span class="annot"><span class="annottext">(HoistBlockers rep -&gt; BlockPred (Wise rep))
-&gt; (Env rep -&gt; HoistBlockers rep)
-&gt; Env rep
-&gt; BlockPred (Wise rep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Env rep -&gt; HoistBlockers rep
forall rep. Env rep -&gt; HoistBlockers rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#envHoistBlockers"><span class="hs-identifier hs-var hs-var">envHoistBlockers</span></a></span><span>
</span><span id="line-993"></span><span>  </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; UsageTable
-&gt; Lambda (Wise rep)
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
BlockPred (Wise rep)
-&gt; UsageTable
-&gt; Lambda (Wise rep)
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambdaMaybeHoist"><span class="hs-identifier hs-var">simplifyLambdaMaybeHoist</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684368550"><span class="hs-identifier hs-var">par_blocker</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Lambda (Wise rep)
</span><a href="#local-6989586621684368551"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-994"></span><span>
</span><span id="line-995"></span><span id="local-6989586621684370839"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambdaNoHoisting"><span class="hs-identifier hs-type">simplifyLambdaNoHoisting</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-996"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370839"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-997"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370839"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-998"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370839"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370839"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-999"></span><span id="simplifyLambdaNoHoisting"><span class="annot"><span class="annottext">simplifyLambdaNoHoisting :: forall rep.
SimplifiableRep rep =&gt;
Lambda (Wise rep) -&gt; SimpleM rep (Lambda (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambdaNoHoisting"><span class="hs-identifier hs-var hs-var">simplifyLambdaNoHoisting</span></a></span></span><span> </span><span id="local-6989586621684368537"><span class="annot"><span class="annottext">Lambda (Wise rep)
</span><a href="#local-6989586621684368537"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1000"></span><span>  </span><span class="annot"><span class="annottext">(Lambda (Wise rep), Stms (Wise rep)) -&gt; Lambda (Wise rep)
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Lambda (Wise rep), Stms (Wise rep)) -&gt; Lambda (Wise rep))
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Lambda (Wise rep))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; UsageTable
-&gt; Lambda (Wise rep)
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
BlockPred (Wise rep)
-&gt; UsageTable
-&gt; Lambda (Wise rep)
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambdaMaybeHoist"><span class="hs-identifier hs-var">simplifyLambdaMaybeHoist</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; BlockPred (Wise rep)
forall rep. Bool -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isFalse"><span class="hs-identifier hs-var">isFalse</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">UsageTable
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Lambda (Wise rep)
</span><a href="#local-6989586621684368537"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-1001"></span><span>
</span><span id="line-1002"></span><span id="local-6989586621684370840"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambdaMaybeHoist"><span class="hs-identifier hs-type">simplifyLambdaMaybeHoist</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1003"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370840"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1004"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370840"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1005"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1006"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370840"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1007"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370840"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370840"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370840"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1008"></span><span id="simplifyLambdaMaybeHoist"><span class="annot"><span class="annottext">simplifyLambdaMaybeHoist :: forall rep.
SimplifiableRep rep =&gt;
BlockPred (Wise rep)
-&gt; UsageTable
-&gt; Lambda (Wise rep)
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambdaMaybeHoist"><span class="hs-identifier hs-var hs-var">simplifyLambdaMaybeHoist</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; BlockPred (Wise rep)
-&gt; UsageTable
-&gt; Lambda (Wise rep)
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; BlockPred (Wise rep)
-&gt; UsageTable
-&gt; Lambda (Wise rep)
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambdaWith"><span class="hs-identifier hs-var">simplifyLambdaWith</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-1009"></span><span>
</span><span id="line-1010"></span><span id="local-6989586621684370905"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambdaWith"><span class="hs-identifier hs-type">simplifyLambdaWith</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1011"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370905"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1012"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#SymbolTable"><span class="hs-identifier hs-type">ST.SymbolTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370905"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html#SymbolTable"><span class="hs-identifier hs-type">ST.SymbolTable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370905"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1013"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#BlockPred"><span class="hs-identifier hs-type">BlockPred</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370905"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1014"></span><span>  </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1015"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370905"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1016"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370905"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370905"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370905"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1017"></span><span id="simplifyLambdaWith"><span class="annot"><span class="annottext">simplifyLambdaWith :: forall rep.
SimplifiableRep rep =&gt;
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; BlockPred (Wise rep)
-&gt; UsageTable
-&gt; Lambda (Wise rep)
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyLambdaWith"><span class="hs-identifier hs-var hs-var">simplifyLambdaWith</span></a></span></span><span> </span><span id="local-6989586621684368495"><span class="annot"><span class="annottext">SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
</span><a href="#local-6989586621684368495"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684368494"><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684368494"><span class="hs-identifier hs-var">blocked</span></a></span></span><span> </span><span id="local-6989586621684368493"><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684368493"><span class="hs-identifier hs-var">usage</span></a></span></span><span> </span><span id="local-6989586621684368492"><span class="annot"><span class="annottext">lam :: Lambda (Wise rep)
</span><a href="#local-6989586621684368492"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span id="local-6989586621684368490"><span class="annot"><span class="annottext">[LParam (Wise rep)]
</span><a href="#local-6989586621684368490"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684368489"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684368489"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621684368488"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684368488"><span class="hs-identifier hs-var">rettype</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1018"></span><span>  </span><span id="local-6989586621684368487"><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
</span><a href="#local-6989586621684368487"><span class="hs-identifier hs-var">params'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Param (LParamInfo rep) -&gt; SimpleM rep (Param (LParamInfo rep)))
-&gt; [Param (LParamInfo rep)] -&gt; SimpleM rep [Param (LParamInfo rep)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LParamInfo rep -&gt; SimpleM rep (LParamInfo rep))
-&gt; Param (LParamInfo rep) -&gt; SimpleM rep (Param (LParamInfo rep))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">LParamInfo rep -&gt; SimpleM rep (LParamInfo rep)
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
[LParam (Wise rep)]
</span><a href="#local-6989586621684368490"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-1019"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684368486"><span class="annot"><span class="annottext">paramnames :: Names
</span><a href="#local-6989586621684368486"><span class="hs-identifier hs-var hs-var">paramnames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; [VName] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda (Wise rep) -&gt; [VName]
forall rep. Lambda rep -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#boundByLambda"><span class="hs-identifier hs-var">boundByLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda (Wise rep)
</span><a href="#local-6989586621684368492"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-1020"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684368484"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684368484"><span class="hs-identifier hs-var">hoisted</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684368483"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684368483"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1021"></span><span>    </span><span class="annot"><span class="annottext">[LParam (Wise rep)]
-&gt; SimpleM rep (Stms (Wise rep), BodyT (Wise rep))
-&gt; SimpleM rep (Stms (Wise rep), BodyT (Wise rep))
forall rep a.
SimplifiableRep rep =&gt;
[LParam (Wise rep)] -&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#bindLParams"><span class="hs-identifier hs-var">bindLParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
[LParam (Wise rep)]
</span><a href="#local-6989586621684368487"><span class="hs-identifier hs-var">params'</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep (Stms (Wise rep), BodyT (Wise rep))
 -&gt; SimpleM rep (Stms (Wise rep), BodyT (Wise rep)))
-&gt; (SimpleM rep (Stms (Wise rep), BodyT (Wise rep))
    -&gt; SimpleM rep (Stms (Wise rep), BodyT (Wise rep)))
-&gt; SimpleM rep (Stms (Wise rep), BodyT (Wise rep))
-&gt; SimpleM rep (Stms (Wise rep), BodyT (Wise rep))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep (Stms (Wise rep), BodyT (Wise rep))
-&gt; SimpleM rep (Stms (Wise rep), BodyT (Wise rep))
forall rep a.
(SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep))
-&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#localVtable"><span class="hs-identifier hs-var">localVtable</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep) -&gt; SymbolTable (Wise rep)
</span><a href="#local-6989586621684368495"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep (Stms (Wise rep), BodyT (Wise rep))
 -&gt; SimpleM rep (Stms (Wise rep), BodyT (Wise rep)))
-&gt; SimpleM rep (Stms (Wise rep), BodyT (Wise rep))
-&gt; SimpleM rep (Stms (Wise rep), BodyT (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1022"></span><span>      </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; UsageTable
-&gt; [Usages]
-&gt; BodyT (Wise rep)
-&gt; SimpleM rep (Stms (Wise rep), BodyT (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
BlockPred (Wise rep)
-&gt; UsageTable
-&gt; [Usages]
-&gt; Body (Wise rep)
-&gt; SimpleM rep (Stms (Wise rep), Body (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyBody"><span class="hs-identifier hs-var">simplifyBody</span></a></span><span>
</span><span id="line-1023"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockPred (Wise rep)
</span><a href="#local-6989586621684368494"><span class="hs-identifier hs-var">blocked</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; BlockPred (Wise rep) -&gt; BlockPred (Wise rep)
forall rep. BlockPred rep -&gt; BlockPred rep -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#orIf"><span class="hs-operator hs-var">`orIf`</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; BlockPred (Wise rep)
forall rep. ASTRep rep =&gt; Names -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#hasFree"><span class="hs-identifier hs-var">hasFree</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684368486"><span class="hs-identifier hs-var">paramnames</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
-&gt; BlockPred (Wise rep) -&gt; BlockPred (Wise rep)
forall rep. BlockPred rep -&gt; BlockPred rep -&gt; BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#orIf"><span class="hs-operator hs-var">`orIf`</span></a></span><span> </span><span class="annot"><span class="annottext">BlockPred (Wise rep)
forall rep. BlockPred rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#isConsumed"><span class="hs-identifier hs-var">isConsumed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1024"></span><span>        </span><span class="annot"><span class="annottext">UsageTable
</span><a href="#local-6989586621684368493"><span class="hs-identifier hs-var">usage</span></a></span><span>
</span><span id="line-1025"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Type -&gt; Usages) -&gt; [Type] -&gt; [Usages]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Usages -&gt; Type -&gt; Usages
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Usages
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684368488"><span class="hs-identifier hs-var">rettype</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1026"></span><span>        </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684368489"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1027"></span><span>  </span><span id="local-6989586621684368482"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684368482"><span class="hs-identifier hs-var">rettype'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; SimpleM rep [Type]
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684368488"><span class="hs-identifier hs-var">rettype</span></a></span><span>
</span><span id="line-1028"></span><span>  </span><span class="annot"><span class="annottext">(Lambda (Wise rep), Stms (Wise rep))
-&gt; SimpleM rep (Lambda (Wise rep), Stms (Wise rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LParam (Wise rep)]
-&gt; BodyT (Wise rep) -&gt; [Type] -&gt; Lambda (Wise rep)
forall rep. [LParam rep] -&gt; BodyT rep -&gt; [Type] -&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (LParamInfo rep)]
[LParam (Wise rep)]
</span><a href="#local-6989586621684368487"><span class="hs-identifier hs-var">params'</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684368483"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684368482"><span class="hs-identifier hs-var">rettype'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684368484"><span class="hs-identifier hs-var">hoisted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1029"></span><span>
</span><span id="line-1030"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#Simplifiable"><span class="hs-identifier hs-type">Simplifiable</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1031"></span><span>  </span><span id="local-6989586621684368473"><span class="annot"><span class="annottext">simplify :: forall rep. SimplifiableRep rep =&gt; Certs -&gt; SimpleM rep Certs
</span><a href="#local-6989586621684368473"><span class="hs-identifier hs-var hs-var hs-var hs-var">simplify</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span> </span><span id="local-6989586621684368471"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684368471"><span class="hs-identifier hs-var">ocs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Certs
</span><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-var">Certs</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Certs) -&gt; ([[VName]] -&gt; [VName]) -&gt; [[VName]] -&gt; Certs
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName]
forall a. Ord a =&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#nubOrd"><span class="hs-identifier hs-var">nubOrd</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [VName])
-&gt; ([[VName]] -&gt; [VName]) -&gt; [[VName]] -&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[[VName]] -&gt; [VName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[VName]] -&gt; Certs) -&gt; SimpleM rep [[VName]] -&gt; SimpleM rep Certs
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SimpleM rep [VName]) -&gt; [VName] -&gt; SimpleM rep [[VName]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SimpleM rep [VName]
forall {rep}. VName -&gt; SimpleM rep [VName]
</span><a href="#local-6989586621684368469"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684368471"><span class="hs-identifier hs-var">ocs</span></a></span><span>
</span><span id="line-1032"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-1033"></span><span>      </span><span id="local-6989586621684368469"><span class="annot"><span class="annottext">check :: VName -&gt; SimpleM rep [VName]
</span><a href="#local-6989586621684368469"><span class="hs-identifier hs-var hs-var">check</span></a></span></span><span> </span><span id="local-6989586621684368463"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368463"><span class="hs-identifier hs-var">idd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1034"></span><span>        </span><span id="local-6989586621684368462"><span class="annot"><span class="annottext">Maybe (SubExp, Certs)
</span><a href="#local-6989586621684368462"><span class="hs-identifier hs-var">vv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SymbolTable (Wise rep) -&gt; Maybe (SubExp, Certs)
forall rep. VName -&gt; SymbolTable rep -&gt; Maybe (SubExp, Certs)
</span><a href="Futhark.Analysis.SymbolTable.html#lookupSubExp"><span class="hs-identifier hs-var">ST.lookupSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368463"><span class="hs-identifier hs-var">idd</span></a></span><span> </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep) -&gt; Maybe (SubExp, Certs))
-&gt; SimpleM rep (SymbolTable (Wise rep))
-&gt; SimpleM rep (Maybe (SubExp, Certs))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (SymbolTable (Wise rep))
forall rep. SimpleM rep (SymbolTable (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#askVtable"><span class="hs-identifier hs-var">askVtable</span></a></span><span>
</span><span id="line-1035"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (SubExp, Certs)
</span><a href="#local-6989586621684368462"><span class="hs-identifier hs-var">vv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1036"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span> </span><span id="local-6989586621684368461"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684368461"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; SimpleM rep [VName]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684368461"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-1037"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684368460"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368460"><span class="hs-identifier hs-var">idd'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; SimpleM rep [VName]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368460"><span class="hs-identifier hs-var">idd'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1038"></span><span>          </span><span class="annot"><span class="annottext">Maybe (SubExp, Certs)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; SimpleM rep [VName]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684368463"><span class="hs-identifier hs-var">idd</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1039"></span><span>
</span><span id="line-1040"></span><span id="local-6989586621684370828"><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#simplifyFun"><span class="hs-identifier hs-type">simplifyFun</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1041"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370828"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1042"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370828"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1043"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370828"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684370828"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-1044"></span><span id="simplifyFun"><span class="annot"><span class="annottext">simplifyFun :: forall rep.
SimplifiableRep rep =&gt;
FunDef (Wise rep) -&gt; SimpleM rep (FunDef (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyFun"><span class="hs-identifier hs-var hs-var">simplifyFun</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span id="local-6989586621684368423"><span class="annot"><span class="annottext">Maybe EntryPoint
</span><a href="#local-6989586621684368423"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span id="local-6989586621684368422"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684368422"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684368421"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684368421"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span id="local-6989586621684368420"><span class="annot"><span class="annottext">[RetType (Wise rep)]
</span><a href="#local-6989586621684368420"><span class="hs-identifier hs-var">rettype</span></a></span></span><span> </span><span id="local-6989586621684368419"><span class="annot"><span class="annottext">[FParam (Wise rep)]
</span><a href="#local-6989586621684368419"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684368418"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684368418"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1045"></span><span>  </span><span id="local-6989586621684368417"><span class="annot"><span class="annottext">[RetType rep]
</span><a href="#local-6989586621684368417"><span class="hs-identifier hs-var">rettype'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[RetType rep] -&gt; SimpleM rep [RetType rep]
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span> </span><span class="annot"><span class="annottext">[RetType rep]
[RetType (Wise rep)]
</span><a href="#local-6989586621684368420"><span class="hs-identifier hs-var">rettype</span></a></span><span>
</span><span id="line-1046"></span><span>  </span><span id="local-6989586621684368416"><span class="annot"><span class="annottext">[Param (FParamInfo rep)]
</span><a href="#local-6989586621684368416"><span class="hs-identifier hs-var">params'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Param (FParamInfo rep) -&gt; SimpleM rep (Param (FParamInfo rep)))
-&gt; [Param (FParamInfo rep)] -&gt; SimpleM rep [Param (FParamInfo rep)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FParamInfo rep -&gt; SimpleM rep (FParamInfo rep))
-&gt; Param (FParamInfo rep) -&gt; SimpleM rep (Param (FParamInfo rep))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">FParamInfo rep -&gt; SimpleM rep (FParamInfo rep)
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">simplify</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param (FParamInfo rep)]
[FParam (Wise rep)]
</span><a href="#local-6989586621684368419"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-1047"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684368415"><span class="annot"><span class="annottext">usages :: [Usages]
</span><a href="#local-6989586621684368415"><span class="hs-identifier hs-var hs-var">usages</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RetType rep -&gt; Usages) -&gt; [RetType rep] -&gt; [Usages]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Diet -&gt; Usages
</span><a href="Futhark.Optimise.Simplify.Engine.html#usageFromDiet"><span class="hs-identifier hs-var">usageFromDiet</span></a></span><span> </span><span class="annot"><span class="annottext">(Diet -&gt; Usages) -&gt; (RetType rep -&gt; Diet) -&gt; RetType rep -&gt; Usages
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TypeBase ExtShape Uniqueness -&gt; Diet
forall shape. TypeBase shape Uniqueness -&gt; Diet
</span><a href="Futhark.IR.Prop.Types.html#diet"><span class="hs-identifier hs-var">diet</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase ExtShape Uniqueness -&gt; Diet)
-&gt; (RetType rep -&gt; TypeBase ExtShape Uniqueness)
-&gt; RetType rep
-&gt; Diet
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">RetType rep -&gt; TypeBase ExtShape Uniqueness
forall t. DeclExtTyped t =&gt; t -&gt; TypeBase ExtShape Uniqueness
</span><a href="Futhark.IR.Prop.Types.html#declExtTypeOf"><span class="hs-identifier hs-var">declExtTypeOf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[RetType rep]
</span><a href="#local-6989586621684368417"><span class="hs-identifier hs-var">rettype'</span></a></span><span>
</span><span id="line-1048"></span><span>  </span><span id="local-6989586621684368412"><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684368412"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[FParam (Wise rep)]
-&gt; SimpleM rep (BodyT (Wise rep)) -&gt; SimpleM rep (BodyT (Wise rep))
forall rep a.
SimplifiableRep rep =&gt;
[FParam (Wise rep)] -&gt; SimpleM rep a -&gt; SimpleM rep a
</span><a href="Futhark.Optimise.Simplify.Engine.html#bindFParams"><span class="hs-identifier hs-var">bindFParams</span></a></span><span> </span><span class="annot"><span class="annottext">[FParam (Wise rep)]
</span><a href="#local-6989586621684368419"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">(SimpleM rep (BodyT (Wise rep)) -&gt; SimpleM rep (BodyT (Wise rep)))
-&gt; SimpleM rep (BodyT (Wise rep)) -&gt; SimpleM rep (BodyT (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">UsageTable
-&gt; [Usages] -&gt; BodyT (Wise rep) -&gt; SimpleM rep (BodyT (Wise rep))
forall rep.
SimplifiableRep rep =&gt;
UsageTable
-&gt; [Usages] -&gt; Body (Wise rep) -&gt; SimpleM rep (Body (Wise rep))
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplifyBodyNoHoisting"><span class="hs-identifier hs-var">simplifyBodyNoHoisting</span></a></span><span> </span><span class="annot"><span class="annottext">UsageTable
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">[Usages]
</span><a href="#local-6989586621684368415"><span class="hs-identifier hs-var">usages</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684368418"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1049"></span><span>  </span><span class="annot"><span class="annottext">FunDef (Wise rep) -&gt; SimpleM rep (FunDef (Wise rep))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(FunDef (Wise rep) -&gt; SimpleM rep (FunDef (Wise rep)))
-&gt; FunDef (Wise rep) -&gt; SimpleM rep (FunDef (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe EntryPoint
-&gt; Attrs
-&gt; Name
-&gt; [RetType (Wise rep)]
-&gt; [FParam (Wise rep)]
-&gt; BodyT (Wise rep)
-&gt; FunDef (Wise rep)
forall rep.
Maybe EntryPoint
-&gt; Attrs
-&gt; Name
-&gt; [RetType rep]
-&gt; [FParam rep]
-&gt; BodyT rep
-&gt; FunDef rep
</span><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-var">FunDef</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EntryPoint
</span><a href="#local-6989586621684368423"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684368422"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684368421"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">[RetType rep]
[RetType (Wise rep)]
</span><a href="#local-6989586621684368417"><span class="hs-identifier hs-var">rettype'</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (FParamInfo rep)]
[FParam (Wise rep)]
</span><a href="#local-6989586621684368416"><span class="hs-identifier hs-var">params'</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Wise rep)
</span><a href="#local-6989586621684368412"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-1050"></span></pre></body></html>