<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-comment">-- | A generic transformation for adding memory allocations to a</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- Futhark program.  Specialised by specific representations in</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- submodules.</span><span>
</span><span id="line-14"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Pass.ExplicitAllocations</span><span>
</span><span id="line-15"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#explicitAllocationsGeneric"><span class="hs-identifier">explicitAllocationsGeneric</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#explicitAllocationsInStmsGeneric"><span class="hs-identifier">explicitAllocationsInStmsGeneric</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ExpHint"><span class="hs-identifier">ExpHint</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#defaultExpHints"><span class="hs-identifier">defaultExpHints</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier">Allocable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier">AllocM</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocEnv"><span class="hs-identifier">AllocEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#SizeSubst"><span class="hs-identifier">SizeSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInStms"><span class="hs-identifier">allocInStms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocForArray"><span class="hs-identifier">allocForArray</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#simplifiable"><span class="hs-identifier">simplifiable</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#arraySizeInBytesExp"><span class="hs-identifier">arraySizeInBytesExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#mkLetNamesB%27"><span class="hs-identifier">mkLetNamesB'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#mkLetNamesB%27%27"><span class="hs-identifier">mkLetNamesB''</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#dimAllocationSize"><span class="hs-identifier">dimAllocationSize</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ChunkMap"><span class="hs-identifier">ChunkMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>
</span><span id="line-32"></span><span>    </span><span class="annot"><span class="hs-comment">-- * Module re-exports</span></span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span>    </span><span class="hs-comment">--</span><span>
</span><span id="line-35"></span><span>    </span><span class="hs-comment">-- These are highly likely to be needed by any downstream</span><span>
</span><span id="line-36"></span><span>    </span><span class="hs-comment">-- users.</span><span>
</span><span id="line-37"></span><span>    </span><span class="hs-keyword">module</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>    </span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html"><span class="hs-identifier">Futhark.MonadFreshNames</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Futhark.Pass.html"><span class="hs-identifier">Futhark.Pass</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-keyword">module</span><span> </span><span class="annot"><a href="Futhark.Tools.html"><span class="hs-identifier">Futhark.Tools</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">where</span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.RWS.Strict</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-46"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-47"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Writer</span></span><span>
</span><span id="line-48"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">foldl'</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">partition</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">zip5</span></span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-50"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html"><span class="hs-identifier">Futhark.Analysis.UsageTable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">UT</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html"><span class="hs-identifier">Futhark.IR.Mem</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html"><span class="hs-identifier">Futhark.IR.Mem.IxFun</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IxFun</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html"><span class="hs-identifier">Futhark.MonadFreshNames</span></a></span><span>
</span><span id="line-56"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Engine</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleOps"><span class="hs-identifier">SimpleOps</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Engine</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Engine</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#mkWiseBody"><span class="hs-identifier">mkWiseBody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.html"><span class="hs-identifier">Futhark.Pass</span></a></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Tools.html"><span class="hs-identifier">Futhark.Tools</span></a></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#maybeNth"><span class="hs-identifier">maybeNth</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.html#splitAt3"><span class="hs-identifier">splitAt3</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.html#splitFromEnd"><span class="hs-identifier">splitFromEnd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.html#takeLast"><span class="hs-identifier">takeLast</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span class="hs-comment">-- | The subexpression giving the number of elements we should</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- allocate space for.  See 'ChunkMap' comment.</span><span>
</span><span id="line-65"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#dimAllocationSize"><span class="hs-identifier hs-type">dimAllocationSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ChunkMap"><span class="hs-identifier hs-type">ChunkMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span>
</span><span id="line-66"></span><span id="dimAllocationSize"><span class="annot"><span class="annottext">dimAllocationSize :: ChunkMap -&gt; SubExp -&gt; SubExp
</span><a href="Futhark.Pass.ExplicitAllocations.html#dimAllocationSize"><span class="hs-identifier hs-var hs-var">dimAllocationSize</span></a></span></span><span> </span><span id="local-6989586621684395075"><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684395075"><span class="hs-identifier hs-var">chunkmap</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684395073"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684395073"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-comment">-- It is important to recurse here, as the substitution may itself</span><span>
</span><span id="line-68"></span><span>  </span><span class="hs-comment">-- be a chunk size.</span><span>
</span><span id="line-69"></span><span>  </span><span class="annot"><span class="annottext">SubExp -&gt; (SubExp -&gt; SubExp) -&gt; Maybe SubExp -&gt; SubExp
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684395073"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ChunkMap -&gt; SubExp -&gt; SubExp
</span><a href="Futhark.Pass.ExplicitAllocations.html#dimAllocationSize"><span class="hs-identifier hs-var">dimAllocationSize</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684395075"><span class="hs-identifier hs-var">chunkmap</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe SubExp -&gt; SubExp) -&gt; Maybe SubExp -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ChunkMap -&gt; Maybe SubExp
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684395073"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684395075"><span class="hs-identifier hs-var">chunkmap</span></a></span><span>
</span><span id="line-70"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#dimAllocationSize"><span class="hs-identifier hs-var">dimAllocationSize</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684395070"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684395070"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-71"></span><span>  </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684395070"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-keyword">type</span><span> </span><span id="Allocable"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-var">Allocable</span></a></span></span><span> </span><span id="local-6989586621684395069"><span class="annot"><a href="#local-6989586621684395069"><span class="hs-identifier hs-type">fromrep</span></a></span></span><span> </span><span id="local-6989586621684395068"><span class="annot"><a href="#local-6989586621684395068"><span class="hs-identifier hs-type">torep</span></a></span></span><span> </span><span id="local-6989586621684395067"><span class="annot"><a href="#local-6989586621684395067"><span class="hs-identifier hs-type">inner</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Pretty.html#PrettyRep"><span class="hs-identifier hs-type">PrettyRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395069"><span class="hs-identifier hs-type">fromrep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-75"></span><span>    </span><span class="annot"><a href="Futhark.IR.Pretty.html#PrettyRep"><span class="hs-identifier hs-type">PrettyRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395068"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-76"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395068"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395067"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-77"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395068"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#LetDecMem"><span class="hs-identifier hs-type">LetDecMem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-78"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#FParamInfo"><span class="hs-identifier hs-type">FParamInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395069"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DeclType"><span class="hs-identifier hs-type">DeclType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-79"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#LParamInfo"><span class="hs-identifier hs-type">LParamInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395069"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-80"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#BranchType"><span class="hs-identifier hs-type">BranchType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395069"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ExtType"><span class="hs-identifier hs-type">ExtType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-81"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395069"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DeclExtType"><span class="hs-identifier hs-type">DeclExtType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#BodyDec"><span class="hs-identifier hs-type">BodyDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395069"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#BodyDec"><span class="hs-identifier hs-type">BodyDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395068"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-84"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#ExpDec"><span class="hs-identifier hs-type">ExpDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395068"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-85"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395067"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395068"><span class="hs-identifier hs-type">torep</span></a></span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>
</span><span id="line-89"></span><span class="hs-comment">-- | A mapping from chunk names to their maximum size.  XXX FIXME</span><span>
</span><span id="line-90"></span><span class="hs-comment">-- HACK: This is part of a hack to add loop-invariant allocations to</span><span>
</span><span id="line-91"></span><span class="hs-comment">-- reduce kernels, because memory expansion does not use range</span><span>
</span><span id="line-92"></span><span class="hs-comment">-- analysis yet (it should).</span><span>
</span><span id="line-93"></span><span class="hs-keyword">type</span><span> </span><span id="ChunkMap"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ChunkMap"><span class="hs-identifier hs-var">ChunkMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="hs-keyword">data</span><span> </span><span id="AllocEnv"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocEnv"><span class="hs-identifier hs-var">AllocEnv</span></a></span></span><span> </span><span id="local-6989586621684396137"><span class="annot"><a href="#local-6989586621684396137"><span class="hs-identifier hs-type">fromrep</span></a></span></span><span> </span><span id="local-6989586621684396136"><span class="annot"><a href="#local-6989586621684396136"><span class="hs-identifier hs-type">torep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="AllocEnv"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocEnv"><span class="hs-identifier hs-var">AllocEnv</span></a></span></span><span>
</span><span id="line-96"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="chunkMap"><span class="annot"><span class="annottext">forall fromrep torep. AllocEnv fromrep torep -&gt; ChunkMap
</span><a href="Futhark.Pass.ExplicitAllocations.html#chunkMap"><span class="hs-identifier hs-var hs-var">chunkMap</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ChunkMap"><span class="hs-identifier hs-type">ChunkMap</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-97"></span><span>    </span><span class="hs-comment">-- | Aggressively try to reuse memory in do-loops -</span><span>
</span><span id="line-98"></span><span>    </span><span class="hs-comment">-- should be True inside kernels, False outside.</span><span>
</span><span id="line-99"></span><span>    </span><span id="aggressiveReuse"><span class="annot"><span class="annottext">forall fromrep torep. AllocEnv fromrep torep -&gt; Bool
</span><a href="Futhark.Pass.ExplicitAllocations.html#aggressiveReuse"><span class="hs-identifier hs-var hs-var">aggressiveReuse</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span>
</span><span id="line-100"></span><span>    </span><span class="hs-comment">-- | When allocating memory, put it in this memory space.</span><span>
</span><span id="line-101"></span><span>    </span><span class="hs-comment">-- This is primarily used to ensure that group-wide</span><span>
</span><span id="line-102"></span><span>    </span><span class="hs-comment">-- statements store their results in local memory.</span><span>
</span><span id="line-103"></span><span>    </span><span id="allocSpace"><span class="annot"><span class="annottext">forall fromrep torep. AllocEnv fromrep torep -&gt; Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocSpace"><span class="hs-identifier hs-var hs-var">allocSpace</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-104"></span><span>    </span><span class="hs-comment">-- | The set of names that are known to be constants at</span><span>
</span><span id="line-105"></span><span>    </span><span class="hs-comment">-- kernel compile time.</span><span>
</span><span id="line-106"></span><span>    </span><span id="envConsts"><span class="annot"><span class="annottext">forall fromrep torep. AllocEnv fromrep torep -&gt; Set VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#envConsts"><span class="hs-identifier hs-var hs-var">envConsts</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-107"></span><span>    </span><span id="allocInOp"><span class="annot"><span class="annottext">forall fromrep torep.
AllocEnv fromrep torep
-&gt; Op fromrep -&gt; AllocM fromrep torep (Op torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInOp"><span class="hs-identifier hs-var hs-var">allocInOp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684396137"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684396137"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684396136"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684396136"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-108"></span><span>    </span><span id="envExpHints"><span class="annot"><span class="annottext">forall fromrep torep.
AllocEnv fromrep torep
-&gt; Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="Futhark.Pass.ExplicitAllocations.html#envExpHints"><span class="hs-identifier hs-var hs-var">envExpHints</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684396136"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684396137"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684396136"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ExpHint"><span class="hs-identifier hs-type">ExpHint</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-110"></span><span>
</span><span id="line-111"></span><span class="hs-comment">-- | Monad for adding allocations to an entire program.</span><span>
</span><span id="line-112"></span><span class="hs-keyword">newtype</span><span> </span><span id="AllocM"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-var">AllocM</span></a></span></span><span> </span><span id="local-6989586621684396087"><span class="annot"><a href="#local-6989586621684396087"><span class="hs-identifier hs-type">fromrep</span></a></span></span><span> </span><span id="local-6989586621684396086"><span class="annot"><a href="#local-6989586621684396086"><span class="hs-identifier hs-type">torep</span></a></span></span><span> </span><span id="local-6989586621684395962"><span class="annot"><a href="#local-6989586621684395962"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-113"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="AllocM"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-var">AllocM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.html#BuilderT"><span class="hs-identifier hs-type">BuilderT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684396086"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocEnv"><span class="hs-identifier hs-type">AllocEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684396087"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684396086"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684395962"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-115"></span><span>    </span><span class="hs-special">(</span><span> </span><span id="local-6989586621684395032"><span id="local-6989586621684395037"><span id="local-6989586621684395042"><span id="local-6989586621684395047"><span id="local-6989586621684395053"><span class="annot"><span class="annottext">Functor (AllocM fromrep torep)
Functor (AllocM fromrep torep)
-&gt; (forall a. a -&gt; AllocM fromrep torep a)
-&gt; (forall a b.
    AllocM fromrep torep (a -&gt; b)
    -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c)
    -&gt; AllocM fromrep torep a
    -&gt; AllocM fromrep torep b
    -&gt; AllocM fromrep torep c)
-&gt; (forall a b.
    AllocM fromrep torep a
    -&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep b)
-&gt; (forall a b.
    AllocM fromrep torep a
    -&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep a)
-&gt; Applicative (AllocM fromrep torep)
forall a. a -&gt; AllocM fromrep torep a
forall {fromrep} {torep}. Functor (AllocM fromrep torep)
forall a b.
AllocM fromrep torep a
-&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep a
forall a b.
AllocM fromrep torep a
-&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep b
forall a b.
AllocM fromrep torep (a -&gt; b)
-&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep b
forall fromrep torep a. a -&gt; AllocM fromrep torep a
forall a b c.
(a -&gt; b -&gt; c)
-&gt; AllocM fromrep torep a
-&gt; AllocM fromrep torep b
-&gt; AllocM fromrep torep c
forall fromrep torep a b.
AllocM fromrep torep a
-&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep a
forall fromrep torep a b.
AllocM fromrep torep a
-&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep b
forall fromrep torep a b.
AllocM fromrep torep (a -&gt; b)
-&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep b
forall fromrep torep a b c.
(a -&gt; b -&gt; c)
-&gt; AllocM fromrep torep a
-&gt; AllocM fromrep torep b
-&gt; AllocM fromrep torep c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: forall a b.
AllocM fromrep torep a
-&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep a
$c&lt;* :: forall fromrep torep a b.
AllocM fromrep torep a
-&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep a
*&gt; :: forall a b.
AllocM fromrep torep a
-&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep b
$c*&gt; :: forall fromrep torep a b.
AllocM fromrep torep a
-&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep b
liftA2 :: forall a b c.
(a -&gt; b -&gt; c)
-&gt; AllocM fromrep torep a
-&gt; AllocM fromrep torep b
-&gt; AllocM fromrep torep c
$cliftA2 :: forall fromrep torep a b c.
(a -&gt; b -&gt; c)
-&gt; AllocM fromrep torep a
-&gt; AllocM fromrep torep b
-&gt; AllocM fromrep torep c
&lt;*&gt; :: forall a b.
AllocM fromrep torep (a -&gt; b)
-&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep b
$c&lt;*&gt; :: forall fromrep torep a b.
AllocM fromrep torep (a -&gt; b)
-&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep b
pure :: forall a. a -&gt; AllocM fromrep torep a
$cpure :: forall fromrep torep a. a -&gt; AllocM fromrep torep a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-116"></span><span>      </span><span id="local-6989586621684395013"><span id="local-6989586621684395019"><span class="annot"><span class="annottext">(forall a b.
 (a -&gt; b) -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep b)
-&gt; (forall a b.
    a -&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep a)
-&gt; Functor (AllocM fromrep torep)
forall a b. a -&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep a
forall a b.
(a -&gt; b) -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep b
forall fromrep torep a b.
a -&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep a
forall fromrep torep a b.
(a -&gt; b) -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: forall a b. a -&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep a
$c&lt;$ :: forall fromrep torep a b.
a -&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep a
fmap :: forall a b.
(a -&gt; b) -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep b
$cfmap :: forall fromrep torep a b.
(a -&gt; b) -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-117"></span><span>      </span><span id="local-6989586621684394990"><span id="local-6989586621684394995"><span id="local-6989586621684395001"><span class="annot"><span class="annottext">Applicative (AllocM fromrep torep)
Applicative (AllocM fromrep torep)
-&gt; (forall a b.
    AllocM fromrep torep a
    -&gt; (a -&gt; AllocM fromrep torep b) -&gt; AllocM fromrep torep b)
-&gt; (forall a b.
    AllocM fromrep torep a
    -&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep b)
-&gt; (forall a. a -&gt; AllocM fromrep torep a)
-&gt; Monad (AllocM fromrep torep)
forall a. a -&gt; AllocM fromrep torep a
forall fromrep torep. Applicative (AllocM fromrep torep)
forall a b.
AllocM fromrep torep a
-&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep b
forall a b.
AllocM fromrep torep a
-&gt; (a -&gt; AllocM fromrep torep b) -&gt; AllocM fromrep torep b
forall fromrep torep a. a -&gt; AllocM fromrep torep a
forall fromrep torep a b.
AllocM fromrep torep a
-&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep b
forall fromrep torep a b.
AllocM fromrep torep a
-&gt; (a -&gt; AllocM fromrep torep b) -&gt; AllocM fromrep torep b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: forall a. a -&gt; AllocM fromrep torep a
$creturn :: forall fromrep torep a. a -&gt; AllocM fromrep torep a
&gt;&gt; :: forall a b.
AllocM fromrep torep a
-&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep b
$c&gt;&gt; :: forall fromrep torep a b.
AllocM fromrep torep a
-&gt; AllocM fromrep torep b -&gt; AllocM fromrep torep b
&gt;&gt;= :: forall a b.
AllocM fromrep torep a
-&gt; (a -&gt; AllocM fromrep torep b) -&gt; AllocM fromrep torep b
$c&gt;&gt;= :: forall fromrep torep a b.
AllocM fromrep torep a
-&gt; (a -&gt; AllocM fromrep torep b) -&gt; AllocM fromrep torep b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-118"></span><span>      </span><span id="local-6989586621684394970"><span id="local-6989586621684394976"><span class="annot"><span class="annottext">Monad (AllocM fromrep torep)
Applicative (AllocM fromrep torep)
AllocM fromrep torep VNameSource
Applicative (AllocM fromrep torep)
-&gt; Monad (AllocM fromrep torep)
-&gt; AllocM fromrep torep VNameSource
-&gt; (VNameSource -&gt; AllocM fromrep torep ())
-&gt; MonadFreshNames (AllocM fromrep torep)
VNameSource -&gt; AllocM fromrep torep ()
forall fromrep torep. Monad (AllocM fromrep torep)
forall fromrep torep. Applicative (AllocM fromrep torep)
forall fromrep torep. AllocM fromrep torep VNameSource
forall fromrep torep. VNameSource -&gt; AllocM fromrep torep ()
forall (m :: * -&gt; *).
Applicative m
-&gt; Monad m
-&gt; m VNameSource
-&gt; (VNameSource -&gt; m ())
-&gt; MonadFreshNames m
putNameSource :: VNameSource -&gt; AllocM fromrep torep ()
$cputNameSource :: forall fromrep torep. VNameSource -&gt; AllocM fromrep torep ()
getNameSource :: AllocM fromrep torep VNameSource
$cgetNameSource :: forall fromrep torep. AllocM fromrep torep VNameSource
</span><a href="Futhark.MonadFreshNames.html#C%3AMonadFreshNames"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">MonadFreshNames</span></a></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-119"></span><span>      </span><span id="local-6989586621684394934"><span id="local-6989586621684394939"><span id="local-6989586621684394944"><span id="local-6989586621684394950"><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684396086"><span class="hs-identifier hs-type">torep</span></a></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-120"></span><span>      </span><span id="local-6989586621684394917"><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684396086"><span class="hs-identifier hs-type">torep</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-121"></span><span>      </span><span id="local-6989586621684394895"><span id="local-6989586621684394900"><span id="local-6989586621684394906"><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocEnv"><span class="hs-identifier hs-type">AllocEnv</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684396087"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684396086"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-122"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span id="local-6989586621684395980"><span id="local-6989586621684395981"><span id="local-6989586621684395982"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684394866"><span id="local-6989586621684394870"><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395982"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395981"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395980"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395982"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395981"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-keyword">type</span><span> </span><span id="Rep"><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-var">Rep</span></a></span></span><span> </span><span id="local-6989586621684395981"><span id="local-6989586621684395982"><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395982"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395981"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="#local-6989586621684395981"><span class="hs-identifier hs-type">torep</span></a></span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span>  </span><span id="local-6989586621684394863"><span class="annot"><span class="annottext">mkExpDecM :: Pat (Rep (AllocM fromrep torep))
-&gt; Exp (Rep (AllocM fromrep torep))
-&gt; AllocM fromrep torep (ExpDec (Rep (AllocM fromrep torep)))
</span><a href="Futhark.Builder.Class.html#mkExpDecM"><span class="hs-identifier hs-var hs-var hs-var hs-var">mkExpDecM</span></a></span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (AllocM fromrep torep))
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Exp (Rep (AllocM fromrep torep))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; AllocM fromrep torep ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span>  </span><span id="local-6989586621684394844"><span class="annot"><span class="annottext">mkLetNamesM :: [VName]
-&gt; Exp (Rep (AllocM fromrep torep))
-&gt; AllocM fromrep torep (Stm (Rep (AllocM fromrep torep)))
</span><a href="Futhark.Builder.Class.html#mkLetNamesM"><span class="hs-identifier hs-var hs-var hs-var hs-var">mkLetNamesM</span></a></span></span><span> </span><span id="local-6989586621684394842"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684394842"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span id="local-6989586621684394841"><span class="annot"><span class="annottext">Exp (Rep (AllocM fromrep torep))
</span><a href="#local-6989586621684394841"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>    </span><span id="local-6989586621684394840"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394840"><span class="hs-identifier hs-var">def_space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep Space
forall fromrep torep. AllocM fromrep torep Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#askDefaultSpace"><span class="hs-identifier hs-var">askDefaultSpace</span></a></span><span>
</span><span id="line-131"></span><span>    </span><span id="local-6989586621684394838"><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394838"><span class="hs-identifier hs-var">chunkmap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(AllocEnv fromrep torep -&gt; ChunkMap)
-&gt; AllocM fromrep torep ChunkMap
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">AllocEnv fromrep torep -&gt; ChunkMap
forall fromrep torep. AllocEnv fromrep torep -&gt; ChunkMap
</span><a href="Futhark.Pass.ExplicitAllocations.html#chunkMap"><span class="hs-identifier hs-var hs-var">chunkMap</span></a></span><span>
</span><span id="line-132"></span><span>    </span><span id="local-6989586621684394836"><span class="annot"><span class="annottext">[ExpHint]
</span><a href="#local-6989586621684394836"><span class="hs-identifier hs-var">hints</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp torep -&gt; AllocM fromrep torep [ExpHint]
forall torep fromrep. Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="Futhark.Pass.ExplicitAllocations.html#expHints"><span class="hs-identifier hs-var">expHints</span></a></span><span> </span><span class="annot"><span class="annottext">Exp torep
Exp (Rep (AllocM fromrep torep))
</span><a href="#local-6989586621684394841"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-133"></span><span>    </span><span id="local-6989586621684394834"><span class="annot"><span class="annottext">PatT LParamMem
</span><a href="#local-6989586621684394834"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Space
-&gt; ChunkMap
-&gt; [VName]
-&gt; Exp (Rep (AllocM fromrep torep))
-&gt; [ExpHint]
-&gt; AllocM fromrep torep (PatT LParamMem)
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Mem (Rep m) inner) =&gt;
Space
-&gt; ChunkMap
-&gt; [VName]
-&gt; Exp (Rep m)
-&gt; [ExpHint]
-&gt; m (PatT LParamMem)
</span><a href="Futhark.Pass.ExplicitAllocations.html#patWithAllocations"><span class="hs-identifier hs-var">patWithAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394840"><span class="hs-identifier hs-var">def_space</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394838"><span class="hs-identifier hs-var">chunkmap</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684394842"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">Exp (Rep (AllocM fromrep torep))
</span><a href="#local-6989586621684394841"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpHint]
</span><a href="#local-6989586621684394836"><span class="hs-identifier hs-var">hints</span></a></span><span>
</span><span id="line-134"></span><span>    </span><span class="annot"><span class="annottext">Stm torep -&gt; AllocM fromrep torep (Stm torep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stm torep -&gt; AllocM fromrep torep (Stm torep))
-&gt; Stm torep -&gt; AllocM fromrep torep (Stm torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat torep -&gt; StmAux (ExpDec torep) -&gt; Exp torep -&gt; Stm torep
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat torep
PatT LParamMem
</span><a href="#local-6989586621684394834"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp torep
Exp (Rep (AllocM fromrep torep))
</span><a href="#local-6989586621684394841"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-135"></span><span>
</span><span id="line-136"></span><span>  </span><span id="local-6989586621684394829"><span class="annot"><span class="annottext">mkBodyM :: Stms (Rep (AllocM fromrep torep))
-&gt; Result
-&gt; AllocM fromrep torep (Body (Rep (AllocM fromrep torep)))
</span><a href="Futhark.Builder.Class.html#mkBodyM"><span class="hs-identifier hs-var hs-var hs-var hs-var">mkBodyM</span></a></span></span><span> </span><span id="local-6989586621684394827"><span class="annot"><span class="annottext">Stms (Rep (AllocM fromrep torep))
</span><a href="#local-6989586621684394827"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684394826"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684394826"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT torep -&gt; AllocM fromrep torep (BodyT torep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(BodyT torep -&gt; AllocM fromrep torep (BodyT torep))
-&gt; BodyT torep -&gt; AllocM fromrep torep (BodyT torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyDec torep -&gt; Stms torep -&gt; Result -&gt; BodyT torep
forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms torep
Stms (Rep (AllocM fromrep torep))
</span><a href="#local-6989586621684394827"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684394826"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span>  </span><span id="local-6989586621684394819"><span class="annot"><span class="annottext">addStms :: Stms (Rep (AllocM fromrep torep)) -&gt; AllocM fromrep torep ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var hs-var hs-var hs-var">addStms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuilderT
  torep (ReaderT (AllocEnv fromrep torep) (State VNameSource)) ()
-&gt; AllocM fromrep torep ()
forall fromrep torep a.
BuilderT
  torep (ReaderT (AllocEnv fromrep torep) (State VNameSource)) a
-&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-var">AllocM</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT
   torep (ReaderT (AllocEnv fromrep torep) (State VNameSource)) ()
 -&gt; AllocM fromrep torep ())
-&gt; (Stms torep
    -&gt; BuilderT
         torep (ReaderT (AllocEnv fromrep torep) (State VNameSource)) ())
-&gt; Stms torep
-&gt; AllocM fromrep torep ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms torep
-&gt; BuilderT
     torep (ReaderT (AllocEnv fromrep torep) (State VNameSource)) ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span>
</span><span id="line-139"></span><span>  </span><span id="local-6989586621684394812"><span class="annot"><span class="annottext">collectStms :: forall a.
AllocM fromrep torep a
-&gt; AllocM fromrep torep (a, Stms (Rep (AllocM fromrep torep)))
</span><a href="Futhark.Builder.Class.html#collectStms"><span class="hs-identifier hs-var hs-var hs-var hs-var">collectStms</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span id="local-6989586621684394810"><span class="annot"><span class="annottext">BuilderT
  torep (ReaderT (AllocEnv fromrep torep) (State VNameSource)) a
</span><a href="#local-6989586621684394810"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BuilderT
  torep
  (ReaderT (AllocEnv fromrep torep) (State VNameSource))
  (a, Stms torep)
-&gt; AllocM fromrep torep (a, Stms torep)
forall fromrep torep a.
BuilderT
  torep (ReaderT (AllocEnv fromrep torep) (State VNameSource)) a
-&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-var">AllocM</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT
   torep
   (ReaderT (AllocEnv fromrep torep) (State VNameSource))
   (a, Stms torep)
 -&gt; AllocM fromrep torep (a, Stms torep))
-&gt; BuilderT
     torep
     (ReaderT (AllocEnv fromrep torep) (State VNameSource))
     (a, Stms torep)
-&gt; AllocM fromrep torep (a, Stms torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BuilderT
  torep (ReaderT (AllocEnv fromrep torep) (State VNameSource)) a
-&gt; BuilderT
     torep
     (ReaderT (AllocEnv fromrep torep) (State VNameSource))
     (a,
      Stms
        (Rep
           (BuilderT
              torep (ReaderT (AllocEnv fromrep torep) (State VNameSource)))))
forall (m :: * -&gt; *) a.
MonadBuilder m =&gt;
m a -&gt; m (a, Stms (Rep m))
</span><a href="Futhark.Builder.Class.html#collectStms"><span class="hs-identifier hs-var">collectStms</span></a></span><span> </span><span class="annot"><span class="annottext">BuilderT
  torep (ReaderT (AllocEnv fromrep torep) (State VNameSource)) a
</span><a href="#local-6989586621684394810"><span class="hs-identifier hs-var">m</span></a></span></span></span></span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span id="local-6989586621684395973"><span id="local-6989586621684395974"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#expHints"><span class="hs-identifier hs-type">expHints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395974"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395973"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395974"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ExpHint"><span class="hs-identifier hs-type">ExpHint</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-142"></span><span id="expHints"><span class="annot"><span class="annottext">expHints :: forall torep fromrep. Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="Futhark.Pass.ExplicitAllocations.html#expHints"><span class="hs-identifier hs-var hs-var">expHints</span></a></span></span><span> </span><span id="local-6989586621684394807"><span class="annot"><span class="annottext">Exp torep
</span><a href="#local-6989586621684394807"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-143"></span><span>  </span><span id="local-6989586621684394806"><span class="annot"><span class="annottext">Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="#local-6989586621684394806"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(AllocEnv fromrep torep
 -&gt; Exp torep -&gt; AllocM fromrep torep [ExpHint])
-&gt; AllocM
     fromrep torep (Exp torep -&gt; AllocM fromrep torep [ExpHint])
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">AllocEnv fromrep torep
-&gt; Exp torep -&gt; AllocM fromrep torep [ExpHint]
forall fromrep torep.
AllocEnv fromrep torep
-&gt; Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="Futhark.Pass.ExplicitAllocations.html#envExpHints"><span class="hs-identifier hs-var hs-var">envExpHints</span></a></span><span>
</span><span id="line-144"></span><span>  </span><span class="annot"><span class="annottext">Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="#local-6989586621684394806"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Exp torep
</span><a href="#local-6989586621684394807"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span id="local-6989586621684395978"><span id="local-6989586621684395979"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#askDefaultSpace"><span class="hs-identifier hs-type">askDefaultSpace</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395979"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395978"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span></span></span><span>
</span><span id="line-147"></span><span id="askDefaultSpace"><span class="annot"><span class="annottext">askDefaultSpace :: forall fromrep torep. AllocM fromrep torep Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#askDefaultSpace"><span class="hs-identifier hs-var hs-var">askDefaultSpace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(AllocEnv fromrep torep -&gt; Space) -&gt; AllocM fromrep torep Space
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">AllocEnv fromrep torep -&gt; Space
forall fromrep torep. AllocEnv fromrep torep -&gt; Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocSpace"><span class="hs-identifier hs-var hs-var">allocSpace</span></a></span><span>
</span><span id="line-148"></span><span>
</span><span id="line-149"></span><span id="local-6989586621684395950"><span id="local-6989586621684395951"><span id="local-6989586621684395952"><span id="local-6989586621684395953"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#runAllocM"><span class="hs-identifier hs-type">runAllocM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-150"></span><span>  </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395953"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-151"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395952"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395952"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395951"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395951"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-152"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395951"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395952"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395951"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ExpHint"><span class="hs-identifier hs-type">ExpHint</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-153"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395952"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395951"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395950"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-154"></span><span>  </span><span class="annot"><a href="#local-6989586621684395953"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395950"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-155"></span><span id="runAllocM"><span class="annot"><span class="annottext">runAllocM :: forall (m :: * -&gt; *) fromrep torep a.
MonadFreshNames m =&gt;
(Op fromrep -&gt; AllocM fromrep torep (Op torep))
-&gt; (Exp torep -&gt; AllocM fromrep torep [ExpHint])
-&gt; AllocM fromrep torep a
-&gt; m a
</span><a href="Futhark.Pass.ExplicitAllocations.html#runAllocM"><span class="hs-identifier hs-var hs-var">runAllocM</span></a></span></span><span> </span><span id="local-6989586621684394788"><span class="annot"><span class="annottext">Op fromrep -&gt; AllocM fromrep torep (Op torep)
</span><a href="#local-6989586621684394788"><span class="hs-identifier hs-var">handleOp</span></a></span></span><span> </span><span id="local-6989586621684394787"><span class="annot"><span class="annottext">Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="#local-6989586621684394787"><span class="hs-identifier hs-var">hints</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span id="local-6989586621684394786"><span class="annot"><span class="annottext">BuilderT
  torep (ReaderT (AllocEnv fromrep torep) (State VNameSource)) a
</span><a href="#local-6989586621684394786"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-156"></span><span>  </span><span class="annot"><span class="annottext">((a, Stms torep) -&gt; a) -&gt; m (a, Stms torep) -&gt; m a
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(a, Stms torep) -&gt; a
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(m (a, Stms torep) -&gt; m a) -&gt; m (a, Stms torep) -&gt; m a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VNameSource -&gt; ((a, Stms torep), VNameSource))
-&gt; m (a, Stms torep)
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
(VNameSource -&gt; (a, VNameSource)) -&gt; m a
</span><a href="Futhark.MonadFreshNames.html#modifyNameSource"><span class="hs-identifier hs-var">modifyNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">((VNameSource -&gt; ((a, Stms torep), VNameSource))
 -&gt; m (a, Stms torep))
-&gt; (VNameSource -&gt; ((a, Stms torep), VNameSource))
-&gt; m (a, Stms torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">State VNameSource (a, Stms torep)
-&gt; VNameSource -&gt; ((a, Stms torep), VNameSource)
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="annot"><span class="annottext">(State VNameSource (a, Stms torep)
 -&gt; VNameSource -&gt; ((a, Stms torep), VNameSource))
-&gt; State VNameSource (a, Stms torep)
-&gt; VNameSource
-&gt; ((a, Stms torep), VNameSource)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ReaderT
  (AllocEnv fromrep torep) (State VNameSource) (a, Stms torep)
-&gt; AllocEnv fromrep torep -&gt; State VNameSource (a, Stms torep)
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BuilderT
  torep (ReaderT (AllocEnv fromrep torep) (State VNameSource)) a
-&gt; Scope torep
-&gt; ReaderT
     (AllocEnv fromrep torep) (State VNameSource) (a, Stms torep)
forall (m :: * -&gt; *) rep a.
MonadFreshNames m =&gt;
BuilderT rep m a -&gt; Scope rep -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT"><span class="hs-identifier hs-var">runBuilderT</span></a></span><span> </span><span class="annot"><span class="annottext">BuilderT
  torep (ReaderT (AllocEnv fromrep torep) (State VNameSource)) a
</span><a href="#local-6989586621684394786"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Scope torep
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">AllocEnv fromrep torep
</span><a href="#local-6989586621684394781"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-157"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-158"></span><span>    </span><span id="local-6989586621684394781"><span class="annot"><span class="annottext">env :: AllocEnv fromrep torep
</span><a href="#local-6989586621684394781"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-159"></span><span>      </span><span class="annot"><span class="annottext">AllocEnv :: forall fromrep torep.
ChunkMap
-&gt; Bool
-&gt; Space
-&gt; Set VName
-&gt; (Op fromrep -&gt; AllocM fromrep torep (Op torep))
-&gt; (Exp torep -&gt; AllocM fromrep torep [ExpHint])
-&gt; AllocEnv fromrep torep
</span><a href="Futhark.Pass.ExplicitAllocations.html#AllocEnv"><span class="hs-identifier hs-type">AllocEnv</span></a></span><span>
</span><span id="line-160"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">chunkMap :: ChunkMap
</span><a href="Futhark.Pass.ExplicitAllocations.html#chunkMap"><span class="hs-identifier hs-var">chunkMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkMap
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-161"></span><span>          </span><span class="annot"><span class="annottext">aggressiveReuse :: Bool
</span><a href="Futhark.Pass.ExplicitAllocations.html#aggressiveReuse"><span class="hs-identifier hs-var">aggressiveReuse</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span>
</span><span id="line-162"></span><span>          </span><span class="annot"><span class="annottext">allocSpace :: Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocSpace"><span class="hs-identifier hs-var">allocSpace</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-163"></span><span>          </span><span class="annot"><span class="annottext">envConsts :: Set VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#envConsts"><span class="hs-identifier hs-var">envConsts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-164"></span><span>          </span><span class="annot"><span class="annottext">allocInOp :: Op fromrep -&gt; AllocM fromrep torep (Op torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInOp"><span class="hs-identifier hs-var">allocInOp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Op fromrep -&gt; AllocM fromrep torep (Op torep)
</span><a href="#local-6989586621684394788"><span class="hs-identifier hs-var">handleOp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-165"></span><span>          </span><span class="annot"><span class="annottext">envExpHints :: Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="Futhark.Pass.ExplicitAllocations.html#envExpHints"><span class="hs-identifier hs-var">envExpHints</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="#local-6989586621684394787"><span class="hs-identifier hs-var">hints</span></a></span><span>
</span><span id="line-166"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-167"></span><span>
</span><span id="line-168"></span><span id="local-6989586621684395929"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#elemSize"><span class="hs-identifier hs-type">elemSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Num</span></span><span> </span><span class="annot"><a href="#local-6989586621684395929"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684395929"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-169"></span><span id="elemSize"><span class="annot"><span class="annottext">elemSize :: forall a. Num a =&gt; Type -&gt; a
</span><a href="Futhark.Pass.ExplicitAllocations.html#elemSize"><span class="hs-identifier hs-var hs-var">elemSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; a
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; a) -&gt; (Type -&gt; PrimType) -&gt; Type -&gt; a
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span>
</span><span id="line-170"></span><span>
</span><span id="line-171"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#arraySizeInBytesExp"><span class="hs-identifier hs-type">arraySizeInBytesExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#PrimExp"><span class="hs-identifier hs-type">PrimExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-172"></span><span id="arraySizeInBytesExp"><span class="annot"><span class="annottext">arraySizeInBytesExp :: Type -&gt; PrimExp VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#arraySizeInBytesExp"><span class="hs-identifier hs-var hs-var">arraySizeInBytesExp</span></a></span></span><span> </span><span id="local-6989586621684394774"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394774"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-173"></span><span>  </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; PrimExp VName)
-&gt; TPrimExp Int64 VName -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName
-&gt; [TPrimExp Int64 VName]
-&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(*)</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; Type -&gt; a
</span><a href="Futhark.Pass.ExplicitAllocations.html#elemSize"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394774"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394774"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span id="local-6989586621684395911"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#arraySizeInBytesExpM"><span class="hs-identifier hs-type">arraySizeInBytesExpM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395911"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ChunkMap"><span class="hs-identifier hs-type">ChunkMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684395911"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#PrimExp"><span class="hs-identifier hs-type">PrimExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-176"></span><span id="arraySizeInBytesExpM"><span class="annot"><span class="annottext">arraySizeInBytesExpM :: forall (m :: * -&gt; *).
MonadBuilder m =&gt;
ChunkMap -&gt; Type -&gt; m (PrimExp VName)
</span><a href="Futhark.Pass.ExplicitAllocations.html#arraySizeInBytesExpM"><span class="hs-identifier hs-var hs-var">arraySizeInBytesExpM</span></a></span></span><span> </span><span id="local-6989586621684394756"><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394756"><span class="hs-identifier hs-var">chunkmap</span></a></span></span><span> </span><span id="local-6989586621684394755"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394755"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684394754"><span class="annot"><span class="annottext">dim_prod_i64 :: TPrimExp Int64 VName
</span><a href="#local-6989586621684394754"><span class="hs-identifier hs-var hs-var">dim_prod_i64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; (SubExp -&gt; SubExp) -&gt; SubExp -&gt; TPrimExp Int64 VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ChunkMap -&gt; SubExp -&gt; SubExp
</span><a href="Futhark.Pass.ExplicitAllocations.html#dimAllocationSize"><span class="hs-identifier hs-var">dimAllocationSize</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394756"><span class="hs-identifier hs-var">chunkmap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394755"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>      </span><span id="local-6989586621684394752"><span class="annot"><span class="annottext">elm_size_i64 :: TPrimExp Int64 VName
</span><a href="#local-6989586621684394752"><span class="hs-identifier hs-var hs-var">elm_size_i64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; Type -&gt; a
</span><a href="Futhark.Pass.ExplicitAllocations.html#elemSize"><span class="hs-identifier hs-var">elemSize</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394755"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-179"></span><span>  </span><span class="annot"><span class="annottext">PrimExp VName -&gt; m (PrimExp VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; m (PrimExp VName))
-&gt; PrimExp VName -&gt; m (PrimExp VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><span class="annottext">BinOp -&gt; PrimExp VName -&gt; PrimExp VName -&gt; PrimExp VName
forall v. BinOp -&gt; PrimExp v -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#BinOpExp"><span class="hs-identifier hs-var">BinOpExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SMax"><span class="hs-identifier hs-var">SMax</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimValue -&gt; PrimExp VName
forall v. PrimValue -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#ValueExp"><span class="hs-identifier hs-var">ValueExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimValue -&gt; PrimExp VName) -&gt; PrimValue -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntValue -&gt; PrimValue
</span><a href="Futhark.IR.Primitive.html#IntValue"><span class="hs-identifier hs-var">IntValue</span></a></span><span> </span><span class="annot"><span class="annottext">(IntValue -&gt; PrimValue) -&gt; IntValue -&gt; PrimValue
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; IntValue
</span><a href="Futhark.IR.Primitive.html#Int64Value"><span class="hs-identifier hs-var">Int64Value</span></a></span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; PrimExp VName) -&gt; PrimExp VName -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-181"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; PrimExp VName)
-&gt; TPrimExp Int64 VName -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684394754"><span class="hs-identifier hs-var">dim_prod_i64</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684394752"><span class="hs-identifier hs-var">elm_size_i64</span></a></span><span>
</span><span id="line-182"></span><span>
</span><span id="line-183"></span><span id="local-6989586621684395903"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#arraySizeInBytes"><span class="hs-identifier hs-type">arraySizeInBytes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395903"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ChunkMap"><span class="hs-identifier hs-type">ChunkMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684395903"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span></span><span>
</span><span id="line-184"></span><span id="arraySizeInBytes"><span class="annot"><span class="annottext">arraySizeInBytes :: forall (m :: * -&gt; *).
MonadBuilder m =&gt;
ChunkMap -&gt; Type -&gt; m SubExp
</span><a href="Futhark.Pass.ExplicitAllocations.html#arraySizeInBytes"><span class="hs-identifier hs-var hs-var">arraySizeInBytes</span></a></span></span><span> </span><span id="local-6989586621684394731"><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394731"><span class="hs-identifier hs-var">chunkmap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; ExpT (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bytes&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT (Rep m) -&gt; m SubExp)
-&gt; (Type -&gt; m (ExpT (Rep m))) -&gt; Type -&gt; m SubExp
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; m (ExpT (Rep m))
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; m (ExpT (Rep m)))
-&gt; (Type -&gt; m (PrimExp VName)) -&gt; Type -&gt; m (ExpT (Rep m))
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">ChunkMap -&gt; Type -&gt; m (PrimExp VName)
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
ChunkMap -&gt; Type -&gt; m (PrimExp VName)
</span><a href="Futhark.Pass.ExplicitAllocations.html#arraySizeInBytesExpM"><span class="hs-identifier hs-var">arraySizeInBytesExpM</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394731"><span class="hs-identifier hs-var">chunkmap</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span id="local-6989586621684395890"><span id="local-6989586621684395891"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocForArray%27"><span class="hs-identifier hs-type">allocForArray'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395891"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395891"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemOp"><span class="hs-identifier hs-type">MemOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395890"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-188"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ChunkMap"><span class="hs-identifier hs-type">ChunkMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-190"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-191"></span><span>  </span><span class="annot"><a href="#local-6989586621684395891"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span></span><span>
</span><span id="line-192"></span><span id="allocForArray%27"><span class="annot"><span class="annottext">allocForArray' :: forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ MemOp inner) =&gt;
ChunkMap -&gt; Type -&gt; Space -&gt; m VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocForArray%27"><span class="hs-identifier hs-var hs-var">allocForArray'</span></a></span></span><span> </span><span id="local-6989586621684394715"><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394715"><span class="hs-identifier hs-var">chunkmap</span></a></span></span><span> </span><span id="local-6989586621684394714"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394714"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684394713"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394713"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-193"></span><span>  </span><span id="local-6989586621684394712"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684394712"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChunkMap -&gt; Type -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
ChunkMap -&gt; Type -&gt; m SubExp
</span><a href="Futhark.Pass.ExplicitAllocations.html#arraySizeInBytes"><span class="hs-identifier hs-var">arraySizeInBytes</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394715"><span class="hs-identifier hs-var">chunkmap</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394714"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-194"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mem&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m VName) -&gt; Exp (Rep m) -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op (Rep m) -&gt; Exp (Rep m)
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op (Rep m) -&gt; Exp (Rep m)) -&gt; Op (Rep m) -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Space -&gt; MemOp inner
forall inner. SubExp -&gt; Space -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-var">Alloc</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684394712"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394713"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span class="hs-comment">-- | Allocate memory for a value of the given type.</span><span>
</span><span id="line-197"></span><span id="local-6989586621684395882"><span id="local-6989586621684395883"><span id="local-6989586621684395884"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocForArray"><span class="hs-identifier hs-type">allocForArray</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-198"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395884"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395883"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395882"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-199"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-200"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-201"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395884"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395883"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span></span></span><span>
</span><span id="line-202"></span><span id="allocForArray"><span class="annot"><span class="annottext">allocForArray :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Type -&gt; Space -&gt; AllocM fromrep torep VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocForArray"><span class="hs-identifier hs-var hs-var">allocForArray</span></a></span></span><span> </span><span id="local-6989586621684394626"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394626"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684394625"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394625"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-203"></span><span>  </span><span id="local-6989586621684394624"><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394624"><span class="hs-identifier hs-var">chunkmap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(AllocEnv fromrep torep -&gt; ChunkMap)
-&gt; AllocM fromrep torep ChunkMap
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">AllocEnv fromrep torep -&gt; ChunkMap
forall fromrep torep. AllocEnv fromrep torep -&gt; ChunkMap
</span><a href="Futhark.Pass.ExplicitAllocations.html#chunkMap"><span class="hs-identifier hs-var hs-var">chunkMap</span></a></span><span>
</span><span id="line-204"></span><span>  </span><span class="annot"><span class="annottext">ChunkMap -&gt; Type -&gt; Space -&gt; AllocM fromrep torep VName
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ MemOp inner) =&gt;
ChunkMap -&gt; Type -&gt; Space -&gt; m VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocForArray%27"><span class="hs-identifier hs-var">allocForArray'</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394624"><span class="hs-identifier hs-var">chunkmap</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394626"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394625"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span id="local-6989586621684395876"><span id="local-6989586621684395877"><span id="local-6989586621684395878"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocsForStm"><span class="hs-identifier hs-type">allocsForStm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-207"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395878"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395877"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395876"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-208"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-209"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395877"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395878"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395877"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395877"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-211"></span><span id="allocsForStm"><span class="annot"><span class="annottext">allocsForStm :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
[Ident] -&gt; Exp torep -&gt; AllocM fromrep torep (Stm torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocsForStm"><span class="hs-identifier hs-var hs-var">allocsForStm</span></a></span></span><span> </span><span id="local-6989586621684394527"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394527"><span class="hs-identifier hs-var">idents</span></a></span></span><span> </span><span id="local-6989586621684394526"><span class="annot"><span class="annottext">Exp torep
</span><a href="#local-6989586621684394526"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-212"></span><span>  </span><span id="local-6989586621684394525"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394525"><span class="hs-identifier hs-var">def_space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep Space
forall fromrep torep. AllocM fromrep torep Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#askDefaultSpace"><span class="hs-identifier hs-var">askDefaultSpace</span></a></span><span>
</span><span id="line-213"></span><span>  </span><span id="local-6989586621684394524"><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394524"><span class="hs-identifier hs-var">chunkmap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(AllocEnv fromrep torep -&gt; ChunkMap)
-&gt; AllocM fromrep torep ChunkMap
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">AllocEnv fromrep torep -&gt; ChunkMap
forall fromrep torep. AllocEnv fromrep torep -&gt; ChunkMap
</span><a href="Futhark.Pass.ExplicitAllocations.html#chunkMap"><span class="hs-identifier hs-var hs-var">chunkMap</span></a></span><span>
</span><span id="line-214"></span><span>  </span><span id="local-6989586621684394523"><span class="annot"><span class="annottext">[ExpHint]
</span><a href="#local-6989586621684394523"><span class="hs-identifier hs-var">hints</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp torep -&gt; AllocM fromrep torep [ExpHint]
forall torep fromrep. Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="Futhark.Pass.ExplicitAllocations.html#expHints"><span class="hs-identifier hs-var">expHints</span></a></span><span> </span><span class="annot"><span class="annottext">Exp torep
</span><a href="#local-6989586621684394526"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-215"></span><span>  </span><span id="local-6989586621684394522"><span class="annot"><span class="annottext">[ExpReturns]
</span><a href="#local-6989586621684394522"><span class="hs-identifier hs-var">rts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp torep -&gt; AllocM fromrep torep [ExpReturns]
forall (m :: * -&gt; *) rep inner.
(Monad m, LocalScope rep m, Mem rep inner) =&gt;
Exp rep -&gt; m [ExpReturns]
</span><a href="Futhark.IR.Mem.html#expReturns"><span class="hs-identifier hs-var">expReturns</span></a></span><span> </span><span class="annot"><span class="annottext">Exp torep
</span><a href="#local-6989586621684394526"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-216"></span><span>  </span><span id="local-6989586621684394520"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684394520"><span class="hs-identifier hs-var">pes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Space
-&gt; ChunkMap
-&gt; [Ident]
-&gt; [ExpReturns]
-&gt; [ExpHint]
-&gt; AllocM fromrep torep [PatElemT LParamMem]
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ MemOp inner) =&gt;
Space
-&gt; ChunkMap
-&gt; [Ident]
-&gt; [ExpReturns]
-&gt; [ExpHint]
-&gt; m [PatElemT LParamMem]
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocsForPat"><span class="hs-identifier hs-var">allocsForPat</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394525"><span class="hs-identifier hs-var">def_space</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394524"><span class="hs-identifier hs-var">chunkmap</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394527"><span class="hs-identifier hs-var">idents</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpReturns]
</span><a href="#local-6989586621684394522"><span class="hs-identifier hs-var">rts</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpHint]
</span><a href="#local-6989586621684394523"><span class="hs-identifier hs-var">hints</span></a></span><span>
</span><span id="line-217"></span><span>  </span><span id="local-6989586621684394518"><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621684394518"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat (Rep (AllocM fromrep torep))
-&gt; Exp (Rep (AllocM fromrep torep))
-&gt; AllocM fromrep torep (ExpDec (Rep (AllocM fromrep torep)))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m (ExpDec (Rep m))
</span><a href="Futhark.Builder.Class.html#mkExpDecM"><span class="hs-identifier hs-var">mkExpDecM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; PatT LParamMem
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684394520"><span class="hs-identifier hs-var">pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp torep
Exp (Rep (AllocM fromrep torep))
</span><a href="#local-6989586621684394526"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-218"></span><span>  </span><span class="annot"><span class="annottext">Stm torep -&gt; AllocM fromrep torep (Stm torep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Stm torep -&gt; AllocM fromrep torep (Stm torep))
-&gt; Stm torep -&gt; AllocM fromrep torep (Stm torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat torep -&gt; StmAux (ExpDec torep) -&gt; Exp torep -&gt; Stm torep
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; PatT LParamMem
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684394520"><span class="hs-identifier hs-var">pes</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="annot"><span class="annottext">()
</span><a href="#local-6989586621684394518"><span class="hs-identifier hs-var">dec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp torep
</span><a href="#local-6989586621684394526"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span id="local-6989586621684395970"><span id="local-6989586621684395971"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#patWithAllocations"><span class="hs-identifier hs-type">patWithAllocations</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-221"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395971"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395971"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684395970"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-222"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ChunkMap"><span class="hs-identifier hs-type">ChunkMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-224"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-225"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395971"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-226"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ExpHint"><span class="hs-identifier hs-type">ExpHint</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-227"></span><span>  </span><span class="annot"><a href="#local-6989586621684395971"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#LetDecMem"><span class="hs-identifier hs-type">LetDecMem</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-228"></span><span id="patWithAllocations"><span class="annot"><span class="annottext">patWithAllocations :: forall (m :: * -&gt; *) inner.
(MonadBuilder m, Mem (Rep m) inner) =&gt;
Space
-&gt; ChunkMap
-&gt; [VName]
-&gt; Exp (Rep m)
-&gt; [ExpHint]
-&gt; m (PatT LParamMem)
</span><a href="Futhark.Pass.ExplicitAllocations.html#patWithAllocations"><span class="hs-identifier hs-var hs-var">patWithAllocations</span></a></span></span><span> </span><span id="local-6989586621684394448"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394448"><span class="hs-identifier hs-var">def_space</span></a></span></span><span> </span><span id="local-6989586621684394447"><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394447"><span class="hs-identifier hs-var">chunkmap</span></a></span></span><span> </span><span id="local-6989586621684394446"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684394446"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span id="local-6989586621684394445"><span class="annot"><span class="annottext">Exp (Rep m)
</span><a href="#local-6989586621684394445"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684394444"><span class="annot"><span class="annottext">[ExpHint]
</span><a href="#local-6989586621684394444"><span class="hs-identifier hs-var">hints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-229"></span><span>  </span><span id="local-6989586621684394443"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684394443"><span class="hs-identifier hs-var">ts'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [ExtType] -&gt; [Type]
forall u. [VName] -&gt; [TypeBase ExtShape u] -&gt; [TypeBase Shape u]
</span><a href="Futhark.Construct.html#instantiateShapes%27"><span class="hs-identifier hs-var">instantiateShapes'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684394446"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">([ExtType] -&gt; [Type]) -&gt; m [ExtType] -&gt; m [Type]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Exp (Rep m) -&gt; m [ExtType]
forall rep (m :: * -&gt; *).
(HasScope rep m, TypedOp (Op rep)) =&gt;
Exp rep -&gt; m [ExtType]
</span><a href="Futhark.IR.Prop.TypeOf.html#expExtType"><span class="hs-identifier hs-var">expExtType</span></a></span><span> </span><span class="annot"><span class="annottext">Exp (Rep m)
</span><a href="#local-6989586621684394445"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-230"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684394439"><span class="annot"><span class="annottext">idents :: [Ident]
</span><a href="#local-6989586621684394439"><span class="hs-identifier hs-var hs-var">idents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Type -&gt; Ident) -&gt; [VName] -&gt; [Type] -&gt; [Ident]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Type -&gt; Ident
</span><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-var">Ident</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684394446"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684394443"><span class="hs-identifier hs-var">ts'</span></a></span><span>
</span><span id="line-231"></span><span>  </span><span id="local-6989586621684394436"><span class="annot"><span class="annottext">[ExpReturns]
</span><a href="#local-6989586621684394436"><span class="hs-identifier hs-var">rts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp (Rep m) -&gt; m [ExpReturns]
forall (m :: * -&gt; *) rep inner.
(Monad m, LocalScope rep m, Mem rep inner) =&gt;
Exp rep -&gt; m [ExpReturns]
</span><a href="Futhark.IR.Mem.html#expReturns"><span class="hs-identifier hs-var">expReturns</span></a></span><span> </span><span class="annot"><span class="annottext">Exp (Rep m)
</span><a href="#local-6989586621684394445"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-232"></span><span>  </span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; PatT LParamMem
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; PatT LParamMem)
-&gt; m [PatElemT LParamMem] -&gt; m (PatT LParamMem)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Space
-&gt; ChunkMap
-&gt; [Ident]
-&gt; [ExpReturns]
-&gt; [ExpHint]
-&gt; m [PatElemT LParamMem]
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ MemOp inner) =&gt;
Space
-&gt; ChunkMap
-&gt; [Ident]
-&gt; [ExpReturns]
-&gt; [ExpHint]
-&gt; m [PatElemT LParamMem]
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocsForPat"><span class="hs-identifier hs-var">allocsForPat</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394448"><span class="hs-identifier hs-var">def_space</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394447"><span class="hs-identifier hs-var">chunkmap</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394439"><span class="hs-identifier hs-var">idents</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpReturns]
</span><a href="#local-6989586621684394436"><span class="hs-identifier hs-var">rts</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpHint]
</span><a href="#local-6989586621684394444"><span class="hs-identifier hs-var">hints</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span id="local-6989586621684395847"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#mkMissingIdents"><span class="hs-identifier hs-type">mkMissingIdents</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395847"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Mem.html#ExpReturns"><span class="hs-identifier hs-type">ExpReturns</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684395847"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-235"></span><span id="mkMissingIdents"><span class="annot"><span class="annottext">mkMissingIdents :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
[Ident] -&gt; [ExpReturns] -&gt; m [Ident]
</span><a href="Futhark.Pass.ExplicitAllocations.html#mkMissingIdents"><span class="hs-identifier hs-var hs-var">mkMissingIdents</span></a></span></span><span> </span><span id="local-6989586621684394428"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394428"><span class="hs-identifier hs-var">idents</span></a></span></span><span> </span><span id="local-6989586621684394427"><span class="annot"><span class="annottext">[ExpReturns]
</span><a href="#local-6989586621684394427"><span class="hs-identifier hs-var">rts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-236"></span><span>  </span><span class="annot"><span class="annottext">[Ident] -&gt; [Ident]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([Ident] -&gt; [Ident]) -&gt; m [Ident] -&gt; m [Ident]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(ExpReturns -&gt; Maybe Ident -&gt; m Ident)
-&gt; [ExpReturns] -&gt; [Maybe Ident] -&gt; m [Ident]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">ExpReturns -&gt; Maybe Ident -&gt; m Ident
forall {f :: * -&gt; *} {d} {u} {ret}.
MonadFreshNames f =&gt;
MemInfo d u ret -&gt; Maybe Ident -&gt; f Ident
</span><a href="#local-6989586621684394424"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ExpReturns] -&gt; [ExpReturns]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[ExpReturns]
</span><a href="#local-6989586621684394427"><span class="hs-identifier hs-var">rts</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Ident -&gt; Maybe Ident) -&gt; [Ident] -&gt; [Maybe Ident]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; Maybe Ident
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ident] -&gt; [Ident]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394428"><span class="hs-identifier hs-var">idents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Maybe Ident] -&gt; [Maybe Ident] -&gt; [Maybe Ident]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Maybe Ident -&gt; [Maybe Ident]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">Maybe Ident
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-238"></span><span>    </span><span id="local-6989586621684394424"><span class="annot"><span class="annottext">f :: MemInfo d u ret -&gt; Maybe Ident -&gt; f Ident
</span><a href="#local-6989586621684394424"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="annottext">MemInfo d u ret
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684394417"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684394417"><span class="hs-identifier hs-var">ident</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ident -&gt; f Ident
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684394417"><span class="hs-identifier hs-var">ident</span></a></span><span>
</span><span id="line-239"></span><span>    </span><span class="annot"><a href="#local-6989586621684394424"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-type">MemMem</span></a></span><span> </span><span id="local-6989586621684394415"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394415"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Ident
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Type -&gt; f Ident
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
String -&gt; Type -&gt; m Ident
</span><a href="Futhark.MonadFreshNames.html#newIdent"><span class="hs-identifier hs-var">newIdent</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ext_mem&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; f Ident) -&gt; Type -&gt; f Ident
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; Type
forall shape u. Space -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-var">Mem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394415"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-240"></span><span>    </span><span class="annot"><a href="#local-6989586621684394424"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">MemInfo d u ret
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe Ident
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Type -&gt; f Ident
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
String -&gt; Type -&gt; m Ident
</span><a href="Futhark.MonadFreshNames.html#newIdent"><span class="hs-identifier hs-var">newIdent</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ext&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; f Ident) -&gt; Type -&gt; f Ident
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Type
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-241"></span><span>
</span><span id="line-242"></span><span id="local-6989586621684395865"><span id="local-6989586621684395866"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocsForPat"><span class="hs-identifier hs-type">allocsForPat</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395866"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395866"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemOp"><span class="hs-identifier hs-type">MemOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395865"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-244"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-245"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ChunkMap"><span class="hs-identifier hs-type">ChunkMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Mem.html#ExpReturns"><span class="hs-identifier hs-type">ExpReturns</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-248"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ExpHint"><span class="hs-identifier hs-type">ExpHint</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-249"></span><span>  </span><span class="annot"><a href="#local-6989586621684395866"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#PatElemT"><span class="hs-identifier hs-type">PatElemT</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#LetDecMem"><span class="hs-identifier hs-type">LetDecMem</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-250"></span><span id="allocsForPat"><span class="annot"><span class="annottext">allocsForPat :: forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ MemOp inner) =&gt;
Space
-&gt; ChunkMap
-&gt; [Ident]
-&gt; [ExpReturns]
-&gt; [ExpHint]
-&gt; m [PatElemT LParamMem]
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocsForPat"><span class="hs-identifier hs-var hs-var">allocsForPat</span></a></span></span><span> </span><span id="local-6989586621684394369"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394369"><span class="hs-identifier hs-var">def_space</span></a></span></span><span> </span><span id="local-6989586621684394368"><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394368"><span class="hs-identifier hs-var">chunkmap</span></a></span></span><span> </span><span id="local-6989586621684394367"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394367"><span class="hs-identifier hs-var">some_idents</span></a></span></span><span> </span><span id="local-6989586621684394366"><span class="annot"><span class="annottext">[ExpReturns]
</span><a href="#local-6989586621684394366"><span class="hs-identifier hs-var">rts</span></a></span></span><span> </span><span id="local-6989586621684394365"><span class="annot"><span class="annottext">[ExpHint]
</span><a href="#local-6989586621684394365"><span class="hs-identifier hs-var">hints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-251"></span><span>  </span><span id="local-6989586621684394364"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394364"><span class="hs-identifier hs-var">idents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; [ExpReturns] -&gt; m [Ident]
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
[Ident] -&gt; [ExpReturns] -&gt; m [Ident]
</span><a href="Futhark.Pass.ExplicitAllocations.html#mkMissingIdents"><span class="hs-identifier hs-var">mkMissingIdents</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394367"><span class="hs-identifier hs-var">some_idents</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpReturns]
</span><a href="#local-6989586621684394366"><span class="hs-identifier hs-var">rts</span></a></span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><span class="annottext">[(Ident, ExpReturns, ExpHint)]
-&gt; ((Ident, ExpReturns, ExpHint) -&gt; m (PatElemT LParamMem))
-&gt; m [PatElemT LParamMem]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ident]
-&gt; [ExpReturns] -&gt; [ExpHint] -&gt; [(Ident, ExpReturns, ExpHint)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394364"><span class="hs-identifier hs-var">idents</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpReturns]
</span><a href="#local-6989586621684394366"><span class="hs-identifier hs-var">rts</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpHint]
</span><a href="#local-6989586621684394365"><span class="hs-identifier hs-var">hints</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Ident, ExpReturns, ExpHint) -&gt; m (PatElemT LParamMem))
 -&gt; m [PatElemT LParamMem])
-&gt; ((Ident, ExpReturns, ExpHint) -&gt; m (PatElemT LParamMem))
-&gt; m [PatElemT LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684394361"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684394361"><span class="hs-identifier hs-var">ident</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684394360"><span class="annot"><span class="annottext">ExpReturns
</span><a href="#local-6989586621684394360"><span class="hs-identifier hs-var">rt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684394359"><span class="annot"><span class="annottext">ExpHint
</span><a href="#local-6989586621684394359"><span class="hs-identifier hs-var">hint</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-254"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684394358"><span class="annot"><span class="annottext">ident_shape :: Shape
</span><a href="#local-6989586621684394358"><span class="hs-identifier hs-var hs-var">ident_shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Shape
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Shape) -&gt; Type -&gt; Shape
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ident -&gt; Type
</span><a href="Futhark.IR.Syntax.Core.html#identType"><span class="hs-identifier hs-var hs-var">identType</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684394361"><span class="hs-identifier hs-var">ident</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">ExpReturns
</span><a href="#local-6989586621684394360"><span class="hs-identifier hs-var">rt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-256"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-type">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-257"></span><span>        </span><span id="local-6989586621684394354"><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684394354"><span class="hs-identifier hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Space -&gt; ChunkMap -&gt; Type -&gt; ExpHint -&gt; m LParamMem
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ MemOp inner) =&gt;
Space -&gt; ChunkMap -&gt; Type -&gt; ExpHint -&gt; m LParamMem
</span><a href="Futhark.Pass.ExplicitAllocations.html#summaryForBindage"><span class="hs-identifier hs-var">summaryForBindage</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394369"><span class="hs-identifier hs-var">def_space</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394368"><span class="hs-identifier hs-var">chunkmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ident -&gt; Type
</span><a href="Futhark.IR.Syntax.Core.html#identType"><span class="hs-identifier hs-var hs-var">identType</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684394361"><span class="hs-identifier hs-var">ident</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpHint
</span><a href="#local-6989586621684394359"><span class="hs-identifier hs-var">hint</span></a></span><span>
</span><span id="line-258"></span><span>        </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; m (PatElemT LParamMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT LParamMem -&gt; m (PatElemT LParamMem))
-&gt; PatElemT LParamMem -&gt; m (PatElemT LParamMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; LParamMem -&gt; PatElemT LParamMem
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684394361"><span class="hs-identifier hs-var">ident</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684394354"><span class="hs-identifier hs-var">summary</span></a></span><span>
</span><span id="line-259"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-type">MemMem</span></a></span><span> </span><span id="local-6989586621684394350"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394350"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-260"></span><span>        </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; m (PatElemT LParamMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT LParamMem -&gt; m (PatElemT LParamMem))
-&gt; PatElemT LParamMem -&gt; m (PatElemT LParamMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; LParamMem -&gt; PatElemT LParamMem
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684394361"><span class="hs-identifier hs-var">ident</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; PatElemT LParamMem)
-&gt; LParamMem -&gt; PatElemT LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; LParamMem
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394350"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-261"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684394348"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394348"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExtShape
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684394347"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684394347"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ReturnsInBlock"><span class="hs-identifier hs-type">ReturnsInBlock</span></a></span><span> </span><span id="local-6989586621684394345"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394345"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684394344"><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684394344"><span class="hs-identifier hs-var">extixfun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-262"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684394343"><span class="annot"><span class="annottext">ixfn :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684394343"><span class="hs-identifier hs-var hs-var">ixfn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; ExtIxFun -&gt; IxFun (TPrimExp Int64 VName)
forall {f :: * -&gt; *} {f :: * -&gt; *}.
(Functor f, Functor f) =&gt;
[Ident] -&gt; f (f (Ext VName)) -&gt; f (f VName)
</span><a href="#local-6989586621684394342"><span class="hs-identifier hs-var">instantiateExtIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394364"><span class="hs-identifier hs-var">idents</span></a></span><span> </span><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684394344"><span class="hs-identifier hs-var">extixfun</span></a></span><span>
</span><span id="line-263"></span><span>        </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; m (PatElemT LParamMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT LParamMem -&gt; m (PatElemT LParamMem))
-&gt; (MemBind -&gt; PatElemT LParamMem)
-&gt; MemBind
-&gt; m (PatElemT LParamMem)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; LParamMem -&gt; PatElemT LParamMem
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684394361"><span class="hs-identifier hs-var">ident</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; PatElemT LParamMem)
-&gt; (MemBind -&gt; LParamMem) -&gt; MemBind -&gt; PatElemT LParamMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; NoUniqueness -&gt; MemBind -&gt; LParamMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394348"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394358"><span class="hs-identifier hs-var">ident_shape</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684394347"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; m (PatElemT LParamMem))
-&gt; MemBind -&gt; m (PatElemT LParamMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394345"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684394343"><span class="hs-identifier hs-var">ixfn</span></a></span><span>
</span><span id="line-264"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684394340"><span class="annot"><span class="annottext">ExtShape
</span><a href="#local-6989586621684394340"><span class="hs-identifier hs-var">extshape</span></a></span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe MemReturn
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-265"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExtShape -&gt; Maybe [SubExp]
forall {b}. ShapeBase (Ext b) -&gt; Maybe [b]
</span><a href="#local-6989586621684394339"><span class="hs-identifier hs-var">knownShape</span></a></span><span> </span><span class="annot"><span class="annottext">ExtShape
</span><a href="#local-6989586621684394340"><span class="hs-identifier hs-var">extshape</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-266"></span><span>          </span><span id="local-6989586621684394338"><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684394338"><span class="hs-identifier hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Space -&gt; ChunkMap -&gt; Type -&gt; ExpHint -&gt; m LParamMem
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ MemOp inner) =&gt;
Space -&gt; ChunkMap -&gt; Type -&gt; ExpHint -&gt; m LParamMem
</span><a href="Futhark.Pass.ExplicitAllocations.html#summaryForBindage"><span class="hs-identifier hs-var">summaryForBindage</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394369"><span class="hs-identifier hs-var">def_space</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394368"><span class="hs-identifier hs-var">chunkmap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ident -&gt; Type
</span><a href="Futhark.IR.Syntax.Core.html#identType"><span class="hs-identifier hs-var hs-var">identType</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684394361"><span class="hs-identifier hs-var">ident</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpHint
</span><a href="#local-6989586621684394359"><span class="hs-identifier hs-var">hint</span></a></span><span>
</span><span id="line-267"></span><span>          </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; m (PatElemT LParamMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT LParamMem -&gt; m (PatElemT LParamMem))
-&gt; PatElemT LParamMem -&gt; m (PatElemT LParamMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; LParamMem -&gt; PatElemT LParamMem
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684394361"><span class="hs-identifier hs-var">ident</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684394338"><span class="hs-identifier hs-var">summary</span></a></span><span>
</span><span id="line-268"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684394337"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394337"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExtShape
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684394336"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684394336"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ReturnsNewBlock"><span class="hs-identifier hs-type">ReturnsNewBlock</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684394334"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684394334"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684394333"><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684394333"><span class="hs-identifier hs-var">extixfn</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-269"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684394332"><span class="annot"><span class="annottext">ixfn :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684394332"><span class="hs-identifier hs-var hs-var">ixfn</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; ExtIxFun -&gt; IxFun (TPrimExp Int64 VName)
forall {f :: * -&gt; *} {f :: * -&gt; *}.
(Functor f, Functor f) =&gt;
[Ident] -&gt; f (f (Ext VName)) -&gt; f (f VName)
</span><a href="#local-6989586621684394342"><span class="hs-identifier hs-var">instantiateExtIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394364"><span class="hs-identifier hs-var">idents</span></a></span><span> </span><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684394333"><span class="hs-identifier hs-var">extixfn</span></a></span><span>
</span><span id="line-270"></span><span>        </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; m (PatElemT LParamMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT LParamMem -&gt; m (PatElemT LParamMem))
-&gt; (MemBind -&gt; PatElemT LParamMem)
-&gt; MemBind
-&gt; m (PatElemT LParamMem)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; LParamMem -&gt; PatElemT LParamMem
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684394361"><span class="hs-identifier hs-var">ident</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; PatElemT LParamMem)
-&gt; (MemBind -&gt; LParamMem) -&gt; MemBind -&gt; PatElemT LParamMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; NoUniqueness -&gt; MemBind -&gt; LParamMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394337"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394358"><span class="hs-identifier hs-var">ident_shape</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684394336"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; m (PatElemT LParamMem))
-&gt; MemBind -&gt; m (PatElemT LParamMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-271"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ident] -&gt; Int -&gt; VName
forall {a}. (Integral a, Show a) =&gt; [Ident] -&gt; a -&gt; VName
</span><a href="#local-6989586621684394331"><span class="hs-identifier hs-var">getIdent</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394364"><span class="hs-identifier hs-var">idents</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684394334"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684394332"><span class="hs-identifier hs-var">ixfn</span></a></span><span>
</span><span id="line-272"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-type">MemAcc</span></a></span><span> </span><span id="local-6989586621684394329"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394329"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684394328"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394328"><span class="hs-identifier hs-var">ispace</span></a></span></span><span> </span><span id="local-6989586621684394327"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684394327"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684394326"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684394326"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-273"></span><span>        </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; m (PatElemT LParamMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT LParamMem -&gt; m (PatElemT LParamMem))
-&gt; PatElemT LParamMem -&gt; m (PatElemT LParamMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; LParamMem -&gt; PatElemT LParamMem
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684394361"><span class="hs-identifier hs-var">ident</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; PatElemT LParamMem)
-&gt; LParamMem -&gt; PatElemT LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Shape -&gt; [Type] -&gt; NoUniqueness -&gt; LParamMem
forall d u ret. VName -&gt; Shape -&gt; [Type] -&gt; u -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-var">MemAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394329"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394328"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684394327"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684394326"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-274"></span><span>      </span><span class="annot"><span class="annottext">ExpReturns
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m (PatElemT LParamMem)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Impossible case reached in allocsForPat!&quot;</span></span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-276"></span><span>    </span><span id="local-6989586621684394339"><span class="annot"><span class="annottext">knownShape :: ShapeBase (Ext b) -&gt; Maybe [b]
</span><a href="#local-6989586621684394339"><span class="hs-identifier hs-var hs-var">knownShape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ext b -&gt; Maybe b) -&gt; [Ext b] -&gt; Maybe [b]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Ext b -&gt; Maybe b
forall {a}. Ext a -&gt; Maybe a
</span><a href="#local-6989586621684394320"><span class="hs-identifier hs-var">known</span></a></span><span> </span><span class="annot"><span class="annottext">([Ext b] -&gt; Maybe [b])
-&gt; (ShapeBase (Ext b) -&gt; [Ext b]) -&gt; ShapeBase (Ext b) -&gt; Maybe [b]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ShapeBase (Ext b) -&gt; [Ext b]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span>
</span><span id="line-277"></span><span>    </span><span id="local-6989586621684394320"><span class="annot"><span class="annottext">known :: Ext a -&gt; Maybe a
</span><a href="#local-6989586621684394320"><span class="hs-identifier hs-var hs-var">known</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-type">Free</span></a></span><span> </span><span id="local-6989586621684394317"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684394317"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684394317"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-278"></span><span>    </span><span class="annot"><a href="#local-6989586621684394320"><span class="hs-identifier hs-var">known</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-279"></span><span>
</span><span id="line-280"></span><span>    </span><span id="local-6989586621684394331"><span class="annot"><span class="annottext">getIdent :: [Ident] -&gt; a -&gt; VName
</span><a href="#local-6989586621684394331"><span class="hs-identifier hs-var hs-var">getIdent</span></a></span></span><span> </span><span id="local-6989586621684394297"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394297"><span class="hs-identifier hs-var">idents</span></a></span></span><span> </span><span id="local-6989586621684394296"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684394296"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-281"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">a -&gt; [Ident] -&gt; Maybe Ident
forall int a. Integral int =&gt; int -&gt; [a] -&gt; Maybe a
</span><a href="Futhark.Util.html#maybeNth"><span class="hs-identifier hs-var">maybeNth</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684394296"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394297"><span class="hs-identifier hs-var">idents</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-282"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684394295"><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684394295"><span class="hs-identifier hs-var">ident</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Ident -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">Ident
</span><a href="#local-6989586621684394295"><span class="hs-identifier hs-var">ident</span></a></span><span>
</span><span id="line-283"></span><span>        </span><span class="annot"><span class="annottext">Maybe Ident
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-284"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; VName
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; VName) -&gt; String -&gt; VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;getIdent: Ext &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684394296"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; but pattern has &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Ident] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394297"><span class="hs-identifier hs-var">idents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; elements: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394297"><span class="hs-identifier hs-var">idents</span></a></span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span>    </span><span id="local-6989586621684394342"><span class="annot"><span class="annottext">instantiateExtIxFun :: [Ident] -&gt; f (f (Ext VName)) -&gt; f (f VName)
</span><a href="#local-6989586621684394342"><span class="hs-identifier hs-var hs-var">instantiateExtIxFun</span></a></span></span><span> </span><span id="local-6989586621684394285"><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394285"><span class="hs-identifier hs-var">idents</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(f (Ext VName) -&gt; f VName) -&gt; f (f (Ext VName)) -&gt; f (f VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">((f (Ext VName) -&gt; f VName) -&gt; f (f (Ext VName)) -&gt; f (f VName))
-&gt; (f (Ext VName) -&gt; f VName) -&gt; f (f (Ext VName)) -&gt; f (f VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Ext VName -&gt; VName) -&gt; f (Ext VName) -&gt; f VName
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Ext VName -&gt; VName
</span><a href="#local-6989586621684394284"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-287"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-288"></span><span>        </span><span id="local-6989586621684394284"><span class="annot"><span class="annottext">inst :: Ext VName -&gt; VName
</span><a href="#local-6989586621684394284"><span class="hs-identifier hs-var hs-var">inst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-type">Free</span></a></span><span> </span><span id="local-6989586621684394283"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394283"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394283"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-289"></span><span>        </span><span class="annot"><a href="#local-6989586621684394284"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span id="local-6989586621684394282"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684394282"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; Int -&gt; VName
forall {a}. (Integral a, Show a) =&gt; [Ident] -&gt; a -&gt; VName
</span><a href="#local-6989586621684394331"><span class="hs-identifier hs-var">getIdent</span></a></span><span> </span><span class="annot"><span class="annottext">[Ident]
</span><a href="#local-6989586621684394285"><span class="hs-identifier hs-var">idents</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684394282"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-290"></span><span>
</span><span id="line-291"></span><span id="local-6989586621684395785"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#instantiateIxFun"><span class="hs-identifier hs-type">instantiateIxFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621684395785"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#ExtIxFun"><span class="hs-identifier hs-type">ExtIxFun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684395785"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span></span><span>
</span><span id="line-292"></span><span id="instantiateIxFun"><span class="annot"><span class="annottext">instantiateIxFun :: forall (m :: * -&gt; *).
Monad m =&gt;
ExtIxFun -&gt; m (IxFun (TPrimExp Int64 VName))
</span><a href="Futhark.Pass.ExplicitAllocations.html#instantiateIxFun"><span class="hs-identifier hs-var hs-var">instantiateIxFun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 (Ext VName) -&gt; m (TPrimExp Int64 VName))
-&gt; ExtIxFun -&gt; m (IxFun (TPrimExp Int64 VName))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">((TPrimExp Int64 (Ext VName) -&gt; m (TPrimExp Int64 VName))
 -&gt; ExtIxFun -&gt; m (IxFun (TPrimExp Int64 VName)))
-&gt; (TPrimExp Int64 (Ext VName) -&gt; m (TPrimExp Int64 VName))
-&gt; ExtIxFun
-&gt; m (IxFun (TPrimExp Int64 VName))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Ext VName -&gt; m VName)
-&gt; TPrimExp Int64 (Ext VName) -&gt; m (TPrimExp Int64 VName)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">Ext VName -&gt; m VName
forall {m :: * -&gt; *} {a}. Monad m =&gt; Ext a -&gt; m a
</span><a href="#local-6989586621684394268"><span class="hs-identifier hs-var">inst</span></a></span><span>
</span><span id="line-293"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-294"></span><span>    </span><span id="local-6989586621684394268"><span class="annot"><span class="annottext">inst :: Ext a -&gt; m a
</span><a href="#local-6989586621684394268"><span class="hs-identifier hs-var hs-var">inst</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; m a
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;instantiateIxFun: not yet&quot;</span></span><span>
</span><span id="line-295"></span><span>    </span><span class="annot"><a href="#local-6989586621684394268"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-type">Free</span></a></span><span> </span><span id="local-6989586621684394263"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684394263"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; m a
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684394263"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span id="local-6989586621684395814"><span id="local-6989586621684395815"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#summaryForBindage"><span class="hs-identifier hs-type">summaryForBindage</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395815"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395815"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemOp"><span class="hs-identifier hs-type">MemOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395814"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-299"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-300"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ChunkMap"><span class="hs-identifier hs-type">ChunkMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-301"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-302"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ExpHint"><span class="hs-identifier hs-type">ExpHint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-303"></span><span>  </span><span class="annot"><a href="#local-6989586621684395815"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemBound"><span class="hs-identifier hs-type">MemBound</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-type">NoUniqueness</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-304"></span><span id="summaryForBindage"><span class="annot"><span class="annottext">summaryForBindage :: forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ MemOp inner) =&gt;
Space -&gt; ChunkMap -&gt; Type -&gt; ExpHint -&gt; m LParamMem
</span><a href="Futhark.Pass.ExplicitAllocations.html#summaryForBindage"><span class="hs-identifier hs-var hs-var">summaryForBindage</span></a></span></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684394228"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394228"><span class="hs-identifier hs-var">bt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpHint
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-305"></span><span>  </span><span class="annot"><span class="annottext">LParamMem -&gt; m LParamMem
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; m LParamMem) -&gt; LParamMem -&gt; m LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; LParamMem
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394228"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-306"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#summaryForBindage"><span class="hs-identifier hs-var">summaryForBindage</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684394227"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394227"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpHint
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-307"></span><span>  </span><span class="annot"><span class="annottext">LParamMem -&gt; m LParamMem
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; m LParamMem) -&gt; LParamMem -&gt; m LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; LParamMem
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394227"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-308"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#summaryForBindage"><span class="hs-identifier hs-var">summaryForBindage</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span id="local-6989586621684394225"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394225"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684394224"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394224"><span class="hs-identifier hs-var">ispace</span></a></span></span><span> </span><span id="local-6989586621684394223"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684394223"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684394222"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684394222"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpHint
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><span class="annottext">LParamMem -&gt; m LParamMem
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; m LParamMem) -&gt; LParamMem -&gt; m LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Shape -&gt; [Type] -&gt; NoUniqueness -&gt; LParamMem
forall d u ret. VName -&gt; Shape -&gt; [Type] -&gt; u -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-var">MemAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394225"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394224"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684394223"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684394222"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-310"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#summaryForBindage"><span class="hs-identifier hs-var">summaryForBindage</span></a></span><span> </span><span id="local-6989586621684394221"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394221"><span class="hs-identifier hs-var">def_space</span></a></span></span><span> </span><span id="local-6989586621684394220"><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394220"><span class="hs-identifier hs-var">chunkmap</span></a></span></span><span> </span><span id="local-6989586621684394219"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621684394219"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684394217"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394217"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684394216"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394216"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684394215"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684394215"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpHint
</span><a href="Futhark.Pass.ExplicitAllocations.html#NoHint"><span class="hs-identifier hs-var">NoHint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-311"></span><span>  </span><span id="local-6989586621684394213"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394213"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChunkMap -&gt; Type -&gt; Space -&gt; m VName
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ MemOp inner) =&gt;
ChunkMap -&gt; Type -&gt; Space -&gt; m VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocForArray%27"><span class="hs-identifier hs-var">allocForArray'</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684394220"><span class="hs-identifier hs-var">chunkmap</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394219"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394221"><span class="hs-identifier hs-var">def_space</span></a></span><span>
</span><span id="line-312"></span><span>  </span><span class="annot"><span class="annottext">LParamMem -&gt; m LParamMem
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; m LParamMem) -&gt; LParamMem -&gt; m LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; NoUniqueness -&gt; VName -&gt; Type -&gt; LParamMem
forall u. PrimType -&gt; Shape -&gt; u -&gt; VName -&gt; Type -&gt; MemBound u
</span><a href="Futhark.Pass.ExplicitAllocations.html#directIxFun"><span class="hs-identifier hs-var">directIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394217"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394216"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684394215"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394213"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394219"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-313"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#summaryForBindage"><span class="hs-identifier hs-var">summaryForBindage</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684394211"><span class="annot"><span class="annottext">t :: Type
</span><a href="#local-6989586621684394211"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684394210"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394210"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Hint"><span class="hs-identifier hs-type">Hint</span></a></span><span> </span><span id="local-6989586621684394208"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684394208"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span> </span><span id="local-6989586621684394207"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394207"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-314"></span><span>  </span><span id="local-6989586621684394206"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684394206"><span class="hs-identifier hs-var">bytes</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-315"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; ExpT (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bytes&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT (Rep m) -&gt; m SubExp)
-&gt; (TPrimExp Int64 VName -&gt; m (ExpT (Rep m)))
-&gt; TPrimExp Int64 VName
-&gt; m SubExp
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; m (ExpT (Rep m))
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; m (ExpT (Rep m)))
-&gt; (TPrimExp Int64 VName -&gt; PrimExp VName)
-&gt; TPrimExp Int64 VName
-&gt; m (ExpT (Rep m))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; m SubExp)
-&gt; TPrimExp Int64 VName -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-316"></span><span>      </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span>
</span><span id="line-317"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName) -&gt; [TPrimExp Int64 VName]
forall num. IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#base"><span class="hs-identifier hs-var hs-var">IxFun.base</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684394208"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-318"></span><span>          </span><span class="annot"><span class="annottext">Int64 -&gt; TPrimExp Int64 VName
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; Int64
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394210"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">)</span><span>
</span><span id="line-319"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-320"></span><span>  </span><span id="local-6989586621684394204"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394204"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ExpT (Rep m) -&gt; m VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mem&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT (Rep m) -&gt; m VName) -&gt; ExpT (Rep m) -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op (Rep m) -&gt; ExpT (Rep m)
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op (Rep m) -&gt; ExpT (Rep m)) -&gt; Op (Rep m) -&gt; ExpT (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Space -&gt; MemOp inner
forall inner. SubExp -&gt; Space -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-var">Alloc</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684394206"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394207"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-321"></span><span>  </span><span class="annot"><span class="annottext">LParamMem -&gt; m LParamMem
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; m LParamMem) -&gt; LParamMem -&gt; m LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; NoUniqueness -&gt; MemBind -&gt; LParamMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394210"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Shape
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394211"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-var">NoUniqueness</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; LParamMem) -&gt; MemBind -&gt; LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394204"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684394208"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-322"></span><span>
</span><span id="line-323"></span><span id="local-6989586621684395768"><span id="local-6989586621684395769"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#lookupMemSpace"><span class="hs-identifier hs-type">lookupMemSpace</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395769"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395768"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621684395768"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684395768"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span></span></span><span>
</span><span id="line-324"></span><span id="lookupMemSpace"><span class="annot"><span class="annottext">lookupMemSpace :: forall rep (m :: * -&gt; *).
(HasScope rep m, Monad m) =&gt;
VName -&gt; m Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#lookupMemSpace"><span class="hs-identifier hs-var hs-var">lookupMemSpace</span></a></span></span><span> </span><span id="local-6989586621684394193"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394193"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-325"></span><span>  </span><span id="local-6989586621684394192"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394192"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394193"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-326"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394192"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-327"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684394190"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394190"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Space -&gt; m Space
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394190"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-328"></span><span>    </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; m Space
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m Space) -&gt; String -&gt; m Space
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;lookupMemSpace: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394193"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; is not a memory block.&quot;</span></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span id="local-6989586621684395775"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#directIxFun"><span class="hs-identifier hs-type">directIxFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684395775"><span class="hs-identifier hs-type">u</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemBound"><span class="hs-identifier hs-type">MemBound</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395775"><span class="hs-identifier hs-type">u</span></a></span></span><span>
</span><span id="line-331"></span><span id="directIxFun"><span class="annot"><span class="annottext">directIxFun :: forall u. PrimType -&gt; Shape -&gt; u -&gt; VName -&gt; Type -&gt; MemBound u
</span><a href="Futhark.Pass.ExplicitAllocations.html#directIxFun"><span class="hs-identifier hs-var hs-var">directIxFun</span></a></span></span><span> </span><span id="local-6989586621684394188"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394188"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span id="local-6989586621684394187"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394187"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684394186"><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684394186"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621684394185"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394185"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684394184"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394184"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-332"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684394183"><span class="annot"><span class="annottext">ixf :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684394183"><span class="hs-identifier hs-var hs-var">ixf</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; IxFun (TPrimExp Int64 VName)
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; IxFun (TPrimExp Int64 VName))
-&gt; [TPrimExp Int64 VName] -&gt; IxFun (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TPrimExp Int64 VName])
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684394184"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-333"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; u -&gt; MemBind -&gt; MemInfo SubExp u MemBind
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394188"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394187"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684394186"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; MemInfo SubExp u MemBind)
-&gt; MemBind -&gt; MemInfo SubExp u MemBind
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394185"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684394183"><span class="hs-identifier hs-var">ixf</span></a></span><span>
</span><span id="line-334"></span><span>
</span><span id="line-335"></span><span id="local-6989586621684395759"><span id="local-6989586621684395761"><span id="local-6989586621684395762"><span id="local-6989586621684395763"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInFParams"><span class="hs-identifier hs-type">allocInFParams</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-336"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395763"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395762"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395761"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-337"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395763"><span class="hs-identifier hs-type">fromrep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-338"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395762"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395763"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395762"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395759"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-339"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395763"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395762"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395759"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-340"></span><span id="allocInFParams"><span class="annot"><span class="annottext">allocInFParams :: forall fromrep torep inner a.
Allocable fromrep torep inner =&gt;
[(FParam fromrep, Space)]
-&gt; ([FParam torep] -&gt; AllocM fromrep torep a)
-&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInFParams"><span class="hs-identifier hs-var hs-var">allocInFParams</span></a></span></span><span> </span><span id="local-6989586621684394089"><span class="annot"><span class="annottext">[(FParam fromrep, Space)]
</span><a href="#local-6989586621684394089"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684394088"><span class="annot"><span class="annottext">[FParam torep] -&gt; AllocM fromrep torep a
</span><a href="#local-6989586621684394088"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-341"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684394087"><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684394087"><span class="hs-identifier hs-var">valparams</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684394086"><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684394086"><span class="hs-identifier hs-var">ctxparams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684394085"><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684394085"><span class="hs-identifier hs-var">memparams</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-342"></span><span>    </span><span class="annot"><span class="annottext">WriterT
  ([Param FParamMem], [Param FParamMem])
  (AllocM fromrep torep)
  [Param FParamMem]
-&gt; AllocM
     fromrep
     torep
     ([Param FParamMem], ([Param FParamMem], [Param FParamMem]))
forall w (m :: * -&gt; *) a. WriterT w m a -&gt; m (a, w)
</span><span class="hs-identifier hs-var hs-var">runWriterT</span></span><span> </span><span class="annot"><span class="annottext">(WriterT
   ([Param FParamMem], [Param FParamMem])
   (AllocM fromrep torep)
   [Param FParamMem]
 -&gt; AllocM
      fromrep
      torep
      ([Param FParamMem], ([Param FParamMem], [Param FParamMem])))
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     [Param FParamMem]
-&gt; AllocM
     fromrep
     torep
     ([Param FParamMem], ([Param FParamMem], [Param FParamMem]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((FParam fromrep, Space)
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      (Param FParamMem))
-&gt; [(FParam fromrep, Space)]
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     [Param FParamMem]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(FParam fromrep
 -&gt; Space
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      (Param FParamMem))
-&gt; (FParam fromrep, Space)
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem)
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">FParam fromrep
-&gt; Space
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
FParam fromrep
-&gt; Space
-&gt; WriterT
     ([FParam torep], [FParam torep])
     (AllocM fromrep torep)
     (FParam torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInFParam"><span class="hs-identifier hs-var">allocInFParam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(FParam fromrep, Space)]
</span><a href="#local-6989586621684394089"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-343"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684394081"><span class="annot"><span class="annottext">params' :: [Param FParamMem]
</span><a href="#local-6989586621684394081"><span class="hs-identifier hs-var hs-var">params'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684394086"><span class="hs-identifier hs-var">ctxparams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; [Param FParamMem] -&gt; [Param FParamMem]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684394085"><span class="hs-identifier hs-var">memparams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; [Param FParamMem] -&gt; [Param FParamMem]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684394087"><span class="hs-identifier hs-var">valparams</span></a></span><span>
</span><span id="line-344"></span><span>      </span><span id="local-6989586621684394080"><span class="annot"><span class="annottext">summary :: Scope torep
</span><a href="#local-6989586621684394080"><span class="hs-identifier hs-var hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; Scope torep
forall rep dec. (FParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfFParams"><span class="hs-identifier hs-var">scopeOfFParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684394081"><span class="hs-identifier hs-var">params'</span></a></span><span>
</span><span id="line-345"></span><span>  </span><span class="annot"><span class="annottext">Scope torep -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope torep
</span><a href="#local-6989586621684394080"><span class="hs-identifier hs-var">summary</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep a -&gt; AllocM fromrep torep a)
-&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[FParam torep] -&gt; AllocM fromrep torep a
</span><a href="#local-6989586621684394088"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">[FParam torep]
[Param FParamMem]
</span><a href="#local-6989586621684394081"><span class="hs-identifier hs-var">params'</span></a></span><span>
</span><span id="line-346"></span><span>
</span><span id="line-347"></span><span id="local-6989586621684395739"><span id="local-6989586621684395740"><span id="local-6989586621684395741"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInFParam"><span class="hs-identifier hs-type">allocInFParam</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395741"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395740"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395739"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-349"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395741"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-350"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-351"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">WriterT</span></span><span>
</span><span id="line-352"></span><span>    </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395740"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395740"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-353"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395741"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395740"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-354"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395740"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-355"></span><span id="allocInFParam"><span class="annot"><span class="annottext">allocInFParam :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
FParam fromrep
-&gt; Space
-&gt; WriterT
     ([FParam torep], [FParam torep])
     (AllocM fromrep torep)
     (FParam torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInFParam"><span class="hs-identifier hs-var hs-var">allocInFParam</span></a></span></span><span> </span><span id="local-6989586621684394042"><span class="annot"><span class="annottext">FParam fromrep
</span><a href="#local-6989586621684394042"><span class="hs-identifier hs-var">param</span></a></span></span><span> </span><span id="local-6989586621684394041"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394041"><span class="hs-identifier hs-var">pspace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-356"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Param DeclType -&gt; DeclType
forall dec. DeclTyped dec =&gt; Param dec -&gt; DeclType
</span><a href="Futhark.IR.Prop.Patterns.html#paramDeclType"><span class="hs-identifier hs-var">paramDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">Param DeclType
FParam fromrep
</span><a href="#local-6989586621684394042"><span class="hs-identifier hs-var">param</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-357"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684394039"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394039"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684394038"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394038"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684394037"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684394037"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-358"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684394036"><span class="annot"><span class="annottext">memname :: String
</span><a href="#local-6989586621684394036"><span class="hs-identifier hs-var hs-var">memname</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param DeclType -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param DeclType
FParam fromrep
</span><a href="#local-6989586621684394042"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_mem&quot;</span></span><span>
</span><span id="line-359"></span><span>          </span><span id="local-6989586621684394033"><span class="annot"><span class="annottext">ixfun :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684394033"><span class="hs-identifier hs-var hs-var">ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; IxFun (TPrimExp Int64 VName)
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; IxFun (TPrimExp Int64 VName))
-&gt; [TPrimExp Int64 VName] -&gt; IxFun (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TPrimExp Int64 VName])
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394038"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-360"></span><span>      </span><span id="local-6989586621684394032"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394032"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep VName
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem]) (AllocM fromrep torep) VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep VName
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      VName)
-&gt; AllocM fromrep torep VName
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem]) (AllocM fromrep torep) VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; AllocM fromrep torep VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684394036"><span class="hs-identifier hs-var">memname</span></a></span><span>
</span><span id="line-361"></span><span>      </span><span class="annot"><span class="annottext">([Param FParamMem], [Param FParamMem])
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem]) (AllocM fromrep torep) ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Attrs -&gt; VName -&gt; FParamMem -&gt; Param FParamMem
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param DeclType -&gt; Attrs
forall dec. Param dec -&gt; Attrs
</span><a href="Futhark.IR.Syntax.Core.html#paramAttrs"><span class="hs-identifier hs-var hs-var">paramAttrs</span></a></span><span> </span><span class="annot"><span class="annottext">Param DeclType
FParam fromrep
</span><a href="#local-6989586621684394042"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394032"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">(FParamMem -&gt; Param FParamMem) -&gt; FParamMem -&gt; Param FParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; FParamMem
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394041"><span class="hs-identifier hs-var">pspace</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span>      </span><span class="annot"><span class="annottext">Param FParamMem
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Param DeclType
FParam fromrep
</span><a href="#local-6989586621684394042"><span class="hs-identifier hs-var">param</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: FParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; Uniqueness -&gt; MemBind -&gt; FParamMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394039"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394038"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684394037"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; FParamMem) -&gt; MemBind -&gt; FParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394032"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684394033"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-363"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684394025"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394025"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-364"></span><span>      </span><span class="annot"><span class="annottext">Param FParamMem
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Param DeclType
FParam fromrep
</span><a href="#local-6989586621684394042"><span class="hs-identifier hs-var">param</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: FParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; FParamMem
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684394025"><span class="hs-identifier hs-var">pt</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-365"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684394024"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394024"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-366"></span><span>      </span><span class="annot"><span class="annottext">Param FParamMem
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Param DeclType
FParam fromrep
</span><a href="#local-6989586621684394042"><span class="hs-identifier hs-var">param</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: FParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space -&gt; FParamMem
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684394024"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-367"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span id="local-6989586621684394023"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394023"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684394022"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394022"><span class="hs-identifier hs-var">ispace</span></a></span></span><span> </span><span id="local-6989586621684394021"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684394021"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684394020"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684394020"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-368"></span><span>      </span><span class="annot"><span class="annottext">Param FParamMem
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Param DeclType
FParam fromrep
</span><a href="#local-6989586621684394042"><span class="hs-identifier hs-var">param</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: FParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Shape -&gt; [Type] -&gt; Uniqueness -&gt; FParamMem
forall d u ret. VName -&gt; Shape -&gt; [Type] -&gt; u -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-var">MemAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684394023"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684394022"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684394021"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684394020"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-369"></span><span>
</span><span id="line-370"></span><span id="local-6989586621684395712"><span id="local-6989586621684395713"><span id="local-6989586621684395714"><span id="local-6989586621684395715"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInMergeParams"><span class="hs-identifier hs-type">allocInMergeParams</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-371"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395715"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395714"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395713"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-372"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395715"><span class="hs-identifier hs-type">fromrep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-373"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395714"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-374"></span><span>    </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395715"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395714"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-375"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395715"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395714"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395712"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-376"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-377"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395715"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395714"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395712"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-378"></span><span id="allocInMergeParams"><span class="annot"><span class="annottext">allocInMergeParams :: forall fromrep torep inner a.
Allocable fromrep torep inner =&gt;
[(FParam fromrep, SubExp)]
-&gt; ([(FParam torep, SubExp)]
    -&gt; ([SubExp] -&gt; AllocM fromrep torep ([SubExp], [SubExp]))
    -&gt; AllocM fromrep torep a)
-&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInMergeParams"><span class="hs-identifier hs-var hs-var">allocInMergeParams</span></a></span></span><span> </span><span id="local-6989586621684393911"><span class="annot"><span class="annottext">[(FParam fromrep, SubExp)]
</span><a href="#local-6989586621684393911"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684393910"><span class="annot"><span class="annottext">[(FParam torep, SubExp)]
-&gt; ([SubExp] -&gt; AllocM fromrep torep ([SubExp], [SubExp]))
-&gt; AllocM fromrep torep a
</span><a href="#local-6989586621684393910"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-379"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684393909"><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684393909"><span class="hs-identifier hs-var">valparams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393908"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393908"><span class="hs-identifier hs-var">valargs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393907"><span class="annot"><span class="annottext">[SubExp
 -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp]
</span><a href="#local-6989586621684393907"><span class="hs-identifier hs-var">handle_loop_subexps</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684393906"><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684393906"><span class="hs-identifier hs-var">ctx_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393905"><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684393905"><span class="hs-identifier hs-var">mem_params</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-380"></span><span>    </span><span class="annot"><span class="annottext">WriterT
  ([Param FParamMem], [Param FParamMem])
  (AllocM fromrep torep)
  ([Param FParamMem], [SubExp],
   [SubExp
    -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp])
-&gt; AllocM
     fromrep
     torep
     (([Param FParamMem], [SubExp],
       [SubExp
        -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp]),
      ([Param FParamMem], [Param FParamMem]))
forall w (m :: * -&gt; *) a. WriterT w m a -&gt; m (a, w)
</span><span class="hs-identifier hs-var hs-var">runWriterT</span></span><span> </span><span class="annot"><span class="annottext">(WriterT
   ([Param FParamMem], [Param FParamMem])
   (AllocM fromrep torep)
   ([Param FParamMem], [SubExp],
    [SubExp
     -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp])
 -&gt; AllocM
      fromrep
      torep
      (([Param FParamMem], [SubExp],
        [SubExp
         -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp]),
       ([Param FParamMem], [Param FParamMem])))
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     ([Param FParamMem], [SubExp],
      [SubExp
       -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp])
-&gt; AllocM
     fromrep
     torep
     (([Param FParamMem], [SubExp],
       [SubExp
        -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp]),
      ([Param FParamMem], [Param FParamMem]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Param FParamMem, SubExp,
  SubExp
  -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)]
-&gt; ([Param FParamMem], [SubExp],
    [SubExp
     -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">([(Param FParamMem, SubExp,
   SubExp
   -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)]
 -&gt; ([Param FParamMem], [SubExp],
     [SubExp
      -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp]))
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     [(Param FParamMem, SubExp,
       SubExp
       -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)]
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     ([Param FParamMem], [SubExp],
      [SubExp
       -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((Param DeclType, SubExp)
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      (Param FParamMem, SubExp,
       SubExp
       -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp))
-&gt; [(Param DeclType, SubExp)]
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     [(Param FParamMem, SubExp,
       SubExp
       -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Param DeclType, SubExp)
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem, SubExp,
      SubExp
      -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
(Param DeclType, SubExp)
-&gt; WriterT
     ([FParam torep], [FParam torep])
     (AllocM fromrep torep)
     (FParam torep, SubExp,
      SubExp
      -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
</span><a href="#local-6989586621684393903"><span class="hs-identifier hs-var">allocInMergeParam</span></a></span><span> </span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
[(FParam fromrep, SubExp)]
</span><a href="#local-6989586621684393911"><span class="hs-identifier hs-var">merge</span></a></span><span>
</span><span id="line-381"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684393902"><span class="annot"><span class="annottext">mergeparams' :: [Param FParamMem]
</span><a href="#local-6989586621684393902"><span class="hs-identifier hs-var hs-var">mergeparams'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684393906"><span class="hs-identifier hs-var">ctx_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; [Param FParamMem] -&gt; [Param FParamMem]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684393905"><span class="hs-identifier hs-var">mem_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; [Param FParamMem] -&gt; [Param FParamMem]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684393909"><span class="hs-identifier hs-var">valparams</span></a></span><span>
</span><span id="line-382"></span><span>      </span><span id="local-6989586621684393901"><span class="annot"><span class="annottext">summary :: Scope torep
</span><a href="#local-6989586621684393901"><span class="hs-identifier hs-var hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; Scope torep
forall rep dec. (FParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfFParams"><span class="hs-identifier hs-var">scopeOfFParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684393902"><span class="hs-identifier hs-var">mergeparams'</span></a></span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span>      </span><span id="local-6989586621684393900"><span class="annot"><span class="annottext">mk_loop_res :: [SubExp] -&gt; AllocM fromrep torep ([SubExp], [SubExp])
</span><a href="#local-6989586621684393900"><span class="hs-identifier hs-var hs-var">mk_loop_res</span></a></span></span><span> </span><span id="local-6989586621684393899"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393899"><span class="hs-identifier hs-var">ses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-385"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684393898"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393898"><span class="hs-identifier hs-var">ses'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684393897"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393897"><span class="hs-identifier hs-var">ctxargs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393896"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393896"><span class="hs-identifier hs-var">memargs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-386"></span><span>          </span><span class="annot"><span class="annottext">WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) [SubExp]
-&gt; AllocM fromrep torep ([SubExp], ([SubExp], [SubExp]))
forall w (m :: * -&gt; *) a. WriterT w m a -&gt; m (a, w)
</span><span class="hs-identifier hs-var hs-var">runWriterT</span></span><span> </span><span class="annot"><span class="annottext">(WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) [SubExp]
 -&gt; AllocM fromrep torep ([SubExp], ([SubExp], [SubExp])))
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) [SubExp]
-&gt; AllocM fromrep torep ([SubExp], ([SubExp], [SubExp]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((SubExp
  -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
 -&gt; SubExp
 -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
-&gt; [SubExp
    -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp]
-&gt; [SubExp]
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) [SubExp]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">(SubExp
 -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
-&gt; SubExp
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">($)</span></span><span> </span><span class="annot"><span class="annottext">[SubExp
 -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp]
</span><a href="#local-6989586621684393907"><span class="hs-identifier hs-var">handle_loop_subexps</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393899"><span class="hs-identifier hs-var">ses</span></a></span><span>
</span><span id="line-387"></span><span>        </span><span class="annot"><span class="annottext">([SubExp], [SubExp]) -&gt; AllocM fromrep torep ([SubExp], [SubExp])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393897"><span class="hs-identifier hs-var">ctxargs</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; [SubExp]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393896"><span class="hs-identifier hs-var">memargs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393898"><span class="hs-identifier hs-var">ses'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684393895"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393895"><span class="hs-identifier hs-var">valctx_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393894"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393894"><span class="hs-identifier hs-var">valargs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; AllocM fromrep torep ([SubExp], [SubExp])
</span><a href="#local-6989586621684393900"><span class="hs-identifier hs-var">mk_loop_res</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393908"><span class="hs-identifier hs-var">valargs</span></a></span><span>
</span><span id="line-390"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684393893"><span class="annot"><span class="annottext">merge' :: [(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684393893"><span class="hs-identifier hs-var hs-var">merge'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-391"></span><span>        </span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; [SubExp] -&gt; [(Param FParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span>
</span><span id="line-392"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684393906"><span class="hs-identifier hs-var">ctx_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; [Param FParamMem] -&gt; [Param FParamMem]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684393905"><span class="hs-identifier hs-var">mem_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem] -&gt; [Param FParamMem] -&gt; [Param FParamMem]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684393909"><span class="hs-identifier hs-var">valparams</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-393"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393895"><span class="hs-identifier hs-var">valctx_args</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; [SubExp]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393894"><span class="hs-identifier hs-var">valargs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>  </span><span class="annot"><span class="annottext">Scope torep -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope torep
</span><a href="#local-6989586621684393901"><span class="hs-identifier hs-var">summary</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep a -&gt; AllocM fromrep torep a)
-&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(FParam torep, SubExp)]
-&gt; ([SubExp] -&gt; AllocM fromrep torep ([SubExp], [SubExp]))
-&gt; AllocM fromrep torep a
</span><a href="#local-6989586621684393910"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam torep, SubExp)]
[(Param FParamMem, SubExp)]
</span><a href="#local-6989586621684393893"><span class="hs-identifier hs-var">merge'</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; AllocM fromrep torep ([SubExp], [SubExp])
</span><a href="#local-6989586621684393900"><span class="hs-identifier hs-var">mk_loop_res</span></a></span><span>
</span><span id="line-395"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-396"></span><span>    </span><span id="local-6989586621684393892"><span class="annot"><span class="annottext">param_names :: Names
</span><a href="#local-6989586621684393892"><span class="hs-identifier hs-var hs-var">param_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names) -&gt; [VName] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Param DeclType, SubExp) -&gt; VName)
-&gt; [(Param DeclType, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param DeclType -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">(Param DeclType -&gt; VName)
-&gt; ((Param DeclType, SubExp) -&gt; Param DeclType)
-&gt; (Param DeclType, SubExp)
-&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Param DeclType, SubExp) -&gt; Param DeclType
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
[(FParam fromrep, SubExp)]
</span><a href="#local-6989586621684393911"><span class="hs-identifier hs-var">merge</span></a></span><span>
</span><span id="line-397"></span><span>    </span><span id="local-6989586621684393890"><span class="annot"><span class="annottext">anyIsLoopParam :: Names -&gt; Bool
</span><a href="#local-6989586621684393890"><span class="hs-identifier hs-var hs-var">anyIsLoopParam</span></a></span></span><span> </span><span id="local-6989586621684393889"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684393889"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684393889"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#namesIntersect"><span class="hs-operator hs-var">`namesIntersect`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684393892"><span class="hs-identifier hs-var">param_names</span></a></span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span>    </span><span id="local-6989586621684393794"><span class="annot"><span class="annottext">scalarRes :: DeclType
-&gt; Space -&gt; IxFun (TPrimExp Int64 VName) -&gt; SubExp -&gt; t m SubExp
</span><a href="#local-6989586621684393794"><span class="hs-identifier hs-var hs-var">scalarRes</span></a></span></span><span> </span><span id="local-6989586621684393793"><span class="annot"><span class="annottext">DeclType
</span><a href="#local-6989586621684393793"><span class="hs-identifier hs-var">param_t</span></a></span></span><span> </span><span id="local-6989586621684393792"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393792"><span class="hs-identifier hs-var">v_mem_space</span></a></span></span><span> </span><span id="local-6989586621684393791"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393791"><span class="hs-identifier hs-var">v_ixfun</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684393790"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393790"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-400"></span><span>      </span><span class="hs-comment">-- Try really hard to avoid copying needlessly, but the result</span><span>
</span><span id="line-401"></span><span>      </span><span class="hs-comment">-- _must_ be in ScalarSpace and have the right index function.</span><span>
</span><span id="line-402"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684393789"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393789"><span class="hs-identifier hs-var">res_mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393788"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393788"><span class="hs-identifier hs-var">res_ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (VName, IxFun (TPrimExp Int64 VName))
-&gt; t m (VName, IxFun (TPrimExp Int64 VName))
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m (VName, IxFun (TPrimExp Int64 VName))
 -&gt; t m (VName, IxFun (TPrimExp Int64 VName)))
-&gt; m (VName, IxFun (TPrimExp Int64 VName))
-&gt; t m (VName, IxFun (TPrimExp Int64 VName))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; m (VName, IxFun (TPrimExp Int64 VName))
forall rep inner (m :: * -&gt; *).
(Mem rep inner, HasScope rep m, Monad m) =&gt;
VName -&gt; m (VName, IxFun (TPrimExp Int64 VName))
</span><a href="Futhark.IR.Mem.html#lookupArraySummary"><span class="hs-identifier hs-var">lookupArraySummary</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393790"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-403"></span><span>      </span><span id="local-6989586621684393786"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393786"><span class="hs-identifier hs-var">res_mem_space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m Space -&gt; t m Space
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m Space -&gt; t m Space) -&gt; m Space -&gt; t m Space
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; m Space
forall rep (m :: * -&gt; *).
(HasScope rep m, Monad m) =&gt;
VName -&gt; m Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#lookupMemSpace"><span class="hs-identifier hs-var">lookupMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393789"><span class="hs-identifier hs-var">res_mem</span></a></span><span>
</span><span id="line-404"></span><span>      </span><span id="local-6989586621684393785"><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684393785"><span class="hs-identifier hs-var">chunkmap</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(AllocEnv fromrep torep -&gt; ChunkMap) -&gt; t m ChunkMap
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">AllocEnv fromrep torep -&gt; ChunkMap
forall fromrep torep. AllocEnv fromrep torep -&gt; ChunkMap
</span><a href="Futhark.Pass.ExplicitAllocations.html#chunkMap"><span class="hs-identifier hs-var hs-var">chunkMap</span></a></span><span>
</span><span id="line-405"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684393784"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393784"><span class="hs-identifier hs-var">res_mem'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393783"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393783"><span class="hs-identifier hs-var">res'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-406"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393786"><span class="hs-identifier hs-var">res_mem_space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393788"><span class="hs-identifier hs-var">res_ixfun</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Space, IxFun (TPrimExp Int64 VName))
-&gt; (Space, IxFun (TPrimExp Int64 VName)) -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393792"><span class="hs-identifier hs-var">v_mem_space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393791"><span class="hs-identifier hs-var">v_ixfun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-407"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(VName, VName) -&gt; t m (VName, VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393789"><span class="hs-identifier hs-var">res_mem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393790"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">m (VName, VName) -&gt; t m (VName, VName)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m (VName, VName) -&gt; t m (VName, VName))
-&gt; m (VName, VName) -&gt; t m (VName, VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ChunkMap
-&gt; Space
-&gt; IxFun (TPrimExp Int64 VName)
-&gt; Type
-&gt; VName
-&gt; m (VName, VName)
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ MemOp inner,
 LetDec (Rep m) ~ LParamMem) =&gt;
ChunkMap
-&gt; Space
-&gt; IxFun (TPrimExp Int64 VName)
-&gt; Type
-&gt; VName
-&gt; m (VName, VName)
</span><a href="Futhark.Pass.ExplicitAllocations.html#arrayWithIxFun"><span class="hs-identifier hs-var">arrayWithIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684393785"><span class="hs-identifier hs-var">chunkmap</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393792"><span class="hs-identifier hs-var">v_mem_space</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393791"><span class="hs-identifier hs-var">v_ixfun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DeclType -&gt; Type
forall shape.
TypeBase shape Uniqueness -&gt; TypeBase shape NoUniqueness
</span><a href="Futhark.IR.Prop.Types.html#fromDecl"><span class="hs-identifier hs-var">fromDecl</span></a></span><span> </span><span class="annot"><span class="annottext">DeclType
</span><a href="#local-6989586621684393793"><span class="hs-identifier hs-var">param_t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393790"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-409"></span><span>      </span><span class="annot"><span class="annottext">([a], [SubExp]) -&gt; t m ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393784"><span class="hs-identifier hs-var">res_mem'</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-410"></span><span>      </span><span class="annot"><span class="annottext">SubExp -&gt; t m SubExp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; t m SubExp) -&gt; SubExp -&gt; t m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393783"><span class="hs-identifier hs-var">res'</span></a></span><span>
</span><span id="line-411"></span><span>    </span><span class="annot"><a href="#local-6989586621684393794"><span class="hs-identifier hs-var">scalarRes</span></a></span><span> </span><span class="annot"><span class="annottext">DeclType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684393780"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684393780"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; t m SubExp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684393780"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span>    </span><span id="local-6989586621684395698"><span id="local-6989586621684395699"><span id="local-6989586621684395700"><span class="annot"><a href="#local-6989586621684393903"><span class="hs-identifier hs-type">allocInMergeParam</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-414"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395700"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395699"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395698"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-415"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DeclType"><span class="hs-identifier hs-type">DeclType</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-416"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">WriterT</span></span><span>
</span><span id="line-417"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395699"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395699"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-418"></span><span>        </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395700"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395699"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395699"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-420"></span><span>          </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-421"></span><span>          </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">WriterT</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395700"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395699"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span>
</span><span id="line-422"></span><span>        </span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-423"></span><span>    </span><span id="local-6989586621684393903"><span class="annot"><span class="annottext">allocInMergeParam :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
(Param DeclType, SubExp)
-&gt; WriterT
     ([FParam torep], [FParam torep])
     (AllocM fromrep torep)
     (FParam torep, SubExp,
      SubExp
      -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
</span><a href="#local-6989586621684393903"><span class="hs-identifier hs-var hs-var">allocInMergeParam</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684393538"><span class="annot"><span class="annottext">Param DeclType
</span><a href="#local-6989586621684393538"><span class="hs-identifier hs-var">mergeparam</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684393537"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393537"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-424"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684393536"><span class="annot"><span class="annottext">param_t :: DeclType
</span><a href="#local-6989586621684393536"><span class="hs-identifier hs-var">param_t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684393535"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684393535"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684393534"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684393534"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684393533"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684393533"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Param DeclType -&gt; DeclType
forall dec. DeclTyped dec =&gt; Param dec -&gt; DeclType
</span><a href="Futhark.IR.Prop.Patterns.html#paramDeclType"><span class="hs-identifier hs-var">paramDeclType</span></a></span><span> </span><span class="annot"><span class="annottext">Param DeclType
</span><a href="#local-6989586621684393538"><span class="hs-identifier hs-var">mergeparam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-425"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684393532"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393532"><span class="hs-identifier hs-var">v_mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393531"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393531"><span class="hs-identifier hs-var">v_ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep (VName, IxFun (TPrimExp Int64 VName))
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (VName, IxFun (TPrimExp Int64 VName))
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep (VName, IxFun (TPrimExp Int64 VName))
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      (VName, IxFun (TPrimExp Int64 VName)))
-&gt; AllocM fromrep torep (VName, IxFun (TPrimExp Int64 VName))
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (VName, IxFun (TPrimExp Int64 VName))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; AllocM fromrep torep (VName, IxFun (TPrimExp Int64 VName))
forall rep inner (m :: * -&gt; *).
(Mem rep inner, HasScope rep m, Monad m) =&gt;
VName -&gt; m (VName, IxFun (TPrimExp Int64 VName))
</span><a href="Futhark.IR.Mem.html#lookupArraySummary"><span class="hs-identifier hs-var">lookupArraySummary</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393537"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-426"></span><span>        </span><span id="local-6989586621684393530"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393530"><span class="hs-identifier hs-var">v_mem_space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep Space
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem]) (AllocM fromrep torep) Space
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep Space
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      Space)
-&gt; AllocM fromrep torep Space
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem]) (AllocM fromrep torep) Space
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; AllocM fromrep torep Space
forall rep (m :: * -&gt; *).
(HasScope rep m, Monad m) =&gt;
VName -&gt; m Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#lookupMemSpace"><span class="hs-identifier hs-var">lookupMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393532"><span class="hs-identifier hs-var">v_mem</span></a></span><span>
</span><span id="line-427"></span><span>
</span><span id="line-428"></span><span>        </span><span class="hs-comment">-- Loop-invariant array parameters that are in scalar space</span><span>
</span><span id="line-429"></span><span>        </span><span class="hs-comment">-- are special - we do not wish to existentialise their index</span><span>
</span><span id="line-430"></span><span>        </span><span class="hs-comment">-- function at all (but the memory block is still existential).</span><span>
</span><span id="line-431"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393530"><span class="hs-identifier hs-var">v_mem_space</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-432"></span><span>          </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ScalarSpace"><span class="hs-identifier hs-type">ScalarSpace</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-433"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Names -&gt; Bool
</span><a href="#local-6989586621684393890"><span class="hs-identifier hs-var">anyIsLoopParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684393534"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-434"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-435"></span><span>                </span><span class="hs-comment">-- Arrays with loop-variant shape cannot be in scalar</span><span>
</span><span id="line-436"></span><span>                </span><span class="hs-comment">-- space, so copy them elsewhere and try again.</span><span>
</span><span id="line-437"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393527"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393527"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep (VName, VName)
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (VName, VName)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep (VName, VName)
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      (VName, VName))
-&gt; AllocM fromrep torep (VName, VName)
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (VName, VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; String -&gt; VName -&gt; AllocM fromrep torep (VName, VName)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Space -&gt; String -&gt; VName -&gt; AllocM fromrep torep (VName, VName)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocLinearArray"><span class="hs-identifier hs-var">allocLinearArray</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393537"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393537"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-438"></span><span>                </span><span class="annot"><span class="annottext">(Param DeclType, SubExp)
-&gt; WriterT
     ([Param (FParamInfo torep)], [Param (FParamInfo torep)])
     (AllocM fromrep torep)
     (Param (FParamInfo torep), SubExp,
      SubExp
      -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
(Param DeclType, SubExp)
-&gt; WriterT
     ([FParam torep], [FParam torep])
     (AllocM fromrep torep)
     (FParam torep, SubExp,
      SubExp
      -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
</span><a href="#local-6989586621684393903"><span class="hs-identifier hs-var">allocInMergeParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param DeclType
</span><a href="#local-6989586621684393538"><span class="hs-identifier hs-var">mergeparam</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393527"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-440"></span><span>                </span><span id="local-6989586621684393525"><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684393525"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; FParamMem
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem)
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mem_param&quot;</span></span><span> </span><span class="annot"><span class="annottext">(FParamMem
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      (Param FParamMem))
-&gt; FParamMem
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; FParamMem
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393530"><span class="hs-identifier hs-var">v_mem_space</span></a></span><span>
</span><span id="line-441"></span><span>                </span><span class="annot"><span class="annottext">([Param FParamMem], [Param FParamMem])
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem]) (AllocM fromrep torep) ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684393525"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-442"></span><span>
</span><span id="line-443"></span><span>                </span><span class="annot"><span class="annottext">(Param FParamMem, SubExp,
 SubExp
 -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem, SubExp,
      SubExp
      -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-444"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Param DeclType
</span><a href="#local-6989586621684393538"><span class="hs-identifier hs-var">mergeparam</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: FParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; Uniqueness -&gt; MemBind -&gt; FParamMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684393535"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684393534"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684393533"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; FParamMem) -&gt; MemBind -&gt; FParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684393525"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393531"><span class="hs-identifier hs-var">v_ixfun</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-445"></span><span>                    </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393537"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-446"></span><span>                    </span><span class="annot"><span class="annottext">DeclType
-&gt; Space
-&gt; IxFun (TPrimExp Int64 VName)
-&gt; SubExp
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
forall {t :: (* -&gt; *) -&gt; * -&gt; *} {m :: * -&gt; *} {fromrep} {torep}
       {a} {inner}.
(MonadTrans t, MonadReader (AllocEnv fromrep torep) (t m),
 MonadBuilder m, MonadWriter ([a], [SubExp]) (t m),
 HasLetDecMem (LetDec (Rep m)), OpReturns inner,
 LParamInfo (Rep m) ~ LParamMem, RetType (Rep m) ~ RetTypeMem,
 LetDec (Rep m) ~ LParamMem, Op (Rep m) ~ MemOp inner,
 FParamInfo (Rep m) ~ FParamMem,
 BranchType (Rep m) ~ BranchTypeMem) =&gt;
DeclType
-&gt; Space -&gt; IxFun (TPrimExp Int64 VName) -&gt; SubExp -&gt; t m SubExp
</span><a href="#local-6989586621684393794"><span class="hs-identifier hs-var">scalarRes</span></a></span><span> </span><span class="annot"><span class="annottext">DeclType
</span><a href="#local-6989586621684393536"><span class="hs-identifier hs-var">param_t</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393530"><span class="hs-identifier hs-var">v_mem_space</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393531"><span class="hs-identifier hs-var">v_ixfun</span></a></span><span>
</span><span id="line-447"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-448"></span><span>          </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-449"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684393523"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684393523"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393522"><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684393522"><span class="hs-identifier hs-var">ext_ixfun</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393521"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684393521"><span class="hs-identifier hs-var">substs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393520"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393520"><span class="hs-identifier hs-var">v_mem'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-450"></span><span>              </span><span class="annot"><span class="annottext">AllocM
  fromrep torep (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(AllocM
   fromrep torep (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName))
-&gt; AllocM
     fromrep torep (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space
-&gt; VName
-&gt; AllocM
     fromrep torep (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Space
-&gt; VName
-&gt; AllocM
     fromrep torep (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
</span><a href="Futhark.Pass.ExplicitAllocations.html#existentializeArray"><span class="hs-identifier hs-var">existentializeArray</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393530"><span class="hs-identifier hs-var">v_mem_space</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393537"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-451"></span><span>            </span><span id="local-6989586621684393518"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393518"><span class="hs-identifier hs-var">v_mem_space'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep Space
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem]) (AllocM fromrep torep) Space
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep Space
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      Space)
-&gt; AllocM fromrep torep Space
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem]) (AllocM fromrep torep) Space
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; AllocM fromrep torep Space
forall rep (m :: * -&gt; *).
(HasScope rep m, Monad m) =&gt;
VName -&gt; m Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#lookupMemSpace"><span class="hs-identifier hs-var">lookupMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393520"><span class="hs-identifier hs-var">v_mem'</span></a></span><span>
</span><span id="line-452"></span><span>
</span><span id="line-453"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684393517"><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684393517"><span class="hs-identifier hs-var">ctx_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393516"><span class="annot"><span class="annottext">[TPrimExp Int64 (Ext VName)]
</span><a href="#local-6989586621684393516"><span class="hs-identifier hs-var">param_ixfun_substs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-454"></span><span>              </span><span class="annot"><span class="annottext">([(Param FParamMem, TPrimExp Int64 (Ext VName))]
 -&gt; ([Param FParamMem], [TPrimExp Int64 (Ext VName)]))
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     [(Param FParamMem, TPrimExp Int64 (Ext VName))]
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     ([Param FParamMem], [TPrimExp Int64 (Ext VName)])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[(Param FParamMem, TPrimExp Int64 (Ext VName))]
-&gt; ([Param FParamMem], [TPrimExp Int64 (Ext VName)])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">(WriterT
   ([Param FParamMem], [Param FParamMem])
   (AllocM fromrep torep)
   [(Param FParamMem, TPrimExp Int64 (Ext VName))]
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      ([Param FParamMem], [TPrimExp Int64 (Ext VName)]))
-&gt; ((TPrimExp Int64 VName
     -&gt; WriterT
          ([Param FParamMem], [Param FParamMem])
          (AllocM fromrep torep)
          (Param FParamMem, TPrimExp Int64 (Ext VName)))
    -&gt; WriterT
         ([Param FParamMem], [Param FParamMem])
         (AllocM fromrep torep)
         [(Param FParamMem, TPrimExp Int64 (Ext VName))])
-&gt; (TPrimExp Int64 VName
    -&gt; WriterT
         ([Param FParamMem], [Param FParamMem])
         (AllocM fromrep torep)
         (Param FParamMem, TPrimExp Int64 (Ext VName)))
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     ([Param FParamMem], [TPrimExp Int64 (Ext VName)])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; (TPrimExp Int64 VName
    -&gt; WriterT
         ([Param FParamMem], [Param FParamMem])
         (AllocM fromrep torep)
         (Param FParamMem, TPrimExp Int64 (Ext VName)))
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     [(Param FParamMem, TPrimExp Int64 (Ext VName))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684393521"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">((TPrimExp Int64 VName
  -&gt; WriterT
       ([Param FParamMem], [Param FParamMem])
       (AllocM fromrep torep)
       (Param FParamMem, TPrimExp Int64 (Ext VName)))
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      ([Param FParamMem], [TPrimExp Int64 (Ext VName)]))
-&gt; (TPrimExp Int64 VName
    -&gt; WriterT
         ([Param FParamMem], [Param FParamMem])
         (AllocM fromrep torep)
         (Param FParamMem, TPrimExp Int64 (Ext VName)))
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     ([Param FParamMem], [TPrimExp Int64 (Ext VName)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684393514"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684393514"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-455"></span><span>                </span><span id="local-6989586621684393513"><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684393513"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; FParamMem
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem)
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ctx_param_ext&quot;</span></span><span> </span><span class="annot"><span class="annottext">(FParamMem
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      (Param FParamMem))
-&gt; FParamMem
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; FParamMem
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; FParamMem) -&gt; PrimType -&gt; FParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimExp VName -&gt; PrimType
forall v. PrimExp v -&gt; PrimType
</span><a href="Futhark.Analysis.PrimExp.html#primExpType"><span class="hs-identifier hs-var">primExpType</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; PrimType) -&gt; PrimExp VName -&gt; PrimType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684393514"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-456"></span><span>                </span><span class="annot"><span class="annottext">(Param FParamMem, TPrimExp Int64 (Ext VName))
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem, TPrimExp Int64 (Ext VName))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684393513"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Ext VName)
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 (Ext VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Ext VName
forall a. a -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-var">Free</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; TPrimExp Int64 (Ext VName))
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 (Ext VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">le64</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TPrimExp Int64 VName) -&gt; VName -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684393513"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span>            </span><span class="annot"><span class="annottext">([Param FParamMem], [Param FParamMem])
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem]) (AllocM fromrep torep) ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param FParamMem]
</span><a href="#local-6989586621684393517"><span class="hs-identifier hs-var">ctx_params</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-459"></span><span>
</span><span id="line-460"></span><span>            </span><span id="local-6989586621684393510"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393510"><span class="hs-identifier hs-var">param_ixfun</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-461"></span><span>              </span><span class="annot"><span class="annottext">ExtIxFun
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (IxFun (TPrimExp Int64 VName))
forall (m :: * -&gt; *).
Monad m =&gt;
ExtIxFun -&gt; m (IxFun (TPrimExp Int64 VName))
</span><a href="Futhark.Pass.ExplicitAllocations.html#instantiateIxFun"><span class="hs-identifier hs-var">instantiateIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtIxFun
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      (IxFun (TPrimExp Int64 VName)))
-&gt; ExtIxFun
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (IxFun (TPrimExp Int64 VName))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-462"></span><span>                </span><span class="annot"><span class="annottext">Map (Ext VName) (TPrimExp Int64 (Ext VName))
-&gt; ExtIxFun -&gt; ExtIxFun
forall a t.
Ord a =&gt;
Map a (TPrimExp t a)
-&gt; IxFun (TPrimExp t a) -&gt; IxFun (TPrimExp t a)
</span><a href="Futhark.IR.Mem.IxFun.html#substituteInIxFun"><span class="hs-identifier hs-var">IxFun.substituteInIxFun</span></a></span><span>
</span><span id="line-463"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Ext VName, TPrimExp Int64 (Ext VName))]
-&gt; Map (Ext VName) (TPrimExp Int64 (Ext VName))
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(Ext VName, TPrimExp Int64 (Ext VName))]
 -&gt; Map (Ext VName) (TPrimExp Int64 (Ext VName)))
-&gt; [(Ext VName, TPrimExp Int64 (Ext VName))]
-&gt; Map (Ext VName) (TPrimExp Int64 (Ext VName))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Ext VName]
-&gt; [TPrimExp Int64 (Ext VName)]
-&gt; [(Ext VName, TPrimExp Int64 (Ext VName))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int -&gt; Ext VName) -&gt; [Int] -&gt; [Ext VName]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Ext VName
forall a. Int -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-var">Ext</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 (Ext VName)]
</span><a href="#local-6989586621684393516"><span class="hs-identifier hs-var">param_ixfun_substs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>                  </span><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684393522"><span class="hs-identifier hs-var">ext_ixfun</span></a></span><span>
</span><span id="line-465"></span><span>
</span><span id="line-466"></span><span>            </span><span id="local-6989586621684393507"><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684393507"><span class="hs-identifier hs-var">mem_param</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; FParamMem
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem)
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mem_param&quot;</span></span><span> </span><span class="annot"><span class="annottext">(FParamMem
 -&gt; WriterT
      ([Param FParamMem], [Param FParamMem])
      (AllocM fromrep torep)
      (Param FParamMem))
-&gt; FParamMem
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; FParamMem
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393518"><span class="hs-identifier hs-var">v_mem_space'</span></a></span><span>
</span><span id="line-467"></span><span>            </span><span class="annot"><span class="annottext">([Param FParamMem], [Param FParamMem])
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem]) (AllocM fromrep torep) ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684393507"><span class="hs-identifier hs-var">mem_param</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>            </span><span class="annot"><span class="annottext">(Param FParamMem, SubExp,
 SubExp
 -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
-&gt; WriterT
     ([Param FParamMem], [Param FParamMem])
     (AllocM fromrep torep)
     (Param FParamMem, SubExp,
      SubExp
      -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-469"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Param DeclType
</span><a href="#local-6989586621684393538"><span class="hs-identifier hs-var">mergeparam</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: FParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; Uniqueness -&gt; MemBind -&gt; FParamMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684393535"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684393534"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684393533"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; FParamMem) -&gt; MemBind -&gt; FParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param FParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param FParamMem
</span><a href="#local-6989586621684393507"><span class="hs-identifier hs-var">mem_param</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393510"><span class="hs-identifier hs-var">param_ixfun</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-470"></span><span>                </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684393523"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-471"></span><span>                </span><span class="annot"><span class="annottext">Space
-&gt; SubExp
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Space
-&gt; SubExp
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
</span><a href="Futhark.Pass.ExplicitAllocations.html#ensureArrayIn"><span class="hs-identifier hs-var">ensureArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393518"><span class="hs-identifier hs-var">v_mem_space'</span></a></span><span>
</span><span id="line-472"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-473"></span><span>    </span><span class="annot"><a href="#local-6989586621684393903"><span class="hs-identifier hs-var">allocInMergeParam</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684393505"><span class="annot"><span class="annottext">Param DeclType
</span><a href="#local-6989586621684393505"><span class="hs-identifier hs-var">mergeparam</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393504"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684393504"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Param DeclType
-&gt; SubExp
-&gt; Space
-&gt; WriterT
     ([Param (FParamInfo torep)], [Param (FParamInfo torep)])
     (AllocM fromrep torep)
     (Param (FParamInfo torep), SubExp,
      SubExp
      -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
forall {torep} {fromrep} {fromrep} {torep} {inner} {inner} {b}.
(PrettyRep fromrep, PrettyRep fromrep, HasLetDecMem (LetDec torep),
 HasLetDecMem (LetDec torep), OpReturns inner, OpReturns inner,
 SizeSubst inner, SizeSubst inner, BuilderOps torep,
 BuilderOps torep, FParamInfo torep ~ FParamMem,
 LetDec torep ~ LParamMem, BodyDec fromrep ~ (),
 LParamInfo fromrep ~ Type, RetType torep ~ RetTypeMem,
 BodyDec fromrep ~ (), BranchType torep ~ BranchTypeMem,
 BranchType fromrep ~ ExtType, FParamInfo torep ~ FParamMem,
 FParamInfo fromrep ~ DeclType, ExpDec torep ~ (),
 LParamInfo fromrep ~ Type, RetType torep ~ RetTypeMem,
 BodyDec torep ~ (), BranchType torep ~ BranchTypeMem,
 BranchType fromrep ~ ExtType, RetType fromrep ~ DeclExtType,
 Op torep ~ MemOp inner, ExpDec torep ~ (),
 LParamInfo torep ~ LParamMem, FParamInfo fromrep ~ DeclType,
 BodyDec torep ~ (), LetDec torep ~ LParamMem,
 LParamInfo torep ~ LParamMem, RetType fromrep ~ DeclExtType,
 Op torep ~ MemOp inner) =&gt;
Param DeclType
-&gt; b
-&gt; Space
-&gt; WriterT
     ([Param (FParamInfo torep)], [Param (FParamInfo torep)])
     (AllocM fromrep torep)
     (Param (FParamInfo torep), b,
      SubExp
      -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
</span><a href="#local-6989586621684393503"><span class="hs-identifier hs-var">doDefault</span></a></span><span> </span><span class="annot"><span class="annottext">Param DeclType
</span><a href="#local-6989586621684393505"><span class="hs-identifier hs-var">mergeparam</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684393504"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">(Space
 -&gt; WriterT
      ([Param (FParamInfo torep)], [Param (FParamInfo torep)])
      (AllocM fromrep torep)
      (Param FParamMem, SubExp,
       SubExp
       -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp))
-&gt; WriterT
     ([Param (FParamInfo torep)], [Param (FParamInfo torep)])
     (AllocM fromrep torep)
     Space
-&gt; WriterT
     ([Param (FParamInfo torep)], [Param (FParamInfo torep)])
     (AllocM fromrep torep)
     (Param FParamMem, SubExp,
      SubExp
      -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep Space
-&gt; WriterT
     ([Param (FParamInfo torep)], [Param (FParamInfo torep)])
     (AllocM fromrep torep)
     Space
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep Space
forall fromrep torep. AllocM fromrep torep Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#askDefaultSpace"><span class="hs-identifier hs-var">askDefaultSpace</span></a></span><span>
</span><span id="line-474"></span><span>
</span><span id="line-475"></span><span>    </span><span id="local-6989586621684393503"><span class="annot"><span class="annottext">doDefault :: Param DeclType
-&gt; b
-&gt; Space
-&gt; WriterT
     ([Param (FParamInfo torep)], [Param (FParamInfo torep)])
     (AllocM fromrep torep)
     (Param (FParamInfo torep), b,
      SubExp
      -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
</span><a href="#local-6989586621684393503"><span class="hs-identifier hs-var hs-var">doDefault</span></a></span></span><span> </span><span id="local-6989586621684393323"><span class="annot"><span class="annottext">Param DeclType
</span><a href="#local-6989586621684393323"><span class="hs-identifier hs-var">mergeparam</span></a></span></span><span> </span><span id="local-6989586621684393322"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684393322"><span class="hs-identifier hs-var">se</span></a></span></span><span> </span><span id="local-6989586621684393321"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393321"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-476"></span><span>      </span><span id="local-6989586621684393320"><span class="annot"><span class="annottext">Param (FParamInfo torep)
</span><a href="#local-6989586621684393320"><span class="hs-identifier hs-var">mergeparam'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">FParam fromrep
-&gt; Space
-&gt; WriterT
     ([Param (FParamInfo torep)], [Param (FParamInfo torep)])
     (AllocM fromrep torep)
     (Param (FParamInfo torep))
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
FParam fromrep
-&gt; Space
-&gt; WriterT
     ([FParam torep], [FParam torep])
     (AllocM fromrep torep)
     (FParam torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInFParam"><span class="hs-identifier hs-var">allocInFParam</span></a></span><span> </span><span class="annot"><span class="annottext">Param DeclType
FParam fromrep
</span><a href="#local-6989586621684393323"><span class="hs-identifier hs-var">mergeparam</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393321"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-477"></span><span>      </span><span class="annot"><span class="annottext">(Param (FParamInfo torep), b,
 SubExp
 -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
-&gt; WriterT
     ([Param (FParamInfo torep)], [Param (FParamInfo torep)])
     (AllocM fromrep torep)
     (Param (FParamInfo torep), b,
      SubExp
      -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (FParamInfo torep)
</span><a href="#local-6989586621684393320"><span class="hs-identifier hs-var">mergeparam'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684393322"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Type
-&gt; Space
-&gt; SubExp
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Type
-&gt; Space
-&gt; SubExp
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
</span><a href="Futhark.Pass.ExplicitAllocations.html#linearFuncallArg"><span class="hs-identifier hs-var">linearFuncallArg</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param DeclType -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param DeclType
</span><a href="#local-6989586621684393323"><span class="hs-identifier hs-var">mergeparam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393321"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span class="hs-comment">-- Returns the existentialized index function, the list of substituted values and the memory location.</span><span>
</span><span id="line-480"></span><span id="local-6989586621684395660"><span id="local-6989586621684395661"><span id="local-6989586621684395662"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#existentializeArray"><span class="hs-identifier hs-type">existentializeArray</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-481"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395662"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395661"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395660"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-482"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-483"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-484"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395662"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395661"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#ExtIxFun"><span class="hs-identifier hs-type">ExtIxFun</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-485"></span><span id="existentializeArray"><span class="annot"><span class="annottext">existentializeArray :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Space
-&gt; VName
-&gt; AllocM
     fromrep torep (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
</span><a href="Futhark.Pass.ExplicitAllocations.html#existentializeArray"><span class="hs-identifier hs-var hs-var">existentializeArray</span></a></span></span><span> </span><span id="local-6989586621684393202"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393202"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684393201"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393201"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-486"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684393200"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393200"><span class="hs-identifier hs-var">mem'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393199"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393199"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; AllocM fromrep torep (VName, IxFun (TPrimExp Int64 VName))
forall rep inner (m :: * -&gt; *).
(Mem rep inner, HasScope rep m, Monad m) =&gt;
VName -&gt; m (VName, IxFun (TPrimExp Int64 VName))
</span><a href="Futhark.IR.Mem.html#lookupArraySummary"><span class="hs-identifier hs-var">lookupArraySummary</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393201"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-487"></span><span>  </span><span id="local-6989586621684393198"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393198"><span class="hs-identifier hs-var">sp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; AllocM fromrep torep Space
forall rep (m :: * -&gt; *).
(HasScope rep m, Monad m) =&gt;
VName -&gt; m Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#lookupMemSpace"><span class="hs-identifier hs-var">lookupMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393200"><span class="hs-identifier hs-var">mem'</span></a></span><span>
</span><span id="line-488"></span><span>
</span><span id="line-489"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684393197"><span class="annot"><span class="annottext">Maybe ExtIxFun
</span><a href="#local-6989586621684393197"><span class="hs-identifier hs-var">ext_ixfun'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393196"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684393196"><span class="hs-identifier hs-var">substs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State [TPrimExp Int64 VName] (Maybe ExtIxFun)
-&gt; [TPrimExp Int64 VName]
-&gt; (Maybe ExtIxFun, [TPrimExp Int64 VName])
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
-&gt; State [TPrimExp Int64 VName] (Maybe ExtIxFun)
forall t v.
(IntExp t, Eq v, Pretty v) =&gt;
IxFun (TPrimExp t v)
-&gt; State [TPrimExp t v] (Maybe (IxFun (TPrimExp t (Ext v))))
</span><a href="Futhark.IR.Mem.IxFun.html#existentialize"><span class="hs-identifier hs-var">IxFun.existentialize</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393199"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ExtIxFun
</span><a href="#local-6989586621684393197"><span class="hs-identifier hs-var">ext_ixfun'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393198"><span class="hs-identifier hs-var">sp</span></a></span><span> </span><span class="annot"><span class="annottext">Space -&gt; Space -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393202"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-492"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684393194"><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684393194"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
-&gt; AllocM
     fromrep torep (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393201"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684393194"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684393196"><span class="hs-identifier hs-var">substs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393200"><span class="hs-identifier hs-var">mem'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-493"></span><span>    </span><span class="annot"><span class="annottext">(Maybe ExtIxFun, Bool)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-494"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684393193"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393193"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393192"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393192"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Space -&gt; String -&gt; VName -&gt; AllocM fromrep torep (VName, VName)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Space -&gt; String -&gt; VName -&gt; AllocM fromrep torep (VName, VName)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocLinearArray"><span class="hs-identifier hs-var">allocLinearArray</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393202"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393201"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393201"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-495"></span><span>      </span><span id="local-6989586621684393191"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393191"><span class="hs-identifier hs-var">ixfun'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp Int64 VName))
-&gt; IxFun (TPrimExp Int64 VName)
forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (IxFun (TPrimExp Int64 VName))
 -&gt; IxFun (TPrimExp Int64 VName))
-&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName)))
-&gt; AllocM fromrep torep (IxFun (TPrimExp Int64 VName))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName)))
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
VName
-&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName)))
</span><a href="Futhark.Pass.ExplicitAllocations.html#lookupIxFun"><span class="hs-identifier hs-var">lookupIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393192"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-496"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684393188"><span class="annot"><span class="annottext">Maybe ExtIxFun
</span><a href="#local-6989586621684393188"><span class="hs-identifier hs-var">ext_ixfun</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393187"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684393187"><span class="hs-identifier hs-var">substs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State [TPrimExp Int64 VName] (Maybe ExtIxFun)
-&gt; [TPrimExp Int64 VName]
-&gt; (Maybe ExtIxFun, [TPrimExp Int64 VName])
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
-&gt; State [TPrimExp Int64 VName] (Maybe ExtIxFun)
forall t v.
(IntExp t, Eq v, Pretty v) =&gt;
IxFun (TPrimExp t v)
-&gt; State [TPrimExp t v] (Maybe (IxFun (TPrimExp t (Ext v))))
</span><a href="Futhark.IR.Mem.IxFun.html#existentialize"><span class="hs-identifier hs-var">IxFun.existentialize</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393191"><span class="hs-identifier hs-var">ixfun'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-497"></span><span>      </span><span class="annot"><span class="annottext">(SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
-&gt; AllocM
     fromrep torep (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393192"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ExtIxFun -&gt; ExtIxFun
forall a. HasCallStack =&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromJust</span></span><span> </span><span class="annot"><span class="annottext">Maybe ExtIxFun
</span><a href="#local-6989586621684393188"><span class="hs-identifier hs-var">ext_ixfun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684393187"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393193"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>
</span><span id="line-499"></span><span id="local-6989586621684395681"><span id="local-6989586621684395682"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#arrayWithIxFun"><span class="hs-identifier hs-type">arrayWithIxFun</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-500"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395682"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395682"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemOp"><span class="hs-identifier hs-type">MemOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395681"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395682"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#LetDecMem"><span class="hs-identifier hs-type">LetDecMem</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-501"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ChunkMap"><span class="hs-identifier hs-type">ChunkMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-502"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-503"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-504"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-505"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-506"></span><span>  </span><span class="annot"><a href="#local-6989586621684395682"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-507"></span><span id="arrayWithIxFun"><span class="annot"><span class="annottext">arrayWithIxFun :: forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ MemOp inner,
 LetDec (Rep m) ~ LParamMem) =&gt;
ChunkMap
-&gt; Space
-&gt; IxFun (TPrimExp Int64 VName)
-&gt; Type
-&gt; VName
-&gt; m (VName, VName)
</span><a href="Futhark.Pass.ExplicitAllocations.html#arrayWithIxFun"><span class="hs-identifier hs-var hs-var">arrayWithIxFun</span></a></span></span><span> </span><span id="local-6989586621684393163"><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684393163"><span class="hs-identifier hs-var">chunkmap</span></a></span></span><span> </span><span id="local-6989586621684393162"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393162"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684393161"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393161"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span> </span><span id="local-6989586621684393160"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684393160"><span class="hs-identifier hs-var">v_t</span></a></span></span><span> </span><span id="local-6989586621684393159"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393159"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-508"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684393158"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684393158"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684393157"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684393157"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684393156"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684393156"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684393160"><span class="hs-identifier hs-var">v_t</span></a></span><span>
</span><span id="line-509"></span><span>  </span><span id="local-6989586621684393155"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393155"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ChunkMap -&gt; Type -&gt; Space -&gt; m VName
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ MemOp inner) =&gt;
ChunkMap -&gt; Type -&gt; Space -&gt; m VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocForArray%27"><span class="hs-identifier hs-var">allocForArray'</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684393163"><span class="hs-identifier hs-var">chunkmap</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684393160"><span class="hs-identifier hs-var">v_t</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393162"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-510"></span><span>  </span><span id="local-6989586621684393154"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393154"><span class="hs-identifier hs-var">v_copy</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; m VName) -&gt; String -&gt; m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393159"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_scalcopy&quot;</span></span><span>
</span><span id="line-511"></span><span>  </span><span class="annot"><span class="annottext">Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; PatT LParamMem
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; LParamMem -&gt; PatElemT LParamMem
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393154"><span class="hs-identifier hs-var">v_copy</span></a></span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; PatElemT LParamMem)
-&gt; LParamMem -&gt; PatElemT LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; NoUniqueness -&gt; MemBind -&gt; LParamMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684393158"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684393157"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684393156"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; LParamMem) -&gt; MemBind -&gt; LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393155"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684393161"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m ()) -&gt; Exp (Rep m) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp (Rep m)
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp (Rep m)) -&gt; BasicOp -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-var">Copy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393159"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-512"></span><span>  </span><span class="annot"><span class="annottext">(VName, VName) -&gt; m (VName, VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393155"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393154"><span class="hs-identifier hs-var">v_copy</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span id="local-6989586621684395649"><span id="local-6989586621684395650"><span id="local-6989586621684395651"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ensureArrayIn"><span class="hs-identifier hs-type">ensureArrayIn</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-515"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395651"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395650"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395649"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-516"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-517"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-518"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">WriterT</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395651"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395650"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span></span></span></span><span>
</span><span id="line-519"></span><span id="ensureArrayIn"><span class="annot"><span class="annottext">ensureArrayIn :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Space
-&gt; SubExp
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
</span><a href="Futhark.Pass.ExplicitAllocations.html#ensureArrayIn"><span class="hs-identifier hs-var hs-var">ensureArrayIn</span></a></span></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span id="local-6989586621684393035"><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684393035"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-520"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String
 -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
-&gt; String
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ensureArrayIn: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PrimValue -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PrimValue
</span><a href="#local-6989586621684393035"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; cannot be an array.&quot;</span></span><span>
</span><span id="line-521"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ensureArrayIn"><span class="hs-identifier hs-var">ensureArrayIn</span></a></span><span> </span><span id="local-6989586621684393034"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393034"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684393033"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393033"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-522"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684393032"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684393032"><span class="hs-identifier hs-var">sub_exp</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ExtIxFun
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393031"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684393031"><span class="hs-identifier hs-var">substs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684393030"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393030"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AllocM
  fromrep torep (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
-&gt; WriterT
     ([SubExp], [SubExp])
     (AllocM fromrep torep)
     (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(AllocM
   fromrep torep (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
 -&gt; WriterT
      ([SubExp], [SubExp])
      (AllocM fromrep torep)
      (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName))
-&gt; AllocM
     fromrep torep (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
-&gt; WriterT
     ([SubExp], [SubExp])
     (AllocM fromrep torep)
     (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space
-&gt; VName
-&gt; AllocM
     fromrep torep (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Space
-&gt; VName
-&gt; AllocM
     fromrep torep (SubExp, ExtIxFun, [TPrimExp Int64 VName], VName)
</span><a href="Futhark.Pass.ExplicitAllocations.html#existentializeArray"><span class="hs-identifier hs-var">existentializeArray</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684393034"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393033"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684393029"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393029"><span class="hs-identifier hs-var">ctx_vals</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PrimExp (Ext VName)]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-524"></span><span>    </span><span class="annot"><span class="annottext">[(SubExp, PrimExp (Ext VName))]
-&gt; ([SubExp], [PrimExp (Ext VName)])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span>
</span><span id="line-525"></span><span>      </span><span class="annot"><span class="annottext">([(SubExp, PrimExp (Ext VName))]
 -&gt; ([SubExp], [PrimExp (Ext VName)]))
-&gt; WriterT
     ([SubExp], [SubExp])
     (AllocM fromrep torep)
     [(SubExp, PrimExp (Ext VName))]
-&gt; WriterT
     ([SubExp], [SubExp])
     (AllocM fromrep torep)
     ([SubExp], [PrimExp (Ext VName)])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; WriterT
      ([SubExp], [SubExp])
      (AllocM fromrep torep)
      (SubExp, PrimExp (Ext VName)))
-&gt; [TPrimExp Int64 VName]
-&gt; WriterT
     ([SubExp], [SubExp])
     (AllocM fromrep torep)
     [(SubExp, PrimExp (Ext VName))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span>
</span><span id="line-526"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684393028"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684393028"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-527"></span><span>            </span><span id="local-6989586621684393027"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393027"><span class="hs-identifier hs-var">vname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep VName
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep VName
 -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) VName)
-&gt; AllocM fromrep torep VName
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (AllocM fromrep torep)) -&gt; AllocM fromrep torep VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ctx_val&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT torep -&gt; AllocM fromrep torep VName)
-&gt; AllocM fromrep torep (ExpT torep) -&gt; AllocM fromrep torep VName
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; AllocM fromrep torep (Exp (Rep (AllocM fromrep torep)))
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684393028"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-528"></span><span>            </span><span class="annot"><span class="annottext">(SubExp, PrimExp (Ext VName))
-&gt; WriterT
     ([SubExp], [SubExp])
     (AllocM fromrep torep)
     (SubExp, PrimExp (Ext VName))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393027"><span class="hs-identifier hs-var">vname</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Ext VName) -&gt; PrimExp VName -&gt; PrimExp (Ext VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Ext VName
forall a. a -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-var">Free</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; PrimExp (Ext VName))
-&gt; PrimExp VName -&gt; PrimExp (Ext VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; SubExp -&gt; PrimExp VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#primExpFromSubExp"><span class="hs-identifier hs-var">primExpFromSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; PrimExp VName) -&gt; SubExp -&gt; PrimExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393027"><span class="hs-identifier hs-var">vname</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-530"></span><span>        </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684393031"><span class="hs-identifier hs-var">substs</span></a></span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span>  </span><span class="annot"><span class="annottext">([SubExp], [SubExp])
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684393029"><span class="hs-identifier hs-var">ctx_vals</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684393030"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-533"></span><span>
</span><span id="line-534"></span><span>  </span><span class="annot"><span class="annottext">SubExp
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684393032"><span class="hs-identifier hs-var">sub_exp</span></a></span><span>
</span><span id="line-535"></span><span>
</span><span id="line-536"></span><span id="local-6989586621684395612"><span id="local-6989586621684395613"><span id="local-6989586621684395614"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ensureDirectArray"><span class="hs-identifier hs-type">ensureDirectArray</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-537"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395614"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395613"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395612"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-538"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-539"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-540"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395614"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395613"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-541"></span><span id="ensureDirectArray"><span class="annot"><span class="annottext">ensureDirectArray :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Maybe Space -&gt; VName -&gt; AllocM fromrep torep (VName, VName)
</span><a href="Futhark.Pass.ExplicitAllocations.html#ensureDirectArray"><span class="hs-identifier hs-var hs-var">ensureDirectArray</span></a></span></span><span> </span><span id="local-6989586621684392925"><span class="annot"><span class="annottext">Maybe Space
</span><a href="#local-6989586621684392925"><span class="hs-identifier hs-var">space_ok</span></a></span></span><span> </span><span id="local-6989586621684392924"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392924"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-542"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684392923"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392923"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684392922"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684392922"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; AllocM fromrep torep (VName, IxFun (TPrimExp Int64 VName))
forall rep inner (m :: * -&gt; *).
(Mem rep inner, HasScope rep m, Monad m) =&gt;
VName -&gt; m (VName, IxFun (TPrimExp Int64 VName))
</span><a href="Futhark.IR.Mem.html#lookupArraySummary"><span class="hs-identifier hs-var">lookupArraySummary</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392924"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-543"></span><span>  </span><span id="local-6989586621684392921"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684392921"><span class="hs-identifier hs-var">mem_space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; AllocM fromrep torep Space
forall rep (m :: * -&gt; *).
(HasScope rep m, Monad m) =&gt;
VName -&gt; m Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#lookupMemSpace"><span class="hs-identifier hs-var">lookupMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392923"><span class="hs-identifier hs-var">mem</span></a></span><span>
</span><span id="line-544"></span><span>  </span><span id="local-6989586621684392920"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684392920"><span class="hs-identifier hs-var">default_space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep Space
forall fromrep torep. AllocM fromrep torep Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#askDefaultSpace"><span class="hs-identifier hs-var">askDefaultSpace</span></a></span><span>
</span><span id="line-545"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName) -&gt; Bool
forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#isDirect"><span class="hs-identifier hs-var">IxFun.isDirect</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684392922"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; (Space -&gt; Bool) -&gt; Maybe Space -&gt; Bool
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Space -&gt; Space -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684392921"><span class="hs-identifier hs-var">mem_space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Space
</span><a href="#local-6989586621684392925"><span class="hs-identifier hs-var">space_ok</span></a></span><span>
</span><span id="line-546"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(VName, VName) -&gt; AllocM fromrep torep (VName, VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392923"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392924"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-547"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Space -&gt; AllocM fromrep torep (VName, VName)
</span><a href="#local-6989586621684392917"><span class="hs-identifier hs-var">needCopy</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Space -&gt; Maybe Space -&gt; Space
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684392920"><span class="hs-identifier hs-var">default_space</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Space
</span><a href="#local-6989586621684392925"><span class="hs-identifier hs-var">space_ok</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-549"></span><span>    </span><span id="local-6989586621684392917"><span class="annot"><span class="annottext">needCopy :: Space -&gt; AllocM fromrep torep (VName, VName)
</span><a href="#local-6989586621684392917"><span class="hs-identifier hs-var hs-var">needCopy</span></a></span></span><span> </span><span id="local-6989586621684392915"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684392915"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-550"></span><span>      </span><span class="hs-comment">-- We need to do a new allocation, copy 'v', and make a new</span><span>
</span><span id="line-551"></span><span>      </span><span class="hs-comment">-- binding for the size of the memory block.</span><span>
</span><span id="line-552"></span><span>      </span><span class="annot"><span class="annottext">Space -&gt; String -&gt; VName -&gt; AllocM fromrep torep (VName, VName)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Space -&gt; String -&gt; VName -&gt; AllocM fromrep torep (VName, VName)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocLinearArray"><span class="hs-identifier hs-var">allocLinearArray</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684392915"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392924"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392924"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-553"></span><span>
</span><span id="line-554"></span><span id="local-6989586621684395665"><span id="local-6989586621684395666"><span id="local-6989586621684395667"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocLinearArray"><span class="hs-identifier hs-type">allocLinearArray</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-555"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395667"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395666"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395665"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-556"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-557"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-558"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-559"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395667"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395666"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-560"></span><span id="allocLinearArray"><span class="annot"><span class="annottext">allocLinearArray :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Space -&gt; String -&gt; VName -&gt; AllocM fromrep torep (VName, VName)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocLinearArray"><span class="hs-identifier hs-var hs-var">allocLinearArray</span></a></span></span><span> </span><span id="local-6989586621684392816"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684392816"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684392815"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684392815"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684392814"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392814"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-561"></span><span>  </span><span id="local-6989586621684392813"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684392813"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; AllocM fromrep torep Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392814"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-562"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684392813"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-563"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684392812"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684392812"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684392811"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684392811"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684392810"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684392810"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-564"></span><span>      </span><span id="local-6989586621684392809"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392809"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Space -&gt; AllocM fromrep torep VName
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Type -&gt; Space -&gt; AllocM fromrep torep VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocForArray"><span class="hs-identifier hs-var">allocForArray</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684392813"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684392816"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-565"></span><span>      </span><span id="local-6989586621684392808"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392808"><span class="hs-identifier hs-var">v'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; AllocM fromrep torep VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; AllocM fromrep torep VName)
-&gt; String -&gt; AllocM fromrep torep VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684392815"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_linear&quot;</span></span><span>
</span><span id="line-566"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684392807"><span class="annot"><span class="annottext">ixfun :: LParamMem
</span><a href="#local-6989586621684392807"><span class="hs-identifier hs-var hs-var">ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; NoUniqueness -&gt; VName -&gt; Type -&gt; LParamMem
forall u. PrimType -&gt; Shape -&gt; u -&gt; VName -&gt; Type -&gt; MemBound u
</span><a href="Futhark.Pass.ExplicitAllocations.html#directIxFun"><span class="hs-identifier hs-var">directIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684392812"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684392811"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684392810"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392809"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684392813"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-567"></span><span>          </span><span id="local-6989586621684392806"><span class="annot"><span class="annottext">pat :: PatT LParamMem
</span><a href="#local-6989586621684392806"><span class="hs-identifier hs-var hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; PatT LParamMem
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; LParamMem -&gt; PatElemT LParamMem
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392808"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684392807"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-568"></span><span>      </span><span class="annot"><span class="annottext">Stm (Rep (AllocM fromrep torep)) -&gt; AllocM fromrep torep ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStm"><span class="hs-identifier hs-var">addStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm (Rep (AllocM fromrep torep)) -&gt; AllocM fromrep torep ())
-&gt; Stm (Rep (AllocM fromrep torep)) -&gt; AllocM fromrep torep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat torep -&gt; StmAux (ExpDec torep) -&gt; Exp torep -&gt; Stm torep
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat torep
PatT LParamMem
</span><a href="#local-6989586621684392806"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp torep -&gt; Stm torep) -&gt; Exp torep -&gt; Stm torep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp torep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp torep) -&gt; BasicOp -&gt; Exp torep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Copy"><span class="hs-identifier hs-var">Copy</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392814"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-569"></span><span>      </span><span class="annot"><span class="annottext">(VName, VName) -&gt; AllocM fromrep torep (VName, VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392809"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392808"><span class="hs-identifier hs-var">v'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>    </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-571"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; AllocM fromrep torep (VName, VName)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; AllocM fromrep torep (VName, VName))
-&gt; String -&gt; AllocM fromrep torep (VName, VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;allocLinearArray: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684392813"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-572"></span><span>
</span><span id="line-573"></span><span id="local-6989586621684395601"><span id="local-6989586621684395602"><span id="local-6989586621684395603"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#funcallArgs"><span class="hs-identifier hs-type">funcallArgs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-574"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395603"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395602"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395601"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-575"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Diet"><span class="hs-identifier hs-type">Diet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-576"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395603"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395602"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Diet"><span class="hs-identifier hs-type">Diet</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-577"></span><span id="funcallArgs"><span class="annot"><span class="annottext">funcallArgs :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
[(SubExp, Diet)] -&gt; AllocM fromrep torep [(SubExp, Diet)]
</span><a href="Futhark.Pass.ExplicitAllocations.html#funcallArgs"><span class="hs-identifier hs-var hs-var">funcallArgs</span></a></span></span><span> </span><span id="local-6989586621684392708"><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684392708"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-578"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684392707"><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684392707"><span class="hs-identifier hs-var">valargs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684392706"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684392706"><span class="hs-identifier hs-var">ctx_args</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684392705"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684392705"><span class="hs-identifier hs-var">mem_and_size_args</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">WriterT
  ([SubExp], [SubExp]) (AllocM fromrep torep) [(SubExp, Diet)]
-&gt; AllocM fromrep torep ([(SubExp, Diet)], ([SubExp], [SubExp]))
forall w (m :: * -&gt; *) a. WriterT w m a -&gt; m (a, w)
</span><span class="hs-identifier hs-var hs-var">runWriterT</span></span><span> </span><span class="annot"><span class="annottext">(WriterT
   ([SubExp], [SubExp]) (AllocM fromrep torep) [(SubExp, Diet)]
 -&gt; AllocM fromrep torep ([(SubExp, Diet)], ([SubExp], [SubExp])))
-&gt; WriterT
     ([SubExp], [SubExp]) (AllocM fromrep torep) [(SubExp, Diet)]
-&gt; AllocM fromrep torep ([(SubExp, Diet)], ([SubExp], [SubExp]))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-579"></span><span>    </span><span class="annot"><span class="annottext">[(SubExp, Diet)]
-&gt; ((SubExp, Diet)
    -&gt; WriterT
         ([SubExp], [SubExp]) (AllocM fromrep torep) (SubExp, Diet))
-&gt; WriterT
     ([SubExp], [SubExp]) (AllocM fromrep torep) [(SubExp, Diet)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684392708"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">(((SubExp, Diet)
  -&gt; WriterT
       ([SubExp], [SubExp]) (AllocM fromrep torep) (SubExp, Diet))
 -&gt; WriterT
      ([SubExp], [SubExp]) (AllocM fromrep torep) [(SubExp, Diet)])
-&gt; ((SubExp, Diet)
    -&gt; WriterT
         ([SubExp], [SubExp]) (AllocM fromrep torep) (SubExp, Diet))
-&gt; WriterT
     ([SubExp], [SubExp]) (AllocM fromrep torep) [(SubExp, Diet)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684392704"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392704"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684392703"><span class="annot"><span class="annottext">Diet
</span><a href="#local-6989586621684392703"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-580"></span><span>      </span><span id="local-6989586621684392702"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684392702"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep Type
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) Type
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep Type
 -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) Type)
-&gt; AllocM fromrep torep Type
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) Type
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; AllocM fromrep torep Type
forall t (m :: * -&gt; *). HasScope t m =&gt; SubExp -&gt; m Type
</span><a href="Futhark.IR.Prop.TypeOf.html#subExpType"><span class="hs-identifier hs-var">subExpType</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392704"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-581"></span><span>      </span><span id="local-6989586621684392700"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684392700"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep Space
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) Space
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep Space
forall fromrep torep. AllocM fromrep torep Space
</span><a href="Futhark.Pass.ExplicitAllocations.html#askDefaultSpace"><span class="hs-identifier hs-var">askDefaultSpace</span></a></span><span>
</span><span id="line-582"></span><span>      </span><span id="local-6989586621684392699"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392699"><span class="hs-identifier hs-var">arg'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type
-&gt; Space
-&gt; SubExp
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Type
-&gt; Space
-&gt; SubExp
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
</span><a href="Futhark.Pass.ExplicitAllocations.html#linearFuncallArg"><span class="hs-identifier hs-var">linearFuncallArg</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684392702"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684392700"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392704"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-583"></span><span>      </span><span class="annot"><span class="annottext">(SubExp, Diet)
-&gt; WriterT
     ([SubExp], [SubExp]) (AllocM fromrep torep) (SubExp, Diet)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392699"><span class="hs-identifier hs-var">arg'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Diet
</span><a href="#local-6989586621684392703"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-584"></span><span>  </span><span class="annot"><span class="annottext">[(SubExp, Diet)] -&gt; AllocM fromrep torep [(SubExp, Diet)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([(SubExp, Diet)] -&gt; AllocM fromrep torep [(SubExp, Diet)])
-&gt; [(SubExp, Diet)] -&gt; AllocM fromrep torep [(SubExp, Diet)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; (SubExp, Diet)) -&gt; [SubExp] -&gt; [(SubExp, Diet)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="annot"><span class="annottext">Diet
</span><a href="Futhark.IR.Syntax.Core.html#Observe"><span class="hs-identifier hs-var">Observe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684392706"><span class="hs-identifier hs-var">ctx_args</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExp] -&gt; [SubExp]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684392705"><span class="hs-identifier hs-var">mem_and_size_args</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(SubExp, Diet)] -&gt; [(SubExp, Diet)] -&gt; [(SubExp, Diet)]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684392707"><span class="hs-identifier hs-var">valargs</span></a></span><span>
</span><span id="line-585"></span><span>
</span><span id="line-586"></span><span id="local-6989586621684395634"><span id="local-6989586621684395635"><span id="local-6989586621684395636"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#linearFuncallArg"><span class="hs-identifier hs-type">linearFuncallArg</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-587"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395636"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395635"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395634"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-588"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Type"><span class="hs-identifier hs-type">Type</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-589"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-590"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-591"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">WriterT</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395636"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395635"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span></span></span></span><span>
</span><span id="line-592"></span><span id="linearFuncallArg"><span class="annot"><span class="annottext">linearFuncallArg :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Type
-&gt; Space
-&gt; SubExp
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
</span><a href="Futhark.Pass.ExplicitAllocations.html#linearFuncallArg"><span class="hs-identifier hs-var hs-var">linearFuncallArg</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span id="local-6989586621684392608"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684392608"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684392607"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392607"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-593"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684392606"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392606"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684392605"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392605"><span class="hs-identifier hs-var">arg'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep (VName, VName)
-&gt; WriterT
     ([SubExp], [SubExp]) (AllocM fromrep torep) (VName, VName)
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep (VName, VName)
 -&gt; WriterT
      ([SubExp], [SubExp]) (AllocM fromrep torep) (VName, VName))
-&gt; AllocM fromrep torep (VName, VName)
-&gt; WriterT
     ([SubExp], [SubExp]) (AllocM fromrep torep) (VName, VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe Space -&gt; VName -&gt; AllocM fromrep torep (VName, VName)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Maybe Space -&gt; VName -&gt; AllocM fromrep torep (VName, VName)
</span><a href="Futhark.Pass.ExplicitAllocations.html#ensureDirectArray"><span class="hs-identifier hs-var">ensureDirectArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Space -&gt; Maybe Space
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684392608"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392607"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-594"></span><span>  </span><span class="annot"><span class="annottext">([SubExp], [SubExp])
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392606"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-595"></span><span>  </span><span class="annot"><span class="annottext">SubExp
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(SubExp
 -&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp)
-&gt; SubExp
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392605"><span class="hs-identifier hs-var">arg'</span></a></span><span>
</span><span id="line-596"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#linearFuncallArg"><span class="hs-identifier hs-var">linearFuncallArg</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684392604"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392604"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-597"></span><span>  </span><span class="annot"><span class="annottext">SubExp
-&gt; WriterT ([SubExp], [SubExp]) (AllocM fromrep torep) SubExp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392604"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-598"></span><span>
</span><span id="line-599"></span><span id="local-6989586621684395589"><span id="local-6989586621684395590"><span id="local-6989586621684395591"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#explicitAllocationsGeneric"><span class="hs-identifier hs-type">explicitAllocationsGeneric</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-600"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395591"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395590"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395589"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-601"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395591"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395591"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395590"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395590"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-602"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395590"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395591"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395590"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ExpHint"><span class="hs-identifier hs-type">ExpHint</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-603"></span><span>  </span><span class="annot"><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395591"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395590"><span class="hs-identifier hs-type">torep</span></a></span></span></span></span><span>
</span><span id="line-604"></span><span id="explicitAllocationsGeneric"><span class="annot"><span class="annottext">explicitAllocationsGeneric :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
(Op fromrep -&gt; AllocM fromrep torep (Op torep))
-&gt; (Exp torep -&gt; AllocM fromrep torep [ExpHint])
-&gt; Pass fromrep torep
</span><a href="Futhark.Pass.ExplicitAllocations.html#explicitAllocationsGeneric"><span class="hs-identifier hs-var hs-var">explicitAllocationsGeneric</span></a></span></span><span> </span><span id="local-6989586621684392497"><span class="annot"><span class="annottext">Op fromrep -&gt; AllocM fromrep torep (Op torep)
</span><a href="#local-6989586621684392497"><span class="hs-identifier hs-var">handleOp</span></a></span></span><span> </span><span id="local-6989586621684392496"><span class="annot"><span class="annottext">Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="#local-6989586621684392496"><span class="hs-identifier hs-var">hints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-605"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; String
-&gt; (Prog fromrep -&gt; PassM (Prog torep))
-&gt; Pass fromrep torep
forall fromrep torep.
String
-&gt; String
-&gt; (Prog fromrep -&gt; PassM (Prog torep))
-&gt; Pass fromrep torep
</span><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-var">Pass</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;explicit allocations&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Transform program to explicit memory representation&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Prog fromrep -&gt; PassM (Prog torep)) -&gt; Pass fromrep torep)
-&gt; (Prog fromrep -&gt; PassM (Prog torep)) -&gt; Pass fromrep torep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-606"></span><span>    </span><span class="annot"><span class="annottext">(Stms fromrep -&gt; PassM (Stms torep))
-&gt; (Stms torep -&gt; FunDef fromrep -&gt; PassM (FunDef torep))
-&gt; Prog fromrep
-&gt; PassM (Prog torep)
forall fromrep torep.
(Stms fromrep -&gt; PassM (Stms torep))
-&gt; (Stms torep -&gt; FunDef fromrep -&gt; PassM (FunDef torep))
-&gt; Prog fromrep
-&gt; PassM (Prog torep)
</span><a href="Futhark.Pass.html#intraproceduralTransformationWithConsts"><span class="hs-identifier hs-var">intraproceduralTransformationWithConsts</span></a></span><span> </span><span class="annot"><span class="annottext">Stms fromrep -&gt; PassM (Stms torep)
</span><a href="#local-6989586621684392493"><span class="hs-identifier hs-var">onStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms torep -&gt; FunDef fromrep -&gt; PassM (FunDef torep)
</span><a href="#local-6989586621684392492"><span class="hs-identifier hs-var">allocInFun</span></a></span><span>
</span><span id="line-607"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-608"></span><span>    </span><span id="local-6989586621684392493"><span class="annot"><span class="annottext">onStms :: Stms fromrep -&gt; PassM (Stms torep)
</span><a href="#local-6989586621684392493"><span class="hs-identifier hs-var hs-var">onStms</span></a></span></span><span> </span><span id="local-6989586621684392491"><span class="annot"><span class="annottext">Stms fromrep
</span><a href="#local-6989586621684392491"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-609"></span><span>      </span><span class="annot"><span class="annottext">(Op fromrep -&gt; AllocM fromrep torep (Op torep))
-&gt; (Exp torep -&gt; AllocM fromrep torep [ExpHint])
-&gt; AllocM fromrep torep (Stms torep)
-&gt; PassM (Stms torep)
forall (m :: * -&gt; *) fromrep torep a.
MonadFreshNames m =&gt;
(Op fromrep -&gt; AllocM fromrep torep (Op torep))
-&gt; (Exp torep -&gt; AllocM fromrep torep [ExpHint])
-&gt; AllocM fromrep torep a
-&gt; m a
</span><a href="Futhark.Pass.ExplicitAllocations.html#runAllocM"><span class="hs-identifier hs-var">runAllocM</span></a></span><span> </span><span class="annot"><span class="annottext">Op fromrep -&gt; AllocM fromrep torep (Op torep)
</span><a href="#local-6989586621684392497"><span class="hs-identifier hs-var">handleOp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="#local-6989586621684392496"><span class="hs-identifier hs-var">hints</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep (Stms torep) -&gt; PassM (Stms torep))
-&gt; AllocM fromrep torep (Stms torep) -&gt; PassM (Stms torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep ()
-&gt; AllocM fromrep torep (Stms (Rep (AllocM fromrep torep)))
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; m a -&gt; m (Stms (Rep m))
</span><a href="Futhark.Builder.Class.html#collectStms_"><span class="hs-identifier hs-var">collectStms_</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep ()
 -&gt; AllocM fromrep torep (Stms (Rep (AllocM fromrep torep))))
-&gt; AllocM fromrep torep ()
-&gt; AllocM fromrep torep (Stms (Rep (AllocM fromrep torep)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms fromrep -&gt; AllocM fromrep torep () -&gt; AllocM fromrep torep ()
forall fromrep torep inner a.
Allocable fromrep torep inner =&gt;
Stms fromrep -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInStms"><span class="hs-identifier hs-var">allocInStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms fromrep
</span><a href="#local-6989586621684392491"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep () -&gt; AllocM fromrep torep ())
-&gt; AllocM fromrep torep () -&gt; AllocM fromrep torep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; AllocM fromrep torep ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-610"></span><span>
</span><span id="line-611"></span><span>    </span><span id="local-6989586621684392492"><span class="annot"><span class="annottext">allocInFun :: Stms torep -&gt; FunDef fromrep -&gt; PassM (FunDef torep)
</span><a href="#local-6989586621684392492"><span class="hs-identifier hs-var hs-var">allocInFun</span></a></span></span><span> </span><span id="local-6989586621684392489"><span class="annot"><span class="annottext">Stms torep
</span><a href="#local-6989586621684392489"><span class="hs-identifier hs-var">consts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span id="local-6989586621684392487"><span class="annot"><span class="annottext">Maybe EntryPoint
</span><a href="#local-6989586621684392487"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span id="local-6989586621684392486"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684392486"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684392485"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684392485"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span id="local-6989586621684392484"><span class="annot"><span class="annottext">[RetType fromrep]
</span><a href="#local-6989586621684392484"><span class="hs-identifier hs-var">rettype</span></a></span></span><span> </span><span id="local-6989586621684392483"><span class="annot"><span class="annottext">[FParam fromrep]
</span><a href="#local-6989586621684392483"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684392482"><span class="annot"><span class="annottext">BodyT fromrep
</span><a href="#local-6989586621684392482"><span class="hs-identifier hs-var">fbody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-612"></span><span>      </span><span class="annot"><span class="annottext">(Op fromrep -&gt; AllocM fromrep torep (Op torep))
-&gt; (Exp torep -&gt; AllocM fromrep torep [ExpHint])
-&gt; AllocM fromrep torep (FunDef torep)
-&gt; PassM (FunDef torep)
forall (m :: * -&gt; *) fromrep torep a.
MonadFreshNames m =&gt;
(Op fromrep -&gt; AllocM fromrep torep (Op torep))
-&gt; (Exp torep -&gt; AllocM fromrep torep [ExpHint])
-&gt; AllocM fromrep torep a
-&gt; m a
</span><a href="Futhark.Pass.ExplicitAllocations.html#runAllocM"><span class="hs-identifier hs-var">runAllocM</span></a></span><span> </span><span class="annot"><span class="annottext">Op fromrep -&gt; AllocM fromrep torep (Op torep)
</span><a href="#local-6989586621684392497"><span class="hs-identifier hs-var">handleOp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="#local-6989586621684392496"><span class="hs-identifier hs-var">hints</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep (FunDef torep) -&gt; PassM (FunDef torep))
-&gt; (AllocM fromrep torep (FunDef torep)
    -&gt; AllocM fromrep torep (FunDef torep))
-&gt; AllocM fromrep torep (FunDef torep)
-&gt; PassM (FunDef torep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms torep
-&gt; AllocM fromrep torep (FunDef torep)
-&gt; AllocM fromrep torep (FunDef torep)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms torep
</span><a href="#local-6989586621684392489"><span class="hs-identifier hs-var">consts</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep (FunDef torep) -&gt; PassM (FunDef torep))
-&gt; AllocM fromrep torep (FunDef torep) -&gt; PassM (FunDef torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-613"></span><span>        </span><span class="annot"><span class="annottext">[(FParam fromrep, Space)]
-&gt; ([FParam torep] -&gt; AllocM fromrep torep (FunDef torep))
-&gt; AllocM fromrep torep (FunDef torep)
forall fromrep torep inner a.
Allocable fromrep torep inner =&gt;
[(FParam fromrep, Space)]
-&gt; ([FParam torep] -&gt; AllocM fromrep torep a)
-&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInFParams"><span class="hs-identifier hs-var">allocInFParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param DeclType] -&gt; [Space] -&gt; [(Param DeclType, Space)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param DeclType]
[FParam fromrep]
</span><a href="#local-6989586621684392483"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">([Space] -&gt; [(Param DeclType, Space)])
-&gt; [Space] -&gt; [(Param DeclType, Space)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; [Space]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([FParam torep] -&gt; AllocM fromrep torep (FunDef torep))
 -&gt; AllocM fromrep torep (FunDef torep))
-&gt; ([FParam torep] -&gt; AllocM fromrep torep (FunDef torep))
-&gt; AllocM fromrep torep (FunDef torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684392480"><span class="annot"><span class="annottext">[FParam torep]
</span><a href="#local-6989586621684392480"><span class="hs-identifier hs-var">params'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-614"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684392479"><span class="annot"><span class="annottext">Body torep
</span><a href="#local-6989586621684392479"><span class="hs-identifier hs-var">fbody'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684392478"><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684392478"><span class="hs-identifier hs-var">mem_rets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-615"></span><span>            </span><span class="annot"><span class="annottext">[Maybe Space]
-&gt; BodyT fromrep -&gt; AllocM fromrep torep (Body torep, [RetTypeMem])
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
[Maybe Space]
-&gt; Body fromrep -&gt; AllocM fromrep torep (Body torep, [RetTypeMem])
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInFunBody"><span class="hs-identifier hs-var">allocInFunBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DeclExtType -&gt; Maybe Space) -&gt; [DeclExtType] -&gt; [Maybe Space]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Space -&gt; DeclExtType -&gt; Maybe Space
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Space -&gt; DeclExtType -&gt; Maybe Space)
-&gt; Maybe Space -&gt; DeclExtType -&gt; Maybe Space
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; Maybe Space
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DeclExtType]
[RetType fromrep]
</span><a href="#local-6989586621684392484"><span class="hs-identifier hs-var">rettype</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">BodyT fromrep
</span><a href="#local-6989586621684392482"><span class="hs-identifier hs-var">fbody</span></a></span><span>
</span><span id="line-616"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684392475"><span class="annot"><span class="annottext">rettype' :: [RetTypeMem]
</span><a href="#local-6989586621684392475"><span class="hs-identifier hs-var hs-var">rettype'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684392478"><span class="hs-identifier hs-var">mem_rets</span></a></span><span> </span><span class="annot"><span class="annottext">[RetTypeMem] -&gt; [RetTypeMem] -&gt; [RetTypeMem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [DeclExtType] -&gt; [RetTypeMem]
</span><a href="Futhark.Pass.ExplicitAllocations.html#memoryInDeclExtType"><span class="hs-identifier hs-var">memoryInDeclExtType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[RetTypeMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684392478"><span class="hs-identifier hs-var">mem_rets</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DeclExtType]
[RetType fromrep]
</span><a href="#local-6989586621684392484"><span class="hs-identifier hs-var">rettype</span></a></span><span>
</span><span id="line-617"></span><span>          </span><span class="annot"><span class="annottext">FunDef torep -&gt; AllocM fromrep torep (FunDef torep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(FunDef torep -&gt; AllocM fromrep torep (FunDef torep))
-&gt; FunDef torep -&gt; AllocM fromrep torep (FunDef torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe EntryPoint
-&gt; Attrs
-&gt; Name
-&gt; [RetType torep]
-&gt; [FParam torep]
-&gt; Body torep
-&gt; FunDef torep
forall rep.
Maybe EntryPoint
-&gt; Attrs
-&gt; Name
-&gt; [RetType rep]
-&gt; [FParam rep]
-&gt; BodyT rep
-&gt; FunDef rep
</span><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-var">FunDef</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EntryPoint
</span><a href="#local-6989586621684392487"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684392486"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684392485"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">[RetType torep]
[RetTypeMem]
</span><a href="#local-6989586621684392475"><span class="hs-identifier hs-var">rettype'</span></a></span><span> </span><span class="annot"><span class="annottext">[FParam torep]
</span><a href="#local-6989586621684392480"><span class="hs-identifier hs-var">params'</span></a></span><span> </span><span class="annot"><span class="annottext">Body torep
</span><a href="#local-6989586621684392479"><span class="hs-identifier hs-var">fbody'</span></a></span><span>
</span><span id="line-618"></span><span>
</span><span id="line-619"></span><span id="local-6989586621684395554"><span id="local-6989586621684395555"><span id="local-6989586621684395556"><span id="local-6989586621684395557"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#explicitAllocationsInStmsGeneric"><span class="hs-identifier hs-type">explicitAllocationsInStmsGeneric</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-620"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395557"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-621"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395556"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395557"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-622"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395555"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395556"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395554"><span class="hs-identifier hs-type">inner</span></a></span><span>
</span><span id="line-623"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-624"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395555"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395555"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395556"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395556"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-625"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395556"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395555"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395556"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ExpHint"><span class="hs-identifier hs-type">ExpHint</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-626"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395555"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-627"></span><span>  </span><span class="annot"><a href="#local-6989586621684395557"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395556"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span></span></span></span></span><span>
</span><span id="line-628"></span><span id="explicitAllocationsInStmsGeneric"><span class="annot"><span class="annottext">explicitAllocationsInStmsGeneric :: forall (m :: * -&gt; *) torep fromrep inner.
(MonadFreshNames m, HasScope torep m,
 Allocable fromrep torep inner) =&gt;
(Op fromrep -&gt; AllocM fromrep torep (Op torep))
-&gt; (Exp torep -&gt; AllocM fromrep torep [ExpHint])
-&gt; Stms fromrep
-&gt; m (Stms torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#explicitAllocationsInStmsGeneric"><span class="hs-identifier hs-var hs-var">explicitAllocationsInStmsGeneric</span></a></span></span><span> </span><span id="local-6989586621684392377"><span class="annot"><span class="annottext">Op fromrep -&gt; AllocM fromrep torep (Op torep)
</span><a href="#local-6989586621684392377"><span class="hs-identifier hs-var">handleOp</span></a></span></span><span> </span><span id="local-6989586621684392376"><span class="annot"><span class="annottext">Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="#local-6989586621684392376"><span class="hs-identifier hs-var">hints</span></a></span></span><span> </span><span id="local-6989586621684392375"><span class="annot"><span class="annottext">Stms fromrep
</span><a href="#local-6989586621684392375"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-629"></span><span>  </span><span id="local-6989586621684392374"><span class="annot"><span class="annottext">Scope torep
</span><a href="#local-6989586621684392374"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (Scope torep)
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-630"></span><span>  </span><span class="annot"><span class="annottext">(Op fromrep -&gt; AllocM fromrep torep (Op torep))
-&gt; (Exp torep -&gt; AllocM fromrep torep [ExpHint])
-&gt; AllocM fromrep torep (Stms torep)
-&gt; m (Stms torep)
forall (m :: * -&gt; *) fromrep torep a.
MonadFreshNames m =&gt;
(Op fromrep -&gt; AllocM fromrep torep (Op torep))
-&gt; (Exp torep -&gt; AllocM fromrep torep [ExpHint])
-&gt; AllocM fromrep torep a
-&gt; m a
</span><a href="Futhark.Pass.ExplicitAllocations.html#runAllocM"><span class="hs-identifier hs-var">runAllocM</span></a></span><span> </span><span class="annot"><span class="annottext">Op fromrep -&gt; AllocM fromrep torep (Op torep)
</span><a href="#local-6989586621684392377"><span class="hs-identifier hs-var">handleOp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp torep -&gt; AllocM fromrep torep [ExpHint]
</span><a href="#local-6989586621684392376"><span class="hs-identifier hs-var">hints</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep (Stms torep) -&gt; m (Stms torep))
-&gt; AllocM fromrep torep (Stms torep) -&gt; m (Stms torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-631"></span><span>    </span><span class="annot"><span class="annottext">Scope torep
-&gt; AllocM fromrep torep (Stms torep)
-&gt; AllocM fromrep torep (Stms torep)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope torep
</span><a href="#local-6989586621684392374"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep (Stms torep)
 -&gt; AllocM fromrep torep (Stms torep))
-&gt; AllocM fromrep torep (Stms torep)
-&gt; AllocM fromrep torep (Stms torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep ()
-&gt; AllocM fromrep torep (Stms (Rep (AllocM fromrep torep)))
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; m a -&gt; m (Stms (Rep m))
</span><a href="Futhark.Builder.Class.html#collectStms_"><span class="hs-identifier hs-var">collectStms_</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep ()
 -&gt; AllocM fromrep torep (Stms (Rep (AllocM fromrep torep))))
-&gt; AllocM fromrep torep ()
-&gt; AllocM fromrep torep (Stms (Rep (AllocM fromrep torep)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms fromrep -&gt; AllocM fromrep torep () -&gt; AllocM fromrep torep ()
forall fromrep torep inner a.
Allocable fromrep torep inner =&gt;
Stms fromrep -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInStms"><span class="hs-identifier hs-var">allocInStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms fromrep
</span><a href="#local-6989586621684392375"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep () -&gt; AllocM fromrep torep ())
-&gt; AllocM fromrep torep () -&gt; AllocM fromrep torep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">() -&gt; AllocM fromrep torep ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-632"></span><span>
</span><span id="line-633"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#memoryInDeclExtType"><span class="hs-identifier hs-type">memoryInDeclExtType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DeclExtType"><span class="hs-identifier hs-type">DeclExtType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Mem.html#FunReturns"><span class="hs-identifier hs-type">FunReturns</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-634"></span><span id="memoryInDeclExtType"><span class="annot"><span class="annottext">memoryInDeclExtType :: Int -&gt; [DeclExtType] -&gt; [RetTypeMem]
</span><a href="Futhark.Pass.ExplicitAllocations.html#memoryInDeclExtType"><span class="hs-identifier hs-var hs-var">memoryInDeclExtType</span></a></span></span><span> </span><span id="local-6989586621684392371"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684392371"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span id="local-6989586621684392370"><span class="annot"><span class="annottext">[DeclExtType]
</span><a href="#local-6989586621684392370"><span class="hs-identifier hs-var">dets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State Int [RetTypeMem] -&gt; Int -&gt; [RetTypeMem]
forall s a. State s a -&gt; s -&gt; a
</span><span class="hs-identifier hs-var">evalState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DeclExtType -&gt; StateT Int Identity RetTypeMem)
-&gt; [DeclExtType] -&gt; State Int [RetTypeMem]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DeclExtType -&gt; StateT Int Identity RetTypeMem
</span><a href="#local-6989586621684392368"><span class="hs-identifier hs-var">addMem</span></a></span><span> </span><span class="annot"><span class="annottext">[DeclExtType]
</span><a href="#local-6989586621684392370"><span class="hs-identifier hs-var">dets</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-635"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-636"></span><span>    </span><span id="local-6989586621684392368"><span class="annot"><span class="annottext">addMem :: DeclExtType -&gt; StateT Int Identity RetTypeMem
</span><a href="#local-6989586621684392368"><span class="hs-identifier hs-var hs-var">addMem</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684392367"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684392367"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetTypeMem -&gt; StateT Int Identity RetTypeMem
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(RetTypeMem -&gt; StateT Int Identity RetTypeMem)
-&gt; RetTypeMem -&gt; StateT Int Identity RetTypeMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; RetTypeMem
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684392367"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-637"></span><span>    </span><span class="annot"><a href="#local-6989586621684392368"><span class="hs-identifier hs-var">addMem</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; StateT Int Identity RetTypeMem
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;memoryInDeclExtType: too much memory&quot;</span></span><span>
</span><span id="line-638"></span><span>    </span><span class="annot"><a href="#local-6989586621684392368"><span class="hs-identifier hs-var">addMem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684392366"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684392366"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684392365"><span class="annot"><span class="annottext">ExtShape
</span><a href="#local-6989586621684392365"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684392364"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684392364"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-639"></span><span>      </span><span id="local-6989586621684392363"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684392363"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT Int Identity Int
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span> </span><span class="annot"><span class="annottext">StateT Int Identity Int
-&gt; StateT Int Identity () -&gt; StateT Int Identity Int
forall (f :: * -&gt; *) a b. Applicative f =&gt; f a -&gt; f b -&gt; f a
</span><span class="hs-operator hs-var">&lt;*</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; StateT Int Identity ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-640"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684392358"><span class="annot"><span class="annottext">shape' :: ExtShape
</span><a href="#local-6989586621684392358"><span class="hs-identifier hs-var hs-var">shape'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ext SubExp -&gt; Ext SubExp) -&gt; ExtShape -&gt; ExtShape
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Ext SubExp -&gt; Ext SubExp
</span><a href="#local-6989586621684392357"><span class="hs-identifier hs-var">shift</span></a></span><span> </span><span class="annot"><span class="annottext">ExtShape
</span><a href="#local-6989586621684392365"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-641"></span><span>      </span><span class="annot"><span class="annottext">RetTypeMem -&gt; StateT Int Identity RetTypeMem
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(RetTypeMem -&gt; StateT Int Identity RetTypeMem)
-&gt; (ExtIxFun -&gt; RetTypeMem)
-&gt; ExtIxFun
-&gt; StateT Int Identity RetTypeMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ExtShape -&gt; Uniqueness -&gt; MemReturn -&gt; RetTypeMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684392366"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">ExtShape
</span><a href="#local-6989586621684392358"><span class="hs-identifier hs-var">shape'</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684392364"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemReturn -&gt; RetTypeMem)
-&gt; (ExtIxFun -&gt; MemReturn) -&gt; ExtIxFun -&gt; RetTypeMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; Int -&gt; ExtIxFun -&gt; MemReturn
</span><a href="Futhark.IR.Mem.html#ReturnsNewBlock"><span class="hs-identifier hs-var">ReturnsNewBlock</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684392363"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtIxFun -&gt; StateT Int Identity RetTypeMem)
-&gt; ExtIxFun -&gt; StateT Int Identity RetTypeMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-642"></span><span>        </span><span class="annot"><span class="annottext">[TPrimExp Int64 (Ext VName)] -&gt; ExtIxFun
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 (Ext VName)] -&gt; ExtIxFun)
-&gt; [TPrimExp Int64 (Ext VName)] -&gt; ExtIxFun
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Ext SubExp -&gt; TPrimExp Int64 (Ext VName))
-&gt; [Ext SubExp] -&gt; [TPrimExp Int64 (Ext VName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Ext SubExp -&gt; TPrimExp Int64 (Ext VName)
</span><a href="#local-6989586621684392356"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="annot"><span class="annottext">([Ext SubExp] -&gt; [TPrimExp Int64 (Ext VName)])
-&gt; [Ext SubExp] -&gt; [TPrimExp Int64 (Ext VName)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtShape -&gt; [Ext SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">ExtShape
</span><a href="#local-6989586621684392358"><span class="hs-identifier hs-var">shape'</span></a></span><span>
</span><span id="line-643"></span><span>    </span><span class="annot"><a href="#local-6989586621684392368"><span class="hs-identifier hs-var">addMem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span id="local-6989586621684392355"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392355"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684392354"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684392354"><span class="hs-identifier hs-var">ispace</span></a></span></span><span> </span><span id="local-6989586621684392353"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684392353"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684392352"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684392352"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetTypeMem -&gt; StateT Int Identity RetTypeMem
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(RetTypeMem -&gt; StateT Int Identity RetTypeMem)
-&gt; RetTypeMem -&gt; StateT Int Identity RetTypeMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Shape -&gt; [Type] -&gt; Uniqueness -&gt; RetTypeMem
forall d u ret. VName -&gt; Shape -&gt; [Type] -&gt; u -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-var">MemAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392355"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684392354"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684392353"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684392352"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-644"></span><span>
</span><span id="line-645"></span><span>    </span><span id="local-6989586621684392356"><span class="annot"><span class="annottext">convert :: Ext SubExp -&gt; TPrimExp Int64 (Ext VName)
</span><a href="#local-6989586621684392356"><span class="hs-identifier hs-var hs-var">convert</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span id="local-6989586621684392350"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684392350"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ext VName -&gt; TPrimExp Int64 (Ext VName)
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">le64</span></a></span><span> </span><span class="annot"><span class="annottext">(Ext VName -&gt; TPrimExp Int64 (Ext VName))
-&gt; Ext VName -&gt; TPrimExp Int64 (Ext VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Ext VName
forall a. Int -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-var">Ext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684392350"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-646"></span><span>    </span><span class="annot"><a href="#local-6989586621684392356"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-type">Free</span></a></span><span> </span><span id="local-6989586621684392349"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392349"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Ext VName
forall a. a -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-var">Free</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Ext VName)
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 (Ext VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392349"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-647"></span><span>
</span><span id="line-648"></span><span>    </span><span id="local-6989586621684392357"><span class="annot"><span class="annottext">shift :: Ext SubExp -&gt; Ext SubExp
</span><a href="#local-6989586621684392357"><span class="hs-identifier hs-var hs-var">shift</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span id="local-6989586621684392348"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684392348"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Ext SubExp
forall a. Int -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-var">Ext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684392348"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684392371"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-649"></span><span>    </span><span class="annot"><a href="#local-6989586621684392357"><span class="hs-identifier hs-var">shift</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-type">Free</span></a></span><span> </span><span id="local-6989586621684392347"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392347"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Ext SubExp
forall a. a -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-var">Free</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392347"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-650"></span><span>
</span><span id="line-651"></span><span id="local-6989586621684395539"><span id="local-6989586621684395541"><span id="local-6989586621684395542"><span id="local-6989586621684395543"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#bodyReturnMemCtx"><span class="hs-identifier hs-type">bodyReturnMemCtx</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-652"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395543"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395542"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395541"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-653"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-654"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395543"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395542"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemInfo"><span class="hs-identifier hs-type">MemInfo</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ExtSize"><span class="hs-identifier hs-type">ExtSize</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395539"><span class="hs-identifier hs-type">u</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemReturn"><span class="hs-identifier hs-type">MemReturn</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span></span></span></span><span>
</span><span id="line-655"></span><span id="bodyReturnMemCtx"><span class="annot"><span class="annottext">bodyReturnMemCtx :: forall fromrep torep inner u.
Allocable fromrep torep inner =&gt;
SubExpRes
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
</span><a href="Futhark.Pass.ExplicitAllocations.html#bodyReturnMemCtx"><span class="hs-identifier hs-var hs-var">bodyReturnMemCtx</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-656"></span><span>  </span><span class="annot"><span class="annottext">[(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-657"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#bodyReturnMemCtx"><span class="hs-identifier hs-var">bodyReturnMemCtx</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684392289"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392289"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-658"></span><span>  </span><span id="local-6989586621684392288"><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684392288"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; AllocM fromrep torep LParamMem
forall rep (m :: * -&gt; *) inner.
(HasScope rep m, Mem rep inner) =&gt;
VName -&gt; m LParamMem
</span><a href="Futhark.IR.Mem.html#lookupMemInfo"><span class="hs-identifier hs-var">lookupMemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392289"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-659"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684392288"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-660"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-type">MemPrim</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-661"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-type">MemAcc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-662"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-type">MemMem</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-comment">-- should not happen</span><span>
</span><span id="line-663"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684392286"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392286"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-664"></span><span>      </span><span id="local-6989586621684392285"><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684392285"><span class="hs-identifier hs-var">mem_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; AllocM fromrep torep LParamMem
forall rep (m :: * -&gt; *) inner.
(HasScope rep m, Mem rep inner) =&gt;
VName -&gt; m LParamMem
</span><a href="Futhark.IR.Mem.html#lookupMemInfo"><span class="hs-identifier hs-var">lookupMemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392286"><span class="hs-identifier hs-var">mem</span></a></span><span>
</span><span id="line-665"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684392285"><span class="hs-identifier hs-var">mem_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-666"></span><span>        </span><span class="annot"><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-type">MemMem</span></a></span><span> </span><span id="local-6989586621684392284"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684392284"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-667"></span><span>          </span><span class="annot"><span class="annottext">[(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; SubExpRes
</span><a href="Futhark.IR.Syntax.html#subExpRes"><span class="hs-identifier hs-var">subExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExpRes) -&gt; SubExp -&gt; SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392286"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space -&gt; MemInfo (Ext SubExp) u MemReturn
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684392284"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-668"></span><span>        </span><span class="annot"><span class="annottext">LParamMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String
 -&gt; AllocM
      fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)])
-&gt; String
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bodyReturnMemCtx: not a memory block: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392286"><span class="hs-identifier hs-var">mem</span></a></span><span>
</span><span id="line-669"></span><span>
</span><span id="line-670"></span><span id="local-6989586621684395561"><span id="local-6989586621684395562"><span id="local-6989586621684395563"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInFunBody"><span class="hs-identifier hs-type">allocInFunBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-671"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395563"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395562"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395561"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-672"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-673"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395563"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-674"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395563"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395562"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395562"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Mem.html#FunReturns"><span class="hs-identifier hs-type">FunReturns</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-675"></span><span id="allocInFunBody"><span class="annot"><span class="annottext">allocInFunBody :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
[Maybe Space]
-&gt; Body fromrep -&gt; AllocM fromrep torep (Body torep, [RetTypeMem])
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInFunBody"><span class="hs-identifier hs-var hs-var">allocInFunBody</span></a></span></span><span> </span><span id="local-6989586621684392174"><span class="annot"><span class="annottext">[Maybe Space]
</span><a href="#local-6989586621684392174"><span class="hs-identifier hs-var">space_oks</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec fromrep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684392173"><span class="annot"><span class="annottext">Stms fromrep
</span><a href="#local-6989586621684392173"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684392172"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684392172"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-676"></span><span>  </span><span class="annot"><span class="annottext">AllocM fromrep torep (Result, [RetTypeMem])
-&gt; AllocM fromrep torep (BodyT torep, [RetTypeMem])
forall (m :: * -&gt; *) a.
MonadBuilder m =&gt;
m (Result, a) -&gt; m (Body (Rep m), a)
</span><a href="Futhark.Construct.html#buildBody"><span class="hs-identifier hs-var">buildBody</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep (Result, [RetTypeMem])
 -&gt; AllocM fromrep torep (BodyT torep, [RetTypeMem]))
-&gt; (AllocM fromrep torep (Result, [RetTypeMem])
    -&gt; AllocM fromrep torep (Result, [RetTypeMem]))
-&gt; AllocM fromrep torep (Result, [RetTypeMem])
-&gt; AllocM fromrep torep (BodyT torep, [RetTypeMem])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms fromrep
-&gt; AllocM fromrep torep (Result, [RetTypeMem])
-&gt; AllocM fromrep torep (Result, [RetTypeMem])
forall fromrep torep inner a.
Allocable fromrep torep inner =&gt;
Stms fromrep -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInStms"><span class="hs-identifier hs-var">allocInStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms fromrep
</span><a href="#local-6989586621684392173"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep (Result, [RetTypeMem])
 -&gt; AllocM fromrep torep (BodyT torep, [RetTypeMem]))
-&gt; AllocM fromrep torep (Result, [RetTypeMem])
-&gt; AllocM fromrep torep (BodyT torep, [RetTypeMem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-677"></span><span>    </span><span id="local-6989586621684392170"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684392170"><span class="hs-identifier hs-var">res'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Maybe Space -&gt; SubExpRes -&gt; AllocM fromrep torep SubExpRes)
-&gt; [Maybe Space] -&gt; Result -&gt; AllocM fromrep torep Result
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">Maybe Space -&gt; SubExpRes -&gt; AllocM fromrep torep SubExpRes
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Maybe Space -&gt; SubExpRes -&gt; AllocM fromrep torep SubExpRes
</span><a href="Futhark.Pass.ExplicitAllocations.html#ensureDirect"><span class="hs-identifier hs-var">ensureDirect</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Space]
</span><a href="#local-6989586621684392168"><span class="hs-identifier hs-var">space_oks'</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684392172"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-678"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684392167"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684392167"><span class="hs-identifier hs-var">mem_ctx_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684392166"><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684392166"><span class="hs-identifier hs-var">mem_ctx_rets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(SubExpRes, RetTypeMem)] -&gt; (Result, [RetTypeMem])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(SubExpRes, RetTypeMem)] -&gt; (Result, [RetTypeMem]))
-&gt; ([[(SubExpRes, RetTypeMem)]] -&gt; [(SubExpRes, RetTypeMem)])
-&gt; [[(SubExpRes, RetTypeMem)]]
-&gt; (Result, [RetTypeMem])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[[(SubExpRes, RetTypeMem)]] -&gt; [(SubExpRes, RetTypeMem)]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[(SubExpRes, RetTypeMem)]] -&gt; (Result, [RetTypeMem]))
-&gt; AllocM fromrep torep [[(SubExpRes, RetTypeMem)]]
-&gt; AllocM fromrep torep (Result, [RetTypeMem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; AllocM fromrep torep [(SubExpRes, RetTypeMem)])
-&gt; Result -&gt; AllocM fromrep torep [[(SubExpRes, RetTypeMem)]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; AllocM fromrep torep [(SubExpRes, RetTypeMem)]
forall fromrep torep inner u.
Allocable fromrep torep inner =&gt;
SubExpRes
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
</span><a href="Futhark.Pass.ExplicitAllocations.html#bodyReturnMemCtx"><span class="hs-identifier hs-var">bodyReturnMemCtx</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684392170"><span class="hs-identifier hs-var">res'</span></a></span><span>
</span><span id="line-679"></span><span>    </span><span class="annot"><span class="annottext">(Result, [RetTypeMem])
-&gt; AllocM fromrep torep (Result, [RetTypeMem])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684392167"><span class="hs-identifier hs-var">mem_ctx_res</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684392170"><span class="hs-identifier hs-var">res'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684392166"><span class="hs-identifier hs-var">mem_ctx_rets</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-680"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-681"></span><span>    </span><span id="local-6989586621684392164"><span class="annot"><span class="annottext">num_vals :: Int
</span><a href="#local-6989586621684392164"><span class="hs-identifier hs-var hs-var">num_vals</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Maybe Space] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Maybe Space]
</span><a href="#local-6989586621684392174"><span class="hs-identifier hs-var">space_oks</span></a></span><span>
</span><span id="line-682"></span><span>    </span><span id="local-6989586621684392168"><span class="annot"><span class="annottext">space_oks' :: [Maybe Space]
</span><a href="#local-6989586621684392168"><span class="hs-identifier hs-var hs-var">space_oks'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Maybe Space -&gt; [Maybe Space]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684392172"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684392164"><span class="hs-identifier hs-var">num_vals</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Space
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">[Maybe Space] -&gt; [Maybe Space] -&gt; [Maybe Space]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Maybe Space]
</span><a href="#local-6989586621684392174"><span class="hs-identifier hs-var">space_oks</span></a></span><span>
</span><span id="line-683"></span><span>
</span><span id="line-684"></span><span id="local-6989586621684395524"><span id="local-6989586621684395525"><span id="local-6989586621684395526"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ensureDirect"><span class="hs-identifier hs-type">ensureDirect</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-685"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395526"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395525"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395524"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-686"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-687"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-688"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395526"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395525"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span></span></span></span><span>
</span><span id="line-689"></span><span id="ensureDirect"><span class="annot"><span class="annottext">ensureDirect :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Maybe Space -&gt; SubExpRes -&gt; AllocM fromrep torep SubExpRes
</span><a href="Futhark.Pass.ExplicitAllocations.html#ensureDirect"><span class="hs-identifier hs-var hs-var">ensureDirect</span></a></span></span><span> </span><span id="local-6989586621684392074"><span class="annot"><span class="annottext">Maybe Space
</span><a href="#local-6989586621684392074"><span class="hs-identifier hs-var">space_ok</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684392073"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684392073"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684392072"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392072"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-690"></span><span>  </span><span id="local-6989586621684392071"><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684392071"><span class="hs-identifier hs-var">se_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; AllocM fromrep torep LParamMem
forall rep (m :: * -&gt; *) inner.
(HasScope rep m, Monad m, Mem rep inner) =&gt;
SubExp -&gt; m LParamMem
</span><a href="Futhark.IR.Mem.html#subExpMemInfo"><span class="hs-identifier hs-var">subExpMemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392072"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-691"></span><span>  </span><span class="annot"><span class="annottext">Certs -&gt; SubExp -&gt; SubExpRes
</span><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-var">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684392073"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExpRes)
-&gt; AllocM fromrep torep SubExp -&gt; AllocM fromrep torep SubExpRes
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684392071"><span class="hs-identifier hs-var">se_info</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392072"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-692"></span><span>    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684392069"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392069"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-693"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684392068"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392068"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Space -&gt; VName -&gt; AllocM fromrep torep (VName, VName)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Maybe Space -&gt; VName -&gt; AllocM fromrep torep (VName, VName)
</span><a href="Futhark.Pass.ExplicitAllocations.html#ensureDirectArray"><span class="hs-identifier hs-var">ensureDirectArray</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Space
</span><a href="#local-6989586621684392074"><span class="hs-identifier hs-var">space_ok</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392069"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-694"></span><span>      </span><span class="annot"><span class="annottext">SubExp -&gt; AllocM fromrep torep SubExp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; AllocM fromrep torep SubExp)
-&gt; SubExp -&gt; AllocM fromrep torep SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684392068"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-695"></span><span>    </span><span class="annot"><span class="annottext">(LParamMem, SubExp)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-696"></span><span>      </span><span class="annot"><span class="annottext">SubExp -&gt; AllocM fromrep torep SubExp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684392072"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-697"></span><span>
</span><span id="line-698"></span><span id="local-6989586621684395570"><span id="local-6989586621684395571"><span id="local-6989586621684395572"><span id="local-6989586621684395573"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInStms"><span class="hs-identifier hs-type">allocInStms</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-699"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395573"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395572"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395571"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-700"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395573"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-701"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395573"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395572"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395570"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-702"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395573"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395572"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395570"><span class="hs-identifier hs-type">a</span></a></span></span></span></span></span><span>
</span><span id="line-703"></span><span id="allocInStms"><span class="annot"><span class="annottext">allocInStms :: forall fromrep torep inner a.
Allocable fromrep torep inner =&gt;
Stms fromrep -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInStms"><span class="hs-identifier hs-var hs-var">allocInStms</span></a></span></span><span> </span><span id="local-6989586621684391964"><span class="annot"><span class="annottext">Stms fromrep
</span><a href="#local-6989586621684391964"><span class="hs-identifier hs-var">origstms</span></a></span></span><span> </span><span id="local-6989586621684391963"><span class="annot"><span class="annottext">AllocM fromrep torep a
</span><a href="#local-6989586621684391963"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Stm fromrep] -&gt; AllocM fromrep torep a
</span><a href="#local-6989586621684391962"><span class="hs-identifier hs-var">allocInStms'</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm fromrep] -&gt; AllocM fromrep torep a)
-&gt; [Stm fromrep] -&gt; AllocM fromrep torep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms fromrep -&gt; [Stm fromrep]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms fromrep
</span><a href="#local-6989586621684391964"><span class="hs-identifier hs-var">origstms</span></a></span><span>
</span><span id="line-704"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-705"></span><span>    </span><span id="local-6989586621684391962"><span class="annot"><span class="annottext">allocInStms' :: [Stm fromrep] -&gt; AllocM fromrep torep a
</span><a href="#local-6989586621684391962"><span class="hs-identifier hs-var hs-var">allocInStms'</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep a
</span><a href="#local-6989586621684391963"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-706"></span><span>    </span><span class="annot"><a href="#local-6989586621684391962"><span class="hs-identifier hs-var">allocInStms'</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684391960"><span class="annot"><span class="annottext">Stm fromrep
</span><a href="#local-6989586621684391960"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684391959"><span class="annot"><span class="annottext">[Stm fromrep]
</span><a href="#local-6989586621684391959"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-707"></span><span>      </span><span id="local-6989586621684391958"><span class="annot"><span class="annottext">Seq (Stm torep)
</span><a href="#local-6989586621684391958"><span class="hs-identifier hs-var">allocstms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep ()
-&gt; AllocM fromrep torep (Stms (Rep (AllocM fromrep torep)))
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; m a -&gt; m (Stms (Rep m))
</span><a href="Futhark.Builder.Class.html#collectStms_"><span class="hs-identifier hs-var">collectStms_</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep ()
 -&gt; AllocM fromrep torep (Stms (Rep (AllocM fromrep torep))))
-&gt; AllocM fromrep torep ()
-&gt; AllocM fromrep torep (Stms (Rep (AllocM fromrep torep)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec fromrep)
-&gt; AllocM fromrep torep () -&gt; AllocM fromrep torep ()
forall (m :: * -&gt; *) anyrep a.
MonadBuilder m =&gt;
StmAux anyrep -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#auxing"><span class="hs-identifier hs-var">auxing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stm fromrep -&gt; StmAux (ExpDec fromrep)
forall rep. Stm rep -&gt; StmAux (ExpDec rep)
</span><a href="Futhark.IR.Syntax.html#stmAux"><span class="hs-identifier hs-var hs-var">stmAux</span></a></span><span> </span><span class="annot"><span class="annottext">Stm fromrep
</span><a href="#local-6989586621684391960"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep () -&gt; AllocM fromrep torep ())
-&gt; AllocM fromrep torep () -&gt; AllocM fromrep torep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm fromrep -&gt; AllocM fromrep torep ()
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Stm fromrep -&gt; AllocM fromrep torep ()
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInStm"><span class="hs-identifier hs-var">allocInStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm fromrep
</span><a href="#local-6989586621684391960"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-708"></span><span>      </span><span class="annot"><span class="annottext">Stms (Rep (AllocM fromrep torep)) -&gt; AllocM fromrep torep ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">Seq (Stm torep)
Stms (Rep (AllocM fromrep torep))
</span><a href="#local-6989586621684391958"><span class="hs-identifier hs-var">allocstms</span></a></span><span>
</span><span id="line-709"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684391954"><span class="annot"><span class="annottext">stms_substs :: ChunkMap
</span><a href="#local-6989586621684391954"><span class="hs-identifier hs-var hs-var">stms_substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Stm torep -&gt; ChunkMap) -&gt; Seq (Stm torep) -&gt; ChunkMap
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">Stm torep -&gt; ChunkMap
forall rep. SizeSubst (Op rep) =&gt; Stm rep -&gt; ChunkMap
</span><a href="Futhark.Pass.ExplicitAllocations.html#sizeSubst"><span class="hs-identifier hs-var">sizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Seq (Stm torep)
</span><a href="#local-6989586621684391958"><span class="hs-identifier hs-var">allocstms</span></a></span><span>
</span><span id="line-710"></span><span>          </span><span id="local-6989586621684391951"><span class="annot"><span class="annottext">stms_consts :: Set VName
</span><a href="#local-6989586621684391951"><span class="hs-identifier hs-var hs-var">stms_consts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Stm torep -&gt; Set VName) -&gt; Seq (Stm torep) -&gt; Set VName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">Stm torep -&gt; Set VName
forall rep. SizeSubst (Op rep) =&gt; Stm rep -&gt; Set VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#stmConsts"><span class="hs-identifier hs-var">stmConsts</span></a></span><span> </span><span class="annot"><span class="annottext">Seq (Stm torep)
</span><a href="#local-6989586621684391958"><span class="hs-identifier hs-var">allocstms</span></a></span><span>
</span><span id="line-711"></span><span>          </span><span id="local-6989586621684391949"><span class="annot"><span class="annottext">f :: AllocEnv fromrep torep -&gt; AllocEnv fromrep torep
</span><a href="#local-6989586621684391949"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684391948"><span class="annot"><span class="annottext">AllocEnv fromrep torep
</span><a href="#local-6989586621684391948"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-712"></span><span>            </span><span class="annot"><span class="annottext">AllocEnv fromrep torep
</span><a href="#local-6989586621684391948"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-713"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">chunkMap :: ChunkMap
</span><a href="Futhark.Pass.ExplicitAllocations.html#chunkMap"><span class="hs-identifier hs-var">chunkMap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkMap
</span><a href="#local-6989586621684391954"><span class="hs-identifier hs-var">stms_substs</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap -&gt; ChunkMap -&gt; ChunkMap
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">AllocEnv fromrep torep -&gt; ChunkMap
forall fromrep torep. AllocEnv fromrep torep -&gt; ChunkMap
</span><a href="Futhark.Pass.ExplicitAllocations.html#chunkMap"><span class="hs-identifier hs-var hs-var">chunkMap</span></a></span><span> </span><span class="annot"><span class="annottext">AllocEnv fromrep torep
</span><a href="#local-6989586621684391948"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-714"></span><span>                </span><span class="annot"><span class="annottext">envConsts :: Set VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#envConsts"><span class="hs-identifier hs-var">envConsts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684391951"><span class="hs-identifier hs-var">stms_consts</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">AllocEnv fromrep torep -&gt; Set VName
forall fromrep torep. AllocEnv fromrep torep -&gt; Set VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#envConsts"><span class="hs-identifier hs-var hs-var">envConsts</span></a></span><span> </span><span class="annot"><span class="annottext">AllocEnv fromrep torep
</span><a href="#local-6989586621684391948"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-715"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-716"></span><span>      </span><span class="annot"><span class="annottext">(AllocEnv fromrep torep -&gt; AllocEnv fromrep torep)
-&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">AllocEnv fromrep torep -&gt; AllocEnv fromrep torep
</span><a href="#local-6989586621684391949"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep a -&gt; AllocM fromrep torep a)
-&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Stm fromrep] -&gt; AllocM fromrep torep a
</span><a href="#local-6989586621684391962"><span class="hs-identifier hs-var">allocInStms'</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm fromrep]
</span><a href="#local-6989586621684391959"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-717"></span><span>
</span><span id="line-718"></span><span id="local-6989586621684395499"><span id="local-6989586621684395500"><span id="local-6989586621684395501"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInStm"><span class="hs-identifier hs-type">allocInStm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-719"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395501"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395500"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395499"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-720"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395501"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-721"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395501"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395500"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-722"></span><span id="allocInStm"><span class="annot"><span class="annottext">allocInStm :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Stm fromrep -&gt; AllocM fromrep torep ()
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInStm"><span class="hs-identifier hs-var hs-var">allocInStm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span id="local-6989586621684391848"><span class="annot"><span class="annottext">[PatElemT (LetDec fromrep)]
</span><a href="#local-6989586621684391848"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec fromrep)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684391847"><span class="annot"><span class="annottext">Exp fromrep
</span><a href="#local-6989586621684391847"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-723"></span><span>  </span><span class="annot"><span class="annottext">Stm torep -&gt; AllocM fromrep torep ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStm"><span class="hs-identifier hs-var">addStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm torep -&gt; AllocM fromrep torep ())
-&gt; AllocM fromrep torep (Stm torep) -&gt; AllocM fromrep torep ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">[Ident] -&gt; Exp torep -&gt; AllocM fromrep torep (Stm torep)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
[Ident] -&gt; Exp torep -&gt; AllocM fromrep torep (Stm torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocsForStm"><span class="hs-identifier hs-var">allocsForStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatElemT (LetDec fromrep) -&gt; Ident)
-&gt; [PatElemT (LetDec fromrep)] -&gt; [Ident]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec fromrep) -&gt; Ident
forall dec. Typed dec =&gt; PatElemT dec -&gt; Ident
</span><a href="Futhark.IR.Prop.Patterns.html#patElemIdent"><span class="hs-identifier hs-var">patElemIdent</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec fromrep)]
</span><a href="#local-6989586621684391848"><span class="hs-identifier hs-var">pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp torep -&gt; AllocM fromrep torep (Stm torep))
-&gt; AllocM fromrep torep (Exp torep)
-&gt; AllocM fromrep torep (Stm torep)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Exp fromrep -&gt; AllocM fromrep torep (Exp torep)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Exp fromrep -&gt; AllocM fromrep torep (Exp torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInExp"><span class="hs-identifier hs-var">allocInExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp fromrep
</span><a href="#local-6989586621684391847"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-724"></span><span>
</span><span id="line-725"></span><span id="local-6989586621684395485"><span id="local-6989586621684395486"><span id="local-6989586621684395487"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInLambda"><span class="hs-identifier hs-type">allocInLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-726"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395487"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395486"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395485"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-727"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395486"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-728"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395487"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-729"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395487"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395486"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395486"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-730"></span><span id="allocInLambda"><span class="annot"><span class="annottext">allocInLambda :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
[LParam torep]
-&gt; Body fromrep -&gt; AllocM fromrep torep (Lambda torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInLambda"><span class="hs-identifier hs-var hs-var">allocInLambda</span></a></span></span><span> </span><span id="local-6989586621684391758"><span class="annot"><span class="annottext">[LParam torep]
</span><a href="#local-6989586621684391758"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684391757"><span class="annot"><span class="annottext">Body fromrep
</span><a href="#local-6989586621684391757"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-731"></span><span>  </span><span class="annot"><span class="annottext">[LParam (Rep (AllocM fromrep torep))]
-&gt; AllocM fromrep torep Result
-&gt; AllocM fromrep torep (Lambda (Rep (AllocM fromrep torep)))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[LParam (Rep m)] -&gt; m Result -&gt; m (Lambda (Rep m))
</span><a href="Futhark.Construct.html#mkLambda"><span class="hs-identifier hs-var">mkLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[LParam torep]
[LParam (Rep (AllocM fromrep torep))]
</span><a href="#local-6989586621684391758"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep Result
 -&gt; AllocM fromrep torep (LambdaT torep))
-&gt; (AllocM fromrep torep Result -&gt; AllocM fromrep torep Result)
-&gt; AllocM fromrep torep Result
-&gt; AllocM fromrep torep (LambdaT torep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms fromrep
-&gt; AllocM fromrep torep Result -&gt; AllocM fromrep torep Result
forall fromrep torep inner a.
Allocable fromrep torep inner =&gt;
Stms fromrep -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInStms"><span class="hs-identifier hs-var">allocInStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body fromrep -&gt; Stms fromrep
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">Body fromrep
</span><a href="#local-6989586621684391757"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep Result
 -&gt; AllocM fromrep torep (LambdaT torep))
-&gt; AllocM fromrep torep Result
-&gt; AllocM fromrep torep (LambdaT torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; AllocM fromrep torep Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; AllocM fromrep torep Result)
-&gt; Result -&gt; AllocM fromrep torep Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body fromrep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">Body fromrep
</span><a href="#local-6989586621684391757"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-732"></span><span>
</span><span id="line-733"></span><span id="local-6989586621684395488"><span id="local-6989586621684395489"><span id="local-6989586621684395490"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInExp"><span class="hs-identifier hs-type">allocInExp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-734"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395490"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395489"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395488"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-735"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395490"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-736"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395490"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395489"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395489"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-737"></span><span id="allocInExp"><span class="annot"><span class="annottext">allocInExp :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Exp fromrep -&gt; AllocM fromrep torep (Exp torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInExp"><span class="hs-identifier hs-var hs-var">allocInExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span id="local-6989586621684391499"><span class="annot"><span class="annottext">[(FParam fromrep, SubExp)]
</span><a href="#local-6989586621684391499"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684391498"><span class="annot"><span class="annottext">LoopForm fromrep
</span><a href="#local-6989586621684391498"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684391497"><span class="annot"><span class="annottext">Stms fromrep
</span><a href="#local-6989586621684391497"><span class="hs-identifier hs-var">bodystms</span></a></span></span><span> </span><span id="local-6989586621684391496"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391496"><span class="hs-identifier hs-var">bodyres</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-738"></span><span>  </span><span class="annot"><span class="annottext">[(FParam fromrep, SubExp)]
-&gt; ([(FParam torep, SubExp)]
    -&gt; ([SubExp] -&gt; AllocM fromrep torep ([SubExp], [SubExp]))
    -&gt; AllocM fromrep torep (ExpT torep))
-&gt; AllocM fromrep torep (ExpT torep)
forall fromrep torep inner a.
Allocable fromrep torep inner =&gt;
[(FParam fromrep, SubExp)]
-&gt; ([(FParam torep, SubExp)]
    -&gt; ([SubExp] -&gt; AllocM fromrep torep ([SubExp], [SubExp]))
    -&gt; AllocM fromrep torep a)
-&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInMergeParams"><span class="hs-identifier hs-var">allocInMergeParams</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam fromrep, SubExp)]
</span><a href="#local-6989586621684391499"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">(([(FParam torep, SubExp)]
  -&gt; ([SubExp] -&gt; AllocM fromrep torep ([SubExp], [SubExp]))
  -&gt; AllocM fromrep torep (ExpT torep))
 -&gt; AllocM fromrep torep (ExpT torep))
-&gt; ([(FParam torep, SubExp)]
    -&gt; ([SubExp] -&gt; AllocM fromrep torep ([SubExp], [SubExp]))
    -&gt; AllocM fromrep torep (ExpT torep))
-&gt; AllocM fromrep torep (ExpT torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684391495"><span class="annot"><span class="annottext">[(FParam torep, SubExp)]
</span><a href="#local-6989586621684391495"><span class="hs-identifier hs-var">merge'</span></a></span></span><span> </span><span id="local-6989586621684391494"><span class="annot"><span class="annottext">[SubExp] -&gt; AllocM fromrep torep ([SubExp], [SubExp])
</span><a href="#local-6989586621684391494"><span class="hs-identifier hs-var">mk_loop_val</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-739"></span><span>    </span><span id="local-6989586621684391493"><span class="annot"><span class="annottext">LoopForm torep
</span><a href="#local-6989586621684391493"><span class="hs-identifier hs-var">form'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">LoopForm fromrep -&gt; AllocM fromrep torep (LoopForm torep)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
LoopForm fromrep -&gt; AllocM fromrep torep (LoopForm torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInLoopForm"><span class="hs-identifier hs-var">allocInLoopForm</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm fromrep
</span><a href="#local-6989586621684391498"><span class="hs-identifier hs-var">form</span></a></span><span>
</span><span id="line-740"></span><span>    </span><span class="annot"><span class="annottext">Scope torep
-&gt; AllocM fromrep torep (ExpT torep)
-&gt; AllocM fromrep torep (ExpT torep)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopForm torep -&gt; Scope torep
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm torep
</span><a href="#local-6989586621684391493"><span class="hs-identifier hs-var">form'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep (ExpT torep)
 -&gt; AllocM fromrep torep (ExpT torep))
-&gt; AllocM fromrep torep (ExpT torep)
-&gt; AllocM fromrep torep (ExpT torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-741"></span><span>      </span><span id="local-6989586621684391490"><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391490"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-742"></span><span>        </span><span class="annot"><span class="annottext">AllocM fromrep torep Result -&gt; AllocM fromrep torep (BodyT torep)
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
m Result -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#buildBody_"><span class="hs-identifier hs-var">buildBody_</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep Result -&gt; AllocM fromrep torep (BodyT torep))
-&gt; (AllocM fromrep torep Result -&gt; AllocM fromrep torep Result)
-&gt; AllocM fromrep torep Result
-&gt; AllocM fromrep torep (BodyT torep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms fromrep
-&gt; AllocM fromrep torep Result -&gt; AllocM fromrep torep Result
forall fromrep torep inner a.
Allocable fromrep torep inner =&gt;
Stms fromrep -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInStms"><span class="hs-identifier hs-var">allocInStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms fromrep
</span><a href="#local-6989586621684391497"><span class="hs-identifier hs-var">bodystms</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep Result -&gt; AllocM fromrep torep (BodyT torep))
-&gt; AllocM fromrep torep Result
-&gt; AllocM fromrep torep (BodyT torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-743"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684391488"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684391488"><span class="hs-identifier hs-var">val_ses</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391487"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684391487"><span class="hs-identifier hs-var">valres'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; AllocM fromrep torep ([SubExp], [SubExp])
</span><a href="#local-6989586621684391494"><span class="hs-identifier hs-var">mk_loop_val</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; AllocM fromrep torep ([SubExp], [SubExp]))
-&gt; [SubExp] -&gt; AllocM fromrep torep ([SubExp], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; Result -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391496"><span class="hs-identifier hs-var">bodyres</span></a></span><span>
</span><span id="line-744"></span><span>          </span><span class="annot"><span class="annottext">Result -&gt; AllocM fromrep torep Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Result -&gt; AllocM fromrep torep Result)
-&gt; Result -&gt; AllocM fromrep torep Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Result
</span><a href="Futhark.IR.Syntax.html#subExpsRes"><span class="hs-identifier hs-var">subExpsRes</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684391488"><span class="hs-identifier hs-var">val_ses</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Certs -&gt; SubExp -&gt; SubExpRes) -&gt; [Certs] -&gt; [SubExp] -&gt; Result
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; SubExp -&gt; SubExpRes
</span><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-var">SubExpRes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExpRes -&gt; Certs) -&gt; Result -&gt; [Certs]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; Certs
</span><a href="Futhark.IR.Syntax.html#resCerts"><span class="hs-identifier hs-var hs-var">resCerts</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391496"><span class="hs-identifier hs-var">bodyres</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684391487"><span class="hs-identifier hs-var">valres'</span></a></span><span>
</span><span id="line-745"></span><span>      </span><span class="annot"><span class="annottext">ExpT torep -&gt; AllocM fromrep torep (ExpT torep)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ExpT torep -&gt; AllocM fromrep torep (ExpT torep))
-&gt; ExpT torep -&gt; AllocM fromrep torep (ExpT torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(FParam torep, SubExp)]
-&gt; LoopForm torep -&gt; BodyT torep -&gt; ExpT torep
forall rep.
[(FParam rep, SubExp)] -&gt; LoopForm rep -&gt; BodyT rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-var">DoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam torep, SubExp)]
</span><a href="#local-6989586621684391495"><span class="hs-identifier hs-var">merge'</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm torep
</span><a href="#local-6989586621684391493"><span class="hs-identifier hs-var">form'</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391490"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-746"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInExp"><span class="hs-identifier hs-var">allocInExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621684391482"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684391482"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span id="local-6989586621684391481"><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684391481"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621684391480"><span class="annot"><span class="annottext">[RetType fromrep]
</span><a href="#local-6989586621684391480"><span class="hs-identifier hs-var">rettype</span></a></span></span><span> </span><span id="local-6989586621684391479"><span class="annot"><span class="annottext">(Safety, SrcLoc, [SrcLoc])
</span><a href="#local-6989586621684391479"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-747"></span><span>  </span><span id="local-6989586621684391478"><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684391478"><span class="hs-identifier hs-var">args'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(SubExp, Diet)] -&gt; AllocM fromrep torep [(SubExp, Diet)]
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
[(SubExp, Diet)] -&gt; AllocM fromrep torep [(SubExp, Diet)]
</span><a href="Futhark.Pass.ExplicitAllocations.html#funcallArgs"><span class="hs-identifier hs-var">funcallArgs</span></a></span><span> </span><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684391481"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-748"></span><span>  </span><span class="hs-comment">-- We assume that every array is going to be in its own memory.</span><span>
</span><span id="line-749"></span><span>  </span><span class="annot"><span class="annottext">ExpT torep -&gt; AllocM fromrep torep (ExpT torep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(ExpT torep -&gt; AllocM fromrep torep (ExpT torep))
-&gt; ExpT torep -&gt; AllocM fromrep torep (ExpT torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name
-&gt; [(SubExp, Diet)]
-&gt; [RetType torep]
-&gt; (Safety, SrcLoc, [SrcLoc])
-&gt; ExpT torep
forall rep.
Name
-&gt; [(SubExp, Diet)]
-&gt; [RetType rep]
-&gt; (Safety, SrcLoc, [SrcLoc])
-&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684391482"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684391478"><span class="hs-identifier hs-var">args'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[RetTypeMem]
</span><a href="#local-6989586621684391477"><span class="hs-identifier hs-var">mems</span></a></span><span> </span><span class="annot"><span class="annottext">[RetTypeMem] -&gt; [RetTypeMem] -&gt; [RetTypeMem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [DeclExtType] -&gt; [RetTypeMem]
</span><a href="Futhark.Pass.ExplicitAllocations.html#memoryInDeclExtType"><span class="hs-identifier hs-var">memoryInDeclExtType</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">[DeclExtType]
[RetType fromrep]
</span><a href="#local-6989586621684391480"><span class="hs-identifier hs-var">rettype</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Safety, SrcLoc, [SrcLoc])
</span><a href="#local-6989586621684391479"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-750"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-751"></span><span>    </span><span id="local-6989586621684391477"><span class="annot"><span class="annottext">mems :: [RetTypeMem]
</span><a href="#local-6989586621684391477"><span class="hs-identifier hs-var hs-var">mems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; RetTypeMem -&gt; [RetTypeMem]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391476"><span class="hs-identifier hs-var">num_arrays</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Space -&gt; RetTypeMem
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-752"></span><span>    </span><span id="local-6989586621684391476"><span class="annot"><span class="annottext">num_arrays :: Int
</span><a href="#local-6989586621684391476"><span class="hs-identifier hs-var hs-var">num_arrays</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[DeclExtType] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([DeclExtType] -&gt; Int) -&gt; [DeclExtType] -&gt; Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DeclExtType -&gt; Bool) -&gt; [DeclExtType] -&gt; [DeclExtType]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Bool) -&gt; (DeclExtType -&gt; Int) -&gt; DeclExtType -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DeclExtType -&gt; Int
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; Int
</span><a href="Futhark.IR.Prop.Types.html#arrayRank"><span class="hs-identifier hs-var">arrayRank</span></a></span><span> </span><span class="annot"><span class="annottext">(DeclExtType -&gt; Int)
-&gt; (DeclExtType -&gt; DeclExtType) -&gt; DeclExtType -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DeclExtType -&gt; DeclExtType
forall t. DeclExtTyped t =&gt; t -&gt; DeclExtType
</span><a href="Futhark.IR.Prop.Types.html#declExtTypeOf"><span class="hs-identifier hs-var">declExtTypeOf</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[DeclExtType]
[RetType fromrep]
</span><a href="#local-6989586621684391480"><span class="hs-identifier hs-var">rettype</span></a></span><span>
</span><span id="line-753"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInExp"><span class="hs-identifier hs-var">allocInExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span id="local-6989586621684391471"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684391471"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684391470"><span class="annot"><span class="annottext">BodyT fromrep
</span><a href="#local-6989586621684391470"><span class="hs-identifier hs-var">tbranch0</span></a></span></span><span> </span><span id="local-6989586621684391469"><span class="annot"><span class="annottext">BodyT fromrep
</span><a href="#local-6989586621684391469"><span class="hs-identifier hs-var">fbranch0</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-type">IfDec</span></a></span><span> </span><span id="local-6989586621684391467"><span class="annot"><span class="annottext">[BranchType fromrep]
</span><a href="#local-6989586621684391467"><span class="hs-identifier hs-var">rets</span></a></span></span><span> </span><span id="local-6989586621684391466"><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684391466"><span class="hs-identifier hs-var">ifsort</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-754"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684391465"><span class="annot"><span class="annottext">num_rets :: Int
</span><a href="#local-6989586621684391465"><span class="hs-identifier hs-var hs-var">num_rets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ExtType] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[ExtType]
[BranchType fromrep]
</span><a href="#local-6989586621684391467"><span class="hs-identifier hs-var">rets</span></a></span><span>
</span><span id="line-755"></span><span>  </span><span class="hs-comment">-- switch to the explicit-mem rep, but do nothing about results</span><span>
</span><span id="line-756"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684391464"><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391464"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391463"><span class="annot"><span class="annottext">[Maybe (IxFun (TPrimExp Int64 VName))]
</span><a href="#local-6989586621684391463"><span class="hs-identifier hs-var">tm_ixfs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; BodyT fromrep
-&gt; AllocM
     fromrep torep (BodyT torep, [Maybe (IxFun (TPrimExp Int64 VName))])
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Int
-&gt; Body fromrep
-&gt; AllocM
     fromrep torep (Body torep, [Maybe (IxFun (TPrimExp Int64 VName))])
</span><a href="#local-6989586621684391462"><span class="hs-identifier hs-var">allocInIfBody</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391465"><span class="hs-identifier hs-var">num_rets</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT fromrep
</span><a href="#local-6989586621684391470"><span class="hs-identifier hs-var">tbranch0</span></a></span><span>
</span><span id="line-757"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684391461"><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391461"><span class="hs-identifier hs-var">fbranch</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391460"><span class="annot"><span class="annottext">[Maybe (IxFun (TPrimExp Int64 VName))]
</span><a href="#local-6989586621684391460"><span class="hs-identifier hs-var">fm_ixfs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; BodyT fromrep
-&gt; AllocM
     fromrep torep (BodyT torep, [Maybe (IxFun (TPrimExp Int64 VName))])
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Int
-&gt; Body fromrep
-&gt; AllocM
     fromrep torep (Body torep, [Maybe (IxFun (TPrimExp Int64 VName))])
</span><a href="#local-6989586621684391462"><span class="hs-identifier hs-var">allocInIfBody</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391465"><span class="hs-identifier hs-var">num_rets</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT fromrep
</span><a href="#local-6989586621684391469"><span class="hs-identifier hs-var">fbranch0</span></a></span><span>
</span><span id="line-758"></span><span>  </span><span id="local-6989586621684391459"><span class="annot"><span class="annottext">[Maybe Space]
</span><a href="#local-6989586621684391459"><span class="hs-identifier hs-var">tspaces</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; BodyT torep -&gt; AllocM fromrep torep [Maybe Space]
forall torep inner (m :: * -&gt; *).
(Mem torep inner, LocalScope torep m) =&gt;
Int -&gt; Body torep -&gt; m [Maybe Space]
</span><a href="Futhark.Pass.ExplicitAllocations.html#mkSpaceOks"><span class="hs-identifier hs-var">mkSpaceOks</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391465"><span class="hs-identifier hs-var">num_rets</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391464"><span class="hs-identifier hs-var">tbranch</span></a></span><span>
</span><span id="line-759"></span><span>  </span><span id="local-6989586621684391457"><span class="annot"><span class="annottext">[Maybe Space]
</span><a href="#local-6989586621684391457"><span class="hs-identifier hs-var">fspaces</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; BodyT torep -&gt; AllocM fromrep torep [Maybe Space]
forall torep inner (m :: * -&gt; *).
(Mem torep inner, LocalScope torep m) =&gt;
Int -&gt; Body torep -&gt; m [Maybe Space]
</span><a href="Futhark.Pass.ExplicitAllocations.html#mkSpaceOks"><span class="hs-identifier hs-var">mkSpaceOks</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391465"><span class="hs-identifier hs-var">num_rets</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391461"><span class="hs-identifier hs-var">fbranch</span></a></span><span>
</span><span id="line-760"></span><span>  </span><span class="hs-comment">-- try to generalize (antiunify) the index functions of the then and else bodies</span><span>
</span><span id="line-761"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684391456"><span class="annot"><span class="annottext">sp_substs :: [(Maybe Space,
  Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)]))]
</span><a href="#local-6989586621684391456"><span class="hs-identifier hs-var hs-var">sp_substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Maybe Space, Maybe (IxFun (TPrimExp Int64 VName)))
 -&gt; (Maybe Space, Maybe (IxFun (TPrimExp Int64 VName)))
 -&gt; (Maybe Space,
     Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])))
-&gt; [(Maybe Space, Maybe (IxFun (TPrimExp Int64 VName)))]
-&gt; [(Maybe Space, Maybe (IxFun (TPrimExp Int64 VName)))]
-&gt; [(Maybe Space,
     Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)]))]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Space, Maybe (IxFun (TPrimExp Int64 VName)))
-&gt; (Maybe Space, Maybe (IxFun (TPrimExp Int64 VName)))
-&gt; (Maybe Space,
    Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)]))
</span><a href="#local-6989586621684391455"><span class="hs-identifier hs-var">generalize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Maybe Space]
-&gt; [Maybe (IxFun (TPrimExp Int64 VName))]
-&gt; [(Maybe Space, Maybe (IxFun (TPrimExp Int64 VName)))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Maybe Space]
</span><a href="#local-6989586621684391459"><span class="hs-identifier hs-var">tspaces</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe (IxFun (TPrimExp Int64 VName))]
</span><a href="#local-6989586621684391463"><span class="hs-identifier hs-var">tm_ixfs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Maybe Space]
-&gt; [Maybe (IxFun (TPrimExp Int64 VName))]
-&gt; [(Maybe Space, Maybe (IxFun (TPrimExp Int64 VName)))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Maybe Space]
</span><a href="#local-6989586621684391457"><span class="hs-identifier hs-var">fspaces</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe (IxFun (TPrimExp Int64 VName))]
</span><a href="#local-6989586621684391460"><span class="hs-identifier hs-var">fm_ixfs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-762"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684391454"><span class="annot"><span class="annottext">[Maybe Space]
</span><a href="#local-6989586621684391454"><span class="hs-identifier hs-var">spaces</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391453"><span class="annot"><span class="annottext">[Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])]
</span><a href="#local-6989586621684391453"><span class="hs-identifier hs-var">subs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Maybe Space,
  Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)]))]
-&gt; ([Maybe Space],
    [Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Maybe Space,
  Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)]))]
</span><a href="#local-6989586621684391456"><span class="hs-identifier hs-var">sp_substs</span></a></span><span>
</span><span id="line-763"></span><span>      </span><span id="local-6989586621684391452"><span class="annot"><span class="annottext">tsubs :: [Maybe (ExtIxFun, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684391452"><span class="hs-identifier hs-var hs-var">tsubs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])
 -&gt; Maybe (ExtIxFun, [TPrimExp Int64 VName]))
-&gt; [Maybe
      (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])]
-&gt; [Maybe (ExtIxFun, [TPrimExp Int64 VName])]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((TPrimExp Int64 VName, TPrimExp Int64 VName)
 -&gt; TPrimExp Int64 VName)
-&gt; Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])
-&gt; Maybe (ExtIxFun, [TPrimExp Int64 VName])
forall a.
((a, a) -&gt; a)
-&gt; Maybe (ExtIxFun, [(a, a)]) -&gt; Maybe (ExtIxFun, [a])
</span><a href="#local-6989586621684391451"><span class="hs-identifier hs-var">selectSub</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName, TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])]
</span><a href="#local-6989586621684391453"><span class="hs-identifier hs-var">subs</span></a></span><span>
</span><span id="line-764"></span><span>      </span><span id="local-6989586621684391450"><span class="annot"><span class="annottext">fsubs :: [Maybe (ExtIxFun, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684391450"><span class="hs-identifier hs-var hs-var">fsubs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])
 -&gt; Maybe (ExtIxFun, [TPrimExp Int64 VName]))
-&gt; [Maybe
      (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])]
-&gt; [Maybe (ExtIxFun, [TPrimExp Int64 VName])]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((TPrimExp Int64 VName, TPrimExp Int64 VName)
 -&gt; TPrimExp Int64 VName)
-&gt; Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])
-&gt; Maybe (ExtIxFun, [TPrimExp Int64 VName])
forall a.
((a, a) -&gt; a)
-&gt; Maybe (ExtIxFun, [(a, a)]) -&gt; Maybe (ExtIxFun, [a])
</span><a href="#local-6989586621684391451"><span class="hs-identifier hs-var">selectSub</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName, TPrimExp Int64 VName)
-&gt; TPrimExp Int64 VName
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])]
</span><a href="#local-6989586621684391453"><span class="hs-identifier hs-var">subs</span></a></span><span>
</span><span id="line-765"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684391449"><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391449"><span class="hs-identifier hs-var">tbranch'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391448"><span class="annot"><span class="annottext">[BranchTypeMem]
</span><a href="#local-6989586621684391448"><span class="hs-identifier hs-var">trets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ExtType]
-&gt; BodyT torep
-&gt; [Maybe Space]
-&gt; [Maybe (ExtIxFun, [TPrimExp Int64 VName])]
-&gt; AllocM fromrep torep (BodyT torep, [BranchTypeMem])
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
[ExtType]
-&gt; Body torep
-&gt; [Maybe Space]
-&gt; [Maybe (ExtIxFun, [TPrimExp Int64 VName])]
-&gt; AllocM fromrep torep (Body torep, [BranchTypeMem])
</span><a href="Futhark.Pass.ExplicitAllocations.html#addResCtxInIfBody"><span class="hs-identifier hs-var">addResCtxInIfBody</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtType]
[BranchType fromrep]
</span><a href="#local-6989586621684391467"><span class="hs-identifier hs-var">rets</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391464"><span class="hs-identifier hs-var">tbranch</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Space]
</span><a href="#local-6989586621684391454"><span class="hs-identifier hs-var">spaces</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe (ExtIxFun, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684391452"><span class="hs-identifier hs-var">tsubs</span></a></span><span>
</span><span id="line-766"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684391446"><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391446"><span class="hs-identifier hs-var">fbranch'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391445"><span class="annot"><span class="annottext">[BranchTypeMem]
</span><a href="#local-6989586621684391445"><span class="hs-identifier hs-var">frets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[ExtType]
-&gt; BodyT torep
-&gt; [Maybe Space]
-&gt; [Maybe (ExtIxFun, [TPrimExp Int64 VName])]
-&gt; AllocM fromrep torep (BodyT torep, [BranchTypeMem])
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
[ExtType]
-&gt; Body torep
-&gt; [Maybe Space]
-&gt; [Maybe (ExtIxFun, [TPrimExp Int64 VName])]
-&gt; AllocM fromrep torep (Body torep, [BranchTypeMem])
</span><a href="Futhark.Pass.ExplicitAllocations.html#addResCtxInIfBody"><span class="hs-identifier hs-var">addResCtxInIfBody</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtType]
[BranchType fromrep]
</span><a href="#local-6989586621684391467"><span class="hs-identifier hs-var">rets</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391461"><span class="hs-identifier hs-var">fbranch</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Space]
</span><a href="#local-6989586621684391454"><span class="hs-identifier hs-var">spaces</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe (ExtIxFun, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684391450"><span class="hs-identifier hs-var">fsubs</span></a></span><span>
</span><span id="line-767"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[BranchTypeMem]
</span><a href="#local-6989586621684391445"><span class="hs-identifier hs-var">frets</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchTypeMem] -&gt; [BranchTypeMem] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">[BranchTypeMem]
</span><a href="#local-6989586621684391448"><span class="hs-identifier hs-var">trets</span></a></span><span>
</span><span id="line-768"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">String -&gt; AllocM fromrep torep (ExpT torep)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In allocInExp, IF case: antiunification of then/else produce different ExtInFn!&quot;</span></span><span>
</span><span id="line-769"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-770"></span><span>      </span><span class="hs-comment">-- above is a sanity check; implementation continues on else branch</span><span>
</span><span id="line-771"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684391443"><span class="annot"><span class="annottext">res_then :: Result
</span><a href="#local-6989586621684391443"><span class="hs-identifier hs-var hs-var">res_then</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT torep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391449"><span class="hs-identifier hs-var">tbranch'</span></a></span><span>
</span><span id="line-772"></span><span>          </span><span id="local-6989586621684391442"><span class="annot"><span class="annottext">res_else :: Result
</span><a href="#local-6989586621684391442"><span class="hs-identifier hs-var hs-var">res_else</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT torep -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391446"><span class="hs-identifier hs-var">fbranch'</span></a></span><span>
</span><span id="line-773"></span><span>          </span><span id="local-6989586621684391441"><span class="annot"><span class="annottext">size_ext :: Int
</span><a href="#local-6989586621684391441"><span class="hs-identifier hs-var hs-var">size_ext</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Result -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391443"><span class="hs-identifier hs-var">res_then</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[BranchTypeMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[BranchTypeMem]
</span><a href="#local-6989586621684391448"><span class="hs-identifier hs-var">trets</span></a></span><span>
</span><span id="line-774"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684391440"><span class="annot"><span class="annottext">[(SubExpRes, SubExpRes, Int)]
</span><a href="#local-6989586621684391440"><span class="hs-identifier hs-var">ind_ses0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391439"><span class="annot"><span class="annottext">[(SubExpRes, SubExpRes, Int)]
</span><a href="#local-6989586621684391439"><span class="hs-identifier hs-var">r_then_else</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-775"></span><span>            </span><span class="annot"><span class="annottext">((SubExpRes, SubExpRes, Int) -&gt; Bool)
-&gt; [(SubExpRes, SubExpRes, Int)]
-&gt; ([(SubExpRes, SubExpRes, Int)], [(SubExpRes, SubExpRes, Int)])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">partition</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684391438"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684391438"><span class="hs-identifier hs-var">r_then</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391437"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684391437"><span class="hs-identifier hs-var">r_else</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684391438"><span class="hs-identifier hs-var">r_then</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExpRes -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684391437"><span class="hs-identifier hs-var">r_else</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(SubExpRes, SubExpRes, Int)]
 -&gt; ([(SubExpRes, SubExpRes, Int)], [(SubExpRes, SubExpRes, Int)]))
-&gt; [(SubExpRes, SubExpRes, Int)]
-&gt; ([(SubExpRes, SubExpRes, Int)], [(SubExpRes, SubExpRes, Int)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-776"></span><span>              </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; [Int] -&gt; [(SubExpRes, SubExpRes, Int)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391443"><span class="hs-identifier hs-var">res_then</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391442"><span class="hs-identifier hs-var">res_else</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391441"><span class="hs-identifier hs-var">size_ext</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-777"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684391436"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391436"><span class="hs-identifier hs-var">r_then_ext</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391435"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391435"><span class="hs-identifier hs-var">r_else_ext</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(SubExpRes, SubExpRes, Int)] -&gt; (Result, Result, [Int])
forall a b c. [(a, b, c)] -&gt; ([a], [b], [c])
</span><span class="hs-identifier hs-var">unzip3</span></span><span> </span><span class="annot"><span class="annottext">[(SubExpRes, SubExpRes, Int)]
</span><a href="#local-6989586621684391439"><span class="hs-identifier hs-var">r_then_else</span></a></span><span>
</span><span id="line-778"></span><span>          </span><span id="local-6989586621684391434"><span class="annot"><span class="annottext">ind_ses :: [(Int, SubExpRes)]
</span><a href="#local-6989586621684391434"><span class="hs-identifier hs-var hs-var">ind_ses</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-779"></span><span>            </span><span class="annot"><span class="annottext">((SubExpRes, SubExpRes, Int) -&gt; Int -&gt; (Int, SubExpRes))
-&gt; [(SubExpRes, SubExpRes, Int)] -&gt; [Int] -&gt; [(Int, SubExpRes)]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span>
</span><span id="line-780"></span><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684391433"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684391433"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391432"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391432"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684391431"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391431"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391432"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391431"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684391433"><span class="hs-identifier hs-var">se</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-781"></span><span>              </span><span class="annot"><span class="annottext">[(SubExpRes, SubExpRes, Int)]
</span><a href="#local-6989586621684391440"><span class="hs-identifier hs-var">ind_ses0</span></a></span><span>
</span><span id="line-782"></span><span>              </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">[(SubExpRes, SubExpRes, Int)] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(SubExpRes, SubExpRes, Int)]
</span><a href="#local-6989586621684391440"><span class="hs-identifier hs-var">ind_ses0</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-783"></span><span>          </span><span id="local-6989586621684391430"><span class="annot"><span class="annottext">rets'' :: [BranchTypeMem]
</span><a href="#local-6989586621684391430"><span class="hs-identifier hs-var hs-var">rets''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([BranchTypeMem] -&gt; (Int, SubExpRes) -&gt; [BranchTypeMem])
-&gt; [BranchTypeMem] -&gt; [(Int, SubExpRes)] -&gt; [BranchTypeMem]
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684391428"><span class="annot"><span class="annottext">[BranchTypeMem]
</span><a href="#local-6989586621684391428"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684391427"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391427"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684391426"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684391426"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; SubExp -&gt; [BranchTypeMem] -&gt; [BranchTypeMem]
forall t. FixExt t =&gt; Int -&gt; SubExp -&gt; t -&gt; t
</span><a href="Futhark.IR.Prop.Types.html#fixExt"><span class="hs-identifier hs-var">fixExt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391427"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684391426"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchTypeMem]
</span><a href="#local-6989586621684391428"><span class="hs-identifier hs-var">acc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[BranchTypeMem]
</span><a href="#local-6989586621684391448"><span class="hs-identifier hs-var">trets</span></a></span><span> </span><span class="annot"><span class="annottext">[(Int, SubExpRes)]
</span><a href="#local-6989586621684391434"><span class="hs-identifier hs-var">ind_ses</span></a></span><span>
</span><span id="line-784"></span><span>          </span><span id="local-6989586621684391424"><span class="annot"><span class="annottext">tbranch'' :: BodyT torep
</span><a href="#local-6989586621684391424"><span class="hs-identifier hs-var hs-var">tbranch''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391449"><span class="hs-identifier hs-var">tbranch'</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">bodyResult :: Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var">bodyResult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391436"><span class="hs-identifier hs-var">r_then_ext</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; Result
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391441"><span class="hs-identifier hs-var">size_ext</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391443"><span class="hs-identifier hs-var">res_then</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-785"></span><span>          </span><span id="local-6989586621684391422"><span class="annot"><span class="annottext">fbranch'' :: BodyT torep
</span><a href="#local-6989586621684391422"><span class="hs-identifier hs-var hs-var">fbranch''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391446"><span class="hs-identifier hs-var">fbranch'</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">bodyResult :: Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var">bodyResult</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391435"><span class="hs-identifier hs-var">r_else_ext</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; Result
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391441"><span class="hs-identifier hs-var">size_ext</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391442"><span class="hs-identifier hs-var">res_else</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-786"></span><span>          </span><span id="local-6989586621684391421"><span class="annot"><span class="annottext">res_if_expr :: ExpT torep
</span><a href="#local-6989586621684391421"><span class="hs-identifier hs-var hs-var">res_if_expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp
-&gt; BodyT torep
-&gt; BodyT torep
-&gt; IfDec (BranchType torep)
-&gt; ExpT torep
forall rep.
SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684391471"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391424"><span class="hs-identifier hs-var">tbranch''</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT torep
</span><a href="#local-6989586621684391422"><span class="hs-identifier hs-var">fbranch''</span></a></span><span> </span><span class="annot"><span class="annottext">(IfDec (BranchType torep) -&gt; ExpT torep)
-&gt; IfDec (BranchType torep) -&gt; ExpT torep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[BranchTypeMem] -&gt; IfSort -&gt; IfDec BranchTypeMem
forall rt. [rt] -&gt; IfSort -&gt; IfDec rt
</span><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-var">IfDec</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchTypeMem]
</span><a href="#local-6989586621684391430"><span class="hs-identifier hs-var">rets''</span></a></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="#local-6989586621684391466"><span class="hs-identifier hs-var">ifsort</span></a></span><span>
</span><span id="line-787"></span><span>      </span><span class="annot"><span class="annottext">ExpT torep -&gt; AllocM fromrep torep (ExpT torep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">ExpT torep
</span><a href="#local-6989586621684391421"><span class="hs-identifier hs-var">res_if_expr</span></a></span><span>
</span><span id="line-788"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-789"></span><span>    </span><span class="annot"><a href="#local-6989586621684391455"><span class="hs-identifier hs-type">generalize</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-790"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-791"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-792"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ExtIxFun"><span class="hs-identifier hs-type">ExtIxFun</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-793"></span><span>    </span><span id="local-6989586621684391455"><span class="annot"><span class="annottext">generalize :: (Maybe Space, Maybe (IxFun (TPrimExp Int64 VName)))
-&gt; (Maybe Space, Maybe (IxFun (TPrimExp Int64 VName)))
-&gt; (Maybe Space,
    Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)]))
</span><a href="#local-6989586621684391455"><span class="hs-identifier hs-var hs-var">generalize</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684391420"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684391420"><span class="hs-identifier hs-var">sp1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684391419"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684391419"><span class="hs-identifier hs-var">ixf1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684391418"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684391418"><span class="hs-identifier hs-var">sp2</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684391417"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684391417"><span class="hs-identifier hs-var">ixf2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-794"></span><span>      </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684391420"><span class="hs-identifier hs-var">sp1</span></a></span><span> </span><span class="annot"><span class="annottext">Space -&gt; Space -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684391418"><span class="hs-identifier hs-var">sp2</span></a></span><span>
</span><span id="line-795"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Space -&gt; Maybe Space
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684391420"><span class="hs-identifier hs-var">sp1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-796"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IxFun (PrimExp VName)
-&gt; IxFun (PrimExp VName)
-&gt; Maybe
     (IxFun (PrimExp (Ext VName)), [(PrimExp VName, PrimExp VName)])
forall v.
Eq v =&gt;
IxFun (PrimExp v)
-&gt; IxFun (PrimExp v)
-&gt; Maybe (IxFun (PrimExp (Ext v)), [(PrimExp v, PrimExp v)])
</span><a href="Futhark.IR.Mem.IxFun.html#leastGeneralGeneralization"><span class="hs-identifier hs-var">IxFun.leastGeneralGeneralization</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; PrimExp VName)
-&gt; IxFun (TPrimExp Int64 VName) -&gt; IxFun (PrimExp VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684391419"><span class="hs-identifier hs-var">ixf1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; PrimExp VName)
-&gt; IxFun (TPrimExp Int64 VName) -&gt; IxFun (PrimExp VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; PrimExp VName
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684391417"><span class="hs-identifier hs-var">ixf2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-797"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684391415"><span class="annot"><span class="annottext">IxFun (PrimExp (Ext VName))
</span><a href="#local-6989586621684391415"><span class="hs-identifier hs-var">ixf</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391414"><span class="annot"><span class="annottext">[(PrimExp VName, PrimExp VName)]
</span><a href="#local-6989586621684391414"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-798"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Space -&gt; Maybe Space
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684391420"><span class="hs-identifier hs-var">sp1</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-799"></span><span>              </span><span class="annot"><span class="annottext">(ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])
-&gt; Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span>
</span><span id="line-800"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(PrimExp (Ext VName) -&gt; TPrimExp Int64 (Ext VName))
-&gt; IxFun (PrimExp (Ext VName)) -&gt; ExtIxFun
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">PrimExp (Ext VName) -&gt; TPrimExp Int64 (Ext VName)
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (PrimExp (Ext VName))
</span><a href="#local-6989586621684391415"><span class="hs-identifier hs-var">ixf</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-801"></span><span>                  </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName]
-&gt; [(TPrimExp Int64 VName, TPrimExp Int64 VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((PrimExp VName, PrimExp VName) -&gt; TPrimExp Int64 VName)
-&gt; [(PrimExp VName, PrimExp VName)] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp VName -&gt; TPrimExp Int64 VName
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; TPrimExp Int64 VName)
-&gt; ((PrimExp VName, PrimExp VName) -&gt; PrimExp VName)
-&gt; (PrimExp VName, PrimExp VName)
-&gt; TPrimExp Int64 VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName, PrimExp VName) -&gt; PrimExp VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(PrimExp VName, PrimExp VName)]
</span><a href="#local-6989586621684391414"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((PrimExp VName, PrimExp VName) -&gt; TPrimExp Int64 VName)
-&gt; [(PrimExp VName, PrimExp VName)] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp VName -&gt; TPrimExp Int64 VName
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName -&gt; TPrimExp Int64 VName)
-&gt; ((PrimExp VName, PrimExp VName) -&gt; PrimExp VName)
-&gt; (PrimExp VName, PrimExp VName)
-&gt; TPrimExp Int64 VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(PrimExp VName, PrimExp VName) -&gt; PrimExp VName
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(PrimExp VName, PrimExp VName)]
</span><a href="#local-6989586621684391414"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-802"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-803"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-804"></span><span>          </span><span class="annot"><span class="annottext">Maybe
  (IxFun (PrimExp (Ext VName)), [(PrimExp VName, PrimExp VName)])
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Space -&gt; Maybe Space
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684391420"><span class="hs-identifier hs-var">sp1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-805"></span><span>    </span><span class="annot"><a href="#local-6989586621684391455"><span class="hs-identifier hs-var">generalize</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684391412"><span class="annot"><span class="annottext">Maybe Space
</span><a href="#local-6989586621684391412"><span class="hs-identifier hs-var">mbsp1</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp Int64 VName))
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe Space, Maybe (IxFun (TPrimExp Int64 VName)))
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Space
</span><a href="#local-6989586621684391412"><span class="hs-identifier hs-var">mbsp1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (ExtIxFun, [(TPrimExp Int64 VName, TPrimExp Int64 VName)])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span>
</span><span id="line-806"></span><span>
</span><span id="line-807"></span><span>    </span><span id="local-6989586621684395441"><span class="annot"><a href="#local-6989586621684391451"><span class="hs-identifier hs-type">selectSub</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-808"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684395441"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684395441"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684395441"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-809"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ExtIxFun"><span class="hs-identifier hs-type">ExtIxFun</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684395441"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684395441"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-810"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ExtIxFun"><span class="hs-identifier hs-type">ExtIxFun</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684395441"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-811"></span><span>    </span><span id="local-6989586621684391451"><span class="annot"><span class="annottext">selectSub :: forall a.
((a, a) -&gt; a)
-&gt; Maybe (ExtIxFun, [(a, a)]) -&gt; Maybe (ExtIxFun, [a])
</span><a href="#local-6989586621684391451"><span class="hs-identifier hs-var hs-var">selectSub</span></a></span></span><span> </span><span id="local-6989586621684391411"><span class="annot"><span class="annottext">(a, a) -&gt; a
</span><a href="#local-6989586621684391411"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684391410"><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684391410"><span class="hs-identifier hs-var">ixfn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391409"><span class="annot"><span class="annottext">[(a, a)]
</span><a href="#local-6989586621684391409"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ExtIxFun, [a]) -&gt; Maybe (ExtIxFun, [a])
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684391410"><span class="hs-identifier hs-var">ixfn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">((a, a) -&gt; a) -&gt; [(a, a)] -&gt; [a]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(a, a) -&gt; a
</span><a href="#local-6989586621684391411"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[(a, a)]
</span><a href="#local-6989586621684391409"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-812"></span><span>    </span><span class="annot"><a href="#local-6989586621684391451"><span class="hs-identifier hs-var">selectSub</span></a></span><span> </span><span class="annot"><span class="annottext">(a, a) -&gt; a
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (ExtIxFun, [(a, a)])
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (ExtIxFun, [a])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-813"></span><span>    </span><span id="local-6989586621684395445"><span id="local-6989586621684395446"><span id="local-6989586621684395447"><span class="annot"><a href="#local-6989586621684391462"><span class="hs-identifier hs-type">allocInIfBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-814"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395447"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395446"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395445"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-815"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-816"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395447"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-817"></span><span>      </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395447"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395446"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395446"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-818"></span><span>    </span><span id="local-6989586621684391462"><span class="annot"><span class="annottext">allocInIfBody :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Int
-&gt; Body fromrep
-&gt; AllocM
     fromrep torep (Body torep, [Maybe (IxFun (TPrimExp Int64 VName))])
</span><a href="#local-6989586621684391462"><span class="hs-identifier hs-var hs-var">allocInIfBody</span></a></span></span><span> </span><span id="local-6989586621684391325"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391325"><span class="hs-identifier hs-var">num_vals</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec fromrep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684391324"><span class="annot"><span class="annottext">Stms fromrep
</span><a href="#local-6989586621684391324"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684391323"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391323"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-819"></span><span>      </span><span class="annot"><span class="annottext">AllocM
  fromrep torep (Result, [Maybe (IxFun (TPrimExp Int64 VName))])
-&gt; AllocM
     fromrep torep (BodyT torep, [Maybe (IxFun (TPrimExp Int64 VName))])
forall (m :: * -&gt; *) a.
MonadBuilder m =&gt;
m (Result, a) -&gt; m (Body (Rep m), a)
</span><a href="Futhark.Construct.html#buildBody"><span class="hs-identifier hs-var">buildBody</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM
   fromrep torep (Result, [Maybe (IxFun (TPrimExp Int64 VName))])
 -&gt; AllocM
      fromrep
      torep
      (BodyT torep, [Maybe (IxFun (TPrimExp Int64 VName))]))
-&gt; (AllocM
      fromrep torep (Result, [Maybe (IxFun (TPrimExp Int64 VName))])
    -&gt; AllocM
         fromrep torep (Result, [Maybe (IxFun (TPrimExp Int64 VName))]))
-&gt; AllocM
     fromrep torep (Result, [Maybe (IxFun (TPrimExp Int64 VName))])
-&gt; AllocM
     fromrep torep (BodyT torep, [Maybe (IxFun (TPrimExp Int64 VName))])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms fromrep
-&gt; AllocM
     fromrep torep (Result, [Maybe (IxFun (TPrimExp Int64 VName))])
-&gt; AllocM
     fromrep torep (Result, [Maybe (IxFun (TPrimExp Int64 VName))])
forall fromrep torep inner a.
Allocable fromrep torep inner =&gt;
Stms fromrep -&gt; AllocM fromrep torep a -&gt; AllocM fromrep torep a
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInStms"><span class="hs-identifier hs-var">allocInStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms fromrep
</span><a href="#local-6989586621684391324"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM
   fromrep torep (Result, [Maybe (IxFun (TPrimExp Int64 VName))])
 -&gt; AllocM
      fromrep
      torep
      (BodyT torep, [Maybe (IxFun (TPrimExp Int64 VName))]))
-&gt; AllocM
     fromrep torep (Result, [Maybe (IxFun (TPrimExp Int64 VName))])
-&gt; AllocM
     fromrep torep (BodyT torep, [Maybe (IxFun (TPrimExp Int64 VName))])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-820"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391322"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391322"><span class="hs-identifier hs-var">val_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; (Result, Result)
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Futhark.Util.html#splitFromEnd"><span class="hs-identifier hs-var">splitFromEnd</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684391325"><span class="hs-identifier hs-var">num_vals</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391323"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-821"></span><span>        </span><span id="local-6989586621684391321"><span class="annot"><span class="annottext">[Maybe (IxFun (TPrimExp Int64 VName))]
</span><a href="#local-6989586621684391321"><span class="hs-identifier hs-var">mem_ixfs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExpRes
 -&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName))))
-&gt; Result
-&gt; AllocM fromrep torep [Maybe (IxFun (TPrimExp Int64 VName))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp
-&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName)))
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
SubExp
-&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName)))
</span><a href="Futhark.Pass.ExplicitAllocations.html#subExpIxFun"><span class="hs-identifier hs-var">subExpIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp
 -&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName))))
-&gt; (SubExpRes -&gt; SubExp)
-&gt; SubExpRes
-&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName)))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391322"><span class="hs-identifier hs-var">val_res</span></a></span><span>
</span><span id="line-822"></span><span>        </span><span class="annot"><span class="annottext">(Result, [Maybe (IxFun (TPrimExp Int64 VName))])
-&gt; AllocM
     fromrep torep (Result, [Maybe (IxFun (TPrimExp Int64 VName))])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684391323"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[Maybe (IxFun (TPrimExp Int64 VName))]
</span><a href="#local-6989586621684391321"><span class="hs-identifier hs-var">mem_ixfs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-823"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInExp"><span class="hs-identifier hs-var">allocInExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-type">WithAcc</span></a></span><span> </span><span id="local-6989586621684391318"><span class="annot"><span class="annottext">[WithAccInput fromrep]
</span><a href="#local-6989586621684391318"><span class="hs-identifier hs-var">inputs</span></a></span></span><span> </span><span id="local-6989586621684391317"><span class="annot"><span class="annottext">Lambda fromrep
</span><a href="#local-6989586621684391317"><span class="hs-identifier hs-var">bodylam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-824"></span><span>  </span><span class="annot"><span class="annottext">[WithAccInput torep] -&gt; Lambda torep -&gt; ExpT torep
forall rep. [WithAccInput rep] -&gt; Lambda rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-var">WithAcc</span></a></span><span> </span><span class="annot"><span class="annottext">([WithAccInput torep] -&gt; Lambda torep -&gt; ExpT torep)
-&gt; AllocM fromrep torep [WithAccInput torep]
-&gt; AllocM fromrep torep (Lambda torep -&gt; ExpT torep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(WithAccInput fromrep -&gt; AllocM fromrep torep (WithAccInput torep))
-&gt; [WithAccInput fromrep]
-&gt; AllocM fromrep torep [WithAccInput torep]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">WithAccInput fromrep -&gt; AllocM fromrep torep (WithAccInput torep)
forall {t :: * -&gt; *} {a} {rep} {inner} {fromrep} {b}.
(Traversable t, ArrayShape a, HasLetDecMem (LetDec rep),
 BuilderOps rep, OpReturns inner, SizeSubst inner,
 PrettyRep fromrep, BranchType rep ~ BranchTypeMem,
 BodyDec fromrep ~ (), RetType rep ~ RetTypeMem,
 RetType fromrep ~ DeclExtType, FParamInfo rep ~ FParamMem,
 BranchType fromrep ~ ExtType, LParamInfo rep ~ LParamMem,
 ExpDec rep ~ (), BodyDec rep ~ (), Op rep ~ MemOp inner,
 FParamInfo fromrep ~ DeclType, LParamInfo fromrep ~ Type,
 LetDec rep ~ LParamMem) =&gt;
(a, [VName], t (LambdaT fromrep, b))
-&gt; AllocM fromrep rep (a, [VName], t (Lambda rep, b))
</span><a href="#local-6989586621684391316"><span class="hs-identifier hs-var">onInput</span></a></span><span> </span><span class="annot"><span class="annottext">[WithAccInput fromrep]
</span><a href="#local-6989586621684391318"><span class="hs-identifier hs-var">inputs</span></a></span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep (Lambda torep -&gt; ExpT torep)
-&gt; AllocM fromrep torep (Lambda torep)
-&gt; AllocM fromrep torep (ExpT torep)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda fromrep -&gt; AllocM fromrep torep (Lambda torep)
forall {fromrep} {torep} {inner}.
(PrettyRep fromrep, HasLetDecMem (LetDec torep), OpReturns inner,
 SizeSubst inner, BuilderOps torep, ExpDec torep ~ (),
 LParamInfo fromrep ~ Type, BodyDec torep ~ (),
 FParamInfo torep ~ FParamMem, LetDec torep ~ LParamMem,
 BodyDec fromrep ~ (), RetType torep ~ RetTypeMem,
 FParamInfo fromrep ~ DeclType, RetType fromrep ~ DeclExtType,
 BranchType torep ~ BranchTypeMem, LParamInfo torep ~ LParamMem,
 BranchType fromrep ~ ExtType, Op torep ~ MemOp inner) =&gt;
LambdaT fromrep -&gt; AllocM fromrep torep (Lambda torep)
</span><a href="#local-6989586621684391315"><span class="hs-identifier hs-var">onLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda fromrep
</span><a href="#local-6989586621684391317"><span class="hs-identifier hs-var">bodylam</span></a></span><span>
</span><span id="line-825"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-826"></span><span>    </span><span id="local-6989586621684391315"><span class="annot"><span class="annottext">onLambda :: LambdaT fromrep -&gt; AllocM fromrep torep (Lambda torep)
</span><a href="#local-6989586621684391315"><span class="hs-identifier hs-var hs-var">onLambda</span></a></span></span><span> </span><span id="local-6989586621684391217"><span class="annot"><span class="annottext">LambdaT fromrep
</span><a href="#local-6989586621684391217"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-827"></span><span>      </span><span id="local-6989586621684391216"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684391216"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Param Type]
-&gt; (Param Type -&gt; AllocM fromrep torep (Param LParamMem))
-&gt; AllocM fromrep torep [Param LParamMem]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT fromrep -&gt; [LParam fromrep]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT fromrep
</span><a href="#local-6989586621684391217"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Param Type -&gt; AllocM fromrep torep (Param LParamMem))
 -&gt; AllocM fromrep torep [Param LParamMem])
-&gt; (Param Type -&gt; AllocM fromrep torep (Param LParamMem))
-&gt; AllocM fromrep torep [Param LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span id="local-6989586621684391214"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684391214"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684391213"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684391213"><span class="hs-identifier hs-var">pv</span></a></span></span><span> </span><span id="local-6989586621684391212"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684391212"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-828"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684391212"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-829"></span><span>          </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Primitive.html#Unit"><span class="hs-identifier hs-var">Unit</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; AllocM fromrep torep (Param LParamMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Param LParamMem -&gt; AllocM fromrep torep (Param LParamMem))
-&gt; Param LParamMem -&gt; AllocM fromrep torep (Param LParamMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Attrs -&gt; VName -&gt; LParamMem -&gt; Param LParamMem
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684391214"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684391213"><span class="hs-identifier hs-var">pv</span></a></span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; Param LParamMem) -&gt; LParamMem -&gt; Param LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; LParamMem
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Primitive.html#Unit"><span class="hs-identifier hs-var">Unit</span></a></span><span>
</span><span id="line-830"></span><span>          </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span id="local-6989586621684391210"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684391210"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684391209"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684391209"><span class="hs-identifier hs-var">ispace</span></a></span></span><span> </span><span id="local-6989586621684391208"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684391208"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684391207"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684391207"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; AllocM fromrep torep (Param LParamMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Param LParamMem -&gt; AllocM fromrep torep (Param LParamMem))
-&gt; Param LParamMem -&gt; AllocM fromrep torep (Param LParamMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Attrs -&gt; VName -&gt; LParamMem -&gt; Param LParamMem
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684391214"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684391213"><span class="hs-identifier hs-var">pv</span></a></span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; Param LParamMem) -&gt; LParamMem -&gt; Param LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Shape -&gt; [Type] -&gt; NoUniqueness -&gt; LParamMem
forall d u ret. VName -&gt; Shape -&gt; [Type] -&gt; u -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-var">MemAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684391210"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684391209"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684391208"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684391207"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-831"></span><span>          </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; AllocM fromrep torep (Param LParamMem)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; AllocM fromrep torep (Param LParamMem))
-&gt; String -&gt; AllocM fromrep torep (Param LParamMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unexpected WithAcc lambda param: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Attrs -&gt; VName -&gt; Type -&gt; Param Type
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684391214"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684391213"><span class="hs-identifier hs-var">pv</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684391212"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-832"></span><span>      </span><span class="annot"><span class="annottext">[LParam torep]
-&gt; Body fromrep -&gt; AllocM fromrep torep (Lambda torep)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
[LParam torep]
-&gt; Body fromrep -&gt; AllocM fromrep torep (Lambda torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInLambda"><span class="hs-identifier hs-var">allocInLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[LParam torep]
[Param LParamMem]
</span><a href="#local-6989586621684391216"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT fromrep -&gt; Body fromrep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT fromrep
</span><a href="#local-6989586621684391217"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-833"></span><span>
</span><span id="line-834"></span><span>    </span><span id="local-6989586621684391316"><span class="annot"><span class="annottext">onInput :: (a, [VName], t (LambdaT fromrep, b))
-&gt; AllocM fromrep rep (a, [VName], t (Lambda rep, b))
</span><a href="#local-6989586621684391316"><span class="hs-identifier hs-var hs-var">onInput</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684391108"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684391108"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391107"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684391107"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684391106"><span class="annot"><span class="annottext">t (LambdaT fromrep, b)
</span><a href="#local-6989586621684391106"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-835"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684391108"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684391107"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(t (Lambda rep, b) -&gt; (a, [VName], t (Lambda rep, b)))
-&gt; AllocM fromrep rep (t (Lambda rep, b))
-&gt; AllocM fromrep rep (a, [VName], t (Lambda rep, b))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((LambdaT fromrep, b) -&gt; AllocM fromrep rep (Lambda rep, b))
-&gt; t (LambdaT fromrep, b) -&gt; AllocM fromrep rep (t (Lambda rep, b))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
-&gt; [VName]
-&gt; (LambdaT fromrep, b)
-&gt; AllocM fromrep rep (Lambda rep, b)
forall {a} {rep} {fromrep} {inner} {b}.
(ArrayShape a, HasLetDecMem (LetDec rep), BuilderOps rep,
 PrettyRep fromrep, OpReturns inner, SizeSubst inner,
 BodyDec fromrep ~ (), FParamInfo rep ~ FParamMem, ExpDec rep ~ (),
 FParamInfo fromrep ~ DeclType, LParamInfo fromrep ~ Type,
 BodyDec rep ~ (), BranchType fromrep ~ ExtType,
 RetType rep ~ RetTypeMem, BranchType rep ~ BranchTypeMem,
 RetType fromrep ~ DeclExtType, LParamInfo rep ~ LParamMem,
 Op rep ~ MemOp inner, LetDec rep ~ LParamMem) =&gt;
a
-&gt; [VName]
-&gt; (LambdaT fromrep, b)
-&gt; AllocM fromrep rep (Lambda rep, b)
</span><a href="#local-6989586621684391105"><span class="hs-identifier hs-var">onOp</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684391108"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684391107"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">t (LambdaT fromrep, b)
</span><a href="#local-6989586621684391106"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-836"></span><span>
</span><span id="line-837"></span><span>    </span><span id="local-6989586621684391105"><span class="annot"><span class="annottext">onOp :: a
-&gt; [VName]
-&gt; (LambdaT fromrep, b)
-&gt; AllocM fromrep rep (Lambda rep, b)
</span><a href="#local-6989586621684391105"><span class="hs-identifier hs-var hs-var">onOp</span></a></span></span><span> </span><span id="local-6989586621684390964"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684390964"><span class="hs-identifier hs-var">accshape</span></a></span></span><span> </span><span id="local-6989586621684390963"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684390963"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684390962"><span class="annot"><span class="annottext">LambdaT fromrep
</span><a href="#local-6989586621684390962"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390961"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684390961"><span class="hs-identifier hs-var">nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-838"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684390960"><span class="annot"><span class="annottext">num_vs :: Int
</span><a href="#local-6989586621684390960"><span class="hs-identifier hs-var hs-var">num_vs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Type] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT fromrep -&gt; [Type]
forall rep. LambdaT rep -&gt; [Type]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT fromrep
</span><a href="#local-6989586621684390962"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-839"></span><span>          </span><span id="local-6989586621684390958"><span class="annot"><span class="annottext">num_is :: Int
</span><a href="#local-6989586621684390958"><span class="hs-identifier hs-var hs-var">num_is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Int
forall a. ArrayShape a =&gt; a -&gt; Int
</span><a href="Futhark.IR.Syntax.Core.html#shapeRank"><span class="hs-identifier hs-var">shapeRank</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684390964"><span class="hs-identifier hs-var">accshape</span></a></span><span>
</span><span id="line-840"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684390956"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684390956"><span class="hs-identifier hs-var">i_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390955"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684390955"><span class="hs-identifier hs-var">x_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390954"><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684390954"><span class="hs-identifier hs-var">y_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-841"></span><span>            </span><span class="annot"><span class="annottext">Int
-&gt; Int
-&gt; [Param Type]
-&gt; ([Param Type], [Param Type], [Param Type])
forall a. Int -&gt; Int -&gt; [a] -&gt; ([a], [a], [a])
</span><a href="Futhark.Util.html#splitAt3"><span class="hs-identifier hs-var">splitAt3</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390958"><span class="hs-identifier hs-var">num_is</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390960"><span class="hs-identifier hs-var">num_vs</span></a></span><span> </span><span class="annot"><span class="annottext">([Param Type] -&gt; ([Param Type], [Param Type], [Param Type]))
-&gt; [Param Type] -&gt; ([Param Type], [Param Type], [Param Type])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LambdaT fromrep -&gt; [LParam fromrep]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT fromrep
</span><a href="#local-6989586621684390962"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-842"></span><span>          </span><span id="local-6989586621684390953"><span class="annot"><span class="annottext">i_params' :: [Param LParamMem]
</span><a href="#local-6989586621684390953"><span class="hs-identifier hs-var hs-var">i_params'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; Param LParamMem)
-&gt; [Param Type] -&gt; [Param LParamMem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span id="local-6989586621684390952"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684390952"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684390951"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390951"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="annot"><span class="annottext">Type
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Attrs -&gt; VName -&gt; LParamMem -&gt; Param LParamMem
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684390952"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390951"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(LParamMem -&gt; Param LParamMem) -&gt; LParamMem -&gt; Param LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; LParamMem
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684390956"><span class="hs-identifier hs-var">i_params</span></a></span><span>
</span><span id="line-843"></span><span>          </span><span id="local-6989586621684390950"><span class="annot"><span class="annottext">is :: [DimIndex SubExp]
</span><a href="#local-6989586621684390950"><span class="hs-identifier hs-var hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param LParamMem -&gt; DimIndex SubExp)
-&gt; [Param LParamMem] -&gt; [DimIndex SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; DimIndex SubExp
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; DimIndex SubExp)
-&gt; (Param LParamMem -&gt; SubExp)
-&gt; Param LParamMem
-&gt; DimIndex SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp)
-&gt; (Param LParamMem -&gt; VName) -&gt; Param LParamMem -&gt; SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684390953"><span class="hs-identifier hs-var">i_params'</span></a></span><span>
</span><span id="line-844"></span><span>      </span><span id="local-6989586621684390948"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684390948"><span class="hs-identifier hs-var">x_params'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; VName -&gt; AllocM fromrep rep (Param LParamMem))
-&gt; [Param Type] -&gt; [VName] -&gt; AllocM fromrep rep [Param LParamMem]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex SubExp]
-&gt; Param Type -&gt; VName -&gt; AllocM fromrep rep (Param LParamMem)
forall {f :: * -&gt; *} {rep} {inner} {u}.
(Monad f, HasLetDecMem (LetDec rep), ASTRep rep, OpReturns inner,
 HasScope rep f, Pretty u, FParamInfo rep ~ FParamMem,
 LParamInfo rep ~ LParamMem, RetType rep ~ RetTypeMem,
 BranchType rep ~ BranchTypeMem, Op rep ~ MemOp inner) =&gt;
[DimIndex SubExp]
-&gt; Param (TypeBase Shape u)
-&gt; VName
-&gt; f (Param (MemInfo SubExp u MemBind))
</span><a href="#local-6989586621684390947"><span class="hs-identifier hs-var">onXParam</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684390950"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684390955"><span class="hs-identifier hs-var">x_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684390963"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-845"></span><span>      </span><span id="local-6989586621684390946"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684390946"><span class="hs-identifier hs-var">y_params'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Param Type -&gt; VName -&gt; AllocM fromrep rep (Param LParamMem))
-&gt; [Param Type] -&gt; [VName] -&gt; AllocM fromrep rep [Param LParamMem]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex SubExp]
-&gt; Param Type -&gt; VName -&gt; AllocM fromrep rep (Param LParamMem)
forall {rep} {fromrep} {inner} {u}.
(PrettyRep fromrep, HasLetDecMem (LetDec rep), OpReturns inner,
 SizeSubst inner, BuilderOps rep, Pretty u,
 FParamInfo rep ~ FParamMem, LetDec rep ~ LParamMem,
 ExpDec rep ~ (), LParamInfo rep ~ LParamMem,
 FParamInfo fromrep ~ DeclType, BodyDec rep ~ (),
 RetType rep ~ RetTypeMem, LParamInfo fromrep ~ Type,
 BodyDec fromrep ~ (), BranchType rep ~ BranchTypeMem,
 BranchType fromrep ~ ExtType, RetType fromrep ~ DeclExtType,
 Op rep ~ MemOp inner) =&gt;
[DimIndex SubExp]
-&gt; Param (TypeBase Shape u)
-&gt; VName
-&gt; AllocM fromrep rep (Param (MemInfo SubExp u MemBind))
</span><a href="#local-6989586621684390945"><span class="hs-identifier hs-var">onYParam</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684390950"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Param Type]
</span><a href="#local-6989586621684390954"><span class="hs-identifier hs-var">y_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684390963"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-846"></span><span>      </span><span id="local-6989586621684390944"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684390944"><span class="hs-identifier hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-847"></span><span>        </span><span class="annot"><span class="annottext">[LParam rep] -&gt; Body fromrep -&gt; AllocM fromrep rep (Lambda rep)
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
[LParam torep]
-&gt; Body fromrep -&gt; AllocM fromrep torep (Lambda torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInLambda"><span class="hs-identifier hs-var">allocInLambda</span></a></span><span>
</span><span id="line-848"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684390953"><span class="hs-identifier hs-var">i_params'</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684390948"><span class="hs-identifier hs-var">x_params'</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684390946"><span class="hs-identifier hs-var">y_params'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-849"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LambdaT fromrep -&gt; Body fromrep
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT fromrep
</span><a href="#local-6989586621684390962"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-850"></span><span>      </span><span class="annot"><span class="annottext">(Lambda rep, b) -&gt; AllocM fromrep rep (Lambda rep, b)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684390944"><span class="hs-identifier hs-var">lam'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684390961"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-851"></span><span>
</span><span id="line-852"></span><span>    </span><span id="local-6989586621684390936"><span class="annot"><span class="annottext">mkP :: Attrs
-&gt; VName
-&gt; PrimType
-&gt; Shape
-&gt; u
-&gt; VName
-&gt; IxFun (TPrimExp Int64 VName)
-&gt; [DimIndex SubExp]
-&gt; Param (MemInfo SubExp u MemBind)
</span><a href="#local-6989586621684390936"><span class="hs-identifier hs-var hs-var">mkP</span></a></span></span><span> </span><span id="local-6989586621684390935"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684390935"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684390934"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390934"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684390933"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390933"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684390932"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684390932"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684390931"><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684390931"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621684390930"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390930"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684390929"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684390929"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span> </span><span id="local-6989586621684390928"><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684390928"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-853"></span><span>      </span><span class="annot"><span class="annottext">Attrs
-&gt; VName
-&gt; MemInfo SubExp u MemBind
-&gt; Param (MemInfo SubExp u MemBind)
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684390935"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390934"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">(MemInfo SubExp u MemBind -&gt; Param (MemInfo SubExp u MemBind))
-&gt; (Slice (TPrimExp Int64 VName) -&gt; MemInfo SubExp u MemBind)
-&gt; Slice (TPrimExp Int64 VName)
-&gt; Param (MemInfo SubExp u MemBind)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; u -&gt; MemBind -&gt; MemInfo SubExp u MemBind
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390933"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684390932"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684390931"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; MemInfo SubExp u MemBind)
-&gt; (Slice (TPrimExp Int64 VName) -&gt; MemBind)
-&gt; Slice (TPrimExp Int64 VName)
-&gt; MemInfo SubExp u MemBind
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390930"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">(IxFun (TPrimExp Int64 VName) -&gt; MemBind)
-&gt; (Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName))
-&gt; Slice (TPrimExp Int64 VName)
-&gt; MemBind
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
-&gt; Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; Slice num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#slice"><span class="hs-identifier hs-var">IxFun.slice</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684390929"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice (TPrimExp Int64 VName) -&gt; Param (MemInfo SubExp u MemBind))
-&gt; Slice (TPrimExp Int64 VName) -&gt; Param (MemInfo SubExp u MemBind)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-854"></span><span>        </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; Slice SubExp -&gt; Slice (TPrimExp Int64 VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice SubExp -&gt; Slice (TPrimExp Int64 VName))
-&gt; Slice SubExp -&gt; Slice (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex SubExp] -&gt; Slice SubExp)
-&gt; [DimIndex SubExp] -&gt; Slice SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684390928"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; [DimIndex SubExp] -&gt; [DimIndex SubExp]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; DimIndex SubExp) -&gt; [SubExp] -&gt; [DimIndex SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; DimIndex SubExp
</span><a href="Futhark.Construct.html#sliceDim"><span class="hs-identifier hs-var">sliceDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684390932"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-855"></span><span>
</span><span id="line-856"></span><span>    </span><span id="local-6989586621684390947"><span class="annot"><span class="annottext">onXParam :: [DimIndex SubExp]
-&gt; Param (TypeBase Shape u)
-&gt; VName
-&gt; f (Param (MemInfo SubExp u MemBind))
</span><a href="#local-6989586621684390947"><span class="hs-identifier hs-var hs-var">onXParam</span></a></span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span id="local-6989586621684390874"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684390874"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684390873"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390873"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684390872"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390872"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-857"></span><span>      </span><span class="annot"><span class="annottext">Param (MemInfo SubExp u MemBind)
-&gt; f (Param (MemInfo SubExp u MemBind))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp u MemBind)
 -&gt; f (Param (MemInfo SubExp u MemBind)))
-&gt; Param (MemInfo SubExp u MemBind)
-&gt; f (Param (MemInfo SubExp u MemBind))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Attrs
-&gt; VName
-&gt; MemInfo SubExp u MemBind
-&gt; Param (MemInfo SubExp u MemBind)
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684390874"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390873"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; MemInfo SubExp u MemBind
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390872"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-858"></span><span>    </span><span class="annot"><a href="#local-6989586621684390947"><span class="hs-identifier hs-var">onXParam</span></a></span><span> </span><span id="local-6989586621684390871"><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684390871"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span id="local-6989586621684390870"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684390870"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684390869"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390869"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684390868"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390868"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684390867"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684390867"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684390866"><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684390866"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684390865"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390865"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-859"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684390864"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390864"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390863"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684390863"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; f (VName, IxFun (TPrimExp Int64 VName))
forall rep inner (m :: * -&gt; *).
(Mem rep inner, HasScope rep m, Monad m) =&gt;
VName -&gt; m (VName, IxFun (TPrimExp Int64 VName))
</span><a href="Futhark.IR.Mem.html#lookupArraySummary"><span class="hs-identifier hs-var">lookupArraySummary</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390865"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-860"></span><span>      </span><span class="annot"><span class="annottext">Param (MemInfo SubExp u MemBind)
-&gt; f (Param (MemInfo SubExp u MemBind))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp u MemBind)
 -&gt; f (Param (MemInfo SubExp u MemBind)))
-&gt; Param (MemInfo SubExp u MemBind)
-&gt; f (Param (MemInfo SubExp u MemBind))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Attrs
-&gt; VName
-&gt; PrimType
-&gt; Shape
-&gt; u
-&gt; VName
-&gt; IxFun (TPrimExp Int64 VName)
-&gt; [DimIndex SubExp]
-&gt; Param (MemInfo SubExp u MemBind)
forall {u}.
Attrs
-&gt; VName
-&gt; PrimType
-&gt; Shape
-&gt; u
-&gt; VName
-&gt; IxFun (TPrimExp Int64 VName)
-&gt; [DimIndex SubExp]
-&gt; Param (MemInfo SubExp u MemBind)
</span><a href="#local-6989586621684390936"><span class="hs-identifier hs-var">mkP</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684390870"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390869"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390868"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684390867"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684390866"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390864"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684390863"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684390871"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-861"></span><span>    </span><span class="annot"><a href="#local-6989586621684390947"><span class="hs-identifier hs-var">onXParam</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684390862"><span class="annot"><span class="annottext">Param (TypeBase Shape u)
</span><a href="#local-6989586621684390862"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-862"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; f (Param (MemInfo SubExp u MemBind))
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; f (Param (MemInfo SubExp u MemBind)))
-&gt; String -&gt; f (Param (MemInfo SubExp u MemBind))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot handle MkAcc param: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase Shape u) -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase Shape u)
</span><a href="#local-6989586621684390862"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-863"></span><span>
</span><span id="line-864"></span><span>    </span><span id="local-6989586621684390945"><span class="annot"><span class="annottext">onYParam :: [DimIndex SubExp]
-&gt; Param (TypeBase Shape u)
-&gt; VName
-&gt; AllocM fromrep rep (Param (MemInfo SubExp u MemBind))
</span><a href="#local-6989586621684390945"><span class="hs-identifier hs-var hs-var">onYParam</span></a></span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span id="local-6989586621684390763"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684390763"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684390762"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390762"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684390761"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390761"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-865"></span><span>      </span><span class="annot"><span class="annottext">Param (MemInfo SubExp u MemBind)
-&gt; AllocM fromrep rep (Param (MemInfo SubExp u MemBind))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp u MemBind)
 -&gt; AllocM fromrep rep (Param (MemInfo SubExp u MemBind)))
-&gt; Param (MemInfo SubExp u MemBind)
-&gt; AllocM fromrep rep (Param (MemInfo SubExp u MemBind))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Attrs
-&gt; VName
-&gt; MemInfo SubExp u MemBind
-&gt; Param (MemInfo SubExp u MemBind)
forall dec. Attrs -&gt; VName -&gt; dec -&gt; Param dec
</span><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-var">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684390763"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390762"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">(MemInfo SubExp u MemBind -&gt; Param (MemInfo SubExp u MemBind))
-&gt; MemInfo SubExp u MemBind -&gt; Param (MemInfo SubExp u MemBind)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; MemInfo SubExp u MemBind
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390761"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-866"></span><span>    </span><span class="annot"><a href="#local-6989586621684390945"><span class="hs-identifier hs-var">onYParam</span></a></span><span> </span><span id="local-6989586621684390760"><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684390760"><span class="hs-identifier hs-var">is</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span id="local-6989586621684390759"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684390759"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684390758"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390758"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684390757"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390757"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684390756"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684390756"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684390755"><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684390755"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684390754"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390754"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-867"></span><span>      </span><span id="local-6989586621684390753"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684390753"><span class="hs-identifier hs-var">arr_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; AllocM fromrep rep Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390754"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-868"></span><span>      </span><span id="local-6989586621684390752"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390752"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Type -&gt; Space -&gt; AllocM fromrep rep VName
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Type -&gt; Space -&gt; AllocM fromrep torep VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocForArray"><span class="hs-identifier hs-var">allocForArray</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684390753"><span class="hs-identifier hs-var">arr_t</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span>
</span><span id="line-869"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684390751"><span class="annot"><span class="annottext">base_dims :: [TPrimExp Int64 VName]
</span><a href="#local-6989586621684390751"><span class="hs-identifier hs-var hs-var">base_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TPrimExp Int64 VName])
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684390753"><span class="hs-identifier hs-var">arr_t</span></a></span><span>
</span><span id="line-870"></span><span>          </span><span id="local-6989586621684390750"><span class="annot"><span class="annottext">ixfun :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684390750"><span class="hs-identifier hs-var hs-var">ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; IxFun (TPrimExp Int64 VName)
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684390751"><span class="hs-identifier hs-var">base_dims</span></a></span><span>
</span><span id="line-871"></span><span>      </span><span class="annot"><span class="annottext">Param (MemInfo SubExp u MemBind)
-&gt; AllocM fromrep rep (Param (MemInfo SubExp u MemBind))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp u MemBind)
 -&gt; AllocM fromrep rep (Param (MemInfo SubExp u MemBind)))
-&gt; Param (MemInfo SubExp u MemBind)
-&gt; AllocM fromrep rep (Param (MemInfo SubExp u MemBind))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Attrs
-&gt; VName
-&gt; PrimType
-&gt; Shape
-&gt; u
-&gt; VName
-&gt; IxFun (TPrimExp Int64 VName)
-&gt; [DimIndex SubExp]
-&gt; Param (MemInfo SubExp u MemBind)
forall {u}.
Attrs
-&gt; VName
-&gt; PrimType
-&gt; Shape
-&gt; u
-&gt; VName
-&gt; IxFun (TPrimExp Int64 VName)
-&gt; [DimIndex SubExp]
-&gt; Param (MemInfo SubExp u MemBind)
</span><a href="#local-6989586621684390936"><span class="hs-identifier hs-var">mkP</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684390759"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390758"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390757"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684390756"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684390755"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390752"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684390750"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><a href="#local-6989586621684390760"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-872"></span><span>    </span><span class="annot"><a href="#local-6989586621684390945"><span class="hs-identifier hs-var">onYParam</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684390749"><span class="annot"><span class="annottext">Param (TypeBase Shape u)
</span><a href="#local-6989586621684390749"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-873"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; AllocM fromrep rep (Param (MemInfo SubExp u MemBind))
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; AllocM fromrep rep (Param (MemInfo SubExp u MemBind)))
-&gt; String -&gt; AllocM fromrep rep (Param (MemInfo SubExp u MemBind))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot handle MkAcc param: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase Shape u) -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase Shape u)
</span><a href="#local-6989586621684390749"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-874"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInExp"><span class="hs-identifier hs-var">allocInExp</span></a></span><span> </span><span id="local-6989586621684390748"><span class="annot"><span class="annottext">ExpT fromrep
</span><a href="#local-6989586621684390748"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Mapper fromrep torep (AllocM fromrep torep)
-&gt; ExpT fromrep -&gt; AllocM fromrep torep (ExpT torep)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
Mapper frep trep m -&gt; Exp frep -&gt; m (Exp trep)
</span><a href="Futhark.IR.Traversals.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a></span><span> </span><span class="annot"><span class="annottext">Mapper fromrep torep (AllocM fromrep torep)
</span><a href="#local-6989586621684390746"><span class="hs-identifier hs-var">alloc</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT fromrep
</span><a href="#local-6989586621684390748"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-875"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-876"></span><span>    </span><span id="local-6989586621684390746"><span class="annot"><span class="annottext">alloc :: Mapper fromrep torep (AllocM fromrep torep)
</span><a href="#local-6989586621684390746"><span class="hs-identifier hs-var hs-var">alloc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-877"></span><span>      </span><span class="annot"><span class="annottext">Mapper Any Any (AllocM fromrep torep)
forall (m :: * -&gt; *) rep. Monad m =&gt; Mapper rep rep m
</span><a href="Futhark.IR.Traversals.html#identityMapper"><span class="hs-identifier hs-var">identityMapper</span></a></span><span>
</span><span id="line-878"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnBody :: Scope torep -&gt; BodyT fromrep -&gt; AllocM fromrep torep (BodyT torep)
</span><a href="Futhark.IR.Traversals.html#mapOnBody"><span class="hs-identifier hs-var">mapOnBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Scope torep
-&gt; BodyT fromrep
-&gt; AllocM fromrep torep (BodyT torep)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unhandled Body in ExplicitAllocations&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-879"></span><span>          </span><span class="annot"><span class="annottext">mapOnRetType :: RetType fromrep -&gt; AllocM fromrep torep (RetType torep)
</span><a href="Futhark.IR.Traversals.html#mapOnRetType"><span class="hs-identifier hs-var">mapOnRetType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; RetType fromrep -&gt; AllocM fromrep torep (RetType torep)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unhandled RetType in ExplicitAllocations&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-880"></span><span>          </span><span class="annot"><span class="annottext">mapOnBranchType :: BranchType fromrep -&gt; AllocM fromrep torep (BranchType torep)
</span><a href="Futhark.IR.Traversals.html#mapOnBranchType"><span class="hs-identifier hs-var">mapOnBranchType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
-&gt; BranchType fromrep -&gt; AllocM fromrep torep (BranchType torep)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unhandled BranchType in ExplicitAllocations&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-881"></span><span>          </span><span class="annot"><span class="annottext">mapOnFParam :: FParam fromrep -&gt; AllocM fromrep torep (FParam torep)
</span><a href="Futhark.IR.Traversals.html#mapOnFParam"><span class="hs-identifier hs-var">mapOnFParam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; FParam fromrep -&gt; AllocM fromrep torep (FParam torep)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unhandled FParam in ExplicitAllocations&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-882"></span><span>          </span><span class="annot"><span class="annottext">mapOnLParam :: LParam fromrep -&gt; AllocM fromrep torep (LParam torep)
</span><a href="Futhark.IR.Traversals.html#mapOnLParam"><span class="hs-identifier hs-var">mapOnLParam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; LParam fromrep -&gt; AllocM fromrep torep (LParam torep)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Unhandled LParam in ExplicitAllocations&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-883"></span><span>          </span><span class="annot"><span class="annottext">mapOnOp :: Op fromrep -&gt; AllocM fromrep torep (Op torep)
</span><a href="Futhark.IR.Traversals.html#mapOnOp"><span class="hs-identifier hs-var">mapOnOp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684390725"><span class="annot"><span class="annottext">Op fromrep
</span><a href="#local-6989586621684390725"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-884"></span><span>            </span><span id="local-6989586621684390724"><span class="annot"><span class="annottext">Op fromrep -&gt; AllocM fromrep torep (Op torep)
</span><a href="#local-6989586621684390724"><span class="hs-identifier hs-var">handle</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(AllocEnv fromrep torep
 -&gt; Op fromrep -&gt; AllocM fromrep torep (Op torep))
-&gt; AllocM
     fromrep torep (Op fromrep -&gt; AllocM fromrep torep (Op torep))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">AllocEnv fromrep torep
-&gt; Op fromrep -&gt; AllocM fromrep torep (Op torep)
forall fromrep torep.
AllocEnv fromrep torep
-&gt; Op fromrep -&gt; AllocM fromrep torep (Op torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInOp"><span class="hs-identifier hs-var hs-var">allocInOp</span></a></span><span>
</span><span id="line-885"></span><span>            </span><span class="annot"><span class="annottext">Op fromrep -&gt; AllocM fromrep torep (Op torep)
</span><a href="#local-6989586621684390724"><span class="hs-identifier hs-var">handle</span></a></span><span> </span><span class="annot"><span class="annottext">Op fromrep
</span><a href="#local-6989586621684390725"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-886"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-887"></span><span>
</span><span id="line-888"></span><span id="local-6989586621684395624"><span id="local-6989586621684395625"><span id="local-6989586621684395626"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#lookupIxFun"><span class="hs-identifier hs-type">lookupIxFun</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-889"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395626"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395625"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395624"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-890"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-891"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395626"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395625"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-892"></span><span id="lookupIxFun"><span class="annot"><span class="annottext">lookupIxFun :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
VName
-&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName)))
</span><a href="Futhark.Pass.ExplicitAllocations.html#lookupIxFun"><span class="hs-identifier hs-var hs-var">lookupIxFun</span></a></span></span><span> </span><span id="local-6989586621684390681"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390681"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-893"></span><span>  </span><span id="local-6989586621684390680"><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684390680"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; AllocM fromrep torep LParamMem
forall rep (m :: * -&gt; *) inner.
(HasScope rep m, Mem rep inner) =&gt;
VName -&gt; m LParamMem
</span><a href="Futhark.IR.Mem.html#lookupMemInfo"><span class="hs-identifier hs-var">lookupMemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390681"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-894"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684390680"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-895"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684390679"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390679"><span class="hs-identifier hs-var">_ptp</span></a></span></span><span> </span><span id="local-6989586621684390678"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684390678"><span class="hs-identifier hs-var">_shp</span></a></span></span><span> </span><span id="local-6989586621684390677"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684390677"><span class="hs-identifier hs-var">_u</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684390676"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684390676"><span class="hs-identifier hs-var">ixf</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp Int64 VName))
-&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (IxFun (TPrimExp Int64 VName))
 -&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName))))
-&gt; Maybe (IxFun (TPrimExp Int64 VName))
-&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
-&gt; Maybe (IxFun (TPrimExp Int64 VName))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684390676"><span class="hs-identifier hs-var">ixf</span></a></span><span>
</span><span id="line-896"></span><span>    </span><span class="annot"><span class="annottext">LParamMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp Int64 VName))
-&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp Int64 VName))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-897"></span><span>
</span><span id="line-898"></span><span id="local-6989586621684395423"><span id="local-6989586621684395424"><span id="local-6989586621684395425"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#subExpIxFun"><span class="hs-identifier hs-type">subExpIxFun</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-899"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395425"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395424"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395423"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-900"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-901"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395425"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395424"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-902"></span><span id="subExpIxFun"><span class="annot"><span class="annottext">subExpIxFun :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
SubExp
-&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName)))
</span><a href="Futhark.Pass.ExplicitAllocations.html#subExpIxFun"><span class="hs-identifier hs-var hs-var">subExpIxFun</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp Int64 VName))
-&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp Int64 VName))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-903"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#subExpIxFun"><span class="hs-identifier hs-var">subExpIxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684390597"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390597"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName)))
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
VName
-&gt; AllocM fromrep torep (Maybe (IxFun (TPrimExp Int64 VName)))
</span><a href="Futhark.Pass.ExplicitAllocations.html#lookupIxFun"><span class="hs-identifier hs-var">lookupIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390597"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-904"></span><span>
</span><span id="line-905"></span><span id="local-6989586621684395436"><span id="local-6989586621684395437"><span id="local-6989586621684395438"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#addResCtxInIfBody"><span class="hs-identifier hs-type">addResCtxInIfBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-906"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395438"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395437"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395436"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-907"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ExtType"><span class="hs-identifier hs-type">ExtType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-908"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395437"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-909"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-910"></span><span>  </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ExtIxFun"><span class="hs-identifier hs-type">ExtIxFun</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-911"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395438"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395437"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395437"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Mem.html#BodyReturns"><span class="hs-identifier hs-type">BodyReturns</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-912"></span><span id="addResCtxInIfBody"><span class="annot"><span class="annottext">addResCtxInIfBody :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
[ExtType]
-&gt; Body torep
-&gt; [Maybe Space]
-&gt; [Maybe (ExtIxFun, [TPrimExp Int64 VName])]
-&gt; AllocM fromrep torep (Body torep, [BranchTypeMem])
</span><a href="Futhark.Pass.ExplicitAllocations.html#addResCtxInIfBody"><span class="hs-identifier hs-var hs-var">addResCtxInIfBody</span></a></span></span><span> </span><span id="local-6989586621684390484"><span class="annot"><span class="annottext">[ExtType]
</span><a href="#local-6989586621684390484"><span class="hs-identifier hs-var">ifrets</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec torep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684390483"><span class="annot"><span class="annottext">Stms torep
</span><a href="#local-6989586621684390483"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684390482"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390482"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684390481"><span class="annot"><span class="annottext">[Maybe Space]
</span><a href="#local-6989586621684390481"><span class="hs-identifier hs-var">spaces</span></a></span></span><span> </span><span id="local-6989586621684390480"><span class="annot"><span class="annottext">[Maybe (ExtIxFun, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684390480"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AllocM fromrep torep (Result, [BranchTypeMem])
-&gt; AllocM
     fromrep torep (Body (Rep (AllocM fromrep torep)), [BranchTypeMem])
forall (m :: * -&gt; *) a.
MonadBuilder m =&gt;
m (Result, a) -&gt; m (Body (Rep m), a)
</span><a href="Futhark.Construct.html#buildBody"><span class="hs-identifier hs-var">buildBody</span></a></span><span> </span><span class="annot"><span class="annottext">(AllocM fromrep torep (Result, [BranchTypeMem])
 -&gt; AllocM
      fromrep torep (Body (Rep (AllocM fromrep torep)), [BranchTypeMem]))
-&gt; AllocM fromrep torep (Result, [BranchTypeMem])
-&gt; AllocM
     fromrep torep (Body (Rep (AllocM fromrep torep)), [BranchTypeMem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-913"></span><span>  </span><span class="annot"><span class="annottext">(Stm torep -&gt; AllocM fromrep torep ())
-&gt; Stms torep -&gt; AllocM fromrep torep ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">Stm torep -&gt; AllocM fromrep torep ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStm"><span class="hs-identifier hs-var">addStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stms torep
</span><a href="#local-6989586621684390483"><span class="hs-identifier hs-var">stms</span></a></span><span>
</span><span id="line-914"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684390478"><span class="annot"><span class="annottext">offsets :: [Int]
</span><a href="#local-6989586621684390478"><span class="hs-identifier hs-var hs-var">offsets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Int) -&gt; Int -&gt; [Int] -&gt; [Int]
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">scanl</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(+)</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; [Int]) -&gt; [Int] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(ExtType -&gt; Maybe (ExtIxFun, [TPrimExp Int64 VName]) -&gt; Int)
-&gt; [ExtType] -&gt; [Maybe (ExtIxFun, [TPrimExp Int64 VName])] -&gt; [Int]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">ExtType -&gt; Maybe (ExtIxFun, [TPrimExp Int64 VName]) -&gt; Int
forall {t :: * -&gt; *} {shape} {u} {a} {a}.
Foldable t =&gt;
TypeBase shape u -&gt; Maybe (a, t a) -&gt; Int
</span><a href="#local-6989586621684390476"><span class="hs-identifier hs-var">numCtxNeeded</span></a></span><span> </span><span class="annot"><span class="annottext">[ExtType]
</span><a href="#local-6989586621684390484"><span class="hs-identifier hs-var">ifrets</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe (ExtIxFun, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684390480"><span class="hs-identifier hs-var">substs</span></a></span><span>
</span><span id="line-915"></span><span>      </span><span id="local-6989586621684390475"><span class="annot"><span class="annottext">num_new_ctx :: Int
</span><a href="#local-6989586621684390475"><span class="hs-identifier hs-var hs-var">num_new_ctx</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684390478"><span class="hs-identifier hs-var">offsets</span></a></span><span>
</span><span id="line-916"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684390473"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390473"><span class="hs-identifier hs-var">ctx</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390472"><span class="annot"><span class="annottext">[BranchTypeMem]
</span><a href="#local-6989586621684390472"><span class="hs-identifier hs-var">ctx_rets</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390471"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390471"><span class="hs-identifier hs-var">res'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390470"><span class="annot"><span class="annottext">[BranchTypeMem]
</span><a href="#local-6989586621684390470"><span class="hs-identifier hs-var">res_rets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-917"></span><span>    </span><span class="annot"><span class="annottext">((Result, [BranchTypeMem], Result, [BranchTypeMem])
 -&gt; (ExtType, SubExpRes, Maybe (ExtIxFun, [TPrimExp Int64 VName]),
     Maybe Space, Int)
 -&gt; AllocM
      fromrep torep (Result, [BranchTypeMem], Result, [BranchTypeMem]))
-&gt; (Result, [BranchTypeMem], Result, [BranchTypeMem])
-&gt; [(ExtType, SubExpRes, Maybe (ExtIxFun, [TPrimExp Int64 VName]),
     Maybe Space, Int)]
-&gt; AllocM
     fromrep torep (Result, [BranchTypeMem], Result, [BranchTypeMem])
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
-&gt; (Result, [BranchTypeMem], Result, [BranchTypeMem])
-&gt; (ExtType, SubExpRes, Maybe (ExtIxFun, [TPrimExp Int64 VName]),
    Maybe Space, Int)
-&gt; AllocM
     fromrep torep (Result, [BranchTypeMem], Result, [BranchTypeMem])
forall {torep} {fromrep} {a} {inner} {u} {u}.
(PrettyRep fromrep, HasLetDecMem (LetDec torep), BuilderOps torep,
 ToExp a, OpReturns inner, SizeSubst inner,
 FParamInfo torep ~ FParamMem, LetDec torep ~ LParamMem,
 ExpDec torep ~ (), LParamInfo torep ~ LParamMem,
 FParamInfo fromrep ~ DeclType, BodyDec torep ~ (),
 RetType torep ~ RetTypeMem, LParamInfo fromrep ~ Type,
 BodyDec fromrep ~ (), BranchType torep ~ BranchTypeMem,
 BranchType fromrep ~ ExtType, RetType fromrep ~ DeclExtType,
 Op torep ~ MemOp inner) =&gt;
Int
-&gt; (Result, [MemInfo (Ext SubExp) u MemReturn], Result,
    [MemInfo (Ext SubExp) u MemReturn])
-&gt; (TypeBase ExtShape u, SubExpRes, Maybe (ExtIxFun, [a]),
    Maybe Space, Int)
-&gt; AllocM
     fromrep
     torep
     (Result, [MemInfo (Ext SubExp) u MemReturn], Result,
      [MemInfo (Ext SubExp) u MemReturn])
</span><a href="#local-6989586621684390468"><span class="hs-identifier hs-var">helper</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390475"><span class="hs-identifier hs-var">num_new_ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(ExtType, SubExpRes, Maybe (ExtIxFun, [TPrimExp Int64 VName]),
   Maybe Space, Int)]
 -&gt; AllocM
      fromrep torep (Result, [BranchTypeMem], Result, [BranchTypeMem]))
-&gt; [(ExtType, SubExpRes, Maybe (ExtIxFun, [TPrimExp Int64 VName]),
     Maybe Space, Int)]
-&gt; AllocM
     fromrep torep (Result, [BranchTypeMem], Result, [BranchTypeMem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-918"></span><span>      </span><span class="annot"><span class="annottext">[ExtType]
-&gt; Result
-&gt; [Maybe (ExtIxFun, [TPrimExp Int64 VName])]
-&gt; [Maybe Space]
-&gt; [Int]
-&gt; [(ExtType, SubExpRes, Maybe (ExtIxFun, [TPrimExp Int64 VName]),
     Maybe Space, Int)]
forall a b c d e.
[a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [e] -&gt; [(a, b, c, d, e)]
</span><span class="hs-identifier hs-var">zip5</span></span><span> </span><span class="annot"><span class="annottext">[ExtType]
</span><a href="#local-6989586621684390484"><span class="hs-identifier hs-var">ifrets</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390482"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe (ExtIxFun, [TPrimExp Int64 VName])]
</span><a href="#local-6989586621684390480"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">[Maybe Space]
</span><a href="#local-6989586621684390481"><span class="hs-identifier hs-var">spaces</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684390478"><span class="hs-identifier hs-var">offsets</span></a></span><span>
</span><span id="line-919"></span><span>  </span><span class="annot"><span class="annottext">(Result, [BranchTypeMem])
-&gt; AllocM fromrep torep (Result, [BranchTypeMem])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390473"><span class="hs-identifier hs-var">ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390471"><span class="hs-identifier hs-var">res'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[BranchTypeMem]
</span><a href="#local-6989586621684390472"><span class="hs-identifier hs-var">ctx_rets</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchTypeMem] -&gt; [BranchTypeMem] -&gt; [BranchTypeMem]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[BranchTypeMem]
</span><a href="#local-6989586621684390470"><span class="hs-identifier hs-var">res_rets</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-920"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-921"></span><span>    </span><span id="local-6989586621684390476"><span class="annot"><span class="annottext">numCtxNeeded :: TypeBase shape u -&gt; Maybe (a, t a) -&gt; Int
</span><a href="#local-6989586621684390476"><span class="hs-identifier hs-var hs-var">numCtxNeeded</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">Maybe (a, t a)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-922"></span><span>    </span><span class="annot"><a href="#local-6989586621684390476"><span class="hs-identifier hs-var">numCtxNeeded</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390461"><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621684390461"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">t a -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">t a
</span><a href="#local-6989586621684390461"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-923"></span><span>    </span><span class="annot"><a href="#local-6989586621684390476"><span class="hs-identifier hs-var">numCtxNeeded</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase shape u
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (a, t a)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span>
</span><span id="line-924"></span><span>
</span><span id="line-925"></span><span>    </span><span id="local-6989586621684390468"><span class="annot"><span class="annottext">helper :: Int
-&gt; (Result, [MemInfo (Ext SubExp) u MemReturn], Result,
    [MemInfo (Ext SubExp) u MemReturn])
-&gt; (TypeBase ExtShape u, SubExpRes, Maybe (ExtIxFun, [a]),
    Maybe Space, Int)
-&gt; AllocM
     fromrep
     torep
     (Result, [MemInfo (Ext SubExp) u MemReturn], Result,
      [MemInfo (Ext SubExp) u MemReturn])
</span><a href="#local-6989586621684390468"><span class="hs-identifier hs-var hs-var">helper</span></a></span></span><span>
</span><span id="line-926"></span><span>      </span><span id="local-6989586621684390303"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390303"><span class="hs-identifier hs-var">num_new_ctx</span></a></span></span><span>
</span><span id="line-927"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684390302"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390302"><span class="hs-identifier hs-var">ctx_acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390301"><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
</span><a href="#local-6989586621684390301"><span class="hs-identifier hs-var">ctx_rets_acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390300"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390300"><span class="hs-identifier hs-var">res_acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390299"><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
</span><a href="#local-6989586621684390299"><span class="hs-identifier hs-var">res_rets_acc</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-928"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684390298"><span class="annot"><span class="annottext">TypeBase ExtShape u
</span><a href="#local-6989586621684390298"><span class="hs-identifier hs-var">ifr</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390297"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684390297"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390296"><span class="annot"><span class="annottext">Maybe (ExtIxFun, [a])
</span><a href="#local-6989586621684390296"><span class="hs-identifier hs-var">mbixfsub</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390295"><span class="annot"><span class="annottext">Maybe Space
</span><a href="#local-6989586621684390295"><span class="hs-identifier hs-var">sp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390294"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390294"><span class="hs-identifier hs-var">ctx_offset</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-929"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (ExtIxFun, [a])
</span><a href="#local-6989586621684390296"><span class="hs-identifier hs-var">mbixfsub</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-930"></span><span>          </span><span class="annot"><span class="annottext">Maybe (ExtIxFun, [a])
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-931"></span><span>            </span><span class="hs-comment">-- does NOT generalize/antiunify; ensure direct</span><span>
</span><span id="line-932"></span><span>            </span><span id="local-6989586621684390293"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684390293"><span class="hs-identifier hs-var">r'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe Space -&gt; SubExpRes -&gt; AllocM fromrep torep SubExpRes
forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
Maybe Space -&gt; SubExpRes -&gt; AllocM fromrep torep SubExpRes
</span><a href="Futhark.Pass.ExplicitAllocations.html#ensureDirect"><span class="hs-identifier hs-var">ensureDirect</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Space
</span><a href="#local-6989586621684390295"><span class="hs-identifier hs-var">sp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684390297"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-933"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684390292"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390292"><span class="hs-identifier hs-var">mem_ctx_ses</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390291"><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
</span><a href="#local-6989586621684390291"><span class="hs-identifier hs-var">mem_ctx_rets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
-&gt; (Result, [MemInfo (Ext SubExp) u MemReturn])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
 -&gt; (Result, [MemInfo (Ext SubExp) u MemReturn]))
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
-&gt; AllocM
     fromrep torep (Result, [MemInfo (Ext SubExp) u MemReturn])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
forall fromrep torep inner u.
Allocable fromrep torep inner =&gt;
SubExpRes
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
</span><a href="Futhark.Pass.ExplicitAllocations.html#bodyReturnMemCtx"><span class="hs-identifier hs-var">bodyReturnMemCtx</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684390293"><span class="hs-identifier hs-var">r'</span></a></span><span>
</span><span id="line-934"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684390290"><span class="annot"><span class="annottext">body_ret :: MemInfo (Ext SubExp) u MemReturn
</span><a href="#local-6989586621684390290"><span class="hs-identifier hs-var hs-var">body_ret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Int
-&gt; TypeBase ExtShape u
-&gt; Maybe Space
-&gt; MemInfo (Ext SubExp) u MemReturn
forall {u}.
Int
-&gt; Int
-&gt; TypeBase ExtShape u
-&gt; Maybe Space
-&gt; MemInfo (Ext SubExp) u MemReturn
</span><a href="#local-6989586621684390289"><span class="hs-identifier hs-var">inspect</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390303"><span class="hs-identifier hs-var">num_new_ctx</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390294"><span class="hs-identifier hs-var">ctx_offset</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase ExtShape u
</span><a href="#local-6989586621684390298"><span class="hs-identifier hs-var">ifr</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Space
</span><a href="#local-6989586621684390295"><span class="hs-identifier hs-var">sp</span></a></span><span>
</span><span id="line-935"></span><span>            </span><span class="annot"><span class="annottext">(Result, [MemInfo (Ext SubExp) u MemReturn], Result,
 [MemInfo (Ext SubExp) u MemReturn])
-&gt; AllocM
     fromrep
     torep
     (Result, [MemInfo (Ext SubExp) u MemReturn], Result,
      [MemInfo (Ext SubExp) u MemReturn])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-936"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390302"><span class="hs-identifier hs-var">ctx_acc</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390292"><span class="hs-identifier hs-var">mem_ctx_ses</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-937"></span><span>                </span><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
</span><a href="#local-6989586621684390301"><span class="hs-identifier hs-var">ctx_rets_acc</span></a></span><span> </span><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
-&gt; [MemInfo (Ext SubExp) u MemReturn]
-&gt; [MemInfo (Ext SubExp) u MemReturn]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
</span><a href="#local-6989586621684390291"><span class="hs-identifier hs-var">mem_ctx_rets</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-938"></span><span>                </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390300"><span class="hs-identifier hs-var">res_acc</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684390293"><span class="hs-identifier hs-var">r'</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-939"></span><span>                </span><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
</span><a href="#local-6989586621684390299"><span class="hs-identifier hs-var">res_rets_acc</span></a></span><span> </span><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
-&gt; [MemInfo (Ext SubExp) u MemReturn]
-&gt; [MemInfo (Ext SubExp) u MemReturn]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">MemInfo (Ext SubExp) u MemReturn
</span><a href="#local-6989586621684390290"><span class="hs-identifier hs-var">body_ret</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-940"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-941"></span><span>          </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684390288"><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684390288"><span class="hs-identifier hs-var">ixfn</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390287"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684390287"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-942"></span><span>            </span><span class="hs-comment">-- generalizes</span><span>
</span><span id="line-943"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684390286"><span class="annot"><span class="annottext">i :: Int
</span><a href="#local-6989586621684390286"><span class="hs-identifier hs-var hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684390287"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-944"></span><span>            </span><span id="local-6989586621684390285"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684390285"><span class="hs-identifier hs-var">ext_ses</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(a -&gt; AllocM fromrep torep SubExp)
-&gt; [a] -&gt; AllocM fromrep torep [SubExp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; a -&gt; AllocM fromrep torep SubExp
forall (m :: * -&gt; *) a.
(MonadBuilder m, ToExp a) =&gt;
String -&gt; a -&gt; m SubExp
</span><a href="Futhark.Construct.html#toSubExp"><span class="hs-identifier hs-var">toSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;ixfn_exist&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684390287"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-945"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684390283"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390283"><span class="hs-identifier hs-var">mem_ctx_ses</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390282"><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
</span><a href="#local-6989586621684390282"><span class="hs-identifier hs-var">mem_ctx_rets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
-&gt; (Result, [MemInfo (Ext SubExp) u MemReturn])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
 -&gt; (Result, [MemInfo (Ext SubExp) u MemReturn]))
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
-&gt; AllocM
     fromrep torep (Result, [MemInfo (Ext SubExp) u MemReturn])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
forall fromrep torep inner u.
Allocable fromrep torep inner =&gt;
SubExpRes
-&gt; AllocM
     fromrep torep [(SubExpRes, MemInfo (Ext SubExp) u MemReturn)]
</span><a href="Futhark.Pass.ExplicitAllocations.html#bodyReturnMemCtx"><span class="hs-identifier hs-var">bodyReturnMemCtx</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684390297"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-946"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684390281"><span class="annot"><span class="annottext">sp' :: Space
</span><a href="#local-6989586621684390281"><span class="hs-identifier hs-var hs-var">sp'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space -&gt; Maybe Space -&gt; Space
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Space
</span><a href="#local-6989586621684390295"><span class="hs-identifier hs-var">sp</span></a></span><span>
</span><span id="line-947"></span><span>                </span><span id="local-6989586621684390280"><span class="annot"><span class="annottext">ixfn' :: ExtIxFun
</span><a href="#local-6989586621684390280"><span class="hs-identifier hs-var hs-var">ixfn'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 (Ext VName) -&gt; TPrimExp Int64 (Ext VName))
-&gt; ExtIxFun -&gt; ExtIxFun
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; TPrimExp Int64 (Ext VName) -&gt; TPrimExp Int64 (Ext VName)
forall t. Int -&gt; TPrimExp t (Ext VName) -&gt; TPrimExp t (Ext VName)
</span><a href="#local-6989586621684390279"><span class="hs-identifier hs-var">adjustExtPE</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390294"><span class="hs-identifier hs-var">ctx_offset</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684390288"><span class="hs-identifier hs-var">ixfn</span></a></span><span>
</span><span id="line-948"></span><span>                </span><span id="local-6989586621684390278"><span class="annot"><span class="annottext">exttp :: MemInfo (Ext SubExp) u MemReturn
</span><a href="#local-6989586621684390278"><span class="hs-identifier hs-var hs-var">exttp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">TypeBase ExtShape u
</span><a href="#local-6989586621684390298"><span class="hs-identifier hs-var">ifr</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-949"></span><span>                  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684390277"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390277"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684390276"><span class="annot"><span class="annottext">ExtShape
</span><a href="#local-6989586621684390276"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684390275"><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684390275"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-950"></span><span>                    </span><span class="annot"><span class="annottext">PrimType
-&gt; ExtShape -&gt; u -&gt; MemReturn -&gt; MemInfo (Ext SubExp) u MemReturn
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390277"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Ext SubExp -&gt; Ext SubExp) -&gt; ExtShape -&gt; ExtShape
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Ext SubExp -&gt; Ext SubExp
forall a. Int -&gt; Ext a -&gt; Ext a
</span><a href="#local-6989586621684390274"><span class="hs-identifier hs-var">adjustExt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390303"><span class="hs-identifier hs-var">num_new_ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExtShape
</span><a href="#local-6989586621684390276"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684390275"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemReturn -&gt; MemInfo (Ext SubExp) u MemReturn)
-&gt; MemReturn -&gt; MemInfo (Ext SubExp) u MemReturn
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-951"></span><span>                      </span><span class="annot"><span class="annottext">Space -&gt; Int -&gt; ExtIxFun -&gt; MemReturn
</span><a href="Futhark.IR.Mem.html#ReturnsNewBlock"><span class="hs-identifier hs-var">ReturnsNewBlock</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684390281"><span class="hs-identifier hs-var">sp'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390294"><span class="hs-identifier hs-var">ctx_offset</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390286"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684390280"><span class="hs-identifier hs-var">ixfn'</span></a></span><span>
</span><span id="line-952"></span><span>                  </span><span class="annot"><span class="annottext">TypeBase ExtShape u
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; MemInfo (Ext SubExp) u MemReturn
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Impossible case reached in addResCtxInIfBody&quot;</span></span><span>
</span><span id="line-953"></span><span>            </span><span class="annot"><span class="annottext">(Result, [MemInfo (Ext SubExp) u MemReturn], Result,
 [MemInfo (Ext SubExp) u MemReturn])
-&gt; AllocM
     fromrep
     torep
     (Result, [MemInfo (Ext SubExp) u MemReturn], Result,
      [MemInfo (Ext SubExp) u MemReturn])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-954"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390302"><span class="hs-identifier hs-var">ctx_acc</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Result
</span><a href="Futhark.IR.Syntax.html#subExpsRes"><span class="hs-identifier hs-var">subExpsRes</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684390285"><span class="hs-identifier hs-var">ext_ses</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390283"><span class="hs-identifier hs-var">mem_ctx_ses</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-955"></span><span>                </span><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
</span><a href="#local-6989586621684390301"><span class="hs-identifier hs-var">ctx_rets_acc</span></a></span><span> </span><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
-&gt; [MemInfo (Ext SubExp) u MemReturn]
-&gt; [MemInfo (Ext SubExp) u MemReturn]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; MemInfo (Ext SubExp) u MemReturn)
-&gt; [SubExp] -&gt; [MemInfo (Ext SubExp) u MemReturn]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MemInfo (Ext SubExp) u MemReturn
-&gt; SubExp -&gt; MemInfo (Ext SubExp) u MemReturn
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; MemInfo (Ext SubExp) u MemReturn
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684390285"><span class="hs-identifier hs-var">ext_ses</span></a></span><span> </span><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
-&gt; [MemInfo (Ext SubExp) u MemReturn]
-&gt; [MemInfo (Ext SubExp) u MemReturn]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
</span><a href="#local-6989586621684390282"><span class="hs-identifier hs-var">mem_ctx_rets</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-956"></span><span>                </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390300"><span class="hs-identifier hs-var">res_acc</span></a></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Result -&gt; Result
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684390297"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span>
</span><span id="line-957"></span><span>                </span><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
</span><a href="#local-6989586621684390299"><span class="hs-identifier hs-var">res_rets_acc</span></a></span><span> </span><span class="annot"><span class="annottext">[MemInfo (Ext SubExp) u MemReturn]
-&gt; [MemInfo (Ext SubExp) u MemReturn]
-&gt; [MemInfo (Ext SubExp) u MemReturn]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">MemInfo (Ext SubExp) u MemReturn
</span><a href="#local-6989586621684390278"><span class="hs-identifier hs-var">exttp</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-958"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-959"></span><span>
</span><span id="line-960"></span><span>    </span><span id="local-6989586621684390289"><span class="annot"><span class="annottext">inspect :: Int
-&gt; Int
-&gt; TypeBase ExtShape u
-&gt; Maybe Space
-&gt; MemInfo (Ext SubExp) u MemReturn
</span><a href="#local-6989586621684390289"><span class="hs-identifier hs-var hs-var">inspect</span></a></span></span><span> </span><span id="local-6989586621684390268"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390268"><span class="hs-identifier hs-var">num_new_ctx</span></a></span></span><span> </span><span id="local-6989586621684390267"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390267"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684390266"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390266"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684390265"><span class="annot"><span class="annottext">ExtShape
</span><a href="#local-6989586621684390265"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684390264"><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684390264"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684390263"><span class="annot"><span class="annottext">Maybe Space
</span><a href="#local-6989586621684390263"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-961"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684390262"><span class="annot"><span class="annottext">space' :: Space
</span><a href="#local-6989586621684390262"><span class="hs-identifier hs-var hs-var">space'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space -&gt; Maybe Space -&gt; Space
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Space
</span><a href="#local-6989586621684390263"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-962"></span><span>          </span><span id="local-6989586621684390261"><span class="annot"><span class="annottext">shape' :: ExtShape
</span><a href="#local-6989586621684390261"><span class="hs-identifier hs-var hs-var">shape'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ext SubExp -&gt; Ext SubExp) -&gt; ExtShape -&gt; ExtShape
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Ext SubExp -&gt; Ext SubExp
forall a. Int -&gt; Ext a -&gt; Ext a
</span><a href="#local-6989586621684390274"><span class="hs-identifier hs-var">adjustExt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390268"><span class="hs-identifier hs-var">num_new_ctx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExtShape
</span><a href="#local-6989586621684390265"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-963"></span><span>          </span><span id="local-6989586621684390260"><span class="annot"><span class="annottext">bodyret :: MemInfo (Ext SubExp) u MemReturn
</span><a href="#local-6989586621684390260"><span class="hs-identifier hs-var hs-var">bodyret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-964"></span><span>            </span><span class="annot"><span class="annottext">PrimType
-&gt; ExtShape -&gt; u -&gt; MemReturn -&gt; MemInfo (Ext SubExp) u MemReturn
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390266"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">ExtShape
</span><a href="#local-6989586621684390261"><span class="hs-identifier hs-var">shape'</span></a></span><span> </span><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684390264"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemReturn -&gt; MemInfo (Ext SubExp) u MemReturn)
-&gt; (ExtIxFun -&gt; MemReturn)
-&gt; ExtIxFun
-&gt; MemInfo (Ext SubExp) u MemReturn
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; Int -&gt; ExtIxFun -&gt; MemReturn
</span><a href="Futhark.IR.Mem.html#ReturnsNewBlock"><span class="hs-identifier hs-var">ReturnsNewBlock</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684390262"><span class="hs-identifier hs-var">space'</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390267"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtIxFun -&gt; MemInfo (Ext SubExp) u MemReturn)
-&gt; ExtIxFun -&gt; MemInfo (Ext SubExp) u MemReturn
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-965"></span><span>              </span><span class="annot"><span class="annottext">[TPrimExp Int64 (Ext VName)] -&gt; ExtIxFun
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 (Ext VName)] -&gt; ExtIxFun)
-&gt; [TPrimExp Int64 (Ext VName)] -&gt; ExtIxFun
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Ext SubExp -&gt; TPrimExp Int64 (Ext VName))
-&gt; [Ext SubExp] -&gt; [TPrimExp Int64 (Ext VName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Ext SubExp -&gt; TPrimExp Int64 (Ext VName)
</span><a href="#local-6989586621684390259"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="annot"><span class="annottext">([Ext SubExp] -&gt; [TPrimExp Int64 (Ext VName)])
-&gt; [Ext SubExp] -&gt; [TPrimExp Int64 (Ext VName)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ExtShape -&gt; [Ext SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">ExtShape
</span><a href="#local-6989586621684390261"><span class="hs-identifier hs-var">shape'</span></a></span><span>
</span><span id="line-966"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">MemInfo (Ext SubExp) u MemReturn
</span><a href="#local-6989586621684390260"><span class="hs-identifier hs-var">bodyret</span></a></span><span>
</span><span id="line-967"></span><span>    </span><span class="annot"><a href="#local-6989586621684390289"><span class="hs-identifier hs-var">inspect</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span id="local-6989586621684390258"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390258"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684390257"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684390257"><span class="hs-identifier hs-var">ispace</span></a></span></span><span> </span><span id="local-6989586621684390256"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684390256"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684390255"><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684390255"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Shape -&gt; [Type] -&gt; u -&gt; MemInfo (Ext SubExp) u MemReturn
forall d u ret. VName -&gt; Shape -&gt; [Type] -&gt; u -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-var">MemAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390258"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684390257"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684390256"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684390255"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-968"></span><span>    </span><span class="annot"><a href="#local-6989586621684390289"><span class="hs-identifier hs-var">inspect</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684390254"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390254"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; MemInfo (Ext SubExp) u MemReturn
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390254"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-969"></span><span>    </span><span class="annot"><a href="#local-6989586621684390289"><span class="hs-identifier hs-var">inspect</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684390253"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684390253"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space -&gt; MemInfo (Ext SubExp) u MemReturn
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684390253"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-970"></span><span>
</span><span id="line-971"></span><span>    </span><span id="local-6989586621684390259"><span class="annot"><span class="annottext">convert :: Ext SubExp -&gt; TPrimExp Int64 (Ext VName)
</span><a href="#local-6989586621684390259"><span class="hs-identifier hs-var hs-var">convert</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span id="local-6989586621684390251"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390251"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Ext VName -&gt; TPrimExp Int64 (Ext VName)
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">le64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Ext VName
forall a. Int -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-var">Ext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390251"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-972"></span><span>    </span><span class="annot"><a href="#local-6989586621684390259"><span class="hs-identifier hs-var">convert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-type">Free</span></a></span><span> </span><span id="local-6989586621684390250"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684390250"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Ext VName
forall a. a -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-var">Free</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Ext VName)
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 (Ext VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684390250"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-973"></span><span>
</span><span id="line-974"></span><span>    </span><span id="local-6989586621684395342"><span class="annot"><a href="#local-6989586621684390274"><span class="hs-identifier hs-type">adjustExt</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395342"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395342"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-975"></span><span>    </span><span id="local-6989586621684390274"><span class="annot"><span class="annottext">adjustExt :: forall a. Int -&gt; Ext a -&gt; Ext a
</span><a href="#local-6989586621684390274"><span class="hs-identifier hs-var hs-var">adjustExt</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-type">Free</span></a></span><span> </span><span id="local-6989586621684390248"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684390248"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Ext a
forall a. a -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-var">Free</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684390248"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-976"></span><span>    </span><span class="annot"><a href="#local-6989586621684390274"><span class="hs-identifier hs-var">adjustExt</span></a></span><span> </span><span id="local-6989586621684390247"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390247"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span id="local-6989586621684390246"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390246"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Ext a
forall a. Int -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-var">Ext</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390247"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390246"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-977"></span><span>
</span><span id="line-978"></span><span>    </span><span id="local-6989586621684395343"><span class="annot"><a href="#local-6989586621684390279"><span class="hs-identifier hs-type">adjustExtPE</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395343"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395343"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-979"></span><span>    </span><span id="local-6989586621684390279"><span class="annot"><span class="annottext">adjustExtPE :: forall t. Int -&gt; TPrimExp t (Ext VName) -&gt; TPrimExp t (Ext VName)
</span><a href="#local-6989586621684390279"><span class="hs-identifier hs-var hs-var">adjustExtPE</span></a></span></span><span> </span><span id="local-6989586621684390244"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390244"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Ext VName -&gt; Ext VName)
-&gt; TPrimExp t (Ext VName) -&gt; TPrimExp t (Ext VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Ext VName -&gt; Ext VName
forall a. Int -&gt; Ext a -&gt; Ext a
</span><a href="#local-6989586621684390274"><span class="hs-identifier hs-var">adjustExt</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390244"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-980"></span><span>
</span><span id="line-981"></span><span id="local-6989586621684395442"><span id="local-6989586621684395443"><span id="local-6989586621684395444"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#mkSpaceOks"><span class="hs-identifier hs-type">mkSpaceOks</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-982"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395444"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395443"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395444"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395442"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-983"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-984"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395444"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-985"></span><span>  </span><span class="annot"><a href="#local-6989586621684395442"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span class="hs-special">]</span></span></span></span><span>
</span><span id="line-986"></span><span id="mkSpaceOks"><span class="annot"><span class="annottext">mkSpaceOks :: forall torep inner (m :: * -&gt; *).
(Mem torep inner, LocalScope torep m) =&gt;
Int -&gt; Body torep -&gt; m [Maybe Space]
</span><a href="Futhark.Pass.ExplicitAllocations.html#mkSpaceOks"><span class="hs-identifier hs-var hs-var">mkSpaceOks</span></a></span></span><span> </span><span id="local-6989586621684390194"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390194"><span class="hs-identifier hs-var">num_vals</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec torep
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684390193"><span class="annot"><span class="annottext">Stms torep
</span><a href="#local-6989586621684390193"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684390192"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390192"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-987"></span><span>  </span><span class="annot"><span class="annottext">Stms torep -&gt; m [Maybe Space] -&gt; m [Maybe Space]
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms torep
</span><a href="#local-6989586621684390193"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(m [Maybe Space] -&gt; m [Maybe Space])
-&gt; m [Maybe Space] -&gt; m [Maybe Space]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; m (Maybe Space)) -&gt; Result -&gt; m [Maybe Space]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; m (Maybe Space)
forall {rep} {m :: * -&gt; *} {inner}.
(HasScope rep m, HasLetDecMem (LetDec rep), Monad m, ASTRep rep,
 OpReturns inner, FParamInfo rep ~ FParamMem,
 RetType rep ~ RetTypeMem, LParamInfo rep ~ LParamMem,
 Op rep ~ MemOp inner, BranchType rep ~ BranchTypeMem) =&gt;
SubExp -&gt; m (Maybe Space)
</span><a href="#local-6989586621684390191"><span class="hs-identifier hs-var">mkSpaceOK</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; m (Maybe Space))
-&gt; (SubExpRes -&gt; SubExp) -&gt; SubExpRes -&gt; m (Maybe Space)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Result -&gt; m [Maybe Space]) -&gt; Result -&gt; m [Maybe Space]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Result -&gt; Result
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#takeLast"><span class="hs-identifier hs-var">takeLast</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684390194"><span class="hs-identifier hs-var">num_vals</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684390192"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-988"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-989"></span><span>    </span><span id="local-6989586621684390191"><span class="annot"><span class="annottext">mkSpaceOK :: SubExp -&gt; m (Maybe Space)
</span><a href="#local-6989586621684390191"><span class="hs-identifier hs-var hs-var">mkSpaceOK</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684390135"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390135"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-990"></span><span>      </span><span id="local-6989586621684390134"><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684390134"><span class="hs-identifier hs-var">v_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m LParamMem
forall rep (m :: * -&gt; *) inner.
(HasScope rep m, Mem rep inner) =&gt;
VName -&gt; m LParamMem
</span><a href="Futhark.IR.Mem.html#lookupMemInfo"><span class="hs-identifier hs-var">lookupMemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390135"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-991"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684390134"><span class="hs-identifier hs-var">v_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-992"></span><span>        </span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Shape
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684390133"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390133"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-993"></span><span>          </span><span id="local-6989586621684390132"><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684390132"><span class="hs-identifier hs-var">mem_info</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m LParamMem
forall rep (m :: * -&gt; *) inner.
(HasScope rep m, Mem rep inner) =&gt;
VName -&gt; m LParamMem
</span><a href="Futhark.IR.Mem.html#lookupMemInfo"><span class="hs-identifier hs-var">lookupMemInfo</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390133"><span class="hs-identifier hs-var">mem</span></a></span><span>
</span><span id="line-994"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LParamMem
</span><a href="#local-6989586621684390132"><span class="hs-identifier hs-var">mem_info</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-995"></span><span>            </span><span class="annot"><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-type">MemMem</span></a></span><span> </span><span id="local-6989586621684390131"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684390131"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Space -&gt; m (Maybe Space)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe Space -&gt; m (Maybe Space)) -&gt; Maybe Space -&gt; m (Maybe Space)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; Maybe Space
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684390131"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-996"></span><span>            </span><span class="annot"><span class="annottext">LParamMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Space -&gt; m (Maybe Space)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Space
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-997"></span><span>        </span><span class="annot"><span class="annottext">LParamMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Maybe Space -&gt; m (Maybe Space)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Space
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-998"></span><span>    </span><span class="annot"><a href="#local-6989586621684390191"><span class="hs-identifier hs-var">mkSpaceOK</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Space -&gt; m (Maybe Space)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe Space
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-999"></span><span>
</span><span id="line-1000"></span><span id="local-6989586621684395460"><span id="local-6989586621684395461"><span id="local-6989586621684395462"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInLoopForm"><span class="hs-identifier hs-type">allocInLoopForm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1001"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Allocable"><span class="hs-identifier hs-type">Allocable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395462"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395461"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395460"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1002"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#LoopForm"><span class="hs-identifier hs-type">LoopForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395462"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1003"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#AllocM"><span class="hs-identifier hs-type">AllocM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395462"><span class="hs-identifier hs-type">fromrep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395461"><span class="hs-identifier hs-type">torep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#LoopForm"><span class="hs-identifier hs-type">LoopForm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395461"><span class="hs-identifier hs-type">torep</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1004"></span><span id="allocInLoopForm"><span class="annot"><span class="annottext">allocInLoopForm :: forall fromrep torep inner.
Allocable fromrep torep inner =&gt;
LoopForm fromrep -&gt; AllocM fromrep torep (LoopForm torep)
</span><a href="Futhark.Pass.ExplicitAllocations.html#allocInLoopForm"><span class="hs-identifier hs-var hs-var">allocInLoopForm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#WhileLoop"><span class="hs-identifier hs-type">WhileLoop</span></a></span><span> </span><span id="local-6989586621684390061"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390061"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoopForm torep -&gt; AllocM fromrep torep (LoopForm torep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(LoopForm torep -&gt; AllocM fromrep torep (LoopForm torep))
-&gt; LoopForm torep -&gt; AllocM fromrep torep (LoopForm torep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; LoopForm torep
forall rep. VName -&gt; LoopForm rep
</span><a href="Futhark.IR.Syntax.html#WhileLoop"><span class="hs-identifier hs-var">WhileLoop</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390061"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1005"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#allocInLoopForm"><span class="hs-identifier hs-var">allocInLoopForm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#ForLoop"><span class="hs-identifier hs-type">ForLoop</span></a></span><span> </span><span id="local-6989586621684390059"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390059"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684390058"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684390058"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span id="local-6989586621684390057"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684390057"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684390056"><span class="annot"><span class="annottext">[(LParam fromrep, VName)]
</span><a href="#local-6989586621684390056"><span class="hs-identifier hs-var">loopvars</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1006"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; IntType -&gt; SubExp -&gt; [(LParam torep, VName)] -&gt; LoopForm torep
forall rep.
VName -&gt; IntType -&gt; SubExp -&gt; [(LParam rep, VName)] -&gt; LoopForm rep
</span><a href="Futhark.IR.Syntax.html#ForLoop"><span class="hs-identifier hs-var">ForLoop</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390059"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684390058"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684390057"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">([(Param LParamMem, VName)] -&gt; LoopForm torep)
-&gt; AllocM fromrep torep [(Param LParamMem, VName)]
-&gt; AllocM fromrep torep (LoopForm torep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((Param Type, VName)
 -&gt; AllocM fromrep torep (Param LParamMem, VName))
-&gt; [(Param Type, VName)]
-&gt; AllocM fromrep torep [(Param LParamMem, VName)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(Param Type, VName)
-&gt; AllocM fromrep torep (Param LParamMem, VName)
</span><a href="#local-6989586621684390055"><span class="hs-identifier hs-var">allocInLoopVar</span></a></span><span> </span><span class="annot"><span class="annottext">[(Param Type, VName)]
[(LParam fromrep, VName)]
</span><a href="#local-6989586621684390056"><span class="hs-identifier hs-var">loopvars</span></a></span><span>
</span><span id="line-1007"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1008"></span><span>    </span><span id="local-6989586621684390055"><span class="annot"><span class="annottext">allocInLoopVar :: (Param Type, VName)
-&gt; AllocM fromrep torep (Param LParamMem, VName)
</span><a href="#local-6989586621684390055"><span class="hs-identifier hs-var hs-var">allocInLoopVar</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684390054"><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684390054"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390053"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390053"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1009"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684390052"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390052"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684390051"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684390051"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; AllocM fromrep torep (VName, IxFun (TPrimExp Int64 VName))
forall rep inner (m :: * -&gt; *).
(Mem rep inner, HasScope rep m, Monad m) =&gt;
VName -&gt; m (VName, IxFun (TPrimExp Int64 VName))
</span><a href="Futhark.IR.Mem.html#lookupArraySummary"><span class="hs-identifier hs-var">lookupArraySummary</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390053"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1010"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Param Type -&gt; Type
forall dec. Typed dec =&gt; Param dec -&gt; Type
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684390054"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1011"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684390050"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390050"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684390049"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684390049"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684390048"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684390048"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1012"></span><span>          </span><span id="local-6989586621684390047"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684390047"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TPrimExp Int64 VName])
-&gt; (Type -&gt; [SubExp]) -&gt; Type -&gt; [TPrimExp Int64 VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; [TPrimExp Int64 VName])
-&gt; AllocM fromrep torep Type
-&gt; AllocM fromrep torep [TPrimExp Int64 VName]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; AllocM fromrep torep Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390053"><span class="hs-identifier hs-var">a</span></a></span><span>
</span><span id="line-1013"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684390046"><span class="annot"><span class="annottext">ixfun' :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684390046"><span class="hs-identifier hs-var hs-var">ixfun'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1014"></span><span>                </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
-&gt; Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; Slice num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#slice"><span class="hs-identifier hs-var">IxFun.slice</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684390051"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName))
-&gt; Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1015"></span><span>                  </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; Slice (TPrimExp Int64 VName)
forall d. Num d =&gt; [d] -&gt; [DimIndex d] -&gt; Slice d
</span><a href="Futhark.Construct.html#fullSliceNum"><span class="hs-identifier hs-var">fullSliceNum</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684390047"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName))
-&gt; TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">le64</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390059"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1016"></span><span>          </span><span class="annot"><span class="annottext">(Param LParamMem, VName)
-&gt; AllocM fromrep torep (Param LParamMem, VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684390054"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: LParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Shape -&gt; NoUniqueness -&gt; MemBind -&gt; LParamMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390050"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684390049"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684390048"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; LParamMem) -&gt; MemBind -&gt; LParamMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390052"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684390046"><span class="hs-identifier hs-var">ixfun'</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390053"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1017"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684390044"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390044"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1018"></span><span>          </span><span class="annot"><span class="annottext">(Param LParamMem, VName)
-&gt; AllocM fromrep torep (Param LParamMem, VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684390054"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: LParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; LParamMem
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684390044"><span class="hs-identifier hs-var">bt</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390053"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1019"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span id="local-6989586621684390043"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684390043"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1020"></span><span>          </span><span class="annot"><span class="annottext">(Param LParamMem, VName)
-&gt; AllocM fromrep torep (Param LParamMem, VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684390054"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: LParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space -&gt; LParamMem
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684390043"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390053"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1021"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span id="local-6989586621684390042"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390042"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684390041"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684390041"><span class="hs-identifier hs-var">ispace</span></a></span></span><span> </span><span id="local-6989586621684390040"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684390040"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684390039"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684390039"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1022"></span><span>          </span><span class="annot"><span class="annottext">(Param LParamMem, VName)
-&gt; AllocM fromrep torep (Param LParamMem, VName)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param Type
</span><a href="#local-6989586621684390054"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: LParamMem
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Shape -&gt; [Type] -&gt; NoUniqueness -&gt; LParamMem
forall d u ret. VName -&gt; Shape -&gt; [Type] -&gt; u -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-var">MemAcc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390042"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684390041"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621684390040"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684390039"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684390053"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1023"></span><span>
</span><span id="line-1024"></span><span class="hs-keyword">class</span><span> </span><span id="SizeSubst"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#SizeSubst"><span class="hs-identifier hs-var">SizeSubst</span></a></span></span><span> </span><span id="local-6989586621684395328"><span class="annot"><a href="#local-6989586621684395328"><span class="hs-identifier hs-type">op</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1025"></span><span>  </span><span id="local-6989586621684395327"><span id="opSizeSubst"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#opSizeSubst"><span class="hs-identifier hs-type">opSizeSubst</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#PatT"><span class="hs-identifier hs-type">PatT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395327"><span class="hs-identifier hs-type">dec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684395328"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ChunkMap"><span class="hs-identifier hs-type">ChunkMap</span></a></span></span><span>
</span><span id="line-1026"></span><span>  </span><span id="opIsConst"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#opIsConst"><span class="hs-identifier hs-type">opIsConst</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621684395328"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1027"></span><span>  </span><span id="local-6989586621684390035"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#opIsConst"><span class="hs-identifier hs-var hs-var">opIsConst</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; op -&gt; Bool
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span></span><span>
</span><span id="line-1028"></span><span>
</span><span id="line-1029"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684390032"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1030"></span><span>  </span><span id="local-6989586621684390029"><span class="annot"><span class="annottext">opSizeSubst :: forall dec. PatT dec -&gt; () -&gt; ChunkMap
</span><a href="#local-6989586621684390029"><span class="hs-identifier hs-var hs-var hs-var hs-var">opSizeSubst</span></a></span></span><span> </span><span class="annot"><span class="annottext">PatT dec
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkMap
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1031"></span><span>
</span><span id="line-1032"></span><span id="local-6989586621684395507"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395507"><span class="hs-identifier hs-type">op</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemOp"><span class="hs-identifier hs-type">MemOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395507"><span class="hs-identifier hs-type">op</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-1033"></span><span>  </span><span id="local-6989586621684390023"><span class="annot"><span class="annottext">opSizeSubst :: forall dec. PatT dec -&gt; MemOp op -&gt; ChunkMap
</span><a href="#local-6989586621684390023"><span class="hs-identifier hs-var hs-var hs-var hs-var">opSizeSubst</span></a></span></span><span> </span><span id="local-6989586621684390022"><span class="annot"><span class="annottext">PatT dec
</span><a href="#local-6989586621684390022"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span id="local-6989586621684390020"><span class="annot"><span class="annottext">op
</span><a href="#local-6989586621684390020"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatT dec -&gt; op -&gt; ChunkMap
forall op dec. SizeSubst op =&gt; PatT dec -&gt; op -&gt; ChunkMap
</span><a href="Futhark.Pass.ExplicitAllocations.html#opSizeSubst"><span class="hs-identifier hs-var">opSizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">PatT dec
</span><a href="#local-6989586621684390022"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">op
</span><a href="#local-6989586621684390020"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-1034"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#opSizeSubst"><span class="hs-identifier hs-var">opSizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">PatT dec
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">MemOp op
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkMap
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1035"></span><span>
</span><span id="line-1036"></span><span>  </span><span id="local-6989586621684390018"><span class="annot"><span class="annottext">opIsConst :: MemOp op -&gt; Bool
</span><a href="#local-6989586621684390018"><span class="hs-identifier hs-var hs-var hs-var hs-var">opIsConst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span id="local-6989586621684390017"><span class="annot"><span class="annottext">op
</span><a href="#local-6989586621684390017"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">op -&gt; Bool
forall op. SizeSubst op =&gt; op -&gt; Bool
</span><a href="Futhark.Pass.ExplicitAllocations.html#opIsConst"><span class="hs-identifier hs-var">opIsConst</span></a></span><span> </span><span class="annot"><span class="annottext">op
</span><a href="#local-6989586621684390017"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-1037"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#opIsConst"><span class="hs-identifier hs-var">opIsConst</span></a></span><span> </span><span class="annot"><span class="annottext">MemOp op
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span></span><span>
</span><span id="line-1038"></span><span>
</span><span id="line-1039"></span><span id="local-6989586621684395496"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#sizeSubst"><span class="hs-identifier hs-type">sizeSubst</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395496"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395496"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ChunkMap"><span class="hs-identifier hs-type">ChunkMap</span></a></span></span><span>
</span><span id="line-1040"></span><span id="sizeSubst"><span class="annot"><span class="annottext">sizeSubst :: forall rep. SizeSubst (Op rep) =&gt; Stm rep -&gt; ChunkMap
</span><a href="Futhark.Pass.ExplicitAllocations.html#sizeSubst"><span class="hs-identifier hs-var hs-var">sizeSubst</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684390012"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684390012"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span id="local-6989586621684390011"><span class="annot"><span class="annottext">Op rep
</span><a href="#local-6989586621684390011"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; Op rep -&gt; ChunkMap
forall op dec. SizeSubst op =&gt; PatT dec -&gt; op -&gt; ChunkMap
</span><a href="Futhark.Pass.ExplicitAllocations.html#opSizeSubst"><span class="hs-identifier hs-var">opSizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684390012"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Op rep
</span><a href="#local-6989586621684390011"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-1041"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#sizeSubst"><span class="hs-identifier hs-var">sizeSubst</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ChunkMap
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1042"></span><span>
</span><span id="line-1043"></span><span id="local-6989586621684395495"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#stmConsts"><span class="hs-identifier hs-type">stmConsts</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395495"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395495"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span><span>
</span><span id="line-1044"></span><span id="stmConsts"><span class="annot"><span class="annottext">stmConsts :: forall rep. SizeSubst (Op rep) =&gt; Stm rep -&gt; Set VName
</span><a href="Futhark.Pass.ExplicitAllocations.html#stmConsts"><span class="hs-identifier hs-var hs-var">stmConsts</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684390005"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684390005"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec rep)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span id="local-6989586621684390004"><span class="annot"><span class="annottext">Op rep
</span><a href="#local-6989586621684390004"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1045"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Op rep -&gt; Bool
forall op. SizeSubst op =&gt; op -&gt; Bool
</span><a href="Futhark.Pass.ExplicitAllocations.html#opIsConst"><span class="hs-identifier hs-var">opIsConst</span></a></span><span> </span><span class="annot"><span class="annottext">Op rep
</span><a href="#local-6989586621684390004"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Set VName) -&gt; [VName] -&gt; Set VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684390005"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-1046"></span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#stmConsts"><span class="hs-identifier hs-var">stmConsts</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1047"></span><span>
</span><span id="line-1048"></span><span id="local-6989586621684395318"><span id="local-6989586621684395319"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#mkLetNamesB%27"><span class="hs-identifier hs-type">mkLetNamesB'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1049"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395319"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#LetDecMem"><span class="hs-identifier hs-type">LetDecMem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1050"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395319"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684395318"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1051"></span><span>    </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395319"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1052"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#ExpDec"><span class="hs-identifier hs-type">ExpDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395319"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1053"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1054"></span><span>  </span><span class="annot"><a href="Futhark.IR.Rep.html#ExpDec"><span class="hs-identifier hs-type">ExpDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395319"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1055"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1056"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395319"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1057"></span><span>  </span><span class="annot"><a href="#local-6989586621684395319"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395319"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1058"></span><span id="mkLetNamesB%27"><span class="annot"><span class="annottext">mkLetNamesB' :: forall (m :: * -&gt; *) inner.
(LetDec (Rep m) ~ LParamMem, Mem (Rep m) inner, MonadBuilder m,
 ExpDec (Rep m) ~ ()) =&gt;
ExpDec (Rep m) -&gt; [VName] -&gt; Exp (Rep m) -&gt; m (Stm (Rep m))
</span><a href="Futhark.Pass.ExplicitAllocations.html#mkLetNamesB%27"><span class="hs-identifier hs-var hs-var">mkLetNamesB'</span></a></span></span><span> </span><span id="local-6989586621684389947"><span class="annot"><span class="annottext">ExpDec (Rep m)
</span><a href="#local-6989586621684389947"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621684389946"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684389946"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span id="local-6989586621684389945"><span class="annot"><span class="annottext">Exp (Rep m)
</span><a href="#local-6989586621684389945"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1059"></span><span>  </span><span id="local-6989586621684389944"><span class="annot"><span class="annottext">PatT LParamMem
</span><a href="#local-6989586621684389944"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Space
-&gt; ChunkMap
-&gt; [VName]
-&gt; Exp (Rep m)
-&gt; [ExpHint]
-&gt; m (PatT LParamMem)
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Mem (Rep m) inner) =&gt;
Space
-&gt; ChunkMap
-&gt; [VName]
-&gt; Exp (Rep m)
-&gt; [ExpHint]
-&gt; m (PatT LParamMem)
</span><a href="Futhark.Pass.ExplicitAllocations.html#patWithAllocations"><span class="hs-identifier hs-var">patWithAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684389946"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">Exp (Rep m)
</span><a href="#local-6989586621684389945"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpHint]
</span><a href="#local-6989586621684389943"><span class="hs-identifier hs-var">nohints</span></a></span><span>
</span><span id="line-1060"></span><span>  </span><span class="annot"><span class="annottext">Stm (Rep m) -&gt; m (Stm (Rep m))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Stm (Rep m) -&gt; m (Stm (Rep m))) -&gt; Stm (Rep m) -&gt; m (Stm (Rep m))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m)
-&gt; StmAux (ExpDec (Rep m)) -&gt; Exp (Rep m) -&gt; Stm (Rep m)
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep m)
PatT LParamMem
</span><a href="#local-6989586621684389944"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="annot"><span class="annottext">()
ExpDec (Rep m)
</span><a href="#local-6989586621684389947"><span class="hs-identifier hs-var">dec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp (Rep m)
</span><a href="#local-6989586621684389945"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1061"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1062"></span><span>    </span><span id="local-6989586621684389943"><span class="annot"><span class="annottext">nohints :: [ExpHint]
</span><a href="#local-6989586621684389943"><span class="hs-identifier hs-var hs-var">nohints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ExpHint) -&gt; [VName] -&gt; [ExpHint]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpHint -&gt; VName -&gt; ExpHint
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">ExpHint
</span><a href="Futhark.Pass.ExplicitAllocations.html#NoHint"><span class="hs-identifier hs-var">NoHint</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684389946"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-1063"></span><span>
</span><span id="line-1064"></span><span id="local-6989586621684395312"><span id="local-6989586621684395314"><span id="local-6989586621684395315"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#mkLetNamesB%27%27"><span class="hs-identifier hs-type">mkLetNamesB''</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1065"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Builder.html#BuilderOps"><span class="hs-identifier hs-type">BuilderOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395315"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1066"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395315"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395314"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1067"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395315"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#LetDecMem"><span class="hs-identifier hs-type">LetDecMem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1068"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.html#OpReturns"><span class="hs-identifier hs-type">OpReturns</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#OpWithWisdom"><span class="hs-identifier hs-type">Engine.OpWithWisdom</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395314"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1069"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#ExpDec"><span class="hs-identifier hs-type">ExpDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395315"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1070"></span><span>    </span><span class="annot"><a href="Futhark.Builder.Class.html#Rep"><span class="hs-identifier hs-type">Rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395312"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Engine.Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395315"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1071"></span><span>    </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Engine.Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395315"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684395312"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1072"></span><span>    </span><span class="annot"><a href="Futhark.Builder.Class.html#MonadBuilder"><span class="hs-identifier hs-type">MonadBuilder</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395312"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1073"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#CanBeWise"><span class="hs-identifier hs-type">Engine.CanBeWise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395314"><span class="hs-identifier hs-type">inner</span></a></span><span>
</span><span id="line-1074"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1075"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1076"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Engine.Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395315"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1077"></span><span>  </span><span class="annot"><a href="#local-6989586621684395312"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Engine.Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395315"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-1078"></span><span id="mkLetNamesB%27%27"><span class="annot"><span class="annottext">mkLetNamesB'' :: forall rep inner (m :: * -&gt; *).
(BuilderOps rep, Mem rep inner, LetDec rep ~ LParamMem,
 OpReturns (OpWithWisdom inner), ExpDec rep ~ (), Rep m ~ Wise rep,
 HasScope (Wise rep) m, MonadBuilder m, CanBeWise inner) =&gt;
[VName] -&gt; Exp (Wise rep) -&gt; m (Stm (Wise rep))
</span><a href="Futhark.Pass.ExplicitAllocations.html#mkLetNamesB%27%27"><span class="hs-identifier hs-var hs-var">mkLetNamesB''</span></a></span></span><span> </span><span id="local-6989586621684389871"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684389871"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span id="local-6989586621684389870"><span class="annot"><span class="annottext">Exp (Wise rep)
</span><a href="#local-6989586621684389870"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1079"></span><span>  </span><span id="local-6989586621684389869"><span class="annot"><span class="annottext">PatT LParamMem
</span><a href="#local-6989586621684389869"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Space
-&gt; ChunkMap
-&gt; [VName]
-&gt; Exp (Rep m)
-&gt; [ExpHint]
-&gt; m (PatT LParamMem)
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Mem (Rep m) inner) =&gt;
Space
-&gt; ChunkMap
-&gt; [VName]
-&gt; Exp (Rep m)
-&gt; [ExpHint]
-&gt; m (PatT LParamMem)
</span><a href="Futhark.Pass.ExplicitAllocations.html#patWithAllocations"><span class="hs-identifier hs-var">patWithAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span> </span><span class="annot"><span class="annottext">ChunkMap
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684389871"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">Exp (Rep m)
Exp (Wise rep)
</span><a href="#local-6989586621684389870"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpHint]
</span><a href="#local-6989586621684389868"><span class="hs-identifier hs-var">nohints</span></a></span><span>
</span><span id="line-1080"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684389867"><span class="annot"><span class="annottext">pat' :: Pat (Wise rep)
</span><a href="#local-6989586621684389867"><span class="hs-identifier hs-var hs-var">pat'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; Exp (Wise rep) -&gt; Pat (Wise rep)
forall rep.
(ASTRep rep, CanBeWise (Op rep)) =&gt;
Pat rep -&gt; Exp (Wise rep) -&gt; Pat (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Rep.html#addWisdomToPat"><span class="hs-identifier hs-var">Engine.addWisdomToPat</span></a></span><span> </span><span class="annot"><span class="annottext">Pat rep
PatT LParamMem
</span><a href="#local-6989586621684389869"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Exp (Wise rep)
</span><a href="#local-6989586621684389870"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1081"></span><span>      </span><span id="local-6989586621684389865"><span class="annot"><span class="annottext">dec :: ExpDec (Wise rep)
</span><a href="#local-6989586621684389865"><span class="hs-identifier hs-var hs-var">dec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat (Wise rep) -&gt; ExpDec rep -&gt; Exp (Wise rep) -&gt; ExpDec (Wise rep)
forall rep.
(ASTRep rep, CanBeWise (Op rep)) =&gt;
Pat (Wise rep) -&gt; ExpDec rep -&gt; Exp (Wise rep) -&gt; ExpDec (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Rep.html#mkWiseExpDec"><span class="hs-identifier hs-var">Engine.mkWiseExpDec</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Wise rep)
</span><a href="#local-6989586621684389867"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp (Wise rep)
</span><a href="#local-6989586621684389870"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1082"></span><span>  </span><span class="annot"><span class="annottext">Stm (Wise rep) -&gt; m (Stm (Wise rep))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Stm (Wise rep) -&gt; m (Stm (Wise rep)))
-&gt; Stm (Wise rep) -&gt; m (Stm (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Wise rep)
-&gt; StmAux (ExpDec (Wise rep)) -&gt; Exp (Wise rep) -&gt; Stm (Wise rep)
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Wise rep)
</span><a href="#local-6989586621684389867"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ExpWisdom, ()) -&gt; StmAux (ExpWisdom, ())
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpWisdom, ())
ExpDec (Wise rep)
</span><a href="#local-6989586621684389865"><span class="hs-identifier hs-var">dec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp (Wise rep)
</span><a href="#local-6989586621684389870"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1083"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1084"></span><span>    </span><span id="local-6989586621684389868"><span class="annot"><span class="annottext">nohints :: [ExpHint]
</span><a href="#local-6989586621684389868"><span class="hs-identifier hs-var hs-var">nohints</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ExpHint) -&gt; [VName] -&gt; [ExpHint]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpHint -&gt; VName -&gt; ExpHint
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">ExpHint
</span><a href="Futhark.Pass.ExplicitAllocations.html#NoHint"><span class="hs-identifier hs-var">NoHint</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684389871"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-1085"></span><span>
</span><span id="line-1086"></span><span id="local-6989586621684395297"><span id="local-6989586621684395299"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#simplifiable"><span class="hs-identifier hs-type">simplifiable</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1087"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimplifiableRep"><span class="hs-identifier hs-type">Engine.SimplifiableRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395299"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1088"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#ExpDec"><span class="hs-identifier hs-type">ExpDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395299"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1089"></span><span>    </span><span class="annot"><a href="Futhark.IR.Rep.html#BodyDec"><span class="hs-identifier hs-type">BodyDec</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395299"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-operator hs-type">~</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1090"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.html#Mem"><span class="hs-identifier hs-type">Mem</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395299"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395297"><span class="hs-identifier hs-type">inner</span></a></span><span>
</span><span id="line-1091"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1092"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#OpWithWisdom"><span class="hs-identifier hs-type">Engine.OpWithWisdom</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395297"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Analysis.UsageTable.html#UsageTable"><span class="hs-identifier hs-type">UT.UsageTable</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1093"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#OpWithWisdom"><span class="hs-identifier hs-type">Engine.OpWithWisdom</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395297"><span class="hs-identifier hs-type">inner</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleM"><span class="hs-identifier hs-type">Engine.SimpleM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395299"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#OpWithWisdom"><span class="hs-identifier hs-type">Engine.OpWithWisdom</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395297"><span class="hs-identifier hs-type">inner</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#Wise"><span class="hs-identifier hs-type">Engine.Wise</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395299"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1094"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.Simplify.Engine.html#SimpleOps"><span class="hs-identifier hs-type">SimpleOps</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395299"><span class="hs-identifier hs-type">rep</span></a></span></span></span><span>
</span><span id="line-1095"></span><span id="simplifiable"><span class="annot"><span class="annottext">simplifiable :: forall rep inner.
(SimplifiableRep rep, ExpDec rep ~ (), BodyDec rep ~ (),
 Mem rep inner) =&gt;
(OpWithWisdom inner -&gt; UsageTable)
-&gt; (OpWithWisdom inner
    -&gt; SimpleM rep (OpWithWisdom inner, Stms (Wise rep)))
-&gt; SimpleOps rep
</span><a href="Futhark.Pass.ExplicitAllocations.html#simplifiable"><span class="hs-identifier hs-var hs-var">simplifiable</span></a></span></span><span> </span><span id="local-6989586621684389783"><span class="annot"><span class="annottext">OpWithWisdom inner -&gt; UsageTable
</span><a href="#local-6989586621684389783"><span class="hs-identifier hs-var">innerUsage</span></a></span></span><span> </span><span id="local-6989586621684389782"><span class="annot"><span class="annottext">OpWithWisdom inner
-&gt; SimpleM rep (OpWithWisdom inner, Stms (Wise rep))
</span><a href="#local-6989586621684389782"><span class="hs-identifier hs-var">simplifyInnerOp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1096"></span><span>  </span><span class="annot"><span class="annottext">(SymbolTable (Wise rep)
 -&gt; Pat (Wise rep)
 -&gt; Exp (Wise rep)
 -&gt; SimpleM rep (ExpDec (Wise rep)))
-&gt; (SymbolTable (Wise rep)
    -&gt; Stms (Wise rep) -&gt; Result -&gt; SimpleM rep (Body (Wise rep)))
-&gt; Protect (BuilderT (Wise rep) (State VNameSource))
-&gt; (Op (Wise rep) -&gt; UsageTable)
-&gt; SimplifyOp rep (Op (Wise rep))
-&gt; SimpleOps rep
forall rep.
(SymbolTable (Wise rep)
 -&gt; Pat (Wise rep)
 -&gt; Exp (Wise rep)
 -&gt; SimpleM rep (ExpDec (Wise rep)))
-&gt; (SymbolTable (Wise rep)
    -&gt; Stms (Wise rep) -&gt; Result -&gt; SimpleM rep (Body (Wise rep)))
-&gt; Protect (Builder (Wise rep))
-&gt; (Op (Wise rep) -&gt; UsageTable)
-&gt; SimplifyOp rep (Op (Wise rep))
-&gt; SimpleOps rep
</span><a href="Futhark.Optimise.Simplify.Engine.html#SimpleOps"><span class="hs-identifier hs-var">SimpleOps</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
-&gt; Pat (Wise rep)
-&gt; Exp (Wise rep)
-&gt; SimpleM rep (ExpDec (Wise rep))
forall {m :: * -&gt; *} {rep} {p}.
(Monad m, ASTRep rep, CanBeWise (Op rep), ExpDec rep ~ ()) =&gt;
p
-&gt; PatT (VarWisdom, LetDec rep)
-&gt; Exp (Wise rep)
-&gt; m (ExpWisdom, ExpDec rep)
</span><a href="#local-6989586621684389780"><span class="hs-identifier hs-var">mkExpDecS'</span></a></span><span> </span><span class="annot"><span class="annottext">SymbolTable (Wise rep)
-&gt; Stms (Wise rep) -&gt; Result -&gt; SimpleM rep (Body (Wise rep))
forall {m :: * -&gt; *} {rep} {p}.
(Monad m, ASTRep rep, CanBeWise (Op rep), BodyDec rep ~ ()) =&gt;
p -&gt; Stms (Wise rep) -&gt; Result -&gt; m (Body (Wise rep))
</span><a href="#local-6989586621684389779"><span class="hs-identifier hs-var">mkBodyS'</span></a></span><span> </span><span class="annot"><span class="annottext">Protect (BuilderT (Wise rep) (State VNameSource))
forall {m :: * -&gt; *} {d} {u} {ret} {inner} {inner}.
(MonadBuilder m, BranchType (Rep m) ~ MemInfo d u ret,
 Op (Rep m) ~ MemOp inner) =&gt;
SubExp -&gt; PatT (LetDec (Rep m)) -&gt; MemOp inner -&gt; Maybe (m ())
</span><a href="#local-6989586621684389778"><span class="hs-identifier hs-var">protectOp</span></a></span><span> </span><span class="annot"><span class="annottext">Op (Wise rep) -&gt; UsageTable
MemOp (OpWithWisdom inner) -&gt; UsageTable
</span><a href="#local-6989586621684389777"><span class="hs-identifier hs-var">opUsage</span></a></span><span> </span><span class="annot"><span class="annottext">SimplifyOp rep (Op (Wise rep))
MemOp (OpWithWisdom inner)
-&gt; SimpleM rep (MemOp (OpWithWisdom inner), Stms (Wise rep))
</span><a href="#local-6989586621684389776"><span class="hs-identifier hs-var">simplifyOp</span></a></span><span>
</span><span id="line-1097"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1098"></span><span>    </span><span id="local-6989586621684389780"><span class="annot"><span class="annottext">mkExpDecS' :: p
-&gt; PatT (VarWisdom, LetDec rep)
-&gt; Exp (Wise rep)
-&gt; m (ExpWisdom, ExpDec rep)
</span><a href="#local-6989586621684389780"><span class="hs-identifier hs-var hs-var">mkExpDecS'</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684389760"><span class="annot"><span class="annottext">PatT (VarWisdom, LetDec rep)
</span><a href="#local-6989586621684389760"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684389759"><span class="annot"><span class="annottext">Exp (Wise rep)
</span><a href="#local-6989586621684389759"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1099"></span><span>      </span><span class="annot"><span class="annottext">(ExpWisdom, ExpDec rep) -&gt; m (ExpWisdom, ExpDec rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">((ExpWisdom, ExpDec rep) -&gt; m (ExpWisdom, ExpDec rep))
-&gt; (ExpWisdom, ExpDec rep) -&gt; m (ExpWisdom, ExpDec rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat (Wise rep) -&gt; ExpDec rep -&gt; Exp (Wise rep) -&gt; ExpDec (Wise rep)
forall rep.
(ASTRep rep, CanBeWise (Op rep)) =&gt;
Pat (Wise rep) -&gt; ExpDec rep -&gt; Exp (Wise rep) -&gt; ExpDec (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Rep.html#mkWiseExpDec"><span class="hs-identifier hs-var">Engine.mkWiseExpDec</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarWisdom, LetDec rep)
Pat (Wise rep)
</span><a href="#local-6989586621684389760"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp (Wise rep)
</span><a href="#local-6989586621684389759"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1100"></span><span>
</span><span id="line-1101"></span><span>    </span><span id="local-6989586621684389779"><span class="annot"><span class="annottext">mkBodyS' :: p -&gt; Stms (Wise rep) -&gt; Result -&gt; m (Body (Wise rep))
</span><a href="#local-6989586621684389779"><span class="hs-identifier hs-var hs-var">mkBodyS'</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684389743"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684389743"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684389742"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684389742"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Body (Wise rep) -&gt; m (Body (Wise rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Body (Wise rep) -&gt; m (Body (Wise rep)))
-&gt; Body (Wise rep) -&gt; m (Body (Wise rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyDec rep -&gt; Stms (Wise rep) -&gt; Result -&gt; Body (Wise rep)
forall rep.
(ASTRep rep, CanBeWise (Op rep)) =&gt;
BodyDec rep -&gt; Stms (Wise rep) -&gt; Result -&gt; Body (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Rep.html#mkWiseBody"><span class="hs-identifier hs-var">mkWiseBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684389743"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684389742"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-1102"></span><span>
</span><span id="line-1103"></span><span>    </span><span id="local-6989586621684389778"><span class="annot"><span class="annottext">protectOp :: SubExp -&gt; PatT (LetDec (Rep m)) -&gt; MemOp inner -&gt; Maybe (m ())
</span><a href="#local-6989586621684389778"><span class="hs-identifier hs-var hs-var">protectOp</span></a></span></span><span> </span><span id="local-6989586621684389722"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684389722"><span class="hs-identifier hs-var">taken</span></a></span></span><span> </span><span id="local-6989586621684389721"><span class="annot"><span class="annottext">PatT (LetDec (Rep m))
</span><a href="#local-6989586621684389721"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span id="local-6989586621684389720"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684389720"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621684389719"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684389719"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m () -&gt; Maybe (m ())
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; Maybe (m ())) -&gt; m () -&gt; Maybe (m ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1104"></span><span>      </span><span id="local-6989586621684389718"><span class="annot"><span class="annottext">BodyT (Rep m)
</span><a href="#local-6989586621684389718"><span class="hs-identifier hs-var">tbody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; m (BodyT (Rep m))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[SubExp] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#resultBodyM"><span class="hs-identifier hs-var">resultBodyM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684389720"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-1105"></span><span>      </span><span id="local-6989586621684389716"><span class="annot"><span class="annottext">BodyT (Rep m)
</span><a href="#local-6989586621684389716"><span class="hs-identifier hs-var">fbody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; m (BodyT (Rep m))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[SubExp] -&gt; m (Body (Rep m))
</span><a href="Futhark.Construct.html#resultBodyM"><span class="hs-identifier hs-var">resultBodyM</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-1106"></span><span>      </span><span id="local-6989586621684389714"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684389714"><span class="hs-identifier hs-var">size'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1107"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; Exp (Rep m) -&gt; m SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;hoisted_alloc_size&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m SubExp) -&gt; Exp (Rep m) -&gt; m SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1108"></span><span>          </span><span class="annot"><span class="annottext">SubExp
-&gt; BodyT (Rep m)
-&gt; BodyT (Rep m)
-&gt; IfDec (BranchType (Rep m))
-&gt; Exp (Rep m)
forall rep.
SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684389722"><span class="hs-identifier hs-var">taken</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Rep m)
</span><a href="#local-6989586621684389718"><span class="hs-identifier hs-var">tbody</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Rep m)
</span><a href="#local-6989586621684389716"><span class="hs-identifier hs-var">fbody</span></a></span><span> </span><span class="annot"><span class="annottext">(IfDec (BranchType (Rep m)) -&gt; Exp (Rep m))
-&gt; IfDec (BranchType (Rep m)) -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[MemInfo d u ret] -&gt; IfSort -&gt; IfDec (MemInfo d u ret)
forall rt. [rt] -&gt; IfSort -&gt; IfDec rt
</span><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-var">IfDec</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimType -&gt; MemInfo d u ret
forall d u ret. PrimType -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-var">MemPrim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="Futhark.IR.Syntax.html#IfFallback"><span class="hs-identifier hs-var">IfFallback</span></a></span><span>
</span><span id="line-1109"></span><span>      </span><span class="annot"><span class="annottext">PatT (LetDec (Rep m)) -&gt; Exp (Rep m) -&gt; m ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec (Rep m))
</span><a href="#local-6989586621684389721"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep m) -&gt; m ()) -&gt; Exp (Rep m) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op (Rep m) -&gt; Exp (Rep m)
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op (Rep m) -&gt; Exp (Rep m)) -&gt; Op (Rep m) -&gt; Exp (Rep m)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Space -&gt; MemOp inner
forall inner. SubExp -&gt; Space -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-var">Alloc</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684389714"><span class="hs-identifier hs-var">size'</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684389719"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-1110"></span><span>    </span><span class="annot"><a href="#local-6989586621684389778"><span class="hs-identifier hs-var">protectOp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">PatT (LetDec (Rep m))
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">MemOp inner
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (m ())
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1111"></span><span>
</span><span id="line-1112"></span><span>    </span><span id="local-6989586621684389777"><span class="annot"><span class="annottext">opUsage :: MemOp (OpWithWisdom inner) -&gt; UsageTable
</span><a href="#local-6989586621684389777"><span class="hs-identifier hs-var hs-var">opUsage</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684389712"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684389712"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1113"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; UsageTable
</span><a href="Futhark.Analysis.UsageTable.html#sizeUsage"><span class="hs-identifier hs-var">UT.sizeUsage</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684389712"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-1114"></span><span>    </span><span class="annot"><a href="#local-6989586621684389777"><span class="hs-identifier hs-var">opUsage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1115"></span><span>      </span><span class="annot"><span class="annottext">UsageTable
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1116"></span><span>    </span><span class="annot"><a href="#local-6989586621684389777"><span class="hs-identifier hs-var">opUsage</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span id="local-6989586621684389710"><span class="annot"><span class="annottext">OpWithWisdom inner
</span><a href="#local-6989586621684389710"><span class="hs-identifier hs-var">inner</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1117"></span><span>      </span><span class="annot"><span class="annottext">OpWithWisdom inner -&gt; UsageTable
</span><a href="#local-6989586621684389783"><span class="hs-identifier hs-var">innerUsage</span></a></span><span> </span><span class="annot"><span class="annottext">OpWithWisdom inner
</span><a href="#local-6989586621684389710"><span class="hs-identifier hs-var">inner</span></a></span><span>
</span><span id="line-1118"></span><span>
</span><span id="line-1119"></span><span>    </span><span id="local-6989586621684389776"><span class="annot"><span class="annottext">simplifyOp :: MemOp (OpWithWisdom inner)
-&gt; SimpleM rep (MemOp (OpWithWisdom inner), Stms (Wise rep))
</span><a href="#local-6989586621684389776"><span class="hs-identifier hs-var hs-var">simplifyOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span id="local-6989586621684389709"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684389709"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621684389708"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684389708"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1120"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(MemOp (OpWithWisdom inner)
 -&gt; Stms (Wise rep)
 -&gt; (MemOp (OpWithWisdom inner), Stms (Wise rep)))
-&gt; SimpleM rep (MemOp (OpWithWisdom inner))
-&gt; SimpleM
     rep
     (Stms (Wise rep) -&gt; (MemOp (OpWithWisdom inner), Stms (Wise rep)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Space -&gt; MemOp (OpWithWisdom inner)
forall inner. SubExp -&gt; Space -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-var">Alloc</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Space -&gt; MemOp (OpWithWisdom inner))
-&gt; SimpleM rep SubExp
-&gt; SimpleM rep (Space -&gt; MemOp (OpWithWisdom inner))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SimpleM rep SubExp
forall e rep.
(Simplifiable e, SimplifiableRep rep) =&gt;
e -&gt; SimpleM rep e
</span><a href="Futhark.Optimise.Simplify.Engine.html#simplify"><span class="hs-identifier hs-var">Engine.simplify</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684389709"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">SimpleM rep (Space -&gt; MemOp (OpWithWisdom inner))
-&gt; SimpleM rep Space -&gt; SimpleM rep (MemOp (OpWithWisdom inner))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; SimpleM rep Space
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684389708"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SimpleM
  rep
  (Stms (Wise rep) -&gt; (MemOp (OpWithWisdom inner), Stms (Wise rep)))
-&gt; SimpleM rep (Stms (Wise rep))
-&gt; SimpleM rep (MemOp (OpWithWisdom inner), Stms (Wise rep))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep) -&gt; SimpleM rep (Stms (Wise rep))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1121"></span><span>    </span><span class="annot"><a href="#local-6989586621684389776"><span class="hs-identifier hs-var">simplifyOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span id="local-6989586621684389706"><span class="annot"><span class="annottext">OpWithWisdom inner
</span><a href="#local-6989586621684389706"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1122"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684389705"><span class="annot"><span class="annottext">OpWithWisdom inner
</span><a href="#local-6989586621684389705"><span class="hs-identifier hs-var">k'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684389704"><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684389704"><span class="hs-identifier hs-var">hoisted</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OpWithWisdom inner
-&gt; SimpleM rep (OpWithWisdom inner, Stms (Wise rep))
</span><a href="#local-6989586621684389782"><span class="hs-identifier hs-var">simplifyInnerOp</span></a></span><span> </span><span class="annot"><span class="annottext">OpWithWisdom inner
</span><a href="#local-6989586621684389706"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-1123"></span><span>      </span><span class="annot"><span class="annottext">(MemOp (OpWithWisdom inner), Stms (Wise rep))
-&gt; SimpleM rep (MemOp (OpWithWisdom inner), Stms (Wise rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OpWithWisdom inner -&gt; MemOp (OpWithWisdom inner)
forall inner. inner -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">OpWithWisdom inner
</span><a href="#local-6989586621684389705"><span class="hs-identifier hs-var">k'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms (Wise rep)
</span><a href="#local-6989586621684389704"><span class="hs-identifier hs-var">hoisted</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1124"></span><span>
</span><span id="line-1125"></span><span class="hs-keyword">data</span><span> </span><span id="ExpHint"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ExpHint"><span class="hs-identifier hs-var">ExpHint</span></a></span></span><span>
</span><span id="line-1126"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="NoHint"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#NoHint"><span class="hs-identifier hs-var">NoHint</span></a></span></span><span>
</span><span id="line-1127"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Hint"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#Hint"><span class="hs-identifier hs-var">Hint</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span>
</span><span id="line-1128"></span><span>
</span><span id="line-1129"></span><span id="local-6989586621684395249"><span id="local-6989586621684395250"><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#defaultExpHints"><span class="hs-identifier hs-type">defaultExpHints</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Monad</span></span><span> </span><span class="annot"><a href="#local-6989586621684395250"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html#ASTRep"><span class="hs-identifier hs-type">ASTRep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395249"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684395249"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684395250"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.html#ExpHint"><span class="hs-identifier hs-type">ExpHint</span></a></span><span class="hs-special">]</span></span></span><span>
</span><span id="line-1130"></span><span id="defaultExpHints"><span class="annot"><span class="annottext">defaultExpHints :: forall (m :: * -&gt; *) rep.
(Monad m, ASTRep rep) =&gt;
Exp rep -&gt; m [ExpHint]
</span><a href="Futhark.Pass.ExplicitAllocations.html#defaultExpHints"><span class="hs-identifier hs-var hs-var">defaultExpHints</span></a></span></span><span> </span><span id="local-6989586621684389693"><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684389693"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[ExpHint] -&gt; m [ExpHint]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">([ExpHint] -&gt; m [ExpHint]) -&gt; [ExpHint] -&gt; m [ExpHint]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ExpHint -&gt; [ExpHint]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp rep -&gt; Int
forall rep. (RepTypes rep, TypedOp (Op rep)) =&gt; Exp rep -&gt; Int
</span><a href="Futhark.IR.Prop.TypeOf.html#expExtTypeSize"><span class="hs-identifier hs-var">expExtTypeSize</span></a></span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684389693"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpHint
</span><a href="Futhark.Pass.ExplicitAllocations.html#NoHint"><span class="hs-identifier hs-var">NoHint</span></a></span><span>
</span><span id="line-1131"></span></pre></body></html>