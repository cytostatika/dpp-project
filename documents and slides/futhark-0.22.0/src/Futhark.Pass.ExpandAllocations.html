<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">-- | Expand allocations inside of maps when possible.</span><span>
</span><span id="line-6"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Pass.ExpandAllocations</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#expandAllocations"><span class="hs-identifier">expandAllocations</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-7"></span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Writer</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">find</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">foldl'</span></span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.Rephrase.html"><span class="hs-identifier">Futhark.Analysis.Rephrase</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.SymbolTable.html"><span class="hs-identifier">Futhark.Analysis.SymbolTable</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">ST</span></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Error.html"><span class="hs-identifier">Futhark.Error</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.html"><span class="hs-identifier">Futhark.IR</span></a></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Simplify.html"><span class="hs-identifier">Futhark.IR.GPU.Simplify</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">GPU</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html"><span class="hs-identifier">Futhark.IR.GPUMem</span></a></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html"><span class="hs-identifier">Futhark.IR.Mem.IxFun</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IxFun</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html"><span class="hs-identifier">Futhark.MonadFreshNames</span></a></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html"><span class="hs-identifier">Futhark.Optimise.Simplify.Rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.Simplify.Rep.html#addScopeWisdom"><span class="hs-identifier">addScopeWisdom</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.html"><span class="hs-identifier">Futhark.Pass</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.GPU.html"><span class="hs-identifier">Futhark.Pass.ExplicitAllocations.GPU</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExplicitAllocations.GPU.html#explicitAllocationsInStms"><span class="hs-identifier">explicitAllocationsInStms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.BlockedKernel</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#nonSegRed"><span class="hs-identifier">nonSegRed</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.ToGPU.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.ToGPU</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.ToGPU.html#segThread"><span class="hs-identifier">segThread</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Tools.html"><span class="hs-identifier">Futhark.Tools</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.CopyPropagate.html"><span class="hs-identifier">Futhark.Transform.CopyPropagate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Transform.CopyPropagate.html#copyPropagateInFun"><span class="hs-identifier">copyPropagateInFun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html"><span class="hs-identifier">Futhark.Transform.Rename</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Transform.Rename.html#renameStm"><span class="hs-identifier">renameStm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#mapAccumLM"><span class="hs-identifier">mapAccumLM</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html"><span class="hs-identifier">Futhark.Util.IntegralExp</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">quot</span></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-comment">-- | The memory expansion pass definition.</span><span>
</span><span id="line-36"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#expandAllocations"><span class="hs-identifier hs-type">expandAllocations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span>
</span><span id="line-37"></span><span id="expandAllocations"><span class="annot"><span class="annottext">expandAllocations :: Pass GPUMem GPUMem
</span><a href="Futhark.Pass.ExpandAllocations.html#expandAllocations"><span class="hs-identifier hs-var hs-var">expandAllocations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; String
-&gt; (Prog GPUMem -&gt; PassM (Prog GPUMem))
-&gt; Pass GPUMem GPUMem
forall fromrep torep.
String
-&gt; String
-&gt; (Prog fromrep -&gt; PassM (Prog torep))
-&gt; Pass fromrep torep
</span><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-var">Pass</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;expand allocations&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Expand allocations&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Prog GPUMem -&gt; PassM (Prog GPUMem)) -&gt; Pass GPUMem GPUMem)
-&gt; (Prog GPUMem -&gt; PassM (Prog GPUMem)) -&gt; Pass GPUMem GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-39"></span><span>    </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span id="local-6989586621684442310"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442310"><span class="hs-identifier hs-var">consts</span></a></span></span><span> </span><span id="local-6989586621684442309"><span class="annot"><span class="annottext">[FunDef GPUMem]
</span><a href="#local-6989586621684442309"><span class="hs-identifier hs-var">funs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-40"></span><span>      </span><span id="local-6989586621684442308"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442308"><span class="hs-identifier hs-var">consts'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-41"></span><span>        </span><span class="annot"><span class="annottext">(VNameSource -&gt; (Stms GPUMem, VNameSource)) -&gt; PassM (Stms GPUMem)
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
(VNameSource -&gt; (a, VNameSource)) -&gt; m a
</span><a href="Futhark.MonadFreshNames.html#modifyNameSource"><span class="hs-identifier hs-var">modifyNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">((VNameSource -&gt; (Stms GPUMem, VNameSource))
 -&gt; PassM (Stms GPUMem))
-&gt; (VNameSource -&gt; (Stms GPUMem, VNameSource))
-&gt; PassM (Stms GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either String (Stms GPUMem, VNameSource)
-&gt; (Stms GPUMem, VNameSource)
forall a. Either String a -&gt; a
</span><a href="Futhark.Pass.ExpandAllocations.html#limitationOnLeft"><span class="hs-identifier hs-var">limitationOnLeft</span></a></span><span> </span><span class="annot"><span class="annottext">(Either String (Stms GPUMem, VNameSource)
 -&gt; (Stms GPUMem, VNameSource))
-&gt; (VNameSource -&gt; Either String (Stms GPUMem, VNameSource))
-&gt; VNameSource
-&gt; (Stms GPUMem, VNameSource)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">StateT VNameSource (Either String) (Stms GPUMem)
-&gt; VNameSource -&gt; Either String (Stms GPUMem, VNameSource)
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><span class="hs-identifier hs-var hs-var">runStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT
  (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
-&gt; Scope GPUMem -&gt; StateT VNameSource (Either String) (Stms GPUMem)
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442310"><span class="hs-identifier hs-var">consts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span>      </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; [FunDef GPUMem] -&gt; Prog GPUMem
forall rep. Stms rep -&gt; [FunDef rep] -&gt; Prog rep
</span><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-var">Prog</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442308"><span class="hs-identifier hs-var">consts'</span></a></span><span> </span><span class="annot"><span class="annottext">([FunDef GPUMem] -&gt; Prog GPUMem)
-&gt; PassM [FunDef GPUMem] -&gt; PassM (Prog GPUMem)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(FunDef GPUMem -&gt; PassM (FunDef GPUMem))
-&gt; [FunDef GPUMem] -&gt; PassM [FunDef GPUMem]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope GPUMem -&gt; FunDef GPUMem -&gt; PassM (FunDef GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformFunDef"><span class="hs-identifier hs-var">transformFunDef</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope GPUMem -&gt; FunDef GPUMem -&gt; PassM (FunDef GPUMem))
-&gt; Scope GPUMem -&gt; FunDef GPUMem -&gt; PassM (FunDef GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; Scope GPUMem
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442308"><span class="hs-identifier hs-var">consts'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FunDef GPUMem]
</span><a href="#local-6989586621684442309"><span class="hs-identifier hs-var">funs</span></a></span><span>
</span><span id="line-43"></span><span>
</span><span id="line-44"></span><span class="hs-comment">-- Cannot use intraproceduralTransformation because it might create</span><span>
</span><span id="line-45"></span><span class="hs-comment">-- duplicate size keys (which are not fixed by renamer, and size</span><span>
</span><span id="line-46"></span><span class="hs-comment">-- keys must currently be globally unique).</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">type</span><span> </span><span id="ExpandM"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#ExpandM"><span class="hs-identifier hs-var">ExpandM</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">StateT</span></span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span id="local-6989586621684443388"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#limitationOnLeft"><span class="hs-identifier hs-type">limitationOnLeft</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><a href="#local-6989586621684443388"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684443388"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-51"></span><span id="limitationOnLeft"><span class="annot"><span class="annottext">limitationOnLeft :: forall a. Either String a -&gt; a
</span><a href="Futhark.Pass.ExpandAllocations.html#limitationOnLeft"><span class="hs-identifier hs-var hs-var">limitationOnLeft</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(String -&gt; a) -&gt; (a -&gt; a) -&gt; Either String a -&gt; a
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; a
forall a. String -&gt; a
</span><a href="Futhark.Error.html#compilerLimitationS"><span class="hs-identifier hs-var">compilerLimitationS</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a
forall a. a -&gt; a
</span><span class="hs-identifier hs-var">id</span></span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#transformFunDef"><span class="hs-identifier hs-type">transformFunDef</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-54"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-55"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-56"></span><span>  </span><span class="annot"><a href="Futhark.Pass.html#PassM"><span class="hs-identifier hs-type">PassM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-57"></span><span id="transformFunDef"><span class="annot"><span class="annottext">transformFunDef :: Scope GPUMem -&gt; FunDef GPUMem -&gt; PassM (FunDef GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformFunDef"><span class="hs-identifier hs-var hs-var">transformFunDef</span></a></span></span><span> </span><span id="local-6989586621684442294"><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684442294"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621684442293"><span class="annot"><span class="annottext">FunDef GPUMem
</span><a href="#local-6989586621684442293"><span class="hs-identifier hs-var">fundec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-58"></span><span>  </span><span id="local-6989586621684442292"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442292"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(VNameSource -&gt; (Body GPUMem, VNameSource)) -&gt; PassM (Body GPUMem)
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
(VNameSource -&gt; (a, VNameSource)) -&gt; m a
</span><a href="Futhark.MonadFreshNames.html#modifyNameSource"><span class="hs-identifier hs-var">modifyNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">((VNameSource -&gt; (Body GPUMem, VNameSource))
 -&gt; PassM (Body GPUMem))
-&gt; (VNameSource -&gt; (Body GPUMem, VNameSource))
-&gt; PassM (Body GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Either String (Body GPUMem, VNameSource)
-&gt; (Body GPUMem, VNameSource)
forall a. Either String a -&gt; a
</span><a href="Futhark.Pass.ExpandAllocations.html#limitationOnLeft"><span class="hs-identifier hs-var">limitationOnLeft</span></a></span><span> </span><span class="annot"><span class="annottext">(Either String (Body GPUMem, VNameSource)
 -&gt; (Body GPUMem, VNameSource))
-&gt; (VNameSource -&gt; Either String (Body GPUMem, VNameSource))
-&gt; VNameSource
-&gt; (Body GPUMem, VNameSource)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">StateT VNameSource (Either String) (Body GPUMem)
-&gt; VNameSource -&gt; Either String (Body GPUMem, VNameSource)
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><span class="hs-identifier hs-var hs-var">runStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT
  (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
-&gt; Scope GPUMem -&gt; StateT VNameSource (Either String) (Body GPUMem)
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT
  (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
</span><a href="#local-6989586621684442291"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>  </span><span class="annot"><span class="annottext">SimpleOps GPUMem
-&gt; SymbolTable (Wise GPUMem)
-&gt; FunDef GPUMem
-&gt; PassM (FunDef GPUMem)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, SimplifiableRep rep) =&gt;
SimpleOps rep
-&gt; SymbolTable (Wise rep) -&gt; FunDef rep -&gt; m (FunDef rep)
</span><a href="Futhark.Transform.CopyPropagate.html#copyPropagateInFun"><span class="hs-identifier hs-var">copyPropagateInFun</span></a></span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><span class="annottext">SimpleOps GPUMem
</span><a href="Futhark.IR.GPUMem.html#simpleGPUMem"><span class="hs-identifier hs-var">simpleGPUMem</span></a></span><span>
</span><span id="line-61"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope (Wise GPUMem) -&gt; SymbolTable (Wise GPUMem)
forall rep. ASTRep rep =&gt; Scope rep -&gt; SymbolTable rep
</span><a href="Futhark.Analysis.SymbolTable.html#fromScope"><span class="hs-identifier hs-var">ST.fromScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope GPUMem -&gt; Scope (Wise GPUMem)
forall rep. Scope rep -&gt; Scope (Wise rep)
</span><a href="Futhark.Optimise.Simplify.Rep.html#addScopeWisdom"><span class="hs-identifier hs-var">addScopeWisdom</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684442294"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><span class="annottext">FunDef GPUMem
</span><a href="#local-6989586621684442293"><span class="hs-identifier hs-var">fundec</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">funDefBody :: Body GPUMem
</span><a href="Futhark.IR.Syntax.html#funDefBody"><span class="hs-identifier hs-var">funDefBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442292"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-64"></span><span>    </span><span id="local-6989586621684442291"><span class="annot"><span class="annottext">m :: ReaderT
  (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
</span><a href="#local-6989586621684442291"><span class="hs-identifier hs-var hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-65"></span><span>      </span><span class="annot"><span class="annottext">Scope GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684442294"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT
   (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem))
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-66"></span><span>        </span><span class="annot"><span class="annottext">FunDef GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">FunDef GPUMem
</span><a href="#local-6989586621684442293"><span class="hs-identifier hs-var">fundec</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT
   (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem))
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-67"></span><span>          </span><span class="annot"><span class="annottext">Body GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem))
-&gt; Body GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FunDef GPUMem -&gt; Body GPUMem
forall rep. FunDef rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#funDefBody"><span class="hs-identifier hs-var hs-var">funDefBody</span></a></span><span> </span><span class="annot"><span class="annottext">FunDef GPUMem
</span><a href="#local-6989586621684442293"><span class="hs-identifier hs-var">fundec</span></a></span><span>
</span><span id="line-68"></span><span>
</span><span id="line-69"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#transformBody"><span class="hs-identifier hs-type">transformBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#ExpandM"><span class="hs-identifier hs-type">ExpandM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span id="transformBody"><span class="annot"><span class="annottext">transformBody :: Body GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformBody"><span class="hs-identifier hs-var hs-var">transformBody</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684442283"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442283"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684442282"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684442282"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyDec GPUMem -&gt; Stms GPUMem -&gt; Result -&gt; Body GPUMem
forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem -&gt; Result -&gt; Body GPUMem)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Result -&gt; Body GPUMem)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442283"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">ReaderT
  (Scope GPUMem)
  (StateT VNameSource (Either String))
  (Result -&gt; Body GPUMem)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) Result
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684442282"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#transformLambda"><span class="hs-identifier hs-type">transformLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#ExpandM"><span class="hs-identifier hs-type">ExpandM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-73"></span><span id="transformLambda"><span class="annot"><span class="annottext">transformLambda :: Lambda GPUMem -&gt; ExpandM (Lambda GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformLambda"><span class="hs-identifier hs-var hs-var">transformLambda</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span id="local-6989586621684442279"><span class="annot"><span class="annottext">[LParam GPUMem]
</span><a href="#local-6989586621684442279"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684442278"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442278"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621684442277"><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684442277"><span class="hs-identifier hs-var">ret</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-74"></span><span>  </span><span class="annot"><span class="annottext">[LParam GPUMem]
-&gt; Body GPUMem
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; Lambda GPUMem
forall rep.
[LParam rep]
-&gt; BodyT rep
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[LParam GPUMem]
</span><a href="#local-6989586621684442279"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-75"></span><span>    </span><span class="annot"><span class="annottext">(Body GPUMem
 -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Lambda GPUMem)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     ([TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Lambda GPUMem)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; Scope GPUMem
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684442279"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442278"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span>    </span><span class="annot"><span class="annottext">ReaderT
  (Scope GPUMem)
  (StateT VNameSource (Either String))
  ([TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Lambda GPUMem)
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; ExpandM (Lambda GPUMem)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     [TypeBase (ShapeBase SubExp) NoUniqueness]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684442277"><span class="hs-identifier hs-var">ret</span></a></span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#transformStms"><span class="hs-identifier hs-type">transformStms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#ExpandM"><span class="hs-identifier hs-type">ExpandM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span id="transformStms"><span class="annot"><span class="annottext">transformStms :: Stms GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformStms"><span class="hs-identifier hs-var hs-var">transformStms</span></a></span></span><span> </span><span id="local-6989586621684442275"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442275"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-80"></span><span>  </span><span class="annot"><span class="annottext">Stms GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442275"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT
   (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem))
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Stms GPUMem] -&gt; Stms GPUMem
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Stms GPUMem] -&gt; Stms GPUMem)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) [Stms GPUMem]
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Stm GPUMem
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem))
-&gt; [Stm GPUMem]
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) [Stms GPUMem]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPUMem -&gt; [Stm GPUMem]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442275"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-81"></span><span>
</span><span id="line-82"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#transformStm"><span class="hs-identifier hs-type">transformStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#ExpandM"><span class="hs-identifier hs-type">ExpandM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-83"></span><span class="hs-comment">-- It is possible that we are unable to expand allocations in some</span><span>
</span><span id="line-84"></span><span class="hs-comment">-- code versions.  If so, we can remove the offending branch.  Only if</span><span>
</span><span id="line-85"></span><span class="hs-comment">-- both versions fail do we propagate the error.</span><span>
</span><span id="line-86"></span><span id="transformStm"><span class="annot"><span class="annottext">transformStm :: Stm GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformStm"><span class="hs-identifier hs-var hs-var">transformStm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684442271"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684442271"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684442270"><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><a href="#local-6989586621684442270"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span id="local-6989586621684442268"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684442268"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684442267"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442267"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span> </span><span id="local-6989586621684442266"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442266"><span class="hs-identifier hs-var">fbranch</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-type">IfDec</span></a></span><span> </span><span id="local-6989586621684442264"><span class="annot"><span class="annottext">[BranchType GPUMem]
</span><a href="#local-6989586621684442264"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="Futhark.IR.Syntax.html#IfEquiv"><span class="hs-identifier hs-var">IfEquiv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-87"></span><span>  </span><span id="local-6989586621684442262"><span class="annot"><span class="annottext">Either String (Body GPUMem)
</span><a href="#local-6989586621684442262"><span class="hs-identifier hs-var">tbranch'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPUMem -&gt; Either String (Body GPUMem)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; Either String (Body GPUMem))
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Either String (Body GPUMem))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442267"><span class="hs-identifier hs-var">tbranch</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ReaderT
  (Scope GPUMem)
  (StateT VNameSource (Either String))
  (Either String (Body GPUMem))
-&gt; (String
    -&gt; ReaderT
         (Scope GPUMem)
         (StateT VNameSource (Either String))
         (Either String (Body GPUMem)))
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Either String (Body GPUMem))
forall e (m :: * -&gt; *) a.
MonadError e m =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catchError`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either String (Body GPUMem)
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Either String (Body GPUMem))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either String (Body GPUMem)
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      (Either String (Body GPUMem)))
-&gt; (String -&gt; Either String (Body GPUMem))
-&gt; String
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Either String (Body GPUMem))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String (Body GPUMem)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>  </span><span id="local-6989586621684442260"><span class="annot"><span class="annottext">Either String (Body GPUMem)
</span><a href="#local-6989586621684442260"><span class="hs-identifier hs-var">fbranch'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPUMem -&gt; Either String (Body GPUMem)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; Either String (Body GPUMem))
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Either String (Body GPUMem))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442266"><span class="hs-identifier hs-var">fbranch</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ReaderT
  (Scope GPUMem)
  (StateT VNameSource (Either String))
  (Either String (Body GPUMem))
-&gt; (String
    -&gt; ReaderT
         (Scope GPUMem)
         (StateT VNameSource (Either String))
         (Either String (Body GPUMem)))
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Either String (Body GPUMem))
forall e (m :: * -&gt; *) a.
MonadError e m =&gt;
m a -&gt; (e -&gt; m a) -&gt; m a
</span><span class="hs-operator hs-var">`catchError`</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either String (Body GPUMem)
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Either String (Body GPUMem))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either String (Body GPUMem)
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      (Either String (Body GPUMem)))
-&gt; (String -&gt; Either String (Body GPUMem))
-&gt; String
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Either String (Body GPUMem))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String (Body GPUMem)
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Either String (Body GPUMem)
</span><a href="#local-6989586621684442262"><span class="hs-identifier hs-var">tbranch'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Either String (Body GPUMem)
</span><a href="#local-6989586621684442260"><span class="hs-identifier hs-var">fbranch'</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-90"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621684442259"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442259"><span class="hs-identifier hs-var">fbranch''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-91"></span><span>      </span><span class="annot"><span class="annottext">Stms GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem))
-&gt; Stms GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem -&gt; Stms GPUMem
</span><a href="#local-6989586621684442258"><span class="hs-identifier hs-var">useBranch</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442259"><span class="hs-identifier hs-var">fbranch''</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621684442257"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442257"><span class="hs-identifier hs-var">tbranch''</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-93"></span><span>      </span><span class="annot"><span class="annottext">Stms GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem))
-&gt; Stms GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem -&gt; Stms GPUMem
</span><a href="#local-6989586621684442258"><span class="hs-identifier hs-var">useBranch</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442257"><span class="hs-identifier hs-var">tbranch''</span></a></span><span>
</span><span id="line-94"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621684442256"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442256"><span class="hs-identifier hs-var">tbranch''</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Right</span></span><span> </span><span id="local-6989586621684442255"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442255"><span class="hs-identifier hs-var">fbranch''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-95"></span><span>      </span><span class="annot"><span class="annottext">Stms GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem))
-&gt; Stms GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; Stms GPUMem
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm GPUMem -&gt; Stms GPUMem) -&gt; Stm GPUMem -&gt; Stms GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem -&gt; StmAux (ExpDec GPUMem) -&gt; ExpT GPUMem -&gt; Stm GPUMem
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684442271"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><a href="#local-6989586621684442270"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT GPUMem -&gt; Stm GPUMem) -&gt; ExpT GPUMem -&gt; Stm GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp
-&gt; Body GPUMem
-&gt; Body GPUMem
-&gt; IfDec (BranchType GPUMem)
-&gt; ExpT GPUMem
forall rep.
SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684442268"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442256"><span class="hs-identifier hs-var">tbranch''</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442255"><span class="hs-identifier hs-var">fbranch''</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[BranchTypeMem] -&gt; IfSort -&gt; IfDec BranchTypeMem
forall rt. [rt] -&gt; IfSort -&gt; IfDec rt
</span><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-var">IfDec</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType GPUMem]
[BranchTypeMem]
</span><a href="#local-6989586621684442264"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="Futhark.IR.Syntax.html#IfEquiv"><span class="hs-identifier hs-var">IfEquiv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-96"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Left</span></span><span> </span><span id="local-6989586621684442253"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684442253"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Either String (Body GPUMem)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-97"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684442253"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-99"></span><span>    </span><span id="local-6989586621684442247"><span class="annot"><span class="annottext">bindRes :: PatElemT (LetDec rep) -&gt; SubExpRes -&gt; Stm rep
</span><a href="#local-6989586621684442247"><span class="hs-identifier hs-var hs-var">bindRes</span></a></span></span><span> </span><span id="local-6989586621684442246"><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684442246"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684442244"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684442244"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684442243"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684442243"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-100"></span><span>      </span><span class="annot"><span class="annottext">Certs -&gt; Stm rep -&gt; Stm rep
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684442244"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm rep -&gt; Stm rep) -&gt; Stm rep -&gt; Stm rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT (LetDec rep)] -&gt; Pat rep
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatElemT (LetDec rep)
</span><a href="#local-6989586621684442246"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Stm rep) -&gt; Exp rep -&gt; Stm rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp rep
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Exp rep) -&gt; BasicOp -&gt; Exp rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684442243"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span>    </span><span id="local-6989586621684442258"><span class="annot"><span class="annottext">useBranch :: Body GPUMem -&gt; Stms GPUMem
</span><a href="#local-6989586621684442258"><span class="hs-identifier hs-var hs-var">useBranch</span></a></span></span><span> </span><span id="local-6989586621684442237"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442237"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-103"></span><span>      </span><span class="annot"><span class="annottext">Body GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442237"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-104"></span><span>        </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; Stms GPUMem -&gt; Stms GPUMem
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Stm GPUMem] -&gt; Stms GPUMem
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatElemT (MemInfo SubExp NoUniqueness MemBind)
 -&gt; SubExpRes -&gt; Stm GPUMem)
-&gt; [PatElemT (MemInfo SubExp NoUniqueness MemBind)]
-&gt; Result
-&gt; [Stm GPUMem]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind)
-&gt; SubExpRes -&gt; Stm GPUMem
forall {rep}.
(ExpDec rep ~ ()) =&gt;
PatElemT (LetDec rep) -&gt; SubExpRes -&gt; Stm rep
</span><a href="#local-6989586621684442247"><span class="hs-identifier hs-var">bindRes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT (MemInfo SubExp NoUniqueness MemBind)
-&gt; [PatElemT (MemInfo SubExp NoUniqueness MemBind)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684442271"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPUMem -&gt; Result
forall rep. BodyT rep -&gt; Result
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684442237"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684442231"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684442231"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684442230"><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><a href="#local-6989586621684442230"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span id="local-6989586621684442229"><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684442229"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-106"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684442228"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442228"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442227"><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684442227"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExpT GPUMem -&gt; ExpandM (Stms GPUMem, ExpT GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformExp"><span class="hs-identifier hs-var">transformExp</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpT GPUMem -&gt; ExpandM (Stms GPUMem, ExpT GPUMem))
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (ExpT GPUMem)
-&gt; ExpandM (Stms GPUMem, ExpT GPUMem)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Mapper
  GPUMem
  GPUMem
  (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
-&gt; ExpT GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (ExpT GPUMem)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
Mapper frep trep m -&gt; Exp frep -&gt; m (Exp trep)
</span><a href="Futhark.IR.Traversals.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a></span><span> </span><span class="annot"><span class="annottext">Mapper
  GPUMem
  GPUMem
  (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
</span><a href="#local-6989586621684442223"><span class="hs-identifier hs-var">transform</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684442229"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-107"></span><span>  </span><span class="annot"><span class="annottext">Stms GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem))
-&gt; Stms GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442228"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; Stms GPUMem -&gt; Stms GPUMem
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; Stms GPUMem
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat GPUMem -&gt; StmAux (ExpDec GPUMem) -&gt; ExpT GPUMem -&gt; Stm GPUMem
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684442231"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><a href="#local-6989586621684442230"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684442227"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-108"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-109"></span><span>    </span><span id="local-6989586621684442223"><span class="annot"><span class="annottext">transform :: Mapper
  GPUMem
  GPUMem
  (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
</span><a href="#local-6989586621684442223"><span class="hs-identifier hs-var hs-var">transform</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-110"></span><span>      </span><span class="annot"><span class="annottext">Mapper
  GPUMem
  GPUMem
  (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
forall (m :: * -&gt; *) rep. Monad m =&gt; Mapper rep rep m
</span><a href="Futhark.IR.Traversals.html#identityMapper"><span class="hs-identifier hs-var">identityMapper</span></a></span><span>
</span><span id="line-111"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnBody :: Scope GPUMem
-&gt; Body GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
</span><a href="Futhark.IR.Traversals.html#mapOnBody"><span class="hs-identifier hs-var">mapOnBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684442213"><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684442213"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684442213"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT
   (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem))
-&gt; (Body GPUMem
    -&gt; ReaderT
         (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem))
-&gt; Body GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Body GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span>
</span><span id="line-112"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-113"></span><span>
</span><span id="line-114"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#transformExp"><span class="hs-identifier hs-type">transformExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#ExpandM"><span class="hs-identifier hs-type">ExpandM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-115"></span><span id="transformExp"><span class="annot"><span class="annottext">transformExp :: ExpT GPUMem -&gt; ExpandM (Stms GPUMem, ExpT GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformExp"><span class="hs-identifier hs-var hs-var">transformExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-type">SegMap</span></a></span><span> </span><span id="local-6989586621684442208"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442208"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684442207"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442207"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684442206"><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684442206"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684442205"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442205"><span class="hs-identifier hs-var">kbody</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684442204"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442204"><span class="hs-identifier hs-var">alloc_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442203"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442203"><span class="hs-identifier hs-var">kbody'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SegLevel
-&gt; SegSpace
-&gt; [Lambda GPUMem]
-&gt; KernelBody GPUMem
-&gt; ExpandM (Stms GPUMem, ([Lambda GPUMem], KernelBody GPUMem))
</span><a href="Futhark.Pass.ExpandAllocations.html#transformScanRed"><span class="hs-identifier hs-var">transformScanRed</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442208"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442207"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442205"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-117"></span><span>  </span><span class="annot"><span class="annottext">(Stms GPUMem, ExpT GPUMem) -&gt; ExpandM (Stms GPUMem, ExpT GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-118"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442204"><span class="hs-identifier hs-var">alloc_stms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-119"></span><span>      </span><span class="annot"><span class="annottext">Op GPUMem -&gt; ExpT GPUMem
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op GPUMem -&gt; ExpT GPUMem) -&gt; Op GPUMem -&gt; ExpT GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ())
forall inner. inner -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ()))
-&gt; HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem -&gt; HostOp GPUMem ()
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp SegLevel GPUMem -&gt; HostOp GPUMem ())
-&gt; SegOp SegLevel GPUMem -&gt; HostOp GPUMem ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegLevel
-&gt; SegSpace
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; KernelBody GPUMem
-&gt; SegOp SegLevel GPUMem
forall lvl rep.
lvl
-&gt; SegSpace
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; KernelBody rep
-&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-var">SegMap</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442208"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442207"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684442206"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442203"><span class="hs-identifier hs-var">kbody'</span></a></span><span>
</span><span id="line-120"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#transformExp"><span class="hs-identifier hs-var">transformExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegRed"><span class="hs-identifier hs-type">SegRed</span></a></span><span> </span><span id="local-6989586621684442200"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442200"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684442199"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442199"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684442198"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684442198"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684442197"><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684442197"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684442196"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442196"><span class="hs-identifier hs-var">kbody</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684442195"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442195"><span class="hs-identifier hs-var">alloc_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684442194"><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684442194"><span class="hs-identifier hs-var">lams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442193"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442193"><span class="hs-identifier hs-var">kbody'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><span class="annottext">SegLevel
-&gt; SegSpace
-&gt; [Lambda GPUMem]
-&gt; KernelBody GPUMem
-&gt; ExpandM (Stms GPUMem, ([Lambda GPUMem], KernelBody GPUMem))
</span><a href="Futhark.Pass.ExpandAllocations.html#transformScanRed"><span class="hs-identifier hs-var">transformScanRed</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442200"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442199"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; Lambda GPUMem)
-&gt; [SegBinOp GPUMem] -&gt; [Lambda GPUMem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; Lambda GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684442198"><span class="hs-identifier hs-var">reds</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442196"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684442191"><span class="annot"><span class="annottext">reds' :: [SegBinOp GPUMem]
</span><a href="#local-6989586621684442191"><span class="hs-identifier hs-var hs-var">reds'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; Lambda GPUMem -&gt; SegBinOp GPUMem)
-&gt; [SegBinOp GPUMem] -&gt; [Lambda GPUMem] -&gt; [SegBinOp GPUMem]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684442190"><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684442190"><span class="hs-identifier hs-var">red</span></a></span></span><span> </span><span id="local-6989586621684442189"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442189"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684442190"><span class="hs-identifier hs-var">red</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">segBinOpLambda :: Lambda GPUMem
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var">segBinOpLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442189"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684442198"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684442194"><span class="hs-identifier hs-var">lams</span></a></span><span>
</span><span id="line-125"></span><span>  </span><span class="annot"><span class="annottext">(Stms GPUMem, ExpT GPUMem) -&gt; ExpandM (Stms GPUMem, ExpT GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-126"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442195"><span class="hs-identifier hs-var">alloc_stms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-127"></span><span>      </span><span class="annot"><span class="annottext">Op GPUMem -&gt; ExpT GPUMem
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op GPUMem -&gt; ExpT GPUMem) -&gt; Op GPUMem -&gt; ExpT GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ())
forall inner. inner -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ()))
-&gt; HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem -&gt; HostOp GPUMem ()
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp SegLevel GPUMem -&gt; HostOp GPUMem ())
-&gt; SegOp SegLevel GPUMem -&gt; HostOp GPUMem ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegLevel
-&gt; SegSpace
-&gt; [SegBinOp GPUMem]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; KernelBody GPUMem
-&gt; SegOp SegLevel GPUMem
forall lvl rep.
lvl
-&gt; SegSpace
-&gt; [SegBinOp rep]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; KernelBody rep
-&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegRed"><span class="hs-identifier hs-var">SegRed</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442200"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442199"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684442191"><span class="hs-identifier hs-var">reds'</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684442197"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442193"><span class="hs-identifier hs-var">kbody'</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-129"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#transformExp"><span class="hs-identifier hs-var">transformExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegScan"><span class="hs-identifier hs-type">SegScan</span></a></span><span> </span><span id="local-6989586621684442187"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442187"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684442186"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442186"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684442185"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684442185"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span id="local-6989586621684442184"><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684442184"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684442183"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442183"><span class="hs-identifier hs-var">kbody</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684442182"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442182"><span class="hs-identifier hs-var">alloc_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684442181"><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684442181"><span class="hs-identifier hs-var">lams</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442180"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442180"><span class="hs-identifier hs-var">kbody'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-131"></span><span>    </span><span class="annot"><span class="annottext">SegLevel
-&gt; SegSpace
-&gt; [Lambda GPUMem]
-&gt; KernelBody GPUMem
-&gt; ExpandM (Stms GPUMem, ([Lambda GPUMem], KernelBody GPUMem))
</span><a href="Futhark.Pass.ExpandAllocations.html#transformScanRed"><span class="hs-identifier hs-var">transformScanRed</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442187"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442186"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; Lambda GPUMem)
-&gt; [SegBinOp GPUMem] -&gt; [Lambda GPUMem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem -&gt; Lambda GPUMem
forall rep. SegBinOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var hs-var">segBinOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684442185"><span class="hs-identifier hs-var">scans</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442183"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-132"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684442179"><span class="annot"><span class="annottext">scans' :: [SegBinOp GPUMem]
</span><a href="#local-6989586621684442179"><span class="hs-identifier hs-var hs-var">scans'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SegBinOp GPUMem -&gt; Lambda GPUMem -&gt; SegBinOp GPUMem)
-&gt; [SegBinOp GPUMem] -&gt; [Lambda GPUMem] -&gt; [SegBinOp GPUMem]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684442178"><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684442178"><span class="hs-identifier hs-var">red</span></a></span></span><span> </span><span id="local-6989586621684442177"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442177"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SegBinOp GPUMem
</span><a href="#local-6989586621684442178"><span class="hs-identifier hs-var">red</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">segBinOpLambda :: Lambda GPUMem
</span><a href="Futhark.IR.SegOp.html#segBinOpLambda"><span class="hs-identifier hs-var">segBinOpLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442177"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684442185"><span class="hs-identifier hs-var">scans</span></a></span><span> </span><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684442181"><span class="hs-identifier hs-var">lams</span></a></span><span>
</span><span id="line-133"></span><span>  </span><span class="annot"><span class="annottext">(Stms GPUMem, ExpT GPUMem) -&gt; ExpandM (Stms GPUMem, ExpT GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-134"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442182"><span class="hs-identifier hs-var">alloc_stms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-135"></span><span>      </span><span class="annot"><span class="annottext">Op GPUMem -&gt; ExpT GPUMem
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op GPUMem -&gt; ExpT GPUMem) -&gt; Op GPUMem -&gt; ExpT GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ())
forall inner. inner -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ()))
-&gt; HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem -&gt; HostOp GPUMem ()
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp SegLevel GPUMem -&gt; HostOp GPUMem ())
-&gt; SegOp SegLevel GPUMem -&gt; HostOp GPUMem ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegLevel
-&gt; SegSpace
-&gt; [SegBinOp GPUMem]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; KernelBody GPUMem
-&gt; SegOp SegLevel GPUMem
forall lvl rep.
lvl
-&gt; SegSpace
-&gt; [SegBinOp rep]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; KernelBody rep
-&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegScan"><span class="hs-identifier hs-var">SegScan</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442187"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442186"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684442179"><span class="hs-identifier hs-var">scans'</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684442184"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442180"><span class="hs-identifier hs-var">kbody'</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#transformExp"><span class="hs-identifier hs-var">transformExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegHist"><span class="hs-identifier hs-type">SegHist</span></a></span><span> </span><span id="local-6989586621684442175"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442175"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684442174"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442174"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684442173"><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684442173"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684442172"><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684442172"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684442171"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442171"><span class="hs-identifier hs-var">kbody</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684442170"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442170"><span class="hs-identifier hs-var">alloc_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684442169"><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684442169"><span class="hs-identifier hs-var">lams'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442168"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442168"><span class="hs-identifier hs-var">kbody'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SegLevel
-&gt; SegSpace
-&gt; [Lambda GPUMem]
-&gt; KernelBody GPUMem
-&gt; ExpandM (Stms GPUMem, ([Lambda GPUMem], KernelBody GPUMem))
</span><a href="Futhark.Pass.ExpandAllocations.html#transformScanRed"><span class="hs-identifier hs-var">transformScanRed</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442175"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442174"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684442167"><span class="hs-identifier hs-var">lams</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442171"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684442166"><span class="annot"><span class="annottext">ops' :: [HistOp GPUMem]
</span><a href="#local-6989586621684442166"><span class="hs-identifier hs-var hs-var">ops'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HistOp GPUMem -&gt; Lambda GPUMem -&gt; HistOp GPUMem)
-&gt; [HistOp GPUMem] -&gt; [Lambda GPUMem] -&gt; [HistOp GPUMem]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">HistOp GPUMem -&gt; Lambda GPUMem -&gt; HistOp GPUMem
forall {rep} {rep}. HistOp rep -&gt; Lambda rep -&gt; HistOp rep
</span><a href="#local-6989586621684442165"><span class="hs-identifier hs-var">onOp</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684442173"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684442169"><span class="hs-identifier hs-var">lams'</span></a></span><span>
</span><span id="line-140"></span><span>  </span><span class="annot"><span class="annottext">(Stms GPUMem, ExpT GPUMem) -&gt; ExpandM (Stms GPUMem, ExpT GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-141"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442170"><span class="hs-identifier hs-var">alloc_stms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-142"></span><span>      </span><span class="annot"><span class="annottext">Op GPUMem -&gt; ExpT GPUMem
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op GPUMem -&gt; ExpT GPUMem) -&gt; Op GPUMem -&gt; ExpT GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ())
forall inner. inner -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ()))
-&gt; HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem -&gt; HostOp GPUMem ()
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp SegLevel GPUMem -&gt; HostOp GPUMem ())
-&gt; SegOp SegLevel GPUMem -&gt; HostOp GPUMem ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegLevel
-&gt; SegSpace
-&gt; [HistOp GPUMem]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; KernelBody GPUMem
-&gt; SegOp SegLevel GPUMem
forall lvl rep.
lvl
-&gt; SegSpace
-&gt; [HistOp rep]
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; KernelBody rep
-&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegHist"><span class="hs-identifier hs-var">SegHist</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442175"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442174"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684442166"><span class="hs-identifier hs-var">ops'</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684442172"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442168"><span class="hs-identifier hs-var">kbody'</span></a></span><span>
</span><span id="line-143"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-145"></span><span>    </span><span id="local-6989586621684442167"><span class="annot"><span class="annottext">lams :: [Lambda GPUMem]
</span><a href="#local-6989586621684442167"><span class="hs-identifier hs-var hs-var">lams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HistOp GPUMem -&gt; Lambda GPUMem)
-&gt; [HistOp GPUMem] -&gt; [Lambda GPUMem]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">HistOp GPUMem -&gt; Lambda GPUMem
forall rep. HistOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#histOp"><span class="hs-identifier hs-var hs-var">histOp</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684442173"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-146"></span><span>    </span><span id="local-6989586621684442165"><span class="annot"><span class="annottext">onOp :: HistOp rep -&gt; Lambda rep -&gt; HistOp rep
</span><a href="#local-6989586621684442165"><span class="hs-identifier hs-var hs-var">onOp</span></a></span></span><span> </span><span id="local-6989586621684442163"><span class="annot"><span class="annottext">HistOp rep
</span><a href="#local-6989586621684442163"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621684442162"><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684442162"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HistOp rep
</span><a href="#local-6989586621684442163"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">histOp :: Lambda rep
</span><a href="Futhark.IR.SegOp.html#histOp"><span class="hs-identifier hs-var">histOp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda rep
</span><a href="#local-6989586621684442162"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-147"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#transformExp"><span class="hs-identifier hs-var">transformExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-type">WithAcc</span></a></span><span> </span><span id="local-6989586621684442160"><span class="annot"><span class="annottext">[WithAccInput GPUMem]
</span><a href="#local-6989586621684442160"><span class="hs-identifier hs-var">inputs</span></a></span></span><span> </span><span id="local-6989586621684442159"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442159"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-148"></span><span>  </span><span id="local-6989586621684442158"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442158"><span class="hs-identifier hs-var">lam'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; ExpandM (Lambda GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformLambda"><span class="hs-identifier hs-var">transformLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442159"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684442157"><span class="annot"><span class="annottext">[Stms GPUMem]
</span><a href="#local-6989586621684442157"><span class="hs-identifier hs-var">input_alloc_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442156"><span class="annot"><span class="annottext">[WithAccInput GPUMem]
</span><a href="#local-6989586621684442156"><span class="hs-identifier hs-var">inputs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Stms GPUMem, WithAccInput GPUMem)]
-&gt; ([Stms GPUMem], [WithAccInput GPUMem])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Stms GPUMem, WithAccInput GPUMem)]
 -&gt; ([Stms GPUMem], [WithAccInput GPUMem]))
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     [(Stms GPUMem, WithAccInput GPUMem)]
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     ([Stms GPUMem], [WithAccInput GPUMem])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(WithAccInput GPUMem
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      (Stms GPUMem, WithAccInput GPUMem))
-&gt; [WithAccInput GPUMem]
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     [(Stms GPUMem, WithAccInput GPUMem)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">WithAccInput GPUMem
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Stms GPUMem, WithAccInput GPUMem)
forall {b} {b}.
(ShapeBase SubExp, b, Maybe (Lambda GPUMem, b))
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
</span><a href="#local-6989586621684442154"><span class="hs-identifier hs-var">onInput</span></a></span><span> </span><span class="annot"><span class="annottext">[WithAccInput GPUMem]
</span><a href="#local-6989586621684442160"><span class="hs-identifier hs-var">inputs</span></a></span><span>
</span><span id="line-150"></span><span>  </span><span class="annot"><span class="annottext">(Stms GPUMem, ExpT GPUMem) -&gt; ExpandM (Stms GPUMem, ExpT GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-151"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[Stms GPUMem] -&gt; Stms GPUMem
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[Stms GPUMem]
</span><a href="#local-6989586621684442157"><span class="hs-identifier hs-var">input_alloc_stms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-152"></span><span>      </span><span class="annot"><span class="annottext">[WithAccInput GPUMem] -&gt; Lambda GPUMem -&gt; ExpT GPUMem
forall rep. [WithAccInput rep] -&gt; Lambda rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-var">WithAcc</span></a></span><span> </span><span class="annot"><span class="annottext">[WithAccInput GPUMem]
</span><a href="#local-6989586621684442156"><span class="hs-identifier hs-var">inputs'</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442158"><span class="hs-identifier hs-var">lam'</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-154"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-155"></span><span>    </span><span id="local-6989586621684442154"><span class="annot"><span class="annottext">onInput :: (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b))
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
</span><a href="#local-6989586621684442154"><span class="hs-identifier hs-var hs-var">onInput</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684442123"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684442123"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442122"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684442122"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Lambda GPUMem, b)
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-156"></span><span>      </span><span class="annot"><span class="annottext">(Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPUMem
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684442123"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684442122"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe (Lambda GPUMem, b)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span>    </span><span class="annot"><a href="#local-6989586621684442154"><span class="hs-identifier hs-var">onInput</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684442121"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684442121"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442120"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684442120"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684442119"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442119"><span class="hs-identifier hs-var">op_lam</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442118"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684442118"><span class="hs-identifier hs-var">nes</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-158"></span><span>      </span><span id="local-6989586621684442117"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684442117"><span class="hs-identifier hs-var">bound_outside</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scope GPUMem -&gt; Names)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) Names
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">((Scope GPUMem -&gt; Names)
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) Names)
-&gt; (Scope GPUMem -&gt; Names)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names)
-&gt; (Scope GPUMem -&gt; [VName]) -&gt; Scope GPUMem -&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem -&gt; [VName]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span>
</span><span id="line-159"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-comment">-- XXX: fake a SegLevel, which we don't have here.  We will not</span><span>
</span><span id="line-160"></span><span>          </span><span class="hs-comment">-- use it for anything, as we will not allow irregular</span><span>
</span><span id="line-161"></span><span>          </span><span class="hs-comment">-- allocations inside the update function.</span><span>
</span><span id="line-162"></span><span>          </span><span id="local-6989586621684442113"><span class="annot"><span class="annottext">lvl :: SegLevel
</span><a href="#local-6989586621684442113"><span class="hs-identifier hs-var hs-var">lvl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Count NumGroups SubExp
-&gt; Count GroupSize SubExp -&gt; SegVirt -&gt; SegLevel
</span><a href="Futhark.IR.GPU.Op.html#SegThread"><span class="hs-identifier hs-var">SegThread</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Count NumGroups SubExp
forall u e. e -&gt; Count u e
</span><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-var">Count</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Count NumGroups SubExp)
-&gt; SubExp -&gt; Count NumGroups SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Count GroupSize SubExp
forall u e. e -&gt; Count u e
</span><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-var">Count</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; Count GroupSize SubExp)
-&gt; SubExp -&gt; Count GroupSize SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><a href="Futhark.IR.SegOp.html#SegNoVirt"><span class="hs-identifier hs-var">SegNoVirt</span></a></span><span>
</span><span id="line-163"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684442107"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442107"><span class="hs-identifier hs-var">op_lam'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442106"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442106"><span class="hs-identifier hs-var">lam_allocs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-164"></span><span>            </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; Names -&gt; Names -&gt; Lambda GPUMem -&gt; (Lambda GPUMem, Extraction)
</span><a href="Futhark.Pass.ExpandAllocations.html#extractLambdaAllocations"><span class="hs-identifier hs-var">extractLambdaAllocations</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442113"><span class="hs-identifier hs-var">lvl</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684442117"><span class="hs-identifier hs-var">bound_outside</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442119"><span class="hs-identifier hs-var">op_lam</span></a></span><span>
</span><span id="line-165"></span><span>          </span><span id="local-6989586621684442104"><span class="annot"><span class="annottext">variantAlloc :: ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space) -&gt; Bool
</span><a href="#local-6989586621684442104"><span class="hs-identifier hs-var hs-var">variantAlloc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684442102"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684442102"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684442102"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684442117"><span class="hs-identifier hs-var">bound_outside</span></a></span><span>
</span><span id="line-166"></span><span>          </span><span class="annot"><a href="#local-6989586621684442104"><span class="hs-identifier hs-var">variantAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-167"></span><span>          </span><span class="hs-special">(</span><span id="local-6989586621684442099"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442099"><span class="hs-identifier hs-var">variant_allocs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442098"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442098"><span class="hs-identifier hs-var">invariant_allocs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(((SegLevel, [TPrimExp Int64 VName]), SubExp, Space) -&gt; Bool)
-&gt; Extraction -&gt; (Extraction, Extraction)
forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; (Map k a, Map k a)
</span><span class="hs-identifier hs-var">M.partition</span></span><span> </span><span class="annot"><span class="annottext">((SegLevel, [TPrimExp Int64 VName]), SubExp, Space) -&gt; Bool
</span><a href="#local-6989586621684442104"><span class="hs-identifier hs-var">variantAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442106"><span class="hs-identifier hs-var">lam_allocs</span></a></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Extraction -&gt; [((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)]
forall k a. Map k a -&gt; [a]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442099"><span class="hs-identifier hs-var">variant_allocs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-170"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442095"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684442095"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-171"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; ReaderT (Scope GPUMem) (StateT VNameSource (Either String)) ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(String
 -&gt; ReaderT (Scope GPUMem) (StateT VNameSource (Either String)) ())
-&gt; String
-&gt; ReaderT (Scope GPUMem) (StateT VNameSource (Either String)) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-172"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot handle un-sliceable allocation size: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684442095"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-173"></span><span>              </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\nLikely cause: irregular nested operations inside accumulator update operator.&quot;</span></span><span>
</span><span id="line-174"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-175"></span><span>          </span><span class="annot"><span class="annottext">()
-&gt; ReaderT (Scope GPUMem) (StateT VNameSource (Either String)) ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>
</span><span id="line-177"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684442093"><span class="annot"><span class="annottext">num_is :: Int
</span><a href="#local-6989586621684442093"><span class="hs-identifier hs-var hs-var">num_is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp -&gt; Int
forall a. ArrayShape a =&gt; a -&gt; Int
</span><a href="Futhark.IR.Syntax.Core.html#shapeRank"><span class="hs-identifier hs-var">shapeRank</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684442121"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-178"></span><span>          </span><span id="local-6989586621684442091"><span class="annot"><span class="annottext">is :: [VName]
</span><a href="#local-6989586621684442091"><span class="hs-identifier hs-var hs-var">is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName)
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName])
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684442093"><span class="hs-identifier hs-var">num_is</span></a></span><span> </span><span class="annot"><span class="annottext">([Param (MemInfo SubExp NoUniqueness MemBind)]
 -&gt; [Param (MemInfo SubExp NoUniqueness MemBind)])
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442119"><span class="hs-identifier hs-var">op_lam</span></a></span><span>
</span><span id="line-179"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684442087"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442087"><span class="hs-identifier hs-var">alloc_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442086"><span class="annot"><span class="annottext">RebaseMap
</span><a href="#local-6989586621684442086"><span class="hs-identifier hs-var">alloc_offsets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-180"></span><span>        </span><span class="annot"><span class="annottext">((SegLevel, [TPrimExp Int64 VName])
 -&gt; (ShapeBase SubExp, [TPrimExp Int64 VName]))
-&gt; Extraction -&gt; ExpandM (Stms GPUMem, RebaseMap)
</span><a href="Futhark.Pass.ExpandAllocations.html#genericExpandedInvariantAllocations"><span class="hs-identifier hs-var">genericExpandedInvariantAllocations</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(ShapeBase SubExp, [TPrimExp Int64 VName])
-&gt; (SegLevel, [TPrimExp Int64 VName])
-&gt; (ShapeBase SubExp, [TPrimExp Int64 VName])
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684442121"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TPrimExp Int64 VName)
-&gt; [VName] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684442091"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442098"><span class="hs-identifier hs-var">invariant_allocs</span></a></span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span>      </span><span id="local-6989586621684442082"><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684442082"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT
  (Scope GPUMem) (StateT VNameSource (Either String)) (Scope GPUMem)
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-183"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684442080"><span class="annot"><span class="annottext">scope' :: Scope GPUMem
</span><a href="#local-6989586621684442080"><span class="hs-identifier hs-var hs-var">scope'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; Scope GPUMem
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442119"><span class="hs-identifier hs-var">op_lam</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem -&gt; Scope GPUMem -&gt; Scope GPUMem
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684442082"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-184"></span><span>      </span><span class="annot"><span class="annottext">(String
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b))))
-&gt; ((Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
    -&gt; ReaderT
         (Scope GPUMem)
         (StateT VNameSource (Either String))
         (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b))))
-&gt; Either
     String
     (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either
   String
   (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b))))
-&gt; Either
     String
     (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-185"></span><span>        </span><span class="annot"><span class="annottext">Scope GPUMem
-&gt; RebaseMap
-&gt; OffsetM
     (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
-&gt; Either
     String
     (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
forall a. Scope GPUMem -&gt; RebaseMap -&gt; OffsetM a -&gt; Either String a
</span><a href="Futhark.Pass.ExpandAllocations.html#runOffsetM"><span class="hs-identifier hs-var">runOffsetM</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684442080"><span class="hs-identifier hs-var">scope'</span></a></span><span> </span><span class="annot"><span class="annottext">RebaseMap
</span><a href="#local-6989586621684442086"><span class="hs-identifier hs-var">alloc_offsets</span></a></span><span> </span><span class="annot"><span class="annottext">(OffsetM
   (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
 -&gt; Either
      String
      (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b))))
-&gt; OffsetM
     (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
-&gt; Either
     String
     (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-186"></span><span>          </span><span id="local-6989586621684442078"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442078"><span class="hs-identifier hs-var">op_lam''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; OffsetM (Lambda GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInLambda"><span class="hs-identifier hs-var">offsetMemoryInLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442107"><span class="hs-identifier hs-var">op_lam'</span></a></span><span>
</span><span id="line-187"></span><span>          </span><span class="annot"><span class="annottext">(Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
-&gt; OffsetM
     (Stms GPUMem, (ShapeBase SubExp, b, Maybe (Lambda GPUMem, b)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442087"><span class="hs-identifier hs-var">alloc_stms</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684442121"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684442120"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Lambda GPUMem, b) -&gt; Maybe (Lambda GPUMem, b)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442078"><span class="hs-identifier hs-var">op_lam''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684442118"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-188"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#transformExp"><span class="hs-identifier hs-var">transformExp</span></a></span><span> </span><span id="local-6989586621684442076"><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684442076"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><span class="annottext">(Stms GPUMem, ExpT GPUMem) -&gt; ExpandM (Stms GPUMem, ExpT GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPUMem
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684442076"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#transformScanRed"><span class="hs-identifier hs-type">transformScanRed</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-192"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegLevel"><span class="hs-identifier hs-type">SegLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-193"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-194"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-195"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-196"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#ExpandM"><span class="hs-identifier hs-type">ExpandM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-197"></span><span id="transformScanRed"><span class="annot"><span class="annottext">transformScanRed :: SegLevel
-&gt; SegSpace
-&gt; [Lambda GPUMem]
-&gt; KernelBody GPUMem
-&gt; ExpandM (Stms GPUMem, ([Lambda GPUMem], KernelBody GPUMem))
</span><a href="Futhark.Pass.ExpandAllocations.html#transformScanRed"><span class="hs-identifier hs-var hs-var">transformScanRed</span></a></span></span><span> </span><span id="local-6989586621684442075"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442075"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684442074"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442074"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684442073"><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684442073"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span id="local-6989586621684442072"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442072"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-198"></span><span>  </span><span id="local-6989586621684442071"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684442071"><span class="hs-identifier hs-var">bound_outside</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scope GPUMem -&gt; Names)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) Names
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">((Scope GPUMem -&gt; Names)
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) Names)
-&gt; (Scope GPUMem -&gt; Names)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names)
-&gt; (Scope GPUMem -&gt; [VName]) -&gt; Scope GPUMem -&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem -&gt; [VName]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684442070"><span class="annot"><span class="annottext">user :: (SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684442070"><span class="hs-identifier hs-var hs-var">user</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442075"><span class="hs-identifier hs-var">lvl</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">le64</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TPrimExp Int64 VName) -&gt; VName -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442074"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684442068"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442068"><span class="hs-identifier hs-var">kbody'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442067"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442067"><span class="hs-identifier hs-var">kbody_allocs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-201"></span><span>        </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; Names
-&gt; Names
-&gt; KernelBody GPUMem
-&gt; (KernelBody GPUMem, Extraction)
</span><a href="Futhark.Pass.ExpandAllocations.html#extractKernelBodyAllocations"><span class="hs-identifier hs-var">extractKernelBodyAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684442070"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684442071"><span class="hs-identifier hs-var">bound_outside</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684442065"><span class="hs-identifier hs-var">bound_in_kernel</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442072"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-202"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684442064"><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684442064"><span class="hs-identifier hs-var">ops'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442063"><span class="annot"><span class="annottext">[Extraction]
</span><a href="#local-6989586621684442063"><span class="hs-identifier hs-var">ops_allocs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Lambda GPUMem, Extraction)] -&gt; ([Lambda GPUMem], [Extraction])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Lambda GPUMem, Extraction)] -&gt; ([Lambda GPUMem], [Extraction]))
-&gt; [(Lambda GPUMem, Extraction)] -&gt; ([Lambda GPUMem], [Extraction])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Lambda GPUMem -&gt; (Lambda GPUMem, Extraction))
-&gt; [Lambda GPUMem] -&gt; [(Lambda GPUMem, Extraction)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; Names -&gt; Names -&gt; Lambda GPUMem -&gt; (Lambda GPUMem, Extraction)
</span><a href="Futhark.Pass.ExpandAllocations.html#extractLambdaAllocations"><span class="hs-identifier hs-var">extractLambdaAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684442070"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684442071"><span class="hs-identifier hs-var">bound_outside</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684442073"><span class="hs-identifier hs-var">ops</span></a></span><span>
</span><span id="line-203"></span><span>      </span><span id="local-6989586621684442062"><span class="annot"><span class="annottext">variantAlloc :: ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space) -&gt; Bool
</span><a href="#local-6989586621684442062"><span class="hs-identifier hs-var hs-var">variantAlloc</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684442061"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684442061"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684442061"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684442071"><span class="hs-identifier hs-var">bound_outside</span></a></span><span>
</span><span id="line-204"></span><span>      </span><span class="annot"><a href="#local-6989586621684442062"><span class="hs-identifier hs-var">variantAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-205"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684442060"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442060"><span class="hs-identifier hs-var">variant_allocs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442059"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442059"><span class="hs-identifier hs-var">invariant_allocs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-206"></span><span>        </span><span class="annot"><span class="annottext">(((SegLevel, [TPrimExp Int64 VName]), SubExp, Space) -&gt; Bool)
-&gt; Extraction -&gt; (Extraction, Extraction)
forall a k. (a -&gt; Bool) -&gt; Map k a -&gt; (Map k a, Map k a)
</span><span class="hs-identifier hs-var">M.partition</span></span><span> </span><span class="annot"><span class="annottext">((SegLevel, [TPrimExp Int64 VName]), SubExp, Space) -&gt; Bool
</span><a href="#local-6989586621684442062"><span class="hs-identifier hs-var">variantAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">(Extraction -&gt; (Extraction, Extraction))
-&gt; Extraction -&gt; (Extraction, Extraction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442067"><span class="hs-identifier hs-var">kbody_allocs</span></a></span><span> </span><span class="annot"><span class="annottext">Extraction -&gt; Extraction -&gt; Extraction
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Extraction] -&gt; Extraction
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[Extraction]
</span><a href="#local-6989586621684442063"><span class="hs-identifier hs-var">ops_allocs</span></a></span><span>
</span><span id="line-207"></span><span>      </span><span id="local-6989586621684442058"><span class="annot"><span class="annottext">badVariant :: ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space) -&gt; Bool
</span><a href="#local-6989586621684442058"><span class="hs-identifier hs-var hs-var">badVariant</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684442057"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684442057"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684442057"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684442065"><span class="hs-identifier hs-var">bound_in_kernel</span></a></span><span>
</span><span id="line-208"></span><span>      </span><span class="annot"><a href="#local-6989586621684442058"><span class="hs-identifier hs-var">badVariant</span></a></span><span> </span><span class="annot"><span class="annottext">((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(((SegLevel, [TPrimExp Int64 VName]), SubExp, Space) -&gt; Bool)
-&gt; [((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)]
-&gt; Maybe ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="annot"><span class="annottext">((SegLevel, [TPrimExp Int64 VName]), SubExp, Space) -&gt; Bool
</span><a href="#local-6989586621684442058"><span class="hs-identifier hs-var">badVariant</span></a></span><span> </span><span class="annot"><span class="annottext">([((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)]
 -&gt; Maybe ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space))
-&gt; [((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)]
-&gt; Maybe ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Extraction -&gt; [((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)]
forall k a. Map k a -&gt; [a]
</span><span class="hs-identifier hs-var">M.elems</span></span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442060"><span class="hs-identifier hs-var">variant_allocs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-211"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684442056"><span class="annot"><span class="annottext">((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)
</span><a href="#local-6989586621684442056"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-212"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; ReaderT (Scope GPUMem) (StateT VNameSource (Either String)) ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(String
 -&gt; ReaderT (Scope GPUMem) (StateT VNameSource (Either String)) ())
-&gt; String
-&gt; ReaderT (Scope GPUMem) (StateT VNameSource (Either String)) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-213"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot handle un-sliceable allocation size: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">((SegLevel, [TPrimExp Int64 VName]), SubExp, Space) -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)
</span><a href="#local-6989586621684442056"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-214"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\nLikely cause: irregular nested operations inside parallel constructs.&quot;</span></span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><span class="annottext">Maybe ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-216"></span><span>      </span><span class="annot"><span class="annottext">()
-&gt; ReaderT (Scope GPUMem) (StateT VNameSource (Either String)) ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442075"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-219"></span><span>    </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegGroup"><span class="hs-identifier hs-type">SegGroup</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><span id="line-220"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Extraction -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442060"><span class="hs-identifier hs-var">variant_allocs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-221"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; ReaderT (Scope GPUMem) (StateT VNameSource (Either String)) ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot handle invariant allocations in SegGroup.&quot;</span></span><span>
</span><span id="line-222"></span><span>    </span><span class="annot"><span class="annottext">SegLevel
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-223"></span><span>      </span><span class="annot"><span class="annottext">()
-&gt; ReaderT (Scope GPUMem) (StateT VNameSource (Either String)) ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span>  </span><span class="annot"><span class="annottext">Extraction
-&gt; Extraction
-&gt; SegLevel
-&gt; SegSpace
-&gt; KernelBody GPUMem
-&gt; (Stms GPUMem
    -&gt; KernelBody GPUMem
    -&gt; OffsetM (Stms GPUMem, ([Lambda GPUMem], KernelBody GPUMem)))
-&gt; ExpandM (Stms GPUMem, ([Lambda GPUMem], KernelBody GPUMem))
forall b.
Extraction
-&gt; Extraction
-&gt; SegLevel
-&gt; SegSpace
-&gt; KernelBody GPUMem
-&gt; (Stms GPUMem -&gt; KernelBody GPUMem -&gt; OffsetM b)
-&gt; ExpandM b
</span><a href="Futhark.Pass.ExpandAllocations.html#allocsForBody"><span class="hs-identifier hs-var">allocsForBody</span></a></span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442060"><span class="hs-identifier hs-var">variant_allocs</span></a></span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442059"><span class="hs-identifier hs-var">invariant_allocs</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442075"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442074"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442068"><span class="hs-identifier hs-var">kbody'</span></a></span><span> </span><span class="annot"><span class="annottext">((Stms GPUMem
  -&gt; KernelBody GPUMem
  -&gt; OffsetM (Stms GPUMem, ([Lambda GPUMem], KernelBody GPUMem)))
 -&gt; ExpandM (Stms GPUMem, ([Lambda GPUMem], KernelBody GPUMem)))
-&gt; (Stms GPUMem
    -&gt; KernelBody GPUMem
    -&gt; OffsetM (Stms GPUMem, ([Lambda GPUMem], KernelBody GPUMem)))
-&gt; ExpandM (Stms GPUMem, ([Lambda GPUMem], KernelBody GPUMem))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684442052"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442052"><span class="hs-identifier hs-var">alloc_stms</span></a></span></span><span> </span><span id="local-6989586621684442051"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442051"><span class="hs-identifier hs-var">kbody''</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-226"></span><span>    </span><span id="local-6989586621684442050"><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684442050"><span class="hs-identifier hs-var">ops''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Lambda GPUMem]
-&gt; (Lambda GPUMem -&gt; OffsetM (Lambda GPUMem))
-&gt; OffsetM [Lambda GPUMem]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684442064"><span class="hs-identifier hs-var">ops'</span></a></span><span> </span><span class="annot"><span class="annottext">((Lambda GPUMem -&gt; OffsetM (Lambda GPUMem))
 -&gt; OffsetM [Lambda GPUMem])
-&gt; (Lambda GPUMem -&gt; OffsetM (Lambda GPUMem))
-&gt; OffsetM [Lambda GPUMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684442048"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442048"><span class="hs-identifier hs-var">op'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-227"></span><span>      </span><span class="annot"><span class="annottext">Scope GPUMem -&gt; OffsetM (Lambda GPUMem) -&gt; OffsetM (Lambda GPUMem)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; Scope GPUMem
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442048"><span class="hs-identifier hs-var">op'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(OffsetM (Lambda GPUMem) -&gt; OffsetM (Lambda GPUMem))
-&gt; OffsetM (Lambda GPUMem) -&gt; OffsetM (Lambda GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; OffsetM (Lambda GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInLambda"><span class="hs-identifier hs-var">offsetMemoryInLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684442048"><span class="hs-identifier hs-var">op'</span></a></span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="annottext">(Stms GPUMem, ([Lambda GPUMem], KernelBody GPUMem))
-&gt; OffsetM (Stms GPUMem, ([Lambda GPUMem], KernelBody GPUMem))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442052"><span class="hs-identifier hs-var">alloc_stms</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Lambda GPUMem]
</span><a href="#local-6989586621684442050"><span class="hs-identifier hs-var">ops''</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442051"><span class="hs-identifier hs-var">kbody''</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-230"></span><span>    </span><span id="local-6989586621684442065"><span class="annot"><span class="annottext">bound_in_kernel :: Names
</span><a href="#local-6989586621684442065"><span class="hs-identifier hs-var hs-var">bound_in_kernel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-231"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName (NameInfo Any) -&gt; [VName]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">(Map VName (NameInfo Any) -&gt; [VName])
-&gt; Map VName (NameInfo Any) -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; Map VName (NameInfo Any)
forall rep. SegSpace -&gt; Scope rep
</span><a href="Futhark.IR.SegOp.html#scopeOfSegSpace"><span class="hs-identifier hs-var">scopeOfSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442074"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>        </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Names
</span><a href="Futhark.Pass.ExpandAllocations.html#boundInKernelBody"><span class="hs-identifier hs-var">boundInKernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442072"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#boundInKernelBody"><span class="hs-identifier hs-type">boundInKernelBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span>
</span><span id="line-235"></span><span id="boundInKernelBody"><span class="annot"><span class="annottext">boundInKernelBody :: KernelBody GPUMem -&gt; Names
</span><a href="Futhark.Pass.ExpandAllocations.html#boundInKernelBody"><span class="hs-identifier hs-var hs-var">boundInKernelBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#namesFromList"><span class="hs-identifier hs-var">namesFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Names)
-&gt; (KernelBody GPUMem -&gt; [VName]) -&gt; KernelBody GPUMem -&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem -&gt; [VName]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">(Scope GPUMem -&gt; [VName])
-&gt; (KernelBody GPUMem -&gt; Scope GPUMem)
-&gt; KernelBody GPUMem
-&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; Scope GPUMem
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem -&gt; Scope GPUMem)
-&gt; (KernelBody GPUMem -&gt; Stms GPUMem)
-&gt; KernelBody GPUMem
-&gt; Scope GPUMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Stms GPUMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span>
</span><span id="line-236"></span><span>
</span><span id="line-237"></span><span id="local-6989586621684443237"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#allocsForBody"><span class="hs-identifier hs-type">allocsForBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#Extraction"><span class="hs-identifier hs-type">Extraction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-239"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#Extraction"><span class="hs-identifier hs-type">Extraction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-240"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegLevel"><span class="hs-identifier hs-type">SegLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-241"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-242"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-243"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443237"><span class="hs-identifier hs-type">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-244"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#ExpandM"><span class="hs-identifier hs-type">ExpandM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443237"><span class="hs-identifier hs-type">b</span></a></span></span><span>
</span><span id="line-245"></span><span id="allocsForBody"><span class="annot"><span class="annottext">allocsForBody :: forall b.
Extraction
-&gt; Extraction
-&gt; SegLevel
-&gt; SegSpace
-&gt; KernelBody GPUMem
-&gt; (Stms GPUMem -&gt; KernelBody GPUMem -&gt; OffsetM b)
-&gt; ExpandM b
</span><a href="Futhark.Pass.ExpandAllocations.html#allocsForBody"><span class="hs-identifier hs-var hs-var">allocsForBody</span></a></span></span><span> </span><span id="local-6989586621684442037"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442037"><span class="hs-identifier hs-var">variant_allocs</span></a></span></span><span> </span><span id="local-6989586621684442036"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442036"><span class="hs-identifier hs-var">invariant_allocs</span></a></span></span><span> </span><span id="local-6989586621684442035"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442035"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684442034"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442034"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684442033"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442033"><span class="hs-identifier hs-var">kbody'</span></a></span></span><span> </span><span id="local-6989586621684442032"><span class="annot"><span class="annottext">Stms GPUMem -&gt; KernelBody GPUMem -&gt; OffsetM b
</span><a href="#local-6989586621684442032"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684442031"><span class="annot"><span class="annottext">RebaseMap
</span><a href="#local-6989586621684442031"><span class="hs-identifier hs-var">alloc_offsets</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442030"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442030"><span class="hs-identifier hs-var">alloc_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-247"></span><span>    </span><span class="annot"><span class="annottext">SegLevel
-&gt; SegSpace
-&gt; Stms GPUMem
-&gt; Extraction
-&gt; Extraction
-&gt; ExpandM (RebaseMap, Stms GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#memoryRequirements"><span class="hs-identifier hs-var">memoryRequirements</span></a></span><span>
</span><span id="line-248"></span><span>      </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442035"><span class="hs-identifier hs-var">lvl</span></a></span><span>
</span><span id="line-249"></span><span>      </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442034"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-250"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Stms GPUMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442033"><span class="hs-identifier hs-var">kbody'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>      </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442037"><span class="hs-identifier hs-var">variant_allocs</span></a></span><span>
</span><span id="line-252"></span><span>      </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442036"><span class="hs-identifier hs-var">invariant_allocs</span></a></span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span>  </span><span id="local-6989586621684442028"><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684442028"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT
  (Scope GPUMem) (StateT VNameSource (Either String)) (Scope GPUMem)
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-255"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684442027"><span class="annot"><span class="annottext">scope' :: Scope GPUMem
</span><a href="#local-6989586621684442027"><span class="hs-identifier hs-var hs-var">scope'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; Scope GPUMem
forall rep. SegSpace -&gt; Scope rep
</span><a href="Futhark.IR.SegOp.html#scopeOfSegSpace"><span class="hs-identifier hs-var">scopeOfSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442034"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem -&gt; Scope GPUMem -&gt; Scope GPUMem
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684442028"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-256"></span><span>  </span><span class="annot"><span class="annottext">(String -&gt; ExpandM b)
-&gt; (b -&gt; ExpandM b) -&gt; Either String b -&gt; ExpandM b
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ExpandM b
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; ExpandM b
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either String b -&gt; ExpandM b) -&gt; Either String b -&gt; ExpandM b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-257"></span><span>    </span><span class="annot"><span class="annottext">Scope GPUMem -&gt; RebaseMap -&gt; OffsetM b -&gt; Either String b
forall a. Scope GPUMem -&gt; RebaseMap -&gt; OffsetM a -&gt; Either String a
</span><a href="Futhark.Pass.ExpandAllocations.html#runOffsetM"><span class="hs-identifier hs-var">runOffsetM</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684442027"><span class="hs-identifier hs-var">scope'</span></a></span><span> </span><span class="annot"><span class="annottext">RebaseMap
</span><a href="#local-6989586621684442031"><span class="hs-identifier hs-var">alloc_offsets</span></a></span><span> </span><span class="annot"><span class="annottext">(OffsetM b -&gt; Either String b) -&gt; OffsetM b -&gt; Either String b
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-258"></span><span>      </span><span id="local-6989586621684442026"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442026"><span class="hs-identifier hs-var">kbody''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; OffsetM (KernelBody GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInKernelBody"><span class="hs-identifier hs-var">offsetMemoryInKernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442033"><span class="hs-identifier hs-var">kbody'</span></a></span><span>
</span><span id="line-259"></span><span>      </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; KernelBody GPUMem -&gt; OffsetM b
</span><a href="#local-6989586621684442032"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442030"><span class="hs-identifier hs-var">alloc_stms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684442026"><span class="hs-identifier hs-var">kbody''</span></a></span><span>
</span><span id="line-260"></span><span>
</span><span id="line-261"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#memoryRequirements"><span class="hs-identifier hs-type">memoryRequirements</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-262"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegLevel"><span class="hs-identifier hs-type">SegLevel</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-263"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-265"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#Extraction"><span class="hs-identifier hs-type">Extraction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-266"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#Extraction"><span class="hs-identifier hs-type">Extraction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-267"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#ExpandM"><span class="hs-identifier hs-type">ExpandM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#RebaseMap"><span class="hs-identifier hs-type">RebaseMap</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span id="memoryRequirements"><span class="annot"><span class="annottext">memoryRequirements :: SegLevel
-&gt; SegSpace
-&gt; Stms GPUMem
-&gt; Extraction
-&gt; Extraction
-&gt; ExpandM (RebaseMap, Stms GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#memoryRequirements"><span class="hs-identifier hs-var hs-var">memoryRequirements</span></a></span></span><span> </span><span id="local-6989586621684442024"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442024"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684442023"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442023"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684442022"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442022"><span class="hs-identifier hs-var">kstms</span></a></span></span><span> </span><span id="local-6989586621684442021"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442021"><span class="hs-identifier hs-var">variant_allocs</span></a></span></span><span> </span><span id="local-6989586621684442020"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442020"><span class="hs-identifier hs-var">invariant_allocs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-269"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684442019"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684442019"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442018"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442018"><span class="hs-identifier hs-var">num_threads_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-270"></span><span>    </span><span class="annot"><span class="annottext">Builder GPUMem SubExp
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (SubExp, Stms GPUMem)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilder"><span class="hs-identifier hs-var">runBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPUMem SubExp
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      (SubExp, Stms GPUMem))
-&gt; (BasicOp -&gt; Builder GPUMem SubExp)
-&gt; BasicOp
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (SubExp, Stms GPUMem)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT GPUMem (State VNameSource)))
-&gt; Builder GPUMem SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_threads&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT GPUMem -&gt; Builder GPUMem SubExp)
-&gt; (BasicOp -&gt; ExpT GPUMem) -&gt; BasicOp -&gt; Builder GPUMem SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPUMem
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      (SubExp, Stms GPUMem))
-&gt; BasicOp
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (SubExp, Stms GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-271"></span><span>      </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span>
</span><span id="line-272"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Mul"><span class="hs-identifier hs-var">Mul</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-273"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count NumGroups SubExp -&gt; SubExp
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">(Count NumGroups SubExp -&gt; SubExp)
-&gt; Count NumGroups SubExp -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegLevel -&gt; Count NumGroups SubExp
</span><a href="Futhark.IR.GPU.Op.html#segNumGroups"><span class="hs-identifier hs-var hs-var">segNumGroups</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442024"><span class="hs-identifier hs-var">lvl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Count GroupSize SubExp -&gt; SubExp
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">(Count GroupSize SubExp -&gt; SubExp)
-&gt; Count GroupSize SubExp -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegLevel -&gt; Count GroupSize SubExp
</span><a href="Futhark.IR.GPU.Op.html#segGroupSize"><span class="hs-identifier hs-var hs-var">segGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442024"><span class="hs-identifier hs-var">lvl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-275"></span><span>
</span><span id="line-276"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684442009"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442009"><span class="hs-identifier hs-var">invariant_alloc_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442008"><span class="annot"><span class="annottext">RebaseMap
</span><a href="#local-6989586621684442008"><span class="hs-identifier hs-var">invariant_alloc_offsets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-277"></span><span>    </span><span class="annot"><span class="annottext">Stms GPUMem
-&gt; ExpandM (Stms GPUMem, RebaseMap)
-&gt; ExpandM (Stms GPUMem, RebaseMap)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442018"><span class="hs-identifier hs-var">num_threads_stms</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpandM (Stms GPUMem, RebaseMap)
 -&gt; ExpandM (Stms GPUMem, RebaseMap))
-&gt; ExpandM (Stms GPUMem, RebaseMap)
-&gt; ExpandM (Stms GPUMem, RebaseMap)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-278"></span><span>      </span><span class="annot"><span class="annottext">SubExp
-&gt; Count NumGroups SubExp
-&gt; Count GroupSize SubExp
-&gt; Extraction
-&gt; ExpandM (Stms GPUMem, RebaseMap)
</span><a href="Futhark.Pass.ExpandAllocations.html#expandedInvariantAllocations"><span class="hs-identifier hs-var">expandedInvariantAllocations</span></a></span><span>
</span><span id="line-279"></span><span>        </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684442019"><span class="hs-identifier hs-var">num_threads</span></a></span><span>
</span><span id="line-280"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegLevel -&gt; Count NumGroups SubExp
</span><a href="Futhark.IR.GPU.Op.html#segNumGroups"><span class="hs-identifier hs-var hs-var">segNumGroups</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442024"><span class="hs-identifier hs-var">lvl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-281"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegLevel -&gt; Count GroupSize SubExp
</span><a href="Futhark.IR.GPU.Op.html#segGroupSize"><span class="hs-identifier hs-var hs-var">segGroupSize</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684442024"><span class="hs-identifier hs-var">lvl</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>        </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442020"><span class="hs-identifier hs-var">invariant_allocs</span></a></span><span>
</span><span id="line-283"></span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684442006"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442006"><span class="hs-identifier hs-var">variant_alloc_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684442005"><span class="annot"><span class="annottext">RebaseMap
</span><a href="#local-6989586621684442005"><span class="hs-identifier hs-var">variant_alloc_offsets</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-285"></span><span>    </span><span class="annot"><span class="annottext">Stms GPUMem
-&gt; ExpandM (Stms GPUMem, RebaseMap)
-&gt; ExpandM (Stms GPUMem, RebaseMap)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442018"><span class="hs-identifier hs-var">num_threads_stms</span></a></span><span> </span><span class="annot"><span class="annottext">(ExpandM (Stms GPUMem, RebaseMap)
 -&gt; ExpandM (Stms GPUMem, RebaseMap))
-&gt; ExpandM (Stms GPUMem, RebaseMap)
-&gt; ExpandM (Stms GPUMem, RebaseMap)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-286"></span><span>      </span><span class="annot"><span class="annottext">SubExp
-&gt; SegSpace
-&gt; Stms GPUMem
-&gt; Extraction
-&gt; ExpandM (Stms GPUMem, RebaseMap)
</span><a href="Futhark.Pass.ExpandAllocations.html#expandedVariantAllocations"><span class="hs-identifier hs-var">expandedVariantAllocations</span></a></span><span>
</span><span id="line-287"></span><span>        </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684442019"><span class="hs-identifier hs-var">num_threads</span></a></span><span>
</span><span id="line-288"></span><span>        </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684442023"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-289"></span><span>        </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442022"><span class="hs-identifier hs-var">kstms</span></a></span><span>
</span><span id="line-290"></span><span>        </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684442021"><span class="hs-identifier hs-var">variant_allocs</span></a></span><span>
</span><span id="line-291"></span><span>
</span><span id="line-292"></span><span>  </span><span class="annot"><span class="annottext">(RebaseMap, Stms GPUMem) -&gt; ExpandM (RebaseMap, Stms GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-293"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">RebaseMap
</span><a href="#local-6989586621684442008"><span class="hs-identifier hs-var">invariant_alloc_offsets</span></a></span><span> </span><span class="annot"><span class="annottext">RebaseMap -&gt; RebaseMap -&gt; RebaseMap
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">RebaseMap
</span><a href="#local-6989586621684442005"><span class="hs-identifier hs-var">variant_alloc_offsets</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-294"></span><span>      </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442018"><span class="hs-identifier hs-var">num_threads_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; Stms GPUMem -&gt; Stms GPUMem
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442009"><span class="hs-identifier hs-var">invariant_alloc_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; Stms GPUMem -&gt; Stms GPUMem
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684442006"><span class="hs-identifier hs-var">variant_alloc_stms</span></a></span><span>
</span><span id="line-295"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-comment">-- | Identifying the spot where an allocation occurs in terms of its</span><span>
</span><span id="line-298"></span><span class="hs-comment">-- level and unique thread ID.</span><span>
</span><span id="line-299"></span><span class="hs-keyword">type</span><span> </span><span id="User"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#User"><span class="hs-identifier hs-var">User</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegLevel"><span class="hs-identifier hs-type">SegLevel</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span class="hs-comment">-- | A description of allocations that have been extracted, and how</span><span>
</span><span id="line-302"></span><span class="hs-comment">-- much memory (and which space) is needed.</span><span>
</span><span id="line-303"></span><span class="hs-keyword">type</span><span> </span><span id="Extraction"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#Extraction"><span class="hs-identifier hs-var">Extraction</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#User"><span class="hs-identifier hs-type">User</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#extractKernelBodyAllocations"><span class="hs-identifier hs-type">extractKernelBodyAllocations</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-306"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#User"><span class="hs-identifier hs-type">User</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-307"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-308"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-310"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-311"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#Extraction"><span class="hs-identifier hs-type">Extraction</span></a></span><span>
</span><span id="line-312"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span id="extractKernelBodyAllocations"><span class="annot"><span class="annottext">extractKernelBodyAllocations :: (SegLevel, [TPrimExp Int64 VName])
-&gt; Names
-&gt; Names
-&gt; KernelBody GPUMem
-&gt; (KernelBody GPUMem, Extraction)
</span><a href="Futhark.Pass.ExpandAllocations.html#extractKernelBodyAllocations"><span class="hs-identifier hs-var hs-var">extractKernelBodyAllocations</span></a></span></span><span> </span><span id="local-6989586621684442002"><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684442002"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684442001"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684442001"><span class="hs-identifier hs-var">bound_outside</span></a></span></span><span> </span><span id="local-6989586621684442000"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684442000"><span class="hs-identifier hs-var">bound_kernel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-314"></span><span>  </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; Names
-&gt; Names
-&gt; (KernelBody GPUMem -&gt; Stms GPUMem)
-&gt; (Stms GPUMem -&gt; KernelBody GPUMem -&gt; KernelBody GPUMem)
-&gt; KernelBody GPUMem
-&gt; (KernelBody GPUMem, Extraction)
forall body.
(SegLevel, [TPrimExp Int64 VName])
-&gt; Names
-&gt; Names
-&gt; (body -&gt; Stms GPUMem)
-&gt; (Stms GPUMem -&gt; body -&gt; body)
-&gt; body
-&gt; (body, Extraction)
</span><a href="Futhark.Pass.ExpandAllocations.html#extractGenericBodyAllocations"><span class="hs-identifier hs-var">extractGenericBodyAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684442002"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684442001"><span class="hs-identifier hs-var">bound_outside</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684442000"><span class="hs-identifier hs-var">bound_kernel</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Stms GPUMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">((Stms GPUMem -&gt; KernelBody GPUMem -&gt; KernelBody GPUMem)
 -&gt; KernelBody GPUMem -&gt; (KernelBody GPUMem, Extraction))
-&gt; (Stms GPUMem -&gt; KernelBody GPUMem -&gt; KernelBody GPUMem)
-&gt; KernelBody GPUMem
-&gt; (KernelBody GPUMem, Extraction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-315"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621684441998"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441998"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684441997"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684441997"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684441997"><span class="hs-identifier hs-var">kbody</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">kernelBodyStms :: Stms GPUMem
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var">kernelBodyStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441998"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-316"></span><span>
</span><span id="line-317"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#extractBodyAllocations"><span class="hs-identifier hs-type">extractBodyAllocations</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-318"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#User"><span class="hs-identifier hs-type">User</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-319"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-320"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-321"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#Extraction"><span class="hs-identifier hs-type">Extraction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span id="extractBodyAllocations"><span class="annot"><span class="annottext">extractBodyAllocations :: (SegLevel, [TPrimExp Int64 VName])
-&gt; Names -&gt; Names -&gt; Body GPUMem -&gt; (Body GPUMem, Extraction)
</span><a href="Futhark.Pass.ExpandAllocations.html#extractBodyAllocations"><span class="hs-identifier hs-var hs-var">extractBodyAllocations</span></a></span></span><span> </span><span id="local-6989586621684441995"><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441995"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621684441994"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441994"><span class="hs-identifier hs-var">bound_outside</span></a></span></span><span> </span><span id="local-6989586621684441993"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441993"><span class="hs-identifier hs-var">bound_kernel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-324"></span><span>  </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; Names
-&gt; Names
-&gt; (Body GPUMem -&gt; Stms GPUMem)
-&gt; (Stms GPUMem -&gt; Body GPUMem -&gt; Body GPUMem)
-&gt; Body GPUMem
-&gt; (Body GPUMem, Extraction)
forall body.
(SegLevel, [TPrimExp Int64 VName])
-&gt; Names
-&gt; Names
-&gt; (body -&gt; Stms GPUMem)
-&gt; (Stms GPUMem -&gt; body -&gt; body)
-&gt; body
-&gt; (body, Extraction)
</span><a href="Futhark.Pass.ExpandAllocations.html#extractGenericBodyAllocations"><span class="hs-identifier hs-var">extractGenericBodyAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441995"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441994"><span class="hs-identifier hs-var">bound_outside</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441993"><span class="hs-identifier hs-var">bound_kernel</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPUMem -&gt; Stms GPUMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">((Stms GPUMem -&gt; Body GPUMem -&gt; Body GPUMem)
 -&gt; Body GPUMem -&gt; (Body GPUMem, Extraction))
-&gt; (Stms GPUMem -&gt; Body GPUMem -&gt; Body GPUMem)
-&gt; Body GPUMem
-&gt; (Body GPUMem, Extraction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-glyph">\</span><span id="local-6989586621684441992"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441992"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684441991"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441991"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441991"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">bodyStms :: Stms GPUMem
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var">bodyStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441992"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-326"></span><span>
</span><span id="line-327"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#extractLambdaAllocations"><span class="hs-identifier hs-type">extractLambdaAllocations</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-328"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#User"><span class="hs-identifier hs-type">User</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-329"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-330"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-331"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-332"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#Extraction"><span class="hs-identifier hs-type">Extraction</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-333"></span><span id="extractLambdaAllocations"><span class="annot"><span class="annottext">extractLambdaAllocations :: (SegLevel, [TPrimExp Int64 VName])
-&gt; Names -&gt; Names -&gt; Lambda GPUMem -&gt; (Lambda GPUMem, Extraction)
</span><a href="Futhark.Pass.ExpandAllocations.html#extractLambdaAllocations"><span class="hs-identifier hs-var hs-var">extractLambdaAllocations</span></a></span></span><span> </span><span id="local-6989586621684441990"><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441990"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621684441989"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441989"><span class="hs-identifier hs-var">bound_outside</span></a></span></span><span> </span><span id="local-6989586621684441988"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441988"><span class="hs-identifier hs-var">bound_kernel</span></a></span></span><span> </span><span id="local-6989586621684441987"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684441987"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684441987"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaBody :: Body GPUMem
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var">lambdaBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441985"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684441984"><span class="hs-identifier hs-var">allocs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-334"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-335"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684441985"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441985"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441984"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684441984"><span class="hs-identifier hs-var">allocs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; Names -&gt; Names -&gt; Body GPUMem -&gt; (Body GPUMem, Extraction)
</span><a href="Futhark.Pass.ExpandAllocations.html#extractBodyAllocations"><span class="hs-identifier hs-var">extractBodyAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441990"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441989"><span class="hs-identifier hs-var">bound_outside</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441988"><span class="hs-identifier hs-var">bound_kernel</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; (Body GPUMem, Extraction))
-&gt; Body GPUMem -&gt; (Body GPUMem, Extraction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684441987"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span id="local-6989586621684443220"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#extractGenericBodyAllocations"><span class="hs-identifier hs-type">extractGenericBodyAllocations</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-338"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#User"><span class="hs-identifier hs-type">User</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-339"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-340"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-341"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684443220"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684443220"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684443220"><span class="hs-identifier hs-type">body</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-343"></span><span>  </span><span class="annot"><a href="#local-6989586621684443220"><span class="hs-identifier hs-type">body</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-344"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="#local-6989586621684443220"><span class="hs-identifier hs-type">body</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-345"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#Extraction"><span class="hs-identifier hs-type">Extraction</span></a></span><span>
</span><span id="line-346"></span><span>  </span><span class="hs-special">)</span></span><span>
</span><span id="line-347"></span><span id="extractGenericBodyAllocations"><span class="annot"><span class="annottext">extractGenericBodyAllocations :: forall body.
(SegLevel, [TPrimExp Int64 VName])
-&gt; Names
-&gt; Names
-&gt; (body -&gt; Stms GPUMem)
-&gt; (Stms GPUMem -&gt; body -&gt; body)
-&gt; body
-&gt; (body, Extraction)
</span><a href="Futhark.Pass.ExpandAllocations.html#extractGenericBodyAllocations"><span class="hs-identifier hs-var hs-var">extractGenericBodyAllocations</span></a></span></span><span> </span><span id="local-6989586621684441979"><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441979"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621684441978"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441978"><span class="hs-identifier hs-var">bound_outside</span></a></span></span><span> </span><span id="local-6989586621684441977"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441977"><span class="hs-identifier hs-var">bound_kernel</span></a></span></span><span> </span><span id="local-6989586621684441976"><span class="annot"><span class="annottext">body -&gt; Stms GPUMem
</span><a href="#local-6989586621684441976"><span class="hs-identifier hs-var">get_stms</span></a></span></span><span> </span><span id="local-6989586621684441975"><span class="annot"><span class="annottext">Stms GPUMem -&gt; body -&gt; body
</span><a href="#local-6989586621684441975"><span class="hs-identifier hs-var">set_stms</span></a></span></span><span> </span><span id="local-6989586621684441974"><span class="annot"><span class="annottext">body
</span><a href="#local-6989586621684441974"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684441973"><span class="annot"><span class="annottext">bound_kernel' :: Names
</span><a href="#local-6989586621684441973"><span class="hs-identifier hs-var hs-var">bound_kernel'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441977"><span class="hs-identifier hs-var">bound_kernel</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; Names
forall rep. Stms rep -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#boundByStms"><span class="hs-identifier hs-var">boundByStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">body -&gt; Stms GPUMem
</span><a href="#local-6989586621684441976"><span class="hs-identifier hs-var">get_stms</span></a></span><span> </span><span class="annot"><span class="annottext">body
</span><a href="#local-6989586621684441974"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684441971"><span class="annot"><span class="annottext">[Stm GPUMem]
</span><a href="#local-6989586621684441971"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441970"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684441970"><span class="hs-identifier hs-var">allocs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-350"></span><span>        </span><span class="annot"><span class="annottext">Writer Extraction [Stm GPUMem] -&gt; ([Stm GPUMem], Extraction)
forall w a. Writer w a -&gt; (a, w)
</span><span class="hs-identifier hs-var">runWriter</span></span><span> </span><span class="annot"><span class="annottext">(Writer Extraction [Stm GPUMem] -&gt; ([Stm GPUMem], Extraction))
-&gt; Writer Extraction [Stm GPUMem] -&gt; ([Stm GPUMem], Extraction)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-351"></span><span>          </span><span class="annot"><span class="annottext">([Maybe (Stm GPUMem)] -&gt; [Stm GPUMem])
-&gt; WriterT Extraction Identity [Maybe (Stm GPUMem)]
-&gt; Writer Extraction [Stm GPUMem]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (Stm GPUMem)] -&gt; [Stm GPUMem]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span> </span><span class="annot"><span class="annottext">(WriterT Extraction Identity [Maybe (Stm GPUMem)]
 -&gt; Writer Extraction [Stm GPUMem])
-&gt; WriterT Extraction Identity [Maybe (Stm GPUMem)]
-&gt; Writer Extraction [Stm GPUMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-352"></span><span>            </span><span class="annot"><span class="annottext">(Stm GPUMem -&gt; WriterT Extraction Identity (Maybe (Stm GPUMem)))
-&gt; [Stm GPUMem] -&gt; WriterT Extraction Identity [Maybe (Stm GPUMem)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; Names
-&gt; Names
-&gt; Stm GPUMem
-&gt; WriterT Extraction Identity (Maybe (Stm GPUMem))
</span><a href="Futhark.Pass.ExpandAllocations.html#extractStmAllocations"><span class="hs-identifier hs-var">extractStmAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441979"><span class="hs-identifier hs-var">user</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441978"><span class="hs-identifier hs-var">bound_outside</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441973"><span class="hs-identifier hs-var">bound_kernel'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Stm GPUMem] -&gt; WriterT Extraction Identity [Maybe (Stm GPUMem)])
-&gt; [Stm GPUMem] -&gt; WriterT Extraction Identity [Maybe (Stm GPUMem)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-353"></span><span>              </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; [Stm GPUMem]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem -&gt; [Stm GPUMem]) -&gt; Stms GPUMem -&gt; [Stm GPUMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">body -&gt; Stms GPUMem
</span><a href="#local-6989586621684441976"><span class="hs-identifier hs-var">get_stms</span></a></span><span> </span><span class="annot"><span class="annottext">body
</span><a href="#local-6989586621684441974"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-354"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPUMem -&gt; body -&gt; body
</span><a href="#local-6989586621684441975"><span class="hs-identifier hs-var">set_stms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stm GPUMem] -&gt; Stms GPUMem
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm GPUMem]
</span><a href="#local-6989586621684441971"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">body
</span><a href="#local-6989586621684441974"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684441970"><span class="hs-identifier hs-var">allocs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-355"></span><span>
</span><span id="line-356"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#expandable"><span class="hs-identifier hs-type">expandable</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#notScalar"><span class="hs-identifier hs-type">notScalar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-357"></span><span id="expandable"><span class="annot"><span class="annottext">expandable :: Space -&gt; Bool
</span><a href="Futhark.Pass.ExpandAllocations.html#expandable"><span class="hs-identifier hs-var hs-var">expandable</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-358"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#expandable"><span class="hs-identifier hs-var">expandable</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ScalarSpace"><span class="hs-identifier hs-type">ScalarSpace</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-359"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#expandable"><span class="hs-identifier hs-var">expandable</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-360"></span><span id="notScalar"><span class="annot"><span class="annottext">notScalar :: Space -&gt; Bool
</span><a href="Futhark.Pass.ExpandAllocations.html#notScalar"><span class="hs-identifier hs-var hs-var">notScalar</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ScalarSpace"><span class="hs-identifier hs-type">ScalarSpace</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-361"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#notScalar"><span class="hs-identifier hs-var">notScalar</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-362"></span><span>
</span><span id="line-363"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#extractStmAllocations"><span class="hs-identifier hs-type">extractStmAllocations</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-364"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#User"><span class="hs-identifier hs-type">User</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-365"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-366"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-367"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-368"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Writer</span></span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#Extraction"><span class="hs-identifier hs-type">Extraction</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span id="extractStmAllocations"><span class="annot"><span class="annottext">extractStmAllocations :: (SegLevel, [TPrimExp Int64 VName])
-&gt; Names
-&gt; Names
-&gt; Stm GPUMem
-&gt; WriterT Extraction Identity (Maybe (Stm GPUMem))
</span><a href="Futhark.Pass.ExpandAllocations.html#extractStmAllocations"><span class="hs-identifier hs-var hs-var">extractStmAllocations</span></a></span></span><span> </span><span id="local-6989586621684441962"><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441962"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621684441961"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441961"><span class="hs-identifier hs-var">bound_outside</span></a></span></span><span> </span><span id="local-6989586621684441960"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441960"><span class="hs-identifier hs-var">bound_kernel</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684441959"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684441959"><span class="hs-identifier hs-var">patElem</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span id="local-6989586621684441957"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441957"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span id="local-6989586621684441956"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684441956"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-370"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Space -&gt; Bool
</span><a href="Futhark.Pass.ExpandAllocations.html#expandable"><span class="hs-identifier hs-var">expandable</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684441956"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="#local-6989586621684441954"><span class="hs-identifier hs-var">expandableSize</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441957"><span class="hs-identifier hs-var">size</span></a></span><span>
</span><span id="line-371"></span><span>      </span><span class="hs-comment">-- FIXME: the '&amp;&amp; notScalar space' part is a hack because we</span><span>
</span><span id="line-372"></span><span>      </span><span class="hs-comment">-- don't otherwise hoist the sizes out far enough, and we</span><span>
</span><span id="line-373"></span><span>      </span><span class="hs-comment">-- promise to be super-duper-careful about not having variant</span><span>
</span><span id="line-374"></span><span>      </span><span class="hs-comment">-- scalar allocations.</span><span>
</span><span id="line-375"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Bool
</span><a href="#local-6989586621684441952"><span class="hs-identifier hs-var">boundInKernel</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441957"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; Bool
</span><a href="Futhark.Pass.ExpandAllocations.html#notScalar"><span class="hs-identifier hs-var">notScalar</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684441956"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-376"></span><span>    </span><span class="annot"><span class="annottext">Extraction -&gt; WriterT Extraction Identity ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">(Extraction -&gt; WriterT Extraction Identity ())
-&gt; Extraction -&gt; WriterT Extraction Identity ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space)
-&gt; Extraction
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441959"><span class="hs-identifier hs-var">patElem</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441962"><span class="hs-identifier hs-var">user</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441957"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684441956"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Stm GPUMem)
-&gt; WriterT Extraction Identity (Maybe (Stm GPUMem))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Stm GPUMem)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-378"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-379"></span><span>    </span><span id="local-6989586621684441954"><span class="annot"><span class="annottext">expandableSize :: SubExp -&gt; Bool
</span><a href="#local-6989586621684441954"><span class="hs-identifier hs-var hs-var">expandableSize</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684441948"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441948"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441948"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441961"><span class="hs-identifier hs-var">bound_outside</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441948"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441960"><span class="hs-identifier hs-var">bound_kernel</span></a></span><span>
</span><span id="line-380"></span><span>    </span><span class="annot"><a href="#local-6989586621684441954"><span class="hs-identifier hs-var">expandableSize</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-381"></span><span>    </span><span id="local-6989586621684441952"><span class="annot"><span class="annottext">boundInKernel :: SubExp -&gt; Bool
</span><a href="#local-6989586621684441952"><span class="hs-identifier hs-var hs-var">boundInKernel</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684441946"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441946"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441946"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441960"><span class="hs-identifier hs-var">bound_kernel</span></a></span><span>
</span><span id="line-382"></span><span>    </span><span class="annot"><a href="#local-6989586621684441952"><span class="hs-identifier hs-var">boundInKernel</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-383"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#extractStmAllocations"><span class="hs-identifier hs-var">extractStmAllocations</span></a></span><span> </span><span id="local-6989586621684441945"><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441945"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span id="local-6989586621684441944"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441944"><span class="hs-identifier hs-var">bound_outside</span></a></span></span><span> </span><span id="local-6989586621684441943"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441943"><span class="hs-identifier hs-var">bound_kernel</span></a></span></span><span> </span><span id="local-6989586621684441942"><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684441942"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-384"></span><span>  </span><span id="local-6989586621684441941"><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684441941"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Mapper GPUMem GPUMem (WriterT Extraction Identity)
-&gt; ExpT GPUMem -&gt; WriterT Extraction Identity (ExpT GPUMem)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
Mapper frep trep m -&gt; Exp frep -&gt; m (Exp trep)
</span><a href="Futhark.IR.Traversals.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; Mapper GPUMem GPUMem (WriterT Extraction Identity)
</span><a href="#local-6989586621684441940"><span class="hs-identifier hs-var">expMapper</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441945"><span class="hs-identifier hs-var">user</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExpT GPUMem -&gt; WriterT Extraction Identity (ExpT GPUMem))
-&gt; ExpT GPUMem -&gt; WriterT Extraction Identity (ExpT GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; ExpT GPUMem
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684441942"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-385"></span><span>  </span><span class="annot"><span class="annottext">Maybe (Stm GPUMem)
-&gt; WriterT Extraction Identity (Maybe (Stm GPUMem))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (Stm GPUMem)
 -&gt; WriterT Extraction Identity (Maybe (Stm GPUMem)))
-&gt; Maybe (Stm GPUMem)
-&gt; WriterT Extraction Identity (Maybe (Stm GPUMem))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; Maybe (Stm GPUMem)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Stm GPUMem -&gt; Maybe (Stm GPUMem))
-&gt; Stm GPUMem -&gt; Maybe (Stm GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684441942"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">stmExp :: ExpT GPUMem
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var">stmExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684441941"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-386"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-387"></span><span>    </span><span id="local-6989586621684441940"><span class="annot"><span class="annottext">expMapper :: (SegLevel, [TPrimExp Int64 VName])
-&gt; Mapper GPUMem GPUMem (WriterT Extraction Identity)
</span><a href="#local-6989586621684441940"><span class="hs-identifier hs-var hs-var">expMapper</span></a></span></span><span> </span><span id="local-6989586621684441938"><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441938"><span class="hs-identifier hs-var">user'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-388"></span><span>      </span><span class="annot"><span class="annottext">Mapper GPUMem GPUMem (WriterT Extraction Identity)
forall (m :: * -&gt; *) rep. Monad m =&gt; Mapper rep rep m
</span><a href="Futhark.IR.Traversals.html#identityMapper"><span class="hs-identifier hs-var">identityMapper</span></a></span><span>
</span><span id="line-389"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnBody :: Scope GPUMem
-&gt; Body GPUMem -&gt; WriterT Extraction Identity (Body GPUMem)
</span><a href="Futhark.IR.Traversals.html#mapOnBody"><span class="hs-identifier hs-var">mapOnBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; WriterT Extraction Identity (Body GPUMem))
-&gt; Scope GPUMem
-&gt; Body GPUMem
-&gt; WriterT Extraction Identity (Body GPUMem)
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">((Body GPUMem -&gt; WriterT Extraction Identity (Body GPUMem))
 -&gt; Scope GPUMem
 -&gt; Body GPUMem
 -&gt; WriterT Extraction Identity (Body GPUMem))
-&gt; (Body GPUMem -&gt; WriterT Extraction Identity (Body GPUMem))
-&gt; Scope GPUMem
-&gt; Body GPUMem
-&gt; WriterT Extraction Identity (Body GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; Body GPUMem -&gt; WriterT Extraction Identity (Body GPUMem)
</span><a href="#local-6989586621684441937"><span class="hs-identifier hs-var">onBody</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441938"><span class="hs-identifier hs-var">user'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-390"></span><span>          </span><span class="annot"><span class="annottext">mapOnOp :: Op GPUMem -&gt; WriterT Extraction Identity (Op GPUMem)
</span><a href="Futhark.IR.Traversals.html#mapOnOp"><span class="hs-identifier hs-var">mapOnOp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; MemOp (HostOp GPUMem ())
-&gt; WriterT Extraction Identity (MemOp (HostOp GPUMem ()))
</span><a href="#local-6989586621684441935"><span class="hs-identifier hs-var">onOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441938"><span class="hs-identifier hs-var">user'</span></a></span><span>
</span><span id="line-391"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-392"></span><span>
</span><span id="line-393"></span><span>    </span><span id="local-6989586621684441937"><span class="annot"><span class="annottext">onBody :: (SegLevel, [TPrimExp Int64 VName])
-&gt; Body GPUMem -&gt; WriterT Extraction Identity (Body GPUMem)
</span><a href="#local-6989586621684441937"><span class="hs-identifier hs-var hs-var">onBody</span></a></span></span><span> </span><span id="local-6989586621684441934"><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441934"><span class="hs-identifier hs-var">user'</span></a></span></span><span> </span><span id="local-6989586621684441933"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441933"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-394"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441932"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441932"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441931"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684441931"><span class="hs-identifier hs-var">allocs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; Names -&gt; Names -&gt; Body GPUMem -&gt; (Body GPUMem, Extraction)
</span><a href="Futhark.Pass.ExpandAllocations.html#extractBodyAllocations"><span class="hs-identifier hs-var">extractBodyAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441934"><span class="hs-identifier hs-var">user'</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441944"><span class="hs-identifier hs-var">bound_outside</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441943"><span class="hs-identifier hs-var">bound_kernel</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441933"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-395"></span><span>      </span><span class="annot"><span class="annottext">Extraction -&gt; WriterT Extraction Identity ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684441931"><span class="hs-identifier hs-var">allocs</span></a></span><span>
</span><span id="line-396"></span><span>      </span><span class="annot"><span class="annottext">Body GPUMem -&gt; WriterT Extraction Identity (Body GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441932"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-397"></span><span>
</span><span id="line-398"></span><span>    </span><span id="local-6989586621684441935"><span class="annot"><span class="annottext">onOp :: (SegLevel, [TPrimExp Int64 VName])
-&gt; MemOp (HostOp GPUMem ())
-&gt; WriterT Extraction Identity (MemOp (HostOp GPUMem ()))
</span><a href="#local-6989586621684441935"><span class="hs-identifier hs-var hs-var">onOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegLevel
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441930"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441930"><span class="hs-identifier hs-var">user_ids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span id="local-6989586621684441929"><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684441929"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-399"></span><span>      </span><span class="annot"><span class="annottext">HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ())
forall inner. inner -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp GPUMem () -&gt; MemOp (HostOp GPUMem ()))
-&gt; (SegOp SegLevel GPUMem -&gt; HostOp GPUMem ())
-&gt; SegOp SegLevel GPUMem
-&gt; MemOp (HostOp GPUMem ())
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem -&gt; HostOp GPUMem ()
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp SegLevel GPUMem -&gt; MemOp (HostOp GPUMem ()))
-&gt; WriterT Extraction Identity (SegOp SegLevel GPUMem)
-&gt; WriterT Extraction Identity (MemOp (HostOp GPUMem ()))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SegOpMapper SegLevel GPUMem GPUMem (WriterT Extraction Identity)
-&gt; SegOp SegLevel GPUMem
-&gt; WriterT Extraction Identity (SegOp SegLevel GPUMem)
forall (m :: * -&gt; *) lvl frep trep.
(Applicative m, Monad m) =&gt;
SegOpMapper lvl frep trep m -&gt; SegOp lvl frep -&gt; m (SegOp lvl trep)
</span><a href="Futhark.IR.SegOp.html#mapSegOpM"><span class="hs-identifier hs-var">mapSegOpM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; SegOpMapper SegLevel GPUMem GPUMem (WriterT Extraction Identity)
</span><a href="#local-6989586621684441927"><span class="hs-identifier hs-var">opMapper</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441926"><span class="hs-identifier hs-var">user''</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684441929"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-400"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-401"></span><span>        </span><span id="local-6989586621684441926"><span class="annot"><span class="annottext">user'' :: (SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441926"><span class="hs-identifier hs-var hs-var">user''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-402"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem -&gt; SegLevel
forall lvl rep. SegOp lvl rep -&gt; lvl
</span><a href="Futhark.IR.SegOp.html#segLevel"><span class="hs-identifier hs-var">segLevel</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684441929"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441930"><span class="hs-identifier hs-var">user_ids</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">le64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem -&gt; SegSpace
forall lvl rep. SegOp lvl rep -&gt; SegSpace
</span><a href="Futhark.IR.SegOp.html#segSpace"><span class="hs-identifier hs-var">segSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684441929"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-403"></span><span>    </span><span class="annot"><a href="#local-6989586621684441935"><span class="hs-identifier hs-var">onOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684441923"><span class="annot"><span class="annottext">MemOp (HostOp GPUMem ())
</span><a href="#local-6989586621684441923"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemOp (HostOp GPUMem ())
-&gt; WriterT Extraction Identity (MemOp (HostOp GPUMem ()))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">MemOp (HostOp GPUMem ())
</span><a href="#local-6989586621684441923"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-404"></span><span>
</span><span id="line-405"></span><span>    </span><span id="local-6989586621684441927"><span class="annot"><span class="annottext">opMapper :: (SegLevel, [TPrimExp Int64 VName])
-&gt; SegOpMapper SegLevel GPUMem GPUMem (WriterT Extraction Identity)
</span><a href="#local-6989586621684441927"><span class="hs-identifier hs-var hs-var">opMapper</span></a></span></span><span> </span><span id="local-6989586621684441922"><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441922"><span class="hs-identifier hs-var">user'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-406"></span><span>      </span><span class="annot"><span class="annottext">SegOpMapper SegLevel Any Any (WriterT Extraction Identity)
forall (m :: * -&gt; *) lvl rep. Monad m =&gt; SegOpMapper lvl rep rep m
</span><a href="Futhark.IR.SegOp.html#identitySegOpMapper"><span class="hs-identifier hs-var">identitySegOpMapper</span></a></span><span>
</span><span id="line-407"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnSegOpLambda :: Lambda GPUMem -&gt; WriterT Extraction Identity (Lambda GPUMem)
</span><a href="Futhark.IR.SegOp.html#mapOnSegOpLambda"><span class="hs-identifier hs-var">mapOnSegOpLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; Lambda GPUMem -&gt; WriterT Extraction Identity (Lambda GPUMem)
</span><a href="#local-6989586621684441919"><span class="hs-identifier hs-var">onLambda</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441922"><span class="hs-identifier hs-var">user'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-408"></span><span>          </span><span class="annot"><span class="annottext">mapOnSegOpBody :: KernelBody GPUMem
-&gt; WriterT Extraction Identity (KernelBody GPUMem)
</span><a href="Futhark.IR.SegOp.html#mapOnSegOpBody"><span class="hs-identifier hs-var">mapOnSegOpBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; KernelBody GPUMem
-&gt; WriterT Extraction Identity (KernelBody GPUMem)
</span><a href="#local-6989586621684441917"><span class="hs-identifier hs-var">onKernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441922"><span class="hs-identifier hs-var">user'</span></a></span><span>
</span><span id="line-409"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span>    </span><span id="local-6989586621684441917"><span class="annot"><span class="annottext">onKernelBody :: (SegLevel, [TPrimExp Int64 VName])
-&gt; KernelBody GPUMem
-&gt; WriterT Extraction Identity (KernelBody GPUMem)
</span><a href="#local-6989586621684441917"><span class="hs-identifier hs-var hs-var">onKernelBody</span></a></span></span><span> </span><span id="local-6989586621684441916"><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441916"><span class="hs-identifier hs-var">user'</span></a></span></span><span> </span><span id="local-6989586621684441915"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684441915"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-412"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441914"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684441914"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441913"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684441913"><span class="hs-identifier hs-var">allocs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; Names
-&gt; Names
-&gt; KernelBody GPUMem
-&gt; (KernelBody GPUMem, Extraction)
</span><a href="Futhark.Pass.ExpandAllocations.html#extractKernelBodyAllocations"><span class="hs-identifier hs-var">extractKernelBodyAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441916"><span class="hs-identifier hs-var">user'</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441944"><span class="hs-identifier hs-var">bound_outside</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684441943"><span class="hs-identifier hs-var">bound_kernel</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684441915"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-413"></span><span>      </span><span class="annot"><span class="annottext">Extraction -&gt; WriterT Extraction Identity ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684441913"><span class="hs-identifier hs-var">allocs</span></a></span><span>
</span><span id="line-414"></span><span>      </span><span class="annot"><span class="annottext">KernelBody GPUMem
-&gt; WriterT Extraction Identity (KernelBody GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684441914"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span>    </span><span id="local-6989586621684441919"><span class="annot"><span class="annottext">onLambda :: (SegLevel, [TPrimExp Int64 VName])
-&gt; Lambda GPUMem -&gt; WriterT Extraction Identity (Lambda GPUMem)
</span><a href="#local-6989586621684441919"><span class="hs-identifier hs-var hs-var">onLambda</span></a></span></span><span> </span><span id="local-6989586621684441912"><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441912"><span class="hs-identifier hs-var">user'</span></a></span></span><span> </span><span id="local-6989586621684441911"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684441911"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-417"></span><span>      </span><span id="local-6989586621684441910"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441910"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; Body GPUMem -&gt; WriterT Extraction Identity (Body GPUMem)
</span><a href="#local-6989586621684441937"><span class="hs-identifier hs-var">onBody</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441912"><span class="hs-identifier hs-var">user'</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; WriterT Extraction Identity (Body GPUMem))
-&gt; Body GPUMem -&gt; WriterT Extraction Identity (Body GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684441911"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-418"></span><span>      </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; WriterT Extraction Identity (Lambda GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684441911"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaBody :: Body GPUMem
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var">lambdaBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441910"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-419"></span><span>
</span><span id="line-420"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#genericExpandedInvariantAllocations"><span class="hs-identifier hs-type">genericExpandedInvariantAllocations</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-421"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#User"><span class="hs-identifier hs-type">User</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#Extraction"><span class="hs-identifier hs-type">Extraction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#ExpandM"><span class="hs-identifier hs-type">ExpandM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#RebaseMap"><span class="hs-identifier hs-type">RebaseMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span id="genericExpandedInvariantAllocations"><span class="annot"><span class="annottext">genericExpandedInvariantAllocations :: ((SegLevel, [TPrimExp Int64 VName])
 -&gt; (ShapeBase SubExp, [TPrimExp Int64 VName]))
-&gt; Extraction -&gt; ExpandM (Stms GPUMem, RebaseMap)
</span><a href="Futhark.Pass.ExpandAllocations.html#genericExpandedInvariantAllocations"><span class="hs-identifier hs-var hs-var">genericExpandedInvariantAllocations</span></a></span></span><span> </span><span id="local-6989586621684441908"><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; (ShapeBase SubExp, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441908"><span class="hs-identifier hs-var">getNumUsers</span></a></span></span><span> </span><span id="local-6989586621684441907"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684441907"><span class="hs-identifier hs-var">invariant_allocs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-423"></span><span>  </span><span class="hs-comment">-- We expand the invariant allocations by adding an inner dimension</span><span>
</span><span id="line-424"></span><span>  </span><span class="hs-comment">-- equal to the number of kernel threads.</span><span>
</span><span id="line-425"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684441906"><span class="annot"><span class="annottext">[RebaseMap]
</span><a href="#local-6989586621684441906"><span class="hs-identifier hs-var">rebases</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441905"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441905"><span class="hs-identifier hs-var">alloc_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Builder GPUMem [RebaseMap]
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     ([RebaseMap], Stms GPUMem)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilder"><span class="hs-identifier hs-var">runBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder GPUMem [RebaseMap]
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      ([RebaseMap], Stms GPUMem))
-&gt; Builder GPUMem [RebaseMap]
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     ([RebaseMap], Stms GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((VName, ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space))
 -&gt; BuilderT GPUMem (State VNameSource) RebaseMap)
-&gt; [(VName, ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space))]
-&gt; Builder GPUMem [RebaseMap]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(VName, ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space))
-&gt; BuilderT GPUMem (State VNameSource) RebaseMap
</span><a href="#local-6989586621684441904"><span class="hs-identifier hs-var">expand</span></a></span><span> </span><span class="annot"><span class="annottext">([(VName, ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space))]
 -&gt; Builder GPUMem [RebaseMap])
-&gt; [(VName, ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space))]
-&gt; Builder GPUMem [RebaseMap]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Extraction
-&gt; [(VName, ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space))]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684441907"><span class="hs-identifier hs-var">invariant_allocs</span></a></span><span>
</span><span id="line-426"></span><span>
</span><span id="line-427"></span><span>  </span><span class="annot"><span class="annottext">(Stms GPUMem, RebaseMap) -&gt; ExpandM (Stms GPUMem, RebaseMap)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441905"><span class="hs-identifier hs-var">alloc_stms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[RebaseMap] -&gt; RebaseMap
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[RebaseMap]
</span><a href="#local-6989586621684441906"><span class="hs-identifier hs-var">rebases</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-428"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-429"></span><span>    </span><span id="local-6989586621684441904"><span class="annot"><span class="annottext">expand :: (VName, ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space))
-&gt; BuilderT GPUMem (State VNameSource) RebaseMap
</span><a href="#local-6989586621684441904"><span class="hs-identifier hs-var hs-var">expand</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441902"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441902"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441901"><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441901"><span class="hs-identifier hs-var">user</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441900"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441900"><span class="hs-identifier hs-var">per_thread_size</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441899"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684441899"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-430"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684441898"><span class="annot"><span class="annottext">num_users :: ShapeBase SubExp
</span><a href="#local-6989586621684441898"><span class="hs-identifier hs-var hs-var">num_users</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ShapeBase SubExp, [TPrimExp Int64 VName]) -&gt; ShapeBase SubExp
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((ShapeBase SubExp, [TPrimExp Int64 VName]) -&gt; ShapeBase SubExp)
-&gt; (ShapeBase SubExp, [TPrimExp Int64 VName]) -&gt; ShapeBase SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; (ShapeBase SubExp, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441908"><span class="hs-identifier hs-var">getNumUsers</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441901"><span class="hs-identifier hs-var">user</span></a></span><span>
</span><span id="line-431"></span><span>          </span><span id="local-6989586621684441897"><span class="annot"><span class="annottext">allocpat :: PatT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441897"><span class="hs-identifier hs-var hs-var">allocpat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatElemT (MemInfo SubExp NoUniqueness MemBind)]
-&gt; PatT (MemInfo SubExp NoUniqueness MemBind)
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
-&gt; MemInfo SubExp NoUniqueness MemBind
-&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind)
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441902"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">(MemInfo SubExp NoUniqueness MemBind
 -&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind))
-&gt; MemInfo SubExp NoUniqueness MemBind
-&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; MemInfo SubExp NoUniqueness MemBind
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684441899"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-432"></span><span>      </span><span id="local-6989586621684441894"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441894"><span class="hs-identifier hs-var">total_size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-433"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT GPUMem (State VNameSource)))
-&gt; BuilderT GPUMem (State VNameSource) VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;total_size&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT GPUMem -&gt; BuilderT GPUMem (State VNameSource) VName)
-&gt; ([TPrimExp Int64 VName]
    -&gt; BuilderT GPUMem (State VNameSource) (ExpT GPUMem))
-&gt; [TPrimExp Int64 VName]
-&gt; BuilderT GPUMem (State VNameSource) VName
forall (m :: * -&gt; *) b c a.
Monad m =&gt;
(b -&gt; m c) -&gt; (a -&gt; m b) -&gt; a -&gt; m c
</span><span class="hs-operator hs-var">&lt;=&lt;</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; BuilderT GPUMem (State VNameSource) (ExpT GPUMem)
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; BuilderT GPUMem (State VNameSource) (ExpT GPUMem))
-&gt; ([TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName)
-&gt; [TPrimExp Int64 VName]
-&gt; BuilderT GPUMem (State VNameSource) (ExpT GPUMem)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; TPrimExp Int64 VName
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName]
 -&gt; BuilderT GPUMem (State VNameSource) VName)
-&gt; [TPrimExp Int64 VName]
-&gt; BuilderT GPUMem (State VNameSource) VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-434"></span><span>          </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441900"><span class="hs-identifier hs-var">per_thread_size</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeBase SubExp -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684441898"><span class="hs-identifier hs-var">num_users</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-435"></span><span>      </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT GPUMem (State VNameSource)))
-&gt; Exp (Rep (BuilderT GPUMem (State VNameSource)))
-&gt; BuilderT GPUMem (State VNameSource) ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Pat (Rep m) -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBind"><span class="hs-identifier hs-var">letBind</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT GPUMem (State VNameSource)))
PatT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441897"><span class="hs-identifier hs-var">allocpat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT GPUMem (State VNameSource)))
 -&gt; BuilderT GPUMem (State VNameSource) ())
-&gt; Exp (Rep (BuilderT GPUMem (State VNameSource)))
-&gt; BuilderT GPUMem (State VNameSource) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op GPUMem -&gt; ExpT GPUMem
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op GPUMem -&gt; ExpT GPUMem) -&gt; Op GPUMem -&gt; ExpT GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Space -&gt; MemOp (HostOp GPUMem ())
forall inner. SubExp -&gt; Space -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-var">Alloc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441894"><span class="hs-identifier hs-var">total_size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684441899"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-436"></span><span>      </span><span class="annot"><span class="annottext">RebaseMap -&gt; BuilderT GPUMem (State VNameSource) RebaseMap
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(RebaseMap -&gt; BuilderT GPUMem (State VNameSource) RebaseMap)
-&gt; RebaseMap -&gt; BuilderT GPUMem (State VNameSource) RebaseMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; (([TPrimExp Int64 VName], PrimType)
    -&gt; IxFun (TPrimExp Int64 VName))
-&gt; RebaseMap
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441902"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">((([TPrimExp Int64 VName], PrimType)
  -&gt; IxFun (TPrimExp Int64 VName))
 -&gt; RebaseMap)
-&gt; (([TPrimExp Int64 VName], PrimType)
    -&gt; IxFun (TPrimExp Int64 VName))
-&gt; RebaseMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; ([TPrimExp Int64 VName], PrimType)
-&gt; IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441886"><span class="hs-identifier hs-var">newBase</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441901"><span class="hs-identifier hs-var">user</span></a></span><span>
</span><span id="line-437"></span><span>
</span><span id="line-438"></span><span>    </span><span id="local-6989586621684441882"><span class="annot"><span class="annottext">untouched :: d -&gt; DimIndex d
</span><a href="#local-6989586621684441882"><span class="hs-identifier hs-var hs-var">untouched</span></a></span></span><span> </span><span id="local-6989586621684441881"><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684441881"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">d -&gt; d -&gt; d -&gt; DimIndex d
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">d
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">d
</span><a href="#local-6989586621684441881"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">d
</span><span class="hs-number">1</span></span><span>
</span><span id="line-439"></span><span>
</span><span id="line-440"></span><span>    </span><span id="local-6989586621684441886"><span class="annot"><span class="annottext">newBase :: (SegLevel, [TPrimExp Int64 VName])
-&gt; ([TPrimExp Int64 VName], PrimType)
-&gt; IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441886"><span class="hs-identifier hs-var hs-var">newBase</span></a></span></span><span> </span><span id="local-6989586621684441879"><span class="annot"><span class="annottext">user :: (SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441879"><span class="hs-identifier hs-var">user</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegThread"><span class="hs-identifier hs-type">SegThread</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441878"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441878"><span class="hs-identifier hs-var">old_shape</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-441"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441877"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684441877"><span class="hs-identifier hs-var">users_shape</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441876"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441876"><span class="hs-identifier hs-var">user_ids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; (ShapeBase SubExp, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441908"><span class="hs-identifier hs-var">getNumUsers</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441879"><span class="hs-identifier hs-var">user</span></a></span><span>
</span><span id="line-442"></span><span>          </span><span id="local-6989586621684441875"><span class="annot"><span class="annottext">num_dims :: Int
</span><a href="#local-6989586621684441875"><span class="hs-identifier hs-var hs-var">num_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441878"><span class="hs-identifier hs-var">old_shape</span></a></span><span>
</span><span id="line-443"></span><span>          </span><span id="local-6989586621684441873"><span class="annot"><span class="annottext">perm :: [Int]
</span><a href="#local-6989586621684441873"><span class="hs-identifier hs-var hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684441875"><span class="hs-identifier hs-var">num_dims</span></a></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684441875"><span class="hs-identifier hs-var">num_dims</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp -&gt; Int
forall a. ArrayShape a =&gt; a -&gt; Int
</span><a href="Futhark.IR.Syntax.Core.html#shapeRank"><span class="hs-identifier hs-var">shapeRank</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684441877"><span class="hs-identifier hs-var">users_shape</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [Int] -&gt; [Int]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684441875"><span class="hs-identifier hs-var">num_dims</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-444"></span><span>          </span><span id="local-6989586621684441871"><span class="annot"><span class="annottext">root_ixfun :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441871"><span class="hs-identifier hs-var hs-var">root_ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; IxFun (TPrimExp Int64 VName)
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441878"><span class="hs-identifier hs-var">old_shape</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeBase SubExp -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684441877"><span class="hs-identifier hs-var">users_shape</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span>          </span><span id="local-6989586621684441869"><span class="annot"><span class="annottext">permuted_ixfun :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441869"><span class="hs-identifier hs-var hs-var">permuted_ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
-&gt; [Int] -&gt; IxFun (TPrimExp Int64 VName)
forall num. IntegralExp num =&gt; IxFun num -&gt; [Int] -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#permute"><span class="hs-identifier hs-var">IxFun.permute</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441871"><span class="hs-identifier hs-var">root_ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684441873"><span class="hs-identifier hs-var">perm</span></a></span><span>
</span><span id="line-446"></span><span>          </span><span id="local-6989586621684441867"><span class="annot"><span class="annottext">offset_ixfun :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441867"><span class="hs-identifier hs-var hs-var">offset_ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-447"></span><span>            </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
-&gt; Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; Slice num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#slice"><span class="hs-identifier hs-var">IxFun.slice</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441869"><span class="hs-identifier hs-var">permuted_ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName))
-&gt; Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-448"></span><span>              </span><span class="annot"><span class="annottext">[DimIndex (TPrimExp Int64 VName)] -&gt; Slice (TPrimExp Int64 VName)
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex (TPrimExp Int64 VName)] -&gt; Slice (TPrimExp Int64 VName))
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; Slice (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName))
-&gt; [TPrimExp Int64 VName] -&gt; [DimIndex (TPrimExp Int64 VName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441876"><span class="hs-identifier hs-var">user_ids</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TPrimExp Int64 VName)]
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; [DimIndex (TPrimExp Int64 VName)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName))
-&gt; [TPrimExp Int64 VName] -&gt; [DimIndex (TPrimExp Int64 VName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall {d}. Num d =&gt; d -&gt; DimIndex d
</span><a href="#local-6989586621684441882"><span class="hs-identifier hs-var">untouched</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441878"><span class="hs-identifier hs-var">old_shape</span></a></span><span>
</span><span id="line-449"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441867"><span class="hs-identifier hs-var">offset_ixfun</span></a></span><span>
</span><span id="line-450"></span><span>    </span><span class="annot"><a href="#local-6989586621684441886"><span class="hs-identifier hs-var">newBase</span></a></span><span> </span><span id="local-6989586621684441863"><span class="annot"><span class="annottext">user :: (SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441863"><span class="hs-identifier hs-var">user</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegGroup"><span class="hs-identifier hs-type">SegGroup</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441862"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441862"><span class="hs-identifier hs-var">old_shape</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-451"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441861"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684441861"><span class="hs-identifier hs-var">users_shape</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441860"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441860"><span class="hs-identifier hs-var">user_ids</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; (ShapeBase SubExp, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441908"><span class="hs-identifier hs-var">getNumUsers</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441863"><span class="hs-identifier hs-var">user</span></a></span><span>
</span><span id="line-452"></span><span>          </span><span id="local-6989586621684441859"><span class="annot"><span class="annottext">root_ixfun :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441859"><span class="hs-identifier hs-var hs-var">root_ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; IxFun (TPrimExp Int64 VName)
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName] -&gt; IxFun (TPrimExp Int64 VName))
-&gt; [TPrimExp Int64 VName] -&gt; IxFun (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeBase SubExp -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684441861"><span class="hs-identifier hs-var">users_shape</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; [TPrimExp Int64 VName] -&gt; [TPrimExp Int64 VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441862"><span class="hs-identifier hs-var">old_shape</span></a></span><span>
</span><span id="line-453"></span><span>          </span><span id="local-6989586621684441858"><span class="annot"><span class="annottext">offset_ixfun :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441858"><span class="hs-identifier hs-var hs-var">offset_ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-454"></span><span>            </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
-&gt; Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; Slice num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#slice"><span class="hs-identifier hs-var">IxFun.slice</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441859"><span class="hs-identifier hs-var">root_ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName))
-&gt; ([DimIndex (TPrimExp Int64 VName)]
    -&gt; Slice (TPrimExp Int64 VName))
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; IxFun (TPrimExp Int64 VName)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TPrimExp Int64 VName)] -&gt; Slice (TPrimExp Int64 VName)
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex (TPrimExp Int64 VName)] -&gt; IxFun (TPrimExp Int64 VName))
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; IxFun (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-455"></span><span>              </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName))
-&gt; [TPrimExp Int64 VName] -&gt; [DimIndex (TPrimExp Int64 VName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441860"><span class="hs-identifier hs-var">user_ids</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TPrimExp Int64 VName)]
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; [DimIndex (TPrimExp Int64 VName)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName))
-&gt; [TPrimExp Int64 VName] -&gt; [DimIndex (TPrimExp Int64 VName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall {d}. Num d =&gt; d -&gt; DimIndex d
</span><a href="#local-6989586621684441882"><span class="hs-identifier hs-var">untouched</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441862"><span class="hs-identifier hs-var">old_shape</span></a></span><span>
</span><span id="line-456"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441858"><span class="hs-identifier hs-var">offset_ixfun</span></a></span><span>
</span><span id="line-457"></span><span>
</span><span id="line-458"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#expandedInvariantAllocations"><span class="hs-identifier hs-type">expandedInvariantAllocations</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-459"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-460"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#NumGroups"><span class="hs-identifier hs-type">NumGroups</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-461"></span><span>  </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#GroupSize"><span class="hs-identifier hs-type">GroupSize</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-462"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#Extraction"><span class="hs-identifier hs-type">Extraction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-463"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#ExpandM"><span class="hs-identifier hs-type">ExpandM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#RebaseMap"><span class="hs-identifier hs-type">RebaseMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span id="expandedInvariantAllocations"><span class="annot"><span class="annottext">expandedInvariantAllocations :: SubExp
-&gt; Count NumGroups SubExp
-&gt; Count GroupSize SubExp
-&gt; Extraction
-&gt; ExpandM (Stms GPUMem, RebaseMap)
</span><a href="Futhark.Pass.ExpandAllocations.html#expandedInvariantAllocations"><span class="hs-identifier hs-var hs-var">expandedInvariantAllocations</span></a></span></span><span> </span><span id="local-6989586621684441857"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441857"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span id="local-6989586621684441856"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441856"><span class="hs-identifier hs-var">num_groups</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-type">Count</span></a></span><span> </span><span id="local-6989586621684441855"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441855"><span class="hs-identifier hs-var">group_size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-465"></span><span>  </span><span class="annot"><span class="annottext">((SegLevel, [TPrimExp Int64 VName])
 -&gt; (ShapeBase SubExp, [TPrimExp Int64 VName]))
-&gt; Extraction -&gt; ExpandM (Stms GPUMem, RebaseMap)
</span><a href="Futhark.Pass.ExpandAllocations.html#genericExpandedInvariantAllocations"><span class="hs-identifier hs-var">genericExpandedInvariantAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
-&gt; (ShapeBase SubExp, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441854"><span class="hs-identifier hs-var">getNumUsers</span></a></span><span>
</span><span id="line-466"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-467"></span><span>    </span><span id="local-6989586621684441854"><span class="annot"><span class="annottext">getNumUsers :: (SegLevel, [TPrimExp Int64 VName])
-&gt; (ShapeBase SubExp, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441854"><span class="hs-identifier hs-var hs-var">getNumUsers</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegThread"><span class="hs-identifier hs-type">SegThread</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span id="local-6989586621684441853"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684441853"><span class="hs-identifier hs-var">gtid</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441857"><span class="hs-identifier hs-var">num_threads</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684441853"><span class="hs-identifier hs-var">gtid</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-468"></span><span>    </span><span class="annot"><a href="#local-6989586621684441854"><span class="hs-identifier hs-var">getNumUsers</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegThread"><span class="hs-identifier hs-type">SegThread</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span id="local-6989586621684441851"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684441851"><span class="hs-identifier hs-var">gid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441850"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684441850"><span class="hs-identifier hs-var">ltid</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441856"><span class="hs-identifier hs-var">num_groups</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441855"><span class="hs-identifier hs-var">group_size</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684441851"><span class="hs-identifier hs-var">gid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684441850"><span class="hs-identifier hs-var">ltid</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>    </span><span class="annot"><a href="#local-6989586621684441854"><span class="hs-identifier hs-var">getNumUsers</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegGroup"><span class="hs-identifier hs-type">SegGroup</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span id="local-6989586621684441849"><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684441849"><span class="hs-identifier hs-var">gid</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; ShapeBase SubExp
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441856"><span class="hs-identifier hs-var">num_groups</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684441849"><span class="hs-identifier hs-var">gid</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-470"></span><span>    </span><span class="annot"><a href="#local-6989586621684441854"><span class="hs-identifier hs-var">getNumUsers</span></a></span><span> </span><span id="local-6989586621684441848"><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441848"><span class="hs-identifier hs-var">user</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; (ShapeBase SubExp, [TPrimExp Int64 VName])
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; (ShapeBase SubExp, [TPrimExp Int64 VName]))
-&gt; String -&gt; (ShapeBase SubExp, [TPrimExp Int64 VName])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;getNumUsers: unhandled &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName]) -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">(SegLevel, [TPrimExp Int64 VName])
</span><a href="#local-6989586621684441848"><span class="hs-identifier hs-var">user</span></a></span><span>
</span><span id="line-471"></span><span>
</span><span id="line-472"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#expandedVariantAllocations"><span class="hs-identifier hs-type">expandedVariantAllocations</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-473"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-474"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-475"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-476"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#Extraction"><span class="hs-identifier hs-type">Extraction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-477"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#ExpandM"><span class="hs-identifier hs-type">ExpandM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#RebaseMap"><span class="hs-identifier hs-type">RebaseMap</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-478"></span><span id="expandedVariantAllocations"><span class="annot"><span class="annottext">expandedVariantAllocations :: SubExp
-&gt; SegSpace
-&gt; Stms GPUMem
-&gt; Extraction
-&gt; ExpandM (Stms GPUMem, RebaseMap)
</span><a href="Futhark.Pass.ExpandAllocations.html#expandedVariantAllocations"><span class="hs-identifier hs-var hs-var">expandedVariantAllocations</span></a></span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684441845"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684441845"><span class="hs-identifier hs-var">variant_allocs</span></a></span></span><span>
</span><span id="line-479"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Extraction -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684441845"><span class="hs-identifier hs-var">variant_allocs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem, RebaseMap) -&gt; ExpandM (Stms GPUMem, RebaseMap)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPUMem
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RebaseMap
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#expandedVariantAllocations"><span class="hs-identifier hs-var">expandedVariantAllocations</span></a></span><span> </span><span id="local-6989586621684441844"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441844"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span> </span><span id="local-6989586621684441843"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684441843"><span class="hs-identifier hs-var">kspace</span></a></span></span><span> </span><span id="local-6989586621684441842"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441842"><span class="hs-identifier hs-var">kstms</span></a></span></span><span> </span><span id="local-6989586621684441841"><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684441841"><span class="hs-identifier hs-var">variant_allocs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-481"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684441840"><span class="annot"><span class="annottext">sizes_to_blocks :: [(SubExp, [(VName, Space)])]
</span><a href="#local-6989586621684441840"><span class="hs-identifier hs-var hs-var">sizes_to_blocks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Extraction -&gt; [(SubExp, [(VName, Space)])]
</span><a href="Futhark.Pass.ExpandAllocations.html#removeCommonSizes"><span class="hs-identifier hs-var">removeCommonSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Extraction
</span><a href="#local-6989586621684441841"><span class="hs-identifier hs-var">variant_allocs</span></a></span><span>
</span><span id="line-482"></span><span>      </span><span id="local-6989586621684441838"><span class="annot"><span class="annottext">variant_sizes :: [SubExp]
</span><a href="#local-6989586621684441838"><span class="hs-identifier hs-var hs-var">variant_sizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((SubExp, [(VName, Space)]) -&gt; SubExp)
-&gt; [(SubExp, [(VName, Space)])] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubExp, [(VName, Space)]) -&gt; SubExp
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(SubExp, [(VName, Space)])]
</span><a href="#local-6989586621684441840"><span class="hs-identifier hs-var">sizes_to_blocks</span></a></span><span>
</span><span id="line-483"></span><span>
</span><span id="line-484"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684441837"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684441837"><span class="hs-identifier hs-var">slice_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441836"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684441836"><span class="hs-identifier hs-var">offsets</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441835"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684441835"><span class="hs-identifier hs-var">size_sums</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-485"></span><span>    </span><span class="annot"><span class="annottext">SubExp
-&gt; [SubExp]
-&gt; SegSpace
-&gt; Stms GPUMem
-&gt; ExpandM (Stms GPU, [VName], [VName])
</span><a href="Futhark.Pass.ExpandAllocations.html#sliceKernelSizes"><span class="hs-identifier hs-var">sliceKernelSizes</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441844"><span class="hs-identifier hs-var">num_threads</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684441838"><span class="hs-identifier hs-var">variant_sizes</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684441843"><span class="hs-identifier hs-var">kspace</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441842"><span class="hs-identifier hs-var">kstms</span></a></span><span>
</span><span id="line-486"></span><span>  </span><span class="hs-comment">-- Note the recursive call to expand allocations inside the newly</span><span>
</span><span id="line-487"></span><span>  </span><span class="hs-comment">-- produced kernels.</span><span>
</span><span id="line-488"></span><span>  </span><span id="local-6989586621684441833"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441833"><span class="hs-identifier hs-var">slice_stms_tmp</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall (m :: * -&gt; *).
(HasScope GPUMem m, MonadFreshNames m) =&gt;
Stms GPUMem -&gt; m (Stms GPUMem)
</span><a href="Futhark.IR.GPUMem.html#simplifyStms"><span class="hs-identifier hs-var">simplifyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem))
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
forall (m :: * -&gt; *).
(MonadFreshNames m, HasScope GPUMem m) =&gt;
Stms GPU -&gt; m (Stms GPUMem)
</span><a href="Futhark.Pass.ExplicitAllocations.GPU.html#explicitAllocationsInStms"><span class="hs-identifier hs-var">explicitAllocationsInStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684441837"><span class="hs-identifier hs-var">slice_stms</span></a></span><span>
</span><span id="line-489"></span><span>  </span><span id="local-6989586621684441831"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441831"><span class="hs-identifier hs-var">slice_stms'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441833"><span class="hs-identifier hs-var">slice_stms_tmp</span></a></span><span>
</span><span id="line-490"></span><span>
</span><span id="line-491"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="#local-6989586621684441830"><span class="hs-identifier hs-type">variant_allocs'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-492"></span><span>      </span><span id="local-6989586621684441830"><span class="annot"><span class="annottext">variant_allocs' :: [(VName, (SubExp, SubExp, Space))]
</span><a href="#local-6989586621684441830"><span class="hs-identifier hs-var hs-var">variant_allocs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-493"></span><span>        </span><span class="annot"><span class="annottext">[[(VName, (SubExp, SubExp, Space))]]
-&gt; [(VName, (SubExp, SubExp, Space))]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">([[(VName, (SubExp, SubExp, Space))]]
 -&gt; [(VName, (SubExp, SubExp, Space))])
-&gt; [[(VName, (SubExp, SubExp, Space))]]
-&gt; [(VName, (SubExp, SubExp, Space))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-494"></span><span>          </span><span class="annot"><span class="annottext">([(VName, Space)]
 -&gt; (VName, VName) -&gt; [(VName, (SubExp, SubExp, Space))])
-&gt; [[(VName, Space)]]
-&gt; [(VName, VName)]
-&gt; [[(VName, (SubExp, SubExp, Space))]]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span>
</span><span id="line-495"></span><span>            </span><span class="annot"><span class="annottext">[(VName, Space)]
-&gt; (VName, VName) -&gt; [(VName, (SubExp, SubExp, Space))]
forall {a} {c}.
[(a, c)] -&gt; (VName, VName) -&gt; [(a, (SubExp, SubExp, c))]
</span><a href="#local-6989586621684441828"><span class="hs-identifier hs-var">memInfo</span></a></span><span>
</span><span id="line-496"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((SubExp, [(VName, Space)]) -&gt; [(VName, Space)])
-&gt; [(SubExp, [(VName, Space)])] -&gt; [[(VName, Space)]]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(SubExp, [(VName, Space)]) -&gt; [(VName, Space)]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(SubExp, [(VName, Space)])]
</span><a href="#local-6989586621684441840"><span class="hs-identifier hs-var">sizes_to_blocks</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [(VName, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684441836"><span class="hs-identifier hs-var">offsets</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684441835"><span class="hs-identifier hs-var">size_sums</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-498"></span><span>      </span><span id="local-6989586621684441828"><span class="annot"><span class="annottext">memInfo :: [(a, c)] -&gt; (VName, VName) -&gt; [(a, (SubExp, SubExp, c))]
</span><a href="#local-6989586621684441828"><span class="hs-identifier hs-var hs-var">memInfo</span></a></span></span><span> </span><span id="local-6989586621684441827"><span class="annot"><span class="annottext">[(a, c)]
</span><a href="#local-6989586621684441827"><span class="hs-identifier hs-var">blocks</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441826"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441826"><span class="hs-identifier hs-var">offset</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441825"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441825"><span class="hs-identifier hs-var">total_size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-499"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684441824"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441826"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441825"><span class="hs-identifier hs-var">total_size</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621684441823"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441824"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684441824"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441823"><span class="annot"><span class="annottext">c
</span><a href="#local-6989586621684441823"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(a, c)]
</span><a href="#local-6989586621684441827"><span class="hs-identifier hs-var">blocks</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-500"></span><span>
</span><span id="line-501"></span><span>  </span><span class="hs-comment">-- We expand the invariant allocations by adding an inner dimension</span><span>
</span><span id="line-502"></span><span>  </span><span class="hs-comment">-- equal to the sum of the sizes required by different threads.</span><span>
</span><span id="line-503"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684441822"><span class="annot"><span class="annottext">[Stm GPUMem]
</span><a href="#local-6989586621684441822"><span class="hs-identifier hs-var">alloc_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441821"><span class="annot"><span class="annottext">[RebaseMap]
</span><a href="#local-6989586621684441821"><span class="hs-identifier hs-var">rebases</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Stm GPUMem, RebaseMap)] -&gt; ([Stm GPUMem], [RebaseMap])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Stm GPUMem, RebaseMap)] -&gt; ([Stm GPUMem], [RebaseMap]))
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     [(Stm GPUMem, RebaseMap)]
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     ([Stm GPUMem], [RebaseMap])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">((VName, (SubExp, SubExp, Space))
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      (Stm GPUMem, RebaseMap))
-&gt; [(VName, (SubExp, SubExp, Space))]
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     [(Stm GPUMem, RebaseMap)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">(VName, (SubExp, SubExp, Space))
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Stm GPUMem, RebaseMap)
</span><a href="#local-6989586621684441820"><span class="hs-identifier hs-var">expand</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName, (SubExp, SubExp, Space))]
</span><a href="#local-6989586621684441830"><span class="hs-identifier hs-var">variant_allocs'</span></a></span><span>
</span><span id="line-504"></span><span>
</span><span id="line-505"></span><span>  </span><span class="annot"><span class="annottext">(Stms GPUMem, RebaseMap) -&gt; ExpandM (Stms GPUMem, RebaseMap)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441831"><span class="hs-identifier hs-var">slice_stms'</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; Stms GPUMem -&gt; Stms GPUMem
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Stm GPUMem] -&gt; Stms GPUMem
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm GPUMem]
</span><a href="#local-6989586621684441822"><span class="hs-identifier hs-var">alloc_stms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[RebaseMap] -&gt; RebaseMap
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[RebaseMap]
</span><a href="#local-6989586621684441821"><span class="hs-identifier hs-var">rebases</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-506"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-507"></span><span>    </span><span id="local-6989586621684441820"><span class="annot"><span class="annottext">expand :: (VName, (SubExp, SubExp, Space))
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Stm GPUMem, RebaseMap)
</span><a href="#local-6989586621684441820"><span class="hs-identifier hs-var hs-var">expand</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441819"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441819"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441818"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441818"><span class="hs-identifier hs-var">offset</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441817"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441817"><span class="hs-identifier hs-var">total_size</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441816"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684441816"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-508"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684441815"><span class="annot"><span class="annottext">allocpat :: PatT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441815"><span class="hs-identifier hs-var hs-var">allocpat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatElemT (MemInfo SubExp NoUniqueness MemBind)]
-&gt; PatT (MemInfo SubExp NoUniqueness MemBind)
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
-&gt; MemInfo SubExp NoUniqueness MemBind
-&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind)
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441819"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">(MemInfo SubExp NoUniqueness MemBind
 -&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind))
-&gt; MemInfo SubExp NoUniqueness MemBind
-&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Space -&gt; MemInfo SubExp NoUniqueness MemBind
forall d u ret. Space -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-var">MemMem</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684441816"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-509"></span><span>      </span><span class="annot"><span class="annottext">(Stm GPUMem, RebaseMap)
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Stm GPUMem, RebaseMap)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-510"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Pat GPUMem -&gt; StmAux (ExpDec GPUMem) -&gt; ExpT GPUMem -&gt; Stm GPUMem
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441815"><span class="hs-identifier hs-var">allocpat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExpT GPUMem -&gt; Stm GPUMem) -&gt; ExpT GPUMem -&gt; Stm GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op GPUMem -&gt; ExpT GPUMem
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op GPUMem -&gt; ExpT GPUMem) -&gt; Op GPUMem -&gt; ExpT GPUMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Space -&gt; MemOp (HostOp GPUMem ())
forall inner. SubExp -&gt; Space -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-var">Alloc</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441817"><span class="hs-identifier hs-var">total_size</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684441816"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-511"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; (([TPrimExp Int64 VName], PrimType)
    -&gt; IxFun (TPrimExp Int64 VName))
-&gt; RebaseMap
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441819"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">((([TPrimExp Int64 VName], PrimType)
  -&gt; IxFun (TPrimExp Int64 VName))
 -&gt; RebaseMap)
-&gt; (([TPrimExp Int64 VName], PrimType)
    -&gt; IxFun (TPrimExp Int64 VName))
-&gt; RebaseMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp
-&gt; ([TPrimExp Int64 VName], PrimType)
-&gt; IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441814"><span class="hs-identifier hs-var">newBase</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441818"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-512"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>
</span><span id="line-514"></span><span>    </span><span id="local-6989586621684441813"><span class="annot"><span class="annottext">num_threads' :: TPrimExp Int64 VName
</span><a href="#local-6989586621684441813"><span class="hs-identifier hs-var hs-var">num_threads'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441844"><span class="hs-identifier hs-var">num_threads</span></a></span><span>
</span><span id="line-515"></span><span>    </span><span id="local-6989586621684441812"><span class="annot"><span class="annottext">gtid :: TPrimExp Int64 VName
</span><a href="#local-6989586621684441812"><span class="hs-identifier hs-var hs-var">gtid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int64 VName
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">le64</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TPrimExp Int64 VName) -&gt; VName -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684441843"><span class="hs-identifier hs-var">kspace</span></a></span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span>    </span><span class="hs-comment">-- For the variant allocations, we add an inner dimension,</span><span>
</span><span id="line-518"></span><span>    </span><span class="hs-comment">-- which is then offset by a thread-specific amount.</span><span>
</span><span id="line-519"></span><span>    </span><span id="local-6989586621684441814"><span class="annot"><span class="annottext">newBase :: SubExp
-&gt; ([TPrimExp Int64 VName], PrimType)
-&gt; IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441814"><span class="hs-identifier hs-var hs-var">newBase</span></a></span></span><span> </span><span id="local-6989586621684441811"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441811"><span class="hs-identifier hs-var">size_per_thread</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441810"><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441810"><span class="hs-identifier hs-var">old_shape</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441809"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441809"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-520"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684441808"><span class="annot"><span class="annottext">elems_per_thread :: TPrimExp Int64 VName
</span><a href="#local-6989586621684441808"><span class="hs-identifier hs-var hs-var">elems_per_thread</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-521"></span><span>            </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441811"><span class="hs-identifier hs-var">size_per_thread</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TPrimExp Int64 VName
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441809"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-522"></span><span>          </span><span id="local-6989586621684441805"><span class="annot"><span class="annottext">root_ixfun :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441805"><span class="hs-identifier hs-var hs-var">root_ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; IxFun (TPrimExp Int64 VName)
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">IxFun.iota</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684441808"><span class="hs-identifier hs-var">elems_per_thread</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684441813"><span class="hs-identifier hs-var">num_threads'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-523"></span><span>          </span><span id="local-6989586621684441804"><span class="annot"><span class="annottext">offset_ixfun :: IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441804"><span class="hs-identifier hs-var hs-var">offset_ixfun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-524"></span><span>            </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
-&gt; Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; Slice num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#slice"><span class="hs-identifier hs-var">IxFun.slice</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441805"><span class="hs-identifier hs-var">root_ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName))
-&gt; ([DimIndex (TPrimExp Int64 VName)]
    -&gt; Slice (TPrimExp Int64 VName))
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; IxFun (TPrimExp Int64 VName)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex (TPrimExp Int64 VName)] -&gt; Slice (TPrimExp Int64 VName)
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex (TPrimExp Int64 VName)] -&gt; IxFun (TPrimExp Int64 VName))
-&gt; [DimIndex (TPrimExp Int64 VName)]
-&gt; IxFun (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-525"></span><span>              </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName
-&gt; TPrimExp Int64 VName
-&gt; DimIndex (TPrimExp Int64 VName)
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684441813"><span class="hs-identifier hs-var">num_threads'</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><span class="hs-number">1</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimIndex (TPrimExp Int64 VName)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
</span><a href="#local-6989586621684441812"><span class="hs-identifier hs-var">gtid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-526"></span><span>          </span><span id="local-6989586621684441803"><span class="annot"><span class="annottext">shapechange :: [DimChange (TPrimExp Int64 VName)]
</span><a href="#local-6989586621684441803"><span class="hs-identifier hs-var hs-var">shapechange</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-527"></span><span>            </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441810"><span class="hs-identifier hs-var">old_shape</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span>
</span><span id="line-528"></span><span>              </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; DimChange (TPrimExp Int64 VName))
-&gt; [TPrimExp Int64 VName] -&gt; [DimChange (TPrimExp Int64 VName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimChange (TPrimExp Int64 VName)
forall d. d -&gt; DimChange d
</span><a href="Futhark.IR.Syntax.html#DimCoercion"><span class="hs-identifier hs-var">DimCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441810"><span class="hs-identifier hs-var">old_shape</span></a></span><span>
</span><span id="line-529"></span><span>              </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; DimChange (TPrimExp Int64 VName))
-&gt; [TPrimExp Int64 VName] -&gt; [DimChange (TPrimExp Int64 VName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName -&gt; DimChange (TPrimExp Int64 VName)
forall d. d -&gt; DimChange d
</span><a href="Futhark.IR.Syntax.html#DimNew"><span class="hs-identifier hs-var">DimNew</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441810"><span class="hs-identifier hs-var">old_shape</span></a></span><span>
</span><span id="line-530"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
-&gt; [DimChange (TPrimExp Int64 VName)]
-&gt; IxFun (TPrimExp Int64 VName)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; ShapeChange num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#reshape"><span class="hs-identifier hs-var">IxFun.reshape</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441804"><span class="hs-identifier hs-var">offset_ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">[DimChange (TPrimExp Int64 VName)]
</span><a href="#local-6989586621684441803"><span class="hs-identifier hs-var">shapechange</span></a></span><span>
</span><span id="line-531"></span><span>
</span><span id="line-532"></span><span class="hs-comment">-- | A map from memory block names to new index function bases.</span><span>
</span><span id="line-533"></span><span class="hs-keyword">type</span><span> </span><span id="RebaseMap"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#RebaseMap"><span class="hs-identifier hs-var">RebaseMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span>
</span><span id="line-535"></span><span class="hs-keyword">newtype</span><span> </span><span id="OffsetM"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-var">OffsetM</span></a></span></span><span> </span><span id="local-6989586621684443104"><span class="annot"><a href="#local-6989586621684443104"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-536"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="OffsetM"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-var">OffsetM</span></a></span></span><span>
</span><span id="line-537"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span>
</span><span id="line-538"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-539"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#RebaseMap"><span class="hs-identifier hs-type">RebaseMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-540"></span><span>          </span><span class="annot"><a href="#local-6989586621684443104"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-541"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-542"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-543"></span><span>    </span><span class="hs-special">(</span><span> </span><span id="local-6989586621684441774"><span id="local-6989586621684441779"><span id="local-6989586621684441784"><span id="local-6989586621684441789"><span id="local-6989586621684441794"><span class="annot"><span class="annottext">Functor OffsetM
Functor OffsetM
-&gt; (forall a. a -&gt; OffsetM a)
-&gt; (forall a b. OffsetM (a -&gt; b) -&gt; OffsetM a -&gt; OffsetM b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c) -&gt; OffsetM a -&gt; OffsetM b -&gt; OffsetM c)
-&gt; (forall a b. OffsetM a -&gt; OffsetM b -&gt; OffsetM b)
-&gt; (forall a b. OffsetM a -&gt; OffsetM b -&gt; OffsetM a)
-&gt; Applicative OffsetM
forall a. a -&gt; OffsetM a
forall a b. OffsetM a -&gt; OffsetM b -&gt; OffsetM a
forall a b. OffsetM a -&gt; OffsetM b -&gt; OffsetM b
forall a b. OffsetM (a -&gt; b) -&gt; OffsetM a -&gt; OffsetM b
forall a b c. (a -&gt; b -&gt; c) -&gt; OffsetM a -&gt; OffsetM b -&gt; OffsetM c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: forall a b. OffsetM a -&gt; OffsetM b -&gt; OffsetM a
$c&lt;* :: forall a b. OffsetM a -&gt; OffsetM b -&gt; OffsetM a
*&gt; :: forall a b. OffsetM a -&gt; OffsetM b -&gt; OffsetM b
$c*&gt; :: forall a b. OffsetM a -&gt; OffsetM b -&gt; OffsetM b
liftA2 :: forall a b c. (a -&gt; b -&gt; c) -&gt; OffsetM a -&gt; OffsetM b -&gt; OffsetM c
$cliftA2 :: forall a b c. (a -&gt; b -&gt; c) -&gt; OffsetM a -&gt; OffsetM b -&gt; OffsetM c
&lt;*&gt; :: forall a b. OffsetM (a -&gt; b) -&gt; OffsetM a -&gt; OffsetM b
$c&lt;*&gt; :: forall a b. OffsetM (a -&gt; b) -&gt; OffsetM a -&gt; OffsetM b
pure :: forall a. a -&gt; OffsetM a
$cpure :: forall a. a -&gt; OffsetM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-544"></span><span>      </span><span id="local-6989586621684441763"><span id="local-6989586621684441768"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; OffsetM a -&gt; OffsetM b)
-&gt; (forall a b. a -&gt; OffsetM b -&gt; OffsetM a) -&gt; Functor OffsetM
forall a b. a -&gt; OffsetM b -&gt; OffsetM a
forall a b. (a -&gt; b) -&gt; OffsetM a -&gt; OffsetM b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: forall a b. a -&gt; OffsetM b -&gt; OffsetM a
$c&lt;$ :: forall a b. a -&gt; OffsetM b -&gt; OffsetM a
fmap :: forall a b. (a -&gt; b) -&gt; OffsetM a -&gt; OffsetM b
$cfmap :: forall a b. (a -&gt; b) -&gt; OffsetM a -&gt; OffsetM b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-545"></span><span>      </span><span id="local-6989586621684441747"><span id="local-6989586621684441751"><span id="local-6989586621684441755"><span class="annot"><span class="annottext">Applicative OffsetM
Applicative OffsetM
-&gt; (forall a b. OffsetM a -&gt; (a -&gt; OffsetM b) -&gt; OffsetM b)
-&gt; (forall a b. OffsetM a -&gt; OffsetM b -&gt; OffsetM b)
-&gt; (forall a. a -&gt; OffsetM a)
-&gt; Monad OffsetM
forall a. a -&gt; OffsetM a
forall a b. OffsetM a -&gt; OffsetM b -&gt; OffsetM b
forall a b. OffsetM a -&gt; (a -&gt; OffsetM b) -&gt; OffsetM b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: forall a. a -&gt; OffsetM a
$creturn :: forall a. a -&gt; OffsetM a
&gt;&gt; :: forall a b. OffsetM a -&gt; OffsetM b -&gt; OffsetM b
$c&gt;&gt; :: forall a b. OffsetM a -&gt; OffsetM b -&gt; OffsetM b
&gt;&gt;= :: forall a b. OffsetM a -&gt; (a -&gt; OffsetM b) -&gt; OffsetM b
$c&gt;&gt;= :: forall a b. OffsetM a -&gt; (a -&gt; OffsetM b) -&gt; OffsetM b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-546"></span><span>      </span><span id="local-6989586621684441723"><span id="local-6989586621684441728"><span id="local-6989586621684441733"><span id="local-6989586621684441738"><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-547"></span><span>      </span><span id="local-6989586621684441713"><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-548"></span><span>      </span><span id="local-6989586621684441700"><span id="local-6989586621684441705"><span class="annot"><span class="hs-identifier hs-type">MonadError</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span></span></span><span>
</span><span id="line-549"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-550"></span><span>
</span><span id="line-551"></span><span id="local-6989586621684443242"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#runOffsetM"><span class="hs-identifier hs-type">runOffsetM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#RebaseMap"><span class="hs-identifier hs-type">RebaseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443242"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="annot"><a href="#local-6989586621684443242"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-552"></span><span id="runOffsetM"><span class="annot"><span class="annottext">runOffsetM :: forall a. Scope GPUMem -&gt; RebaseMap -&gt; OffsetM a -&gt; Either String a
</span><a href="Futhark.Pass.ExpandAllocations.html#runOffsetM"><span class="hs-identifier hs-var hs-var">runOffsetM</span></a></span></span><span> </span><span id="local-6989586621684441694"><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441694"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span id="local-6989586621684441693"><span class="annot"><span class="annottext">RebaseMap
</span><a href="#local-6989586621684441693"><span class="hs-identifier hs-var">offsets</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span id="local-6989586621684441692"><span class="annot"><span class="annottext">ReaderT (Scope GPUMem) (ReaderT RebaseMap (Either String)) a
</span><a href="#local-6989586621684441692"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-553"></span><span>  </span><span class="annot"><span class="annottext">ReaderT RebaseMap (Either String) a -&gt; RebaseMap -&gt; Either String a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT (Scope GPUMem) (ReaderT RebaseMap (Either String)) a
-&gt; Scope GPUMem -&gt; ReaderT RebaseMap (Either String) a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (Scope GPUMem) (ReaderT RebaseMap (Either String)) a
</span><a href="#local-6989586621684441692"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441694"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RebaseMap
</span><a href="#local-6989586621684441693"><span class="hs-identifier hs-var">offsets</span></a></span><span>
</span><span id="line-554"></span><span>
</span><span id="line-555"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#askRebaseMap"><span class="hs-identifier hs-type">askRebaseMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#RebaseMap"><span class="hs-identifier hs-type">RebaseMap</span></a></span><span>
</span><span id="line-556"></span><span id="askRebaseMap"><span class="annot"><span class="annottext">askRebaseMap :: OffsetM RebaseMap
</span><a href="Futhark.Pass.ExpandAllocations.html#askRebaseMap"><span class="hs-identifier hs-var hs-var">askRebaseMap</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReaderT
  (Scope GPUMem) (ReaderT RebaseMap (Either String)) RebaseMap
-&gt; OffsetM RebaseMap
forall a.
ReaderT (Scope GPUMem) (ReaderT RebaseMap (Either String)) a
-&gt; OffsetM a
</span><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-var">OffsetM</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT
   (Scope GPUMem) (ReaderT RebaseMap (Either String)) RebaseMap
 -&gt; OffsetM RebaseMap)
-&gt; ReaderT
     (Scope GPUMem) (ReaderT RebaseMap (Either String)) RebaseMap
-&gt; OffsetM RebaseMap
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ReaderT RebaseMap (Either String) RebaseMap
-&gt; ReaderT
     (Scope GPUMem) (ReaderT RebaseMap (Either String)) RebaseMap
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">ReaderT RebaseMap (Either String) RebaseMap
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-557"></span><span>
</span><span id="line-558"></span><span id="local-6989586621684443098"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#localRebaseMap"><span class="hs-identifier hs-type">localRebaseMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#RebaseMap"><span class="hs-identifier hs-type">RebaseMap</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#RebaseMap"><span class="hs-identifier hs-type">RebaseMap</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443098"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443098"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-559"></span><span id="localRebaseMap"><span class="annot"><span class="annottext">localRebaseMap :: forall a. (RebaseMap -&gt; RebaseMap) -&gt; OffsetM a -&gt; OffsetM a
</span><a href="Futhark.Pass.ExpandAllocations.html#localRebaseMap"><span class="hs-identifier hs-var hs-var">localRebaseMap</span></a></span></span><span> </span><span id="local-6989586621684441682"><span class="annot"><span class="annottext">RebaseMap -&gt; RebaseMap
</span><a href="#local-6989586621684441682"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span id="local-6989586621684441681"><span class="annot"><span class="annottext">ReaderT (Scope GPUMem) (ReaderT RebaseMap (Either String)) a
</span><a href="#local-6989586621684441681"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ReaderT (Scope GPUMem) (ReaderT RebaseMap (Either String)) a
-&gt; OffsetM a
forall a.
ReaderT (Scope GPUMem) (ReaderT RebaseMap (Either String)) a
-&gt; OffsetM a
</span><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-var">OffsetM</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT (Scope GPUMem) (ReaderT RebaseMap (Either String)) a
 -&gt; OffsetM a)
-&gt; ReaderT (Scope GPUMem) (ReaderT RebaseMap (Either String)) a
-&gt; OffsetM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-560"></span><span>  </span><span id="local-6989586621684441680"><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441680"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT
  (Scope GPUMem) (ReaderT RebaseMap (Either String)) (Scope GPUMem)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-561"></span><span>  </span><span class="annot"><span class="annottext">ReaderT RebaseMap (Either String) a
-&gt; ReaderT (Scope GPUMem) (ReaderT RebaseMap (Either String)) a
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(ReaderT RebaseMap (Either String) a
 -&gt; ReaderT (Scope GPUMem) (ReaderT RebaseMap (Either String)) a)
-&gt; ReaderT RebaseMap (Either String) a
-&gt; ReaderT (Scope GPUMem) (ReaderT RebaseMap (Either String)) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(RebaseMap -&gt; RebaseMap)
-&gt; ReaderT RebaseMap (Either String) a
-&gt; ReaderT RebaseMap (Either String) a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">RebaseMap -&gt; RebaseMap
</span><a href="#local-6989586621684441682"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(ReaderT RebaseMap (Either String) a
 -&gt; ReaderT RebaseMap (Either String) a)
-&gt; ReaderT RebaseMap (Either String) a
-&gt; ReaderT RebaseMap (Either String) a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (Scope GPUMem) (ReaderT RebaseMap (Either String)) a
-&gt; Scope GPUMem -&gt; ReaderT RebaseMap (Either String) a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (Scope GPUMem) (ReaderT RebaseMap (Either String)) a
</span><a href="#local-6989586621684441681"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441680"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-562"></span><span>
</span><span id="line-563"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#lookupNewBase"><span class="hs-identifier hs-type">lookupNewBase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-564"></span><span id="lookupNewBase"><span class="annot"><span class="annottext">lookupNewBase :: VName
-&gt; ([TPrimExp Int64 VName], PrimType)
-&gt; OffsetM (Maybe (IxFun (TPrimExp Int64 VName)))
</span><a href="Futhark.Pass.ExpandAllocations.html#lookupNewBase"><span class="hs-identifier hs-var hs-var">lookupNewBase</span></a></span></span><span> </span><span id="local-6989586621684441677"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441677"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684441676"><span class="annot"><span class="annottext">([TPrimExp Int64 VName], PrimType)
</span><a href="#local-6989586621684441676"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-565"></span><span>  </span><span id="local-6989586621684441675"><span class="annot"><span class="annottext">RebaseMap
</span><a href="#local-6989586621684441675"><span class="hs-identifier hs-var">offsets</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OffsetM RebaseMap
</span><a href="Futhark.Pass.ExpandAllocations.html#askRebaseMap"><span class="hs-identifier hs-var">askRebaseMap</span></a></span><span>
</span><span id="line-566"></span><span>  </span><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp Int64 VName))
-&gt; OffsetM (Maybe (IxFun (TPrimExp Int64 VName)))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (IxFun (TPrimExp Int64 VName))
 -&gt; OffsetM (Maybe (IxFun (TPrimExp Int64 VName))))
-&gt; Maybe (IxFun (TPrimExp Int64 VName))
-&gt; OffsetM (Maybe (IxFun (TPrimExp Int64 VName)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(([TPrimExp Int64 VName], PrimType)
 -&gt; IxFun (TPrimExp Int64 VName))
-&gt; ([TPrimExp Int64 VName], PrimType)
-&gt; IxFun (TPrimExp Int64 VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([TPrimExp Int64 VName], PrimType)
</span><a href="#local-6989586621684441676"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((([TPrimExp Int64 VName], PrimType)
  -&gt; IxFun (TPrimExp Int64 VName))
 -&gt; IxFun (TPrimExp Int64 VName))
-&gt; Maybe
     (([TPrimExp Int64 VName], PrimType)
      -&gt; IxFun (TPrimExp Int64 VName))
-&gt; Maybe (IxFun (TPrimExp Int64 VName))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; RebaseMap
-&gt; Maybe
     (([TPrimExp Int64 VName], PrimType)
      -&gt; IxFun (TPrimExp Int64 VName))
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441677"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">RebaseMap
</span><a href="#local-6989586621684441675"><span class="hs-identifier hs-var">offsets</span></a></span><span>
</span><span id="line-567"></span><span>
</span><span id="line-568"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInKernelBody"><span class="hs-identifier hs-type">offsetMemoryInKernelBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-569"></span><span id="offsetMemoryInKernelBody"><span class="annot"><span class="annottext">offsetMemoryInKernelBody :: KernelBody GPUMem -&gt; OffsetM (KernelBody GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInKernelBody"><span class="hs-identifier hs-var hs-var">offsetMemoryInKernelBody</span></a></span></span><span> </span><span id="local-6989586621684441673"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684441673"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-570"></span><span>  </span><span id="local-6989586621684441672"><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441672"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OffsetM (Scope GPUMem)
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-571"></span><span>  </span><span id="local-6989586621684441671"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441671"><span class="hs-identifier hs-var">stms'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-572"></span><span>    </span><span class="annot"><span class="annottext">[Stm GPUMem] -&gt; Stms GPUMem
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm GPUMem] -&gt; Stms GPUMem)
-&gt; ((Scope GPUMem, [Stm GPUMem]) -&gt; [Stm GPUMem])
-&gt; (Scope GPUMem, [Stm GPUMem])
-&gt; Stms GPUMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Scope GPUMem, [Stm GPUMem]) -&gt; [Stm GPUMem]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span>
</span><span id="line-573"></span><span>      </span><span class="annot"><span class="annottext">((Scope GPUMem, [Stm GPUMem]) -&gt; Stms GPUMem)
-&gt; OffsetM (Scope GPUMem, [Stm GPUMem]) -&gt; OffsetM (Stms GPUMem)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Scope GPUMem -&gt; Stm GPUMem -&gt; OffsetM (Scope GPUMem, Stm GPUMem))
-&gt; Scope GPUMem
-&gt; [Stm GPUMem]
-&gt; OffsetM (Scope GPUMem, [Stm GPUMem])
forall (m :: * -&gt; *) acc x y.
Monad m =&gt;
(acc -&gt; x -&gt; m (acc, y)) -&gt; acc -&gt; [x] -&gt; m (acc, [y])
</span><a href="Futhark.Util.html#mapAccumLM"><span class="hs-identifier hs-var">mapAccumLM</span></a></span><span>
</span><span id="line-574"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684441670"><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441670"><span class="hs-identifier hs-var">scope'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
-&gt; OffsetM (Scope GPUMem, Stm GPUMem)
-&gt; OffsetM (Scope GPUMem, Stm GPUMem)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441670"><span class="hs-identifier hs-var">scope'</span></a></span><span> </span><span class="annot"><span class="annottext">(OffsetM (Scope GPUMem, Stm GPUMem)
 -&gt; OffsetM (Scope GPUMem, Stm GPUMem))
-&gt; (Stm GPUMem -&gt; OffsetM (Scope GPUMem, Stm GPUMem))
-&gt; Stm GPUMem
-&gt; OffsetM (Scope GPUMem, Stm GPUMem)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; OffsetM (Scope GPUMem, Stm GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInStm"><span class="hs-identifier hs-var">offsetMemoryInStm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>        </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441672"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-576"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPUMem -&gt; [Stm GPUMem]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPUMem -&gt; [Stm GPUMem]) -&gt; Stms GPUMem -&gt; [Stm GPUMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Stms GPUMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684441673"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-577"></span><span>  </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; OffsetM (KernelBody GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684441673"><span class="hs-identifier hs-var">kbody</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">kernelBodyStms :: Stms GPUMem
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var">kernelBodyStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441671"><span class="hs-identifier hs-var">stms'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-578"></span><span>
</span><span id="line-579"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInBody"><span class="hs-identifier hs-type">offsetMemoryInBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-580"></span><span id="offsetMemoryInBody"><span class="annot"><span class="annottext">offsetMemoryInBody :: Body GPUMem -&gt; OffsetM (Body GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInBody"><span class="hs-identifier hs-var hs-var">offsetMemoryInBody</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span id="local-6989586621684441667"><span class="annot"><span class="annottext">BodyDec GPUMem
</span><a href="#local-6989586621684441667"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621684441666"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441666"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684441665"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684441665"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-581"></span><span>  </span><span id="local-6989586621684441664"><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441664"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OffsetM (Scope GPUMem)
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-582"></span><span>  </span><span id="local-6989586621684441663"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441663"><span class="hs-identifier hs-var">stms'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-583"></span><span>    </span><span class="annot"><span class="annottext">[Stm GPUMem] -&gt; Stms GPUMem
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm GPUMem] -&gt; Stms GPUMem)
-&gt; ((Scope GPUMem, [Stm GPUMem]) -&gt; [Stm GPUMem])
-&gt; (Scope GPUMem, [Stm GPUMem])
-&gt; Stms GPUMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Scope GPUMem, [Stm GPUMem]) -&gt; [Stm GPUMem]
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span>
</span><span id="line-584"></span><span>      </span><span class="annot"><span class="annottext">((Scope GPUMem, [Stm GPUMem]) -&gt; Stms GPUMem)
-&gt; OffsetM (Scope GPUMem, [Stm GPUMem]) -&gt; OffsetM (Stms GPUMem)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Scope GPUMem -&gt; Stm GPUMem -&gt; OffsetM (Scope GPUMem, Stm GPUMem))
-&gt; Scope GPUMem
-&gt; [Stm GPUMem]
-&gt; OffsetM (Scope GPUMem, [Stm GPUMem])
forall (m :: * -&gt; *) acc x y.
Monad m =&gt;
(acc -&gt; x -&gt; m (acc, y)) -&gt; acc -&gt; [x] -&gt; m (acc, [y])
</span><a href="Futhark.Util.html#mapAccumLM"><span class="hs-identifier hs-var">mapAccumLM</span></a></span><span>
</span><span id="line-585"></span><span>        </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684441662"><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441662"><span class="hs-identifier hs-var">scope'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
-&gt; OffsetM (Scope GPUMem, Stm GPUMem)
-&gt; OffsetM (Scope GPUMem, Stm GPUMem)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441662"><span class="hs-identifier hs-var">scope'</span></a></span><span> </span><span class="annot"><span class="annottext">(OffsetM (Scope GPUMem, Stm GPUMem)
 -&gt; OffsetM (Scope GPUMem, Stm GPUMem))
-&gt; (Stm GPUMem -&gt; OffsetM (Scope GPUMem, Stm GPUMem))
-&gt; Stm GPUMem
-&gt; OffsetM (Scope GPUMem, Stm GPUMem)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; OffsetM (Scope GPUMem, Stm GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInStm"><span class="hs-identifier hs-var">offsetMemoryInStm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-586"></span><span>        </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441664"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-587"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPUMem -&gt; [Stm GPUMem]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441666"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-588"></span><span>  </span><span class="annot"><span class="annottext">Body GPUMem -&gt; OffsetM (Body GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; OffsetM (Body GPUMem))
-&gt; Body GPUMem -&gt; OffsetM (Body GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyDec GPUMem -&gt; Stms GPUMem -&gt; Result -&gt; Body GPUMem
forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec GPUMem
</span><a href="#local-6989586621684441667"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441663"><span class="hs-identifier hs-var">stms'</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684441665"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-589"></span><span>
</span><span id="line-590"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInStm"><span class="hs-identifier hs-type">offsetMemoryInStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-591"></span><span id="offsetMemoryInStm"><span class="annot"><span class="annottext">offsetMemoryInStm :: Stm GPUMem -&gt; OffsetM (Scope GPUMem, Stm GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInStm"><span class="hs-identifier hs-var hs-var">offsetMemoryInStm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684441661"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684441661"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684441660"><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><a href="#local-6989586621684441660"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621684441659"><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684441659"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-592"></span><span>  </span><span id="local-6989586621684441658"><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684441658"><span class="hs-identifier hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExpT GPUMem -&gt; OffsetM (ExpT GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInExp"><span class="hs-identifier hs-var">offsetMemoryInExp</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684441659"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-593"></span><span>  </span><span id="local-6989586621684441656"><span class="annot"><span class="annottext">PatT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441656"><span class="hs-identifier hs-var">pat'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat GPUMem -&gt; [ExpReturns] -&gt; OffsetM (Pat GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInPat"><span class="hs-identifier hs-var">offsetMemoryInPat</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684441661"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">([ExpReturns]
 -&gt; OffsetM (PatT (MemInfo SubExp NoUniqueness MemBind)))
-&gt; OffsetM [ExpReturns]
-&gt; OffsetM (PatT (MemInfo SubExp NoUniqueness MemBind))
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">ExpT GPUMem -&gt; OffsetM [ExpReturns]
forall (m :: * -&gt; *) rep inner.
(Monad m, LocalScope rep m, Mem rep inner) =&gt;
Exp rep -&gt; m [ExpReturns]
</span><a href="Futhark.IR.Mem.html#expReturns"><span class="hs-identifier hs-var">expReturns</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684441658"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-594"></span><span>  </span><span id="local-6989586621684441653"><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441653"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OffsetM (Scope GPUMem)
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-595"></span><span>  </span><span class="hs-comment">-- Try to recompute the index function.  Fall back to creating rebase</span><span>
</span><span id="line-596"></span><span>  </span><span class="hs-comment">-- operations with the RebaseMap.</span><span>
</span><span id="line-597"></span><span>  </span><span id="local-6989586621684441652"><span class="annot"><span class="annottext">[ExpReturns]
</span><a href="#local-6989586621684441652"><span class="hs-identifier hs-var">rts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT (Scope GPUMem) OffsetM [ExpReturns]
-&gt; Scope GPUMem -&gt; OffsetM [ExpReturns]
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ExpT GPUMem -&gt; ReaderT (Scope GPUMem) OffsetM [ExpReturns]
forall (m :: * -&gt; *) rep inner.
(Monad m, LocalScope rep m, Mem rep inner) =&gt;
Exp rep -&gt; m [ExpReturns]
</span><a href="Futhark.IR.Mem.html#expReturns"><span class="hs-identifier hs-var">expReturns</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684441658"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441653"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-598"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684441651"><span class="annot"><span class="annottext">pat'' :: PatT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441651"><span class="hs-identifier hs-var hs-var">pat''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatElemT (MemInfo SubExp NoUniqueness MemBind)]
-&gt; PatT (MemInfo SubExp NoUniqueness MemBind)
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT (MemInfo SubExp NoUniqueness MemBind)]
 -&gt; PatT (MemInfo SubExp NoUniqueness MemBind))
-&gt; [PatElemT (MemInfo SubExp NoUniqueness MemBind)]
-&gt; PatT (MemInfo SubExp NoUniqueness MemBind)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (MemInfo SubExp NoUniqueness MemBind)
 -&gt; ExpReturns -&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind))
-&gt; [PatElemT (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [ExpReturns]
-&gt; [PatElemT (MemInfo SubExp NoUniqueness MemBind)]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind)
-&gt; ExpReturns -&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441650"><span class="hs-identifier hs-var">pick</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT (MemInfo SubExp NoUniqueness MemBind)
-&gt; [PatElemT (MemInfo SubExp NoUniqueness MemBind)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441656"><span class="hs-identifier hs-var">pat'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[ExpReturns]
</span><a href="#local-6989586621684441652"><span class="hs-identifier hs-var">rts</span></a></span><span>
</span><span id="line-599"></span><span>      </span><span id="local-6989586621684441649"><span class="annot"><span class="annottext">stm :: Stm GPUMem
</span><a href="#local-6989586621684441649"><span class="hs-identifier hs-var hs-var">stm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Pat GPUMem -&gt; StmAux (ExpDec GPUMem) -&gt; ExpT GPUMem -&gt; Stm GPUMem
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441651"><span class="hs-identifier hs-var">pat''</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><a href="#local-6989586621684441660"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684441658"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-600"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684441648"><span class="annot"><span class="annottext">scope' :: Scope GPUMem
</span><a href="#local-6989586621684441648"><span class="hs-identifier hs-var hs-var">scope'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; Scope GPUMem
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684441649"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem -&gt; Scope GPUMem -&gt; Scope GPUMem
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441653"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-601"></span><span>  </span><span class="annot"><span class="annottext">(Scope GPUMem, Stm GPUMem) -&gt; OffsetM (Scope GPUMem, Stm GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441648"><span class="hs-identifier hs-var">scope'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684441649"><span class="hs-identifier hs-var">stm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-602"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-603"></span><span>    </span><span class="annot"><a href="#local-6989586621684441650"><span class="hs-identifier hs-type">pick</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-604"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#PatElemT"><span class="hs-identifier hs-type">PatElemT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemInfo"><span class="hs-identifier hs-type">MemInfo</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-type">NoUniqueness</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemBind"><span class="hs-identifier hs-type">MemBind</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-605"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.html#ExpReturns"><span class="hs-identifier hs-type">ExpReturns</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-606"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#PatElemT"><span class="hs-identifier hs-type">PatElemT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemInfo"><span class="hs-identifier hs-type">MemInfo</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#NoUniqueness"><span class="hs-identifier hs-type">NoUniqueness</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemBind"><span class="hs-identifier hs-type">MemBind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-607"></span><span>    </span><span id="local-6989586621684441650"><span class="annot"><span class="annottext">pick :: PatElemT (MemInfo SubExp NoUniqueness MemBind)
-&gt; ExpReturns -&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441650"><span class="hs-identifier hs-var hs-var">pick</span></a></span></span><span>
</span><span id="line-608"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-type">PatElem</span></a></span><span> </span><span id="local-6989586621684441647"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441647"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684441645"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441645"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684441644"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684441644"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684441643"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684441643"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621684441642"><span class="annot"><span class="annottext">MemBind
</span><a href="#local-6989586621684441642"><span class="hs-identifier hs-var">_ret</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ShapeBase ExtSize
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ReturnsInBlock"><span class="hs-identifier hs-type">ReturnsInBlock</span></a></span><span> </span><span id="local-6989586621684441640"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441640"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621684441639"><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684441639"><span class="hs-identifier hs-var">extixfun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-610"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684441638"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441638"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExtIxFun -&gt; Maybe (IxFun (TPrimExp Int64 VName))
</span><a href="#local-6989586621684441637"><span class="hs-identifier hs-var">instantiateIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684441639"><span class="hs-identifier hs-var">extixfun</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-611"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; MemInfo SubExp NoUniqueness MemBind
-&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind)
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441647"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType
-&gt; ShapeBase SubExp
-&gt; NoUniqueness
-&gt; MemBind
-&gt; MemInfo SubExp NoUniqueness MemBind
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441645"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684441644"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684441643"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441640"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441638"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-612"></span><span>    </span><span class="annot"><a href="#local-6989586621684441650"><span class="hs-identifier hs-var">pick</span></a></span><span> </span><span id="local-6989586621684441635"><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441635"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExpReturns
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441635"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span>    </span><span class="annot"><a href="#local-6989586621684441637"><span class="hs-identifier hs-type">instantiateIxFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#ExtIxFun"><span class="hs-identifier hs-type">ExtIxFun</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span>
</span><span id="line-615"></span><span>    </span><span id="local-6989586621684441637"><span class="annot"><span class="annottext">instantiateIxFun :: ExtIxFun -&gt; Maybe (IxFun (TPrimExp Int64 VName))
</span><a href="#local-6989586621684441637"><span class="hs-identifier hs-var hs-var">instantiateIxFun</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 (Ext VName) -&gt; Maybe (TPrimExp Int64 VName))
-&gt; ExtIxFun -&gt; Maybe (IxFun (TPrimExp Int64 VName))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Ext VName -&gt; Maybe VName)
-&gt; TPrimExp Int64 (Ext VName) -&gt; Maybe (TPrimExp Int64 VName)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">Ext VName -&gt; Maybe VName
forall {a}. Ext a -&gt; Maybe a
</span><a href="#local-6989586621684441633"><span class="hs-identifier hs-var">inst</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-616"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-617"></span><span>        </span><span id="local-6989586621684441633"><span class="annot"><span class="annottext">inst :: Ext a -&gt; Maybe a
</span><a href="#local-6989586621684441633"><span class="hs-identifier hs-var hs-var">inst</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe a
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-618"></span><span>        </span><span class="annot"><a href="#local-6989586621684441633"><span class="hs-identifier hs-var">inst</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-type">Free</span></a></span><span> </span><span id="local-6989586621684441629"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684441629"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; Maybe a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684441629"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-619"></span><span>
</span><span id="line-620"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInPat"><span class="hs-identifier hs-type">offsetMemoryInPat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Mem.html#ExpReturns"><span class="hs-identifier hs-type">ExpReturns</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-621"></span><span id="offsetMemoryInPat"><span class="annot"><span class="annottext">offsetMemoryInPat :: Pat GPUMem -&gt; [ExpReturns] -&gt; OffsetM (Pat GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInPat"><span class="hs-identifier hs-var hs-var">offsetMemoryInPat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span id="local-6989586621684441628"><span class="annot"><span class="annottext">[PatElemT (LetDec GPUMem)]
</span><a href="#local-6989586621684441628"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684441627"><span class="annot"><span class="annottext">[ExpReturns]
</span><a href="#local-6989586621684441627"><span class="hs-identifier hs-var">rets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-622"></span><span>  </span><span class="annot"><span class="annottext">[PatElemT (MemInfo SubExp NoUniqueness MemBind)]
-&gt; PatT (MemInfo SubExp NoUniqueness MemBind)
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT (MemInfo SubExp NoUniqueness MemBind)]
 -&gt; PatT (MemInfo SubExp NoUniqueness MemBind))
-&gt; OffsetM [PatElemT (MemInfo SubExp NoUniqueness MemBind)]
-&gt; OffsetM (PatT (MemInfo SubExp NoUniqueness MemBind))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (MemInfo SubExp NoUniqueness MemBind)
 -&gt; ExpReturns
 -&gt; OffsetM (PatElemT (MemInfo SubExp NoUniqueness MemBind)))
-&gt; [PatElemT (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [ExpReturns]
-&gt; OffsetM [PatElemT (MemInfo SubExp NoUniqueness MemBind)]
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m [c]
</span><span class="hs-identifier hs-var">zipWithM</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind)
-&gt; ExpReturns
-&gt; OffsetM (PatElemT (MemInfo SubExp NoUniqueness MemBind))
</span><a href="#local-6989586621684441625"><span class="hs-identifier hs-var">onPE</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT (LetDec GPUMem)]
[PatElemT (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684441628"><span class="hs-identifier hs-var">pes</span></a></span><span> </span><span class="annot"><span class="annottext">[ExpReturns]
</span><a href="#local-6989586621684441627"><span class="hs-identifier hs-var">rets</span></a></span><span>
</span><span id="line-623"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-624"></span><span>    </span><span id="local-6989586621684441625"><span class="annot"><span class="annottext">onPE :: PatElemT (MemInfo SubExp NoUniqueness MemBind)
-&gt; ExpReturns
-&gt; OffsetM (PatElemT (MemInfo SubExp NoUniqueness MemBind))
</span><a href="#local-6989586621684441625"><span class="hs-identifier hs-var hs-var">onPE</span></a></span></span><span>
</span><span id="line-625"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-type">PatElem</span></a></span><span> </span><span id="local-6989586621684441624"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441624"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684441623"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441623"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684441622"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684441622"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684441621"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684441621"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684441620"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441620"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-626"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ShapeBase ExtSize
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ReturnsNewBlock"><span class="hs-identifier hs-type">ReturnsNewBlock</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684441618"><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684441618"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-627"></span><span>        </span><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind)
-&gt; OffsetM (PatElemT (MemInfo SubExp NoUniqueness MemBind))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (MemInfo SubExp NoUniqueness MemBind)
 -&gt; OffsetM (PatElemT (MemInfo SubExp NoUniqueness MemBind)))
-&gt; (IxFun (TPrimExp Int64 VName)
    -&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind))
-&gt; IxFun (TPrimExp Int64 VName)
-&gt; OffsetM (PatElemT (MemInfo SubExp NoUniqueness MemBind))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName
-&gt; MemInfo SubExp NoUniqueness MemBind
-&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind)
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441624"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(MemInfo SubExp NoUniqueness MemBind
 -&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind))
-&gt; (IxFun (TPrimExp Int64 VName)
    -&gt; MemInfo SubExp NoUniqueness MemBind)
-&gt; IxFun (TPrimExp Int64 VName)
-&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType
-&gt; ShapeBase SubExp
-&gt; NoUniqueness
-&gt; MemBind
-&gt; MemInfo SubExp NoUniqueness MemBind
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441623"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684441622"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684441621"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; MemInfo SubExp NoUniqueness MemBind)
-&gt; (IxFun (TPrimExp Int64 VName) -&gt; MemBind)
-&gt; IxFun (TPrimExp Int64 VName)
-&gt; MemInfo SubExp NoUniqueness MemBind
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441620"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">(IxFun (TPrimExp Int64 VName)
 -&gt; OffsetM (PatElemT (MemInfo SubExp NoUniqueness MemBind)))
-&gt; IxFun (TPrimExp Int64 VName)
-&gt; OffsetM (PatElemT (MemInfo SubExp NoUniqueness MemBind))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-628"></span><span>          </span><span class="annot"><span class="annottext">(TPrimExp Int64 (Ext VName) -&gt; TPrimExp Int64 VName)
-&gt; ExtIxFun -&gt; IxFun (TPrimExp Int64 VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Ext VName -&gt; VName)
-&gt; TPrimExp Int64 (Ext VName) -&gt; TPrimExp Int64 VName
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Ext VName -&gt; VName
</span><a href="#local-6989586621684441617"><span class="hs-identifier hs-var">unExt</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684441618"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-629"></span><span>    </span><span class="annot"><a href="#local-6989586621684441625"><span class="hs-identifier hs-var">onPE</span></a></span><span> </span><span id="local-6989586621684441616"><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441616"><span class="hs-identifier hs-var">pe</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExpReturns
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-630"></span><span>      </span><span id="local-6989586621684441615"><span class="annot"><span class="annottext">MemInfo SubExp NoUniqueness MemBind
</span><a href="#local-6989586621684441615"><span class="hs-identifier hs-var">new_dec</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemInfo SubExp NoUniqueness MemBind
-&gt; OffsetM (MemInfo SubExp NoUniqueness MemBind)
forall u. MemBound u -&gt; OffsetM (MemBound u)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInMemBound"><span class="hs-identifier hs-var">offsetMemoryInMemBound</span></a></span><span> </span><span class="annot"><span class="annottext">(MemInfo SubExp NoUniqueness MemBind
 -&gt; OffsetM (MemInfo SubExp NoUniqueness MemBind))
-&gt; MemInfo SubExp NoUniqueness MemBind
-&gt; OffsetM (MemInfo SubExp NoUniqueness MemBind)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind)
-&gt; MemInfo SubExp NoUniqueness MemBind
forall dec. PatElemT dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#patElemDec"><span class="hs-identifier hs-var hs-var">patElemDec</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441616"><span class="hs-identifier hs-var">pe</span></a></span><span>
</span><span id="line-631"></span><span>      </span><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind)
-&gt; OffsetM (PatElemT (MemInfo SubExp NoUniqueness MemBind))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441616"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">patElemDec :: MemInfo SubExp NoUniqueness MemBind
</span><a href="Futhark.IR.Syntax.Core.html#patElemDec"><span class="hs-identifier hs-var">patElemDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemInfo SubExp NoUniqueness MemBind
</span><a href="#local-6989586621684441615"><span class="hs-identifier hs-var">new_dec</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-632"></span><span>    </span><span id="local-6989586621684441617"><span class="annot"><span class="annottext">unExt :: Ext VName -&gt; VName
</span><a href="#local-6989586621684441617"><span class="hs-identifier hs-var hs-var">unExt</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span id="local-6989586621684441612"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684441612"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatElemT (MemInfo SubExp NoUniqueness MemBind) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT (LetDec GPUMem)]
[PatElemT (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684441628"><span class="hs-identifier hs-var">pes</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT (MemInfo SubExp NoUniqueness MemBind)]
-&gt; Int -&gt; PatElemT (MemInfo SubExp NoUniqueness MemBind)
forall a. [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684441612"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-633"></span><span>    </span><span class="annot"><a href="#local-6989586621684441617"><span class="hs-identifier hs-var">unExt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-type">Free</span></a></span><span> </span><span id="local-6989586621684441610"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441610"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441610"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-634"></span><span>
</span><span id="line-635"></span><span id="local-6989586621684443073"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInParam"><span class="hs-identifier hs-type">offsetMemoryInParam</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemBound"><span class="hs-identifier hs-type">MemBound</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443073"><span class="hs-identifier hs-type">u</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemBound"><span class="hs-identifier hs-type">MemBound</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443073"><span class="hs-identifier hs-type">u</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-636"></span><span id="offsetMemoryInParam"><span class="annot"><span class="annottext">offsetMemoryInParam :: forall u. Param (MemBound u) -&gt; OffsetM (Param (MemBound u))
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInParam"><span class="hs-identifier hs-var hs-var">offsetMemoryInParam</span></a></span></span><span> </span><span id="local-6989586621684441606"><span class="annot"><span class="annottext">Param (MemBound u)
</span><a href="#local-6989586621684441606"><span class="hs-identifier hs-var">fparam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-637"></span><span>  </span><span id="local-6989586621684441605"><span class="annot"><span class="annottext">MemBound u
</span><a href="#local-6989586621684441605"><span class="hs-identifier hs-var">fparam'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemBound u -&gt; OffsetM (MemBound u)
forall u. MemBound u -&gt; OffsetM (MemBound u)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInMemBound"><span class="hs-identifier hs-var">offsetMemoryInMemBound</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBound u -&gt; OffsetM (MemBound u))
-&gt; MemBound u -&gt; OffsetM (MemBound u)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (MemBound u) -&gt; MemBound u
forall dec. Param dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var hs-var">paramDec</span></a></span><span> </span><span class="annot"><span class="annottext">Param (MemBound u)
</span><a href="#local-6989586621684441606"><span class="hs-identifier hs-var">fparam</span></a></span><span>
</span><span id="line-638"></span><span>  </span><span class="annot"><span class="annottext">Param (MemBound u) -&gt; OffsetM (Param (MemBound u))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Param (MemBound u)
</span><a href="#local-6989586621684441606"><span class="hs-identifier hs-var">fparam</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">paramDec :: MemBound u
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var">paramDec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemBound u
</span><a href="#local-6989586621684441605"><span class="hs-identifier hs-var">fparam'</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-639"></span><span>
</span><span id="line-640"></span><span id="local-6989586621684443076"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInMemBound"><span class="hs-identifier hs-type">offsetMemoryInMemBound</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemBound"><span class="hs-identifier hs-type">MemBound</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443076"><span class="hs-identifier hs-type">u</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemBound"><span class="hs-identifier hs-type">MemBound</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443076"><span class="hs-identifier hs-type">u</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-641"></span><span id="offsetMemoryInMemBound"><span class="annot"><span class="annottext">offsetMemoryInMemBound :: forall u. MemBound u -&gt; OffsetM (MemBound u)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInMemBound"><span class="hs-identifier hs-var hs-var">offsetMemoryInMemBound</span></a></span></span><span> </span><span id="local-6989586621684441596"><span class="annot"><span class="annottext">summary :: MemBound u
</span><a href="#local-6989586621684441596"><span class="hs-identifier hs-var">summary</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684441595"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441595"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684441594"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684441594"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684441593"><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684441593"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-type">ArrayIn</span></a></span><span> </span><span id="local-6989586621684441592"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441592"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684441591"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441591"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-642"></span><span>  </span><span id="local-6989586621684441590"><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp Int64 VName))
</span><a href="#local-6989586621684441590"><span class="hs-identifier hs-var">new_base</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; ([TPrimExp Int64 VName], PrimType)
-&gt; OffsetM (Maybe (IxFun (TPrimExp Int64 VName)))
</span><a href="Futhark.Pass.ExpandAllocations.html#lookupNewBase"><span class="hs-identifier hs-var">lookupNewBase</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441592"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName) -&gt; [TPrimExp Int64 VName]
forall num. IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#base"><span class="hs-identifier hs-var hs-var">IxFun.base</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441591"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441595"><span class="hs-identifier hs-var">pt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-643"></span><span>  </span><span class="annot"><span class="annottext">MemBound u -&gt; OffsetM (MemBound u)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(MemBound u -&gt; OffsetM (MemBound u))
-&gt; (Maybe (MemBound u) -&gt; MemBound u)
-&gt; Maybe (MemBound u)
-&gt; OffsetM (MemBound u)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MemBound u -&gt; Maybe (MemBound u) -&gt; MemBound u
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">MemBound u
</span><a href="#local-6989586621684441596"><span class="hs-identifier hs-var">summary</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (MemBound u) -&gt; OffsetM (MemBound u))
-&gt; Maybe (MemBound u) -&gt; OffsetM (MemBound u)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-644"></span><span>    </span><span id="local-6989586621684441587"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441587"><span class="hs-identifier hs-var">new_base'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp Int64 VName))
</span><a href="#local-6989586621684441590"><span class="hs-identifier hs-var">new_base</span></a></span><span>
</span><span id="line-645"></span><span>    </span><span class="annot"><span class="annottext">MemBound u -&gt; Maybe (MemBound u)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(MemBound u -&gt; Maybe (MemBound u))
-&gt; MemBound u -&gt; Maybe (MemBound u)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ShapeBase SubExp -&gt; u -&gt; MemBind -&gt; MemBound u
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441595"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684441594"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684441593"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemBind -&gt; MemBound u) -&gt; MemBind -&gt; MemBound u
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
</span><a href="Futhark.IR.Mem.html#ArrayIn"><span class="hs-identifier hs-var">ArrayIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441592"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">(IxFun (TPrimExp Int64 VName) -&gt; MemBind)
-&gt; IxFun (TPrimExp Int64 VName) -&gt; MemBind
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
-&gt; IxFun (TPrimExp Int64 VName) -&gt; IxFun (TPrimExp Int64 VName)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; IxFun num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#rebase"><span class="hs-identifier hs-var">IxFun.rebase</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441587"><span class="hs-identifier hs-var">new_base'</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441591"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-646"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInMemBound"><span class="hs-identifier hs-var">offsetMemoryInMemBound</span></a></span><span> </span><span id="local-6989586621684441585"><span class="annot"><span class="annottext">MemBound u
</span><a href="#local-6989586621684441585"><span class="hs-identifier hs-var">summary</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemBound u -&gt; OffsetM (MemBound u)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">MemBound u
</span><a href="#local-6989586621684441585"><span class="hs-identifier hs-var">summary</span></a></span><span>
</span><span id="line-647"></span><span>
</span><span id="line-648"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInBodyReturns"><span class="hs-identifier hs-type">offsetMemoryInBodyReturns</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#BodyReturns"><span class="hs-identifier hs-type">BodyReturns</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#BodyReturns"><span class="hs-identifier hs-type">BodyReturns</span></a></span><span>
</span><span id="line-649"></span><span id="offsetMemoryInBodyReturns"><span class="annot"><span class="annottext">offsetMemoryInBodyReturns :: BranchTypeMem -&gt; OffsetM BranchTypeMem
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInBodyReturns"><span class="hs-identifier hs-var hs-var">offsetMemoryInBodyReturns</span></a></span></span><span> </span><span id="local-6989586621684441582"><span class="annot"><span class="annottext">br :: BranchTypeMem
</span><a href="#local-6989586621684441582"><span class="hs-identifier hs-var">br</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684441581"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441581"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684441580"><span class="annot"><span class="annottext">ShapeBase ExtSize
</span><a href="#local-6989586621684441580"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684441579"><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684441579"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#ReturnsInBlock"><span class="hs-identifier hs-type">ReturnsInBlock</span></a></span><span> </span><span id="local-6989586621684441578"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441578"><span class="hs-identifier hs-var">mem</span></a></span></span><span> </span><span id="local-6989586621684441577"><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684441577"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-650"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684441576"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441576"><span class="hs-identifier hs-var">ixfun'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ExtIxFun -&gt; Maybe (IxFun (TPrimExp Int64 VName))
</span><a href="Futhark.IR.Mem.html#isStaticIxFun"><span class="hs-identifier hs-var">isStaticIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684441577"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-651"></span><span>    </span><span id="local-6989586621684441574"><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp Int64 VName))
</span><a href="#local-6989586621684441574"><span class="hs-identifier hs-var">new_base</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; ([TPrimExp Int64 VName], PrimType)
-&gt; OffsetM (Maybe (IxFun (TPrimExp Int64 VName)))
</span><a href="Futhark.Pass.ExpandAllocations.html#lookupNewBase"><span class="hs-identifier hs-var">lookupNewBase</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441578"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName) -&gt; [TPrimExp Int64 VName]
forall num. IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#base"><span class="hs-identifier hs-var hs-var">IxFun.base</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441576"><span class="hs-identifier hs-var">ixfun'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441581"><span class="hs-identifier hs-var">pt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-652"></span><span>    </span><span class="annot"><span class="annottext">BranchTypeMem -&gt; OffsetM BranchTypeMem
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(BranchTypeMem -&gt; OffsetM BranchTypeMem)
-&gt; (Maybe BranchTypeMem -&gt; BranchTypeMem)
-&gt; Maybe BranchTypeMem
-&gt; OffsetM BranchTypeMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BranchTypeMem -&gt; Maybe BranchTypeMem -&gt; BranchTypeMem
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">BranchTypeMem
</span><a href="#local-6989586621684441582"><span class="hs-identifier hs-var">br</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe BranchTypeMem -&gt; OffsetM BranchTypeMem)
-&gt; Maybe BranchTypeMem -&gt; OffsetM BranchTypeMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-653"></span><span>      </span><span id="local-6989586621684441573"><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441573"><span class="hs-identifier hs-var">new_base'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp Int64 VName))
</span><a href="#local-6989586621684441574"><span class="hs-identifier hs-var">new_base</span></a></span><span>
</span><span id="line-654"></span><span>      </span><span class="annot"><span class="annottext">BranchTypeMem -&gt; Maybe BranchTypeMem
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(BranchTypeMem -&gt; Maybe BranchTypeMem)
-&gt; (ExtIxFun -&gt; BranchTypeMem) -&gt; ExtIxFun -&gt; Maybe BranchTypeMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PrimType
-&gt; ShapeBase ExtSize -&gt; NoUniqueness -&gt; MemReturn -&gt; BranchTypeMem
forall d u ret.
PrimType -&gt; ShapeBase d -&gt; u -&gt; ret -&gt; MemInfo d u ret
</span><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-var">MemArray</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441581"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase ExtSize
</span><a href="#local-6989586621684441580"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">NoUniqueness
</span><a href="#local-6989586621684441579"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">(MemReturn -&gt; BranchTypeMem)
-&gt; (ExtIxFun -&gt; MemReturn) -&gt; ExtIxFun -&gt; BranchTypeMem
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ExtIxFun -&gt; MemReturn
</span><a href="Futhark.IR.Mem.html#ReturnsInBlock"><span class="hs-identifier hs-var">ReturnsInBlock</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441578"><span class="hs-identifier hs-var">mem</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtIxFun -&gt; Maybe BranchTypeMem)
-&gt; ExtIxFun -&gt; Maybe BranchTypeMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-655"></span><span>        </span><span class="annot"><span class="annottext">ExtIxFun -&gt; ExtIxFun -&gt; ExtIxFun
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; IxFun num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#rebase"><span class="hs-identifier hs-var">IxFun.rebase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TPrimExp Int64 VName -&gt; TPrimExp Int64 (Ext VName))
-&gt; IxFun (TPrimExp Int64 VName) -&gt; ExtIxFun
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; Ext VName)
-&gt; TPrimExp Int64 VName -&gt; TPrimExp Int64 (Ext VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Ext VName
forall a. a -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-var">Free</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp Int64 VName)
</span><a href="#local-6989586621684441573"><span class="hs-identifier hs-var">new_base'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExtIxFun
</span><a href="#local-6989586621684441577"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-656"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInBodyReturns"><span class="hs-identifier hs-var">offsetMemoryInBodyReturns</span></a></span><span> </span><span id="local-6989586621684441572"><span class="annot"><span class="annottext">BranchTypeMem
</span><a href="#local-6989586621684441572"><span class="hs-identifier hs-var">br</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchTypeMem -&gt; OffsetM BranchTypeMem
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">BranchTypeMem
</span><a href="#local-6989586621684441572"><span class="hs-identifier hs-var">br</span></a></span><span>
</span><span id="line-657"></span><span>
</span><span id="line-658"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInLambda"><span class="hs-identifier hs-type">offsetMemoryInLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-659"></span><span id="offsetMemoryInLambda"><span class="annot"><span class="annottext">offsetMemoryInLambda :: Lambda GPUMem -&gt; OffsetM (Lambda GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInLambda"><span class="hs-identifier hs-var hs-var">offsetMemoryInLambda</span></a></span></span><span> </span><span id="local-6989586621684441571"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684441571"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; OffsetM (Lambda GPUMem) -&gt; OffsetM (Lambda GPUMem)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684441571"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">(OffsetM (Lambda GPUMem) -&gt; OffsetM (Lambda GPUMem))
-&gt; OffsetM (Lambda GPUMem) -&gt; OffsetM (Lambda GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-660"></span><span>  </span><span id="local-6989586621684441570"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441570"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Body GPUMem -&gt; OffsetM (Body GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInBody"><span class="hs-identifier hs-var">offsetMemoryInBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; OffsetM (Body GPUMem))
-&gt; Body GPUMem -&gt; OffsetM (Body GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; Body GPUMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684441571"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-661"></span><span>  </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; OffsetM (Lambda GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Lambda GPUMem -&gt; OffsetM (Lambda GPUMem))
-&gt; Lambda GPUMem -&gt; OffsetM (Lambda GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684441571"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lambdaBody :: Body GPUMem
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var">lambdaBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441570"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-662"></span><span>
</span><span id="line-663"></span><span class="hs-comment">-- A loop may have memory parameters, and those memory blocks may</span><span>
</span><span id="line-664"></span><span class="hs-comment">-- be expanded.  We assume (but do not check - FIXME) that if the</span><span>
</span><span id="line-665"></span><span class="hs-comment">-- initial value of a loop parameter is an expanded memory block,</span><span>
</span><span id="line-666"></span><span class="hs-comment">-- then so will the result be.</span><span>
</span><span id="line-667"></span><span id="local-6989586621684443066"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInLoopParams"><span class="hs-identifier hs-type">offsetMemoryInLoopParams</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-668"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-669"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443066"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-670"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443066"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-671"></span><span id="offsetMemoryInLoopParams"><span class="annot"><span class="annottext">offsetMemoryInLoopParams :: forall a.
[(FParam GPUMem, SubExp)]
-&gt; ([(FParam GPUMem, SubExp)] -&gt; OffsetM a) -&gt; OffsetM a
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInLoopParams"><span class="hs-identifier hs-var hs-var">offsetMemoryInLoopParams</span></a></span></span><span> </span><span id="local-6989586621684441564"><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
</span><a href="#local-6989586621684441564"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684441563"><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)] -&gt; OffsetM a
</span><a href="#local-6989586621684441563"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-672"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441562"><span class="annot"><span class="annottext">[Param (MemInfo SubExp Uniqueness MemBind)]
</span><a href="#local-6989586621684441562"><span class="hs-identifier hs-var">params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441561"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684441561"><span class="hs-identifier hs-var">args</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Param (MemInfo SubExp Uniqueness MemBind), SubExp)]
-&gt; ([Param (MemInfo SubExp Uniqueness MemBind)], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
[(Param (MemInfo SubExp Uniqueness MemBind), SubExp)]
</span><a href="#local-6989586621684441564"><span class="hs-identifier hs-var">merge</span></a></span><span>
</span><span id="line-673"></span><span>  </span><span class="annot"><span class="annottext">(RebaseMap -&gt; RebaseMap) -&gt; OffsetM a -&gt; OffsetM a
forall a. (RebaseMap -&gt; RebaseMap) -&gt; OffsetM a -&gt; OffsetM a
</span><a href="Futhark.Pass.ExpandAllocations.html#localRebaseMap"><span class="hs-identifier hs-var">localRebaseMap</span></a></span><span> </span><span class="annot"><span class="annottext">RebaseMap -&gt; RebaseMap
</span><a href="#local-6989586621684441560"><span class="hs-identifier hs-var">extend</span></a></span><span> </span><span class="annot"><span class="annottext">(OffsetM a -&gt; OffsetM a) -&gt; OffsetM a -&gt; OffsetM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-674"></span><span>    </span><span id="local-6989586621684441559"><span class="annot"><span class="annottext">[Param (MemInfo SubExp Uniqueness MemBind)]
</span><a href="#local-6989586621684441559"><span class="hs-identifier hs-var">params'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp Uniqueness MemBind)
 -&gt; OffsetM (Param (MemInfo SubExp Uniqueness MemBind)))
-&gt; [Param (MemInfo SubExp Uniqueness MemBind)]
-&gt; OffsetM [Param (MemInfo SubExp Uniqueness MemBind)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp Uniqueness MemBind)
-&gt; OffsetM (Param (MemInfo SubExp Uniqueness MemBind))
forall u. Param (MemBound u) -&gt; OffsetM (Param (MemBound u))
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInParam"><span class="hs-identifier hs-var">offsetMemoryInParam</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (MemInfo SubExp Uniqueness MemBind)]
</span><a href="#local-6989586621684441562"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-675"></span><span>    </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)] -&gt; OffsetM a
</span><a href="#local-6989586621684441563"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">([(FParam GPUMem, SubExp)] -&gt; OffsetM a)
-&gt; [(FParam GPUMem, SubExp)] -&gt; OffsetM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param (MemInfo SubExp Uniqueness MemBind)]
-&gt; [SubExp]
-&gt; [(Param (MemInfo SubExp Uniqueness MemBind), SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param (MemInfo SubExp Uniqueness MemBind)]
</span><a href="#local-6989586621684441559"><span class="hs-identifier hs-var">params'</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684441561"><span class="hs-identifier hs-var">args</span></a></span><span>
</span><span id="line-676"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-677"></span><span>    </span><span id="local-6989586621684441560"><span class="annot"><span class="annottext">extend :: RebaseMap -&gt; RebaseMap
</span><a href="#local-6989586621684441560"><span class="hs-identifier hs-var hs-var">extend</span></a></span></span><span> </span><span id="local-6989586621684441558"><span class="annot"><span class="annottext">RebaseMap
</span><a href="#local-6989586621684441558"><span class="hs-identifier hs-var">rm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RebaseMap
 -&gt; (Param (MemInfo SubExp Uniqueness MemBind), SubExp)
 -&gt; RebaseMap)
-&gt; RebaseMap
-&gt; [(Param (MemInfo SubExp Uniqueness MemBind), SubExp)]
-&gt; RebaseMap
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">RebaseMap
-&gt; (Param (MemInfo SubExp Uniqueness MemBind), SubExp) -&gt; RebaseMap
forall {a} {dec}. Map VName a -&gt; (Param dec, SubExp) -&gt; Map VName a
</span><a href="#local-6989586621684441557"><span class="hs-identifier hs-var">onParamArg</span></a></span><span> </span><span class="annot"><span class="annottext">RebaseMap
</span><a href="#local-6989586621684441558"><span class="hs-identifier hs-var">rm</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
[(Param (MemInfo SubExp Uniqueness MemBind), SubExp)]
</span><a href="#local-6989586621684441564"><span class="hs-identifier hs-var">merge</span></a></span><span>
</span><span id="line-678"></span><span>    </span><span id="local-6989586621684441557"><span class="annot"><span class="annottext">onParamArg :: Map VName a -&gt; (Param dec, SubExp) -&gt; Map VName a
</span><a href="#local-6989586621684441557"><span class="hs-identifier hs-var hs-var">onParamArg</span></a></span></span><span> </span><span id="local-6989586621684441554"><span class="annot"><span class="annottext">Map VName a
</span><a href="#local-6989586621684441554"><span class="hs-identifier hs-var">rm</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441553"><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684441553"><span class="hs-identifier hs-var">param</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684441552"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441552"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684441551"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684441551"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName a -&gt; Maybe a
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441552"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName a
</span><a href="#local-6989586621684441554"><span class="hs-identifier hs-var">rm</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-680"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; a -&gt; Map VName a -&gt; Map VName a
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param dec -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684441553"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684441551"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName a
</span><a href="#local-6989586621684441554"><span class="hs-identifier hs-var">rm</span></a></span><span>
</span><span id="line-681"></span><span>    </span><span class="annot"><a href="#local-6989586621684441557"><span class="hs-identifier hs-var">onParamArg</span></a></span><span> </span><span id="local-6989586621684441549"><span class="annot"><span class="annottext">Map VName a
</span><a href="#local-6989586621684441549"><span class="hs-identifier hs-var">rm</span></a></span></span><span> </span><span class="annot"><span class="annottext">(Param dec, SubExp)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName a
</span><a href="#local-6989586621684441549"><span class="hs-identifier hs-var">rm</span></a></span><span>
</span><span id="line-682"></span><span>
</span><span id="line-683"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInExp"><span class="hs-identifier hs-type">offsetMemoryInExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#OffsetM"><span class="hs-identifier hs-type">OffsetM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-684"></span><span id="offsetMemoryInExp"><span class="annot"><span class="annottext">offsetMemoryInExp :: ExpT GPUMem -&gt; OffsetM (ExpT GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInExp"><span class="hs-identifier hs-var hs-var">offsetMemoryInExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span id="local-6989586621684441547"><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
</span><a href="#local-6989586621684441547"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684441546"><span class="annot"><span class="annottext">LoopForm GPUMem
</span><a href="#local-6989586621684441546"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684441545"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441545"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-685"></span><span>  </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
-&gt; ([(FParam GPUMem, SubExp)] -&gt; OffsetM (ExpT GPUMem))
-&gt; OffsetM (ExpT GPUMem)
forall a.
[(FParam GPUMem, SubExp)]
-&gt; ([(FParam GPUMem, SubExp)] -&gt; OffsetM a) -&gt; OffsetM a
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInLoopParams"><span class="hs-identifier hs-var">offsetMemoryInLoopParams</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
</span><a href="#local-6989586621684441547"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">(([(FParam GPUMem, SubExp)] -&gt; OffsetM (ExpT GPUMem))
 -&gt; OffsetM (ExpT GPUMem))
-&gt; ([(FParam GPUMem, SubExp)] -&gt; OffsetM (ExpT GPUMem))
-&gt; OffsetM (ExpT GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684441544"><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
</span><a href="#local-6989586621684441544"><span class="hs-identifier hs-var">merge'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-686"></span><span>    </span><span id="local-6989586621684441543"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441543"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-687"></span><span>      </span><span class="annot"><span class="annottext">Scope GPUMem -&gt; OffsetM (Body GPUMem) -&gt; OffsetM (Body GPUMem)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span>
</span><span id="line-688"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (MemInfo SubExp Uniqueness MemBind)] -&gt; Scope GPUMem
forall rep dec. (FParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfFParams"><span class="hs-identifier hs-var">scopeOfFParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Param (MemInfo SubExp Uniqueness MemBind), SubExp)
 -&gt; Param (MemInfo SubExp Uniqueness MemBind))
-&gt; [(Param (MemInfo SubExp Uniqueness MemBind), SubExp)]
-&gt; [Param (MemInfo SubExp Uniqueness MemBind)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param (MemInfo SubExp Uniqueness MemBind), SubExp)
-&gt; Param (MemInfo SubExp Uniqueness MemBind)
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
[(Param (MemInfo SubExp Uniqueness MemBind), SubExp)]
</span><a href="#local-6989586621684441544"><span class="hs-identifier hs-var">merge'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope GPUMem -&gt; Scope GPUMem -&gt; Scope GPUMem
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">LoopForm GPUMem -&gt; Scope GPUMem
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm GPUMem
</span><a href="#local-6989586621684441546"><span class="hs-identifier hs-var">form</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-689"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body GPUMem -&gt; OffsetM (Body GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInBody"><span class="hs-identifier hs-var">offsetMemoryInBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441545"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-690"></span><span>    </span><span class="annot"><span class="annottext">ExpT GPUMem -&gt; OffsetM (ExpT GPUMem)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(ExpT GPUMem -&gt; OffsetM (ExpT GPUMem))
-&gt; ExpT GPUMem -&gt; OffsetM (ExpT GPUMem)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
-&gt; LoopForm GPUMem -&gt; Body GPUMem -&gt; ExpT GPUMem
forall rep.
[(FParam rep, SubExp)] -&gt; LoopForm rep -&gt; BodyT rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-var">DoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam GPUMem, SubExp)]
</span><a href="#local-6989586621684441544"><span class="hs-identifier hs-var">merge'</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm GPUMem
</span><a href="#local-6989586621684441546"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441543"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-691"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInExp"><span class="hs-identifier hs-var">offsetMemoryInExp</span></a></span><span> </span><span id="local-6989586621684441541"><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684441541"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Mapper GPUMem GPUMem OffsetM
-&gt; ExpT GPUMem -&gt; OffsetM (ExpT GPUMem)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
Mapper frep trep m -&gt; Exp frep -&gt; m (Exp trep)
</span><a href="Futhark.IR.Traversals.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a></span><span> </span><span class="annot"><span class="annottext">Mapper GPUMem GPUMem OffsetM
</span><a href="#local-6989586621684441540"><span class="hs-identifier hs-var">recurse</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684441541"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-692"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-693"></span><span>    </span><span id="local-6989586621684441540"><span class="annot"><span class="annottext">recurse :: Mapper GPUMem GPUMem OffsetM
</span><a href="#local-6989586621684441540"><span class="hs-identifier hs-var hs-var">recurse</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-694"></span><span>      </span><span class="annot"><span class="annottext">Mapper GPUMem GPUMem OffsetM
forall (m :: * -&gt; *) rep. Monad m =&gt; Mapper rep rep m
</span><a href="Futhark.IR.Traversals.html#identityMapper"><span class="hs-identifier hs-var">identityMapper</span></a></span><span>
</span><span id="line-695"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnBody :: Scope GPUMem -&gt; Body GPUMem -&gt; OffsetM (Body GPUMem)
</span><a href="Futhark.IR.Traversals.html#mapOnBody"><span class="hs-identifier hs-var">mapOnBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684441537"><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441537"><span class="hs-identifier hs-var">bscope</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Scope GPUMem -&gt; OffsetM (Body GPUMem) -&gt; OffsetM (Body GPUMem)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
</span><a href="#local-6989586621684441537"><span class="hs-identifier hs-var">bscope</span></a></span><span> </span><span class="annot"><span class="annottext">(OffsetM (Body GPUMem) -&gt; OffsetM (Body GPUMem))
-&gt; (Body GPUMem -&gt; OffsetM (Body GPUMem))
-&gt; Body GPUMem
-&gt; OffsetM (Body GPUMem)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem -&gt; OffsetM (Body GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInBody"><span class="hs-identifier hs-var">offsetMemoryInBody</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-696"></span><span>          </span><span class="annot"><span class="annottext">mapOnBranchType :: BranchType GPUMem -&gt; OffsetM (BranchType GPUMem)
</span><a href="Futhark.IR.Traversals.html#mapOnBranchType"><span class="hs-identifier hs-var">mapOnBranchType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchType GPUMem -&gt; OffsetM (BranchType GPUMem)
BranchTypeMem -&gt; OffsetM BranchTypeMem
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInBodyReturns"><span class="hs-identifier hs-var">offsetMemoryInBodyReturns</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-697"></span><span>          </span><span class="annot"><span class="annottext">mapOnOp :: Op GPUMem -&gt; OffsetM (Op GPUMem)
</span><a href="Futhark.IR.Traversals.html#mapOnOp"><span class="hs-identifier hs-var">mapOnOp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Op GPUMem -&gt; OffsetM (Op GPUMem)
forall {op}.
MemOp (HostOp GPUMem op) -&gt; OffsetM (MemOp (HostOp GPUMem op))
</span><a href="#local-6989586621684441535"><span class="hs-identifier hs-var">onOp</span></a></span><span>
</span><span id="line-698"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-699"></span><span>    </span><span id="local-6989586621684441535"><span class="annot"><span class="annottext">onOp :: MemOp (HostOp GPUMem op) -&gt; OffsetM (MemOp (HostOp GPUMem op))
</span><a href="#local-6989586621684441535"><span class="hs-identifier hs-var hs-var">onOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span id="local-6989586621684441529"><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684441529"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-700"></span><span>      </span><span class="annot"><span class="annottext">HostOp GPUMem op -&gt; MemOp (HostOp GPUMem op)
forall inner. inner -&gt; MemOp inner
</span><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-var">Inner</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp GPUMem op -&gt; MemOp (HostOp GPUMem op))
-&gt; (SegOp SegLevel GPUMem -&gt; HostOp GPUMem op)
-&gt; SegOp SegLevel GPUMem
-&gt; MemOp (HostOp GPUMem op)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem -&gt; HostOp GPUMem op
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span>
</span><span id="line-701"></span><span>        </span><span class="annot"><span class="annottext">(SegOp SegLevel GPUMem -&gt; MemOp (HostOp GPUMem op))
-&gt; OffsetM (SegOp SegLevel GPUMem)
-&gt; OffsetM (MemOp (HostOp GPUMem op))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem
-&gt; OffsetM (SegOp SegLevel GPUMem)
-&gt; OffsetM (SegOp SegLevel GPUMem)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; Scope GPUMem
forall rep. SegSpace -&gt; Scope rep
</span><a href="Futhark.IR.SegOp.html#scopeOfSegSpace"><span class="hs-identifier hs-var">scopeOfSegSpace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem -&gt; SegSpace
forall lvl rep. SegOp lvl rep -&gt; SegSpace
</span><a href="Futhark.IR.SegOp.html#segSpace"><span class="hs-identifier hs-var">segSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684441529"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOpMapper SegLevel GPUMem GPUMem OffsetM
-&gt; SegOp SegLevel GPUMem -&gt; OffsetM (SegOp SegLevel GPUMem)
forall (m :: * -&gt; *) lvl frep trep.
(Applicative m, Monad m) =&gt;
SegOpMapper lvl frep trep m -&gt; SegOp lvl frep -&gt; m (SegOp lvl trep)
</span><a href="Futhark.IR.SegOp.html#mapSegOpM"><span class="hs-identifier hs-var">mapSegOpM</span></a></span><span> </span><span class="annot"><span class="annottext">SegOpMapper SegLevel GPUMem GPUMem OffsetM
forall {lvl}. SegOpMapper lvl GPUMem GPUMem OffsetM
</span><a href="#local-6989586621684441528"><span class="hs-identifier hs-var">segOpMapper</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684441529"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-702"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-703"></span><span>        </span><span id="local-6989586621684441528"><span class="annot"><span class="annottext">segOpMapper :: SegOpMapper lvl GPUMem GPUMem OffsetM
</span><a href="#local-6989586621684441528"><span class="hs-identifier hs-var hs-var">segOpMapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-704"></span><span>          </span><span class="annot"><span class="annottext">SegOpMapper lvl Any Any OffsetM
forall (m :: * -&gt; *) lvl rep. Monad m =&gt; SegOpMapper lvl rep rep m
</span><a href="Futhark.IR.SegOp.html#identitySegOpMapper"><span class="hs-identifier hs-var">identitySegOpMapper</span></a></span><span>
</span><span id="line-705"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnSegOpBody :: KernelBody GPUMem -&gt; OffsetM (KernelBody GPUMem)
</span><a href="Futhark.IR.SegOp.html#mapOnSegOpBody"><span class="hs-identifier hs-var">mapOnSegOpBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; OffsetM (KernelBody GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInKernelBody"><span class="hs-identifier hs-var">offsetMemoryInKernelBody</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-706"></span><span>              </span><span class="annot"><span class="annottext">mapOnSegOpLambda :: Lambda GPUMem -&gt; OffsetM (Lambda GPUMem)
</span><a href="Futhark.IR.SegOp.html#mapOnSegOpLambda"><span class="hs-identifier hs-var">mapOnSegOpLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; OffsetM (Lambda GPUMem)
</span><a href="Futhark.Pass.ExpandAllocations.html#offsetMemoryInLambda"><span class="hs-identifier hs-var">offsetMemoryInLambda</span></a></span><span>
</span><span id="line-707"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-708"></span><span>    </span><span class="annot"><a href="#local-6989586621684441535"><span class="hs-identifier hs-var">onOp</span></a></span><span> </span><span id="local-6989586621684441526"><span class="annot"><span class="annottext">MemOp (HostOp GPUMem op)
</span><a href="#local-6989586621684441526"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MemOp (HostOp GPUMem op) -&gt; OffsetM (MemOp (HostOp GPUMem op))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">MemOp (HostOp GPUMem op)
</span><a href="#local-6989586621684441526"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-709"></span><span>
</span><span id="line-710"></span><span class="hs-comment">---- Slicing allocation sizes out of a kernel.</span><span>
</span><span id="line-711"></span><span>
</span><span id="line-712"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#unAllocGPUStms"><span class="hs-identifier hs-type">unAllocGPUStms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Either</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU.GPU</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-713"></span><span id="unAllocGPUStms"><span class="annot"><span class="annottext">unAllocGPUStms :: Stms GPUMem -&gt; Either String (Stms GPU)
</span><a href="Futhark.Pass.ExpandAllocations.html#unAllocGPUStms"><span class="hs-identifier hs-var hs-var">unAllocGPUStms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Stms GPUMem -&gt; Either String (Stms GPU)
</span><a href="#local-6989586621684441524"><span class="hs-identifier hs-var">unAllocStms</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-714"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-715"></span><span>    </span><span id="local-6989586621684441523"><span class="annot"><span class="annottext">unAllocBody :: Body GPUMem -&gt; Either String (BodyT GPU)
</span><a href="#local-6989586621684441523"><span class="hs-identifier hs-var hs-var">unAllocBody</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span id="local-6989586621684441522"><span class="annot"><span class="annottext">BodyDec GPUMem
</span><a href="#local-6989586621684441522"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621684441521"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441521"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684441520"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684441520"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-716"></span><span>      </span><span class="annot"><span class="annottext">BodyDec GPU -&gt; Stms GPU -&gt; Result -&gt; BodyT GPU
forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec GPU
BodyDec GPUMem
</span><a href="#local-6989586621684441522"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; Result -&gt; BodyT GPU)
-&gt; Either String (Stms GPU) -&gt; Either String (Result -&gt; BodyT GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Stms GPUMem -&gt; Either String (Stms GPU)
</span><a href="#local-6989586621684441524"><span class="hs-identifier hs-var">unAllocStms</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441521"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Either String (Result -&gt; BodyT GPU)
-&gt; Either String Result -&gt; Either String (BodyT GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Result -&gt; Either String Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684441520"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-717"></span><span>
</span><span id="line-718"></span><span>    </span><span id="local-6989586621684441519"><span class="annot"><span class="annottext">unAllocKernelBody :: KernelBody GPUMem -&gt; Either String (KernelBody GPU)
</span><a href="#local-6989586621684441519"><span class="hs-identifier hs-var hs-var">unAllocKernelBody</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span id="local-6989586621684441517"><span class="annot"><span class="annottext">BodyDec GPUMem
</span><a href="#local-6989586621684441517"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621684441516"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441516"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684441515"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684441515"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-719"></span><span>      </span><span class="annot"><span class="annottext">BodyDec GPU -&gt; Stms GPU -&gt; [KernelResult] -&gt; KernelBody GPU
forall rep.
BodyDec rep -&gt; Stms rep -&gt; [KernelResult] -&gt; KernelBody rep
</span><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-var">KernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec GPU
BodyDec GPUMem
</span><a href="#local-6989586621684441517"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPU -&gt; [KernelResult] -&gt; KernelBody GPU)
-&gt; Either String (Stms GPU)
-&gt; Either String ([KernelResult] -&gt; KernelBody GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Stms GPUMem -&gt; Either String (Stms GPU)
</span><a href="#local-6989586621684441524"><span class="hs-identifier hs-var">unAllocStms</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441516"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Either String ([KernelResult] -&gt; KernelBody GPU)
-&gt; Either String [KernelResult] -&gt; Either String (KernelBody GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[KernelResult] -&gt; Either String [KernelResult]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684441515"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-720"></span><span>
</span><span id="line-721"></span><span>    </span><span id="local-6989586621684441524"><span class="annot"><span class="annottext">unAllocStms :: Bool -&gt; Stms GPUMem -&gt; Either String (Stms GPU)
</span><a href="#local-6989586621684441524"><span class="hs-identifier hs-var hs-var">unAllocStms</span></a></span></span><span> </span><span id="local-6989586621684441514"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684441514"><span class="hs-identifier hs-var">nested</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-722"></span><span>      </span><span class="annot"><span class="annottext">([Maybe (Stm GPU)] -&gt; Stms GPU)
-&gt; Either String [Maybe (Stm GPU)] -&gt; Either String (Stms GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stm GPU] -&gt; Stms GPU
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm GPU] -&gt; Stms GPU)
-&gt; ([Maybe (Stm GPU)] -&gt; [Stm GPU])
-&gt; [Maybe (Stm GPU)]
-&gt; Stms GPU
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[Maybe (Stm GPU)] -&gt; [Stm GPU]
forall a. [Maybe a] -&gt; [a]
</span><span class="hs-identifier hs-var">catMaybes</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Either String [Maybe (Stm GPU)] -&gt; Either String (Stms GPU))
-&gt; (Stms GPUMem -&gt; Either String [Maybe (Stm GPU)])
-&gt; Stms GPUMem
-&gt; Either String (Stms GPU)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Stm GPUMem -&gt; Either String (Maybe (Stm GPU)))
-&gt; [Stm GPUMem] -&gt; Either String [Maybe (Stm GPU)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Stm GPUMem -&gt; Either String (Maybe (Stm GPU))
</span><a href="#local-6989586621684441513"><span class="hs-identifier hs-var">unAllocStm</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684441514"><span class="hs-identifier hs-var">nested</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Stm GPUMem] -&gt; Either String [Maybe (Stm GPU)])
-&gt; (Stms GPUMem -&gt; [Stm GPUMem])
-&gt; Stms GPUMem
-&gt; Either String [Maybe (Stm GPU)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; [Stm GPUMem]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span>
</span><span id="line-723"></span><span>
</span><span id="line-724"></span><span>    </span><span id="local-6989586621684441513"><span class="annot"><span class="annottext">unAllocStm :: Bool -&gt; Stm GPUMem -&gt; Either String (Maybe (Stm GPU))
</span><a href="#local-6989586621684441513"><span class="hs-identifier hs-var hs-var">unAllocStm</span></a></span></span><span> </span><span id="local-6989586621684441512"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684441512"><span class="hs-identifier hs-var">nested</span></a></span></span><span> </span><span id="local-6989586621684441511"><span class="annot"><span class="annottext">stm :: Stm GPUMem
</span><a href="#local-6989586621684441511"><span class="hs-identifier hs-var">stm</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-725"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684441512"><span class="hs-identifier hs-var">nested</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String (Maybe (Stm GPU))
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Either String (Maybe (Stm GPU)))
-&gt; String -&gt; Either String (Maybe (Stm GPU))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Cannot handle nested allocation: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Stm GPUMem
</span><a href="#local-6989586621684441511"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-726"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Stm GPU) -&gt; Either String (Maybe (Stm GPU))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Stm GPU)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-727"></span><span>    </span><span class="annot"><a href="#local-6989586621684441513"><span class="hs-identifier hs-var">unAllocStm</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684441510"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684441510"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684441509"><span class="annot"><span class="annottext">StmAux (ExpDec GPUMem)
</span><a href="#local-6989586621684441509"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621684441508"><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684441508"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-728"></span><span>      </span><span class="annot"><span class="annottext">Stm GPU -&gt; Maybe (Stm GPU)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Stm GPU -&gt; Maybe (Stm GPU))
-&gt; Either String (Stm GPU) -&gt; Either String (Maybe (Stm GPU))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT (TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; StmAux () -&gt; ExpT GPU -&gt; Stm GPU
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT (TypeBase (ShapeBase SubExp) NoUniqueness)
 -&gt; StmAux () -&gt; ExpT GPU -&gt; Stm GPU)
-&gt; Either String (PatT (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; Either String (StmAux () -&gt; ExpT GPU -&gt; Stm GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">PatT (MemInfo SubExp NoUniqueness MemBind)
-&gt; Either String (PatT (TypeBase (ShapeBase SubExp) NoUniqueness))
forall {d} {u} {ret} {a}.
PatT (MemInfo d u ret)
-&gt; Either a (PatT (TypeBase (ShapeBase d) u))
</span><a href="#local-6989586621684441507"><span class="hs-identifier hs-var">unAllocPat</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT (MemInfo SubExp NoUniqueness MemBind)
</span><a href="#local-6989586621684441510"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Either String (StmAux () -&gt; ExpT GPU -&gt; Stm GPU)
-&gt; Either String (StmAux ()) -&gt; Either String (ExpT GPU -&gt; Stm GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">StmAux () -&gt; Either String (StmAux ())
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec GPUMem)
</span><a href="#local-6989586621684441509"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">Either String (ExpT GPU -&gt; Stm GPU)
-&gt; Either String (ExpT GPU) -&gt; Either String (Stm GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Mapper GPUMem GPU (Either String)
-&gt; ExpT GPUMem -&gt; Either String (ExpT GPU)
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
Mapper frep trep m -&gt; Exp frep -&gt; m (Exp trep)
</span><a href="Futhark.IR.Traversals.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a></span><span> </span><span class="annot"><span class="annottext">Mapper GPUMem GPU (Either String)
</span><a href="#local-6989586621684441506"><span class="hs-identifier hs-var">unAlloc'</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT GPUMem
</span><a href="#local-6989586621684441508"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-729"></span><span>
</span><span id="line-730"></span><span>    </span><span id="local-6989586621684441505"><span class="annot"><span class="annottext">unAllocLambda :: Lambda GPUMem -&gt; Either String (Lambda GPU)
</span><a href="#local-6989586621684441505"><span class="hs-identifier hs-var hs-var">unAllocLambda</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span id="local-6989586621684441504"><span class="annot"><span class="annottext">[LParam GPUMem]
</span><a href="#local-6989586621684441504"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684441503"><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441503"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621684441502"><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684441502"><span class="hs-identifier hs-var">ret</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-731"></span><span>      </span><span class="annot"><span class="annottext">[LParam GPU]
-&gt; BodyT GPU
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; Lambda GPU
forall rep.
[LParam rep]
-&gt; BodyT rep
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Param (MemInfo SubExp NoUniqueness MemBind)
 -&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; [Param (MemInfo SubExp NoUniqueness MemBind)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness)
forall {d} {u} {ret}.
Param (MemInfo d u ret) -&gt; Param (TypeBase (ShapeBase d) u)
</span><a href="#local-6989586621684441501"><span class="hs-identifier hs-var">unParam</span></a></span><span> </span><span class="annot"><span class="annottext">[LParam GPUMem]
[Param (MemInfo SubExp NoUniqueness MemBind)]
</span><a href="#local-6989586621684441504"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(BodyT GPU
 -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Lambda GPU)
-&gt; Either String (BodyT GPU)
-&gt; Either
     String ([TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Lambda GPU)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem -&gt; Either String (BodyT GPU)
</span><a href="#local-6989586621684441523"><span class="hs-identifier hs-var">unAllocBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body GPUMem
</span><a href="#local-6989586621684441503"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">Either
  String ([TypeBase (ShapeBase SubExp) NoUniqueness] -&gt; Lambda GPU)
-&gt; Either String [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; Either String (Lambda GPU)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; Either String [TypeBase (ShapeBase SubExp) NoUniqueness]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684441502"><span class="hs-identifier hs-var">ret</span></a></span><span>
</span><span id="line-732"></span><span>
</span><span id="line-733"></span><span>    </span><span id="local-6989586621684441507"><span class="annot"><span class="annottext">unAllocPat :: PatT (MemInfo d u ret)
-&gt; Either a (PatT (TypeBase (ShapeBase d) u))
</span><a href="#local-6989586621684441507"><span class="hs-identifier hs-var hs-var">unAllocPat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span id="local-6989586621684441496"><span class="annot"><span class="annottext">[PatElemT (MemInfo d u ret)]
</span><a href="#local-6989586621684441496"><span class="hs-identifier hs-var">pes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-734"></span><span>      </span><span class="annot"><span class="annottext">[PatElemT (TypeBase (ShapeBase d) u)]
-&gt; PatT (TypeBase (ShapeBase d) u)
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT (TypeBase (ShapeBase d) u)]
 -&gt; PatT (TypeBase (ShapeBase d) u))
-&gt; Either a [PatElemT (TypeBase (ShapeBase d) u)]
-&gt; Either a (PatT (TypeBase (ShapeBase d) u))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (MemInfo d u ret)
 -&gt; Either a (PatElemT (TypeBase (ShapeBase d) u)))
-&gt; [PatElemT (MemInfo d u ret)]
-&gt; Either a [PatElemT (TypeBase (ShapeBase d) u)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(MemInfo d u ret -&gt; Either a (TypeBase (ShapeBase d) u))
-&gt; PatElemT (MemInfo d u ret)
-&gt; Either a (PatElemT (TypeBase (ShapeBase d) u))
forall (m :: * -&gt; *) from to.
Monad m =&gt;
(from -&gt; m to) -&gt; PatElemT from -&gt; m (PatElemT to)
</span><a href="Futhark.Analysis.Rephrase.html#rephrasePatElem"><span class="hs-identifier hs-var">rephrasePatElem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase (ShapeBase d) u -&gt; Either a (TypeBase (ShapeBase d) u)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase d) u -&gt; Either a (TypeBase (ShapeBase d) u))
-&gt; (MemInfo d u ret -&gt; TypeBase (ShapeBase d) u)
-&gt; MemInfo d u ret
-&gt; Either a (TypeBase (ShapeBase d) u)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MemInfo d u ret -&gt; TypeBase (ShapeBase d) u
forall d u ret. MemInfo d u ret -&gt; TypeBase (ShapeBase d) u
</span><a href="Futhark.Pass.ExpandAllocations.html#unMem"><span class="hs-identifier hs-var">unMem</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT (MemInfo d u ret)]
</span><a href="#local-6989586621684441496"><span class="hs-identifier hs-var">pes</span></a></span><span>
</span><span id="line-735"></span><span>
</span><span id="line-736"></span><span>    </span><span id="local-6989586621684441493"><span class="annot"><span class="annottext">unAllocOp :: MemOp (HostOp GPUMem ()) -&gt; Either String (HostOp GPU (SOAC GPU))
</span><a href="#local-6989586621684441493"><span class="hs-identifier hs-var hs-var">unAllocOp</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String (HostOp GPU (SOAC GPU))
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unAllocOp: unhandled Alloc&quot;</span></span><span>
</span><span id="line-737"></span><span>    </span><span class="annot"><a href="#local-6989586621684441493"><span class="hs-identifier hs-var">unAllocOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#OtherOp"><span class="hs-identifier hs-type">OtherOp</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Either String (HostOp GPU (SOAC GPU))
forall a b. a -&gt; Either a b
</span><span class="hs-identifier hs-var">Left</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;unAllocOp: unhandled OtherOp&quot;</span></span><span>
</span><span id="line-738"></span><span>    </span><span class="annot"><a href="#local-6989586621684441493"><span class="hs-identifier hs-var">unAllocOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SizeOp"><span class="hs-identifier hs-type">SizeOp</span></a></span><span> </span><span id="local-6989586621684441490"><span class="annot"><span class="annottext">SizeOp
</span><a href="#local-6989586621684441490"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostOp GPU (SOAC GPU) -&gt; Either String (HostOp GPU (SOAC GPU))
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(HostOp GPU (SOAC GPU) -&gt; Either String (HostOp GPU (SOAC GPU)))
-&gt; HostOp GPU (SOAC GPU) -&gt; Either String (HostOp GPU (SOAC GPU))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SizeOp -&gt; HostOp GPU (SOAC GPU)
forall rep op. SizeOp -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SizeOp"><span class="hs-identifier hs-var">SizeOp</span></a></span><span> </span><span class="annot"><span class="annottext">SizeOp
</span><a href="#local-6989586621684441490"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-739"></span><span>    </span><span class="annot"><a href="#local-6989586621684441493"><span class="hs-identifier hs-var">unAllocOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span id="local-6989586621684441489"><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684441489"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPU -&gt; HostOp GPU (SOAC GPU)
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp SegLevel GPU -&gt; HostOp GPU (SOAC GPU))
-&gt; Either String (SegOp SegLevel GPU)
-&gt; Either String (HostOp GPU (SOAC GPU))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SegOpMapper SegLevel GPUMem GPU (Either String)
-&gt; SegOp SegLevel GPUMem -&gt; Either String (SegOp SegLevel GPU)
forall (m :: * -&gt; *) lvl frep trep.
(Applicative m, Monad m) =&gt;
SegOpMapper lvl frep trep m -&gt; SegOp lvl frep -&gt; m (SegOp lvl trep)
</span><a href="Futhark.IR.SegOp.html#mapSegOpM"><span class="hs-identifier hs-var">mapSegOpM</span></a></span><span> </span><span class="annot"><span class="annottext">SegOpMapper SegLevel GPUMem GPU (Either String)
</span><a href="#local-6989586621684441488"><span class="hs-identifier hs-var">mapper</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684441489"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-740"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-741"></span><span>        </span><span id="local-6989586621684441488"><span class="annot"><span class="annottext">mapper :: SegOpMapper SegLevel GPUMem GPU (Either String)
</span><a href="#local-6989586621684441488"><span class="hs-identifier hs-var hs-var">mapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-742"></span><span>          </span><span class="annot"><span class="annottext">SegOpMapper SegLevel Any Any (Either String)
forall (m :: * -&gt; *) lvl rep. Monad m =&gt; SegOpMapper lvl rep rep m
</span><a href="Futhark.IR.SegOp.html#identitySegOpMapper"><span class="hs-identifier hs-var">identitySegOpMapper</span></a></span><span>
</span><span id="line-743"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnSegOpLambda :: Lambda GPUMem -&gt; Either String (Lambda GPU)
</span><a href="Futhark.IR.SegOp.html#mapOnSegOpLambda"><span class="hs-identifier hs-var">mapOnSegOpLambda</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; Either String (Lambda GPU)
</span><a href="#local-6989586621684441505"><span class="hs-identifier hs-var">unAllocLambda</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-744"></span><span>              </span><span class="annot"><span class="annottext">mapOnSegOpBody :: KernelBody GPUMem -&gt; Either String (KernelBody GPU)
</span><a href="Futhark.IR.SegOp.html#mapOnSegOpBody"><span class="hs-identifier hs-var">mapOnSegOpBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem -&gt; Either String (KernelBody GPU)
</span><a href="#local-6989586621684441519"><span class="hs-identifier hs-var">unAllocKernelBody</span></a></span><span>
</span><span id="line-745"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-746"></span><span>
</span><span id="line-747"></span><span>    </span><span id="local-6989586621684441501"><span class="annot"><span class="annottext">unParam :: Param (MemInfo d u ret) -&gt; Param (TypeBase (ShapeBase d) u)
</span><a href="#local-6989586621684441501"><span class="hs-identifier hs-var hs-var">unParam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(MemInfo d u ret -&gt; TypeBase (ShapeBase d) u)
-&gt; Param (MemInfo d u ret) -&gt; Param (TypeBase (ShapeBase d) u)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">MemInfo d u ret -&gt; TypeBase (ShapeBase d) u
forall d u ret. MemInfo d u ret -&gt; TypeBase (ShapeBase d) u
</span><a href="Futhark.Pass.ExpandAllocations.html#unMem"><span class="hs-identifier hs-var">unMem</span></a></span><span>
</span><span id="line-748"></span><span>
</span><span id="line-749"></span><span>    </span><span id="local-6989586621684441485"><span class="annot"><span class="annottext">unT :: MemInfo d u ret -&gt; Either a (TypeBase (ShapeBase d) u)
</span><a href="#local-6989586621684441485"><span class="hs-identifier hs-var hs-var">unT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeBase (ShapeBase d) u -&gt; Either a (TypeBase (ShapeBase d) u)
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase d) u -&gt; Either a (TypeBase (ShapeBase d) u))
-&gt; (MemInfo d u ret -&gt; TypeBase (ShapeBase d) u)
-&gt; MemInfo d u ret
-&gt; Either a (TypeBase (ShapeBase d) u)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">MemInfo d u ret -&gt; TypeBase (ShapeBase d) u
forall d u ret. MemInfo d u ret -&gt; TypeBase (ShapeBase d) u
</span><a href="Futhark.Pass.ExpandAllocations.html#unMem"><span class="hs-identifier hs-var">unMem</span></a></span><span>
</span><span id="line-750"></span><span>
</span><span id="line-751"></span><span>    </span><span id="local-6989586621684441506"><span class="annot"><span class="annottext">unAlloc' :: Mapper GPUMem GPU (Either String)
</span><a href="#local-6989586621684441506"><span class="hs-identifier hs-var hs-var">unAlloc'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-752"></span><span>      </span><span class="annot"><span class="annottext">Mapper :: forall frep trep (m :: * -&gt; *).
(SubExp -&gt; m SubExp)
-&gt; (Scope trep -&gt; Body frep -&gt; m (Body trep))
-&gt; (VName -&gt; m VName)
-&gt; (RetType frep -&gt; m (RetType trep))
-&gt; (BranchType frep -&gt; m (BranchType trep))
-&gt; (FParam frep -&gt; m (FParam trep))
-&gt; (LParam frep -&gt; m (LParam trep))
-&gt; (Op frep -&gt; m (Op trep))
-&gt; Mapper frep trep m
</span><a href="Futhark.IR.Traversals.html#Mapper"><span class="hs-identifier hs-type">Mapper</span></a></span><span>
</span><span id="line-753"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnBody :: Scope GPU -&gt; Body GPUMem -&gt; Either String (BodyT GPU)
</span><a href="Futhark.IR.Traversals.html#mapOnBody"><span class="hs-identifier hs-var">mapOnBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Body GPUMem -&gt; Either String (BodyT GPU))
-&gt; Scope GPU -&gt; Body GPUMem -&gt; Either String (BodyT GPU)
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">Body GPUMem -&gt; Either String (BodyT GPU)
</span><a href="#local-6989586621684441523"><span class="hs-identifier hs-var">unAllocBody</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-754"></span><span>          </span><span class="annot"><span class="annottext">mapOnRetType :: RetType GPUMem -&gt; Either String (RetType GPU)
</span><a href="Futhark.IR.Traversals.html#mapOnRetType"><span class="hs-identifier hs-var">mapOnRetType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetType GPUMem -&gt; Either String (RetType GPU)
forall {d} {u} {ret} {a}.
MemInfo d u ret -&gt; Either a (TypeBase (ShapeBase d) u)
</span><a href="#local-6989586621684441485"><span class="hs-identifier hs-var">unT</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-755"></span><span>          </span><span class="annot"><span class="annottext">mapOnBranchType :: BranchType GPUMem -&gt; Either String (BranchType GPU)
</span><a href="Futhark.IR.Traversals.html#mapOnBranchType"><span class="hs-identifier hs-var">mapOnBranchType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BranchType GPUMem -&gt; Either String (BranchType GPU)
forall {d} {u} {ret} {a}.
MemInfo d u ret -&gt; Either a (TypeBase (ShapeBase d) u)
</span><a href="#local-6989586621684441485"><span class="hs-identifier hs-var">unT</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-756"></span><span>          </span><span class="annot"><span class="annottext">mapOnFParam :: FParam GPUMem -&gt; Either String (FParam GPU)
</span><a href="Futhark.IR.Traversals.html#mapOnFParam"><span class="hs-identifier hs-var">mapOnFParam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) Uniqueness)
-&gt; Either String (Param (TypeBase (ShapeBase SubExp) Uniqueness))
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(Param (TypeBase (ShapeBase SubExp) Uniqueness)
 -&gt; Either String (Param (TypeBase (ShapeBase SubExp) Uniqueness)))
-&gt; (Param (MemInfo SubExp Uniqueness MemBind)
    -&gt; Param (TypeBase (ShapeBase SubExp) Uniqueness))
-&gt; Param (MemInfo SubExp Uniqueness MemBind)
-&gt; Either String (Param (TypeBase (ShapeBase SubExp) Uniqueness))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp Uniqueness MemBind)
-&gt; Param (TypeBase (ShapeBase SubExp) Uniqueness)
forall {d} {u} {ret}.
Param (MemInfo d u ret) -&gt; Param (TypeBase (ShapeBase d) u)
</span><a href="#local-6989586621684441501"><span class="hs-identifier hs-var">unParam</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-757"></span><span>          </span><span class="annot"><span class="annottext">mapOnLParam :: LParam GPUMem -&gt; Either String (LParam GPU)
</span><a href="Futhark.IR.Traversals.html#mapOnLParam"><span class="hs-identifier hs-var">mapOnLParam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
-&gt; Either String (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span> </span><span class="annot"><span class="annottext">(Param (TypeBase (ShapeBase SubExp) NoUniqueness)
 -&gt; Either
      String (Param (TypeBase (ShapeBase SubExp) NoUniqueness)))
-&gt; (Param (MemInfo SubExp NoUniqueness MemBind)
    -&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; Either String (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Param (MemInfo SubExp NoUniqueness MemBind)
-&gt; Param (TypeBase (ShapeBase SubExp) NoUniqueness)
forall {d} {u} {ret}.
Param (MemInfo d u ret) -&gt; Param (TypeBase (ShapeBase d) u)
</span><a href="#local-6989586621684441501"><span class="hs-identifier hs-var">unParam</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-758"></span><span>          </span><span class="annot"><span class="annottext">mapOnOp :: Op GPUMem -&gt; Either String (Op GPU)
</span><a href="Futhark.IR.Traversals.html#mapOnOp"><span class="hs-identifier hs-var">mapOnOp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Op GPUMem -&gt; Either String (Op GPU)
MemOp (HostOp GPUMem ()) -&gt; Either String (HostOp GPU (SOAC GPU))
</span><a href="#local-6989586621684441493"><span class="hs-identifier hs-var">unAllocOp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-759"></span><span>          </span><span class="annot"><span class="annottext">mapOnSubExp :: SubExp -&gt; Either String SubExp
</span><a href="Futhark.IR.Traversals.html#mapOnSubExp"><span class="hs-identifier hs-var">mapOnSubExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; Either String SubExp
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span class="hs-special">,</span><span>
</span><span id="line-760"></span><span>          </span><span class="annot"><span class="annottext">mapOnVName :: VName -&gt; Either String VName
</span><a href="Futhark.IR.Traversals.html#mapOnVName"><span class="hs-identifier hs-var">mapOnVName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Either String VName
forall a b. b -&gt; Either a b
</span><span class="hs-identifier hs-var">Right</span></span><span>
</span><span id="line-761"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-762"></span><span>
</span><span id="line-763"></span><span id="local-6989586621684443041"><span id="local-6989586621684443042"><span id="local-6989586621684443043"><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#unMem"><span class="hs-identifier hs-type">unMem</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemInfo"><span class="hs-identifier hs-type">MemInfo</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443043"><span class="hs-identifier hs-type">d</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443042"><span class="hs-identifier hs-type">u</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443041"><span class="hs-identifier hs-type">ret</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#ShapeBase"><span class="hs-identifier hs-type">ShapeBase</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684443043"><span class="hs-identifier hs-type">d</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684443042"><span class="hs-identifier hs-type">u</span></a></span></span></span></span><span>
</span><span id="line-764"></span><span id="unMem"><span class="annot"><span class="annottext">unMem :: forall d u ret. MemInfo d u ret -&gt; TypeBase (ShapeBase d) u
</span><a href="Futhark.Pass.ExpandAllocations.html#unMem"><span class="hs-identifier hs-var hs-var">unMem</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemPrim"><span class="hs-identifier hs-type">MemPrim</span></a></span><span> </span><span id="local-6989586621684441477"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441477"><span class="hs-identifier hs-var">pt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TypeBase (ShapeBase d) u
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441477"><span class="hs-identifier hs-var">pt</span></a></span><span>
</span><span id="line-765"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#unMem"><span class="hs-identifier hs-var">unMem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemArray"><span class="hs-identifier hs-type">MemArray</span></a></span><span> </span><span id="local-6989586621684441475"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441475"><span class="hs-identifier hs-var">pt</span></a></span></span><span> </span><span id="local-6989586621684441474"><span class="annot"><span class="annottext">ShapeBase d
</span><a href="#local-6989586621684441474"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684441473"><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684441473"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="annot"><span class="annottext">ret
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ShapeBase d -&gt; u -&gt; TypeBase (ShapeBase d) u
forall shape u. PrimType -&gt; shape -&gt; u -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684441475"><span class="hs-identifier hs-var">pt</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase d
</span><a href="#local-6989586621684441474"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684441473"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-766"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#unMem"><span class="hs-identifier hs-var">unMem</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#MemAcc"><span class="hs-identifier hs-type">MemAcc</span></a></span><span> </span><span id="local-6989586621684441470"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441470"><span class="hs-identifier hs-var">acc</span></a></span></span><span> </span><span id="local-6989586621684441469"><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684441469"><span class="hs-identifier hs-var">ispace</span></a></span></span><span> </span><span id="local-6989586621684441468"><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684441468"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684441467"><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684441467"><span class="hs-identifier hs-var">u</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; ShapeBase SubExp
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; u
-&gt; TypeBase (ShapeBase d) u
forall shape u.
VName
-&gt; ShapeBase SubExp
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; u
-&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-var">Acc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441470"><span class="hs-identifier hs-var">acc</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase SubExp
</span><a href="#local-6989586621684441469"><span class="hs-identifier hs-var">ispace</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684441468"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="annot"><span class="annottext">u
</span><a href="#local-6989586621684441467"><span class="hs-identifier hs-var">u</span></a></span><span>
</span><span id="line-767"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#unMem"><span class="hs-identifier hs-var">unMem</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.html#MemMem"><span class="hs-identifier hs-type">MemMem</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TypeBase (ShapeBase d) u
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Primitive.html#Unit"><span class="hs-identifier hs-var">Unit</span></a></span><span>
</span><span id="line-768"></span><span>
</span><span id="line-769"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#unAllocScope"><span class="hs-identifier hs-type">unAllocScope</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU.GPU</span></a></span><span>
</span><span id="line-770"></span><span id="unAllocScope"><span class="annot"><span class="annottext">unAllocScope :: Scope GPUMem -&gt; Scope GPU
</span><a href="Futhark.Pass.ExpandAllocations.html#unAllocScope"><span class="hs-identifier hs-var hs-var">unAllocScope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(NameInfo GPUMem -&gt; NameInfo GPU) -&gt; Scope GPUMem -&gt; Scope GPU
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">NameInfo GPUMem -&gt; NameInfo GPU
forall {rep} {d} {u} {ret} {rep} {d} {u} {d} {u} {ret} {ret}.
(FParamInfo rep ~ MemInfo d u ret,
 LParamInfo rep ~ TypeBase (ShapeBase d) u,
 LetDec rep ~ TypeBase (ShapeBase d) u,
 FParamInfo rep ~ TypeBase (ShapeBase d) u,
 LetDec rep ~ MemInfo d u ret, LParamInfo rep ~ MemInfo d u ret) =&gt;
NameInfo rep -&gt; NameInfo rep
</span><a href="#local-6989586621684441462"><span class="hs-identifier hs-var">unInfo</span></a></span><span>
</span><span id="line-771"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-772"></span><span>    </span><span id="local-6989586621684441462"><span class="annot"><span class="annottext">unInfo :: NameInfo rep -&gt; NameInfo rep
</span><a href="#local-6989586621684441462"><span class="hs-identifier hs-var hs-var">unInfo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LetName"><span class="hs-identifier hs-type">LetName</span></a></span><span> </span><span id="local-6989586621684441436"><span class="annot"><span class="annottext">LetDec rep
</span><a href="#local-6989586621684441436"><span class="hs-identifier hs-var">dec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LetDec rep -&gt; NameInfo rep
forall rep. LetDec rep -&gt; NameInfo rep
</span><a href="Futhark.IR.Prop.Scope.html#LetName"><span class="hs-identifier hs-var">LetName</span></a></span><span> </span><span class="annot"><span class="annottext">(LetDec rep -&gt; NameInfo rep) -&gt; LetDec rep -&gt; NameInfo rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MemInfo d u ret -&gt; TypeBase (ShapeBase d) u
forall d u ret. MemInfo d u ret -&gt; TypeBase (ShapeBase d) u
</span><a href="Futhark.Pass.ExpandAllocations.html#unMem"><span class="hs-identifier hs-var">unMem</span></a></span><span> </span><span class="annot"><span class="annottext">LetDec rep
MemInfo d u ret
</span><a href="#local-6989586621684441436"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-773"></span><span>    </span><span class="annot"><a href="#local-6989586621684441462"><span class="hs-identifier hs-var">unInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#FParamName"><span class="hs-identifier hs-type">FParamName</span></a></span><span> </span><span id="local-6989586621684441434"><span class="annot"><span class="annottext">FParamInfo rep
</span><a href="#local-6989586621684441434"><span class="hs-identifier hs-var">dec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FParamInfo rep -&gt; NameInfo rep
forall rep. FParamInfo rep -&gt; NameInfo rep
</span><a href="Futhark.IR.Prop.Scope.html#FParamName"><span class="hs-identifier hs-var">FParamName</span></a></span><span> </span><span class="annot"><span class="annottext">(FParamInfo rep -&gt; NameInfo rep) -&gt; FParamInfo rep -&gt; NameInfo rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MemInfo d u ret -&gt; TypeBase (ShapeBase d) u
forall d u ret. MemInfo d u ret -&gt; TypeBase (ShapeBase d) u
</span><a href="Futhark.Pass.ExpandAllocations.html#unMem"><span class="hs-identifier hs-var">unMem</span></a></span><span> </span><span class="annot"><span class="annottext">FParamInfo rep
MemInfo d u ret
</span><a href="#local-6989586621684441434"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-774"></span><span>    </span><span class="annot"><a href="#local-6989586621684441462"><span class="hs-identifier hs-var">unInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LParamName"><span class="hs-identifier hs-type">LParamName</span></a></span><span> </span><span id="local-6989586621684441432"><span class="annot"><span class="annottext">LParamInfo rep
</span><a href="#local-6989586621684441432"><span class="hs-identifier hs-var">dec</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LParamInfo rep -&gt; NameInfo rep
forall rep. LParamInfo rep -&gt; NameInfo rep
</span><a href="Futhark.IR.Prop.Scope.html#LParamName"><span class="hs-identifier hs-var">LParamName</span></a></span><span> </span><span class="annot"><span class="annottext">(LParamInfo rep -&gt; NameInfo rep) -&gt; LParamInfo rep -&gt; NameInfo rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">MemInfo d u ret -&gt; TypeBase (ShapeBase d) u
forall d u ret. MemInfo d u ret -&gt; TypeBase (ShapeBase d) u
</span><a href="Futhark.Pass.ExpandAllocations.html#unMem"><span class="hs-identifier hs-var">unMem</span></a></span><span> </span><span class="annot"><span class="annottext">LParamInfo rep
MemInfo d u ret
</span><a href="#local-6989586621684441432"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-775"></span><span>    </span><span class="annot"><a href="#local-6989586621684441462"><span class="hs-identifier hs-var">unInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#IndexName"><span class="hs-identifier hs-type">IndexName</span></a></span><span> </span><span id="local-6989586621684441430"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684441430"><span class="hs-identifier hs-var">it</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IntType -&gt; NameInfo rep
forall rep. IntType -&gt; NameInfo rep
</span><a href="Futhark.IR.Prop.Scope.html#IndexName"><span class="hs-identifier hs-var">IndexName</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684441430"><span class="hs-identifier hs-var">it</span></a></span><span>
</span><span id="line-776"></span><span>
</span><span id="line-777"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#removeCommonSizes"><span class="hs-identifier hs-type">removeCommonSizes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#Extraction"><span class="hs-identifier hs-type">Extraction</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-778"></span><span id="removeCommonSizes"><span class="annot"><span class="annottext">removeCommonSizes :: Extraction -&gt; [(SubExp, [(VName, Space)])]
</span><a href="Futhark.Pass.ExpandAllocations.html#removeCommonSizes"><span class="hs-identifier hs-var hs-var">removeCommonSizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map SubExp [(VName, Space)] -&gt; [(SubExp, [(VName, Space)])]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">(Map SubExp [(VName, Space)] -&gt; [(SubExp, [(VName, Space)])])
-&gt; (Extraction -&gt; Map SubExp [(VName, Space)])
-&gt; Extraction
-&gt; [(SubExp, [(VName, Space)])]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Map SubExp [(VName, Space)]
 -&gt; (VName, ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space))
 -&gt; Map SubExp [(VName, Space)])
-&gt; Map SubExp [(VName, Space)]
-&gt; [(VName, ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space))]
-&gt; Map SubExp [(VName, Space)]
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">Map SubExp [(VName, Space)]
-&gt; (VName, ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space))
-&gt; Map SubExp [(VName, Space)]
forall {k} {a} {b} {a}.
Ord k =&gt;
Map k [(a, b)] -&gt; (a, (a, k, b)) -&gt; Map k [(a, b)]
</span><a href="#local-6989586621684441429"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span class="annot"><span class="annottext">Map SubExp [(VName, Space)]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">([(VName, ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space))]
 -&gt; Map SubExp [(VName, Space)])
-&gt; (Extraction
    -&gt; [(VName, ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space))])
-&gt; Extraction
-&gt; Map SubExp [(VName, Space)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Extraction
-&gt; [(VName, ((SegLevel, [TPrimExp Int64 VName]), SubExp, Space))]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span>
</span><span id="line-779"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-780"></span><span>    </span><span id="local-6989586621684441429"><span class="annot"><span class="annottext">comb :: Map k [(a, b)] -&gt; (a, (a, k, b)) -&gt; Map k [(a, b)]
</span><a href="#local-6989586621684441429"><span class="hs-identifier hs-var hs-var">comb</span></a></span></span><span> </span><span id="local-6989586621684441426"><span class="annot"><span class="annottext">Map k [(a, b)]
</span><a href="#local-6989586621684441426"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441425"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684441425"><span class="hs-identifier hs-var">mem</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441424"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684441424"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441423"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684441423"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([(a, b)] -&gt; [(a, b)] -&gt; [(a, b)])
-&gt; k -&gt; [(a, b)] -&gt; Map k [(a, b)] -&gt; Map k [(a, b)]
forall k a. Ord k =&gt; (a -&gt; a -&gt; a) -&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insertWith</span></span><span> </span><span class="annot"><span class="annottext">[(a, b)] -&gt; [(a, b)] -&gt; [(a, b)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">(++)</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684441424"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684441425"><span class="hs-identifier hs-var">mem</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684441423"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Map k [(a, b)]
</span><a href="#local-6989586621684441426"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-781"></span><span>
</span><span id="line-782"></span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#sliceKernelSizes"><span class="hs-identifier hs-type">sliceKernelSizes</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-783"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-784"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-785"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-786"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-787"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExpandAllocations.html#ExpandM"><span class="hs-identifier hs-type">ExpandM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU.GPU</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-788"></span><span id="sliceKernelSizes"><span class="annot"><span class="annottext">sliceKernelSizes :: SubExp
-&gt; [SubExp]
-&gt; SegSpace
-&gt; Stms GPUMem
-&gt; ExpandM (Stms GPU, [VName], [VName])
</span><a href="Futhark.Pass.ExpandAllocations.html#sliceKernelSizes"><span class="hs-identifier hs-var hs-var">sliceKernelSizes</span></a></span></span><span> </span><span id="local-6989586621684441421"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441421"><span class="hs-identifier hs-var">num_threads</span></a></span></span><span> </span><span id="local-6989586621684441420"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684441420"><span class="hs-identifier hs-var">sizes</span></a></span></span><span> </span><span id="local-6989586621684441419"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684441419"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684441418"><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441418"><span class="hs-identifier hs-var">kstms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-789"></span><span>  </span><span id="local-6989586621684441417"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684441417"><span class="hs-identifier hs-var">kstms'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(String
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPU))
-&gt; (Stms GPU
    -&gt; ReaderT
         (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPU))
-&gt; Either String (Stms GPU)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPU)
forall a c b. (a -&gt; c) -&gt; (b -&gt; c) -&gt; Either a b -&gt; c
</span><span class="hs-identifier hs-var">either</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPU)
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwError</span></span><span> </span><span class="annot"><span class="annottext">Stms GPU
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPU)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Either String (Stms GPU)
 -&gt; ReaderT
      (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPU))
-&gt; Either String (Stms GPU)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem -&gt; Either String (Stms GPU)
</span><a href="Futhark.Pass.ExpandAllocations.html#unAllocGPUStms"><span class="hs-identifier hs-var">unAllocGPUStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPUMem
</span><a href="#local-6989586621684441418"><span class="hs-identifier hs-var">kstms</span></a></span><span>
</span><span id="line-790"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684441416"><span class="annot"><span class="annottext">num_sizes :: Int
</span><a href="#local-6989586621684441416"><span class="hs-identifier hs-var hs-var">num_sizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684441420"><span class="hs-identifier hs-var">sizes</span></a></span><span>
</span><span id="line-791"></span><span>      </span><span id="local-6989586621684441415"><span class="annot"><span class="annottext">i64s :: [TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684441415"><span class="hs-identifier hs-var hs-var">i64s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684441416"><span class="hs-identifier hs-var">num_sizes</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness
 -&gt; [TypeBase (ShapeBase SubExp) NoUniqueness])
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-792"></span><span>
</span><span id="line-793"></span><span>  </span><span id="local-6989586621684441412"><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684441412"><span class="hs-identifier hs-var">kernels_scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Scope GPUMem -&gt; Scope GPU)
-&gt; ReaderT
     (Scope GPUMem) (StateT VNameSource (Either String)) (Scope GPU)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">Scope GPUMem -&gt; Scope GPU
</span><a href="Futhark.Pass.ExpandAllocations.html#unAllocScope"><span class="hs-identifier hs-var">unAllocScope</span></a></span><span>
</span><span id="line-794"></span><span>
</span><span id="line-795"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684441411"><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684441411"><span class="hs-identifier hs-var">max_lam</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   (Lambda GPU)
 -&gt; Scope GPU
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      (Lambda GPU, Stms GPU))
-&gt; Scope GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Lambda GPU)
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Lambda GPU, Stms GPU)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">BuilderT
  GPU
  (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
  (Lambda GPU)
-&gt; Scope GPU
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Lambda GPU, Stms GPU)
forall (m :: * -&gt; *) rep a.
MonadFreshNames m =&gt;
BuilderT rep m a -&gt; Scope rep -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT"><span class="hs-identifier hs-var">runBuilderT</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684441412"><span class="hs-identifier hs-var">kernels_scope</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   (Lambda GPU)
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      (Lambda GPU, Stms GPU))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Lambda GPU)
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Lambda GPU, Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-796"></span><span>    </span><span id="local-6989586621684441408"><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684441408"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684441416"><span class="hs-identifier hs-var">num_sizes</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      [Param (TypeBase (ShapeBase SubExp) NoUniqueness)])
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;x&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-797"></span><span>    </span><span id="local-6989586621684441405"><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684441405"><span class="hs-identifier hs-var">ys</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684441416"><span class="hs-identifier hs-var">num_sizes</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      [Param (TypeBase (ShapeBase SubExp) NoUniqueness)])
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;y&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-798"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684441404"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684441404"><span class="hs-identifier hs-var">zs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441403"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684441403"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scope GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Result, Stms GPU)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Result, Stms GPU)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)] -&gt; Scope GPU
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([Param (TypeBase (ShapeBase SubExp) NoUniqueness)] -&gt; Scope GPU)
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)] -&gt; Scope GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684441408"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684441405"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   (Result, Stms GPU)
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      (Result, Stms GPU))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Result, Stms GPU)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Result, Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-799"></span><span>      </span><span class="annot"><span class="annottext">BuilderT
  GPU
  (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
  Result
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Result,
      Stms
        (Rep
           (BuilderT
              GPU
              (ReaderT (Scope GPUMem) (StateT VNameSource (Either String))))))
forall (m :: * -&gt; *) a.
MonadBuilder m =&gt;
m a -&gt; m (a, Stms (Rep m))
</span><a href="Futhark.Builder.Class.html#collectStms"><span class="hs-identifier hs-var">collectStms</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   Result
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      (Result,
       Stms
         (Rep
            (BuilderT
               GPU
               (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))))))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     Result
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Result,
      Stms
        (Rep
           (BuilderT
              GPU
              (ReaderT (Scope GPUMem) (StateT VNameSource (Either String))))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-800"></span><span>        </span><span class="annot"><span class="annottext">[(Param (TypeBase (ShapeBase SubExp) NoUniqueness),
  Param (TypeBase (ShapeBase SubExp) NoUniqueness))]
-&gt; ((Param (TypeBase (ShapeBase SubExp) NoUniqueness),
     Param (TypeBase (ShapeBase SubExp) NoUniqueness))
    -&gt; BuilderT
         GPU
         (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
         SubExpRes)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     Result
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [(Param (TypeBase (ShapeBase SubExp) NoUniqueness),
     Param (TypeBase (ShapeBase SubExp) NoUniqueness))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684441408"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684441405"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param (TypeBase (ShapeBase SubExp) NoUniqueness),
   Param (TypeBase (ShapeBase SubExp) NoUniqueness))
  -&gt; BuilderT
       GPU
       (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
       SubExpRes)
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      Result)
-&gt; ((Param (TypeBase (ShapeBase SubExp) NoUniqueness),
     Param (TypeBase (ShapeBase SubExp) NoUniqueness))
    -&gt; BuilderT
         GPU
         (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
         SubExpRes)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684441401"><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684441401"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441400"><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684441400"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-801"></span><span>          </span><span class="annot"><span class="annottext">(SubExp -&gt; SubExpRes)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     SubExp
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     SubExpRes
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExpRes
</span><a href="Futhark.IR.Syntax.html#subExpRes"><span class="hs-identifier hs-var">subExpRes</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   SubExp
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      SubExpRes)
-&gt; (BasicOp
    -&gt; BuilderT
         GPU
         (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
         SubExp)
-&gt; BasicOp
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     SubExpRes
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; Exp
     (Rep
        (BuilderT
           GPU (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;z&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT GPU
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      SubExp)
-&gt; (BasicOp -&gt; ExpT GPU)
-&gt; BasicOp
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      SubExpRes)
-&gt; BasicOp
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     SubExpRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-802"></span><span>            </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SMax"><span class="hs-identifier hs-var">SMax</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684441401"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684441400"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-803"></span><span>    </span><span class="annot"><span class="annottext">Lambda GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Lambda GPU)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Lambda GPU
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      (Lambda GPU))
-&gt; Lambda GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Lambda GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[LParam GPU]
-&gt; BodyT GPU
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; Lambda GPU
forall rep.
[LParam rep]
-&gt; BodyT rep
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684441408"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
-&gt; [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684441405"><span class="hs-identifier hs-var">ys</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU -&gt; Result -&gt; BodyT GPU
forall rep. Buildable rep =&gt; Stms rep -&gt; Result -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684441403"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684441404"><span class="hs-identifier hs-var">zs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684441415"><span class="hs-identifier hs-var">i64s</span></a></span><span>
</span><span id="line-804"></span><span>
</span><span id="line-805"></span><span>  </span><span id="local-6989586621684441396"><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684441396"><span class="hs-identifier hs-var">flat_gtid_lparam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;flat_gtid&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-806"></span><span>
</span><span id="line-807"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684441394"><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684441394"><span class="hs-identifier hs-var">size_lam'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   (Lambda GPU)
 -&gt; Scope GPU
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      (Lambda GPU, Stms GPU))
-&gt; Scope GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Lambda GPU)
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Lambda GPU, Stms GPU)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">BuilderT
  GPU
  (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
  (Lambda GPU)
-&gt; Scope GPU
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Lambda GPU, Stms GPU)
forall (m :: * -&gt; *) rep a.
MonadFreshNames m =&gt;
BuilderT rep m a -&gt; Scope rep -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT"><span class="hs-identifier hs-var">runBuilderT</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684441412"><span class="hs-identifier hs-var">kernels_scope</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   (Lambda GPU)
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      (Lambda GPU, Stms GPU))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Lambda GPU)
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (Lambda GPU, Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-808"></span><span>    </span><span id="local-6989586621684441393"><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684441393"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684441416"><span class="hs-identifier hs-var">num_sizes</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      [Param (TypeBase (ShapeBase SubExp) NoUniqueness)])
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     [Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Param (TypeBase (ShapeBase SubExp) NoUniqueness))
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;x&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-809"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684441392"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684441392"><span class="hs-identifier hs-var">zs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441391"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684441391"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scope GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Result, Stms GPU)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Result, Stms GPU)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span>
</span><span id="line-810"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)] -&gt; Scope GPU
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)]
</span><a href="#local-6989586621684441393"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU -&gt; Scope GPU -&gt; Scope GPU
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase (ShapeBase SubExp) NoUniqueness)] -&gt; Scope GPU
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684441396"><span class="hs-identifier hs-var">flat_gtid_lparam</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-811"></span><span>      </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   (Result, Stms GPU)
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      (Result, Stms GPU))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Result, Stms GPU)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Result, Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BuilderT
  GPU
  (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
  Result
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Result,
      Stms
        (Rep
           (BuilderT
              GPU
              (ReaderT (Scope GPUMem) (StateT VNameSource (Either String))))))
forall (m :: * -&gt; *) a.
MonadBuilder m =&gt;
m a -&gt; m (a, Stms (Rep m))
</span><a href="Futhark.Builder.Class.html#collectStms"><span class="hs-identifier hs-var">collectStms</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   Result
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      (Result,
       Stms
         (Rep
            (BuilderT
               GPU
               (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))))))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     Result
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Result,
      Stms
        (Rep
           (BuilderT
              GPU
              (ReaderT (Scope GPUMem) (StateT VNameSource (Either String))))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-812"></span><span>        </span><span class="hs-comment">-- Even though this SegRed is one-dimensional, we need to</span><span>
</span><span id="line-813"></span><span>        </span><span class="hs-comment">-- provide indexes corresponding to the original potentially</span><span>
</span><span id="line-814"></span><span>        </span><span class="hs-comment">-- multi-dimensional construct.</span><span>
</span><span id="line-815"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684441390"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684441390"><span class="hs-identifier hs-var">kspace_gtids</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441389"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684441389"><span class="hs-identifier hs-var">kspace_dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684441419"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-816"></span><span>            </span><span id="local-6989586621684441387"><span class="annot"><span class="annottext">new_inds :: [TPrimExp Int64 VName]
</span><a href="#local-6989586621684441387"><span class="hs-identifier hs-var hs-var">new_inds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-817"></span><span>              </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
-&gt; TPrimExp Int64 VName -&gt; [TPrimExp Int64 VName]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span>
</span><span id="line-818"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName)
-&gt; [SubExp] -&gt; [TPrimExp Int64 VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684441389"><span class="hs-identifier hs-var">kspace_dims</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-819"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; TPrimExp Int64 VName
</span><a href="Futhark.Analysis.PrimExp.Convert.html#pe64"><span class="hs-identifier hs-var">pe64</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TPrimExp Int64 VName) -&gt; SubExp -&gt; TPrimExp Int64 VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684441396"><span class="hs-identifier hs-var">flat_gtid_lparam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-820"></span><span>        </span><span class="annot"><span class="annottext">([VName]
 -&gt; ExpT GPU
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      ())
-&gt; [[VName]]
-&gt; [ExpT GPU]
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; ExpT GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; [VName]) -&gt; [VName] -&gt; [[VName]]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684441390"><span class="hs-identifier hs-var">kspace_gtids</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([ExpT GPU]
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      ())
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     [ExpT GPU]
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int64 VName
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      (ExpT GPU))
-&gt; [TPrimExp Int64 VName]
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     [ExpT GPU]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int64 VName
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (ExpT GPU)
forall a (m :: * -&gt; *).
(ToExp a, MonadBuilder m) =&gt;
a -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp Int64 VName]
</span><a href="#local-6989586621684441387"><span class="hs-identifier hs-var">new_inds</span></a></span><span>
</span><span id="line-821"></span><span>
</span><span id="line-822"></span><span>        </span><span class="annot"><span class="annottext">(Stm GPU
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      ())
-&gt; Stms GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stm (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStm"><span class="hs-identifier hs-var">addStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684441417"><span class="hs-identifier hs-var">kstms'</span></a></span><span>
</span><span id="line-823"></span><span>        </span><span class="annot"><span class="annottext">Result
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     Result
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Result
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      Result)
-&gt; Result
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     Result
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Result
</span><a href="Futhark.IR.Syntax.html#subExpsRes"><span class="hs-identifier hs-var">subExpsRes</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684441420"><span class="hs-identifier hs-var">sizes</span></a></span><span>
</span><span id="line-824"></span><span>
</span><span id="line-825"></span><span>    </span><span class="annot"><span class="annottext">Scope GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Lambda GPU)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Lambda GPU)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; Scope GPU
forall rep. SegSpace -&gt; Scope rep
</span><a href="Futhark.IR.SegOp.html#scopeOfSegSpace"><span class="hs-identifier hs-var">scopeOfSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684441419"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   (Lambda GPU)
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      (Lambda GPU))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Lambda GPU)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Lambda GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-826"></span><span>      </span><span class="annot"><span class="annottext">Lambda GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Lambda GPU)
forall (m :: * -&gt; *).
(HasScope GPU m, MonadFreshNames m) =&gt;
Lambda GPU -&gt; m (Lambda GPU)
</span><a href="Futhark.IR.GPU.Simplify.html#simplifyLambda"><span class="hs-identifier hs-var">GPU.simplifyLambda</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LParam GPU]
-&gt; BodyT GPU
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; Lambda GPU
forall rep.
[LParam rep]
-&gt; BodyT rep
-&gt; [TypeBase (ShapeBase SubExp) NoUniqueness]
-&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param (TypeBase (ShapeBase SubExp) NoUniqueness)
LParam GPU
</span><a href="#local-6989586621684441396"><span class="hs-identifier hs-var">flat_gtid_lparam</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BodyDec GPU -&gt; Stms GPU -&gt; Result -&gt; BodyT GPU
forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684441391"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684441392"><span class="hs-identifier hs-var">zs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase SubExp) NoUniqueness]
</span><a href="#local-6989586621684441415"><span class="hs-identifier hs-var">i64s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-827"></span><span>
</span><span id="line-828"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684441379"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684441379"><span class="hs-identifier hs-var">maxes_per_thread</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441378"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684441378"><span class="hs-identifier hs-var">size_sums</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684441377"><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684441377"><span class="hs-identifier hs-var">slice_stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   ([VName], [VName])
 -&gt; Scope GPU
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      (([VName], [VName]), Stms GPU))
-&gt; Scope GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     ([VName], [VName])
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (([VName], [VName]), Stms GPU)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">BuilderT
  GPU
  (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
  ([VName], [VName])
-&gt; Scope GPU
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (([VName], [VName]), Stms GPU)
forall (m :: * -&gt; *) rep a.
MonadFreshNames m =&gt;
BuilderT rep m a -&gt; Scope rep -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT"><span class="hs-identifier hs-var">runBuilderT</span></a></span><span> </span><span class="annot"><span class="annottext">Scope GPU
</span><a href="#local-6989586621684441412"><span class="hs-identifier hs-var">kernels_scope</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT
   GPU
   (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
   ([VName], [VName])
 -&gt; ReaderT
      (Scope GPUMem)
      (StateT VNameSource (Either String))
      (([VName], [VName]), Stms GPU))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     ([VName], [VName])
-&gt; ReaderT
     (Scope GPUMem)
     (StateT VNameSource (Either String))
     (([VName], [VName]), Stms GPU)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-829"></span><span>    </span><span id="local-6989586621684441376"><span class="annot"><span class="annottext">PatT (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684441376"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-830"></span><span>      </span><span class="annot"><span class="annottext">[Ident] -&gt; PatT (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="Futhark.IR.Prop.Patterns.html#basicPat"><span class="hs-identifier hs-var">basicPat</span></a></span><span> </span><span class="annot"><span class="annottext">([Ident] -&gt; PatT (TypeBase (ShapeBase SubExp) NoUniqueness))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     [Ident]
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (PatT (TypeBase (ShapeBase SubExp) NoUniqueness))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     Ident
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     [Ident]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684441416"><span class="hs-identifier hs-var">num_sizes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     Ident
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
String -&gt; TypeBase (ShapeBase SubExp) NoUniqueness -&gt; m Ident
</span><a href="Futhark.MonadFreshNames.html#newIdent"><span class="hs-identifier hs-var">newIdent</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;max_per_thread&quot;</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (ShapeBase SubExp) NoUniqueness
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      Ident)
-&gt; TypeBase (ShapeBase SubExp) NoUniqueness
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     Ident
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TypeBase (ShapeBase SubExp) NoUniqueness
forall shape u. PrimType -&gt; TypeBase shape u
</span><a href="Futhark.IR.Syntax.Core.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-831"></span><span>
</span><span id="line-832"></span><span>    </span><span id="local-6989586621684441373"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441373"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-833"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Exp
     (Rep
        (BuilderT
           GPU (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;size_slice_w&quot;</span></span><span>
</span><span id="line-834"></span><span>        </span><span class="annot"><span class="annottext">(ExpT GPU
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      SubExp)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (ExpT GPU)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     SubExp
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">BinOp
-&gt; SubExp
-&gt; [SubExp]
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Exp
        (Rep
           (BuilderT
              GPU
              (ReaderT (Scope GPUMem) (StateT VNameSource (Either String))))))
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
BinOp -&gt; SubExp -&gt; [SubExp] -&gt; m (Exp (Rep m))
</span><a href="Futhark.Construct.html#foldBinOp"><span class="hs-identifier hs-var">foldBinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Mul"><span class="hs-identifier hs-var">Mul</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#segSpaceDims"><span class="hs-identifier hs-var">segSpaceDims</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684441419"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-835"></span><span>
</span><span id="line-836"></span><span>    </span><span id="local-6989586621684441370"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441370"><span class="hs-identifier hs-var">thread_space_iota</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-837"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Exp
     (Rep
        (BuilderT
           GPU (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;thread_space_iota&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp
   (Rep
      (BuilderT
         GPU (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))))
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      VName)
-&gt; Exp
     (Rep
        (BuilderT
           GPU (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-838"></span><span>        </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; SubExp -&gt; SubExp -&gt; IntType -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Iota"><span class="hs-identifier hs-var">Iota</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441373"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-839"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684441368"><span class="annot"><span class="annottext">red_op :: SegBinOp GPU
</span><a href="#local-6989586621684441368"><span class="hs-identifier hs-var hs-var">red_op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-840"></span><span>          </span><span class="annot"><span class="annottext">Commutativity
-&gt; Lambda GPU -&gt; [SubExp] -&gt; ShapeBase SubExp -&gt; SegBinOp GPU
forall rep.
Commutativity
-&gt; Lambda rep -&gt; [SubExp] -&gt; ShapeBase SubExp -&gt; SegBinOp rep
</span><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-var">SegBinOp</span></a></span><span>
</span><span id="line-841"></span><span>            </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Commutative"><span class="hs-identifier hs-var">Commutative</span></a></span><span>
</span><span id="line-842"></span><span>            </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684441411"><span class="hs-identifier hs-var">max_lam</span></a></span><span>
</span><span id="line-843"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; SubExp -&gt; [SubExp]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684441416"><span class="hs-identifier hs-var">num_sizes</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; [SubExp]) -&gt; SubExp -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-844"></span><span>            </span><span class="annot"><span class="annottext">ShapeBase SubExp
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-845"></span><span>    </span><span id="local-6989586621684441365"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684441365"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     SegLevel
forall (m :: * -&gt; *) inner.
(MonadBuilder m, Op (Rep m) ~ HostOp (Rep m) inner) =&gt;
String -&gt; m SegLevel
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#segThread"><span class="hs-identifier hs-var">segThread</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segred&quot;</span></span><span>
</span><span id="line-846"></span><span>
</span><span id="line-847"></span><span>    </span><span class="annot"><span class="annottext">Stms GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     ()
forall (m :: * -&gt; *). MonadBuilder m =&gt; Stms (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#addStms"><span class="hs-identifier hs-var">addStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms GPU
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      ())
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Stms GPU)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">(Stm GPU
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      (Stm GPU))
-&gt; Stms GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Stms GPU)
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Stm GPU
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Stm GPU)
forall rep (m :: * -&gt; *).
(Renameable rep, MonadFreshNames m) =&gt;
Stm rep -&gt; m (Stm rep)
</span><a href="Futhark.Transform.Rename.html#renameStm"><span class="hs-identifier hs-var">renameStm</span></a></span><span>
</span><span id="line-848"></span><span>      </span><span class="annot"><span class="annottext">(Stms GPU
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      (Stms GPU))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Stms GPU)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Stms GPU)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">SegOpLevel GPU
-&gt; Pat GPU
-&gt; SubExp
-&gt; [SegBinOp GPU]
-&gt; Lambda GPU
-&gt; [VName]
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     (Stms GPU)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, DistRep rep, HasScope rep m) =&gt;
SegOpLevel rep
-&gt; Pat rep
-&gt; SubExp
-&gt; [SegBinOp rep]
-&gt; Lambda rep
-&gt; [VName]
-&gt; m (Stms rep)
</span><a href="Futhark.Pass.ExtractKernels.BlockedKernel.html#nonSegRed"><span class="hs-identifier hs-var">nonSegRed</span></a></span><span> </span><span class="annot"><span class="annottext">SegOpLevel GPU
SegLevel
</span><a href="#local-6989586621684441365"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (TypeBase (ShapeBase SubExp) NoUniqueness)
Pat GPU
</span><a href="#local-6989586621684441376"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441373"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SegBinOp GPU
</span><a href="#local-6989586621684441368"><span class="hs-identifier hs-var">red_op</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Lambda GPU
</span><a href="#local-6989586621684441394"><span class="hs-identifier hs-var">size_lam'</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441370"><span class="hs-identifier hs-var">thread_space_iota</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-849"></span><span>
</span><span id="line-850"></span><span>    </span><span id="local-6989586621684441363"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684441363"><span class="hs-identifier hs-var">size_sums</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; (VName
    -&gt; BuilderT
         GPU
         (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
         VName)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684441376"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((VName
  -&gt; BuilderT
       GPU
       (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
       VName)
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      [VName])
-&gt; (VName
    -&gt; BuilderT
         GPU
         (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
         VName)
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684441361"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441361"><span class="hs-identifier hs-var">threads_max</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-851"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; Exp
     (Rep
        (BuilderT
           GPU (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;size_sum&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp
   (Rep
      (BuilderT
         GPU (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))))
 -&gt; BuilderT
      GPU
      (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
      VName)
-&gt; Exp
     (Rep
        (BuilderT
           GPU (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))))
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-852"></span><span>        </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT GPU
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT GPU) -&gt; BasicOp -&gt; ExpT GPU
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BinOp -&gt; SubExp -&gt; SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#BinOp"><span class="hs-identifier hs-var">BinOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Mul"><span class="hs-identifier hs-var">Mul</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684441361"><span class="hs-identifier hs-var">threads_max</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684441421"><span class="hs-identifier hs-var">num_threads</span></a></span><span>
</span><span id="line-853"></span><span>
</span><span id="line-854"></span><span>    </span><span class="annot"><span class="annottext">([VName], [VName])
-&gt; BuilderT
     GPU
     (ReaderT (Scope GPUMem) (StateT VNameSource (Either String)))
     ([VName], [VName])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatT (TypeBase (ShapeBase SubExp) NoUniqueness) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (TypeBase (ShapeBase SubExp) NoUniqueness)
</span><a href="#local-6989586621684441376"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684441363"><span class="hs-identifier hs-var">size_sums</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-855"></span><span>
</span><span id="line-856"></span><span>  </span><span class="annot"><span class="annottext">(Stms GPU, [VName], [VName])
-&gt; ExpandM (Stms GPU, [VName], [VName])
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms GPU
</span><a href="#local-6989586621684441377"><span class="hs-identifier hs-var">slice_stms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684441379"><span class="hs-identifier hs-var">maxes_per_thread</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684441378"><span class="hs-identifier hs-var">size_sums</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-857"></span></pre></body></html>