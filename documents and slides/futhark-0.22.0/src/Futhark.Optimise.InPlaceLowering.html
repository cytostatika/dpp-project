<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE MultiParamTypeClasses #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-comment">-- | This module implements an optimisation that moves in-place</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- updates into/before loops where possible, with the end goal of</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- minimising memory copies.  As an example, consider this program:</span><span>
</span><span id="line-12"></span><span class="hs-comment">--</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-14"></span><span class="hs-comment">--   let r =</span><span>
</span><span id="line-15"></span><span class="hs-comment">--     loop (r1 = r0) = for i &lt; n do</span><span>
</span><span id="line-16"></span><span class="hs-comment">--       let a = r1[i]</span><span>
</span><span id="line-17"></span><span class="hs-comment">--       let r1[i] = a * i</span><span>
</span><span id="line-18"></span><span class="hs-comment">--       in r1</span><span>
</span><span id="line-19"></span><span class="hs-comment">--   ...</span><span>
</span><span id="line-20"></span><span class="hs-comment">--   let x = y with [k] &lt;- r in</span><span>
</span><span id="line-21"></span><span class="hs-comment">--   ...</span><span>
</span><span id="line-22"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-23"></span><span class="hs-comment">--</span><span>
</span><span id="line-24"></span><span class="hs-comment">-- We want to turn this into the following:</span><span>
</span><span id="line-25"></span><span class="hs-comment">--</span><span>
</span><span id="line-26"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-27"></span><span class="hs-comment">--   let x0 = y with [k] &lt;- r0</span><span>
</span><span id="line-28"></span><span class="hs-comment">--   loop (x = x0) = for i &lt; n do</span><span>
</span><span id="line-29"></span><span class="hs-comment">--     let a = a[k,i]</span><span>
</span><span id="line-30"></span><span class="hs-comment">--     let x[k,i] = a * i</span><span>
</span><span id="line-31"></span><span class="hs-comment">--     in x</span><span>
</span><span id="line-32"></span><span class="hs-comment">--   let r = x[k] in</span><span>
</span><span id="line-33"></span><span class="hs-comment">--   ...</span><span>
</span><span id="line-34"></span><span class="hs-comment">-- @</span><span>
</span><span id="line-35"></span><span class="hs-comment">--</span><span>
</span><span id="line-36"></span><span class="hs-comment">-- The intent is that we are also going to optimise the new data</span><span>
</span><span id="line-37"></span><span class="hs-comment">-- movement (in the @x0@-binding), possibly by changing how @r0@ is</span><span>
</span><span id="line-38"></span><span class="hs-comment">-- defined.  For the above transformation to be valid, a number of</span><span>
</span><span id="line-39"></span><span class="hs-comment">-- conditions must be fulfilled:</span><span>
</span><span id="line-40"></span><span class="hs-comment">--</span><span>
</span><span id="line-41"></span><span class="hs-comment">--    (1) @r@ must not be consumed after the original in-place update.</span><span>
</span><span id="line-42"></span><span class="hs-comment">--</span><span>
</span><span id="line-43"></span><span class="hs-comment">--    (2) @k@ and @y@ must be available at the beginning of the loop.</span><span>
</span><span id="line-44"></span><span class="hs-comment">--</span><span>
</span><span id="line-45"></span><span class="hs-comment">--    (3) @x@ must be visible whenever @r@ is visible.  (This means</span><span>
</span><span id="line-46"></span><span class="hs-comment">--    that both @x@ and @r@ must be bound in the same t'Body'.)</span><span>
</span><span id="line-47"></span><span class="hs-comment">--</span><span>
</span><span id="line-48"></span><span class="hs-comment">--    (4) If @x@ is consumed at a point after the loop, @r@ must not</span><span>
</span><span id="line-49"></span><span class="hs-comment">--    be used after that point.</span><span>
</span><span id="line-50"></span><span class="hs-comment">--</span><span>
</span><span id="line-51"></span><span class="hs-comment">--    (5) The size of @r1@ is invariant inside the loop.</span><span>
</span><span id="line-52"></span><span class="hs-comment">--</span><span>
</span><span id="line-53"></span><span class="hs-comment">--    (6) The value @r@ must come from something that we can actually</span><span>
</span><span id="line-54"></span><span class="hs-comment">--    optimise (e.g. not a function parameter).</span><span>
</span><span id="line-55"></span><span class="hs-comment">--</span><span>
</span><span id="line-56"></span><span class="hs-comment">--    (7) @y@ (or its aliases) may not be used inside the body of the</span><span>
</span><span id="line-57"></span><span class="hs-comment">--    loop.</span><span>
</span><span id="line-58"></span><span class="hs-comment">--</span><span>
</span><span id="line-59"></span><span class="hs-comment">--    (8) The result of the loop may not alias the merge parameter</span><span>
</span><span id="line-60"></span><span class="hs-comment">--    @r1@.</span><span>
</span><span id="line-61"></span><span class="hs-comment">--</span><span>
</span><span id="line-62"></span><span class="hs-comment">--    (9) @y@ or its aliases may not be used after the loop.</span><span>
</span><span id="line-63"></span><span class="hs-comment">--</span><span>
</span><span id="line-64"></span><span class="hs-comment">-- FIXME: the implementation is not finished yet.  Specifically, not</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- all of the above conditions are checked.</span><span>
</span><span id="line-66"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Optimise.InPlaceLowering</span><span>
</span><span id="line-67"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#inPlaceLoweringGPU"><span class="hs-identifier">inPlaceLoweringGPU</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#inPlaceLoweringSeq"><span class="hs-identifier">inPlaceLoweringSeq</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>    </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#inPlaceLoweringMC"><span class="hs-identifier">inPlaceLoweringMC</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span class="hs-keyword">where</span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.RWS</span></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Ord</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">comparing</span></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.Alias.html"><span class="hs-identifier">Futhark.Analysis.Alias</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Builder.html"><span class="hs-identifier">Futhark.Builder</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Aliases.html"><span class="hs-identifier">Futhark.IR.Aliases</span></a></span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html"><span class="hs-identifier">Futhark.IR.GPU</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.MC.html"><span class="hs-identifier">Futhark.IR.MC</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Seq.html"><span class="hs-identifier">Futhark.IR.Seq</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Seq.html#Seq"><span class="hs-identifier">Seq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html"><span class="hs-identifier">Futhark.Optimise.InPlaceLowering.LowerIntoStm</span></a></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.html"><span class="hs-identifier">Futhark.Pass</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#nubByOrd"><span class="hs-identifier">nubByOrd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="hs-comment">-- | Apply the in-place lowering optimisation to the given program.</span><span>
</span><span id="line-87"></span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#inPlaceLoweringGPU"><span class="hs-identifier hs-type">inPlaceLoweringGPU</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span>
</span><span id="line-88"></span><span id="inPlaceLoweringGPU"><span class="annot"><span class="annottext">inPlaceLoweringGPU :: Pass GPU GPU
</span><a href="Futhark.Optimise.InPlaceLowering.html#inPlaceLoweringGPU"><span class="hs-identifier hs-var hs-var">inPlaceLoweringGPU</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OnOp GPU -&gt; LowerUpdate GPU (ForwardingM GPU) -&gt; Pass GPU GPU
forall rep.
Constraints rep =&gt;
OnOp rep -&gt; LowerUpdate rep (ForwardingM rep) -&gt; Pass rep rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#inPlaceLowering"><span class="hs-identifier hs-var">inPlaceLowering</span></a></span><span> </span><span class="annot"><span class="annottext">OnOp GPU
</span><a href="Futhark.Optimise.InPlaceLowering.html#onKernelOp"><span class="hs-identifier hs-var">onKernelOp</span></a></span><span> </span><span class="annot"><span class="annottext">LowerUpdate GPU (ForwardingM GPU)
forall (m :: * -&gt; *). MonadFreshNames m =&gt; LowerUpdate GPU m
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdateGPU"><span class="hs-identifier hs-var">lowerUpdateGPU</span></a></span><span>
</span><span id="line-89"></span><span>
</span><span id="line-90"></span><span class="hs-comment">-- | Apply the in-place lowering optimisation to the given program.</span><span>
</span><span id="line-91"></span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#inPlaceLoweringSeq"><span class="hs-identifier hs-type">inPlaceLoweringSeq</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Seq.html#Seq"><span class="hs-identifier hs-type">Seq</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Seq.html#Seq"><span class="hs-identifier hs-type">Seq</span></a></span><span>
</span><span id="line-92"></span><span id="inPlaceLoweringSeq"><span class="annot"><span class="annottext">inPlaceLoweringSeq :: Pass Seq Seq
</span><a href="Futhark.Optimise.InPlaceLowering.html#inPlaceLoweringSeq"><span class="hs-identifier hs-var hs-var">inPlaceLoweringSeq</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OnOp Seq -&gt; LowerUpdate Seq (ForwardingM Seq) -&gt; Pass Seq Seq
forall rep.
Constraints rep =&gt;
OnOp rep -&gt; LowerUpdate rep (ForwardingM rep) -&gt; Pass rep rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#inPlaceLowering"><span class="hs-identifier hs-var">inPlaceLowering</span></a></span><span> </span><span class="annot"><span class="annottext">OnOp Seq
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">LowerUpdate Seq (ForwardingM Seq)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, Buildable rep, LetDec rep ~ Type,
 CanBeAliased (Op rep)) =&gt;
LowerUpdate rep m
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdate"><span class="hs-identifier hs-var">lowerUpdate</span></a></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="hs-comment">-- | Apply the in-place lowering optimisation to the given program.</span><span>
</span><span id="line-95"></span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#inPlaceLoweringMC"><span class="hs-identifier hs-type">inPlaceLoweringMC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span>
</span><span id="line-96"></span><span id="inPlaceLoweringMC"><span class="annot"><span class="annottext">inPlaceLoweringMC :: Pass MC MC
</span><a href="Futhark.Optimise.InPlaceLowering.html#inPlaceLoweringMC"><span class="hs-identifier hs-var hs-var">inPlaceLoweringMC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OnOp MC -&gt; LowerUpdate MC (ForwardingM MC) -&gt; Pass MC MC
forall rep.
Constraints rep =&gt;
OnOp rep -&gt; LowerUpdate rep (ForwardingM rep) -&gt; Pass rep rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#inPlaceLowering"><span class="hs-identifier hs-var">inPlaceLowering</span></a></span><span> </span><span class="annot"><span class="annottext">OnOp MC
</span><a href="Futhark.Optimise.InPlaceLowering.html#onMCOp"><span class="hs-identifier hs-var">onMCOp</span></a></span><span> </span><span class="annot"><span class="annottext">LowerUpdate MC (ForwardingM MC)
forall (m :: * -&gt; *) rep.
(MonadFreshNames m, Buildable rep, LetDec rep ~ Type,
 CanBeAliased (Op rep)) =&gt;
LowerUpdate rep m
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#lowerUpdate"><span class="hs-identifier hs-var">lowerUpdate</span></a></span><span>
</span><span id="line-97"></span><span>
</span><span id="line-98"></span><span class="hs-comment">-- | Apply the in-place lowering optimisation to the given program.</span><span>
</span><span id="line-99"></span><span id="local-6989586621684429054"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#inPlaceLowering"><span class="hs-identifier hs-type">inPlaceLowering</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-100"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429054"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-101"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#OnOp"><span class="hs-identifier hs-type">OnOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429054"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-102"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#LowerUpdate"><span class="hs-identifier hs-type">LowerUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429054"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429054"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429054"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429054"><span class="hs-identifier hs-type">rep</span></a></span></span><span>
</span><span id="line-104"></span><span id="inPlaceLowering"><span class="annot"><span class="annottext">inPlaceLowering :: forall rep.
Constraints rep =&gt;
OnOp rep -&gt; LowerUpdate rep (ForwardingM rep) -&gt; Pass rep rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#inPlaceLowering"><span class="hs-identifier hs-var hs-var">inPlaceLowering</span></a></span></span><span> </span><span id="local-6989586621684428546"><span class="annot"><span class="annottext">OnOp rep
</span><a href="#local-6989586621684428546"><span class="hs-identifier hs-var">onOp</span></a></span></span><span> </span><span id="local-6989586621684428545"><span class="annot"><span class="annottext">LowerUpdate rep (ForwardingM rep)
</span><a href="#local-6989586621684428545"><span class="hs-identifier hs-var">lower</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-105"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; String -&gt; (Prog rep -&gt; PassM (Prog rep)) -&gt; Pass rep rep
forall fromrep torep.
String
-&gt; String
-&gt; (Prog fromrep -&gt; PassM (Prog torep))
-&gt; Pass fromrep torep
</span><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-var">Pass</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;In-place lowering&quot;</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Lower in-place updates into loops&quot;</span></span><span> </span><span class="annot"><span class="annottext">((Prog rep -&gt; PassM (Prog rep)) -&gt; Pass rep rep)
-&gt; (Prog rep -&gt; PassM (Prog rep)) -&gt; Pass rep rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><span class="annottext">(Prog (Aliases rep) -&gt; Prog rep)
-&gt; PassM (Prog (Aliases rep)) -&gt; PassM (Prog rep)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Prog (Aliases rep) -&gt; Prog rep
forall rep. CanBeAliased (Op rep) =&gt; Prog (Aliases rep) -&gt; Prog rep
</span><a href="Futhark.IR.Aliases.html#removeProgAliases"><span class="hs-identifier hs-var">removeProgAliases</span></a></span><span>
</span><span id="line-107"></span><span>      </span><span class="annot"><span class="annottext">(PassM (Prog (Aliases rep)) -&gt; PassM (Prog rep))
-&gt; (Prog rep -&gt; PassM (Prog (Aliases rep)))
-&gt; Prog rep
-&gt; PassM (Prog rep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Stms (Aliases rep) -&gt; PassM (Stms (Aliases rep)))
-&gt; (Stms (Aliases rep)
    -&gt; FunDef (Aliases rep) -&gt; PassM (FunDef (Aliases rep)))
-&gt; Prog (Aliases rep)
-&gt; PassM (Prog (Aliases rep))
forall fromrep torep.
(Stms fromrep -&gt; PassM (Stms torep))
-&gt; (Stms torep -&gt; FunDef fromrep -&gt; PassM (FunDef torep))
-&gt; Prog fromrep
-&gt; PassM (Prog torep)
</span><a href="Futhark.Pass.html#intraproceduralTransformationWithConsts"><span class="hs-identifier hs-var">intraproceduralTransformationWithConsts</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Aliases rep) -&gt; PassM (Stms (Aliases rep))
</span><a href="#local-6989586621684428540"><span class="hs-identifier hs-var">optimiseConsts</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Aliases rep)
-&gt; FunDef (Aliases rep) -&gt; PassM (FunDef (Aliases rep))
</span><a href="#local-6989586621684428539"><span class="hs-identifier hs-var">optimiseFunDef</span></a></span><span>
</span><span id="line-108"></span><span>      </span><span class="annot"><span class="annottext">(Prog (Aliases rep) -&gt; PassM (Prog (Aliases rep)))
-&gt; (Prog rep -&gt; Prog (Aliases rep))
-&gt; Prog rep
-&gt; PassM (Prog (Aliases rep))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Prog rep -&gt; Prog (Aliases rep)
forall rep.
(ASTRep rep, CanBeAliased (Op rep)) =&gt;
Prog rep -&gt; Prog (Aliases rep)
</span><a href="Futhark.Analysis.Alias.html#aliasAnalysis"><span class="hs-identifier hs-var">aliasAnalysis</span></a></span><span>
</span><span id="line-109"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-110"></span><span>    </span><span id="local-6989586621684428540"><span class="annot"><span class="annottext">optimiseConsts :: Stms (Aliases rep) -&gt; PassM (Stms (Aliases rep))
</span><a href="#local-6989586621684428540"><span class="hs-identifier hs-var hs-var">optimiseConsts</span></a></span></span><span> </span><span id="local-6989586621684428537"><span class="annot"><span class="annottext">Stms (Aliases rep)
</span><a href="#local-6989586621684428537"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-111"></span><span>      </span><span class="annot"><span class="annottext">(VNameSource -&gt; (Stms (Aliases rep), VNameSource))
-&gt; PassM (Stms (Aliases rep))
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
(VNameSource -&gt; (a, VNameSource)) -&gt; m a
</span><a href="Futhark.MonadFreshNames.html#modifyNameSource"><span class="hs-identifier hs-var">modifyNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">((VNameSource -&gt; (Stms (Aliases rep), VNameSource))
 -&gt; PassM (Stms (Aliases rep)))
-&gt; (VNameSource -&gt; (Stms (Aliases rep), VNameSource))
-&gt; PassM (Stms (Aliases rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-112"></span><span>        </span><span class="annot"><span class="annottext">LowerUpdate rep (ForwardingM rep)
-&gt; OnOp rep
-&gt; ForwardingM rep (Stms (Aliases rep))
-&gt; VNameSource
-&gt; (Stms (Aliases rep), VNameSource)
forall rep a.
LowerUpdate rep (ForwardingM rep)
-&gt; OnOp rep -&gt; ForwardingM rep a -&gt; VNameSource -&gt; (a, VNameSource)
</span><a href="Futhark.Optimise.InPlaceLowering.html#runForwardingM"><span class="hs-identifier hs-var">runForwardingM</span></a></span><span> </span><span class="annot"><span class="annottext">LowerUpdate rep (ForwardingM rep)
</span><a href="#local-6989586621684428545"><span class="hs-identifier hs-var">lower</span></a></span><span> </span><span class="annot"><span class="annottext">OnOp rep
</span><a href="#local-6989586621684428546"><span class="hs-identifier hs-var">onOp</span></a></span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep (Stms (Aliases rep))
 -&gt; VNameSource -&gt; (Stms (Aliases rep), VNameSource))
-&gt; ForwardingM rep (Stms (Aliases rep))
-&gt; VNameSource
-&gt; (Stms (Aliases rep), VNameSource)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-113"></span><span>          </span><span class="annot"><span class="annottext">[Stm (Aliases rep)] -&gt; Stms (Aliases rep)
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">([Stm (Aliases rep)] -&gt; Stms (Aliases rep))
-&gt; ForwardingM rep [Stm (Aliases rep)]
-&gt; ForwardingM rep (Stms (Aliases rep))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
-&gt; ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)]
forall rep.
Constraints rep =&gt;
[Stm (Aliases rep)]
-&gt; ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)]
</span><a href="Futhark.Optimise.InPlaceLowering.html#optimiseStms"><span class="hs-identifier hs-var">optimiseStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms (Aliases rep) -&gt; [Stm (Aliases rep)]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Aliases rep)
</span><a href="#local-6989586621684428537"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; ForwardingM rep ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span>
</span><span id="line-115"></span><span>    </span><span id="local-6989586621684428539"><span class="annot"><span class="annottext">optimiseFunDef :: Stms (Aliases rep)
-&gt; FunDef (Aliases rep) -&gt; PassM (FunDef (Aliases rep))
</span><a href="#local-6989586621684428539"><span class="hs-identifier hs-var hs-var">optimiseFunDef</span></a></span></span><span> </span><span id="local-6989586621684428530"><span class="annot"><span class="annottext">Stms (Aliases rep)
</span><a href="#local-6989586621684428530"><span class="hs-identifier hs-var">consts</span></a></span></span><span> </span><span id="local-6989586621684428529"><span class="annot"><span class="annottext">FunDef (Aliases rep)
</span><a href="#local-6989586621684428529"><span class="hs-identifier hs-var">fundec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-116"></span><span>      </span><span class="annot"><span class="annottext">(VNameSource -&gt; (FunDef (Aliases rep), VNameSource))
-&gt; PassM (FunDef (Aliases rep))
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
(VNameSource -&gt; (a, VNameSource)) -&gt; m a
</span><a href="Futhark.MonadFreshNames.html#modifyNameSource"><span class="hs-identifier hs-var">modifyNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">((VNameSource -&gt; (FunDef (Aliases rep), VNameSource))
 -&gt; PassM (FunDef (Aliases rep)))
-&gt; (VNameSource -&gt; (FunDef (Aliases rep), VNameSource))
-&gt; PassM (FunDef (Aliases rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-117"></span><span>        </span><span class="annot"><span class="annottext">LowerUpdate rep (ForwardingM rep)
-&gt; OnOp rep
-&gt; ForwardingM rep (FunDef (Aliases rep))
-&gt; VNameSource
-&gt; (FunDef (Aliases rep), VNameSource)
forall rep a.
LowerUpdate rep (ForwardingM rep)
-&gt; OnOp rep -&gt; ForwardingM rep a -&gt; VNameSource -&gt; (a, VNameSource)
</span><a href="Futhark.Optimise.InPlaceLowering.html#runForwardingM"><span class="hs-identifier hs-var">runForwardingM</span></a></span><span> </span><span class="annot"><span class="annottext">LowerUpdate rep (ForwardingM rep)
</span><a href="#local-6989586621684428545"><span class="hs-identifier hs-var">lower</span></a></span><span> </span><span class="annot"><span class="annottext">OnOp rep
</span><a href="#local-6989586621684428546"><span class="hs-identifier hs-var">onOp</span></a></span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep (FunDef (Aliases rep))
 -&gt; VNameSource -&gt; (FunDef (Aliases rep), VNameSource))
-&gt; ForwardingM rep (FunDef (Aliases rep))
-&gt; VNameSource
-&gt; (FunDef (Aliases rep), VNameSource)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-118"></span><span>          </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
-&gt; ForwardingM rep (FunDef (Aliases rep))
-&gt; ForwardingM rep (FunDef (Aliases rep))
forall {rep} {a}.
[Stm (Aliases rep)] -&gt; ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="#local-6989586621684428528"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms (Aliases rep) -&gt; [Stm (Aliases rep)]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Aliases rep)
</span><a href="#local-6989586621684428530"><span class="hs-identifier hs-var">consts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep (FunDef (Aliases rep))
 -&gt; ForwardingM rep (FunDef (Aliases rep)))
-&gt; ForwardingM rep (FunDef (Aliases rep))
-&gt; ForwardingM rep (FunDef (Aliases rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-119"></span><span>            </span><span class="annot"><span class="annottext">[FParam (Aliases rep)]
-&gt; ForwardingM rep (FunDef (Aliases rep))
-&gt; ForwardingM rep (FunDef (Aliases rep))
forall rep a.
[FParam (Aliases rep)] -&gt; ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="Futhark.Optimise.InPlaceLowering.html#bindingFParams"><span class="hs-identifier hs-var">bindingFParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FunDef (Aliases rep) -&gt; [FParam (Aliases rep)]
forall rep. FunDef rep -&gt; [FParam rep]
</span><a href="Futhark.IR.Syntax.html#funDefParams"><span class="hs-identifier hs-var hs-var">funDefParams</span></a></span><span> </span><span class="annot"><span class="annottext">FunDef (Aliases rep)
</span><a href="#local-6989586621684428529"><span class="hs-identifier hs-var">fundec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep (FunDef (Aliases rep))
 -&gt; ForwardingM rep (FunDef (Aliases rep)))
-&gt; ForwardingM rep (FunDef (Aliases rep))
-&gt; ForwardingM rep (FunDef (Aliases rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-120"></span><span>              </span><span id="local-6989586621684428525"><span class="annot"><span class="annottext">Body (Aliases rep)
</span><a href="#local-6989586621684428525"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Body (Aliases rep) -&gt; ForwardingM rep (Body (Aliases rep))
forall rep.
Constraints rep =&gt;
Body (Aliases rep) -&gt; ForwardingM rep (Body (Aliases rep))
</span><a href="Futhark.Optimise.InPlaceLowering.html#optimiseBody"><span class="hs-identifier hs-var">optimiseBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Body (Aliases rep) -&gt; ForwardingM rep (Body (Aliases rep)))
-&gt; Body (Aliases rep) -&gt; ForwardingM rep (Body (Aliases rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FunDef (Aliases rep) -&gt; Body (Aliases rep)
forall rep. FunDef rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#funDefBody"><span class="hs-identifier hs-var hs-var">funDefBody</span></a></span><span> </span><span class="annot"><span class="annottext">FunDef (Aliases rep)
</span><a href="#local-6989586621684428529"><span class="hs-identifier hs-var">fundec</span></a></span><span>
</span><span id="line-121"></span><span>              </span><span class="annot"><span class="annottext">FunDef (Aliases rep) -&gt; ForwardingM rep (FunDef (Aliases rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(FunDef (Aliases rep) -&gt; ForwardingM rep (FunDef (Aliases rep)))
-&gt; FunDef (Aliases rep) -&gt; ForwardingM rep (FunDef (Aliases rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FunDef (Aliases rep)
</span><a href="#local-6989586621684428529"><span class="hs-identifier hs-var">fundec</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">funDefBody :: Body (Aliases rep)
</span><a href="Futhark.IR.Syntax.html#funDefBody"><span class="hs-identifier hs-var">funDefBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Body (Aliases rep)
</span><a href="#local-6989586621684428525"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span>    </span><span id="local-6989586621684428528"><span class="annot"><span class="annottext">descend :: [Stm (Aliases rep)] -&gt; ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="#local-6989586621684428528"><span class="hs-identifier hs-var hs-var">descend</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684428522"><span class="annot"><span class="annottext">ForwardingM rep a
</span><a href="#local-6989586621684428522"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ForwardingM rep a
</span><a href="#local-6989586621684428522"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-124"></span><span>    </span><span class="annot"><a href="#local-6989586621684428528"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684428521"><span class="annot"><span class="annottext">Stm (Aliases rep)
</span><a href="#local-6989586621684428521"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684428520"><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428520"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684428519"><span class="annot"><span class="annottext">ForwardingM rep a
</span><a href="#local-6989586621684428519"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep) -&gt; ForwardingM rep a -&gt; ForwardingM rep a
forall rep a.
Stm (Aliases rep) -&gt; ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="Futhark.Optimise.InPlaceLowering.html#bindingStm"><span class="hs-identifier hs-var">bindingStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep)
</span><a href="#local-6989586621684428521"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep a -&gt; ForwardingM rep a)
-&gt; ForwardingM rep a -&gt; ForwardingM rep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)] -&gt; ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="#local-6989586621684428528"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428520"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">ForwardingM rep a
</span><a href="#local-6989586621684428519"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-125"></span><span>
</span><span id="line-126"></span><span class="hs-keyword">type</span><span> </span><span id="Constraints"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#Constraints"><span class="hs-identifier hs-var">Constraints</span></a></span></span><span> </span><span id="local-6989586621684428517"><span class="annot"><a href="#local-6989586621684428517"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Buildable"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428517"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#CanBeAliased"><span class="hs-identifier hs-type">CanBeAliased</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428517"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span id="local-6989586621684429006"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#optimiseBody"><span class="hs-identifier hs-type">optimiseBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-129"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429006"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-130"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429006"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429006"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429006"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-132"></span><span id="optimiseBody"><span class="annot"><span class="annottext">optimiseBody :: forall rep.
Constraints rep =&gt;
Body (Aliases rep) -&gt; ForwardingM rep (Body (Aliases rep))
</span><a href="Futhark.Optimise.InPlaceLowering.html#optimiseBody"><span class="hs-identifier hs-var hs-var">optimiseBody</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span id="local-6989586621684428507"><span class="annot"><span class="annottext">BodyDec (Aliases rep)
</span><a href="#local-6989586621684428507"><span class="hs-identifier hs-var">als</span></a></span></span><span> </span><span id="local-6989586621684428506"><span class="annot"><span class="annottext">Stms (Aliases rep)
</span><a href="#local-6989586621684428506"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684428505"><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684428505"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>  </span><span id="local-6989586621684428504"><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428504"><span class="hs-identifier hs-var">stms'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ForwardingM rep [Stm (Aliases rep)]
-&gt; ForwardingM rep [Stm (Aliases rep)]
forall rep a. ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="Futhark.Optimise.InPlaceLowering.html#deepen"><span class="hs-identifier hs-var">deepen</span></a></span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep [Stm (Aliases rep)]
 -&gt; ForwardingM rep [Stm (Aliases rep)])
-&gt; ForwardingM rep [Stm (Aliases rep)]
-&gt; ForwardingM rep [Stm (Aliases rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
-&gt; ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)]
forall rep.
Constraints rep =&gt;
[Stm (Aliases rep)]
-&gt; ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)]
</span><a href="Futhark.Optimise.InPlaceLowering.html#optimiseStms"><span class="hs-identifier hs-var">optimiseStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms (Aliases rep) -&gt; [Stm (Aliases rep)]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="annot"><span class="annottext">Stms (Aliases rep)
</span><a href="#local-6989586621684428506"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)])
-&gt; ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; ForwardingM rep ()) -&gt; Result -&gt; ForwardingM rep ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; ForwardingM rep ()
forall {rep}. SubExp -&gt; ForwardingM rep ()
</span><a href="#local-6989586621684428501"><span class="hs-identifier hs-var">seen</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; ForwardingM rep ())
-&gt; (SubExpRes -&gt; SubExp) -&gt; SubExpRes -&gt; ForwardingM rep ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684428505"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-134"></span><span>  </span><span class="annot"><span class="annottext">BodyT (Aliases rep) -&gt; ForwardingM rep (BodyT (Aliases rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(BodyT (Aliases rep) -&gt; ForwardingM rep (BodyT (Aliases rep)))
-&gt; BodyT (Aliases rep) -&gt; ForwardingM rep (BodyT (Aliases rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyDec (Aliases rep)
-&gt; Stms (Aliases rep) -&gt; Result -&gt; BodyT (Aliases rep)
forall rep. BodyDec rep -&gt; Stms rep -&gt; Result -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="annot"><span class="annottext">BodyDec (Aliases rep)
</span><a href="#local-6989586621684428507"><span class="hs-identifier hs-var">als</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stm (Aliases rep)] -&gt; Stms (Aliases rep)
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428504"><span class="hs-identifier hs-var">stms'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Result
</span><a href="#local-6989586621684428505"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-136"></span><span>    </span><span id="local-6989586621684428501"><span class="annot"><span class="annottext">seen :: SubExp -&gt; ForwardingM rep ()
</span><a href="#local-6989586621684428501"><span class="hs-identifier hs-var hs-var">seen</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Constant"><span class="hs-identifier hs-type">Constant</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; ForwardingM rep ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>    </span><span class="annot"><a href="#local-6989586621684428501"><span class="hs-identifier hs-var">seen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684428496"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684428496"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ForwardingM rep ()
forall rep. VName -&gt; ForwardingM rep ()
</span><a href="Futhark.Optimise.InPlaceLowering.html#seenVar"><span class="hs-identifier hs-var">seenVar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684428496"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span id="local-6989586621684429015"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#optimiseStms"><span class="hs-identifier hs-type">optimiseStms</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-140"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429015"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429015"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-142"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429015"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-143"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429015"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429015"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span></span><span>
</span><span id="line-144"></span><span id="optimiseStms"><span class="annot"><span class="annottext">optimiseStms :: forall rep.
Constraints rep =&gt;
[Stm (Aliases rep)]
-&gt; ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)]
</span><a href="Futhark.Optimise.InPlaceLowering.html#optimiseStms"><span class="hs-identifier hs-var hs-var">optimiseStms</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684428365"><span class="annot"><span class="annottext">ForwardingM rep ()
</span><a href="#local-6989586621684428365"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ForwardingM rep ()
</span><a href="#local-6989586621684428365"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">ForwardingM rep ()
-&gt; ForwardingM rep [Stm (Aliases rep)]
-&gt; ForwardingM rep [Stm (Aliases rep)]
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><span class="hs-operator hs-var">&gt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)] -&gt; ForwardingM rep [Stm (Aliases rep)]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-145"></span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#optimiseStms"><span class="hs-identifier hs-var">optimiseStms</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684428364"><span class="annot"><span class="annottext">Stm (Aliases rep)
</span><a href="#local-6989586621684428364"><span class="hs-identifier hs-var">stm</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684428363"><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428363"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684428362"><span class="annot"><span class="annottext">ForwardingM rep ()
</span><a href="#local-6989586621684428362"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-146"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684428361"><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428361"><span class="hs-identifier hs-var">stms'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684428360"><span class="annot"><span class="annottext">BottomUp rep
</span><a href="#local-6989586621684428360"><span class="hs-identifier hs-var">bup</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ForwardingM rep [Stm (Aliases rep)]
-&gt; ForwardingM rep ([Stm (Aliases rep)], BottomUp rep)
forall rep a.
ForwardingM rep a -&gt; ForwardingM rep (a, BottomUp rep)
</span><a href="Futhark.Optimise.InPlaceLowering.html#tapBottomUp"><span class="hs-identifier hs-var">tapBottomUp</span></a></span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep [Stm (Aliases rep)]
 -&gt; ForwardingM rep ([Stm (Aliases rep)], BottomUp rep))
-&gt; ForwardingM rep [Stm (Aliases rep)]
-&gt; ForwardingM rep ([Stm (Aliases rep)], BottomUp rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep)
-&gt; ForwardingM rep [Stm (Aliases rep)]
-&gt; ForwardingM rep [Stm (Aliases rep)]
forall rep a.
Stm (Aliases rep) -&gt; ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="Futhark.Optimise.InPlaceLowering.html#bindingStm"><span class="hs-identifier hs-var">bindingStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep)
</span><a href="#local-6989586621684428364"><span class="hs-identifier hs-var">stm</span></a></span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep [Stm (Aliases rep)]
 -&gt; ForwardingM rep [Stm (Aliases rep)])
-&gt; ForwardingM rep [Stm (Aliases rep)]
-&gt; ForwardingM rep [Stm (Aliases rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
-&gt; ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)]
forall rep.
Constraints rep =&gt;
[Stm (Aliases rep)]
-&gt; ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)]
</span><a href="Futhark.Optimise.InPlaceLowering.html#optimiseStms"><span class="hs-identifier hs-var">optimiseStms</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428363"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">ForwardingM rep ()
</span><a href="#local-6989586621684428362"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-147"></span><span>  </span><span id="local-6989586621684428358"><span class="annot"><span class="annottext">Stm (Aliases rep)
</span><a href="#local-6989586621684428358"><span class="hs-identifier hs-var">stm'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep) -&gt; ForwardingM rep (Stm (Aliases rep))
forall rep.
Constraints rep =&gt;
Stm (Aliases rep) -&gt; ForwardingM rep (Stm (Aliases rep))
</span><a href="Futhark.Optimise.InPlaceLowering.html#optimiseInStm"><span class="hs-identifier hs-var">optimiseInStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep)
</span><a href="#local-6989586621684428364"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-148"></span><span>  </span><span class="hs-comment">-- XXX: unfortunate that we cannot handle duplicate update values.</span><span>
</span><span id="line-149"></span><span>  </span><span class="hs-comment">-- Would be good to improve this.  See inplacelowering6.fut.</span><span>
</span><span id="line-150"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">(DesiredUpdate (VarAliases, LetDec rep)
 -&gt; DesiredUpdate (VarAliases, LetDec rep) -&gt; Ordering)
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#nubByOrd"><span class="hs-identifier hs-var">nubByOrd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DesiredUpdate (VarAliases, LetDec rep) -&gt; VName)
-&gt; DesiredUpdate (VarAliases, LetDec rep)
-&gt; DesiredUpdate (VarAliases, LetDec rep)
-&gt; Ordering
forall a b. Ord a =&gt; (b -&gt; a) -&gt; b -&gt; b -&gt; Ordering
</span><span class="hs-identifier hs-var">comparing</span></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (VarAliases, LetDec rep) -&gt; VName
forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateValue"><span class="hs-identifier hs-var hs-var">updateValue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><span class="annottext">([DesiredUpdate (VarAliases, LetDec rep)]
 -&gt; [DesiredUpdate (VarAliases, LetDec rep)])
-&gt; ([DesiredUpdate (VarAliases, LetDec rep)]
    -&gt; [DesiredUpdate (VarAliases, LetDec rep)])
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(DesiredUpdate (VarAliases, LetDec rep) -&gt; Bool)
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; (DesiredUpdate (VarAliases, LetDec rep) -&gt; Bool)
-&gt; DesiredUpdate (VarAliases, LetDec rep)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names -&gt; Bool
</span><a href="Futhark.IR.Prop.Names.html#nameIn"><span class="hs-operator hs-var">`nameIn`</span></a></span><span> </span><span class="annot"><span class="annottext">BottomUp rep -&gt; Names
forall rep. BottomUp rep -&gt; Names
</span><a href="Futhark.Optimise.InPlaceLowering.html#bottomUpSeen"><span class="hs-identifier hs-var hs-var">bottomUpSeen</span></a></span><span> </span><span class="annot"><span class="annottext">BottomUp rep
</span><a href="#local-6989586621684428360"><span class="hs-identifier hs-var">bup</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; (DesiredUpdate (VarAliases, LetDec rep) -&gt; VName)
-&gt; DesiredUpdate (VarAliases, LetDec rep)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (VarAliases, LetDec rep) -&gt; VName
forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateSource"><span class="hs-identifier hs-var hs-var">updateSource</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- (9)</span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><span class="annottext">([DesiredUpdate (VarAliases, LetDec rep)]
 -&gt; [DesiredUpdate (VarAliases, LetDec rep)])
-&gt; ([DesiredUpdate (VarAliases, LetDec rep)]
    -&gt; [DesiredUpdate (VarAliases, LetDec rep)])
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(DesiredUpdate (VarAliases, LetDec rep) -&gt; Bool)
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684428350"><span class="hs-identifier hs-var">boundHere</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; (DesiredUpdate (VarAliases, LetDec rep) -&gt; VName)
-&gt; DesiredUpdate (VarAliases, LetDec rep)
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (VarAliases, LetDec rep) -&gt; VName
forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateValue"><span class="hs-identifier hs-var hs-var">updateValue</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>    </span><span class="annot"><span class="annottext">([DesiredUpdate (VarAliases, LetDec rep)]
 -&gt; [DesiredUpdate (VarAliases, LetDec rep)])
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BottomUp rep -&gt; [DesiredUpdate (LetDec (Aliases rep))]
forall rep. BottomUp rep -&gt; [DesiredUpdate (LetDec (Aliases rep))]
</span><a href="Futhark.Optimise.InPlaceLowering.html#forwardThese"><span class="hs-identifier hs-var hs-var">forwardThese</span></a></span><span> </span><span class="annot"><span class="annottext">BottomUp rep
</span><a href="#local-6989586621684428360"><span class="hs-identifier hs-var">bup</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-154"></span><span>    </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-155"></span><span>      </span><span class="annot"><span class="annottext">Stm (Aliases rep) -&gt; ForwardingM rep ()
forall {rep} {rep}.
(Buildable rep, CanBeAliased (Op rep), FreeDec (ExpDec rep),
 FreeDec (BodyDec rep), FreeIn (FParamInfo rep),
 FreeIn (LParamInfo rep), FreeIn (LetDec rep), FreeIn (RetType rep),
 FreeIn (BranchType rep), FreeIn (Op rep),
 LetDec rep ~ (VarAliases, LetDec rep)) =&gt;
Stm rep -&gt; ForwardingM rep ()
</span><a href="#local-6989586621684428348"><span class="hs-identifier hs-var">checkIfForwardableUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep)
</span><a href="#local-6989586621684428358"><span class="hs-identifier hs-var">stm'</span></a></span><span>
</span><span id="line-156"></span><span>      </span><span class="annot"><span class="annottext">[Stm (Aliases rep)] -&gt; ForwardingM rep [Stm (Aliases rep)]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([Stm (Aliases rep)] -&gt; ForwardingM rep [Stm (Aliases rep)])
-&gt; [Stm (Aliases rep)] -&gt; ForwardingM rep [Stm (Aliases rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep)
</span><a href="#local-6989586621684428358"><span class="hs-identifier hs-var">stm'</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep) -&gt; [Stm (Aliases rep)] -&gt; [Stm (Aliases rep)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428361"><span class="hs-identifier hs-var">stms'</span></a></span><span>
</span><span id="line-157"></span><span>    </span><span id="local-6989586621684428347"><span class="annot"><span class="annottext">[DesiredUpdate (VarAliases, LetDec rep)]
</span><a href="#local-6989586621684428347"><span class="hs-identifier hs-var">updates</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-158"></span><span>      </span><span id="local-6989586621684428346"><span class="annot"><span class="annottext">Scope (Aliases rep)
-&gt; Stm (Aliases rep)
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
-&gt; Maybe (ForwardingM rep [Stm (Aliases rep)])
</span><a href="#local-6989586621684428346"><span class="hs-identifier hs-var">lower</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TopDown rep
 -&gt; Scope (Aliases rep)
 -&gt; Stm (Aliases rep)
 -&gt; [DesiredUpdate (VarAliases, LetDec rep)]
 -&gt; Maybe (ForwardingM rep [Stm (Aliases rep)]))
-&gt; ForwardingM
     rep
     (Scope (Aliases rep)
      -&gt; Stm (Aliases rep)
      -&gt; [DesiredUpdate (VarAliases, LetDec rep)]
      -&gt; Maybe (ForwardingM rep [Stm (Aliases rep)]))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">TopDown rep
-&gt; Scope (Aliases rep)
-&gt; Stm (Aliases rep)
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
-&gt; Maybe (ForwardingM rep [Stm (Aliases rep)])
forall rep. TopDown rep -&gt; LowerUpdate rep (ForwardingM rep)
</span><a href="Futhark.Optimise.InPlaceLowering.html#topLowerUpdate"><span class="hs-identifier hs-var hs-var">topLowerUpdate</span></a></span><span>
</span><span id="line-159"></span><span>      </span><span id="local-6989586621684428343"><span class="annot"><span class="annottext">Scope (Aliases rep)
</span><a href="#local-6989586621684428343"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ForwardingM rep (Scope (Aliases rep))
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span>      </span><span class="hs-comment">-- If we forward any updates, we need to remove them from stms'.</span><span>
</span><span id="line-162"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684428341"><span class="annot"><span class="annottext">updated_names :: [VName]
</span><a href="#local-6989586621684428341"><span class="hs-identifier hs-var hs-var">updated_names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-163"></span><span>            </span><span class="annot"><span class="annottext">(DesiredUpdate (VarAliases, LetDec rep) -&gt; VName)
-&gt; [DesiredUpdate (VarAliases, LetDec rep)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DesiredUpdate (VarAliases, LetDec rep) -&gt; VName
forall dec. DesiredUpdate dec -&gt; VName
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#updateName"><span class="hs-identifier hs-var hs-var">updateName</span></a></span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (VarAliases, LetDec rep)]
</span><a href="#local-6989586621684428347"><span class="hs-identifier hs-var">updates</span></a></span><span>
</span><span id="line-164"></span><span>          </span><span id="local-6989586621684428339"><span class="annot"><span class="annottext">notUpdated :: Stm (Aliases rep) -&gt; Bool
</span><a href="#local-6989586621684428339"><span class="hs-identifier hs-var hs-var">notUpdated</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-165"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool)
-&gt; (Stm (Aliases rep) -&gt; Bool) -&gt; Stm (Aliases rep) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684428341"><span class="hs-identifier hs-var">updated_names</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Bool)
-&gt; (Stm (Aliases rep) -&gt; [VName]) -&gt; Stm (Aliases rep) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatT (VarAliases, LetDec rep) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT (VarAliases, LetDec rep) -&gt; [VName])
-&gt; (Stm (Aliases rep) -&gt; PatT (VarAliases, LetDec rep))
-&gt; Stm (Aliases rep)
-&gt; [VName]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep) -&gt; PatT (VarAliases, LetDec rep)
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>      </span><span class="hs-comment">-- Condition (5) and (7) are assumed to be checked by</span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-comment">-- lowerUpdate.</span><span>
</span><span id="line-169"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Scope (Aliases rep)
-&gt; Stm (Aliases rep)
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
-&gt; Maybe (ForwardingM rep [Stm (Aliases rep)])
</span><a href="#local-6989586621684428346"><span class="hs-identifier hs-var">lower</span></a></span><span> </span><span class="annot"><span class="annottext">Scope (Aliases rep)
</span><a href="#local-6989586621684428343"><span class="hs-identifier hs-var">scope</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep)
</span><a href="#local-6989586621684428358"><span class="hs-identifier hs-var">stm'</span></a></span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (VarAliases, LetDec rep)]
</span><a href="#local-6989586621684428347"><span class="hs-identifier hs-var">updates</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-170"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684428335"><span class="annot"><span class="annottext">ForwardingM rep [Stm (Aliases rep)]
</span><a href="#local-6989586621684428335"><span class="hs-identifier hs-var">lowering</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>          </span><span id="local-6989586621684428334"><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428334"><span class="hs-identifier hs-var">new_stms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ForwardingM rep [Stm (Aliases rep)]
</span><a href="#local-6989586621684428335"><span class="hs-identifier hs-var">lowering</span></a></span><span>
</span><span id="line-172"></span><span>          </span><span id="local-6989586621684428333"><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428333"><span class="hs-identifier hs-var">new_stms'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
-&gt; ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)]
forall rep.
Constraints rep =&gt;
[Stm (Aliases rep)]
-&gt; ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)]
</span><a href="Futhark.Optimise.InPlaceLowering.html#optimiseStms"><span class="hs-identifier hs-var">optimiseStms</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428334"><span class="hs-identifier hs-var">new_stms</span></a></span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)])
-&gt; ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BottomUp rep -&gt; ForwardingM rep ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">BottomUp rep
</span><a href="#local-6989586621684428360"><span class="hs-identifier hs-var">bup</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">forwardThese :: [DesiredUpdate (LetDec (Aliases rep))]
</span><a href="Futhark.Optimise.InPlaceLowering.html#forwardThese"><span class="hs-identifier hs-var">forwardThese</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><span id="line-173"></span><span>          </span><span class="annot"><span class="annottext">[Stm (Aliases rep)] -&gt; ForwardingM rep [Stm (Aliases rep)]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([Stm (Aliases rep)] -&gt; ForwardingM rep [Stm (Aliases rep)])
-&gt; [Stm (Aliases rep)] -&gt; ForwardingM rep [Stm (Aliases rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428333"><span class="hs-identifier hs-var">new_stms'</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)] -&gt; [Stm (Aliases rep)] -&gt; [Stm (Aliases rep)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(Stm (Aliases rep) -&gt; Bool)
-&gt; [Stm (Aliases rep)] -&gt; [Stm (Aliases rep)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep) -&gt; Bool
</span><a href="#local-6989586621684428339"><span class="hs-identifier hs-var">notUpdated</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428361"><span class="hs-identifier hs-var">stms'</span></a></span><span>
</span><span id="line-174"></span><span>        </span><span class="annot"><span class="annottext">Maybe (ForwardingM rep [Stm (Aliases rep)])
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-175"></span><span>          </span><span class="annot"><span class="annottext">Stm (Aliases rep) -&gt; ForwardingM rep ()
forall {rep} {rep}.
(Buildable rep, CanBeAliased (Op rep), FreeDec (ExpDec rep),
 FreeDec (BodyDec rep), FreeIn (FParamInfo rep),
 FreeIn (LParamInfo rep), FreeIn (LetDec rep), FreeIn (RetType rep),
 FreeIn (BranchType rep), FreeIn (Op rep),
 LetDec rep ~ (VarAliases, LetDec rep)) =&gt;
Stm rep -&gt; ForwardingM rep ()
</span><a href="#local-6989586621684428348"><span class="hs-identifier hs-var">checkIfForwardableUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep)
</span><a href="#local-6989586621684428358"><span class="hs-identifier hs-var">stm'</span></a></span><span>
</span><span id="line-176"></span><span>          </span><span class="annot"><span class="annottext">[Stm (Aliases rep)] -&gt; ForwardingM rep [Stm (Aliases rep)]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">([Stm (Aliases rep)] -&gt; ForwardingM rep [Stm (Aliases rep)])
-&gt; [Stm (Aliases rep)] -&gt; ForwardingM rep [Stm (Aliases rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep)
</span><a href="#local-6989586621684428358"><span class="hs-identifier hs-var">stm'</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep) -&gt; [Stm (Aliases rep)] -&gt; [Stm (Aliases rep)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428361"><span class="hs-identifier hs-var">stms'</span></a></span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-178"></span><span>    </span><span id="local-6989586621684428350"><span class="annot"><span class="annottext">boundHere :: [VName]
</span><a href="#local-6989586621684428350"><span class="hs-identifier hs-var hs-var">boundHere</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatT (VarAliases, LetDec rep) -&gt; [VName]
forall dec. PatT dec -&gt; [VName]
</span><a href="Futhark.IR.Prop.Patterns.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">(PatT (VarAliases, LetDec rep) -&gt; [VName])
-&gt; PatT (VarAliases, LetDec rep) -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep) -&gt; Pat (Aliases rep)
forall rep. Stm rep -&gt; Pat rep
</span><a href="Futhark.IR.Syntax.html#stmPat"><span class="hs-identifier hs-var hs-var">stmPat</span></a></span><span> </span><span class="annot"><span class="annottext">Stm (Aliases rep)
</span><a href="#local-6989586621684428364"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-179"></span><span>
</span><span id="line-180"></span><span>    </span><span id="local-6989586621684428348"><span class="annot"><span class="annottext">checkIfForwardableUpdate :: Stm rep -&gt; ForwardingM rep ()
</span><a href="#local-6989586621684428348"><span class="hs-identifier hs-var hs-var">checkIfForwardableUpdate</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684428263"><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684428263"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#StmAux"><span class="hs-identifier hs-type">StmAux</span></a></span><span> </span><span id="local-6989586621684428261"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684428261"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExpDec rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684428260"><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684428260"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-type">PatElem</span></a></span><span> </span><span id="local-6989586621684428257"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684428257"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684428256"><span class="annot"><span class="annottext">LetDec rep
</span><a href="#local-6989586621684428256"><span class="hs-identifier hs-var">dec</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat rep
</span><a href="#local-6989586621684428263"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-182"></span><span>        </span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span class="annot"><span class="annottext">Safety
</span><a href="Futhark.IR.Primitive.html#Unsafe"><span class="hs-identifier hs-var">Unsafe</span></a></span><span> </span><span id="local-6989586621684428252"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684428252"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621684428251"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684428251"><span class="hs-identifier hs-var">slice</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684428250"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684428250"><span class="hs-identifier hs-var">ve</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp rep
</span><a href="#local-6989586621684428260"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-183"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; VName
-&gt; LetDec (Aliases rep)
-&gt; Certs
-&gt; VName
-&gt; Slice SubExp
-&gt; ForwardingM rep ()
forall rep.
Constraints rep =&gt;
VName
-&gt; VName
-&gt; LetDec (Aliases rep)
-&gt; Certs
-&gt; VName
-&gt; Slice SubExp
-&gt; ForwardingM rep ()
</span><a href="Futhark.Optimise.InPlaceLowering.html#maybeForward"><span class="hs-identifier hs-var">maybeForward</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684428250"><span class="hs-identifier hs-var">ve</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684428257"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">LetDec rep
LetDec (Aliases rep)
</span><a href="#local-6989586621684428256"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684428261"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684428252"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684428251"><span class="hs-identifier hs-var">slice</span></a></span><span>
</span><span id="line-184"></span><span>    </span><span class="annot"><a href="#local-6989586621684428348"><span class="hs-identifier hs-var">checkIfForwardableUpdate</span></a></span><span> </span><span id="local-6989586621684428248"><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684428248"><span class="hs-identifier hs-var">stm'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-185"></span><span>      </span><span class="annot"><span class="annottext">(VName -&gt; ForwardingM rep ()) -&gt; [VName] -&gt; ForwardingM rep ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ForwardingM rep ()
forall rep. VName -&gt; ForwardingM rep ()
</span><a href="Futhark.Optimise.InPlaceLowering.html#seenVar"><span class="hs-identifier hs-var">seenVar</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; ForwardingM rep ()) -&gt; [VName] -&gt; ForwardingM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; [VName]) -&gt; Names -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp rep -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp rep -&gt; Names) -&gt; Exp rep -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm rep -&gt; Exp rep
forall rep. Stm rep -&gt; Exp rep
</span><a href="Futhark.IR.Syntax.html#stmExp"><span class="hs-identifier hs-var hs-var">stmExp</span></a></span><span> </span><span class="annot"><span class="annottext">Stm rep
</span><a href="#local-6989586621684428248"><span class="hs-identifier hs-var">stm'</span></a></span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span id="local-6989586621684428942"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#optimiseInStm"><span class="hs-identifier hs-type">optimiseInStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428942"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428942"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428942"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428942"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-188"></span><span id="optimiseInStm"><span class="annot"><span class="annottext">optimiseInStm :: forall rep.
Constraints rep =&gt;
Stm (Aliases rep) -&gt; ForwardingM rep (Stm (Aliases rep))
</span><a href="Futhark.Optimise.InPlaceLowering.html#optimiseInStm"><span class="hs-identifier hs-var hs-var">optimiseInStm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684428240"><span class="annot"><span class="annottext">Pat (Aliases rep)
</span><a href="#local-6989586621684428240"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684428239"><span class="annot"><span class="annottext">StmAux (ExpDec (Aliases rep))
</span><a href="#local-6989586621684428239"><span class="hs-identifier hs-var">dec</span></a></span></span><span> </span><span id="local-6989586621684428238"><span class="annot"><span class="annottext">Exp (Aliases rep)
</span><a href="#local-6989586621684428238"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-189"></span><span>  </span><span class="annot"><span class="annottext">Pat (Aliases rep)
-&gt; StmAux (ExpDec (Aliases rep))
-&gt; Exp (Aliases rep)
-&gt; Stm (Aliases rep)
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Aliases rep)
</span><a href="#local-6989586621684428240"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec (Aliases rep))
</span><a href="#local-6989586621684428239"><span class="hs-identifier hs-var">dec</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp (Aliases rep) -&gt; Stm (Aliases rep))
-&gt; ForwardingM rep (Exp (Aliases rep))
-&gt; ForwardingM rep (Stm (Aliases rep))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Exp (Aliases rep) -&gt; ForwardingM rep (Exp (Aliases rep))
forall rep.
Constraints rep =&gt;
Exp (Aliases rep) -&gt; ForwardingM rep (Exp (Aliases rep))
</span><a href="Futhark.Optimise.InPlaceLowering.html#optimiseExp"><span class="hs-identifier hs-var">optimiseExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp (Aliases rep)
</span><a href="#local-6989586621684428238"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-190"></span><span>
</span><span id="line-191"></span><span id="local-6989586621684428899"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#optimiseExp"><span class="hs-identifier hs-type">optimiseExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428899"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428899"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428899"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428899"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-192"></span><span id="optimiseExp"><span class="annot"><span class="annottext">optimiseExp :: forall rep.
Constraints rep =&gt;
Exp (Aliases rep) -&gt; ForwardingM rep (Exp (Aliases rep))
</span><a href="Futhark.Optimise.InPlaceLowering.html#optimiseExp"><span class="hs-identifier hs-var hs-var">optimiseExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span id="local-6989586621684428216"><span class="annot"><span class="annottext">[(FParam (Aliases rep), SubExp)]
</span><a href="#local-6989586621684428216"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684428215"><span class="annot"><span class="annottext">LoopForm (Aliases rep)
</span><a href="#local-6989586621684428215"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684428214"><span class="annot"><span class="annottext">BodyT (Aliases rep)
</span><a href="#local-6989586621684428214"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-193"></span><span>  </span><span class="annot"><span class="annottext">Scope (Aliases rep)
-&gt; ForwardingM rep (ExpT (Aliases rep))
-&gt; ForwardingM rep (ExpT (Aliases rep))
forall rep a.
Scope (Aliases rep) -&gt; ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="Futhark.Optimise.InPlaceLowering.html#bindingScope"><span class="hs-identifier hs-var">bindingScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LoopForm (Aliases rep) -&gt; Scope (Aliases rep)
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm (Aliases rep)
</span><a href="#local-6989586621684428215"><span class="hs-identifier hs-var">form</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep (ExpT (Aliases rep))
 -&gt; ForwardingM rep (ExpT (Aliases rep)))
-&gt; (ForwardingM rep (ExpT (Aliases rep))
    -&gt; ForwardingM rep (ExpT (Aliases rep)))
-&gt; ForwardingM rep (ExpT (Aliases rep))
-&gt; ForwardingM rep (ExpT (Aliases rep))
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[FParam (Aliases rep)]
-&gt; ForwardingM rep (ExpT (Aliases rep))
-&gt; ForwardingM rep (ExpT (Aliases rep))
forall rep a.
[FParam (Aliases rep)] -&gt; ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="Futhark.Optimise.InPlaceLowering.html#bindingFParams"><span class="hs-identifier hs-var">bindingFParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Param DeclType, SubExp) -&gt; Param DeclType)
-&gt; [(Param DeclType, SubExp)] -&gt; [Param DeclType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param DeclType, SubExp) -&gt; Param DeclType
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
[(FParam (Aliases rep), SubExp)]
</span><a href="#local-6989586621684428216"><span class="hs-identifier hs-var">merge</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep (ExpT (Aliases rep))
 -&gt; ForwardingM rep (ExpT (Aliases rep)))
-&gt; ForwardingM rep (ExpT (Aliases rep))
-&gt; ForwardingM rep (ExpT (Aliases rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><span class="annottext">[(FParam (Aliases rep), SubExp)]
-&gt; LoopForm (Aliases rep)
-&gt; BodyT (Aliases rep)
-&gt; ExpT (Aliases rep)
forall rep.
[(FParam rep, SubExp)] -&gt; LoopForm rep -&gt; BodyT rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-var">DoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam (Aliases rep), SubExp)]
</span><a href="#local-6989586621684428216"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm (Aliases rep)
</span><a href="#local-6989586621684428215"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="annot"><span class="annottext">(BodyT (Aliases rep) -&gt; ExpT (Aliases rep))
-&gt; ForwardingM rep (BodyT (Aliases rep))
-&gt; ForwardingM rep (ExpT (Aliases rep))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">BodyT (Aliases rep) -&gt; ForwardingM rep (BodyT (Aliases rep))
forall rep.
Constraints rep =&gt;
Body (Aliases rep) -&gt; ForwardingM rep (Body (Aliases rep))
</span><a href="Futhark.Optimise.InPlaceLowering.html#optimiseBody"><span class="hs-identifier hs-var">optimiseBody</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT (Aliases rep)
</span><a href="#local-6989586621684428214"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-195"></span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#optimiseExp"><span class="hs-identifier hs-var">optimiseExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span id="local-6989586621684428210"><span class="annot"><span class="annottext">Op (Aliases rep)
</span><a href="#local-6989586621684428210"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-196"></span><span>  </span><span id="local-6989586621684428209"><span class="annot"><span class="annottext">OpWithAliases (Op rep) -&gt; ForwardingM rep (OpWithAliases (Op rep))
</span><a href="#local-6989586621684428209"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TopDown rep
 -&gt; OpWithAliases (Op rep)
 -&gt; ForwardingM rep (OpWithAliases (Op rep)))
-&gt; ForwardingM
     rep
     (OpWithAliases (Op rep)
      -&gt; ForwardingM rep (OpWithAliases (Op rep)))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">TopDown rep
-&gt; OpWithAliases (Op rep)
-&gt; ForwardingM rep (OpWithAliases (Op rep))
forall rep. TopDown rep -&gt; OnOp rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#topOnOp"><span class="hs-identifier hs-var hs-var">topOnOp</span></a></span><span>
</span><span id="line-197"></span><span>  </span><span class="annot"><span class="annottext">OpWithAliases (Op rep) -&gt; ExpT (Aliases rep)
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(OpWithAliases (Op rep) -&gt; ExpT (Aliases rep))
-&gt; ForwardingM rep (OpWithAliases (Op rep))
-&gt; ForwardingM rep (ExpT (Aliases rep))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">OpWithAliases (Op rep) -&gt; ForwardingM rep (OpWithAliases (Op rep))
</span><a href="#local-6989586621684428209"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Op (Aliases rep)
OpWithAliases (Op rep)
</span><a href="#local-6989586621684428210"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-198"></span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#optimiseExp"><span class="hs-identifier hs-var">optimiseExp</span></a></span><span> </span><span id="local-6989586621684428207"><span class="annot"><span class="annottext">ExpT (Aliases rep)
</span><a href="#local-6989586621684428207"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Mapper (Aliases rep) (Aliases rep) (ForwardingM rep)
-&gt; ExpT (Aliases rep) -&gt; ForwardingM rep (ExpT (Aliases rep))
forall (m :: * -&gt; *) frep trep.
(Applicative m, Monad m) =&gt;
Mapper frep trep m -&gt; Exp frep -&gt; m (Exp trep)
</span><a href="Futhark.IR.Traversals.html#mapExpM"><span class="hs-identifier hs-var">mapExpM</span></a></span><span> </span><span class="annot"><span class="annottext">Mapper (Aliases rep) (Aliases rep) (ForwardingM rep)
</span><a href="#local-6989586621684428205"><span class="hs-identifier hs-var">optimise</span></a></span><span> </span><span class="annot"><span class="annottext">ExpT (Aliases rep)
</span><a href="#local-6989586621684428207"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-200"></span><span>    </span><span id="local-6989586621684428205"><span class="annot"><span class="annottext">optimise :: Mapper (Aliases rep) (Aliases rep) (ForwardingM rep)
</span><a href="#local-6989586621684428205"><span class="hs-identifier hs-var hs-var">optimise</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-201"></span><span>      </span><span class="annot"><span class="annottext">Mapper (Aliases rep) (Aliases rep) (ForwardingM rep)
forall (m :: * -&gt; *) rep. Monad m =&gt; Mapper rep rep m
</span><a href="Futhark.IR.Traversals.html#identityMapper"><span class="hs-identifier hs-var">identityMapper</span></a></span><span>
</span><span id="line-202"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnBody :: Scope (Aliases rep)
-&gt; BodyT (Aliases rep) -&gt; ForwardingM rep (BodyT (Aliases rep))
</span><a href="Futhark.IR.Traversals.html#mapOnBody"><span class="hs-identifier hs-var">mapOnBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(BodyT (Aliases rep) -&gt; ForwardingM rep (BodyT (Aliases rep)))
-&gt; Scope (Aliases rep)
-&gt; BodyT (Aliases rep)
-&gt; ForwardingM rep (BodyT (Aliases rep))
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">BodyT (Aliases rep) -&gt; ForwardingM rep (BodyT (Aliases rep))
forall rep.
Constraints rep =&gt;
Body (Aliases rep) -&gt; ForwardingM rep (Body (Aliases rep))
</span><a href="Futhark.Optimise.InPlaceLowering.html#optimiseBody"><span class="hs-identifier hs-var">optimiseBody</span></a></span><span>
</span><span id="line-203"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span id="local-6989586621684428876"><span id="local-6989586621684428877"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#onSegOp"><span class="hs-identifier hs-type">onSegOp</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-206"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Builder.Class.html#Buildable"><span class="hs-identifier hs-type">Buildable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428877"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Aliases.html#CanBeAliased"><span class="hs-identifier hs-type">CanBeAliased</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428877"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-207"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428876"><span class="hs-identifier hs-type">lvl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428877"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-208"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428877"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428876"><span class="hs-identifier hs-type">lvl</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428877"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-209"></span><span id="onSegOp"><span class="annot"><span class="annottext">onSegOp :: forall rep lvl.
(Buildable rep, CanBeAliased (Op rep)) =&gt;
SegOp lvl (Aliases rep)
-&gt; ForwardingM rep (SegOp lvl (Aliases rep))
</span><a href="Futhark.Optimise.InPlaceLowering.html#onSegOp"><span class="hs-identifier hs-var hs-var">onSegOp</span></a></span></span><span> </span><span id="local-6989586621684428187"><span class="annot"><span class="annottext">SegOp lvl (Aliases rep)
</span><a href="#local-6989586621684428187"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-210"></span><span>  </span><span class="annot"><span class="annottext">Scope (Aliases rep)
-&gt; ForwardingM rep (SegOp lvl (Aliases rep))
-&gt; ForwardingM rep (SegOp lvl (Aliases rep))
forall rep a.
Scope (Aliases rep) -&gt; ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="Futhark.Optimise.InPlaceLowering.html#bindingScope"><span class="hs-identifier hs-var">bindingScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; Scope (Aliases rep)
forall rep. SegSpace -&gt; Scope rep
</span><a href="Futhark.IR.SegOp.html#scopeOfSegSpace"><span class="hs-identifier hs-var">scopeOfSegSpace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOp lvl (Aliases rep) -&gt; SegSpace
forall lvl rep. SegOp lvl rep -&gt; SegSpace
</span><a href="Futhark.IR.SegOp.html#segSpace"><span class="hs-identifier hs-var">segSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp lvl (Aliases rep)
</span><a href="#local-6989586621684428187"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep (SegOp lvl (Aliases rep))
 -&gt; ForwardingM rep (SegOp lvl (Aliases rep)))
-&gt; ForwardingM rep (SegOp lvl (Aliases rep))
-&gt; ForwardingM rep (SegOp lvl (Aliases rep))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-211"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684428178"><span class="annot"><span class="annottext">mapper :: SegOpMapper lvl (Aliases rep) (Aliases rep) (ForwardingM rep)
</span><a href="#local-6989586621684428178"><span class="hs-identifier hs-var hs-var">mapper</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegOpMapper lvl (Aliases rep) (Aliases rep) (ForwardingM rep)
forall (m :: * -&gt; *) lvl rep. Monad m =&gt; SegOpMapper lvl rep rep m
</span><a href="Futhark.IR.SegOp.html#identitySegOpMapper"><span class="hs-identifier hs-var">identitySegOpMapper</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">mapOnSegOpBody :: KernelBody (Aliases rep)
-&gt; ForwardingM rep (KernelBody (Aliases rep))
</span><a href="Futhark.IR.SegOp.html#mapOnSegOpBody"><span class="hs-identifier hs-var">mapOnSegOpBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">KernelBody (Aliases rep)
-&gt; ForwardingM rep (KernelBody (Aliases rep))
forall {rep}.
(Buildable rep, CanBeAliased (Op rep)) =&gt;
KernelBody (Aliases rep)
-&gt; ForwardingM rep (KernelBody (Aliases rep))
</span><a href="#local-6989586621684428175"><span class="hs-identifier hs-var">onKernelBody</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-212"></span><span>        </span><span id="local-6989586621684428175"><span class="annot"><span class="annottext">onKernelBody :: KernelBody (Aliases rep)
-&gt; ForwardingM rep (KernelBody (Aliases rep))
</span><a href="#local-6989586621684428175"><span class="hs-identifier hs-var hs-var">onKernelBody</span></a></span></span><span> </span><span id="local-6989586621684428156"><span class="annot"><span class="annottext">KernelBody (Aliases rep)
</span><a href="#local-6989586621684428156"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-213"></span><span>          </span><span id="local-6989586621684428155"><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428155"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-214"></span><span>            </span><span class="annot"><span class="annottext">ForwardingM rep [Stm (Aliases rep)]
-&gt; ForwardingM rep [Stm (Aliases rep)]
forall rep a. ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="Futhark.Optimise.InPlaceLowering.html#deepen"><span class="hs-identifier hs-var">deepen</span></a></span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep [Stm (Aliases rep)]
 -&gt; ForwardingM rep [Stm (Aliases rep)])
-&gt; ForwardingM rep [Stm (Aliases rep)]
-&gt; ForwardingM rep [Stm (Aliases rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-215"></span><span>              </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
-&gt; ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)]
forall rep.
Constraints rep =&gt;
[Stm (Aliases rep)]
-&gt; ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)]
</span><a href="Futhark.Optimise.InPlaceLowering.html#optimiseStms"><span class="hs-identifier hs-var">optimiseStms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms (Aliases rep) -&gt; [Stm (Aliases rep)]
forall rep. Stms rep -&gt; [Stm rep]
</span><a href="Futhark.IR.Syntax.html#stmsToList"><span class="hs-identifier hs-var">stmsToList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody (Aliases rep) -&gt; Stms (Aliases rep)
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody (Aliases rep)
</span><a href="#local-6989586621684428156"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)])
-&gt; ForwardingM rep () -&gt; ForwardingM rep [Stm (Aliases rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-216"></span><span>                </span><span class="annot"><span class="annottext">(VName -&gt; ForwardingM rep ()) -&gt; [VName] -&gt; ForwardingM rep ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><span class="hs-identifier hs-var">mapM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ForwardingM rep ()
forall rep. VName -&gt; ForwardingM rep ()
</span><a href="Futhark.Optimise.InPlaceLowering.html#seenVar"><span class="hs-identifier hs-var">seenVar</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; ForwardingM rep ()) -&gt; [VName] -&gt; ForwardingM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; [VName]) -&gt; Names -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[KernelResult] -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; Names) -&gt; [KernelResult] -&gt; Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody (Aliases rep) -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody (Aliases rep)
</span><a href="#local-6989586621684428156"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-217"></span><span>          </span><span class="annot"><span class="annottext">KernelBody (Aliases rep)
-&gt; ForwardingM rep (KernelBody (Aliases rep))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">KernelBody (Aliases rep)
</span><a href="#local-6989586621684428156"><span class="hs-identifier hs-var">kbody</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">kernelBodyStms :: Stms (Aliases rep)
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var">kernelBodyStms</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)] -&gt; Stms (Aliases rep)
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm (Aliases rep)]
</span><a href="#local-6989586621684428155"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-218"></span><span>    </span><span class="annot"><span class="annottext">SegOpMapper lvl (Aliases rep) (Aliases rep) (ForwardingM rep)
-&gt; SegOp lvl (Aliases rep)
-&gt; ForwardingM rep (SegOp lvl (Aliases rep))
forall (m :: * -&gt; *) lvl frep trep.
(Applicative m, Monad m) =&gt;
SegOpMapper lvl frep trep m -&gt; SegOp lvl frep -&gt; m (SegOp lvl trep)
</span><a href="Futhark.IR.SegOp.html#mapSegOpM"><span class="hs-identifier hs-var">mapSegOpM</span></a></span><span> </span><span class="annot"><span class="annottext">SegOpMapper lvl (Aliases rep) (Aliases rep) (ForwardingM rep)
forall {lvl}.
SegOpMapper lvl (Aliases rep) (Aliases rep) (ForwardingM rep)
</span><a href="#local-6989586621684428178"><span class="hs-identifier hs-var">mapper</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp lvl (Aliases rep)
</span><a href="#local-6989586621684428187"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-219"></span><span>
</span><span id="line-220"></span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#onMCOp"><span class="hs-identifier hs-type">onMCOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#OnOp"><span class="hs-identifier hs-type">OnOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span>
</span><span id="line-221"></span><span id="onMCOp"><span class="annot"><span class="annottext">onMCOp :: OnOp MC
</span><a href="Futhark.Optimise.InPlaceLowering.html#onMCOp"><span class="hs-identifier hs-var hs-var">onMCOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-type">ParOp</span></a></span><span> </span><span id="local-6989586621684428150"><span class="annot"><span class="annottext">Maybe (SegOp () (Aliases MC))
</span><a href="#local-6989586621684428150"><span class="hs-identifier hs-var">par_op</span></a></span></span><span> </span><span id="local-6989586621684428149"><span class="annot"><span class="annottext">SegOp () (Aliases MC)
</span><a href="#local-6989586621684428149"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () (Aliases MC))
-&gt; SegOp () (Aliases MC) -&gt; MCOp (Aliases MC) (SOAC (Aliases MC))
forall rep op. Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-var">ParOp</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (SegOp () (Aliases MC))
 -&gt; SegOp () (Aliases MC) -&gt; MCOp (Aliases MC) (SOAC (Aliases MC)))
-&gt; ForwardingM MC (Maybe (SegOp () (Aliases MC)))
-&gt; ForwardingM
     MC (SegOp () (Aliases MC) -&gt; MCOp (Aliases MC) (SOAC (Aliases MC)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(SegOp () (Aliases MC) -&gt; ForwardingM MC (SegOp () (Aliases MC)))
-&gt; Maybe (SegOp () (Aliases MC))
-&gt; ForwardingM MC (Maybe (SegOp () (Aliases MC)))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">SegOp () (Aliases MC) -&gt; ForwardingM MC (SegOp () (Aliases MC))
forall rep lvl.
(Buildable rep, CanBeAliased (Op rep)) =&gt;
SegOp lvl (Aliases rep)
-&gt; ForwardingM rep (SegOp lvl (Aliases rep))
</span><a href="Futhark.Optimise.InPlaceLowering.html#onSegOp"><span class="hs-identifier hs-var">onSegOp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () (Aliases MC))
</span><a href="#local-6989586621684428150"><span class="hs-identifier hs-var">par_op</span></a></span><span> </span><span class="annot"><span class="annottext">ForwardingM
  MC (SegOp () (Aliases MC) -&gt; MCOp (Aliases MC) (SOAC (Aliases MC)))
-&gt; ForwardingM MC (SegOp () (Aliases MC))
-&gt; ForwardingM MC (MCOp (Aliases MC) (SOAC (Aliases MC)))
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SegOp () (Aliases MC) -&gt; ForwardingM MC (SegOp () (Aliases MC))
forall rep lvl.
(Buildable rep, CanBeAliased (Op rep)) =&gt;
SegOp lvl (Aliases rep)
-&gt; ForwardingM rep (SegOp lvl (Aliases rep))
</span><a href="Futhark.Optimise.InPlaceLowering.html#onSegOp"><span class="hs-identifier hs-var">onSegOp</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp () (Aliases MC)
</span><a href="#local-6989586621684428149"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-222"></span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#onMCOp"><span class="hs-identifier hs-var">onMCOp</span></a></span><span> </span><span id="local-6989586621684428147"><span class="annot"><span class="annottext">Op (Aliases MC)
</span><a href="#local-6989586621684428147"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MCOp (Aliases MC) (SOAC (Aliases MC))
-&gt; ForwardingM MC (MCOp (Aliases MC) (SOAC (Aliases MC)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Op (Aliases MC)
MCOp (Aliases MC) (SOAC (Aliases MC))
</span><a href="#local-6989586621684428147"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-223"></span><span>
</span><span id="line-224"></span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#onKernelOp"><span class="hs-identifier hs-type">onKernelOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#OnOp"><span class="hs-identifier hs-type">OnOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.html#GPU"><span class="hs-identifier hs-type">GPU</span></a></span><span>
</span><span id="line-225"></span><span id="onKernelOp"><span class="annot"><span class="annottext">onKernelOp :: OnOp GPU
</span><a href="Futhark.Optimise.InPlaceLowering.html#onKernelOp"><span class="hs-identifier hs-var hs-var">onKernelOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span id="local-6989586621684428145"><span class="annot"><span class="annottext">SegOp SegLevel (Aliases GPU)
</span><a href="#local-6989586621684428145"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel (Aliases GPU)
-&gt; HostOp (Aliases GPU) (SOAC (Aliases GPU))
forall rep op. SegOp SegLevel rep -&gt; HostOp rep op
</span><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-var">SegOp</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp SegLevel (Aliases GPU)
 -&gt; HostOp (Aliases GPU) (SOAC (Aliases GPU)))
-&gt; ForwardingM GPU (SegOp SegLevel (Aliases GPU))
-&gt; ForwardingM GPU (HostOp (Aliases GPU) (SOAC (Aliases GPU)))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel (Aliases GPU)
-&gt; ForwardingM GPU (SegOp SegLevel (Aliases GPU))
forall rep lvl.
(Buildable rep, CanBeAliased (Op rep)) =&gt;
SegOp lvl (Aliases rep)
-&gt; ForwardingM rep (SegOp lvl (Aliases rep))
</span><a href="Futhark.Optimise.InPlaceLowering.html#onSegOp"><span class="hs-identifier hs-var">onSegOp</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel (Aliases GPU)
</span><a href="#local-6989586621684428145"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-226"></span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#onKernelOp"><span class="hs-identifier hs-var">onKernelOp</span></a></span><span> </span><span id="local-6989586621684428144"><span class="annot"><span class="annottext">Op (Aliases GPU)
</span><a href="#local-6989586621684428144"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostOp (Aliases GPU) (SOAC (Aliases GPU))
-&gt; ForwardingM GPU (HostOp (Aliases GPU) (SOAC (Aliases GPU)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Op (Aliases GPU)
HostOp (Aliases GPU) (SOAC (Aliases GPU))
</span><a href="#local-6989586621684428144"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-227"></span><span>
</span><span id="line-228"></span><span class="hs-keyword">data</span><span> </span><span id="Entry"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#Entry"><span class="hs-identifier hs-var">Entry</span></a></span></span><span> </span><span id="local-6989586621684428843"><span class="annot"><a href="#local-6989586621684428843"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Entry"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#Entry"><span class="hs-identifier hs-var">Entry</span></a></span></span><span>
</span><span id="line-229"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="entryNumber"><span class="annot"><span class="annottext">forall rep. Entry rep -&gt; Int
</span><a href="Futhark.Optimise.InPlaceLowering.html#entryNumber"><span class="hs-identifier hs-var hs-var">entryNumber</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-230"></span><span>    </span><span id="entryAliases"><span class="annot"><span class="annottext">forall rep. Entry rep -&gt; Names
</span><a href="Futhark.Optimise.InPlaceLowering.html#entryAliases"><span class="hs-identifier hs-var hs-var">entryAliases</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-231"></span><span>    </span><span id="entryDepth"><span class="annot"><span class="annottext">forall rep. Entry rep -&gt; Int
</span><a href="Futhark.Optimise.InPlaceLowering.html#entryDepth"><span class="hs-identifier hs-var hs-var">entryDepth</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-232"></span><span>    </span><span id="entryOptimisable"><span class="annot"><span class="annottext">forall rep. Entry rep -&gt; Bool
</span><a href="Futhark.Optimise.InPlaceLowering.html#entryOptimisable"><span class="hs-identifier hs-var hs-var">entryOptimisable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">,</span><span>
</span><span id="line-233"></span><span>    </span><span id="entryType"><span class="annot"><span class="annottext">forall rep. Entry rep -&gt; NameInfo (Aliases rep)
</span><a href="Futhark.Optimise.InPlaceLowering.html#entryType"><span class="hs-identifier hs-var hs-var">entryType</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#NameInfo"><span class="hs-identifier hs-type">NameInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428843"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span class="hs-keyword">type</span><span> </span><span id="VTable"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#VTable"><span class="hs-identifier hs-var">VTable</span></a></span></span><span> </span><span id="local-6989586621684428137"><span class="annot"><a href="#local-6989586621684428137"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#Entry"><span class="hs-identifier hs-type">Entry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428137"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span class="hs-keyword">type</span><span> </span><span id="OnOp"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#OnOp"><span class="hs-identifier hs-var">OnOp</span></a></span></span><span> </span><span id="local-6989586621684428136"><span class="annot"><a href="#local-6989586621684428136"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428136"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428136"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428136"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-239"></span><span>
</span><span id="line-240"></span><span class="hs-keyword">data</span><span> </span><span id="TopDown"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#TopDown"><span class="hs-identifier hs-var">TopDown</span></a></span></span><span> </span><span id="local-6989586621684428925"><span class="annot"><a href="#local-6989586621684428925"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="TopDown"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#TopDown"><span class="hs-identifier hs-var">TopDown</span></a></span></span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="topDownCounter"><span class="annot"><span class="annottext">forall rep. TopDown rep -&gt; Int
</span><a href="Futhark.Optimise.InPlaceLowering.html#topDownCounter"><span class="hs-identifier hs-var hs-var">topDownCounter</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-242"></span><span>    </span><span id="topDownTable"><span class="annot"><span class="annottext">forall rep. TopDown rep -&gt; VTable rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#topDownTable"><span class="hs-identifier hs-var hs-var">topDownTable</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#VTable"><span class="hs-identifier hs-type">VTable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428925"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-243"></span><span>    </span><span id="topDownDepth"><span class="annot"><span class="annottext">forall rep. TopDown rep -&gt; Int
</span><a href="Futhark.Optimise.InPlaceLowering.html#topDownDepth"><span class="hs-identifier hs-var hs-var">topDownDepth</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-244"></span><span>    </span><span id="topLowerUpdate"><span class="annot"><span class="annottext">forall rep. TopDown rep -&gt; LowerUpdate rep (ForwardingM rep)
</span><a href="Futhark.Optimise.InPlaceLowering.html#topLowerUpdate"><span class="hs-identifier hs-var hs-var">topLowerUpdate</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#LowerUpdate"><span class="hs-identifier hs-type">LowerUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428925"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428925"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-245"></span><span>    </span><span id="topOnOp"><span class="annot"><span class="annottext">forall rep. TopDown rep -&gt; OnOp rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#topOnOp"><span class="hs-identifier hs-var hs-var">topOnOp</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#OnOp"><span class="hs-identifier hs-type">OnOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428925"><span class="hs-identifier hs-type">rep</span></a></span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span class="hs-keyword">data</span><span> </span><span id="BottomUp"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#BottomUp"><span class="hs-identifier hs-var">BottomUp</span></a></span></span><span> </span><span id="local-6989586621684428934"><span class="annot"><a href="#local-6989586621684428934"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="BottomUp"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#BottomUp"><span class="hs-identifier hs-var">BottomUp</span></a></span></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="bottomUpSeen"><span class="annot"><span class="annottext">forall rep. BottomUp rep -&gt; Names
</span><a href="Futhark.Optimise.InPlaceLowering.html#bottomUpSeen"><span class="hs-identifier hs-var hs-var">bottomUpSeen</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-250"></span><span>    </span><span id="forwardThese"><span class="annot"><span class="annottext">forall rep. BottomUp rep -&gt; [DesiredUpdate (LetDec (Aliases rep))]
</span><a href="Futhark.Optimise.InPlaceLowering.html#forwardThese"><span class="hs-identifier hs-var hs-var">forwardThese</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier hs-type">DesiredUpdate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428934"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-252"></span><span>
</span><span id="line-253"></span><span id="local-6989586621684428824"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684428126"><span id="local-6989586621684428128"><span class="annot"><span class="hs-identifier hs-type">Semigroup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#BottomUp"><span class="hs-identifier hs-type">BottomUp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428824"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-254"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#BottomUp"><span class="hs-identifier hs-type">BottomUp</span></a></span><span> </span><span id="local-6989586621684428120"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684428120"><span class="hs-identifier hs-var">seen1</span></a></span></span><span> </span><span id="local-6989586621684428119"><span class="annot"><span class="annottext">[DesiredUpdate (LetDec (Aliases rep))]
</span><a href="#local-6989586621684428119"><span class="hs-identifier hs-var">forward1</span></a></span></span><span> </span><span id="local-6989586621684428118"><span class="annot"><span class="annottext">&lt;&gt; :: BottomUp rep -&gt; BottomUp rep -&gt; BottomUp rep
</span><span class="hs-operator hs-var hs-var hs-var hs-var">&lt;&gt;</span></span></span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#BottomUp"><span class="hs-identifier hs-type">BottomUp</span></a></span><span> </span><span id="local-6989586621684428117"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684428117"><span class="hs-identifier hs-var">seen2</span></a></span></span><span> </span><span id="local-6989586621684428116"><span class="annot"><span class="annottext">[DesiredUpdate (LetDec (Aliases rep))]
</span><a href="#local-6989586621684428116"><span class="hs-identifier hs-var">forward2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-255"></span><span>    </span><span class="annot"><span class="annottext">Names -&gt; [DesiredUpdate (LetDec (Aliases rep))] -&gt; BottomUp rep
forall rep.
Names -&gt; [DesiredUpdate (LetDec (Aliases rep))] -&gt; BottomUp rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#BottomUp"><span class="hs-identifier hs-var">BottomUp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684428120"><span class="hs-identifier hs-var">seen1</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684428117"><span class="hs-identifier hs-var">seen2</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DesiredUpdate (VarAliases, LetDec rep)]
[DesiredUpdate (LetDec (Aliases rep))]
</span><a href="#local-6989586621684428119"><span class="hs-identifier hs-var">forward1</span></a></span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (VarAliases, LetDec rep)]
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
-&gt; [DesiredUpdate (VarAliases, LetDec rep)]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (VarAliases, LetDec rep)]
[DesiredUpdate (LetDec (Aliases rep))]
</span><a href="#local-6989586621684428116"><span class="hs-identifier hs-var">forward2</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-256"></span><span>
</span><span id="line-257"></span><span id="local-6989586621684428821"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684428109"><span id="local-6989586621684428111"><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#BottomUp"><span class="hs-identifier hs-type">BottomUp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428821"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-258"></span><span>  </span><span id="local-6989586621684428103"><span class="annot"><span class="annottext">mempty :: BottomUp rep
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">mempty</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names -&gt; [DesiredUpdate (LetDec (Aliases rep))] -&gt; BottomUp rep
forall rep.
Names -&gt; [DesiredUpdate (LetDec (Aliases rep))] -&gt; BottomUp rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#BottomUp"><span class="hs-identifier hs-var">BottomUp</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">[DesiredUpdate (LetDec (Aliases rep))]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span class="hs-keyword">newtype</span><span> </span><span id="ForwardingM"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-var">ForwardingM</span></a></span></span><span> </span><span id="local-6989586621684429058"><span class="annot"><a href="#local-6989586621684429058"><span class="hs-identifier hs-type">rep</span></a></span></span><span> </span><span id="local-6989586621684428102"><span class="annot"><a href="#local-6989586621684428102"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ForwardingM"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-var">ForwardingM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">RWS</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#TopDown"><span class="hs-identifier hs-type">TopDown</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429058"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#BottomUp"><span class="hs-identifier hs-type">BottomUp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429058"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428102"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-special">(</span><span> </span><span id="local-6989586621684428084"><span id="local-6989586621684428090"><span id="local-6989586621684428097"><span class="annot"><span class="annottext">Applicative (ForwardingM rep)
Applicative (ForwardingM rep)
-&gt; (forall a b.
    ForwardingM rep a -&gt; (a -&gt; ForwardingM rep b) -&gt; ForwardingM rep b)
-&gt; (forall a b.
    ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep b)
-&gt; (forall a. a -&gt; ForwardingM rep a)
-&gt; Monad (ForwardingM rep)
forall rep. Applicative (ForwardingM rep)
forall a. a -&gt; ForwardingM rep a
forall rep a. a -&gt; ForwardingM rep a
forall a b.
ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep b
forall a b.
ForwardingM rep a -&gt; (a -&gt; ForwardingM rep b) -&gt; ForwardingM rep b
forall rep a b.
ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep b
forall rep a b.
ForwardingM rep a -&gt; (a -&gt; ForwardingM rep b) -&gt; ForwardingM rep b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: forall a. a -&gt; ForwardingM rep a
$creturn :: forall rep a. a -&gt; ForwardingM rep a
&gt;&gt; :: forall a b.
ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep b
$c&gt;&gt; :: forall rep a b.
ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep b
&gt;&gt;= :: forall a b.
ForwardingM rep a -&gt; (a -&gt; ForwardingM rep b) -&gt; ForwardingM rep b
$c&gt;&gt;= :: forall rep a b.
ForwardingM rep a -&gt; (a -&gt; ForwardingM rep b) -&gt; ForwardingM rep b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-263"></span><span>      </span><span id="local-6989586621684428045"><span id="local-6989586621684428052"><span id="local-6989586621684428059"><span id="local-6989586621684428066"><span id="local-6989586621684428074"><span class="annot"><span class="annottext">Functor (ForwardingM rep)
Functor (ForwardingM rep)
-&gt; (forall a. a -&gt; ForwardingM rep a)
-&gt; (forall a b.
    ForwardingM rep (a -&gt; b) -&gt; ForwardingM rep a -&gt; ForwardingM rep b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c)
    -&gt; ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep c)
-&gt; (forall a b.
    ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep b)
-&gt; (forall a b.
    ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep a)
-&gt; Applicative (ForwardingM rep)
forall rep. Functor (ForwardingM rep)
forall a. a -&gt; ForwardingM rep a
forall rep a. a -&gt; ForwardingM rep a
forall a b.
ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep a
forall a b.
ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep b
forall a b.
ForwardingM rep (a -&gt; b) -&gt; ForwardingM rep a -&gt; ForwardingM rep b
forall rep a b.
ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep a
forall rep a b.
ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep b
forall rep a b.
ForwardingM rep (a -&gt; b) -&gt; ForwardingM rep a -&gt; ForwardingM rep b
forall a b c.
(a -&gt; b -&gt; c)
-&gt; ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep c
forall rep a b c.
(a -&gt; b -&gt; c)
-&gt; ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: forall a b.
ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep a
$c&lt;* :: forall rep a b.
ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep a
*&gt; :: forall a b.
ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep b
$c*&gt; :: forall rep a b.
ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep b
liftA2 :: forall a b c.
(a -&gt; b -&gt; c)
-&gt; ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep c
$cliftA2 :: forall rep a b c.
(a -&gt; b -&gt; c)
-&gt; ForwardingM rep a -&gt; ForwardingM rep b -&gt; ForwardingM rep c
&lt;*&gt; :: forall a b.
ForwardingM rep (a -&gt; b) -&gt; ForwardingM rep a -&gt; ForwardingM rep b
$c&lt;*&gt; :: forall rep a b.
ForwardingM rep (a -&gt; b) -&gt; ForwardingM rep a -&gt; ForwardingM rep b
pure :: forall a. a -&gt; ForwardingM rep a
$cpure :: forall rep a. a -&gt; ForwardingM rep a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-264"></span><span>      </span><span id="local-6989586621684428030"><span id="local-6989586621684428036"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; ForwardingM rep a -&gt; ForwardingM rep b)
-&gt; (forall a b. a -&gt; ForwardingM rep b -&gt; ForwardingM rep a)
-&gt; Functor (ForwardingM rep)
forall a b. a -&gt; ForwardingM rep b -&gt; ForwardingM rep a
forall a b. (a -&gt; b) -&gt; ForwardingM rep a -&gt; ForwardingM rep b
forall rep a b. a -&gt; ForwardingM rep b -&gt; ForwardingM rep a
forall rep a b. (a -&gt; b) -&gt; ForwardingM rep a -&gt; ForwardingM rep b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: forall a b. a -&gt; ForwardingM rep b -&gt; ForwardingM rep a
$c&lt;$ :: forall rep a b. a -&gt; ForwardingM rep b -&gt; ForwardingM rep a
fmap :: forall a b. (a -&gt; b) -&gt; ForwardingM rep a -&gt; ForwardingM rep b
$cfmap :: forall rep a b. (a -&gt; b) -&gt; ForwardingM rep a -&gt; ForwardingM rep b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-265"></span><span>      </span><span id="local-6989586621684428009"><span id="local-6989586621684428015"><span id="local-6989586621684428022"><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#TopDown"><span class="hs-identifier hs-type">TopDown</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429058"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-266"></span><span>      </span><span id="local-6989586621684427979"><span id="local-6989586621684427985"><span id="local-6989586621684427991"><span id="local-6989586621684427998"><span class="annot"><span class="hs-identifier hs-type">MonadWriter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#BottomUp"><span class="hs-identifier hs-type">BottomUp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429058"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-267"></span><span>      </span><span id="local-6989586621684427957"><span id="local-6989586621684427963"><span id="local-6989586621684427970"><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span></span></span></span><span>
</span><span id="line-268"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span id="local-6989586621684429059"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429059"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-271"></span><span>  </span><span id="local-6989586621684427942"><span class="annot"><span class="annottext">getNameSource :: ForwardingM rep VNameSource
</span><a href="Futhark.MonadFreshNames.html#getNameSource"><span class="hs-identifier hs-var hs-var hs-var hs-var">getNameSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ForwardingM rep VNameSource
forall s (m :: * -&gt; *). MonadState s m =&gt; m s
</span><span class="hs-identifier hs-var">get</span></span><span>
</span><span id="line-272"></span><span>  </span><span id="local-6989586621684427938"><span class="annot"><span class="annottext">putNameSource :: VNameSource -&gt; ForwardingM rep ()
</span><a href="Futhark.MonadFreshNames.html#putNameSource"><span class="hs-identifier hs-var hs-var hs-var hs-var">putNameSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VNameSource -&gt; ForwardingM rep ()
forall s (m :: * -&gt; *). MonadState s m =&gt; s -&gt; m ()
</span><span class="hs-identifier hs-var">put</span></span></span><span>
</span><span id="line-273"></span><span>
</span><span id="line-274"></span><span id="local-6989586621684428948"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684427923"><span id="local-6989586621684427926"><span id="local-6989586621684427928"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428948"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428948"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428948"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-275"></span><span>  </span><span id="local-6989586621684427919"><span class="annot"><span class="annottext">askScope :: ForwardingM rep (Scope (Aliases rep))
</span><a href="#local-6989586621684427919"><span class="hs-identifier hs-var hs-var hs-var hs-var">askScope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Entry rep -&gt; NameInfo (Aliases rep))
-&gt; Map VName (Entry rep) -&gt; Scope (Aliases rep)
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">Entry rep -&gt; NameInfo (Aliases rep)
forall rep. Entry rep -&gt; NameInfo (Aliases rep)
</span><a href="Futhark.Optimise.InPlaceLowering.html#entryType"><span class="hs-identifier hs-var hs-var">entryType</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName (Entry rep) -&gt; Scope (Aliases rep))
-&gt; ForwardingM rep (Map VName (Entry rep))
-&gt; ForwardingM rep (Scope (Aliases rep))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(TopDown rep -&gt; Map VName (Entry rep))
-&gt; ForwardingM rep (Map VName (Entry rep))
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">TopDown rep -&gt; Map VName (Entry rep)
forall rep. TopDown rep -&gt; VTable rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#topDownTable"><span class="hs-identifier hs-var hs-var">topDownTable</span></a></span></span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span id="local-6989586621684429021"><span id="local-6989586621684429022"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#runForwardingM"><span class="hs-identifier hs-type">runForwardingM</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-278"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#LowerUpdate"><span class="hs-identifier hs-type">LowerUpdate</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429022"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429022"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-279"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#OnOp"><span class="hs-identifier hs-type">OnOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429022"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-280"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429022"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429021"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-281"></span><span>  </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-282"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684429021"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-283"></span><span id="runForwardingM"><span class="annot"><span class="annottext">runForwardingM :: forall rep a.
LowerUpdate rep (ForwardingM rep)
-&gt; OnOp rep -&gt; ForwardingM rep a -&gt; VNameSource -&gt; (a, VNameSource)
</span><a href="Futhark.Optimise.InPlaceLowering.html#runForwardingM"><span class="hs-identifier hs-var hs-var">runForwardingM</span></a></span></span><span> </span><span id="local-6989586621684427917"><span class="annot"><span class="annottext">LowerUpdate rep (ForwardingM rep)
</span><a href="#local-6989586621684427917"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684427916"><span class="annot"><span class="annottext">OnOp rep
</span><a href="#local-6989586621684427916"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span id="local-6989586621684427915"><span class="annot"><span class="annottext">RWS (TopDown rep) (BottomUp rep) VNameSource a
</span><a href="#local-6989586621684427915"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684427914"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684427914"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-284"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684427913"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684427913"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684427912"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684427912"><span class="hs-identifier hs-var">src'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BottomUp rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RWS (TopDown rep) (BottomUp rep) VNameSource a
-&gt; TopDown rep -&gt; VNameSource -&gt; (a, VNameSource, BottomUp rep)
forall r w s a. RWS r w s a -&gt; r -&gt; s -&gt; (a, s, w)
</span><span class="hs-identifier hs-var">runRWS</span></span><span> </span><span class="annot"><span class="annottext">RWS (TopDown rep) (BottomUp rep) VNameSource a
</span><a href="#local-6989586621684427915"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684427910"><span class="hs-identifier hs-var">emptyTopDown</span></a></span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684427914"><span class="hs-identifier hs-var">src</span></a></span><span>
</span><span id="line-285"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684427913"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684427912"><span class="hs-identifier hs-var">src'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-286"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-287"></span><span>    </span><span id="local-6989586621684427910"><span class="annot"><span class="annottext">emptyTopDown :: TopDown rep
</span><a href="#local-6989586621684427910"><span class="hs-identifier hs-var hs-var">emptyTopDown</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-288"></span><span>      </span><span class="annot"><span class="annottext">TopDown :: forall rep.
Int
-&gt; VTable rep
-&gt; Int
-&gt; LowerUpdate rep (ForwardingM rep)
-&gt; OnOp rep
-&gt; TopDown rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#TopDown"><span class="hs-identifier hs-type">TopDown</span></a></span><span>
</span><span id="line-289"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">topDownCounter :: Int
</span><a href="Futhark.Optimise.InPlaceLowering.html#topDownCounter"><span class="hs-identifier hs-var">topDownCounter</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span>
</span><span id="line-290"></span><span>          </span><span class="annot"><span class="annottext">topDownTable :: VTable rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#topDownTable"><span class="hs-identifier hs-var">topDownTable</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VTable rep
forall k a. Map k a
</span><span class="hs-identifier hs-var">M.empty</span></span><span class="hs-special">,</span><span>
</span><span id="line-291"></span><span>          </span><span class="annot"><span class="annottext">topDownDepth :: Int
</span><a href="Futhark.Optimise.InPlaceLowering.html#topDownDepth"><span class="hs-identifier hs-var">topDownDepth</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span>
</span><span id="line-292"></span><span>          </span><span class="annot"><span class="annottext">topLowerUpdate :: LowerUpdate rep (ForwardingM rep)
</span><a href="Futhark.Optimise.InPlaceLowering.html#topLowerUpdate"><span class="hs-identifier hs-var">topLowerUpdate</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LowerUpdate rep (ForwardingM rep)
</span><a href="#local-6989586621684427917"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-293"></span><span>          </span><span class="annot"><span class="annottext">topOnOp :: OnOp rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#topOnOp"><span class="hs-identifier hs-var">topOnOp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OnOp rep
</span><a href="#local-6989586621684427916"><span class="hs-identifier hs-var">g</span></a></span><span>
</span><span id="line-294"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-295"></span><span>
</span><span id="line-296"></span><span id="local-6989586621684428721"><span id="local-6989586621684428722"><span id="local-6989586621684428723"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#bindingParams"><span class="hs-identifier hs-type">bindingParams</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-297"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684428723"><span class="hs-identifier hs-type">dec</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#NameInfo"><span class="hs-identifier hs-type">NameInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428722"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-298"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428723"><span class="hs-identifier hs-type">dec</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-299"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428722"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428721"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-300"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428722"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428721"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-301"></span><span id="bindingParams"><span class="annot"><span class="annottext">bindingParams :: forall dec rep a.
(dec -&gt; NameInfo (Aliases rep))
-&gt; [Param dec] -&gt; ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="Futhark.Optimise.InPlaceLowering.html#bindingParams"><span class="hs-identifier hs-var hs-var">bindingParams</span></a></span></span><span> </span><span id="local-6989586621684427900"><span class="annot"><span class="annottext">dec -&gt; NameInfo (Aliases rep)
</span><a href="#local-6989586621684427900"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684427899"><span class="annot"><span class="annottext">[Param dec]
</span><a href="#local-6989586621684427899"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TopDown rep -&gt; TopDown rep)
-&gt; ForwardingM rep a -&gt; ForwardingM rep a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((TopDown rep -&gt; TopDown rep)
 -&gt; ForwardingM rep a -&gt; ForwardingM rep a)
-&gt; (TopDown rep -&gt; TopDown rep)
-&gt; ForwardingM rep a
-&gt; ForwardingM rep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#TopDown"><span class="hs-identifier hs-type">TopDown</span></a></span><span> </span><span id="local-6989586621684427897"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427897"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684427896"><span class="annot"><span class="annottext">VTable rep
</span><a href="#local-6989586621684427896"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684427895"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427895"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621684427894"><span class="annot"><span class="annottext">LowerUpdate rep (ForwardingM rep)
</span><a href="#local-6989586621684427894"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684427893"><span class="annot"><span class="annottext">OnOp rep
</span><a href="#local-6989586621684427893"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684427892"><span class="annot"><span class="annottext">entry :: Param dec -&gt; (VName, Entry rep)
</span><a href="#local-6989586621684427892"><span class="hs-identifier hs-var hs-var">entry</span></a></span></span><span> </span><span id="local-6989586621684427891"><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684427891"><span class="hs-identifier hs-var">fparam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-303"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Param dec -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684427891"><span class="hs-identifier hs-var">fparam</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-304"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; Names -&gt; Int -&gt; Bool -&gt; NameInfo (Aliases rep) -&gt; Entry rep
forall rep.
Int -&gt; Names -&gt; Int -&gt; Bool -&gt; NameInfo (Aliases rep) -&gt; Entry rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#Entry"><span class="hs-identifier hs-var">Entry</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427897"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427895"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">(NameInfo (Aliases rep) -&gt; Entry rep)
-&gt; NameInfo (Aliases rep) -&gt; Entry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">dec -&gt; NameInfo (Aliases rep)
</span><a href="#local-6989586621684427900"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(dec -&gt; NameInfo (Aliases rep)) -&gt; dec -&gt; NameInfo (Aliases rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param dec -&gt; dec
forall dec. Param dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#paramDec"><span class="hs-identifier hs-var hs-var">paramDec</span></a></span><span> </span><span class="annot"><span class="annottext">Param dec
</span><a href="#local-6989586621684427891"><span class="hs-identifier hs-var">fparam</span></a></span><span>
</span><span id="line-305"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>      </span><span id="local-6989586621684427888"><span class="annot"><span class="annottext">entries :: VTable rep
</span><a href="#local-6989586621684427888"><span class="hs-identifier hs-var hs-var">entries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, Entry rep)] -&gt; VTable rep
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Entry rep)] -&gt; VTable rep)
-&gt; [(VName, Entry rep)] -&gt; VTable rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Param dec -&gt; (VName, Entry rep))
-&gt; [Param dec] -&gt; [(VName, Entry rep)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param dec -&gt; (VName, Entry rep)
</span><a href="#local-6989586621684427892"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">[Param dec]
</span><a href="#local-6989586621684427899"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-307"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; VTable rep
-&gt; Int
-&gt; LowerUpdate rep (ForwardingM rep)
-&gt; OnOp rep
-&gt; TopDown rep
forall rep.
Int
-&gt; VTable rep
-&gt; Int
-&gt; LowerUpdate rep (ForwardingM rep)
-&gt; OnOp rep
-&gt; TopDown rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#TopDown"><span class="hs-identifier hs-var">TopDown</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427897"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VTable rep -&gt; VTable rep -&gt; VTable rep
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.union</span></span><span> </span><span class="annot"><span class="annottext">VTable rep
</span><a href="#local-6989586621684427888"><span class="hs-identifier hs-var">entries</span></a></span><span> </span><span class="annot"><span class="annottext">VTable rep
</span><a href="#local-6989586621684427896"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427895"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">LowerUpdate rep (ForwardingM rep)
</span><a href="#local-6989586621684427894"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">OnOp rep
</span><a href="#local-6989586621684427893"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-308"></span><span>
</span><span id="line-309"></span><span id="local-6989586621684429009"><span id="local-6989586621684429010"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#bindingFParams"><span class="hs-identifier hs-type">bindingFParams</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-310"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#FParam"><span class="hs-identifier hs-type">FParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429010"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429010"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429009"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-312"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429010"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429009"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-313"></span><span id="bindingFParams"><span class="annot"><span class="annottext">bindingFParams :: forall rep a.
[FParam (Aliases rep)] -&gt; ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="Futhark.Optimise.InPlaceLowering.html#bindingFParams"><span class="hs-identifier hs-var hs-var">bindingFParams</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(FParamInfo rep -&gt; NameInfo (Aliases rep))
-&gt; [Param (FParamInfo rep)]
-&gt; ForwardingM rep a
-&gt; ForwardingM rep a
forall dec rep a.
(dec -&gt; NameInfo (Aliases rep))
-&gt; [Param dec] -&gt; ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="Futhark.Optimise.InPlaceLowering.html#bindingParams"><span class="hs-identifier hs-var">bindingParams</span></a></span><span> </span><span class="annot"><span class="annottext">FParamInfo rep -&gt; NameInfo (Aliases rep)
forall rep. FParamInfo rep -&gt; NameInfo rep
</span><a href="Futhark.IR.Prop.Scope.html#FParamName"><span class="hs-identifier hs-var">FParamName</span></a></span><span>
</span><span id="line-314"></span><span>
</span><span id="line-315"></span><span id="local-6989586621684428892"><span id="local-6989586621684428893"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#bindingScope"><span class="hs-identifier hs-type">bindingScope</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-316"></span><span>  </span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428893"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-317"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428893"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428892"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-318"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428893"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428892"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-319"></span><span id="bindingScope"><span class="annot"><span class="annottext">bindingScope :: forall rep a.
Scope (Aliases rep) -&gt; ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="Futhark.Optimise.InPlaceLowering.html#bindingScope"><span class="hs-identifier hs-var hs-var">bindingScope</span></a></span></span><span> </span><span id="local-6989586621684427875"><span class="annot"><span class="annottext">Scope (Aliases rep)
</span><a href="#local-6989586621684427875"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TopDown rep -&gt; TopDown rep)
-&gt; ForwardingM rep a -&gt; ForwardingM rep a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((TopDown rep -&gt; TopDown rep)
 -&gt; ForwardingM rep a -&gt; ForwardingM rep a)
-&gt; (TopDown rep -&gt; TopDown rep)
-&gt; ForwardingM rep a
-&gt; ForwardingM rep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#TopDown"><span class="hs-identifier hs-type">TopDown</span></a></span><span> </span><span id="local-6989586621684427874"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427874"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684427873"><span class="annot"><span class="annottext">Map VName (Entry rep)
</span><a href="#local-6989586621684427873"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684427872"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427872"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621684427871"><span class="annot"><span class="annottext">LowerUpdate rep (ForwardingM rep)
</span><a href="#local-6989586621684427871"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684427870"><span class="annot"><span class="annottext">OnOp rep
</span><a href="#local-6989586621684427870"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-320"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684427869"><span class="annot"><span class="annottext">entries :: Map VName (Entry rep)
</span><a href="#local-6989586621684427869"><span class="hs-identifier hs-var hs-var">entries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(NameInfo (Aliases rep) -&gt; Entry rep)
-&gt; Scope (Aliases rep) -&gt; Map VName (Entry rep)
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">NameInfo (Aliases rep) -&gt; Entry rep
</span><a href="#local-6989586621684427868"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">Scope (Aliases rep)
</span><a href="#local-6989586621684427875"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-321"></span><span>      </span><span id="local-6989586621684427862"><span class="annot"><span class="annottext">infoAliases :: NameInfo rep -&gt; Names
</span><a href="#local-6989586621684427862"><span class="hs-identifier hs-var hs-var">infoAliases</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LetName"><span class="hs-identifier hs-type">LetName</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684427860"><span class="annot"><span class="annottext">VarAliases
</span><a href="#local-6989586621684427860"><span class="hs-identifier hs-var">aliases</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VarAliases -&gt; Names
</span><a href="Futhark.IR.Aliases.html#unAliases"><span class="hs-identifier hs-var hs-var">unAliases</span></a></span><span> </span><span class="annot"><span class="annottext">VarAliases
</span><a href="#local-6989586621684427860"><span class="hs-identifier hs-var">aliases</span></a></span><span>
</span><span id="line-322"></span><span>      </span><span class="annot"><a href="#local-6989586621684427862"><span class="hs-identifier hs-var">infoAliases</span></a></span><span> </span><span class="annot"><span class="annottext">NameInfo rep
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-323"></span><span>      </span><span id="local-6989586621684427868"><span class="annot"><span class="annottext">entry :: NameInfo (Aliases rep) -&gt; Entry rep
</span><a href="#local-6989586621684427868"><span class="hs-identifier hs-var hs-var">entry</span></a></span></span><span> </span><span id="local-6989586621684427858"><span class="annot"><span class="annottext">NameInfo (Aliases rep)
</span><a href="#local-6989586621684427858"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Names -&gt; Int -&gt; Bool -&gt; NameInfo (Aliases rep) -&gt; Entry rep
forall rep.
Int -&gt; Names -&gt; Int -&gt; Bool -&gt; NameInfo (Aliases rep) -&gt; Entry rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#Entry"><span class="hs-identifier hs-var">Entry</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427874"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NameInfo (Aliases rep) -&gt; Names
forall {rep} {b}.
(LetDec rep ~ (VarAliases, b)) =&gt;
NameInfo rep -&gt; Names
</span><a href="#local-6989586621684427862"><span class="hs-identifier hs-var">infoAliases</span></a></span><span> </span><span class="annot"><span class="annottext">NameInfo (Aliases rep)
</span><a href="#local-6989586621684427858"><span class="hs-identifier hs-var">info</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427872"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">NameInfo (Aliases rep)
</span><a href="#local-6989586621684427858"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-324"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; Map VName (Entry rep)
-&gt; Int
-&gt; LowerUpdate rep (ForwardingM rep)
-&gt; OnOp rep
-&gt; TopDown rep
forall rep.
Int
-&gt; VTable rep
-&gt; Int
-&gt; LowerUpdate rep (ForwardingM rep)
-&gt; OnOp rep
-&gt; TopDown rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#TopDown"><span class="hs-identifier hs-var">TopDown</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427874"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName (Entry rep)
</span><a href="#local-6989586621684427869"><span class="hs-identifier hs-var">entries</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName (Entry rep)
-&gt; Map VName (Entry rep) -&gt; Map VName (Entry rep)
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName (Entry rep)
</span><a href="#local-6989586621684427873"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427872"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">LowerUpdate rep (ForwardingM rep)
</span><a href="#local-6989586621684427871"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">OnOp rep
</span><a href="#local-6989586621684427870"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span id="local-6989586621684429001"><span id="local-6989586621684429002"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#bindingStm"><span class="hs-identifier hs-type">bindingStm</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-327"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429002"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-328"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429002"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429001"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-329"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429002"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684429001"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-330"></span><span id="bindingStm"><span class="annot"><span class="annottext">bindingStm :: forall rep a.
Stm (Aliases rep) -&gt; ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="Futhark.Optimise.InPlaceLowering.html#bindingStm"><span class="hs-identifier hs-var hs-var">bindingStm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684427852"><span class="annot"><span class="annottext">Pat (Aliases rep)
</span><a href="#local-6989586621684427852"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec (Aliases rep))
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Exp (Aliases rep)
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TopDown rep -&gt; TopDown rep)
-&gt; ForwardingM rep a -&gt; ForwardingM rep a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((TopDown rep -&gt; TopDown rep)
 -&gt; ForwardingM rep a -&gt; ForwardingM rep a)
-&gt; (TopDown rep -&gt; TopDown rep)
-&gt; ForwardingM rep a
-&gt; ForwardingM rep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#TopDown"><span class="hs-identifier hs-type">TopDown</span></a></span><span> </span><span id="local-6989586621684427851"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427851"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684427850"><span class="annot"><span class="annottext">VTable rep
</span><a href="#local-6989586621684427850"><span class="hs-identifier hs-var">vtable</span></a></span></span><span> </span><span id="local-6989586621684427849"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427849"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621684427848"><span class="annot"><span class="annottext">LowerUpdate rep (ForwardingM rep)
</span><a href="#local-6989586621684427848"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684427847"><span class="annot"><span class="annottext">OnOp rep
</span><a href="#local-6989586621684427847"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-331"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684427846"><span class="annot"><span class="annottext">entries :: VTable rep
</span><a href="#local-6989586621684427846"><span class="hs-identifier hs-var hs-var">entries</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, Entry rep)] -&gt; VTable rep
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Entry rep)] -&gt; VTable rep)
-&gt; [(VName, Entry rep)] -&gt; VTable rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatElemT (VarAliases, LetDec rep) -&gt; (VName, Entry rep))
-&gt; [PatElemT (VarAliases, LetDec rep)] -&gt; [(VName, Entry rep)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarAliases, LetDec rep) -&gt; (VName, Entry rep)
</span><a href="#local-6989586621684427845"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT (VarAliases, LetDec rep)] -&gt; [(VName, Entry rep)])
-&gt; [PatElemT (VarAliases, LetDec rep)] -&gt; [(VName, Entry rep)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT (VarAliases, LetDec rep)
-&gt; [PatElemT (VarAliases, LetDec rep)]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">PatT (VarAliases, LetDec rep)
Pat (Aliases rep)
</span><a href="#local-6989586621684427852"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-332"></span><span>      </span><span id="local-6989586621684427845"><span class="annot"><span class="annottext">entry :: PatElemT (VarAliases, LetDec rep) -&gt; (VName, Entry rep)
</span><a href="#local-6989586621684427845"><span class="hs-identifier hs-var hs-var">entry</span></a></span></span><span> </span><span id="local-6989586621684427843"><span class="annot"><span class="annottext">PatElemT (VarAliases, LetDec rep)
</span><a href="#local-6989586621684427843"><span class="hs-identifier hs-var">patElem</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-333"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684427842"><span class="annot"><span class="annottext">VarAliases
</span><a href="#local-6989586621684427842"><span class="hs-identifier hs-var">aliases</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LetDec rep
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatElemT (VarAliases, LetDec rep) -&gt; (VarAliases, LetDec rep)
forall dec. PatElemT dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#patElemDec"><span class="hs-identifier hs-var hs-var">patElemDec</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarAliases, LetDec rep)
</span><a href="#local-6989586621684427843"><span class="hs-identifier hs-var">patElem</span></a></span><span>
</span><span id="line-334"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">PatElemT (VarAliases, LetDec rep) -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarAliases, LetDec rep)
</span><a href="#local-6989586621684427843"><span class="hs-identifier hs-var">patElem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-335"></span><span>              </span><span class="annot"><span class="annottext">Int -&gt; Names -&gt; Int -&gt; Bool -&gt; NameInfo (Aliases rep) -&gt; Entry rep
forall rep.
Int -&gt; Names -&gt; Int -&gt; Bool -&gt; NameInfo (Aliases rep) -&gt; Entry rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#Entry"><span class="hs-identifier hs-var">Entry</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427851"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VarAliases -&gt; Names
</span><a href="Futhark.IR.Aliases.html#unAliases"><span class="hs-identifier hs-var hs-var">unAliases</span></a></span><span> </span><span class="annot"><span class="annottext">VarAliases
</span><a href="#local-6989586621684427842"><span class="hs-identifier hs-var">aliases</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427849"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">(NameInfo (Aliases rep) -&gt; Entry rep)
-&gt; NameInfo (Aliases rep) -&gt; Entry rep
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LetDec (Aliases rep) -&gt; NameInfo (Aliases rep)
forall rep. LetDec rep -&gt; NameInfo rep
</span><a href="Futhark.IR.Prop.Scope.html#LetName"><span class="hs-identifier hs-var">LetName</span></a></span><span> </span><span class="annot"><span class="annottext">(LetDec (Aliases rep) -&gt; NameInfo (Aliases rep))
-&gt; LetDec (Aliases rep) -&gt; NameInfo (Aliases rep)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarAliases, LetDec rep) -&gt; (VarAliases, LetDec rep)
forall dec. PatElemT dec -&gt; dec
</span><a href="Futhark.IR.Syntax.Core.html#patElemDec"><span class="hs-identifier hs-var hs-var">patElemDec</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (VarAliases, LetDec rep)
</span><a href="#local-6989586621684427843"><span class="hs-identifier hs-var">patElem</span></a></span><span>
</span><span id="line-336"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-337"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; VTable rep
-&gt; Int
-&gt; LowerUpdate rep (ForwardingM rep)
-&gt; OnOp rep
-&gt; TopDown rep
forall rep.
Int
-&gt; VTable rep
-&gt; Int
-&gt; LowerUpdate rep (ForwardingM rep)
-&gt; OnOp rep
-&gt; TopDown rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#TopDown"><span class="hs-identifier hs-var">TopDown</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427851"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VTable rep -&gt; VTable rep -&gt; VTable rep
forall k a. Ord k =&gt; Map k a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.union</span></span><span> </span><span class="annot"><span class="annottext">VTable rep
</span><a href="#local-6989586621684427846"><span class="hs-identifier hs-var">entries</span></a></span><span> </span><span class="annot"><span class="annottext">VTable rep
</span><a href="#local-6989586621684427850"><span class="hs-identifier hs-var">vtable</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427849"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">LowerUpdate rep (ForwardingM rep)
</span><a href="#local-6989586621684427848"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">OnOp rep
</span><a href="#local-6989586621684427847"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-338"></span><span>
</span><span id="line-339"></span><span id="local-6989586621684428698"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#bindingNumber"><span class="hs-identifier hs-type">bindingNumber</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428698"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span><span>
</span><span id="line-340"></span><span id="bindingNumber"><span class="annot"><span class="annottext">bindingNumber :: forall rep. VName -&gt; ForwardingM rep Int
</span><a href="Futhark.Optimise.InPlaceLowering.html#bindingNumber"><span class="hs-identifier hs-var hs-var">bindingNumber</span></a></span></span><span> </span><span id="local-6989586621684427828"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427828"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-341"></span><span>  </span><span id="local-6989586621684427827"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621684427827"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TopDown rep -&gt; Maybe Int) -&gt; ForwardingM rep (Maybe Int)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">((TopDown rep -&gt; Maybe Int) -&gt; ForwardingM rep (Maybe Int))
-&gt; (TopDown rep -&gt; Maybe Int) -&gt; ForwardingM rep (Maybe Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Entry rep -&gt; Int) -&gt; Maybe (Entry rep) -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Entry rep -&gt; Int
forall rep. Entry rep -&gt; Int
</span><a href="Futhark.Optimise.InPlaceLowering.html#entryNumber"><span class="hs-identifier hs-var hs-var">entryNumber</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Entry rep) -&gt; Maybe Int)
-&gt; (TopDown rep -&gt; Maybe (Entry rep)) -&gt; TopDown rep -&gt; Maybe Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName (Entry rep) -&gt; Maybe (Entry rep)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427828"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName (Entry rep) -&gt; Maybe (Entry rep))
-&gt; (TopDown rep -&gt; Map VName (Entry rep))
-&gt; TopDown rep
-&gt; Maybe (Entry rep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TopDown rep -&gt; Map VName (Entry rep)
forall rep. TopDown rep -&gt; VTable rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#topDownTable"><span class="hs-identifier hs-var hs-var">topDownTable</span></a></span><span>
</span><span id="line-342"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621684427827"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-343"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684427825"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427825"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; ForwardingM rep Int
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427825"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-344"></span><span>    </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-345"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ForwardingM rep Int
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ForwardingM rep Int) -&gt; String -&gt; ForwardingM rep Int
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-346"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bindingNumber: variable &quot;</span></span><span>
</span><span id="line-347"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427828"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-348"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; not found.&quot;</span></span><span>
</span><span id="line-349"></span><span>
</span><span id="line-350"></span><span id="local-6989586621684428996"><span id="local-6989586621684428997"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#deepen"><span class="hs-identifier hs-type">deepen</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428997"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428996"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428997"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428996"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-351"></span><span id="deepen"><span class="annot"><span class="annottext">deepen :: forall rep a. ForwardingM rep a -&gt; ForwardingM rep a
</span><a href="Futhark.Optimise.InPlaceLowering.html#deepen"><span class="hs-identifier hs-var hs-var">deepen</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TopDown rep -&gt; TopDown rep)
-&gt; ForwardingM rep a -&gt; ForwardingM rep a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">((TopDown rep -&gt; TopDown rep)
 -&gt; ForwardingM rep a -&gt; ForwardingM rep a)
-&gt; (TopDown rep -&gt; TopDown rep)
-&gt; ForwardingM rep a
-&gt; ForwardingM rep a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684427819"><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684427819"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684427819"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">topDownDepth :: Int
</span><a href="Futhark.Optimise.InPlaceLowering.html#topDownDepth"><span class="hs-identifier hs-var">topDownDepth</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TopDown rep -&gt; Int
forall rep. TopDown rep -&gt; Int
</span><a href="Futhark.Optimise.InPlaceLowering.html#topDownDepth"><span class="hs-identifier hs-var hs-var">topDownDepth</span></a></span><span> </span><span class="annot"><span class="annottext">TopDown rep
</span><a href="#local-6989586621684427819"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">}</span><span>
</span><span id="line-352"></span><span>
</span><span id="line-353"></span><span id="local-6989586621684428687"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#areAvailableBefore"><span class="hs-identifier hs-type">areAvailableBefore</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#Names"><span class="hs-identifier hs-type">Names</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428687"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-354"></span><span id="areAvailableBefore"><span class="annot"><span class="annottext">areAvailableBefore :: forall rep. Names -&gt; VName -&gt; ForwardingM rep Bool
</span><a href="Futhark.Optimise.InPlaceLowering.html#areAvailableBefore"><span class="hs-identifier hs-var hs-var">areAvailableBefore</span></a></span></span><span> </span><span id="local-6989586621684427808"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684427808"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span id="local-6989586621684427807"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427807"><span class="hs-identifier hs-var">point</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-355"></span><span>  </span><span id="local-6989586621684427806"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427806"><span class="hs-identifier hs-var">pointN</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ForwardingM rep Int
forall rep. VName -&gt; ForwardingM rep Int
</span><a href="Futhark.Optimise.InPlaceLowering.html#bindingNumber"><span class="hs-identifier hs-var">bindingNumber</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427807"><span class="hs-identifier hs-var">point</span></a></span><span>
</span><span id="line-356"></span><span>  </span><span id="local-6989586621684427805"><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684427805"><span class="hs-identifier hs-var">nameNs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ForwardingM rep Int) -&gt; [VName] -&gt; ForwardingM rep [Int]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ForwardingM rep Int
forall rep. VName -&gt; ForwardingM rep Int
</span><a href="Futhark.Optimise.InPlaceLowering.html#bindingNumber"><span class="hs-identifier hs-var">bindingNumber</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; ForwardingM rep [Int])
-&gt; [VName] -&gt; ForwardingM rep [Int]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684427808"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-357"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; ForwardingM rep Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; ForwardingM rep Bool) -&gt; Bool -&gt; ForwardingM rep Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Bool) -&gt; [Int] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427806"><span class="hs-identifier hs-var">pointN</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Int]
</span><a href="#local-6989586621684427805"><span class="hs-identifier hs-var">nameNs</span></a></span><span>
</span><span id="line-358"></span><span>
</span><span id="line-359"></span><span id="local-6989586621684428681"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#isInCurrentBody"><span class="hs-identifier hs-type">isInCurrentBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428681"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-360"></span><span id="isInCurrentBody"><span class="annot"><span class="annottext">isInCurrentBody :: forall rep. VName -&gt; ForwardingM rep Bool
</span><a href="Futhark.Optimise.InPlaceLowering.html#isInCurrentBody"><span class="hs-identifier hs-var hs-var">isInCurrentBody</span></a></span></span><span> </span><span id="local-6989586621684427788"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427788"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-361"></span><span>  </span><span id="local-6989586621684427787"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427787"><span class="hs-identifier hs-var">current</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TopDown rep -&gt; Int) -&gt; ForwardingM rep Int
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">TopDown rep -&gt; Int
forall rep. TopDown rep -&gt; Int
</span><a href="Futhark.Optimise.InPlaceLowering.html#topDownDepth"><span class="hs-identifier hs-var hs-var">topDownDepth</span></a></span><span>
</span><span id="line-362"></span><span>  </span><span id="local-6989586621684427786"><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621684427786"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TopDown rep -&gt; Maybe Int) -&gt; ForwardingM rep (Maybe Int)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">((TopDown rep -&gt; Maybe Int) -&gt; ForwardingM rep (Maybe Int))
-&gt; (TopDown rep -&gt; Maybe Int) -&gt; ForwardingM rep (Maybe Int)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Entry rep -&gt; Int) -&gt; Maybe (Entry rep) -&gt; Maybe Int
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Entry rep -&gt; Int
forall rep. Entry rep -&gt; Int
</span><a href="Futhark.Optimise.InPlaceLowering.html#entryDepth"><span class="hs-identifier hs-var hs-var">entryDepth</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Entry rep) -&gt; Maybe Int)
-&gt; (TopDown rep -&gt; Maybe (Entry rep)) -&gt; TopDown rep -&gt; Maybe Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName (Entry rep) -&gt; Maybe (Entry rep)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427788"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName (Entry rep) -&gt; Maybe (Entry rep))
-&gt; (TopDown rep -&gt; Map VName (Entry rep))
-&gt; TopDown rep
-&gt; Maybe (Entry rep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TopDown rep -&gt; Map VName (Entry rep)
forall rep. TopDown rep -&gt; VTable rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#topDownTable"><span class="hs-identifier hs-var hs-var">topDownTable</span></a></span><span>
</span><span id="line-363"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Int
</span><a href="#local-6989586621684427786"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-364"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684427785"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427785"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ForwardingM rep Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; ForwardingM rep Bool) -&gt; Bool -&gt; ForwardingM rep Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427785"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684427787"><span class="hs-identifier hs-var">current</span></a></span><span>
</span><span id="line-365"></span><span>    </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-366"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ForwardingM rep Bool
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ForwardingM rep Bool) -&gt; String -&gt; ForwardingM rep Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-367"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;isInCurrentBody: variable &quot;</span></span><span>
</span><span id="line-368"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427788"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-369"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; not found.&quot;</span></span><span>
</span><span id="line-370"></span><span>
</span><span id="line-371"></span><span id="local-6989586621684427784"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#isOptimisable"><span class="hs-identifier hs-type">isOptimisable</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684427784"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-372"></span><span id="isOptimisable"><span class="annot"><span class="annottext">isOptimisable :: forall rep. VName -&gt; ForwardingM rep Bool
</span><a href="Futhark.Optimise.InPlaceLowering.html#isOptimisable"><span class="hs-identifier hs-var hs-var">isOptimisable</span></a></span></span><span> </span><span id="local-6989586621684427774"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427774"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-373"></span><span>  </span><span id="local-6989586621684427773"><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621684427773"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TopDown rep -&gt; Maybe Bool) -&gt; ForwardingM rep (Maybe Bool)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">((TopDown rep -&gt; Maybe Bool) -&gt; ForwardingM rep (Maybe Bool))
-&gt; (TopDown rep -&gt; Maybe Bool) -&gt; ForwardingM rep (Maybe Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Entry rep -&gt; Bool) -&gt; Maybe (Entry rep) -&gt; Maybe Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">Entry rep -&gt; Bool
forall rep. Entry rep -&gt; Bool
</span><a href="Futhark.Optimise.InPlaceLowering.html#entryOptimisable"><span class="hs-identifier hs-var hs-var">entryOptimisable</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe (Entry rep) -&gt; Maybe Bool)
-&gt; (TopDown rep -&gt; Maybe (Entry rep)) -&gt; TopDown rep -&gt; Maybe Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName (Entry rep) -&gt; Maybe (Entry rep)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427774"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName (Entry rep) -&gt; Maybe (Entry rep))
-&gt; (TopDown rep -&gt; Map VName (Entry rep))
-&gt; TopDown rep
-&gt; Maybe (Entry rep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TopDown rep -&gt; Map VName (Entry rep)
forall rep. TopDown rep -&gt; VTable rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#topDownTable"><span class="hs-identifier hs-var hs-var">topDownTable</span></a></span><span>
</span><span id="line-374"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe Bool
</span><a href="#local-6989586621684427773"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-375"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684427772"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684427772"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; ForwardingM rep Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684427772"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-376"></span><span>    </span><span class="annot"><span class="annottext">Maybe Bool
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-377"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ForwardingM rep Bool
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ForwardingM rep Bool) -&gt; String -&gt; ForwardingM rep Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-378"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;isOptimisable: variable &quot;</span></span><span>
</span><span id="line-379"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427774"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-380"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; not found.&quot;</span></span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span id="local-6989586621684428986"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#seenVar"><span class="hs-identifier hs-type">seenVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428986"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-383"></span><span id="seenVar"><span class="annot"><span class="annottext">seenVar :: forall rep. VName -&gt; ForwardingM rep ()
</span><a href="Futhark.Optimise.InPlaceLowering.html#seenVar"><span class="hs-identifier hs-var hs-var">seenVar</span></a></span></span><span> </span><span id="local-6989586621684427764"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427764"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-384"></span><span>  </span><span id="local-6989586621684427763"><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684427763"><span class="hs-identifier hs-var">aliases</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-385"></span><span>    </span><span class="annot"><span class="annottext">(TopDown rep -&gt; Names) -&gt; ForwardingM rep Names
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">((TopDown rep -&gt; Names) -&gt; ForwardingM rep Names)
-&gt; (TopDown rep -&gt; Names) -&gt; ForwardingM rep Names
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-386"></span><span>      </span><span class="annot"><span class="annottext">Names -&gt; (Entry rep -&gt; Names) -&gt; Maybe (Entry rep) -&gt; Names
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Entry rep -&gt; Names
forall rep. Entry rep -&gt; Names
</span><a href="Futhark.Optimise.InPlaceLowering.html#entryAliases"><span class="hs-identifier hs-var hs-var">entryAliases</span></a></span><span>
</span><span id="line-387"></span><span>        </span><span class="annot"><span class="annottext">(Maybe (Entry rep) -&gt; Names)
-&gt; (TopDown rep -&gt; Maybe (Entry rep)) -&gt; TopDown rep -&gt; Names
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName (Entry rep) -&gt; Maybe (Entry rep)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427764"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-388"></span><span>        </span><span class="annot"><span class="annottext">(Map VName (Entry rep) -&gt; Maybe (Entry rep))
-&gt; (TopDown rep -&gt; Map VName (Entry rep))
-&gt; TopDown rep
-&gt; Maybe (Entry rep)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TopDown rep -&gt; Map VName (Entry rep)
forall rep. TopDown rep -&gt; VTable rep
</span><a href="Futhark.Optimise.InPlaceLowering.html#topDownTable"><span class="hs-identifier hs-var hs-var">topDownTable</span></a></span><span>
</span><span id="line-389"></span><span>  </span><span class="annot"><span class="annottext">BottomUp rep -&gt; ForwardingM rep ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">(BottomUp rep -&gt; ForwardingM rep ())
-&gt; BottomUp rep -&gt; ForwardingM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BottomUp rep
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">bottomUpSeen :: Names
</span><a href="Futhark.Optimise.InPlaceLowering.html#bottomUpSeen"><span class="hs-identifier hs-var">bottomUpSeen</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#oneName"><span class="hs-identifier hs-var">oneName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427764"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Names
</span><a href="#local-6989586621684427763"><span class="hs-identifier hs-var">aliases</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-390"></span><span>
</span><span id="line-391"></span><span id="local-6989586621684428943"><span id="local-6989586621684428944"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#tapBottomUp"><span class="hs-identifier hs-type">tapBottomUp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428944"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428943"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428944"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684428943"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#BottomUp"><span class="hs-identifier hs-type">BottomUp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428944"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-392"></span><span id="tapBottomUp"><span class="annot"><span class="annottext">tapBottomUp :: forall rep a.
ForwardingM rep a -&gt; ForwardingM rep (a, BottomUp rep)
</span><a href="Futhark.Optimise.InPlaceLowering.html#tapBottomUp"><span class="hs-identifier hs-var hs-var">tapBottomUp</span></a></span></span><span> </span><span id="local-6989586621684427757"><span class="annot"><span class="annottext">ForwardingM rep a
</span><a href="#local-6989586621684427757"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684427756"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684427756"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684427755"><span class="annot"><span class="annottext">BottomUp rep
</span><a href="#local-6989586621684427755"><span class="hs-identifier hs-var">bup</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ForwardingM rep a -&gt; ForwardingM rep (a, BottomUp rep)
forall w (m :: * -&gt; *) a. MonadWriter w m =&gt; m a -&gt; m (a, w)
</span><span class="hs-identifier hs-var">listen</span></span><span> </span><span class="annot"><span class="annottext">ForwardingM rep a
</span><a href="#local-6989586621684427757"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-394"></span><span>  </span><span class="annot"><span class="annottext">(a, BottomUp rep) -&gt; ForwardingM rep (a, BottomUp rep)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684427756"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BottomUp rep
</span><a href="#local-6989586621684427755"><span class="hs-identifier hs-var">bup</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span id="local-6989586621684428902"><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#maybeForward"><span class="hs-identifier hs-type">maybeForward</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-397"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#Constraints"><span class="hs-identifier hs-type">Constraints</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428902"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-398"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-399"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-400"></span><span>  </span><span class="annot"><a href="Futhark.IR.Rep.html#LetDec"><span class="hs-identifier hs-type">LetDec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Aliases.html#Aliases"><span class="hs-identifier hs-type">Aliases</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428902"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-401"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Certs"><span class="hs-identifier hs-type">Certs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-402"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-403"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-404"></span><span>  </span><span class="annot"><a href="Futhark.Optimise.InPlaceLowering.html#ForwardingM"><span class="hs-identifier hs-type">ForwardingM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684428902"><span class="hs-identifier hs-type">rep</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-405"></span><span id="maybeForward"><span class="annot"><span class="annottext">maybeForward :: forall rep.
Constraints rep =&gt;
VName
-&gt; VName
-&gt; LetDec (Aliases rep)
-&gt; Certs
-&gt; VName
-&gt; Slice SubExp
-&gt; ForwardingM rep ()
</span><a href="Futhark.Optimise.InPlaceLowering.html#maybeForward"><span class="hs-identifier hs-var hs-var">maybeForward</span></a></span></span><span> </span><span id="local-6989586621684427730"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427730"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684427729"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427729"><span class="hs-identifier hs-var">dest_nm</span></a></span></span><span> </span><span id="local-6989586621684427728"><span class="annot"><span class="annottext">LetDec (Aliases rep)
</span><a href="#local-6989586621684427728"><span class="hs-identifier hs-var">dest_dec</span></a></span></span><span> </span><span id="local-6989586621684427727"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684427727"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684427726"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427726"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span id="local-6989586621684427725"><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684427725"><span class="hs-identifier hs-var">slice</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-406"></span><span>  </span><span class="hs-comment">-- Checks condition (2)</span><span>
</span><span id="line-407"></span><span>  </span><span id="local-6989586621684427724"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684427724"><span class="hs-identifier hs-var">available</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-408"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427726"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Slice SubExp -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684427725"><span class="hs-identifier hs-var">slice</span></a></span><span> </span><span class="annot"><span class="annottext">Names -&gt; Names -&gt; Names
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684427727"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span>      </span><span class="annot"><span class="annottext">Names -&gt; VName -&gt; ForwardingM rep Bool
forall rep. Names -&gt; VName -&gt; ForwardingM rep Bool
</span><a href="Futhark.Optimise.InPlaceLowering.html#areAvailableBefore"><span class="hs-operator hs-var">`areAvailableBefore`</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427730"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-410"></span><span>  </span><span class="hs-comment">-- Check condition (3)</span><span>
</span><span id="line-411"></span><span>  </span><span id="local-6989586621684427723"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684427723"><span class="hs-identifier hs-var">samebody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ForwardingM rep Bool
forall rep. VName -&gt; ForwardingM rep Bool
</span><a href="Futhark.Optimise.InPlaceLowering.html#isInCurrentBody"><span class="hs-identifier hs-var">isInCurrentBody</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427730"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-comment">-- Check condition (6)</span><span>
</span><span id="line-413"></span><span>  </span><span id="local-6989586621684427722"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684427722"><span class="hs-identifier hs-var">optimisable</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName -&gt; ForwardingM rep Bool
forall rep. VName -&gt; ForwardingM rep Bool
</span><a href="Futhark.Optimise.InPlaceLowering.html#isOptimisable"><span class="hs-identifier hs-var">isOptimisable</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427730"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-414"></span><span>  </span><span id="local-6989586621684427721"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684427721"><span class="hs-identifier hs-var">not_prim</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (Type -&gt; Bool) -&gt; Type -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Bool
forall shape u. TypeBase shape u -&gt; Bool
</span><a href="Futhark.IR.Prop.Types.html#primType"><span class="hs-identifier hs-var">primType</span></a></span><span> </span><span class="annot"><span class="annottext">(Type -&gt; Bool) -&gt; ForwardingM rep Type -&gt; ForwardingM rep Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ForwardingM rep Type
forall rep (m :: * -&gt; *). HasScope rep m =&gt; VName -&gt; m Type
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427730"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-415"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; ForwardingM rep () -&gt; ForwardingM rep ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684427724"><span class="hs-identifier hs-var">available</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684427723"><span class="hs-identifier hs-var">samebody</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684427722"><span class="hs-identifier hs-var">optimisable</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684427721"><span class="hs-identifier hs-var">not_prim</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ForwardingM rep () -&gt; ForwardingM rep ())
-&gt; ForwardingM rep () -&gt; ForwardingM rep ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-416"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684427716"><span class="annot"><span class="annottext">fwd :: DesiredUpdate (VarAliases, LetDec rep)
</span><a href="#local-6989586621684427716"><span class="hs-identifier hs-var hs-var">fwd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; (VarAliases, LetDec rep)
-&gt; Certs
-&gt; VName
-&gt; Slice SubExp
-&gt; VName
-&gt; DesiredUpdate (VarAliases, LetDec rep)
forall dec.
VName
-&gt; dec
-&gt; Certs
-&gt; VName
-&gt; Slice SubExp
-&gt; VName
-&gt; DesiredUpdate dec
</span><a href="Futhark.Optimise.InPlaceLowering.LowerIntoStm.html#DesiredUpdate"><span class="hs-identifier hs-var">DesiredUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427729"><span class="hs-identifier hs-var">dest_nm</span></a></span><span> </span><span class="annot"><span class="annottext">(VarAliases, LetDec rep)
LetDec (Aliases rep)
</span><a href="#local-6989586621684427728"><span class="hs-identifier hs-var">dest_dec</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684427727"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427726"><span class="hs-identifier hs-var">src</span></a></span><span> </span><span class="annot"><span class="annottext">Slice SubExp
</span><a href="#local-6989586621684427725"><span class="hs-identifier hs-var">slice</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684427730"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-417"></span><span>    </span><span class="annot"><span class="annottext">BottomUp rep -&gt; ForwardingM rep ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">BottomUp Any
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">forwardThese :: [DesiredUpdate (LetDec (Aliases rep))]
</span><a href="Futhark.Optimise.InPlaceLowering.html#forwardThese"><span class="hs-identifier hs-var">forwardThese</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">DesiredUpdate (VarAliases, LetDec rep)
DesiredUpdate (LetDec (Aliases rep))
</span><a href="#local-6989586621684427716"><span class="hs-identifier hs-var">fwd</span></a></span><span class="hs-special">]</span><span class="hs-special">}</span><span>
</span><span id="line-418"></span></pre></body></html>