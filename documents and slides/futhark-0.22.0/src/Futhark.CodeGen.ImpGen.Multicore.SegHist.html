<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.CodeGen.ImpGen.Multicore.SegHist</span><span>
</span><span id="line-2"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#compileSegHist"><span class="hs-identifier">compileSegHist</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-3"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-4"></span><span class="hs-keyword">where</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad</span></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">zip4</span></span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html"><span class="hs-identifier">Futhark.CodeGen.ImpCode.Multicore</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Imp</span></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen</span></a></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.Multicore.Base</span></a></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.Multicore.SegRed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#compileSegRed%27"><span class="hs-identifier">compileSegRed'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html"><span class="hs-identifier">Futhark.IR.MCMem</span></a></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html"><span class="hs-identifier">Futhark.MonadFreshNames</span></a></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#chunks"><span class="hs-identifier">chunks</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.html#splitFromEnd"><span class="hs-identifier">splitFromEnd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.html#takeLast"><span class="hs-identifier">takeLast</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html"><span class="hs-identifier">Futhark.Util.IntegralExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-identifier">rem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">quot</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">rem</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#compileSegHist"><span class="hs-identifier hs-type">compileSegHist</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-19"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-20"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-22"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-23"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-24"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span>
</span><span id="line-25"></span><span id="compileSegHist"><span class="annot"><span class="annottext">compileSegHist :: Pat MCMem
-&gt; SegSpace
-&gt; [HistOp MCMem]
-&gt; KernelBody MCMem
-&gt; TV Int32
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#compileSegHist"><span class="hs-identifier hs-var hs-var">compileSegHist</span></a></span></span><span> </span><span id="local-6989586621684533918"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684533918"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684533917"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533917"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684533916"><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533916"><span class="hs-identifier hs-var">histops</span></a></span></span><span> </span><span id="local-6989586621684533915"><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533915"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span id="local-6989586621684533914"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684533914"><span class="hs-identifier hs-var">nsubtasks</span></a></span></span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">(VName, SubExp)
</span><span class="hs-identifier">_</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533917"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><span class="annottext">Pat MCMem
-&gt; SegSpace
-&gt; [HistOp MCMem]
-&gt; KernelBody MCMem
-&gt; TV Int32
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#nonsegmentedHist"><span class="hs-identifier hs-var">nonsegmentedHist</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684533918"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533917"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533916"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533915"><span class="hs-identifier hs-var">kbody</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684533914"><span class="hs-identifier hs-var">nsubtasks</span></a></span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><span class="annottext">Pat MCMem
-&gt; SegSpace
-&gt; [HistOp MCMem]
-&gt; KernelBody MCMem
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#segmentedHist"><span class="hs-identifier hs-var">segmentedHist</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684533918"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533917"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533916"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533915"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-comment">-- | Split some list into chunks equal to the number of values</span><span>
</span><span id="line-32"></span><span class="hs-comment">-- returned by each 'SegBinOp'</span><span>
</span><span id="line-33"></span><span id="local-6989586621684534312"><span id="local-6989586621684534313"><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#segHistOpChunks"><span class="hs-identifier hs-type">segHistOpChunks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684534313"><span class="hs-identifier hs-type">rep</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684534312"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684534312"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span class="hs-special">]</span></span></span><span>
</span><span id="line-34"></span><span id="segHistOpChunks"><span class="annot"><span class="annottext">segHistOpChunks :: forall rep a. [HistOp rep] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#segHistOpChunks"><span class="hs-identifier hs-var hs-var">segHistOpChunks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [a] -&gt; [[a]]
forall a. [Int] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.Util.html#chunks"><span class="hs-identifier hs-var">chunks</span></a></span><span> </span><span class="annot"><span class="annottext">([Int] -&gt; [a] -&gt; [[a]])
-&gt; ([HistOp rep] -&gt; [Int]) -&gt; [HistOp rep] -&gt; [a] -&gt; [[a]]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(HistOp rep -&gt; Int) -&gt; [HistOp rep] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int) -&gt; (HistOp rep -&gt; [SubExp]) -&gt; HistOp rep -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HistOp rep -&gt; [SubExp]
forall rep. HistOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#histNeutral"><span class="hs-identifier hs-var hs-var">histNeutral</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#histSize"><span class="hs-identifier hs-type">histSize</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span>
</span><span id="line-37"></span><span id="histSize"><span class="annot"><span class="annottext">histSize :: HistOp MCMem -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#histSize"><span class="hs-identifier hs-var hs-var">histSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; TExp Int64)
-&gt; (HistOp MCMem -&gt; [TExp Int64]) -&gt; HistOp MCMem -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64])
-&gt; (HistOp MCMem -&gt; [SubExp]) -&gt; HistOp MCMem -&gt; [TExp Int64]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">(Shape -&gt; [SubExp])
-&gt; (HistOp MCMem -&gt; Shape) -&gt; HistOp MCMem -&gt; [SubExp]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem -&gt; Shape
forall rep. HistOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#histShape"><span class="hs-identifier hs-var hs-var">histShape</span></a></span><span>
</span><span id="line-38"></span><span>
</span><span id="line-39"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#nonsegmentedHist"><span class="hs-identifier hs-type">nonsegmentedHist</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-40"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-41"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-43"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-44"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-45"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span>
</span><span id="line-46"></span><span id="nonsegmentedHist"><span class="annot"><span class="annottext">nonsegmentedHist :: Pat MCMem
-&gt; SegSpace
-&gt; [HistOp MCMem]
-&gt; KernelBody MCMem
-&gt; TV Int32
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#nonsegmentedHist"><span class="hs-identifier hs-var hs-var">nonsegmentedHist</span></a></span></span><span> </span><span id="local-6989586621684533900"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684533900"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684533899"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533899"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684533898"><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533898"><span class="hs-identifier hs-var">histops</span></a></span></span><span> </span><span id="local-6989586621684533897"><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533897"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span id="local-6989586621684533896"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684533896"><span class="hs-identifier hs-var">num_histos</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533895"><span class="annot"><span class="annottext">ns :: [SubExp]
</span><a href="#local-6989586621684533895"><span class="hs-identifier hs-var hs-var">ns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; SubExp) -&gt; [(VName, SubExp)] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; SubExp
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; [SubExp]) -&gt; [(VName, SubExp)] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533899"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-48"></span><span>      </span><span id="local-6989586621684533893"><span class="annot"><span class="annottext">ns_64 :: [TExp Int64]
</span><a href="#local-6989586621684533893"><span class="hs-identifier hs-var hs-var">ns_64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533895"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-49"></span><span>      </span><span id="local-6989586621684533892"><span class="annot"><span class="annottext">num_histos' :: TExp Int32
</span><a href="#local-6989586621684533892"><span class="hs-identifier hs-var hs-var">num_histos'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TExp Int32
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684533896"><span class="hs-identifier hs-var">num_histos</span></a></span><span>
</span><span id="line-50"></span><span>      </span><span id="local-6989586621684533890"><span class="annot"><span class="annottext">hist_width :: TExp Int64
</span><a href="#local-6989586621684533890"><span class="hs-identifier hs-var hs-var">hist_width</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HistOp MCMem -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#histSize"><span class="hs-identifier hs-var">histSize</span></a></span><span> </span><span class="annot"><span class="annottext">(HistOp MCMem -&gt; TExp Int64) -&gt; HistOp MCMem -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem] -&gt; HistOp MCMem
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">head</span></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533898"><span class="hs-identifier hs-var">histops</span></a></span><span>
</span><span id="line-51"></span><span>      </span><span id="local-6989586621684533881"><span class="annot"><span class="annottext">use_subhistogram :: TPrimExp Bool VName
</span><a href="#local-6989586621684533881"><span class="hs-identifier hs-var hs-var">use_subhistogram</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int32 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><a href="#local-6989586621684533892"><span class="hs-identifier hs-var">num_histos'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684533890"><span class="hs-identifier hs-var">hist_width</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C%3D."><span class="hs-operator hs-var">.&lt;=.</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533893"><span class="hs-identifier hs-var">ns_64</span></a></span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span>  </span><span id="local-6989586621684533877"><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533877"><span class="hs-identifier hs-var">histops'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem] -&gt; MulticoreGen [HistOp MCMem]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#renameHistOpLambda"><span class="hs-identifier hs-var">renameHistOpLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533898"><span class="hs-identifier hs-var">histops</span></a></span><span>
</span><span id="line-54"></span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-comment">-- Only do something if there is actually input.</span><span>
</span><span id="line-56"></span><span>  </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code)
-&gt; ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sUnless"><span class="hs-identifier hs-var">sUnless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533893"><span class="hs-identifier hs-var">ns_64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-58"></span><span>      </span><span id="local-6989586621684533872"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533872"><span class="hs-identifier hs-var">flat_idx</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int64)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;iter&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int64"><span class="hs-identifier hs-var">int64</span></a></span><span>
</span><span id="line-59"></span><span>      </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
TPrimExp Bool VName
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span>
</span><span id="line-60"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Bool VName
</span><a href="#local-6989586621684533881"><span class="hs-identifier hs-var">use_subhistogram</span></a></span><span>
</span><span id="line-61"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat MCMem
-&gt; TV Int64
-&gt; SegSpace
-&gt; [HistOp MCMem]
-&gt; TV Int32
-&gt; KernelBody MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#subHistogram"><span class="hs-identifier hs-var">subHistogram</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684533900"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533872"><span class="hs-identifier hs-var">flat_idx</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533899"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533898"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684533896"><span class="hs-identifier hs-var">num_histos</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533897"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat MCMem
-&gt; TV Int64
-&gt; SegSpace
-&gt; [HistOp MCMem]
-&gt; KernelBody MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#atomicHistogram"><span class="hs-identifier hs-var">atomicHistogram</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684533900"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533872"><span class="hs-identifier hs-var">flat_idx</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533899"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533877"><span class="hs-identifier hs-var">histops'</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533897"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-63"></span><span>
</span><span id="line-64"></span><span class="hs-comment">-- |</span><span>
</span><span id="line-65"></span><span class="hs-comment">-- Atomic Histogram approach</span><span>
</span><span id="line-66"></span><span class="hs-comment">-- The implementation has three sub-strategies depending on the</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- type of the operator</span><span>
</span><span id="line-68"></span><span class="hs-comment">-- 1. If values are integral scalars, a direct-supported atomic update is used.</span><span>
</span><span id="line-69"></span><span class="hs-comment">-- 2. If values are on one memory location, e.g. a float, then a</span><span>
</span><span id="line-70"></span><span class="hs-comment">-- CAS operation is used to perform the update, where the float is</span><span>
</span><span id="line-71"></span><span class="hs-comment">-- casted to an integral scalar.</span><span>
</span><span id="line-72"></span><span class="hs-comment">-- 1. and 2. currently only works for 32-bit and 64-bit types,</span><span>
</span><span id="line-73"></span><span class="hs-comment">-- but GCC has support for 8-, 16- and 128- bit types as well.</span><span>
</span><span id="line-74"></span><span class="hs-comment">-- 3. Otherwise a locking based approach is used</span><span>
</span><span id="line-75"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#onOpAtomic"><span class="hs-identifier hs-type">onOpAtomic</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span id="onOpAtomic"><span class="annot"><span class="annottext">onOpAtomic :: HistOp MCMem
-&gt; MulticoreGen
     ([VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#onOpAtomic"><span class="hs-identifier hs-var hs-var">onOpAtomic</span></a></span></span><span> </span><span id="local-6989586621684533865"><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533865"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-77"></span><span>  </span><span id="local-6989586621684533864"><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684533864"><span class="hs-identifier hs-var">atomics</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HostEnv -&gt; AtomicBinOp
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#hostAtomics"><span class="hs-identifier hs-var hs-var">hostAtomics</span></a></span><span> </span><span class="annot"><span class="annottext">(HostEnv -&gt; AtomicBinOp)
-&gt; ImpM MCMem HostEnv Multicore HostEnv
-&gt; ImpM MCMem HostEnv Multicore AtomicBinOp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore HostEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533860"><span class="annot"><span class="annottext">lambda :: Lambda MCMem
</span><a href="#local-6989586621684533860"><span class="hs-identifier hs-var hs-var">lambda</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HistOp MCMem -&gt; Lambda MCMem
forall rep. HistOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#histOp"><span class="hs-identifier hs-var hs-var">histOp</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533865"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-79"></span><span>      </span><span id="local-6989586621684533858"><span class="annot"><span class="annottext">do_op :: AtomicUpdate MCMem ()
</span><a href="#local-6989586621684533858"><span class="hs-identifier hs-var hs-var">do_op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AtomicBinOp -&gt; Lambda MCMem -&gt; AtomicUpdate MCMem ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#atomicUpdateLocking"><span class="hs-identifier hs-var">atomicUpdateLocking</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684533864"><span class="hs-identifier hs-var">atomics</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem
</span><a href="#local-6989586621684533860"><span class="hs-identifier hs-var">lambda</span></a></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">AtomicUpdate MCMem ()
</span><a href="#local-6989586621684533858"><span class="hs-identifier hs-var">do_op</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-81"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#AtomicPrim"><span class="hs-identifier hs-type">AtomicPrim</span></a></span><span> </span><span id="local-6989586621684533855"><span class="annot"><span class="annottext">[VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="#local-6989586621684533855"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; MulticoreGen
     ([VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="#local-6989586621684533855"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-82"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#AtomicCAS"><span class="hs-identifier hs-type">AtomicCAS</span></a></span><span> </span><span id="local-6989586621684533853"><span class="annot"><span class="annottext">[VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="#local-6989586621684533853"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; MulticoreGen
     ([VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="#local-6989586621684533853"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-83"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#AtomicLocking"><span class="hs-identifier hs-type">AtomicLocking</span></a></span><span> </span><span id="local-6989586621684533851"><span class="annot"><span class="annottext">Locking
-&gt; [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="#local-6989586621684533851"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-84"></span><span>      </span><span class="hs-comment">-- Allocate a static array of locks</span><span>
</span><span id="line-85"></span><span>      </span><span class="hs-comment">-- as in the GPU backend</span><span>
</span><span id="line-86"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533848"><span class="annot"><span class="annottext">num_locks :: Int
</span><a href="#local-6989586621684533848"><span class="hs-identifier hs-var hs-var">num_locks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">100151</span></span><span> </span><span class="hs-comment">-- This number is taken from the GPU backend</span><span>
</span><span id="line-87"></span><span>          </span><span id="local-6989586621684533844"><span class="annot"><span class="annottext">dims :: [TExp Int64]
</span><a href="#local-6989586621684533844"><span class="hs-identifier hs-var hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistOp MCMem -&gt; Shape
forall rep. HistOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#histOpShape"><span class="hs-identifier hs-var hs-var">histOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533865"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Shape -&gt; Shape
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem -&gt; Shape
forall rep. HistOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#histShape"><span class="hs-identifier hs-var hs-var">histShape</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533865"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span>      </span><span id="local-6989586621684533842"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533842"><span class="hs-identifier hs-var">locks</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-89"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; Space
-&gt; PrimType
-&gt; ArrayContents
-&gt; ImpM MCMem HostEnv Multicore VName
forall rep r op.
String -&gt; Space -&gt; PrimType -&gt; ArrayContents -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sStaticArray"><span class="hs-identifier hs-var">sStaticArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;hist_locks&quot;</span></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span> </span><span class="annot"><span class="annottext">(ArrayContents -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; ArrayContents -&gt; ImpM MCMem HostEnv Multicore VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-90"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; ArrayContents
</span><a href="Futhark.CodeGen.ImpCode.html#ArrayZeros"><span class="hs-identifier hs-var">Imp.ArrayZeros</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684533848"><span class="hs-identifier hs-var">num_locks</span></a></span><span>
</span><span id="line-91"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533822"><span class="annot"><span class="annottext">l' :: Locking
</span><a href="#local-6989586621684533822"><span class="hs-identifier hs-var hs-var">l'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; TExp Int32
-&gt; ([TExp Int64] -&gt; [TExp Int64])
-&gt; Locking
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#Locking"><span class="hs-identifier hs-var">Locking</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533842"><span class="hs-identifier hs-var">locks</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">TExp Int32
</span><span class="hs-number">0</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; [TExp Int64]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; [TExp Int64])
-&gt; ([TExp Int64] -&gt; TExp Int64) -&gt; [TExp Int64] -&gt; [TExp Int64]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; TExp Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684533848"><span class="hs-identifier hs-var">num_locks</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; TExp Int64)
-&gt; ([TExp Int64] -&gt; TExp Int64) -&gt; [TExp Int64] -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; TExp Int64
forall num. IntegralExp num =&gt; [num] -&gt; [num] -&gt; num
</span><a href="Futhark.IR.Prop.Reshape.html#flattenIndex"><span class="hs-identifier hs-var">flattenIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533844"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>      </span><span class="annot"><span class="annottext">([VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; MulticoreGen
     ([VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(([VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; MulticoreGen
      ([VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()))
-&gt; ([VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; MulticoreGen
     ([VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Locking
-&gt; [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="#local-6989586621684533851"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Locking
</span><a href="#local-6989586621684533822"><span class="hs-identifier hs-var">l'</span></a></span><span>
</span><span id="line-93"></span><span>
</span><span id="line-94"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#atomicHistogram"><span class="hs-identifier hs-type">atomicHistogram</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-95"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-96"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-97"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-98"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-99"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-100"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span id="atomicHistogram"><span class="annot"><span class="annottext">atomicHistogram :: Pat MCMem
-&gt; TV Int64
-&gt; SegSpace
-&gt; [HistOp MCMem]
-&gt; KernelBody MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#atomicHistogram"><span class="hs-identifier hs-var hs-var">atomicHistogram</span></a></span></span><span> </span><span id="local-6989586621684533819"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684533819"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684533818"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533818"><span class="hs-identifier hs-var">flat_idx</span></a></span></span><span> </span><span id="local-6989586621684533817"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533817"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684533816"><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533816"><span class="hs-identifier hs-var">histops</span></a></span></span><span> </span><span id="local-6989586621684533815"><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533815"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-102"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684533814"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533814"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533813"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533813"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533817"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-103"></span><span>      </span><span id="local-6989586621684533810"><span class="annot"><span class="annottext">ns_64 :: [TExp Int64]
</span><a href="#local-6989586621684533810"><span class="hs-identifier hs-var hs-var">ns_64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533813"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-104"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533804"><span class="annot"><span class="annottext">num_red_res :: Int
</span><a href="#local-6989586621684533804"><span class="hs-identifier hs-var hs-var">num_red_res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533816"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HistOp MCMem -&gt; Int) -&gt; [HistOp MCMem] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int)
-&gt; (HistOp MCMem -&gt; [SubExp]) -&gt; HistOp MCMem -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem -&gt; [SubExp]
forall rep. HistOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#histNeutral"><span class="hs-identifier hs-var hs-var">histNeutral</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533816"><span class="hs-identifier hs-var">histops</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684533801"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533801"><span class="hs-identifier hs-var">all_red_pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533800"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533800"><span class="hs-identifier hs-var">map_pes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [PatElemT LParamMem]
-&gt; ([PatElemT LParamMem], [PatElemT LParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684533804"><span class="hs-identifier hs-var">num_red_res</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem]
 -&gt; ([PatElemT LParamMem], [PatElemT LParamMem]))
-&gt; [PatElemT LParamMem]
-&gt; ([PatElemT LParamMem], [PatElemT LParamMem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
PatT LParamMem
</span><a href="#local-6989586621684533819"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-106"></span><span>
</span><span id="line-107"></span><span>  </span><span id="local-6989586621684533797"><span class="annot"><span class="annottext">[[VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()]
</span><a href="#local-6989586621684533797"><span class="hs-identifier hs-var">atomicOps</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(HistOp MCMem
 -&gt; MulticoreGen
      ([VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()))
-&gt; [HistOp MCMem]
-&gt; ImpM
     MCMem
     HostEnv
     Multicore
     [[VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
-&gt; MulticoreGen
     ([VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#onOpAtomic"><span class="hs-identifier hs-var">onOpAtomic</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533816"><span class="hs-identifier hs-var">histops</span></a></span><span>
</span><span id="line-108"></span><span>
</span><span id="line-109"></span><span>  </span><span id="local-6989586621684533795"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533795"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code)
-&gt; ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-110"></span><span>    </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533814"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64 -&gt; [TExp Int64]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533810"><span class="hs-identifier hs-var">ns_64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; [TExp Int64]) -&gt; TExp Int64 -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533818"><span class="hs-identifier hs-var">flat_idx</span></a></span><span>
</span><span id="line-111"></span><span>    </span><span class="annot"><span class="annottext">Names
-&gt; Stms MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; Stms MCMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533815"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-112"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684533788"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684533788"><span class="hs-identifier hs-var">red_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533787"><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684533787"><span class="hs-identifier hs-var">map_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-113"></span><span>            </span><span class="annot"><span class="annottext">Int -&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Futhark.Util.html#splitFromEnd"><span class="hs-identifier hs-var">splitFromEnd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533800"><span class="hs-identifier hs-var">map_pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; ([KernelResult], [KernelResult]))
-&gt; [KernelResult] -&gt; ([KernelResult], [KernelResult])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533815"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-114"></span><span>          </span><span id="local-6989586621684533785"><span class="annot"><span class="annottext">red_res_split :: [([SubExp], [SubExp])]
</span><a href="#local-6989586621684533785"><span class="hs-identifier hs-var hs-var">red_res_split</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem] -&gt; [SubExp] -&gt; [([SubExp], [SubExp])]
forall rep. [HistOp rep] -&gt; [SubExp] -&gt; [([SubExp], [SubExp])]
</span><a href="Futhark.IR.SegOp.html#splitHistResults"><span class="hs-identifier hs-var">splitHistResults</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533816"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [([SubExp], [SubExp])])
-&gt; [SubExp] -&gt; [([SubExp], [SubExp])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(KernelResult -&gt; SubExp) -&gt; [KernelResult] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684533788"><span class="hs-identifier hs-var">red_res</span></a></span><span>
</span><span id="line-115"></span><span>
</span><span id="line-116"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533781"><span class="annot"><span class="annottext">pes_per_op :: [[PatElemT LParamMem]]
</span><a href="#local-6989586621684533781"><span class="hs-identifier hs-var hs-var">pes_per_op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall a. [Int] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.Util.html#chunks"><span class="hs-identifier hs-var">chunks</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HistOp MCMem -&gt; Int) -&gt; [HistOp MCMem] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; Int)
-&gt; (HistOp MCMem -&gt; [VName]) -&gt; HistOp MCMem -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem -&gt; [VName]
forall rep. HistOp rep -&gt; [VName]
</span><a href="Futhark.IR.SegOp.html#histDest"><span class="hs-identifier hs-var hs-var">histDest</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533816"><span class="hs-identifier hs-var">histops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533801"><span class="hs-identifier hs-var">all_red_pes</span></a></span><span>
</span><span id="line-117"></span><span>      </span><span class="annot"><span class="annottext">[(HistOp MCMem, ([SubExp], [SubExp]),
  [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore (),
  [PatElemT LParamMem])]
-&gt; ((HistOp MCMem, ([SubExp], [SubExp]),
     [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore (),
     [PatElemT LParamMem])
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[HistOp MCMem]
-&gt; [([SubExp], [SubExp])]
-&gt; [[VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()]
-&gt; [[PatElemT LParamMem]]
-&gt; [(HistOp MCMem, ([SubExp], [SubExp]),
     [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore (),
     [PatElemT LParamMem])]
forall a b c d. [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [(a, b, c, d)]
</span><span class="hs-identifier hs-var">zip4</span></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533816"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">[([SubExp], [SubExp])]
</span><a href="#local-6989586621684533785"><span class="hs-identifier hs-var">red_res_split</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()]
</span><a href="#local-6989586621684533797"><span class="hs-identifier hs-var">atomicOps</span></a></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684533781"><span class="hs-identifier hs-var">pes_per_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((HistOp MCMem, ([SubExp], [SubExp]),
   [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore (),
   [PatElemT LParamMem])
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((HistOp MCMem, ([SubExp], [SubExp]),
     [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore (),
     [PatElemT LParamMem])
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-118"></span><span>        </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span id="local-6989586621684533777"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684533777"><span class="hs-identifier hs-var">dest_shape</span></a></span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684533776"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684533776"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684533775"><span class="annot"><span class="annottext">Lambda MCMem
</span><a href="#local-6989586621684533775"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684533774"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533774"><span class="hs-identifier hs-var">bucket</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533773"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533773"><span class="hs-identifier hs-var">vs'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533772"><span class="annot"><span class="annottext">[VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="#local-6989586621684533772"><span class="hs-identifier hs-var">do_op</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533771"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533771"><span class="hs-identifier hs-var">dest_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-119"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684533769"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684533769"><span class="hs-identifier hs-var">_is_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533768"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684533768"><span class="hs-identifier hs-var">vs_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533773"><span class="hs-identifier hs-var">vs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem]))
-&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem -&gt; [LParam MCMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem
</span><a href="#local-6989586621684533775"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-120"></span><span>              </span><span id="local-6989586621684533765"><span class="annot"><span class="annottext">dest_shape' :: [TExp Int64]
</span><a href="#local-6989586621684533765"><span class="hs-identifier hs-var hs-var">dest_shape'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684533777"><span class="hs-identifier hs-var">dest_shape</span></a></span><span>
</span><span id="line-121"></span><span>              </span><span id="local-6989586621684533763"><span class="annot"><span class="annottext">bucket' :: [TExp Int64]
</span><a href="#local-6989586621684533763"><span class="hs-identifier hs-var hs-var">bucket'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533774"><span class="hs-identifier hs-var">bucket</span></a></span><span>
</span><span id="line-122"></span><span>              </span><span id="local-6989586621684533762"><span class="annot"><span class="annottext">bucket_in_bounds :: TPrimExp Bool VName
</span><a href="#local-6989586621684533762"><span class="hs-identifier hs-var hs-var">bucket_in_bounds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [TExp Int64] -&gt; TPrimExp Bool VName
</span><a href="Futhark.CodeGen.ImpGen.html#inBounds"><span class="hs-identifier hs-var">inBounds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; [TExp Int64] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533763"><span class="hs-identifier hs-var">bucket'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533765"><span class="hs-identifier hs-var">dest_shape'</span></a></span><span>
</span><span id="line-123"></span><span>
</span><span id="line-124"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;save map-out results&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-125"></span><span>            </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, KernelResult)]
-&gt; ((PatElemT LParamMem, KernelResult)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem]
-&gt; [KernelResult] -&gt; [(PatElemT LParamMem, KernelResult)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533800"><span class="hs-identifier hs-var">map_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684533787"><span class="hs-identifier hs-var">map_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, KernelResult)
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((PatElemT LParamMem, KernelResult)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684533757"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684533757"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533756"><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684533756"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-126"></span><span>              </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684533757"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533814"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">KernelResult
</span><a href="#local-6989586621684533756"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-127"></span><span>
</span><span id="line-128"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;perform updates&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-129"></span><span>            </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
</span><a href="#local-6989586621684533762"><span class="hs-identifier hs-var">bucket_in_bounds</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-130"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533751"><span class="annot"><span class="annottext">bucket_is :: [TExp Int64]
</span><a href="#local-6989586621684533751"><span class="hs-identifier hs-var hs-var">bucket_is</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533814"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533763"><span class="hs-identifier hs-var">bucket'</span></a></span><span>
</span><span id="line-131"></span><span>              </span><span class="annot"><span class="annottext">[LParam MCMem] -&gt; ImpM MCMem HostEnv Multicore ()
forall rep inner r op.
Mem rep inner =&gt;
[LParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-var">dLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([LParam MCMem] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [LParam MCMem] -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem -&gt; [LParam MCMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem
</span><a href="#local-6989586621684533775"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-132"></span><span>              </span><span class="annot"><span class="annottext">Shape
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684533776"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684533747"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533747"><span class="hs-identifier hs-var">is'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>                </span><span class="annot"><span class="annottext">[(Param LParamMem, SubExp)]
-&gt; ((Param LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [SubExp] -&gt; [(Param LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684533768"><span class="hs-identifier hs-var">vs_params</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533773"><span class="hs-identifier hs-var">vs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((Param LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684533746"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684533746"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533745"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533745"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-134"></span><span>                  </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684533746"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533745"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533747"><span class="hs-identifier hs-var">is'</span></a></span><span>
</span><span id="line-135"></span><span>                </span><span class="annot"><span class="annottext">[VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="#local-6989586621684533772"><span class="hs-identifier hs-var">do_op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatElemT LParamMem -&gt; VName) -&gt; [PatElemT LParamMem] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533771"><span class="hs-identifier hs-var">dest_res</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533751"><span class="hs-identifier hs-var">bucket_is</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533747"><span class="hs-identifier hs-var">is'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-136"></span><span>
</span><span id="line-137"></span><span>  </span><span id="local-6989586621684533743"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684533743"><span class="hs-identifier hs-var">free_params</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Code -&gt; [VName] -&gt; MulticoreGen [Param]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#freeParams"><span class="hs-identifier hs-var">freeParams</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533795"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533817"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533818"><span class="hs-identifier hs-var">flat_idx</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-138"></span><span>  </span><span class="annot"><span class="annottext">Code -&gt; ImpM MCMem HostEnv Multicore ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Code -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Multicore -&gt; Code
forall a. a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Op"><span class="hs-identifier hs-var">Imp.Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Multicore -&gt; Code) -&gt; Multicore -&gt; Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; VName -&gt; Code -&gt; Code -&gt; Code -&gt; [Param] -&gt; VName -&gt; Multicore
</span><a href="Futhark.CodeGen.ImpCode.Multicore.html#ParLoop"><span class="hs-identifier hs-var">Imp.ParLoop</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;atomic_seg_hist&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533818"><span class="hs-identifier hs-var">flat_idx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Code
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533795"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">Code
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684533743"><span class="hs-identifier hs-var">free_params</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Multicore) -&gt; VName -&gt; Multicore
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533817"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-139"></span><span>
</span><span id="line-140"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#updateHisto"><span class="hs-identifier hs-type">updateHisto</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span id="updateHisto"><span class="annot"><span class="annottext">updateHisto :: HistOp MCMem
-&gt; [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#updateHisto"><span class="hs-identifier hs-var hs-var">updateHisto</span></a></span></span><span> </span><span id="local-6989586621684533735"><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533735"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span id="local-6989586621684533734"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533734"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684533733"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533733"><span class="hs-identifier hs-var">bucket</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533731"><span class="annot"><span class="annottext">acc_params :: [Param LParamMem]
</span><a href="#local-6989586621684533731"><span class="hs-identifier hs-var hs-var">acc_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533734"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; [Param LParamMem])
-&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem -&gt; [LParam MCMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda MCMem -&gt; [LParam MCMem]) -&gt; Lambda MCMem -&gt; [LParam MCMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem -&gt; Lambda MCMem
forall rep. HistOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#histOp"><span class="hs-identifier hs-var hs-var">histOp</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533735"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-143"></span><span>      </span><span id="local-6989586621684533727"><span class="annot"><span class="annottext">bind_acc_params :: ImpM rep r op ()
</span><a href="#local-6989586621684533727"><span class="hs-identifier hs-var hs-var">bind_acc_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-144"></span><span>        </span><span class="annot"><span class="annottext">[(Param LParamMem, VName)]
-&gt; ((Param LParamMem, VName) -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [VName] -&gt; [(Param LParamMem, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684533731"><span class="hs-identifier hs-var">acc_params</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533734"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, VName) -&gt; ImpM rep r op ())
 -&gt; ImpM rep r op ())
-&gt; ((Param LParamMem, VName) -&gt; ImpM rep r op ())
-&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684533726"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684533726"><span class="hs-identifier hs-var">acc_p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533725"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533725"><span class="hs-identifier hs-var">arr</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-145"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684533726"><span class="hs-identifier hs-var">acc_p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533725"><span class="hs-identifier hs-var">arr</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533733"><span class="hs-identifier hs-var">bucket</span></a></span><span>
</span><span id="line-146"></span><span>      </span><span id="local-6989586621684533723"><span class="annot"><span class="annottext">op_body :: ImpM MCMem r op ()
</span><a href="#local-6989586621684533723"><span class="hs-identifier hs-var hs-var">op_body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param Any] -&gt; Body MCMem -&gt; ImpM MCMem r op ()
forall dec rep r op. [Param dec] -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody%27"><span class="hs-identifier hs-var">compileBody'</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; ImpM MCMem r op ())
-&gt; Body MCMem -&gt; ImpM MCMem r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem -&gt; Body MCMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda MCMem -&gt; Body MCMem) -&gt; Lambda MCMem -&gt; Body MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem -&gt; Lambda MCMem
forall rep. HistOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#histOp"><span class="hs-identifier hs-var hs-var">histOp</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533735"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-147"></span><span>      </span><span id="local-6989586621684533720"><span class="annot"><span class="annottext">writeArray :: VName -&gt; SubExp -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684533720"><span class="hs-identifier hs-var hs-var">writeArray</span></a></span></span><span> </span><span id="local-6989586621684533719"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533719"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span id="local-6989586621684533718"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533718"><span class="hs-identifier hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533719"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533733"><span class="hs-identifier hs-var">bucket</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533718"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-148"></span><span>      </span><span id="local-6989586621684533716"><span class="annot"><span class="annottext">do_hist :: ImpM rep r op ()
</span><a href="#local-6989586621684533716"><span class="hs-identifier hs-var hs-var">do_hist</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp -&gt; ImpM rep r op ())
-&gt; [VName] -&gt; [SubExp] -&gt; ImpM rep r op ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp -&gt; ImpM rep r op ()
forall {rep} {r} {op}. VName -&gt; SubExp -&gt; ImpM rep r op ()
</span><a href="#local-6989586621684533720"><span class="hs-identifier hs-var">writeArray</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533734"><span class="hs-identifier hs-var">arrs</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; ImpM rep r op ()) -&gt; [SubExp] -&gt; ImpM rep r op ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body MCMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; [SubExpRes]) -&gt; Body MCMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem -&gt; Body MCMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Lambda MCMem -&gt; Body MCMem) -&gt; Lambda MCMem -&gt; Body MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem -&gt; Lambda MCMem
forall rep. HistOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#histOp"><span class="hs-identifier hs-var hs-var">histOp</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533735"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-149"></span><span>
</span><span id="line-150"></span><span>  </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Start of body&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-151"></span><span>    </span><span class="annot"><span class="annottext">[LParam MCMem] -&gt; ImpM MCMem HostEnv Multicore ()
forall rep inner r op.
Mem rep inner =&gt;
[LParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-var">dLParams</span></a></span><span> </span><span class="annot"><span class="annottext">[LParam MCMem]
[Param LParamMem]
</span><a href="#local-6989586621684533731"><span class="hs-identifier hs-var">acc_params</span></a></span><span>
</span><span id="line-152"></span><span>    </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore ()
forall {rep} {r} {op}. ImpM rep r op ()
</span><a href="#local-6989586621684533727"><span class="hs-identifier hs-var">bind_acc_params</span></a></span><span>
</span><span id="line-153"></span><span>    </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore ()
forall {r} {op}. ImpM MCMem r op ()
</span><a href="#local-6989586621684533723"><span class="hs-identifier hs-var">op_body</span></a></span><span>
</span><span id="line-154"></span><span>    </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore ()
forall {rep} {r} {op}. ImpM rep r op ()
</span><a href="#local-6989586621684533716"><span class="hs-identifier hs-var">do_hist</span></a></span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span class="hs-comment">-- Generates num_histos sub-histograms of the size</span><span>
</span><span id="line-157"></span><span class="hs-comment">-- of the destination histogram</span><span>
</span><span id="line-158"></span><span class="hs-comment">-- Then for each chunk of the input each subhistogram</span><span>
</span><span id="line-159"></span><span class="hs-comment">-- is computed and finally combined through a segmented reduction</span><span>
</span><span id="line-160"></span><span class="hs-comment">-- across the histogram indicies.</span><span>
</span><span id="line-161"></span><span class="hs-comment">-- This is expected to be fast if len(histDest) is small</span><span>
</span><span id="line-162"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#subHistogram"><span class="hs-identifier hs-type">subHistogram</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-163"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-164"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-165"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-166"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-167"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-168"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-169"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-170"></span><span id="subHistogram"><span class="annot"><span class="annottext">subHistogram :: Pat MCMem
-&gt; TV Int64
-&gt; SegSpace
-&gt; [HistOp MCMem]
-&gt; TV Int32
-&gt; KernelBody MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#subHistogram"><span class="hs-identifier hs-var hs-var">subHistogram</span></a></span></span><span> </span><span id="local-6989586621684533713"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684533713"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684533712"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533712"><span class="hs-identifier hs-var">flat_idx</span></a></span></span><span> </span><span id="local-6989586621684533711"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533711"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684533710"><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533710"><span class="hs-identifier hs-var">histops</span></a></span></span><span> </span><span id="local-6989586621684533709"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684533709"><span class="hs-identifier hs-var">num_histos</span></a></span></span><span> </span><span id="local-6989586621684533708"><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533708"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>  </span><span class="annot"><span class="annottext">Code -&gt; ImpM MCMem HostEnv Multicore ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Code -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;subHistogram segHist&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-172"></span><span>
</span><span id="line-173"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684533706"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533706"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533705"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533705"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533711"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-174"></span><span>      </span><span id="local-6989586621684533703"><span class="annot"><span class="annottext">ns_64 :: [TExp Int64]
</span><a href="#local-6989586621684533703"><span class="hs-identifier hs-var hs-var">ns_64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533705"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-175"></span><span>
</span><span id="line-176"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533702"><span class="annot"><span class="annottext">pes :: [PatElemT LParamMem]
</span><a href="#local-6989586621684533702"><span class="hs-identifier hs-var hs-var">pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
PatT LParamMem
</span><a href="#local-6989586621684533713"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-177"></span><span>      </span><span id="local-6989586621684533696"><span class="annot"><span class="annottext">num_red_res :: Int
</span><a href="#local-6989586621684533696"><span class="hs-identifier hs-var hs-var">num_red_res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533710"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HistOp MCMem -&gt; Int) -&gt; [HistOp MCMem] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int)
-&gt; (HistOp MCMem -&gt; [SubExp]) -&gt; HistOp MCMem -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem -&gt; [SubExp]
forall rep. HistOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#histNeutral"><span class="hs-identifier hs-var hs-var">histNeutral</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533710"><span class="hs-identifier hs-var">histops</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-178"></span><span>      </span><span id="local-6989586621684533695"><span class="annot"><span class="annottext">map_pes :: [PatElemT LParamMem]
</span><a href="#local-6989586621684533695"><span class="hs-identifier hs-var hs-var">map_pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [PatElemT LParamMem] -&gt; [PatElemT LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684533696"><span class="hs-identifier hs-var">num_red_res</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533702"><span class="hs-identifier hs-var">pes</span></a></span><span>
</span><span id="line-179"></span><span>      </span><span id="local-6989586621684533693"><span class="annot"><span class="annottext">per_red_pes :: [[PatElemT LParamMem]]
</span><a href="#local-6989586621684533693"><span class="hs-identifier hs-var hs-var">per_red_pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem] -&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall rep a. [HistOp rep] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#segHistOpChunks"><span class="hs-identifier hs-var">segHistOpChunks</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533710"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [[PatElemT LParamMem]])
-&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
PatT LParamMem
</span><a href="#local-6989586621684533713"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span>  </span><span class="hs-comment">-- Allocate array of subhistograms in the calling thread.  Each</span><span>
</span><span id="line-182"></span><span>  </span><span class="hs-comment">-- tasks will work in its own private allocations (to avoid false</span><span>
</span><span id="line-183"></span><span>  </span><span class="hs-comment">-- sharing), but this is where they will ultimately copy their</span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-comment">-- results.</span><span>
</span><span id="line-185"></span><span>  </span><span id="local-6989586621684533692"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684533692"><span class="hs-identifier hs-var">global_subhistograms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
-&gt; (HistOp MCMem -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; ImpM MCMem HostEnv Multicore [[VName]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533710"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">((HistOp MCMem -&gt; ImpM MCMem HostEnv Multicore [VName])
 -&gt; ImpM MCMem HostEnv Multicore [[VName]])
-&gt; (HistOp MCMem -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; ImpM MCMem HostEnv Multicore [[VName]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684533690"><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533690"><span class="hs-identifier hs-var">histop</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-186"></span><span>    </span><span class="annot"><span class="annottext">[Type]
-&gt; (Type -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; ImpM MCMem HostEnv Multicore [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistOp MCMem -&gt; [Type]
forall rep. HistOp rep -&gt; [Type]
</span><a href="Futhark.IR.SegOp.html#histType"><span class="hs-identifier hs-var">histType</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533690"><span class="hs-identifier hs-var">histop</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Type -&gt; ImpM MCMem HostEnv Multicore VName)
 -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; (Type -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; ImpM MCMem HostEnv Multicore [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684533688"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684533688"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-187"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533685"><span class="annot"><span class="annottext">shape :: Shape
</span><a href="#local-6989586621684533685"><span class="hs-identifier hs-var hs-var">shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Shape
forall d. [d] -&gt; ShapeBase d
</span><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int32 -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684533709"><span class="hs-identifier hs-var">num_histos</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Shape -&gt; Shape -&gt; Shape
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; Shape
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684533688"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-188"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM MCMem HostEnv Multicore VName
forall rep r op.
String -&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var">sAllocArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;subhistogram&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684533688"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684533685"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533679"><span class="annot"><span class="annottext">tid' :: TExp Int64
</span><a href="#local-6989586621684533679"><span class="hs-identifier hs-var hs-var">tid'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; VName -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533711"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-191"></span><span>      </span><span id="local-6989586621684533678"><span class="annot"><span class="annottext">flat_idx' :: TExp Int64
</span><a href="#local-6989586621684533678"><span class="hs-identifier hs-var hs-var">flat_idx'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533712"><span class="hs-identifier hs-var">flat_idx</span></a></span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684533677"><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684533677"><span class="hs-identifier hs-var">local_subhistograms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533676"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533676"><span class="hs-identifier hs-var">prebody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore [[VName]]
-&gt; ImpM MCMem HostEnv Multicore ([[VName]], Code)
forall rep r op a. ImpM rep r op a -&gt; ImpM rep r op (a, Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect%27"><span class="hs-identifier hs-var">collect'</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore [[VName]]
 -&gt; ImpM MCMem HostEnv Multicore ([[VName]], Code))
-&gt; ImpM MCMem HostEnv Multicore [[VName]]
-&gt; ImpM MCMem HostEnv Multicore ([[VName]], Code)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-194"></span><span>    </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533706"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64 -&gt; [TExp Int64]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533703"><span class="hs-identifier hs-var">ns_64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; [TExp Int64]) -&gt; TExp Int64 -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684533678"><span class="hs-identifier hs-var">flat_idx'</span></a></span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span>    </span><span class="annot"><span class="annottext">[([PatElemT LParamMem], HistOp MCMem)]
-&gt; (([PatElemT LParamMem], HistOp MCMem)
    -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; ImpM MCMem HostEnv Multicore [[VName]]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
-&gt; [HistOp MCMem] -&gt; [([PatElemT LParamMem], HistOp MCMem)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684533693"><span class="hs-identifier hs-var">per_red_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533710"><span class="hs-identifier hs-var">histops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((([PatElemT LParamMem], HistOp MCMem)
  -&gt; ImpM MCMem HostEnv Multicore [VName])
 -&gt; ImpM MCMem HostEnv Multicore [[VName]])
-&gt; (([PatElemT LParamMem], HistOp MCMem)
    -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; ImpM MCMem HostEnv Multicore [[VName]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684533674"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533674"><span class="hs-identifier hs-var">pes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533673"><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533673"><span class="hs-identifier hs-var">histop</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-197"></span><span>      </span><span id="local-6989586621684533672"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533672"><span class="hs-identifier hs-var">op_local_subhistograms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Type]
-&gt; (Type -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; ImpM MCMem HostEnv Multicore [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistOp MCMem -&gt; [Type]
forall rep. HistOp rep -&gt; [Type]
</span><a href="Futhark.IR.SegOp.html#histType"><span class="hs-identifier hs-var">histType</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533673"><span class="hs-identifier hs-var">histop</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((Type -&gt; ImpM MCMem HostEnv Multicore VName)
 -&gt; ImpM MCMem HostEnv Multicore [VName])
-&gt; (Type -&gt; ImpM MCMem HostEnv Multicore VName)
-&gt; ImpM MCMem HostEnv Multicore [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684533671"><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684533671"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-198"></span><span>        </span><span class="annot"><span class="annottext">String
-&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM MCMem HostEnv Multicore VName
forall rep r op.
String -&gt; PrimType -&gt; Shape -&gt; Space -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sAllocArray"><span class="hs-identifier hs-var">sAllocArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;subhistogram&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; PrimType
forall shape u. TypeBase shape u -&gt; PrimType
</span><a href="Futhark.IR.Prop.Types.html#elemType"><span class="hs-identifier hs-var">elemType</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684533671"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Type -&gt; Shape
forall shape u. ArrayShape shape =&gt; TypeBase shape u -&gt; shape
</span><a href="Futhark.IR.Prop.Types.html#arrayShape"><span class="hs-identifier hs-var">arrayShape</span></a></span><span> </span><span class="annot"><span class="annottext">Type
</span><a href="#local-6989586621684533671"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="Futhark.IR.Syntax.Core.html#DefaultSpace"><span class="hs-identifier hs-var">DefaultSpace</span></a></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span>      </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, VName, SubExp)]
-&gt; ((PatElemT LParamMem, VName, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem]
-&gt; [VName] -&gt; [SubExp] -&gt; [(PatElemT LParamMem, VName, SubExp)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533674"><span class="hs-identifier hs-var">pes'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533672"><span class="hs-identifier hs-var">op_local_subhistograms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistOp MCMem -&gt; [SubExp]
forall rep. HistOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#histNeutral"><span class="hs-identifier hs-var hs-var">histNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533673"><span class="hs-identifier hs-var">histop</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, VName, SubExp)
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((PatElemT LParamMem, VName, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684533669"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684533669"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533668"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533668"><span class="hs-identifier hs-var">hist</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533667"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533667"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-201"></span><span>        </span><span class="hs-comment">-- First thread initializes histogram with dest vals. Others</span><span>
</span><span id="line-202"></span><span>        </span><span class="hs-comment">-- initialize with neutral element</span><span>
</span><span id="line-203"></span><span>        </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
TPrimExp Bool VName
-&gt; ImpM rep r op () -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sIf"><span class="hs-identifier hs-var">sIf</span></a></span><span>
</span><span id="line-204"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684533679"><span class="hs-identifier hs-var">tid'</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TPrimExp Bool VName
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-205"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533668"><span class="hs-identifier hs-var">hist</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684533669"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-206"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Shape
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistOp MCMem -&gt; Shape
forall rep. HistOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#histShape"><span class="hs-identifier hs-var hs-var">histShape</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533673"><span class="hs-identifier hs-var">histop</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684533666"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533666"><span class="hs-identifier hs-var">shape_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-207"></span><span>              </span><span class="annot"><span class="annottext">Shape
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistOp MCMem -&gt; Shape
forall rep. HistOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#histOpShape"><span class="hs-identifier hs-var hs-var">histOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533673"><span class="hs-identifier hs-var">histop</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684533665"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533665"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-208"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533668"><span class="hs-identifier hs-var">hist</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533666"><span class="hs-identifier hs-var">shape_is</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533665"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533667"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-209"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; ImpM MCMem HostEnv Multicore [VName]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533672"><span class="hs-identifier hs-var">op_local_subhistograms</span></a></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-comment">-- Generate loop body of parallel function</span><span>
</span><span id="line-214"></span><span>  </span><span id="local-6989586621684533664"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533664"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code)
-&gt; ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-215"></span><span>    </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533706"><span class="hs-identifier hs-var">is</span></a></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64 -&gt; [TExp Int64]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533703"><span class="hs-identifier hs-var">ns_64</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; [TExp Int64]) -&gt; TExp Int64 -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684533678"><span class="hs-identifier hs-var">flat_idx'</span></a></span><span>
</span><span id="line-216"></span><span>    </span><span class="annot"><span class="annottext">Names
-&gt; Stms MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; Stms MCMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533708"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-217"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684533662"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533662"><span class="hs-identifier hs-var">red_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533661"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533661"><span class="hs-identifier hs-var">map_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-218"></span><span>            </span><span class="annot"><span class="annottext">Int -&gt; [SubExp] -&gt; ([SubExp], [SubExp])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Futhark.Util.html#splitFromEnd"><span class="hs-identifier hs-var">splitFromEnd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533695"><span class="hs-identifier hs-var">map_pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; ([SubExp], [SubExp]))
-&gt; [SubExp] -&gt; ([SubExp], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-219"></span><span>              </span><span class="annot"><span class="annottext">(KernelResult -&gt; SubExp) -&gt; [KernelResult] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; [SubExp]) -&gt; [KernelResult] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533708"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-220"></span><span>
</span><span id="line-221"></span><span>      </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;save map-out results&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-222"></span><span>        </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, SubExp)]
-&gt; ((PatElemT LParamMem, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; [SubExp] -&gt; [(PatElemT LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533695"><span class="hs-identifier hs-var">map_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533661"><span class="hs-identifier hs-var">map_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((PatElemT LParamMem, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684533660"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684533660"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533659"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533659"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-223"></span><span>          </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684533660"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533706"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533659"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span>      </span><span class="annot"><span class="annottext">[(HistOp MCMem, [VName], ([SubExp], [SubExp]))]
-&gt; ((HistOp MCMem, [VName], ([SubExp], [SubExp]))
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[HistOp MCMem]
-&gt; [[VName]]
-&gt; [([SubExp], [SubExp])]
-&gt; [(HistOp MCMem, [VName], ([SubExp], [SubExp]))]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533710"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684533677"><span class="hs-identifier hs-var">local_subhistograms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[HistOp MCMem] -&gt; [SubExp] -&gt; [([SubExp], [SubExp])]
forall rep. [HistOp rep] -&gt; [SubExp] -&gt; [([SubExp], [SubExp])]
</span><a href="Futhark.IR.SegOp.html#splitHistResults"><span class="hs-identifier hs-var">splitHistResults</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533710"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533662"><span class="hs-identifier hs-var">red_res</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((HistOp MCMem, [VName], ([SubExp], [SubExp]))
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((HistOp MCMem, [VName], ([SubExp], [SubExp]))
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-226"></span><span>        </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span> </span><span id="local-6989586621684533658"><span class="annot"><span class="annottext">histop :: HistOp MCMem
</span><a href="#local-6989586621684533658"><span class="hs-identifier hs-var">histop</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span id="local-6989586621684533657"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684533657"><span class="hs-identifier hs-var">dest_shape</span></a></span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684533656"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684533656"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684533655"><span class="annot"><span class="annottext">Lambda MCMem
</span><a href="#local-6989586621684533655"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-227"></span><span>           </span><span id="local-6989586621684533654"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533654"><span class="hs-identifier hs-var">histop_subhistograms</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-228"></span><span>           </span><span class="hs-special">(</span><span id="local-6989586621684533653"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533653"><span class="hs-identifier hs-var">bucket</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533652"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533652"><span class="hs-identifier hs-var">vs'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>           </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-230"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533650"><span class="annot"><span class="annottext">bucket' :: [TExp Int64]
</span><a href="#local-6989586621684533650"><span class="hs-identifier hs-var hs-var">bucket'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533653"><span class="hs-identifier hs-var">bucket</span></a></span><span>
</span><span id="line-231"></span><span>                </span><span id="local-6989586621684533648"><span class="annot"><span class="annottext">dest_shape' :: [TExp Int64]
</span><a href="#local-6989586621684533648"><span class="hs-identifier hs-var hs-var">dest_shape'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684533657"><span class="hs-identifier hs-var">dest_shape</span></a></span><span>
</span><span id="line-232"></span><span>                </span><span id="local-6989586621684533647"><span class="annot"><span class="annottext">bucket_in_bounds :: TPrimExp Bool VName
</span><a href="#local-6989586621684533647"><span class="hs-identifier hs-var hs-var">bucket_in_bounds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-233"></span><span>                  </span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [TExp Int64] -&gt; TPrimExp Bool VName
</span><a href="Futhark.CodeGen.ImpGen.html#inBounds"><span class="hs-identifier hs-var">inBounds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; [TExp Int64] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533650"><span class="hs-identifier hs-var">bucket'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533648"><span class="hs-identifier hs-var">dest_shape'</span></a></span><span>
</span><span id="line-234"></span><span>                </span><span id="local-6989586621684533645"><span class="annot"><span class="annottext">vs_params :: [Param LParamMem]
</span><a href="#local-6989586621684533645"><span class="hs-identifier hs-var hs-var">vs_params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#takeLast"><span class="hs-identifier hs-var">takeLast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533652"><span class="hs-identifier hs-var">vs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; [Param LParamMem])
-&gt; [Param LParamMem] -&gt; [Param LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem -&gt; [LParam MCMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem
</span><a href="#local-6989586621684533655"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-235"></span><span>
</span><span id="line-236"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;perform updates&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-237"></span><span>              </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
</span><a href="#local-6989586621684533647"><span class="hs-identifier hs-var">bucket_in_bounds</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-238"></span><span>                </span><span class="annot"><span class="annottext">[LParam MCMem] -&gt; ImpM MCMem HostEnv Multicore ()
forall rep inner r op.
Mem rep inner =&gt;
[LParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-var">dLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([LParam MCMem] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [LParam MCMem] -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem -&gt; [LParam MCMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem
</span><a href="#local-6989586621684533655"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-239"></span><span>                </span><span class="annot"><span class="annottext">Shape
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684533656"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684533644"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533644"><span class="hs-identifier hs-var">is'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-240"></span><span>                  </span><span class="annot"><span class="annottext">[(Param LParamMem, SubExp)]
-&gt; ((Param LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [SubExp] -&gt; [(Param LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684533645"><span class="hs-identifier hs-var">vs_params</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533652"><span class="hs-identifier hs-var">vs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((Param LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684533643"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684533643"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533642"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533642"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-241"></span><span>                    </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684533643"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533642"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533644"><span class="hs-identifier hs-var">is'</span></a></span><span>
</span><span id="line-242"></span><span>                  </span><span class="annot"><span class="annottext">HistOp MCMem
-&gt; [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#updateHisto"><span class="hs-identifier hs-var">updateHisto</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533658"><span class="hs-identifier hs-var">histop</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533654"><span class="hs-identifier hs-var">histop_subhistograms</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533650"><span class="hs-identifier hs-var">bucket'</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533644"><span class="hs-identifier hs-var">is'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span>  </span><span class="hs-comment">-- Copy the task-local subhistograms to the global subhistograms,</span><span>
</span><span id="line-245"></span><span>  </span><span class="hs-comment">-- where they will be combined.</span><span>
</span><span id="line-246"></span><span>  </span><span id="local-6989586621684533641"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533641"><span class="hs-identifier hs-var">postbody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code)
-&gt; ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-247"></span><span>    </span><span class="annot"><span class="annottext">[(VName, VName)]
-&gt; ((VName, VName) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [(VName, VName)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[VName]] -&gt; [VName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684533692"><span class="hs-identifier hs-var">global_subhistograms</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[VName]] -&gt; [VName]
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><span class="hs-identifier hs-var">concat</span></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684533677"><span class="hs-identifier hs-var">local_subhistograms</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((VName, VName) -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((VName, VName) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-248"></span><span>      </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684533639"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533639"><span class="hs-identifier hs-var">global</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533638"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533638"><span class="hs-identifier hs-var">local</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533639"><span class="hs-identifier hs-var">global</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684533679"><span class="hs-identifier hs-var">tid'</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533638"><span class="hs-identifier hs-var">local</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-249"></span><span>
</span><span id="line-250"></span><span>  </span><span id="local-6989586621684533637"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684533637"><span class="hs-identifier hs-var">free_params</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Code -&gt; [VName] -&gt; MulticoreGen [Param]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#freeParams"><span class="hs-identifier hs-var">freeParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533676"><span class="hs-identifier hs-var">prebody</span></a></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Code -&gt; Code
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533664"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Code -&gt; Code
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533641"><span class="hs-identifier hs-var">postbody</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533711"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; [VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533712"><span class="hs-identifier hs-var">flat_idx</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684533636"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533636"><span class="hs-identifier hs-var">body_allocs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533635"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533635"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code -&gt; (Code, Code)
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#extractAllocations"><span class="hs-identifier hs-var">extractAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533664"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-252"></span><span>  </span><span class="annot"><span class="annottext">Code -&gt; ImpM MCMem HostEnv Multicore ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Code -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Multicore -&gt; Code
forall a. a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Op"><span class="hs-identifier hs-var">Imp.Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Multicore -&gt; Code) -&gt; Multicore -&gt; Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; VName -&gt; Code -&gt; Code -&gt; Code -&gt; [Param] -&gt; VName -&gt; Multicore
</span><a href="Futhark.CodeGen.ImpCode.Multicore.html#ParLoop"><span class="hs-identifier hs-var">Imp.ParLoop</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;seghist_stage_1&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533712"><span class="hs-identifier hs-var">flat_idx</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533636"><span class="hs-identifier hs-var">body_allocs</span></a></span><span> </span><span class="annot"><span class="annottext">Code -&gt; Code -&gt; Code
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533676"><span class="hs-identifier hs-var">prebody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533635"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533641"><span class="hs-identifier hs-var">postbody</span></a></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684533637"><span class="hs-identifier hs-var">free_params</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Multicore) -&gt; VName -&gt; Multicore
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533711"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span>  </span><span class="hs-comment">-- Perform a segmented reduction over the subhistograms</span><span>
</span><span id="line-255"></span><span>  </span><span class="annot"><span class="annottext">[([PatElemT LParamMem], [VName], HistOp MCMem)]
-&gt; (([PatElemT LParamMem], [VName], HistOp MCMem)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
-&gt; [[VName]]
-&gt; [HistOp MCMem]
-&gt; [([PatElemT LParamMem], [VName], HistOp MCMem)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684533693"><span class="hs-identifier hs-var">per_red_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[[VName]]
</span><a href="#local-6989586621684533692"><span class="hs-identifier hs-var">global_subhistograms</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533710"><span class="hs-identifier hs-var">histops</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((([PatElemT LParamMem], [VName], HistOp MCMem)
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; (([PatElemT LParamMem], [VName], HistOp MCMem)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684533633"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533633"><span class="hs-identifier hs-var">red_pes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533632"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533632"><span class="hs-identifier hs-var">hists</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533631"><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533631"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>    </span><span id="local-6989586621684533630"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533630"><span class="hs-identifier hs-var">bucket_ids</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-257"></span><span>      </span><span class="annot"><span class="annottext">Int
-&gt; ImpM MCMem HostEnv Multicore VName
-&gt; ImpM MCMem HostEnv Multicore [VName]
forall (m :: * -&gt; *) a. Applicative m =&gt; Int -&gt; m a -&gt; m [a]
</span><span class="hs-identifier hs-var">replicateM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape -&gt; Int
forall a. ArrayShape a =&gt; a -&gt; Int
</span><a href="Futhark.IR.Syntax.Core.html#shapeRank"><span class="hs-identifier hs-var">shapeRank</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistOp MCMem -&gt; Shape
forall rep. HistOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#histShape"><span class="hs-identifier hs-var hs-var">histShape</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533631"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; ImpM MCMem HostEnv Multicore VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;bucket_id&quot;</span></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>    </span><span id="local-6989586621684533626"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533626"><span class="hs-identifier hs-var">subhistogram_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; ImpM MCMem HostEnv Multicore VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;subhistogram_id&quot;</span></span><span>
</span><span id="line-259"></span><span>
</span><span id="line-260"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533625"><span class="annot"><span class="annottext">segred_space :: SegSpace
</span><a href="#local-6989586621684533625"><span class="hs-identifier hs-var hs-var">segred_space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-261"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; [(VName, SubExp)] -&gt; SegSpace
</span><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-var">SegSpace</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533711"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; SegSpace) -&gt; [(VName, SubExp)] -&gt; SegSpace
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-262"></span><span>            </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684533623"><span class="hs-identifier hs-var">segment_dims</span></a></span><span>
</span><span id="line-263"></span><span>              </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; [(VName, SubExp)] -&gt; [(VName, SubExp)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [SubExp] -&gt; [(VName, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533630"><span class="hs-identifier hs-var">bucket_ids</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistOp MCMem -&gt; Shape
forall rep. HistOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#histShape"><span class="hs-identifier hs-var hs-var">histShape</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533631"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>              </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; [(VName, SubExp)] -&gt; [(VName, SubExp)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533626"><span class="hs-identifier hs-var">subhistogram_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; SubExp
forall t. TV t -&gt; SubExp
</span><a href="Futhark.CodeGen.ImpGen.html#tvSize"><span class="hs-identifier hs-var">tvSize</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684533709"><span class="hs-identifier hs-var">num_histos</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-265"></span><span>
</span><span id="line-266"></span><span>        </span><span id="local-6989586621684533622"><span class="annot"><span class="annottext">segred_op :: SegBinOp MCMem
</span><a href="#local-6989586621684533622"><span class="hs-identifier hs-var hs-var">segred_op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Commutativity
-&gt; Lambda MCMem -&gt; [SubExp] -&gt; Shape -&gt; SegBinOp MCMem
forall rep.
Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Shape -&gt; SegBinOp rep
</span><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-var">SegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Noncommutative"><span class="hs-identifier hs-var">Noncommutative</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistOp MCMem -&gt; Lambda MCMem
forall rep. HistOp rep -&gt; Lambda rep
</span><a href="Futhark.IR.SegOp.html#histOp"><span class="hs-identifier hs-var hs-var">histOp</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533631"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistOp MCMem -&gt; [SubExp]
forall rep. HistOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#histNeutral"><span class="hs-identifier hs-var hs-var">histNeutral</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533631"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HistOp MCMem -&gt; Shape
forall rep. HistOp rep -&gt; Shape
</span><a href="Futhark.IR.SegOp.html#histOpShape"><span class="hs-identifier hs-var hs-var">histOpShape</span></a></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem
</span><a href="#local-6989586621684533631"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span>    </span><span id="local-6989586621684533619"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684533619"><span class="hs-identifier hs-var">nsubtasks_red</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int32)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_tasks&quot;</span></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int32))
-&gt; PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int32)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span>
</span><span id="line-269"></span><span>    </span><span id="local-6989586621684533616"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533616"><span class="hs-identifier hs-var">red_code</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Pat MCMem
-&gt; SegSpace
-&gt; [SegBinOp MCMem]
-&gt; TV Int32
-&gt; DoSegBody
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegRed.html#compileSegRed%27"><span class="hs-identifier hs-var">compileSegRed'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; PatT LParamMem
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533633"><span class="hs-identifier hs-var">red_pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533625"><span class="hs-identifier hs-var">segred_space</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SegBinOp MCMem
</span><a href="#local-6989586621684533622"><span class="hs-identifier hs-var">segred_op</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684533619"><span class="hs-identifier hs-var">nsubtasks_red</span></a></span><span> </span><span class="annot"><span class="annottext">(DoSegBody -&gt; MulticoreGen Code) -&gt; DoSegBody -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684533614"><span class="annot"><span class="annottext">[(SubExp, [TExp Int64])] -&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="#local-6989586621684533614"><span class="hs-identifier hs-var">red_cont</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-270"></span><span>      </span><span class="annot"><span class="annottext">[(SubExp, [TExp Int64])] -&gt; ImpM MCMem HostEnv Multicore ()
</span><a href="#local-6989586621684533614"><span class="hs-identifier hs-var">red_cont</span></a></span><span> </span><span class="annot"><span class="annottext">([(SubExp, [TExp Int64])] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [(SubExp, [TExp Int64])] -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-271"></span><span>        </span><span class="annot"><span class="annottext">((VName -&gt; (SubExp, [TExp Int64]))
 -&gt; [VName] -&gt; [(SubExp, [TExp Int64])])
-&gt; [VName]
-&gt; (VName -&gt; (SubExp, [TExp Int64]))
-&gt; [(SubExp, [TExp Int64])]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; (SubExp, [TExp Int64]))
-&gt; [VName] -&gt; [(SubExp, [TExp Int64])]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533632"><span class="hs-identifier hs-var">hists</span></a></span><span> </span><span class="annot"><span class="annottext">((VName -&gt; (SubExp, [TExp Int64])) -&gt; [(SubExp, [TExp Int64])])
-&gt; (VName -&gt; (SubExp, [TExp Int64])) -&gt; [(SubExp, [TExp Int64])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684533612"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533612"><span class="hs-identifier hs-var">subhisto</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-272"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533612"><span class="hs-identifier hs-var">subhisto</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-273"></span><span>            </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [TExp Int64]) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-274"></span><span>              </span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; VName) -&gt; [(VName, SubExp)] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)]
</span><a href="#local-6989586621684533623"><span class="hs-identifier hs-var">segment_dims</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684533626"><span class="hs-identifier hs-var">subhistogram_id</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533630"><span class="hs-identifier hs-var">bucket_ids</span></a></span><span>
</span><span id="line-275"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-276"></span><span>
</span><span id="line-277"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533610"><span class="annot"><span class="annottext">ns_red :: [TExp Int64]
</span><a href="#local-6989586621684533610"><span class="hs-identifier hs-var hs-var">ns_red</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((VName, SubExp) -&gt; TExp Int64)
-&gt; [(VName, SubExp)] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64)
-&gt; ((VName, SubExp) -&gt; SubExp) -&gt; (VName, SubExp) -&gt; TExp Int64
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VName, SubExp) -&gt; SubExp
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; [TExp Int64])
-&gt; [(VName, SubExp)] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533625"><span class="hs-identifier hs-var">segred_space</span></a></span><span>
</span><span id="line-278"></span><span>        </span><span id="local-6989586621684533605"><span class="annot"><span class="annottext">iterations :: TExp Int64
</span><a href="#local-6989586621684533605"><span class="hs-identifier hs-var hs-var">iterations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; TExp Int64) -&gt; [TExp Int64] -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533610"><span class="hs-identifier hs-var">ns_red</span></a></span><span> </span><span class="hs-comment">-- The segmented reduction is sequential over the inner most dimension</span><span>
</span><span id="line-279"></span><span>        </span><span id="local-6989586621684533604"><span class="annot"><span class="annottext">scheduler_info :: SchedulerInfo
</span><a href="#local-6989586621684533604"><span class="hs-identifier hs-var hs-var">scheduler_info</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Exp -&gt; Scheduling -&gt; SchedulerInfo
</span><a href="Futhark.CodeGen.ImpCode.Multicore.html#SchedulerInfo"><span class="hs-identifier hs-var">Imp.SchedulerInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684533619"><span class="hs-identifier hs-var">nsubtasks_red</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684533605"><span class="hs-identifier hs-var">iterations</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scheduling
</span><a href="Futhark.CodeGen.ImpCode.Multicore.html#Static"><span class="hs-identifier hs-var">Imp.Static</span></a></span><span>
</span><span id="line-280"></span><span>        </span><span id="local-6989586621684533600"><span class="annot"><span class="annottext">red_task :: ParallelTask
</span><a href="#local-6989586621684533600"><span class="hs-identifier hs-var hs-var">red_task</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code -&gt; VName -&gt; ParallelTask
</span><a href="Futhark.CodeGen.ImpCode.Multicore.html#ParallelTask"><span class="hs-identifier hs-var">Imp.ParallelTask</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533616"><span class="hs-identifier hs-var">red_code</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; ParallelTask) -&gt; VName -&gt; ParallelTask
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533711"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-281"></span><span>    </span><span id="local-6989586621684533598"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684533598"><span class="hs-identifier hs-var">free_params_red</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Code -&gt; [VName] -&gt; MulticoreGen [Param]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#freeParams"><span class="hs-identifier hs-var">freeParams</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533616"><span class="hs-identifier hs-var">red_code</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533711"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684533619"><span class="hs-identifier hs-var">nsubtasks_red</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-282"></span><span>    </span><span class="annot"><span class="annottext">Code -&gt; ImpM MCMem HostEnv Multicore ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Code -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Multicore -&gt; Code
forall a. a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Op"><span class="hs-identifier hs-var">Imp.Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Multicore -&gt; Code) -&gt; Multicore -&gt; Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; [Param]
-&gt; ParallelTask
-&gt; Maybe ParallelTask
-&gt; [Param]
-&gt; SchedulerInfo
-&gt; Multicore
</span><a href="Futhark.CodeGen.ImpCode.Multicore.html#Segop"><span class="hs-identifier hs-var">Imp.Segop</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;seghist_red&quot;</span></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684533598"><span class="hs-identifier hs-var">free_params_red</span></a></span><span> </span><span class="annot"><span class="annottext">ParallelTask
</span><a href="#local-6989586621684533600"><span class="hs-identifier hs-var">red_task</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ParallelTask
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">[Param]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">SchedulerInfo
</span><a href="#local-6989586621684533604"><span class="hs-identifier hs-var">scheduler_info</span></a></span><span>
</span><span id="line-283"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-284"></span><span>    </span><span id="local-6989586621684533623"><span class="annot"><span class="annottext">segment_dims :: [(VName, SubExp)]
</span><a href="#local-6989586621684533623"><span class="hs-identifier hs-var hs-var">segment_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; [(VName, SubExp)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; [(VName, SubExp)])
-&gt; [(VName, SubExp)] -&gt; [(VName, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533711"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-285"></span><span>
</span><span id="line-286"></span><span class="hs-comment">-- This implementation for a Segmented Hist only</span><span>
</span><span id="line-287"></span><span class="hs-comment">-- parallelize over the segments,</span><span>
</span><span id="line-288"></span><span class="hs-comment">-- where each segment is updated sequentially.</span><span>
</span><span id="line-289"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#segmentedHist"><span class="hs-identifier hs-type">segmentedHist</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-290"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-291"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-292"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-293"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-294"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span>
</span><span id="line-295"></span><span id="segmentedHist"><span class="annot"><span class="annottext">segmentedHist :: Pat MCMem
-&gt; SegSpace
-&gt; [HistOp MCMem]
-&gt; KernelBody MCMem
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#segmentedHist"><span class="hs-identifier hs-var hs-var">segmentedHist</span></a></span></span><span> </span><span id="local-6989586621684533596"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684533596"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684533595"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533595"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684533594"><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533594"><span class="hs-identifier hs-var">histops</span></a></span></span><span> </span><span id="local-6989586621684533593"><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533593"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-296"></span><span>  </span><span class="annot"><span class="annottext">Code -&gt; ImpM MCMem HostEnv Multicore ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Code -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Maybe Exp -&gt; Code
forall a. String -&gt; Maybe Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DebugPrint"><span class="hs-identifier hs-var">Imp.DebugPrint</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Segmented segHist&quot;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-297"></span><span>  </span><span class="hs-comment">-- Iteration variable over the segments</span><span>
</span><span id="line-298"></span><span>  </span><span id="local-6989586621684533592"><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533592"><span class="hs-identifier hs-var">segments_i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int64)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segment_iter&quot;</span></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int64))
-&gt; PrimType -&gt; ImpM MCMem HostEnv Multicore (TV Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-299"></span><span>  </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code)
-&gt; ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-300"></span><span>    </span><span id="local-6989586621684533590"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533590"><span class="hs-identifier hs-var">par_body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TExp Int64
-&gt; Pat MCMem
-&gt; SegSpace
-&gt; [HistOp MCMem]
-&gt; KernelBody MCMem
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#compileSegHistBody"><span class="hs-identifier hs-var">compileSegHistBody</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; TExp Int64
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533592"><span class="hs-identifier hs-var">segments_i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684533596"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533595"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533594"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533593"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-301"></span><span>    </span><span id="local-6989586621684533588"><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684533588"><span class="hs-identifier hs-var">free_params</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Code -&gt; [VName] -&gt; MulticoreGen [Param]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#freeParams"><span class="hs-identifier hs-var">freeParams</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533590"><span class="hs-identifier hs-var">par_body</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533595"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533592"><span class="hs-identifier hs-var">segments_i</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684533587"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533587"><span class="hs-identifier hs-var">body_allocs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533586"><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533586"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Code -&gt; (Code, Code)
</span><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#extractAllocations"><span class="hs-identifier hs-var">extractAllocations</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533590"><span class="hs-identifier hs-var">par_body</span></a></span><span>
</span><span id="line-303"></span><span>    </span><span class="annot"><span class="annottext">Code -&gt; ImpM MCMem HostEnv Multicore ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; Code -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Multicore -&gt; Code
forall a. a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Op"><span class="hs-identifier hs-var">Imp.Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Multicore -&gt; Code) -&gt; Multicore -&gt; Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; VName -&gt; Code -&gt; Code -&gt; Code -&gt; [Param] -&gt; VName -&gt; Multicore
</span><a href="Futhark.CodeGen.ImpCode.Multicore.html#ParLoop"><span class="hs-identifier hs-var">Imp.ParLoop</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segmented_hist&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int64 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int64
</span><a href="#local-6989586621684533592"><span class="hs-identifier hs-var">segments_i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533587"><span class="hs-identifier hs-var">body_allocs</span></a></span><span> </span><span class="annot"><span class="annottext">Code
</span><a href="#local-6989586621684533586"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">Code
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684533588"><span class="hs-identifier hs-var">free_params</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Multicore) -&gt; VName -&gt; Multicore
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; VName
</span><a href="Futhark.IR.SegOp.html#segFlat"><span class="hs-identifier hs-var hs-var">segFlat</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533595"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-304"></span><span>
</span><span id="line-305"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#compileSegHistBody"><span class="hs-identifier hs-type">compileSegHistBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-306"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int64</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-307"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-308"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-309"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-310"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MCMem.html#MCMem"><span class="hs-identifier hs-type">MCMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.Multicore.Base.html#MulticoreGen"><span class="hs-identifier hs-type">MulticoreGen</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.Multicore.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span>
</span><span id="line-312"></span><span id="compileSegHistBody"><span class="annot"><span class="annottext">compileSegHistBody :: TExp Int64
-&gt; Pat MCMem
-&gt; SegSpace
-&gt; [HistOp MCMem]
-&gt; KernelBody MCMem
-&gt; MulticoreGen Code
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#compileSegHistBody"><span class="hs-identifier hs-var hs-var">compileSegHistBody</span></a></span></span><span> </span><span id="local-6989586621684533585"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684533585"><span class="hs-identifier hs-var">idx</span></a></span></span><span> </span><span id="local-6989586621684533584"><span class="annot"><span class="annottext">Pat MCMem
</span><a href="#local-6989586621684533584"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684533583"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533583"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684533582"><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533582"><span class="hs-identifier hs-var">histops</span></a></span></span><span> </span><span id="local-6989586621684533581"><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533581"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-313"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684533580"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533580"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533579"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533579"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SubExp)] -&gt; ([VName], [SubExp]))
-&gt; [(VName, SubExp)] -&gt; ([VName], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SegSpace -&gt; [(VName, SubExp)]
</span><a href="Futhark.IR.SegOp.html#unSegSpace"><span class="hs-identifier hs-var hs-var">unSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684533583"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-314"></span><span>      </span><span id="local-6989586621684533577"><span class="annot"><span class="annottext">ns_64 :: [TExp Int64]
</span><a href="#local-6989586621684533577"><span class="hs-identifier hs-var hs-var">ns_64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533579"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533571"><span class="annot"><span class="annottext">num_red_res :: Int
</span><a href="#local-6989586621684533571"><span class="hs-identifier hs-var hs-var">num_red_res</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533582"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">[Int] -&gt; Int
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HistOp MCMem -&gt; Int) -&gt; [HistOp MCMem] -&gt; [Int]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; Int)
-&gt; (HistOp MCMem -&gt; [SubExp]) -&gt; HistOp MCMem -&gt; Int
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">HistOp MCMem -&gt; [SubExp]
forall rep. HistOp rep -&gt; [SubExp]
</span><a href="Futhark.IR.SegOp.html#histNeutral"><span class="hs-identifier hs-var hs-var">histNeutral</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533582"><span class="hs-identifier hs-var">histops</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-317"></span><span>      </span><span id="local-6989586621684533570"><span class="annot"><span class="annottext">map_pes :: [PatElemT LParamMem]
</span><a href="#local-6989586621684533570"><span class="hs-identifier hs-var hs-var">map_pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [PatElemT LParamMem] -&gt; [PatElemT LParamMem]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684533571"><span class="hs-identifier hs-var">num_red_res</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [PatElemT LParamMem])
-&gt; [PatElemT LParamMem] -&gt; [PatElemT LParamMem]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
PatT LParamMem
</span><a href="#local-6989586621684533584"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-318"></span><span>      </span><span id="local-6989586621684533569"><span class="annot"><span class="annottext">per_red_pes :: [[PatElemT LParamMem]]
</span><a href="#local-6989586621684533569"><span class="hs-identifier hs-var hs-var">per_red_pes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem] -&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall rep a. [HistOp rep] -&gt; [a] -&gt; [[a]]
</span><a href="Futhark.CodeGen.ImpGen.Multicore.SegHist.html#segHistOpChunks"><span class="hs-identifier hs-var">segHistOpChunks</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533582"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">([PatElemT LParamMem] -&gt; [[PatElemT LParamMem]])
-&gt; [PatElemT LParamMem] -&gt; [[PatElemT LParamMem]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatT LParamMem -&gt; [PatElemT LParamMem]
forall dec. PatT dec -&gt; [PatElemT dec]
</span><a href="Futhark.IR.Syntax.html#patElems"><span class="hs-identifier hs-var hs-var">patElems</span></a></span><span> </span><span class="annot"><span class="annottext">Pat MCMem
PatT LParamMem
</span><a href="#local-6989586621684533584"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-319"></span><span>
</span><span id="line-320"></span><span>  </span><span class="annot"><span class="annottext">ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code)
-&gt; ImpM MCMem HostEnv Multicore () -&gt; MulticoreGen Code
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-321"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684533568"><span class="annot"><span class="annottext">inner_bound :: TExp Int64
</span><a href="#local-6989586621684533568"><span class="hs-identifier hs-var hs-var">inner_bound</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533577"><span class="hs-identifier hs-var">ns_64</span></a></span><span>
</span><span id="line-322"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; TExp Int64
-&gt; (TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op.
String
-&gt; TExp t -&gt; (TExp t -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sFor"><span class="hs-identifier hs-var">sFor</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;i&quot;</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684533568"><span class="hs-identifier hs-var">inner_bound</span></a></span><span> </span><span class="annot"><span class="annottext">((TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; (TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684533565"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684533565"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-323"></span><span>      </span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [VName] -&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall (m :: * -&gt; *) a b c.
Applicative m =&gt;
(a -&gt; b -&gt; m c) -&gt; [a] -&gt; [b] -&gt; m ()
</span><span class="hs-identifier hs-var">zipWithM_</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533580"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64 -&gt; [TExp Int64]
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533577"><span class="hs-identifier hs-var">ns_64</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684533585"><span class="hs-identifier hs-var">idx</span></a></span><span>
</span><span id="line-324"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64 -&gt; ImpM MCMem HostEnv Multicore ()
forall t rep r op. VName -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dPrimV_"><span class="hs-identifier hs-var">dPrimV_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; VName
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533580"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684533565"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-325"></span><span>
</span><span id="line-326"></span><span>      </span><span class="annot"><span class="annottext">Names
-&gt; Stms MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; Stms MCMem
forall rep. KernelBody rep -&gt; Stms rep
</span><a href="Futhark.IR.SegOp.html#kernelBodyStms"><span class="hs-identifier hs-var hs-var">kernelBodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533581"><span class="hs-identifier hs-var">kbody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-327"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684533563"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533563"><span class="hs-identifier hs-var">red_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533562"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533562"><span class="hs-identifier hs-var">map_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-328"></span><span>              </span><span class="annot"><span class="annottext">Int -&gt; [SubExp] -&gt; ([SubExp], [SubExp])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><a href="Futhark.Util.html#splitFromEnd"><span class="hs-identifier hs-var">splitFromEnd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533570"><span class="hs-identifier hs-var">map_pes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; ([SubExp], [SubExp]))
-&gt; [SubExp] -&gt; ([SubExp], [SubExp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-329"></span><span>                </span><span class="annot"><span class="annottext">(KernelResult -&gt; SubExp) -&gt; [KernelResult] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">KernelResult -&gt; SubExp
</span><a href="Futhark.IR.SegOp.html#kernelResultSubExp"><span class="hs-identifier hs-var">kernelResultSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; [SubExp]) -&gt; [KernelResult] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem -&gt; [KernelResult]
forall rep. KernelBody rep -&gt; [KernelResult]
</span><a href="Futhark.IR.SegOp.html#kernelBodyResult"><span class="hs-identifier hs-var hs-var">kernelBodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MCMem
</span><a href="#local-6989586621684533581"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-330"></span><span>        </span><span class="annot"><span class="annottext">[([PatElemT LParamMem], HistOp MCMem, ([SubExp], [SubExp]))]
-&gt; (([PatElemT LParamMem], HistOp MCMem, ([SubExp], [SubExp]))
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
-&gt; [HistOp MCMem]
-&gt; [([SubExp], [SubExp])]
-&gt; [([PatElemT LParamMem], HistOp MCMem, ([SubExp], [SubExp]))]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[[PatElemT LParamMem]]
</span><a href="#local-6989586621684533569"><span class="hs-identifier hs-var">per_red_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533582"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[HistOp MCMem] -&gt; [SubExp] -&gt; [([SubExp], [SubExp])]
forall rep. [HistOp rep] -&gt; [SubExp] -&gt; [([SubExp], [SubExp])]
</span><a href="Futhark.IR.SegOp.html#splitHistResults"><span class="hs-identifier hs-var">splitHistResults</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MCMem]
</span><a href="#local-6989586621684533582"><span class="hs-identifier hs-var">histops</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533563"><span class="hs-identifier hs-var">red_res</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((([PatElemT LParamMem], HistOp MCMem, ([SubExp], [SubExp]))
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; (([PatElemT LParamMem], HistOp MCMem, ([SubExp], [SubExp]))
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-331"></span><span>          </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684533561"><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533561"><span class="hs-identifier hs-var">red_pes</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">HistOp</span></a></span><span> </span><span id="local-6989586621684533560"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684533560"><span class="hs-identifier hs-var">dest_shape</span></a></span></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684533559"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684533559"><span class="hs-identifier hs-var">shape</span></a></span></span><span> </span><span id="local-6989586621684533558"><span class="annot"><span class="annottext">Lambda MCMem
</span><a href="#local-6989586621684533558"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684533557"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533557"><span class="hs-identifier hs-var">bucket</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533556"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533556"><span class="hs-identifier hs-var">vs'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-332"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684533554"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684533554"><span class="hs-identifier hs-var">is_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533553"><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684533553"><span class="hs-identifier hs-var">vs_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533556"><span class="hs-identifier hs-var">vs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem]))
-&gt; [Param LParamMem] -&gt; ([Param LParamMem], [Param LParamMem])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem -&gt; [LParam MCMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem
</span><a href="#local-6989586621684533558"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-333"></span><span>                </span><span id="local-6989586621684533551"><span class="annot"><span class="annottext">bucket' :: [TExp Int64]
</span><a href="#local-6989586621684533551"><span class="hs-identifier hs-var hs-var">bucket'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533557"><span class="hs-identifier hs-var">bucket</span></a></span><span>
</span><span id="line-334"></span><span>                </span><span id="local-6989586621684533549"><span class="annot"><span class="annottext">dest_shape' :: [TExp Int64]
</span><a href="#local-6989586621684533549"><span class="hs-identifier hs-var hs-var">dest_shape'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; TExp Int64) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [TExp Int64]) -&gt; [SubExp] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Shape -&gt; [SubExp]
forall d. ShapeBase d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684533560"><span class="hs-identifier hs-var">dest_shape</span></a></span><span>
</span><span id="line-335"></span><span>                </span><span id="local-6989586621684533548"><span class="annot"><span class="annottext">bucket_in_bounds :: TPrimExp Bool VName
</span><a href="#local-6989586621684533548"><span class="hs-identifier hs-var hs-var">bucket_in_bounds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Slice (TExp Int64) -&gt; [TExp Int64] -&gt; TPrimExp Bool VName
</span><a href="Futhark.CodeGen.ImpGen.html#inBounds"><span class="hs-identifier hs-var">inBounds</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex (TExp Int64)] -&gt; Slice (TExp Int64)
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TExp Int64 -&gt; DimIndex (TExp Int64))
-&gt; [TExp Int64] -&gt; [DimIndex (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; DimIndex (TExp Int64)
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533551"><span class="hs-identifier hs-var">bucket'</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533549"><span class="hs-identifier hs-var">dest_shape'</span></a></span><span>
</span><span id="line-336"></span><span>
</span><span id="line-337"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;save map-out results&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-338"></span><span>              </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, SubExp)]
-&gt; ((PatElemT LParamMem, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; [SubExp] -&gt; [(PatElemT LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533570"><span class="hs-identifier hs-var">map_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533562"><span class="hs-identifier hs-var">map_res</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((PatElemT LParamMem, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684533547"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684533547"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533546"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533546"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-339"></span><span>                </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684533547"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533580"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533546"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-340"></span><span>
</span><span id="line-341"></span><span>            </span><span class="annot"><span class="annottext">String
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op. String -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sComment"><span class="hs-identifier hs-var">sComment</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;perform updates&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-342"></span><span>              </span><span class="annot"><span class="annottext">TPrimExp Bool VName
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
TPrimExp Bool VName -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sWhen"><span class="hs-identifier hs-var">sWhen</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Bool VName
</span><a href="#local-6989586621684533548"><span class="hs-identifier hs-var">bucket_in_bounds</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-343"></span><span>                </span><span class="annot"><span class="annottext">[LParam MCMem] -&gt; ImpM MCMem HostEnv Multicore ()
forall rep inner r op.
Mem rep inner =&gt;
[LParam rep] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#dLParams"><span class="hs-identifier hs-var">dLParams</span></a></span><span> </span><span class="annot"><span class="annottext">([LParam MCMem] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; [LParam MCMem] -&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem -&gt; [LParam MCMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem
</span><a href="#local-6989586621684533558"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-344"></span><span>                </span><span class="annot"><span class="annottext">Shape
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Shape -&gt; ([TExp Int64] -&gt; ImpM rep r op ()) -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sLoopNest"><span class="hs-identifier hs-var">sLoopNest</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684533559"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">(([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ([TExp Int64] -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684533545"><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533545"><span class="hs-identifier hs-var">vec_is</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-345"></span><span>                  </span><span class="hs-comment">-- Index</span><span>
</span><span id="line-346"></span><span>                  </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, Param LParamMem)]
-&gt; ((PatElemT LParamMem, Param LParamMem)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem]
-&gt; [Param LParamMem] -&gt; [(PatElemT LParamMem, Param LParamMem)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533561"><span class="hs-identifier hs-var">red_pes</span></a></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684533554"><span class="hs-identifier hs-var">is_params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, Param LParamMem)
  -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((PatElemT LParamMem, Param LParamMem)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684533544"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684533544"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533543"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684533543"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-347"></span><span>                    </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span>
</span><span id="line-348"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684533543"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-349"></span><span>                      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-350"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684533544"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>                      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533580"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533551"><span class="hs-identifier hs-var">bucket'</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533545"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-352"></span><span>                  </span><span class="hs-comment">-- Value at index</span><span>
</span><span id="line-353"></span><span>                  </span><span class="annot"><span class="annottext">[(Param LParamMem, SubExp)]
-&gt; ((Param LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param LParamMem] -&gt; [SubExp] -&gt; [(Param LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param LParamMem]
</span><a href="#local-6989586621684533553"><span class="hs-identifier hs-var">vs_params</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684533556"><span class="hs-identifier hs-var">vs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((Param LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684533542"><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684533542"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533541"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533541"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-354"></span><span>                    </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param LParamMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param LParamMem
</span><a href="#local-6989586621684533542"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533541"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533545"><span class="hs-identifier hs-var">vec_is</span></a></span><span>
</span><span id="line-355"></span><span>                  </span><span class="annot"><span class="annottext">Names
-&gt; Stms MCMem
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileStms"><span class="hs-identifier hs-var">compileStms</span></a></span><span> </span><span class="annot"><span class="annottext">Names
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body MCMem -&gt; Stms MCMem
forall rep. BodyT rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#bodyStms"><span class="hs-identifier hs-var hs-var">bodyStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; Stms MCMem) -&gt; Body MCMem -&gt; Stms MCMem
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem -&gt; Body MCMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem
</span><a href="#local-6989586621684533558"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ImpM MCMem HostEnv Multicore ()
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-356"></span><span>                    </span><span class="annot"><span class="annottext">[(PatElemT LParamMem, SubExp)]
-&gt; ((PatElemT LParamMem, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT LParamMem] -&gt; [SubExp] -&gt; [(PatElemT LParamMem, SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PatElemT LParamMem]
</span><a href="#local-6989586621684533561"><span class="hs-identifier hs-var">red_pes</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExp] -&gt; [(PatElemT LParamMem, SubExp)])
-&gt; [SubExp] -&gt; [(PatElemT LParamMem, SubExp)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; SubExp) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; [SubExp]) -&gt; [SubExpRes] -&gt; [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body MCMem -&gt; [SubExpRes]
forall rep. BodyT rep -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#bodyResult"><span class="hs-identifier hs-var hs-var">bodyResult</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MCMem -&gt; [SubExpRes]) -&gt; Body MCMem -&gt; [SubExpRes]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem -&gt; Body MCMem
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda MCMem
</span><a href="#local-6989586621684533558"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((PatElemT LParamMem, SubExp) -&gt; ImpM MCMem HostEnv Multicore ())
 -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ((PatElemT LParamMem, SubExp)
    -&gt; ImpM MCMem HostEnv Multicore ())
-&gt; ImpM MCMem HostEnv Multicore ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-357"></span><span>                      </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684533539"><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684533539"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684533538"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533538"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-358"></span><span>                        </span><span class="annot"><span class="annottext">VName
-&gt; [TExp Int64]
-&gt; SubExp
-&gt; [TExp Int64]
-&gt; ImpM MCMem HostEnv Multicore ()
forall rep r op.
VName -&gt; [TExp Int64] -&gt; SubExp -&gt; [TExp Int64] -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#copyDWIMFix"><span class="hs-identifier hs-var">copyDWIMFix</span></a></span><span>
</span><span id="line-359"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LParamMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT LParamMem
</span><a href="#local-6989586621684533539"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-360"></span><span>                          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; TExp Int64) -&gt; [VName] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TExp Int64
forall a. a -&gt; TPrimExp Int64 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le64"><span class="hs-identifier hs-var">Imp.le64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; [VName]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">init</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684533580"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533551"><span class="hs-identifier hs-var">bucket'</span></a></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; [TExp Int64] -&gt; [TExp Int64]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64]
</span><a href="#local-6989586621684533545"><span class="hs-identifier hs-var">vec_is</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-361"></span><span>                          </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684533538"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-362"></span><span>                          </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-363"></span></pre></body></html>