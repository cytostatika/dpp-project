<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-comment">-- | Compile a 'GPUMem' program to imperative code with kernels.</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- This is mostly (but not entirely) the same process no matter if we</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- are targeting OpenCL or CUDA.  The important distinctions (the host</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- level code) are introduced later.</span><span>
</span><span id="line-10"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.CodeGen.ImpGen.GPU</span><span>
</span><span id="line-11"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#compileProgOpenCL"><span class="hs-identifier">compileProgOpenCL</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#compileProgCUDA"><span class="hs-identifier">compileProgCUDA</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Language.Futhark.Warnings.html#Warnings"><span class="hs-identifier">Warnings</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">where</span><span>
</span><span id="line-16"></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Except</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">second</span></span><span class="hs-special">)</span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">foldl'</span></span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html"><span class="hs-identifier">Futhark.CodeGen.ImpCode.GPU</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#bytes"><span class="hs-identifier">bytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html"><span class="hs-identifier">Futhark.CodeGen.ImpCode.GPU</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Imp</span></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#compileProg"><span class="hs-identifier">compileProg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen</span></a></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.GPU.Base</span></a></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegHist.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.GPU.SegHist</span></a></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegMap.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.GPU.SegMap</span></a></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.GPU.SegRed</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.GPU.SegScan</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Transpose.html"><span class="hs-identifier">Futhark.CodeGen.ImpGen.GPU.Transpose</span></a></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.CodeGen.SetDefaultSpace.html"><span class="hs-identifier">Futhark.CodeGen.SetDefaultSpace</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Error.html"><span class="hs-identifier">Futhark.Error</span></a></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html"><span class="hs-identifier">Futhark.IR.GPUMem</span></a></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html"><span class="hs-identifier">Futhark.IR.Mem.IxFun</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">IxFun</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html"><span class="hs-identifier">Futhark.MonadFreshNames</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html"><span class="hs-identifier">Futhark.Util.IntegralExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier">IntegralExp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-identifier">divUp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-identifier">quot</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-identifier">rem</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">quot</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">rem</span></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#callKernelOperations"><span class="hs-identifier hs-type">callKernelOperations</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-type">Operations</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#HostEnv"><span class="hs-identifier hs-type">HostEnv</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#HostOp"><span class="hs-identifier hs-type">Imp.HostOp</span></a></span><span>
</span><span id="line-41"></span><span id="callKernelOperations"><span class="annot"><span class="annottext">callKernelOperations :: Operations GPUMem HostEnv HostOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#callKernelOperations"><span class="hs-identifier hs-var hs-var">callKernelOperations</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-42"></span><span>  </span><span class="annot"><span class="annottext">Operations :: forall rep r op.
ExpCompiler rep r op
-&gt; OpCompiler rep r op
-&gt; StmsCompiler rep r op
-&gt; CopyCompiler rep r op
-&gt; Map Space (AllocCompiler rep r op)
-&gt; Operations rep r op
</span><a href="Futhark.CodeGen.ImpGen.html#Operations"><span class="hs-identifier hs-type">Operations</span></a></span><span>
</span><span id="line-43"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">opsExpCompiler :: ExpCompiler GPUMem HostEnv HostOp
</span><a href="Futhark.CodeGen.ImpGen.html#opsExpCompiler"><span class="hs-identifier hs-var">opsExpCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ExpCompiler GPUMem HostEnv HostOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#expCompiler"><span class="hs-identifier hs-var">expCompiler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>      </span><span class="annot"><span class="annottext">opsCopyCompiler :: CopyCompiler GPUMem HostEnv HostOp
</span><a href="Futhark.CodeGen.ImpGen.html#opsCopyCompiler"><span class="hs-identifier hs-var">opsCopyCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CopyCompiler GPUMem HostEnv HostOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#callKernelCopy"><span class="hs-identifier hs-var">callKernelCopy</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>      </span><span class="annot"><span class="annottext">opsOpCompiler :: OpCompiler GPUMem HostEnv HostOp
</span><a href="Futhark.CodeGen.ImpGen.html#opsOpCompiler"><span class="hs-identifier hs-var">opsOpCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">OpCompiler GPUMem HostEnv HostOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#opCompiler"><span class="hs-identifier hs-var">opCompiler</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span>      </span><span class="annot"><span class="annottext">opsStmsCompiler :: StmsCompiler GPUMem HostEnv HostOp
</span><a href="Futhark.CodeGen.ImpGen.html#opsStmsCompiler"><span class="hs-identifier hs-var">opsStmsCompiler</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StmsCompiler GPUMem HostEnv HostOp
forall rep inner op r.
(Mem rep inner, FreeIn op) =&gt;
Names -&gt; Stms rep -&gt; ImpM rep r op () -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#defCompileStms"><span class="hs-identifier hs-var">defCompileStms</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>      </span><span class="annot"><span class="annottext">opsAllocCompilers :: Map Space (AllocCompiler GPUMem HostEnv HostOp)
</span><a href="Futhark.CodeGen.ImpGen.html#opsAllocCompilers"><span class="hs-identifier hs-var">opsAllocCompilers</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Space (AllocCompiler GPUMem HostEnv HostOp)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-48"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-49"></span><span>
</span><span id="line-50"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#openclAtomics"><span class="hs-identifier hs-type">openclAtomics</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#cudaAtomics"><span class="hs-identifier hs-type">cudaAtomics</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicBinOp"><span class="hs-identifier hs-type">AtomicBinOp</span></a></span><span>
</span><span id="line-51"></span><span class="hs-special">(</span><span id="openclAtomics"><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#openclAtomics"><span class="hs-identifier hs-var">openclAtomics</span></a></span></span><span class="hs-special">,</span><span> </span><span id="cudaAtomics"><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#cudaAtomics"><span class="hs-identifier hs-var">cudaAtomics</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(BinOp
 -&gt; [(BinOp,
      VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
 -&gt; Maybe
      (VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp))
-&gt; [(BinOp,
     VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
-&gt; AtomicBinOp
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">BinOp
-&gt; [(BinOp,
     VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
-&gt; Maybe
     (VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)
forall a b. Eq a =&gt; a -&gt; [(a, b)] -&gt; Maybe b
</span><span class="hs-identifier hs-var">lookup</span></span><span> </span><span class="annot"><span class="annottext">[(BinOp,
  VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
</span><a href="#local-6989586621684545357"><span class="hs-identifier hs-var">opencl</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(BinOp
 -&gt; [(BinOp,
      VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
 -&gt; Maybe
      (VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp))
-&gt; [(BinOp,
     VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
-&gt; AtomicBinOp
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">BinOp
-&gt; [(BinOp,
     VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
-&gt; Maybe
     (VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)
forall a b. Eq a =&gt; a -&gt; [(a, b)] -&gt; Maybe b
</span><span class="hs-identifier hs-var">lookup</span></span><span> </span><span class="annot"><span class="annottext">[(BinOp,
  VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
</span><a href="#local-6989586621684545356"><span class="hs-identifier hs-var">cuda</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-53"></span><span>    </span><span id="local-6989586621684545355"><span class="annot"><span class="annottext">opencl64 :: [(BinOp,
  VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
</span><a href="#local-6989586621684545355"><span class="hs-identifier hs-var hs-var">opencl64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-54"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Add"><span class="hs-identifier hs-var">Add</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicAdd"><span class="hs-identifier hs-var">Imp.AtomicAdd</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-55"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SMax"><span class="hs-identifier hs-var">SMax</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicSMax"><span class="hs-identifier hs-var">Imp.AtomicSMax</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SMin"><span class="hs-identifier hs-var">SMin</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicSMin"><span class="hs-identifier hs-var">Imp.AtomicSMin</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#UMax"><span class="hs-identifier hs-var">UMax</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicUMax"><span class="hs-identifier hs-var">Imp.AtomicUMax</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-58"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#UMin"><span class="hs-identifier hs-var">UMin</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicUMin"><span class="hs-identifier hs-var">Imp.AtomicUMin</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-59"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#And"><span class="hs-identifier hs-var">And</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicAnd"><span class="hs-identifier hs-var">Imp.AtomicAnd</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-60"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Or"><span class="hs-identifier hs-var">Or</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicOr"><span class="hs-identifier hs-var">Imp.AtomicOr</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Xor"><span class="hs-identifier hs-var">Xor</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicXor"><span class="hs-identifier hs-var">Imp.AtomicXor</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-62"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-63"></span><span>    </span><span id="local-6989586621684545336"><span class="annot"><span class="annottext">opencl32 :: [(BinOp,
  VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
</span><a href="#local-6989586621684545336"><span class="hs-identifier hs-var hs-var">opencl32</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-64"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; Overflow -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Add"><span class="hs-identifier hs-var">Add</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span> </span><span class="annot"><span class="annottext">Overflow
</span><a href="Futhark.IR.Primitive.html#OverflowUndef"><span class="hs-identifier hs-var">OverflowUndef</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicAdd"><span class="hs-identifier hs-var">Imp.AtomicAdd</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-65"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SMax"><span class="hs-identifier hs-var">SMax</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicSMax"><span class="hs-identifier hs-var">Imp.AtomicSMax</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-66"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#SMin"><span class="hs-identifier hs-var">SMin</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicSMin"><span class="hs-identifier hs-var">Imp.AtomicSMin</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-67"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#UMax"><span class="hs-identifier hs-var">UMax</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicUMax"><span class="hs-identifier hs-var">Imp.AtomicUMax</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-68"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#UMin"><span class="hs-identifier hs-var">UMin</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicUMin"><span class="hs-identifier hs-var">Imp.AtomicUMin</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-69"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#And"><span class="hs-identifier hs-var">And</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicAnd"><span class="hs-identifier hs-var">Imp.AtomicAnd</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-70"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Or"><span class="hs-identifier hs-var">Or</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicOr"><span class="hs-identifier hs-var">Imp.AtomicOr</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-71"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#Xor"><span class="hs-identifier hs-var">Xor</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IntType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicXor"><span class="hs-identifier hs-var">Imp.AtomicXor</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-73"></span><span>    </span><span id="local-6989586621684545357"><span class="annot"><span class="annottext">opencl :: [(BinOp,
  VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
</span><a href="#local-6989586621684545357"><span class="hs-identifier hs-var hs-var">opencl</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(BinOp,
  VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
</span><a href="#local-6989586621684545336"><span class="hs-identifier hs-var">opencl32</span></a></span><span> </span><span class="annot"><span class="annottext">[(BinOp,
  VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
-&gt; [(BinOp,
     VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
-&gt; [(BinOp,
     VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[(BinOp,
  VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
</span><a href="#local-6989586621684545355"><span class="hs-identifier hs-var">opencl64</span></a></span><span>
</span><span id="line-74"></span><span>    </span><span id="local-6989586621684545356"><span class="annot"><span class="annottext">cuda :: [(BinOp,
  VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
</span><a href="#local-6989586621684545356"><span class="hs-identifier hs-var hs-var">cuda</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-75"></span><span>      </span><span class="annot"><span class="annottext">[(BinOp,
  VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
</span><a href="#local-6989586621684545357"><span class="hs-identifier hs-var">opencl</span></a></span><span>
</span><span id="line-76"></span><span>        </span><span class="annot"><span class="annottext">[(BinOp,
  VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
-&gt; [(BinOp,
     VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
-&gt; [(BinOp,
     VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#FAdd"><span class="hs-identifier hs-var">FAdd</span></a></span><span> </span><span class="annot"><span class="annottext">FloatType
</span><a href="Futhark.IR.Primitive.html#Float32"><span class="hs-identifier hs-var">Float32</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FloatType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicFAdd"><span class="hs-identifier hs-var">Imp.AtomicFAdd</span></a></span><span> </span><span class="annot"><span class="annottext">FloatType
</span><a href="Futhark.IR.Primitive.html#Float32"><span class="hs-identifier hs-var">Float32</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-77"></span><span>             </span><span class="hs-special">(</span><span class="annot"><span class="annottext">FloatType -&gt; BinOp
</span><a href="Futhark.IR.Primitive.html#FAdd"><span class="hs-identifier hs-var">FAdd</span></a></span><span> </span><span class="annot"><span class="annottext">FloatType
</span><a href="Futhark.IR.Primitive.html#Float64"><span class="hs-identifier hs-var">Float64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">FloatType
-&gt; VName -&gt; VName -&gt; Count Elements (TExp Int64) -&gt; Exp -&gt; AtomicOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#AtomicFAdd"><span class="hs-identifier hs-var">Imp.AtomicFAdd</span></a></span><span> </span><span class="annot"><span class="annottext">FloatType
</span><a href="Futhark.IR.Primitive.html#Float64"><span class="hs-identifier hs-var">Float64</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-78"></span><span>           </span><span class="hs-special">]</span><span>
</span><span id="line-79"></span><span>
</span><span id="line-80"></span><span id="local-6989586621684545775"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#compileProg"><span class="hs-identifier hs-type">compileProg</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-81"></span><span>  </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684545775"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-82"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#HostEnv"><span class="hs-identifier hs-type">HostEnv</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-83"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-84"></span><span>  </span><span class="annot"><a href="#local-6989586621684545775"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Warnings.html#Warnings"><span class="hs-identifier hs-type">Warnings</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#Program"><span class="hs-identifier hs-type">Imp.Program</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-85"></span><span id="compileProg"><span class="annot"><span class="annottext">compileProg :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
HostEnv -&gt; Prog GPUMem -&gt; m (Warnings, Program)
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#compileProg"><span class="hs-identifier hs-var hs-var">compileProg</span></a></span></span><span> </span><span id="local-6989586621684545309"><span class="annot"><span class="annottext">HostEnv
</span><a href="#local-6989586621684545309"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621684545308"><span class="annot"><span class="annottext">Prog GPUMem
</span><a href="#local-6989586621684545308"><span class="hs-identifier hs-var">prog</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-86"></span><span>  </span><span class="annot"><span class="annottext">(Program -&gt; Program) -&gt; (Warnings, Program) -&gt; (Warnings, Program)
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(HostOp -&gt; HostOp) -&gt; Program -&gt; Program
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">HostOp -&gt; HostOp
</span><a href="#local-6989586621684545307"><span class="hs-identifier hs-var">setOpSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(Program -&gt; Program) -&gt; (Program -&gt; Program) -&gt; Program -&gt; Program
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Program -&gt; Program
forall {op}. Definitions op -&gt; Definitions op
</span><a href="#local-6989586621684545305"><span class="hs-identifier hs-var">setDefsSpace</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-87"></span><span>    </span><span class="annot"><span class="annottext">((Warnings, Program) -&gt; (Warnings, Program))
-&gt; m (Warnings, Program) -&gt; m (Warnings, Program)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">HostEnv
-&gt; Operations GPUMem HostEnv HostOp
-&gt; Space
-&gt; Prog GPUMem
-&gt; m (Warnings, Program)
forall rep inner op (m :: * -&gt; *) r.
(Mem rep inner, FreeIn op, MonadFreshNames m) =&gt;
r
-&gt; Operations rep r op
-&gt; Space
-&gt; Prog rep
-&gt; m (Warnings, Definitions op)
</span><a href="Futhark.CodeGen.ImpGen.html#compileProg"><span class="hs-identifier hs-var">Futhark.CodeGen.ImpGen.compileProg</span></a></span><span> </span><span class="annot"><span class="annottext">HostEnv
</span><a href="#local-6989586621684545309"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Operations GPUMem HostEnv HostOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#callKernelOperations"><span class="hs-identifier hs-var">callKernelOperations</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684545303"><span class="hs-identifier hs-var">device_space</span></a></span><span> </span><span class="annot"><span class="annottext">Prog GPUMem
</span><a href="#local-6989586621684545308"><span class="hs-identifier hs-var">prog</span></a></span><span>
</span><span id="line-88"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-89"></span><span>    </span><span id="local-6989586621684545303"><span class="annot"><span class="annottext">device_space :: Space
</span><a href="#local-6989586621684545303"><span class="hs-identifier hs-var hs-var">device_space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Imp.Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;device&quot;</span></span><span>
</span><span id="line-90"></span><span>    </span><span id="local-6989586621684545301"><span class="annot"><span class="annottext">global_space :: Space
</span><a href="#local-6989586621684545301"><span class="hs-identifier hs-var hs-var">global_space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Imp.Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;global&quot;</span></span><span>
</span><span id="line-91"></span><span>    </span><span id="local-6989586621684545305"><span class="annot"><span class="annottext">setDefsSpace :: Definitions op -&gt; Definitions op
</span><a href="#local-6989586621684545305"><span class="hs-identifier hs-var hs-var">setDefsSpace</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Space -&gt; Definitions op -&gt; Definitions op
forall op. Space -&gt; Definitions op -&gt; Definitions op
</span><a href="Futhark.CodeGen.SetDefaultSpace.html#setDefaultSpace"><span class="hs-identifier hs-var">setDefaultSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684545303"><span class="hs-identifier hs-var">device_space</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span id="local-6989586621684545307"><span class="annot"><span class="annottext">setOpSpace :: HostOp -&gt; HostOp
</span><a href="#local-6989586621684545307"><span class="hs-identifier hs-var hs-var">setOpSpace</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#CallKernel"><span class="hs-identifier hs-type">Imp.CallKernel</span></a></span><span> </span><span id="local-6989586621684545298"><span class="annot"><span class="annottext">Kernel
</span><a href="#local-6989586621684545298"><span class="hs-identifier hs-var">kernel</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-93"></span><span>      </span><span class="annot"><span class="annottext">Kernel -&gt; HostOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#CallKernel"><span class="hs-identifier hs-var">Imp.CallKernel</span></a></span><span>
</span><span id="line-94"></span><span>        </span><span class="annot"><span class="annottext">Kernel
</span><a href="#local-6989586621684545298"><span class="hs-identifier hs-var">kernel</span></a></span><span>
</span><span id="line-95"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">kernelBody :: Code KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#kernelBody"><span class="hs-identifier hs-var">Imp.kernelBody</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-96"></span><span>              </span><span class="annot"><span class="annottext">Space -&gt; Code KernelOp -&gt; Code KernelOp
forall op. Space -&gt; Code op -&gt; Code op
</span><a href="Futhark.CodeGen.SetDefaultSpace.html#setDefaultCodeSpace"><span class="hs-identifier hs-var">setDefaultCodeSpace</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684545301"><span class="hs-identifier hs-var">global_space</span></a></span><span> </span><span class="annot"><span class="annottext">(Code KernelOp -&gt; Code KernelOp) -&gt; Code KernelOp -&gt; Code KernelOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Kernel -&gt; Code KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#kernelBody"><span class="hs-identifier hs-var hs-var">Imp.kernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">Kernel
</span><a href="#local-6989586621684545298"><span class="hs-identifier hs-var">kernel</span></a></span><span>
</span><span id="line-97"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><a href="#local-6989586621684545307"><span class="hs-identifier hs-var">setOpSpace</span></a></span><span> </span><span id="local-6989586621684545295"><span class="annot"><span class="annottext">HostOp
</span><a href="#local-6989586621684545295"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostOp
</span><a href="#local-6989586621684545295"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-99"></span><span>
</span><span id="line-100"></span><span class="hs-comment">-- | Compile a 'GPUMem' program to low-level parallel code, with</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- either CUDA or OpenCL characteristics.</span><span>
</span><span id="line-102"></span><span id="local-6989586621684545739"><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#compileProgOpenCL"><span class="hs-identifier hs-type">compileProgOpenCL</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#compileProgCUDA"><span class="hs-identifier hs-type">compileProgCUDA</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684545739"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684545739"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Warnings.html#Warnings"><span class="hs-identifier hs-type">Warnings</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#Program"><span class="hs-identifier hs-type">Imp.Program</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-105"></span><span id="compileProgOpenCL"><span class="annot"><span class="annottext">compileProgOpenCL :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Prog GPUMem -&gt; m (Warnings, Program)
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#compileProgOpenCL"><span class="hs-identifier hs-var hs-var">compileProgOpenCL</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostEnv -&gt; Prog GPUMem -&gt; m (Warnings, Program)
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
HostEnv -&gt; Prog GPUMem -&gt; m (Warnings, Program)
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#compileProg"><span class="hs-identifier hs-var">compileProg</span></a></span><span> </span><span class="annot"><span class="annottext">(HostEnv -&gt; Prog GPUMem -&gt; m (Warnings, Program))
-&gt; HostEnv -&gt; Prog GPUMem -&gt; m (Warnings, Program)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp -&gt; Target -&gt; Map VName Locks -&gt; HostEnv
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#HostEnv"><span class="hs-identifier hs-var">HostEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#openclAtomics"><span class="hs-identifier hs-var">openclAtomics</span></a></span><span> </span><span class="annot"><span class="annottext">Target
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#OpenCL"><span class="hs-identifier hs-var">OpenCL</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Locks
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-106"></span><span id="compileProgCUDA"><span class="annot"><span class="annottext">compileProgCUDA :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Prog GPUMem -&gt; m (Warnings, Program)
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#compileProgCUDA"><span class="hs-identifier hs-var hs-var">compileProgCUDA</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostEnv -&gt; Prog GPUMem -&gt; m (Warnings, Program)
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
HostEnv -&gt; Prog GPUMem -&gt; m (Warnings, Program)
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#compileProg"><span class="hs-identifier hs-var">compileProg</span></a></span><span> </span><span class="annot"><span class="annottext">(HostEnv -&gt; Prog GPUMem -&gt; m (Warnings, Program))
-&gt; HostEnv -&gt; Prog GPUMem -&gt; m (Warnings, Program)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp -&gt; Target -&gt; Map VName Locks -&gt; HostEnv
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#HostEnv"><span class="hs-identifier hs-var">HostEnv</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#cudaAtomics"><span class="hs-identifier hs-var">cudaAtomics</span></a></span><span> </span><span class="annot"><span class="annottext">Target
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CUDA"><span class="hs-identifier hs-var">CUDA</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName Locks
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#opCompiler"><span class="hs-identifier hs-type">opCompiler</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-109"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-110"></span><span>  </span><span class="annot"><a href="Futhark.IR.Rep.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-111"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-112"></span><span id="opCompiler"><span class="annot"><span class="annottext">opCompiler :: OpCompiler GPUMem HostEnv HostOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#opCompiler"><span class="hs-identifier hs-var hs-var">opCompiler</span></a></span></span><span> </span><span id="local-6989586621684545285"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545285"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span id="local-6989586621684545283"><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545283"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684545282"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684545282"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-113"></span><span>  </span><span class="annot"><span class="annottext">Pat GPUMem -&gt; DimSize -&gt; Space -&gt; ImpM GPUMem HostEnv HostOp ()
forall rep inner r op.
Mem rep inner =&gt;
Pat rep -&gt; DimSize -&gt; Space -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileAlloc"><span class="hs-identifier hs-var">compileAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545285"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545283"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684545282"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-114"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#opCompiler"><span class="hs-identifier hs-var">opCompiler</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684545279"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684545279"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SizeOp"><span class="hs-identifier hs-type">SizeOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#GetSize"><span class="hs-identifier hs-type">GetSize</span></a></span><span> </span><span id="local-6989586621684545275"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684545275"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621684545274"><span class="annot"><span class="annottext">SizeClass
</span><a href="#local-6989586621684545274"><span class="hs-identifier hs-var">size_class</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-115"></span><span>  </span><span id="local-6989586621684545273"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684545273"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp (Maybe Name)
forall rep r op. ImpM rep r op (Maybe Name)
</span><a href="Futhark.CodeGen.ImpGen.html#askFunction"><span class="hs-identifier hs-var">askFunction</span></a></span><span>
</span><span id="line-116"></span><span>  </span><span class="annot"><span class="annottext">HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-117"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; Name -&gt; SizeClass -&gt; HostOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#GetSize"><span class="hs-identifier hs-var">Imp.GetSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LetDecMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LetDecMem
</span><a href="#local-6989586621684545279"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Name -&gt; Name -&gt; Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#keyWithEntryPoint"><span class="hs-identifier hs-var">keyWithEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684545273"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684545275"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SizeClass -&gt; HostOp) -&gt; SizeClass -&gt; HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-118"></span><span>      </span><span class="annot"><span class="annottext">Maybe Name -&gt; SizeClass -&gt; SizeClass
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#sizeClassWithEntryPoint"><span class="hs-identifier hs-var">sizeClassWithEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684545273"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="#local-6989586621684545274"><span class="hs-identifier hs-var">size_class</span></a></span><span>
</span><span id="line-119"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#opCompiler"><span class="hs-identifier hs-var">opCompiler</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684545266"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684545266"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SizeOp"><span class="hs-identifier hs-type">SizeOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#CmpSizeLe"><span class="hs-identifier hs-type">CmpSizeLe</span></a></span><span> </span><span id="local-6989586621684545264"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684545264"><span class="hs-identifier hs-var">key</span></a></span></span><span> </span><span id="local-6989586621684545263"><span class="annot"><span class="annottext">SizeClass
</span><a href="#local-6989586621684545263"><span class="hs-identifier hs-var">size_class</span></a></span></span><span> </span><span id="local-6989586621684545262"><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545262"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-120"></span><span>  </span><span id="local-6989586621684545261"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684545261"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp (Maybe Name)
forall rep r op. ImpM rep r op (Maybe Name)
</span><a href="Futhark.CodeGen.ImpGen.html#askFunction"><span class="hs-identifier hs-var">askFunction</span></a></span><span>
</span><span id="line-121"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684545260"><span class="annot"><span class="annottext">size_class' :: SizeClass
</span><a href="#local-6989586621684545260"><span class="hs-identifier hs-var hs-var">size_class'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Name -&gt; SizeClass -&gt; SizeClass
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#sizeClassWithEntryPoint"><span class="hs-identifier hs-var">sizeClassWithEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684545261"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="#local-6989586621684545263"><span class="hs-identifier hs-var">size_class</span></a></span><span>
</span><span id="line-122"></span><span>  </span><span class="annot"><span class="annottext">HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; (Exp -&gt; HostOp) -&gt; Exp -&gt; ImpM GPUMem HostEnv HostOp ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Name -&gt; SizeClass -&gt; Exp -&gt; HostOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#CmpSizeLe"><span class="hs-identifier hs-var">Imp.CmpSizeLe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LetDecMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LetDecMem
</span><a href="#local-6989586621684545266"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Name -&gt; Name -&gt; Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#keyWithEntryPoint"><span class="hs-identifier hs-var">keyWithEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684545261"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684545264"><span class="hs-identifier hs-var">key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="#local-6989586621684545260"><span class="hs-identifier hs-var">size_class'</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><span class="annottext">(Exp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; ImpM GPUMem HostEnv HostOp Exp -&gt; ImpM GPUMem HostEnv HostOp ()
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">DimSize -&gt; ImpM GPUMem HostEnv HostOp Exp
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op Exp
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545262"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-124"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#opCompiler"><span class="hs-identifier hs-var">opCompiler</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684545256"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684545256"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SizeOp"><span class="hs-identifier hs-type">SizeOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#GetSizeMax"><span class="hs-identifier hs-type">GetSizeMax</span></a></span><span> </span><span id="local-6989586621684545254"><span class="annot"><span class="annottext">SizeClass
</span><a href="#local-6989586621684545254"><span class="hs-identifier hs-var">size_class</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-125"></span><span>  </span><span class="annot"><span class="annottext">HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SizeClass -&gt; HostOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#GetSizeMax"><span class="hs-identifier hs-var">Imp.GetSizeMax</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LetDecMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LetDecMem
</span><a href="#local-6989586621684545256"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="#local-6989586621684545254"><span class="hs-identifier hs-var">size_class</span></a></span><span>
</span><span id="line-126"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#opCompiler"><span class="hs-identifier hs-var">opCompiler</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684545252"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684545252"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SizeOp"><span class="hs-identifier hs-type">SizeOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#CalcNumGroups"><span class="hs-identifier hs-type">CalcNumGroups</span></a></span><span> </span><span id="local-6989586621684545250"><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545250"><span class="hs-identifier hs-var">w64</span></a></span></span><span> </span><span id="local-6989586621684545249"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684545249"><span class="hs-identifier hs-var">max_num_groups_key</span></a></span></span><span> </span><span id="local-6989586621684545248"><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545248"><span class="hs-identifier hs-var">group_size</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-127"></span><span>  </span><span id="local-6989586621684545247"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684545247"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp (Maybe Name)
forall rep r op. ImpM rep r op (Maybe Name)
</span><a href="Futhark.CodeGen.ImpGen.html#askFunction"><span class="hs-identifier hs-var">askFunction</span></a></span><span>
</span><span id="line-128"></span><span>  </span><span id="local-6989586621684545246"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684545246"><span class="hs-identifier hs-var">max_num_groups</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem HostEnv HostOp (TV Int32)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;max_num_groups&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-129"></span><span>  </span><span class="annot"><span class="annottext">HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-130"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; Name -&gt; SizeClass -&gt; HostOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#GetSize"><span class="hs-identifier hs-var">Imp.GetSize</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684545246"><span class="hs-identifier hs-var">max_num_groups</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Name -&gt; Name -&gt; Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#keyWithEntryPoint"><span class="hs-identifier hs-var">keyWithEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684545247"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684545249"><span class="hs-identifier hs-var">max_num_groups_key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SizeClass -&gt; HostOp) -&gt; SizeClass -&gt; HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-131"></span><span>      </span><span class="annot"><span class="annottext">Maybe Name -&gt; SizeClass -&gt; SizeClass
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#sizeClassWithEntryPoint"><span class="hs-identifier hs-var">sizeClassWithEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684545247"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="Futhark.IR.GPU.Sizes.html#SizeNumGroups"><span class="hs-identifier hs-var">SizeNumGroups</span></a></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span>  </span><span class="hs-comment">-- If 'w' is small, we launch fewer groups than we normally would.</span><span>
</span><span id="line-134"></span><span>  </span><span class="hs-comment">-- We don't want any idle groups.</span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-comment">--</span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-comment">-- The calculations are done with 64-bit integers to avoid overflow</span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-comment">-- issues.</span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684545241"><span class="annot"><span class="annottext">num_groups_maybe_zero :: TExp Int64
</span><a href="#local-6989586621684545241"><span class="hs-identifier hs-var hs-var">num_groups_maybe_zero</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-139"></span><span>        </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall v. TPrimExp Int64 v -&gt; TPrimExp Int64 v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sMin64"><span class="hs-identifier hs-var">sMin64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DimSize -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545250"><span class="hs-identifier hs-var">w64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#divUp"><span class="hs-operator hs-var">`divUp`</span></a></span><span> </span><span class="annot"><span class="annottext">DimSize -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545248"><span class="hs-identifier hs-var">group_size</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; TExp Int64) -&gt; TExp Int64 -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-140"></span><span>          </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; TPrimExp Int32 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684545246"><span class="hs-identifier hs-var">max_num_groups</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-comment">-- We also don't want zero groups.</span><span>
</span><span id="line-142"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684545236"><span class="annot"><span class="annottext">num_groups :: TExp Int64
</span><a href="#local-6989586621684545236"><span class="hs-identifier hs-var hs-var">num_groups</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Int64
forall v. TPrimExp Int64 v -&gt; TPrimExp Int64 v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sMax64"><span class="hs-identifier hs-var">sMax64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545241"><span class="hs-identifier hs-var">num_groups_maybe_zero</span></a></span><span>
</span><span id="line-143"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; TV Int32
forall t. VName -&gt; PrimType -&gt; TV t
</span><a href="Futhark.CodeGen.ImpGen.html#mkTV"><span class="hs-identifier hs-var">mkTV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LetDecMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LetDecMem
</span><a href="#local-6989586621684545252"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TPrimExp Int32 VName -&gt; ImpM GPUMem HostEnv HostOp ()
forall t rep r op. TV t -&gt; TExp t -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#%3C--"><span class="hs-operator hs-var">&lt;--</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TPrimExp Int32 VName
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int32 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt32"><span class="hs-identifier hs-var">sExt32</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545236"><span class="hs-identifier hs-var">num_groups</span></a></span><span>
</span><span id="line-144"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#opCompiler"><span class="hs-identifier hs-var">opCompiler</span></a></span><span> </span><span id="local-6989586621684545231"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545231"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Inner"><span class="hs-identifier hs-type">Inner</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span id="local-6989586621684545229"><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684545229"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-145"></span><span>  </span><span class="annot"><span class="annottext">Pat GPUMem
-&gt; SegOp SegLevel GPUMem -&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#segOpCompiler"><span class="hs-identifier hs-var">segOpCompiler</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545231"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684545229"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-146"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#opCompiler"><span class="hs-identifier hs-var">opCompiler</span></a></span><span> </span><span id="local-6989586621684545227"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545227"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684545226"><span class="annot"><span class="annottext">Op GPUMem
</span><a href="#local-6989586621684545226"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-147"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp ()
forall a. String -&gt; a
</span><a href="Futhark.Error.html#compilerBugS"><span class="hs-identifier hs-var">compilerBugS</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; String -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;opCompiler: Invalid pattern\n  &quot;</span></span><span>
</span><span id="line-149"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PatT LetDecMem -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LetDecMem
</span><a href="#local-6989586621684545227"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-150"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\nfor expression\n  &quot;</span></span><span>
</span><span id="line-151"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">MemOp (HostOp GPUMem ()) -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Op GPUMem
MemOp (HostOp GPUMem ())
</span><a href="#local-6989586621684545226"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-152"></span><span>
</span><span id="line-153"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#sizeClassWithEntryPoint"><span class="hs-identifier hs-type">sizeClassWithEntryPoint</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#SizeClass"><span class="hs-identifier hs-type">Imp.SizeClass</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#SizeClass"><span class="hs-identifier hs-type">Imp.SizeClass</span></a></span><span>
</span><span id="line-154"></span><span id="sizeClassWithEntryPoint"><span class="annot"><span class="annottext">sizeClassWithEntryPoint :: Maybe Name -&gt; SizeClass -&gt; SizeClass
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#sizeClassWithEntryPoint"><span class="hs-identifier hs-var hs-var">sizeClassWithEntryPoint</span></a></span></span><span> </span><span id="local-6989586621684545223"><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684545223"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Sizes.html#SizeThreshold"><span class="hs-identifier hs-type">Imp.SizeThreshold</span></a></span><span> </span><span id="local-6989586621684545221"><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684545221"><span class="hs-identifier hs-var">path</span></a></span></span><span> </span><span id="local-6989586621684545220"><span class="annot"><span class="annottext">Maybe Int64
</span><a href="#local-6989586621684545220"><span class="hs-identifier hs-var">def</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-155"></span><span>  </span><span class="annot"><span class="annottext">KernelPath -&gt; Maybe Int64 -&gt; SizeClass
</span><a href="Futhark.IR.GPU.Sizes.html#SizeThreshold"><span class="hs-identifier hs-var">Imp.SizeThreshold</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, Bool) -&gt; (Name, Bool)) -&gt; KernelPath -&gt; KernelPath
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, Bool) -&gt; (Name, Bool)
</span><a href="#local-6989586621684545219"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">KernelPath
</span><a href="#local-6989586621684545221"><span class="hs-identifier hs-var">path</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe Int64
</span><a href="#local-6989586621684545220"><span class="hs-identifier hs-var">def</span></a></span><span>
</span><span id="line-156"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-157"></span><span>    </span><span id="local-6989586621684545219"><span class="annot"><span class="annottext">f :: (Name, Bool) -&gt; (Name, Bool)
</span><a href="#local-6989586621684545219"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684545218"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684545218"><span class="hs-identifier hs-var">name</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684545217"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684545217"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Name -&gt; Name -&gt; Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#keyWithEntryPoint"><span class="hs-identifier hs-var">keyWithEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><a href="#local-6989586621684545223"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684545218"><span class="hs-identifier hs-var">name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684545217"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-158"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#sizeClassWithEntryPoint"><span class="hs-identifier hs-var">sizeClassWithEntryPoint</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684545216"><span class="annot"><span class="annottext">SizeClass
</span><a href="#local-6989586621684545216"><span class="hs-identifier hs-var">size_class</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="#local-6989586621684545216"><span class="hs-identifier hs-var">size_class</span></a></span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#segOpCompiler"><span class="hs-identifier hs-type">segOpCompiler</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-161"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-162"></span><span>  </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegLevel"><span class="hs-identifier hs-type">SegLevel</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-163"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-164"></span><span id="segOpCompiler"><span class="annot"><span class="annottext">segOpCompiler :: Pat GPUMem
-&gt; SegOp SegLevel GPUMem -&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#segOpCompiler"><span class="hs-identifier hs-var hs-var">segOpCompiler</span></a></span></span><span> </span><span id="local-6989586621684545215"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545215"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-type">SegMap</span></a></span><span> </span><span id="local-6989586621684545213"><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684545213"><span class="hs-identifier hs-var">lvl</span></a></span></span><span> </span><span id="local-6989586621684545212"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684545212"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase DimSize) NoUniqueness]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684545211"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684545211"><span class="hs-identifier hs-var">kbody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-165"></span><span>  </span><span class="annot"><span class="annottext">Pat GPUMem
-&gt; SegLevel
-&gt; SegSpace
-&gt; KernelBody GPUMem
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegMap.html#compileSegMap"><span class="hs-identifier hs-var">compileSegMap</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545215"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684545213"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684545212"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684545211"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-166"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#segOpCompiler"><span class="hs-identifier hs-var">segOpCompiler</span></a></span><span> </span><span id="local-6989586621684545209"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545209"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegRed"><span class="hs-identifier hs-type">SegRed</span></a></span><span> </span><span id="local-6989586621684545207"><span class="annot"><span class="annottext">lvl :: SegLevel
</span><a href="#local-6989586621684545207"><span class="hs-identifier hs-var">lvl</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegThread"><span class="hs-identifier hs-type">SegThread</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span id="local-6989586621684545205"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684545205"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684545204"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684545204"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase DimSize) NoUniqueness]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684545203"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684545203"><span class="hs-identifier hs-var">kbody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-167"></span><span>  </span><span class="annot"><span class="annottext">Pat GPUMem
-&gt; SegLevel
-&gt; SegSpace
-&gt; [SegBinOp GPUMem]
-&gt; KernelBody GPUMem
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegRed.html#compileSegRed"><span class="hs-identifier hs-var">compileSegRed</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545209"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684545207"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684545205"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684545204"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684545203"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-168"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#segOpCompiler"><span class="hs-identifier hs-var">segOpCompiler</span></a></span><span> </span><span id="local-6989586621684545201"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545201"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegScan"><span class="hs-identifier hs-type">SegScan</span></a></span><span> </span><span id="local-6989586621684545199"><span class="annot"><span class="annottext">lvl :: SegLevel
</span><a href="#local-6989586621684545199"><span class="hs-identifier hs-var">lvl</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegThread"><span class="hs-identifier hs-type">SegThread</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span id="local-6989586621684545198"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684545198"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684545197"><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684545197"><span class="hs-identifier hs-var">scans</span></a></span></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase DimSize) NoUniqueness]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684545196"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684545196"><span class="hs-identifier hs-var">kbody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-169"></span><span>  </span><span class="annot"><span class="annottext">Pat GPUMem
-&gt; SegLevel
-&gt; SegSpace
-&gt; [SegBinOp GPUMem]
-&gt; KernelBody GPUMem
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegScan.html#compileSegScan"><span class="hs-identifier hs-var">compileSegScan</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545201"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SegLevel
</span><a href="#local-6989586621684545199"><span class="hs-identifier hs-var">lvl</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684545198"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp GPUMem]
</span><a href="#local-6989586621684545197"><span class="hs-identifier hs-var">scans</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684545196"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-170"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#segOpCompiler"><span class="hs-identifier hs-var">segOpCompiler</span></a></span><span> </span><span id="local-6989586621684545194"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545194"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegHist"><span class="hs-identifier hs-type">SegHist</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.GPU.Op.html#SegThread"><span class="hs-identifier hs-type">SegThread</span></a></span><span> </span><span id="local-6989586621684545192"><span class="annot"><span class="annottext">Count NumGroups DimSize
</span><a href="#local-6989586621684545192"><span class="hs-identifier hs-var">num_groups</span></a></span></span><span> </span><span id="local-6989586621684545191"><span class="annot"><span class="annottext">Count GroupSize DimSize
</span><a href="#local-6989586621684545191"><span class="hs-identifier hs-var">group_size</span></a></span></span><span> </span><span class="annot"><span class="annottext">SegVirt
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684545190"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684545190"><span class="hs-identifier hs-var">space</span></a></span></span><span> </span><span id="local-6989586621684545189"><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684545189"><span class="hs-identifier hs-var">ops</span></a></span></span><span> </span><span class="annot"><span class="annottext">[TypeBase (ShapeBase DimSize) NoUniqueness]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684545188"><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684545188"><span class="hs-identifier hs-var">kbody</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-171"></span><span>  </span><span class="annot"><span class="annottext">Pat GPUMem
-&gt; Count NumGroups DimSize
-&gt; Count GroupSize DimSize
-&gt; SegSpace
-&gt; [HistOp GPUMem]
-&gt; KernelBody GPUMem
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.SegHist.html#compileSegHist"><span class="hs-identifier hs-var">compileSegHist</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545194"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Count NumGroups DimSize
</span><a href="#local-6989586621684545192"><span class="hs-identifier hs-var">num_groups</span></a></span><span> </span><span class="annot"><span class="annottext">Count GroupSize DimSize
</span><a href="#local-6989586621684545191"><span class="hs-identifier hs-var">group_size</span></a></span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684545190"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp GPUMem]
</span><a href="#local-6989586621684545189"><span class="hs-identifier hs-var">ops</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody GPUMem
</span><a href="#local-6989586621684545188"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-172"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#segOpCompiler"><span class="hs-identifier hs-var">segOpCompiler</span></a></span><span> </span><span id="local-6989586621684545186"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545186"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684545185"><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684545185"><span class="hs-identifier hs-var">segop</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-173"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; ImpM GPUMem HostEnv HostOp ()
forall a. String -&gt; a
</span><a href="Futhark.Error.html#compilerBugS"><span class="hs-identifier hs-var">compilerBugS</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; String -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;segOpCompiler: unexpected &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">SegLevel -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem -&gt; SegLevel
forall lvl rep. SegOp lvl rep -&gt; lvl
</span><a href="Futhark.IR.SegOp.html#segLevel"><span class="hs-identifier hs-var">segLevel</span></a></span><span> </span><span class="annot"><span class="annottext">SegOp SegLevel GPUMem
</span><a href="#local-6989586621684545185"><span class="hs-identifier hs-var">segop</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; for rhs of pattern &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PatT LetDecMem -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
PatT LetDecMem
</span><a href="#local-6989586621684545186"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span class="hs-comment">-- Create boolean expression that checks whether all kernels in the</span><span>
</span><span id="line-176"></span><span class="hs-comment">-- enclosed code do not use more local memory than we have available.</span><span>
</span><span id="line-177"></span><span class="hs-comment">-- We look at *all* the kernels here, even those that might be</span><span>
</span><span id="line-178"></span><span class="hs-comment">-- otherwise protected by their own multi-versioning branches deeper</span><span>
</span><span id="line-179"></span><span class="hs-comment">-- down.  Currently the compiler will not generate multi-versioning</span><span>
</span><span id="line-180"></span><span class="hs-comment">-- that makes this a problem, but it might in the future.</span><span>
</span><span id="line-181"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#checkLocalMemoryReqs"><span class="hs-identifier hs-type">checkLocalMemoryReqs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#Code"><span class="hs-identifier hs-type">Imp.Code</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.html#TExp"><span class="hs-identifier hs-type">Imp.TExp</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-182"></span><span id="checkLocalMemoryReqs"><span class="annot"><span class="annottext">checkLocalMemoryReqs :: Code HostOp -&gt; CallKernelGen (Maybe (TExp Bool))
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#checkLocalMemoryReqs"><span class="hs-identifier hs-var hs-var">checkLocalMemoryReqs</span></a></span></span><span> </span><span id="local-6989586621684545181"><span class="annot"><span class="annottext">Code HostOp
</span><a href="#local-6989586621684545181"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-183"></span><span>  </span><span id="local-6989586621684545180"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684545180"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp (Scope SOACS)
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-184"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684545178"><span class="annot"><span class="annottext">alloc_sizes :: [Count Bytes (TExp Int64)]
</span><a href="#local-6989586621684545178"><span class="hs-identifier hs-var hs-var">alloc_sizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Kernel -&gt; Count Bytes (TExp Int64))
-&gt; [Kernel] -&gt; [Count Bytes (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Count Bytes (TExp Int64)] -&gt; Count Bytes (TExp Int64)
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">([Count Bytes (TExp Int64)] -&gt; Count Bytes (TExp Int64))
-&gt; (Kernel -&gt; [Count Bytes (TExp Int64)])
-&gt; Kernel
-&gt; Count Bytes (TExp Int64)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Count Bytes (TExp Int64) -&gt; Count Bytes (TExp Int64))
-&gt; [Count Bytes (TExp Int64)] -&gt; [Count Bytes (TExp Int64)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Count Bytes (TExp Int64) -&gt; Count Bytes (TExp Int64)
forall {e}. IntegralExp e =&gt; e -&gt; e
</span><a href="#local-6989586621684545176"><span class="hs-identifier hs-var">alignedSize</span></a></span><span> </span><span class="annot"><span class="annottext">([Count Bytes (TExp Int64)] -&gt; [Count Bytes (TExp Int64)])
-&gt; (Kernel -&gt; [Count Bytes (TExp Int64)])
-&gt; Kernel
-&gt; [Count Bytes (TExp Int64)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Code KernelOp -&gt; [Count Bytes (TExp Int64)]
</span><a href="#local-6989586621684545175"><span class="hs-identifier hs-var">localAllocSizes</span></a></span><span> </span><span class="annot"><span class="annottext">(Code KernelOp -&gt; [Count Bytes (TExp Int64)])
-&gt; (Kernel -&gt; Code KernelOp)
-&gt; Kernel
-&gt; [Count Bytes (TExp Int64)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Kernel -&gt; Code KernelOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#kernelBody"><span class="hs-identifier hs-var hs-var">Imp.kernelBody</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Kernel] -&gt; [Count Bytes (TExp Int64)])
-&gt; [Kernel] -&gt; [Count Bytes (TExp Int64)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Code HostOp -&gt; [Kernel]
</span><a href="#local-6989586621684545174"><span class="hs-identifier hs-var">getGPU</span></a></span><span> </span><span class="annot"><span class="annottext">Code HostOp
</span><a href="#local-6989586621684545181"><span class="hs-identifier hs-var">code</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span>  </span><span class="hs-comment">-- If any of the sizes involve a variable that is not known at this</span><span>
</span><span id="line-187"></span><span>  </span><span class="hs-comment">-- point, then we cannot check the requirements.</span><span>
</span><span id="line-188"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Scope SOACS -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><span class="hs-operator hs-var">`M.notMember`</span></span><span> </span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684545180"><span class="hs-identifier hs-var">scope</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Names -&gt; [VName]
</span><a href="Futhark.IR.Prop.Names.html#namesToList"><span class="hs-identifier hs-var">namesToList</span></a></span><span> </span><span class="annot"><span class="annottext">(Names -&gt; [VName]) -&gt; Names -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Count Bytes (TExp Int64)] -&gt; Names
forall a. FreeIn a =&gt; a -&gt; Names
</span><a href="Futhark.IR.Prop.Names.html#freeIn"><span class="hs-identifier hs-var">freeIn</span></a></span><span> </span><span class="annot"><span class="annottext">[Count Bytes (TExp Int64)]
</span><a href="#local-6989586621684545178"><span class="hs-identifier hs-var">alloc_sizes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe (TExp Bool) -&gt; CallKernelGen (Maybe (TExp Bool))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (TExp Bool)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-190"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-191"></span><span>      </span><span id="local-6989586621684545169"><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684545169"><span class="hs-identifier hs-var">local_memory_capacity</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#TV"><span class="hs-identifier hs-type">TV</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int32</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; PrimType -&gt; ImpM GPUMem HostEnv HostOp (TV Int32)
forall rep r op t. String -&gt; PrimType -&gt; ImpM rep r op (TV t)
</span><a href="Futhark.CodeGen.ImpGen.html#dPrim"><span class="hs-identifier hs-var">dPrim</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local_memory_capacity&quot;</span></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span>
</span><span id="line-192"></span><span>      </span><span class="annot"><span class="annottext">HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall op rep r. op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#sOp"><span class="hs-identifier hs-var">sOp</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SizeClass -&gt; HostOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#GetSizeMax"><span class="hs-identifier hs-var">Imp.GetSizeMax</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TV Int32 -&gt; VName
forall t. TV t -&gt; VName
</span><a href="Futhark.CodeGen.ImpGen.html#tvVar"><span class="hs-identifier hs-var">tvVar</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684545169"><span class="hs-identifier hs-var">local_memory_capacity</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SizeClass
</span><a href="Futhark.IR.GPU.Sizes.html#SizeLocalMemory"><span class="hs-identifier hs-var">SizeLocalMemory</span></a></span><span>
</span><span id="line-193"></span><span>
</span><span id="line-194"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684545167"><span class="annot"><span class="annottext">local_memory_capacity_64 :: TExp Int64
</span><a href="#local-6989586621684545167"><span class="hs-identifier hs-var hs-var">local_memory_capacity_64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-195"></span><span>            </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int32 VName -&gt; TExp Int64)
-&gt; TPrimExp Int32 VName -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TV Int32 -&gt; TPrimExp Int32 VName
forall t. TV t -&gt; TExp t
</span><a href="Futhark.CodeGen.ImpGen.html#tvExp"><span class="hs-identifier hs-var">tvExp</span></a></span><span> </span><span class="annot"><span class="annottext">TV Int32
</span><a href="#local-6989586621684545169"><span class="hs-identifier hs-var">local_memory_capacity</span></a></span><span>
</span><span id="line-196"></span><span>          </span><span id="local-6989586621684545166"><span class="annot"><span class="annottext">fits :: Count Bytes (TExp Int64) -&gt; TExp Bool
</span><a href="#local-6989586621684545166"><span class="hs-identifier hs-var hs-var">fits</span></a></span></span><span> </span><span id="local-6989586621684545165"><span class="annot"><span class="annottext">Count Bytes (TExp Int64)
</span><a href="#local-6989586621684545165"><span class="hs-identifier hs-var">size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-197"></span><span>            </span><span class="annot"><span class="annottext">Count Bytes (TExp Int64) -&gt; TExp Int64
forall u e. Count u e -&gt; e
</span><a href="Futhark.IR.GPU.Sizes.html#unCount"><span class="hs-identifier hs-var hs-var">unCount</span></a></span><span> </span><span class="annot"><span class="annottext">Count Bytes (TExp Int64)
</span><a href="#local-6989586621684545165"><span class="hs-identifier hs-var">size</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64 -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C%3D."><span class="hs-operator hs-var">.&lt;=.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545167"><span class="hs-identifier hs-var">local_memory_capacity_64</span></a></span><span>
</span><span id="line-198"></span><span>      </span><span class="annot"><span class="annottext">Maybe (TExp Bool) -&gt; CallKernelGen (Maybe (TExp Bool))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (TExp Bool) -&gt; CallKernelGen (Maybe (TExp Bool)))
-&gt; Maybe (TExp Bool) -&gt; CallKernelGen (Maybe (TExp Bool))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; Maybe (TExp Bool)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(TExp Bool -&gt; Maybe (TExp Bool)) -&gt; TExp Bool -&gt; Maybe (TExp Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TExp Bool -&gt; TExp Bool -&gt; TExp Bool)
-&gt; TExp Bool -&gt; [TExp Bool] -&gt; TExp Bool
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">(.&amp;&amp;.)</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
forall v. TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#true"><span class="hs-identifier hs-var">true</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Count Bytes (TExp Int64) -&gt; TExp Bool)
-&gt; [Count Bytes (TExp Int64)] -&gt; [TExp Bool]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Count Bytes (TExp Int64) -&gt; TExp Bool
</span><a href="#local-6989586621684545166"><span class="hs-identifier hs-var">fits</span></a></span><span> </span><span class="annot"><span class="annottext">[Count Bytes (TExp Int64)]
</span><a href="#local-6989586621684545178"><span class="hs-identifier hs-var">alloc_sizes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-200"></span><span>    </span><span id="local-6989586621684545174"><span class="annot"><span class="annottext">getGPU :: Code HostOp -&gt; [Kernel]
</span><a href="#local-6989586621684545174"><span class="hs-identifier hs-var hs-var">getGPU</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(HostOp -&gt; [Kernel]) -&gt; Code HostOp -&gt; [Kernel]
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">HostOp -&gt; [Kernel]
</span><a href="#local-6989586621684545155"><span class="hs-identifier hs-var">getKernel</span></a></span><span>
</span><span id="line-201"></span><span>    </span><span id="local-6989586621684545155"><span class="annot"><span class="annottext">getKernel :: HostOp -&gt; [Kernel]
</span><a href="#local-6989586621684545155"><span class="hs-identifier hs-var hs-var">getKernel</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#CallKernel"><span class="hs-identifier hs-type">Imp.CallKernel</span></a></span><span> </span><span id="local-6989586621684545154"><span class="annot"><span class="annottext">Kernel
</span><a href="#local-6989586621684545154"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Kernel
</span><a href="#local-6989586621684545154"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-202"></span><span>    </span><span class="annot"><a href="#local-6989586621684545155"><span class="hs-identifier hs-var">getKernel</span></a></span><span> </span><span class="annot"><span class="annottext">HostOp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-203"></span><span>
</span><span id="line-204"></span><span>    </span><span id="local-6989586621684545175"><span class="annot"><span class="annottext">localAllocSizes :: Code KernelOp -&gt; [Count Bytes (TExp Int64)]
</span><a href="#local-6989586621684545175"><span class="hs-identifier hs-var hs-var">localAllocSizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(KernelOp -&gt; [Count Bytes (TExp Int64)])
-&gt; Code KernelOp -&gt; [Count Bytes (TExp Int64)]
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">KernelOp -&gt; [Count Bytes (TExp Int64)]
</span><a href="#local-6989586621684545151"><span class="hs-identifier hs-var">localAllocSize</span></a></span><span>
</span><span id="line-205"></span><span>    </span><span id="local-6989586621684545151"><span class="annot"><span class="annottext">localAllocSize :: KernelOp -&gt; [Count Bytes (TExp Int64)]
</span><a href="#local-6989586621684545151"><span class="hs-identifier hs-var hs-var">localAllocSize</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#LocalAlloc"><span class="hs-identifier hs-type">Imp.LocalAlloc</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684545149"><span class="annot"><span class="annottext">Count Bytes (TExp Int64)
</span><a href="#local-6989586621684545149"><span class="hs-identifier hs-var">size</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Count Bytes (TExp Int64)
</span><a href="#local-6989586621684545149"><span class="hs-identifier hs-var">size</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-206"></span><span>    </span><span class="annot"><a href="#local-6989586621684545151"><span class="hs-identifier hs-var">localAllocSize</span></a></span><span> </span><span class="annot"><span class="annottext">KernelOp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-comment">-- These allocations will actually be padded to an 8-byte aligned</span><span>
</span><span id="line-209"></span><span>    </span><span class="hs-comment">-- size, so we should take that into account when checking whether</span><span>
</span><span id="line-210"></span><span>    </span><span class="hs-comment">-- they fit.</span><span>
</span><span id="line-211"></span><span>    </span><span id="local-6989586621684545176"><span class="annot"><span class="annottext">alignedSize :: e -&gt; e
</span><a href="#local-6989586621684545176"><span class="hs-identifier hs-var hs-var">alignedSize</span></a></span></span><span> </span><span id="local-6989586621684545138"><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621684545138"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621684545138"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">e -&gt; e -&gt; e
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">e
</span><span class="hs-number">8</span></span><span> </span><span class="annot"><span class="annottext">e -&gt; e -&gt; e
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">e
</span><a href="#local-6989586621684545138"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">e -&gt; e -&gt; e
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">e
</span><span class="hs-number">8</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">e -&gt; e -&gt; e
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#rem"><span class="hs-operator hs-var">`rem`</span></a></span><span> </span><span class="annot"><span class="annottext">e
</span><span class="hs-number">8</span></span><span class="hs-special">)</span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#withAcc"><span class="hs-identifier hs-type">withAcc</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-214"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-215"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-216"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-217"></span><span>  </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-218"></span><span id="withAcc"><span class="annot"><span class="annottext">withAcc :: Pat GPUMem
-&gt; [(ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize]))]
-&gt; Lambda GPUMem
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#withAcc"><span class="hs-identifier hs-var hs-var">withAcc</span></a></span></span><span> </span><span id="local-6989586621684545133"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545133"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684545132"><span class="annot"><span class="annottext">[(ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize]))]
</span><a href="#local-6989586621684545132"><span class="hs-identifier hs-var">inputs</span></a></span></span><span> </span><span id="local-6989586621684545131"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684545131"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-219"></span><span>  </span><span id="local-6989586621684545130"><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684545130"><span class="hs-identifier hs-var">atomics</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HostEnv -&gt; AtomicBinOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#hostAtomics"><span class="hs-identifier hs-var hs-var">hostAtomics</span></a></span><span> </span><span class="annot"><span class="annottext">(HostEnv -&gt; AtomicBinOp)
-&gt; ImpM GPUMem HostEnv HostOp HostEnv
-&gt; ImpM GPUMem HostEnv HostOp AtomicBinOp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp HostEnv
forall rep r op. ImpM rep r op r
</span><a href="Futhark.CodeGen.ImpGen.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-220"></span><span>  </span><span class="annot"><span class="annottext">AtomicBinOp
-&gt; [(VName,
     (ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize])))]
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="#local-6989586621684545127"><span class="hs-identifier hs-var">locksForInputs</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684545130"><span class="hs-identifier hs-var">atomics</span></a></span><span> </span><span class="annot"><span class="annottext">([(VName,
   (ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize])))]
 -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; [(VName,
     (ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize])))]
-&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; [(ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize]))]
-&gt; [(VName,
     (ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize])))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684545126"><span class="hs-identifier hs-var">accs</span></a></span><span> </span><span class="annot"><span class="annottext">[(ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize]))]
</span><a href="#local-6989586621684545132"><span class="hs-identifier hs-var">inputs</span></a></span><span>
</span><span id="line-221"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-222"></span><span>    </span><span id="local-6989586621684545126"><span class="annot"><span class="annottext">accs :: [VName]
</span><a href="#local-6989586621684545126"><span class="hs-identifier hs-var hs-var">accs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param LetDecMem -&gt; VName) -&gt; [Param LetDecMem] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Param LetDecMem -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">([Param LetDecMem] -&gt; [VName]) -&gt; [Param LetDecMem] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem -&gt; [LParam GPUMem]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684545131"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-223"></span><span>    </span><span id="local-6989586621684545127"><span class="annot"><span class="annottext">locksForInputs :: AtomicBinOp
-&gt; [(VName,
     (ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize])))]
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="#local-6989586621684545127"><span class="hs-identifier hs-var hs-var">locksForInputs</span></a></span></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-224"></span><span>      </span><span class="annot"><span class="annottext">ExpCompiler GPUMem HostEnv HostOp
forall rep inner r op.
Mem rep inner =&gt;
Pat rep -&gt; Exp rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#defCompileExp"><span class="hs-identifier hs-var">defCompileExp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545133"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp GPUMem -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; Exp GPUMem -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize]))]
-&gt; Lambda GPUMem -&gt; Exp GPUMem
forall rep. [WithAccInput rep] -&gt; Lambda rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-var">WithAcc</span></a></span><span> </span><span class="annot"><span class="annottext">[(ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize]))]
</span><a href="#local-6989586621684545132"><span class="hs-identifier hs-var">inputs</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684545131"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-225"></span><span>    </span><span class="annot"><a href="#local-6989586621684545127"><span class="hs-identifier hs-var">locksForInputs</span></a></span><span> </span><span id="local-6989586621684545121"><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684545121"><span class="hs-identifier hs-var">atomics</span></a></span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684545120"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545120"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeBase DimSize
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684545119"><span class="annot"><span class="annottext">Maybe (Lambda GPUMem, [DimSize])
</span><a href="#local-6989586621684545119"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684545118"><span class="annot"><span class="annottext">[(VName,
  (ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize])))]
</span><a href="#local-6989586621684545118"><span class="hs-identifier hs-var">inputs'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-226"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684545117"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684545117"><span class="hs-identifier hs-var">op_lam</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[DimSize]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (Lambda GPUMem, [DimSize])
</span><a href="#local-6989586621684545119"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-227"></span><span>        </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#AtomicLocking"><span class="hs-identifier hs-type">AtomicLocking</span></a></span><span> </span><span class="annot"><span class="annottext">Locking -&gt; DoAtomicUpdate GPUMem KernelEnv
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">AtomicBinOp -&gt; Lambda GPUMem -&gt; AtomicUpdate GPUMem KernelEnv
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#atomicUpdateLocking"><span class="hs-identifier hs-var">atomicUpdateLocking</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684545121"><span class="hs-identifier hs-var">atomics</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684545117"><span class="hs-identifier hs-var">op_lam</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-228"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684545112"><span class="annot"><span class="annottext">num_locks :: Int
</span><a href="#local-6989586621684545112"><span class="hs-identifier hs-var hs-var">num_locks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">100151</span></span><span>
</span><span id="line-229"></span><span>        </span><span id="local-6989586621684545111"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545111"><span class="hs-identifier hs-var">locks_arr</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-230"></span><span>          </span><span class="annot"><span class="annottext">String
-&gt; Space
-&gt; PrimType
-&gt; ArrayContents
-&gt; ImpM GPUMem HostEnv HostOp VName
forall rep r op.
String -&gt; Space -&gt; PrimType -&gt; ArrayContents -&gt; ImpM rep r op VName
</span><a href="Futhark.CodeGen.ImpGen.html#sStaticArray"><span class="hs-identifier hs-var">sStaticArray</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;withacc_locks&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;device&quot;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="Futhark.IR.Prop.Types.html#int32"><span class="hs-identifier hs-var">int32</span></a></span><span> </span><span class="annot"><span class="annottext">(ArrayContents -&gt; ImpM GPUMem HostEnv HostOp VName)
-&gt; ArrayContents -&gt; ImpM GPUMem HostEnv HostOp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-231"></span><span>            </span><span class="annot"><span class="annottext">Int -&gt; ArrayContents
</span><a href="Futhark.CodeGen.ImpCode.html#ArrayZeros"><span class="hs-identifier hs-var">Imp.ArrayZeros</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684545112"><span class="hs-identifier hs-var">num_locks</span></a></span><span>
</span><span id="line-232"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684545108"><span class="annot"><span class="annottext">locks :: Locks
</span><a href="#local-6989586621684545108"><span class="hs-identifier hs-var hs-var">locks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Int -&gt; Locks
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#Locks"><span class="hs-identifier hs-var">Locks</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545111"><span class="hs-identifier hs-var">locks_arr</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684545112"><span class="hs-identifier hs-var">num_locks</span></a></span><span>
</span><span id="line-233"></span><span>            </span><span id="local-6989586621684545106"><span class="annot"><span class="annottext">extend :: HostEnv -&gt; HostEnv
</span><a href="#local-6989586621684545106"><span class="hs-identifier hs-var hs-var">extend</span></a></span></span><span> </span><span id="local-6989586621684545105"><span class="annot"><span class="annottext">HostEnv
</span><a href="#local-6989586621684545105"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HostEnv
</span><a href="#local-6989586621684545105"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">hostLocks :: Map VName Locks
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#hostLocks"><span class="hs-identifier hs-var">hostLocks</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Locks -&gt; Map VName Locks -&gt; Map VName Locks
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545120"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Locks
</span><a href="#local-6989586621684545108"><span class="hs-identifier hs-var">locks</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName Locks -&gt; Map VName Locks)
-&gt; Map VName Locks -&gt; Map VName Locks
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">HostEnv -&gt; Map VName Locks
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#hostLocks"><span class="hs-identifier hs-var hs-var">hostLocks</span></a></span><span> </span><span class="annot"><span class="annottext">HostEnv
</span><a href="#local-6989586621684545105"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-234"></span><span>        </span><span class="annot"><span class="annottext">(HostEnv -&gt; HostEnv)
-&gt; ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ()
forall r rep op a. (r -&gt; r) -&gt; ImpM rep r op a -&gt; ImpM rep r op a
</span><a href="Futhark.CodeGen.ImpGen.html#localEnv"><span class="hs-identifier hs-var">localEnv</span></a></span><span> </span><span class="annot"><span class="annottext">HostEnv -&gt; HostEnv
</span><a href="#local-6989586621684545106"><span class="hs-identifier hs-var">extend</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
-&gt; [(VName,
     (ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize])))]
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="#local-6989586621684545127"><span class="hs-identifier hs-var">locksForInputs</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684545121"><span class="hs-identifier hs-var">atomics</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName,
  (ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize])))]
</span><a href="#local-6989586621684545118"><span class="hs-identifier hs-var">inputs'</span></a></span><span>
</span><span id="line-235"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-236"></span><span>        </span><span class="annot"><span class="annottext">AtomicBinOp
-&gt; [(VName,
     (ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize])))]
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="#local-6989586621684545127"><span class="hs-identifier hs-var">locksForInputs</span></a></span><span> </span><span class="annot"><span class="annottext">AtomicBinOp
</span><a href="#local-6989586621684545121"><span class="hs-identifier hs-var">atomics</span></a></span><span> </span><span class="annot"><span class="annottext">[(VName,
  (ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize])))]
</span><a href="#local-6989586621684545118"><span class="hs-identifier hs-var">inputs'</span></a></span><span>
</span><span id="line-237"></span><span>
</span><span id="line-238"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#expCompiler"><span class="hs-identifier hs-type">expCompiler</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#ExpCompiler"><span class="hs-identifier hs-type">ExpCompiler</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#HostEnv"><span class="hs-identifier hs-type">HostEnv</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#HostOp"><span class="hs-identifier hs-type">Imp.HostOp</span></a></span><span>
</span><span id="line-239"></span><span class="hs-comment">-- We generate a simple kernel for itoa and replicate.</span><span>
</span><span id="line-240"></span><span id="expCompiler"><span class="annot"><span class="annottext">expCompiler :: ExpCompiler GPUMem HostEnv HostOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#expCompiler"><span class="hs-identifier hs-var hs-var">expCompiler</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684545101"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684545101"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Iota"><span class="hs-identifier hs-type">Iota</span></a></span><span> </span><span id="local-6989586621684545098"><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545098"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684545097"><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545097"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span id="local-6989586621684545096"><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545096"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684545095"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684545095"><span class="hs-identifier hs-var">et</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-241"></span><span>  </span><span id="local-6989586621684545094"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684545094"><span class="hs-identifier hs-var">x'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DimSize -&gt; ImpM GPUMem HostEnv HostOp Exp
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op Exp
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545097"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-242"></span><span>  </span><span id="local-6989586621684545093"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684545093"><span class="hs-identifier hs-var">s'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DimSize -&gt; ImpM GPUMem HostEnv HostOp Exp
forall a rep r op. ToExp a =&gt; a -&gt; ImpM rep r op Exp
</span><a href="Futhark.CodeGen.ImpGen.html#toExp"><span class="hs-identifier hs-var">toExp</span></a></span><span> </span><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545096"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-243"></span><span>
</span><span id="line-244"></span><span>  </span><span class="annot"><span class="annottext">VName
-&gt; TExp Int64
-&gt; Exp
-&gt; Exp
-&gt; IntType
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sIota"><span class="hs-identifier hs-var">sIota</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LetDecMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LetDecMem
</span><a href="#local-6989586621684545101"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DimSize -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545098"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684545094"><span class="hs-identifier hs-var">x'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684545093"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684545095"><span class="hs-identifier hs-var">et</span></a></span><span>
</span><span id="line-245"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#expCompiler"><span class="hs-identifier hs-var">expCompiler</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684545091"><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
</span><a href="#local-6989586621684545091"><span class="hs-identifier hs-var">pe</span></a></span></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Replicate"><span class="hs-identifier hs-type">Replicate</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeBase DimSize
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684545089"><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545089"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatElemT LetDecMem -&gt; TypeBase (ShapeBase DimSize) NoUniqueness
forall dec.
Typed dec =&gt;
PatElemT dec -&gt; TypeBase (ShapeBase DimSize) NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#patElemType"><span class="hs-identifier hs-var">patElemType</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LetDecMem
</span><a href="#local-6989586621684545091"><span class="hs-identifier hs-var">pe</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; ImpM GPUMem HostEnv HostOp ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-248"></span><span>    </span><span class="annot"><span class="annottext">VName -&gt; DimSize -&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sReplicate"><span class="hs-identifier hs-var">sReplicate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatElemT LetDecMem -&gt; VName
forall dec. PatElemT dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#patElemName"><span class="hs-identifier hs-var hs-var">patElemName</span></a></span><span> </span><span class="annot"><span class="annottext">PatElemT (LetDec GPUMem)
PatElemT LetDecMem
</span><a href="#local-6989586621684545091"><span class="hs-identifier hs-var">pe</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545089"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-249"></span><span class="hs-comment">-- Allocation in the &quot;local&quot; space is just a placeholder.</span><span>
</span><span id="line-250"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#expCompiler"><span class="hs-identifier hs-var">expCompiler</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.html#Alloc"><span class="hs-identifier hs-type">Alloc</span></a></span><span> </span><span class="annot"><span class="annottext">DimSize
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-type">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;local&quot;</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-251"></span><span>  </span><span class="annot"><span class="annottext">() -&gt; ImpM GPUMem HostEnv HostOp ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-252"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#expCompiler"><span class="hs-identifier hs-var">expCompiler</span></a></span><span> </span><span id="local-6989586621684545084"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545084"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-type">WithAcc</span></a></span><span> </span><span id="local-6989586621684545083"><span class="annot"><span class="annottext">[(ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize]))]
</span><a href="#local-6989586621684545083"><span class="hs-identifier hs-var">inputs</span></a></span></span><span> </span><span id="local-6989586621684545082"><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684545082"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-253"></span><span>  </span><span class="annot"><span class="annottext">Pat GPUMem
-&gt; [(ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize]))]
-&gt; Lambda GPUMem
-&gt; ImpM GPUMem HostEnv HostOp ()
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#withAcc"><span class="hs-identifier hs-var">withAcc</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545084"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">[(ShapeBase DimSize, [VName], Maybe (Lambda GPUMem, [DimSize]))]
</span><a href="#local-6989586621684545083"><span class="hs-identifier hs-var">inputs</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda GPUMem
</span><a href="#local-6989586621684545082"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-254"></span><span class="hs-comment">-- This is a multi-versioning If created by incremental flattening.</span><span>
</span><span id="line-255"></span><span class="hs-comment">-- We need to augment the conditional with a check that any local</span><span>
</span><span id="line-256"></span><span class="hs-comment">-- memory requirements in tbranch are compatible with the hardware.</span><span>
</span><span id="line-257"></span><span class="hs-comment">-- We do not check anything for fbranch, as we assume that it will</span><span>
</span><span id="line-258"></span><span class="hs-comment">-- always be safe (and what would we do if none of the branches would</span><span>
</span><span id="line-259"></span><span class="hs-comment">-- work?).</span><span>
</span><span id="line-260"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#expCompiler"><span class="hs-identifier hs-var">expCompiler</span></a></span><span> </span><span id="local-6989586621684545081"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545081"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span id="local-6989586621684545079"><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545079"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684545078"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684545078"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span> </span><span id="local-6989586621684545077"><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684545077"><span class="hs-identifier hs-var">fbranch</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#IfDec"><span class="hs-identifier hs-type">IfDec</span></a></span><span> </span><span class="annot"><span class="annottext">[BranchType GPUMem]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IfSort
</span><a href="Futhark.IR.Syntax.html#IfEquiv"><span class="hs-identifier hs-var">IfEquiv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-261"></span><span>  </span><span id="local-6989586621684545074"><span class="annot"><span class="annottext">Code HostOp
</span><a href="#local-6989586621684545074"><span class="hs-identifier hs-var">tcode</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp ()
-&gt; ImpM GPUMem HostEnv HostOp (Code HostOp)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem HostEnv HostOp ()
 -&gt; ImpM GPUMem HostEnv HostOp (Code HostOp))
-&gt; ImpM GPUMem HostEnv HostOp ()
-&gt; ImpM GPUMem HostEnv HostOp (Code HostOp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem -&gt; BodyT GPUMem -&gt; ImpM GPUMem HostEnv HostOp ()
forall rep r op. Pat rep -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545081"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684545078"><span class="hs-identifier hs-var">tbranch</span></a></span><span>
</span><span id="line-262"></span><span>  </span><span id="local-6989586621684545071"><span class="annot"><span class="annottext">Code HostOp
</span><a href="#local-6989586621684545071"><span class="hs-identifier hs-var">fcode</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ImpM GPUMem HostEnv HostOp ()
-&gt; ImpM GPUMem HostEnv HostOp (Code HostOp)
forall rep r op. ImpM rep r op () -&gt; ImpM rep r op (Code op)
</span><a href="Futhark.CodeGen.ImpGen.html#collect"><span class="hs-identifier hs-var">collect</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem HostEnv HostOp ()
 -&gt; ImpM GPUMem HostEnv HostOp (Code HostOp))
-&gt; ImpM GPUMem HostEnv HostOp ()
-&gt; ImpM GPUMem HostEnv HostOp (Code HostOp)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem -&gt; BodyT GPUMem -&gt; ImpM GPUMem HostEnv HostOp ()
forall rep r op. Pat rep -&gt; Body rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#compileBody"><span class="hs-identifier hs-var">compileBody</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545081"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">BodyT GPUMem
</span><a href="#local-6989586621684545077"><span class="hs-identifier hs-var">fbranch</span></a></span><span>
</span><span id="line-263"></span><span>  </span><span id="local-6989586621684545070"><span class="annot"><span class="annottext">Maybe (TExp Bool)
</span><a href="#local-6989586621684545070"><span class="hs-identifier hs-var">check</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Code HostOp -&gt; CallKernelGen (Maybe (TExp Bool))
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#checkLocalMemoryReqs"><span class="hs-identifier hs-var">checkLocalMemoryReqs</span></a></span><span> </span><span class="annot"><span class="annottext">Code HostOp
</span><a href="#local-6989586621684545074"><span class="hs-identifier hs-var">tcode</span></a></span><span>
</span><span id="line-264"></span><span>  </span><span class="annot"><span class="annottext">Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe (TExp Bool)
</span><a href="#local-6989586621684545070"><span class="hs-identifier hs-var">check</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-265"></span><span>    </span><span class="annot"><span class="annottext">Maybe (TExp Bool)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Code HostOp
</span><a href="#local-6989586621684545071"><span class="hs-identifier hs-var">fcode</span></a></span><span>
</span><span id="line-266"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684545068"><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684545068"><span class="hs-identifier hs-var">ok</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; Code HostOp -&gt; Code HostOp -&gt; Code HostOp
forall a. TExp Bool -&gt; Code a -&gt; Code a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#If"><span class="hs-identifier hs-var">Imp.If</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684545068"><span class="hs-identifier hs-var">ok</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">DimSize -&gt; TExp Bool
forall a. ToExp a =&gt; a -&gt; TExp Bool
</span><a href="Futhark.CodeGen.ImpGen.html#toBoolExp"><span class="hs-identifier hs-var">toBoolExp</span></a></span><span> </span><span class="annot"><span class="annottext">DimSize
</span><a href="#local-6989586621684545079"><span class="hs-identifier hs-var">cond</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Code HostOp
</span><a href="#local-6989586621684545074"><span class="hs-identifier hs-var">tcode</span></a></span><span> </span><span class="annot"><span class="annottext">Code HostOp
</span><a href="#local-6989586621684545071"><span class="hs-identifier hs-var">fcode</span></a></span><span>
</span><span id="line-267"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#expCompiler"><span class="hs-identifier hs-var">expCompiler</span></a></span><span> </span><span id="local-6989586621684545065"><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545065"><span class="hs-identifier hs-var">dest</span></a></span></span><span> </span><span id="local-6989586621684545064"><span class="annot"><span class="annottext">Exp GPUMem
</span><a href="#local-6989586621684545064"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-268"></span><span>  </span><span class="annot"><span class="annottext">ExpCompiler GPUMem HostEnv HostOp
forall rep inner r op.
Mem rep inner =&gt;
Pat rep -&gt; Exp rep -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#defCompileExp"><span class="hs-identifier hs-var">defCompileExp</span></a></span><span> </span><span class="annot"><span class="annottext">Pat GPUMem
</span><a href="#local-6989586621684545065"><span class="hs-identifier hs-var">dest</span></a></span><span> </span><span class="annot"><span class="annottext">Exp GPUMem
</span><a href="#local-6989586621684545064"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-269"></span><span>
</span><span id="line-270"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#callKernelCopy"><span class="hs-identifier hs-type">callKernelCopy</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#CopyCompiler"><span class="hs-identifier hs-type">CopyCompiler</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.GPUMem.html#GPUMem"><span class="hs-identifier hs-type">GPUMem</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#HostEnv"><span class="hs-identifier hs-type">HostEnv</span></a></span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#HostOp"><span class="hs-identifier hs-type">Imp.HostOp</span></a></span><span>
</span><span id="line-271"></span><span id="callKernelCopy"><span class="annot"><span class="annottext">callKernelCopy :: CopyCompiler GPUMem HostEnv HostOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#callKernelCopy"><span class="hs-identifier hs-var hs-var">callKernelCopy</span></a></span></span><span> </span><span id="local-6989586621684545063"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545063"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span id="local-6989586621684545062"><span class="annot"><span class="annottext">destloc :: MemLoc
</span><a href="#local-6989586621684545062"><span class="hs-identifier hs-var">destloc</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span id="local-6989586621684545060"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545060"><span class="hs-identifier hs-var">destmem</span></a></span></span><span> </span><span class="annot"><span class="annottext">[DimSize]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684545059"><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684545059"><span class="hs-identifier hs-var">destIxFun</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684545058"><span class="annot"><span class="annottext">srcloc :: MemLoc
</span><a href="#local-6989586621684545058"><span class="hs-identifier hs-var">srcloc</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.CodeGen.ImpGen.html#MemLoc"><span class="hs-identifier hs-type">MemLoc</span></a></span><span> </span><span id="local-6989586621684545057"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545057"><span class="hs-identifier hs-var">srcmem</span></a></span></span><span> </span><span id="local-6989586621684545056"><span class="annot"><span class="annottext">[DimSize]
</span><a href="#local-6989586621684545056"><span class="hs-identifier hs-var">srcshape</span></a></span></span><span> </span><span id="local-6989586621684545055"><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684545055"><span class="hs-identifier hs-var">srcIxFun</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684545054"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545054"><span class="hs-identifier hs-var">destoffset</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684545053"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545053"><span class="hs-identifier hs-var">srcoffset</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684545052"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545052"><span class="hs-identifier hs-var">num_arrays</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684545051"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545051"><span class="hs-identifier hs-var">size_x</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684545050"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545050"><span class="hs-identifier hs-var">size_y</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-273"></span><span>      </span><span class="annot"><span class="annottext">PrimType
-&gt; MemLoc
-&gt; MemLoc
-&gt; Maybe
     (TExp Int64, TExp Int64, TExp Int64, TExp Int64, TExp Int64)
</span><a href="Futhark.CodeGen.ImpGen.html#isMapTransposeCopy"><span class="hs-identifier hs-var">isMapTransposeCopy</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545063"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684545062"><span class="hs-identifier hs-var">destloc</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684545058"><span class="hs-identifier hs-var">srcloc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-274"></span><span>    </span><span id="local-6989586621684545048"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684545048"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; CallKernelGen Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#mapTransposeForType"><span class="hs-identifier hs-var">mapTransposeForType</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545063"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-275"></span><span>    </span><span class="annot"><span class="annottext">Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-276"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; Name -&gt; [Arg] -&gt; Code HostOp
forall a. [VName] -&gt; Name -&gt; [Arg] -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Call"><span class="hs-identifier hs-var">Imp.Call</span></a></span><span>
</span><span id="line-277"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-278"></span><span>        </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684545048"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-279"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#MemArg"><span class="hs-identifier hs-var">Imp.MemArg</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545060"><span class="hs-identifier hs-var">destmem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-280"></span><span>          </span><span class="annot"><span class="annottext">Exp -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#ExpArg"><span class="hs-identifier hs-var">Imp.ExpArg</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Arg) -&gt; Exp -&gt; Arg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545054"><span class="hs-identifier hs-var">destoffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-281"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#MemArg"><span class="hs-identifier hs-var">Imp.MemArg</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545057"><span class="hs-identifier hs-var">srcmem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-282"></span><span>          </span><span class="annot"><span class="annottext">Exp -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#ExpArg"><span class="hs-identifier hs-var">Imp.ExpArg</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Arg) -&gt; Exp -&gt; Arg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545053"><span class="hs-identifier hs-var">srcoffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-283"></span><span>          </span><span class="annot"><span class="annottext">Exp -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#ExpArg"><span class="hs-identifier hs-var">Imp.ExpArg</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Arg) -&gt; Exp -&gt; Arg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545052"><span class="hs-identifier hs-var">num_arrays</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-284"></span><span>          </span><span class="annot"><span class="annottext">Exp -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#ExpArg"><span class="hs-identifier hs-var">Imp.ExpArg</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Arg) -&gt; Exp -&gt; Arg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545051"><span class="hs-identifier hs-var">size_x</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-285"></span><span>          </span><span class="annot"><span class="annottext">Exp -&gt; Arg
</span><a href="Futhark.CodeGen.ImpCode.html#ExpArg"><span class="hs-identifier hs-var">Imp.ExpArg</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Arg) -&gt; Exp -&gt; Arg
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545050"><span class="hs-identifier hs-var">size_y</span></a></span><span>
</span><span id="line-286"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684545042"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545042"><span class="hs-identifier hs-var">bt_size</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TExp Int64
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545063"><span class="hs-identifier hs-var">bt</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-288"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684545040"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545040"><span class="hs-identifier hs-var">destoffset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64) -&gt; TExp Int64 -&gt; Maybe (TExp Int64)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; num -&gt; Maybe num
</span><a href="Futhark.IR.Mem.IxFun.html#linearWithOffset"><span class="hs-identifier hs-var">IxFun.linearWithOffset</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684545059"><span class="hs-identifier hs-var">destIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545042"><span class="hs-identifier hs-var">bt_size</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-289"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684545038"><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545038"><span class="hs-identifier hs-var">srcoffset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64) -&gt; TExp Int64 -&gt; Maybe (TExp Int64)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; num -&gt; Maybe num
</span><a href="Futhark.IR.Mem.IxFun.html#linearWithOffset"><span class="hs-identifier hs-var">IxFun.linearWithOffset</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TExp Int64)
</span><a href="#local-6989586621684545055"><span class="hs-identifier hs-var">srcIxFun</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545042"><span class="hs-identifier hs-var">bt_size</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-290"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684545037"><span class="annot"><span class="annottext">num_elems :: Count Elements (TExp Int64)
</span><a href="#local-6989586621684545037"><span class="hs-identifier hs-var hs-var">num_elems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Elements (TExp Int64)
forall a. a -&gt; Count Elements a
</span><a href="Futhark.CodeGen.ImpCode.html#elements"><span class="hs-identifier hs-var">Imp.elements</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; Count Elements (TExp Int64))
-&gt; TExp Int64 -&gt; Count Elements (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[TExp Int64] -&gt; TExp Int64
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">([TExp Int64] -&gt; TExp Int64) -&gt; [TExp Int64] -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DimSize -&gt; TExp Int64) -&gt; [DimSize] -&gt; [TExp Int64]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DimSize -&gt; TExp Int64
forall a. ToExp a =&gt; a -&gt; TExp Int64
</span><a href="Futhark.CodeGen.ImpGen.html#toInt64Exp"><span class="hs-identifier hs-var">toInt64Exp</span></a></span><span> </span><span class="annot"><span class="annottext">[DimSize]
</span><a href="#local-6989586621684545056"><span class="hs-identifier hs-var">srcshape</span></a></span><span>
</span><span id="line-291"></span><span>    </span><span id="local-6989586621684545034"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684545034"><span class="hs-identifier hs-var">srcspace</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(MemEntry -&gt; Space)
-&gt; ImpM GPUMem HostEnv HostOp MemEntry
-&gt; ImpM GPUMem HostEnv HostOp Space
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM GPUMem HostEnv HostOp MemEntry
forall rep r op. VName -&gt; ImpM rep r op MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier hs-var">lookupMemory</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545057"><span class="hs-identifier hs-var">srcmem</span></a></span><span>
</span><span id="line-292"></span><span>    </span><span id="local-6989586621684545031"><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684545031"><span class="hs-identifier hs-var">destspace</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MemEntry -&gt; Space
</span><a href="Futhark.CodeGen.ImpGen.html#entryMemSpace"><span class="hs-identifier hs-var hs-var">entryMemSpace</span></a></span><span> </span><span class="annot"><span class="annottext">(MemEntry -&gt; Space)
-&gt; ImpM GPUMem HostEnv HostOp MemEntry
-&gt; ImpM GPUMem HostEnv HostOp Space
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; ImpM GPUMem HostEnv HostOp MemEntry
forall rep r op. VName -&gt; ImpM rep r op MemEntry
</span><a href="Futhark.CodeGen.ImpGen.html#lookupMemory"><span class="hs-identifier hs-var">lookupMemory</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545060"><span class="hs-identifier hs-var">destmem</span></a></span><span>
</span><span id="line-293"></span><span>    </span><span class="annot"><span class="annottext">Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall op rep r. Code op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emit"><span class="hs-identifier hs-var">emit</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; Code HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-294"></span><span>      </span><span class="annot"><span class="annottext">VName
-&gt; Count Bytes (TExp Int64)
-&gt; Space
-&gt; VName
-&gt; Count Bytes (TExp Int64)
-&gt; Space
-&gt; Count Bytes (TExp Int64)
-&gt; Code HostOp
forall a.
VName
-&gt; Count Bytes (TExp Int64)
-&gt; Space
-&gt; VName
-&gt; Count Bytes (TExp Int64)
-&gt; Space
-&gt; Count Bytes (TExp Int64)
-&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Copy"><span class="hs-identifier hs-var">Imp.Copy</span></a></span><span>
</span><span id="line-295"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545060"><span class="hs-identifier hs-var">destmem</span></a></span><span>
</span><span id="line-296"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a. a -&gt; Count Bytes a
</span><a href="Futhark.CodeGen.ImpCode.html#bytes"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; Count Bytes (TExp Int64))
-&gt; TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545040"><span class="hs-identifier hs-var">destoffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>        </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684545031"><span class="hs-identifier hs-var">destspace</span></a></span><span>
</span><span id="line-298"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545057"><span class="hs-identifier hs-var">srcmem</span></a></span><span>
</span><span id="line-299"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a. a -&gt; Count Bytes a
</span><a href="Futhark.CodeGen.ImpCode.html#bytes"><span class="hs-identifier hs-var">bytes</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; Count Bytes (TExp Int64))
-&gt; TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TExp Int64 -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684545038"><span class="hs-identifier hs-var">srcoffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>        </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684545034"><span class="hs-identifier hs-var">srcspace</span></a></span><span>
</span><span id="line-301"></span><span>        </span><span class="annot"><span class="annottext">(Count Bytes (TExp Int64) -&gt; Code HostOp)
-&gt; Count Bytes (TExp Int64) -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64)
</span><a href="#local-6989586621684545037"><span class="hs-identifier hs-var">num_elems</span></a></span><span> </span><span class="annot"><span class="annottext">Count Elements (TExp Int64) -&gt; PrimType -&gt; Count Bytes (TExp Int64)
</span><a href="Futhark.CodeGen.ImpCode.html#withElemType"><span class="hs-operator hs-var">`Imp.withElemType`</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545063"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-302"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CopyCompiler GPUMem HostEnv HostOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#sCopy"><span class="hs-identifier hs-var">sCopy</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545063"><span class="hs-identifier hs-var">bt</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684545062"><span class="hs-identifier hs-var">destloc</span></a></span><span> </span><span class="annot"><span class="annottext">MemLoc
</span><a href="#local-6989586621684545058"><span class="hs-identifier hs-var">srcloc</span></a></span><span>
</span><span id="line-303"></span><span>
</span><span id="line-304"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#mapTransposeForType"><span class="hs-identifier hs-type">mapTransposeForType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.Base.html#CallKernelGen"><span class="hs-identifier hs-type">CallKernelGen</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>
</span><span id="line-305"></span><span id="mapTransposeForType"><span class="annot"><span class="annottext">mapTransposeForType :: PrimType -&gt; CallKernelGen Name
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#mapTransposeForType"><span class="hs-identifier hs-var hs-var">mapTransposeForType</span></a></span></span><span> </span><span id="local-6989586621684545027"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545027"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-306"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684545026"><span class="annot"><span class="annottext">fname :: Name
</span><a href="#local-6989586621684545026"><span class="hs-identifier hs-var hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;builtin#&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; String
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#mapTransposeName"><span class="hs-identifier hs-var">mapTransposeName</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545027"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-307"></span><span>
</span><span id="line-308"></span><span>  </span><span id="local-6989586621684545023"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684545023"><span class="hs-identifier hs-var">exists</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; ImpM GPUMem HostEnv HostOp Bool
forall rep r op. Name -&gt; ImpM rep r op Bool
</span><a href="Futhark.CodeGen.ImpGen.html#hasFunction"><span class="hs-identifier hs-var">hasFunction</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684545026"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><span class="annottext">Bool
-&gt; ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684545023"><span class="hs-identifier hs-var">exists</span></a></span><span> </span><span class="annot"><span class="annottext">(ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; ImpM GPUMem HostEnv HostOp () -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Function HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall op rep r. Name -&gt; Function op -&gt; ImpM rep r op ()
</span><a href="Futhark.CodeGen.ImpGen.html#emitFunction"><span class="hs-identifier hs-var">emitFunction</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684545026"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="annot"><span class="annottext">(Function HostOp -&gt; ImpM GPUMem HostEnv HostOp ())
-&gt; Function HostOp -&gt; ImpM GPUMem HostEnv HostOp ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; Function HostOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#mapTransposeFunction"><span class="hs-identifier hs-var">mapTransposeFunction</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545027"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-310"></span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><span class="annottext">Name -&gt; CallKernelGen Name
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684545026"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-312"></span><span>
</span><span id="line-313"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#mapTransposeName"><span class="hs-identifier hs-type">mapTransposeName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span>
</span><span id="line-314"></span><span id="mapTransposeName"><span class="annot"><span class="annottext">mapTransposeName :: PrimType -&gt; String
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#mapTransposeName"><span class="hs-identifier hs-var hs-var">mapTransposeName</span></a></span></span><span> </span><span id="local-6989586621684545018"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545018"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;gpu_map_transpose_&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; String -&gt; String
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545018"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span class="annot"><a href="Futhark.CodeGen.ImpGen.GPU.html#mapTransposeFunction"><span class="hs-identifier hs-type">mapTransposeFunction</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Primitive.html#PrimType"><span class="hs-identifier hs-type">PrimType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.CodeGen.ImpCode.GPU.html#Function"><span class="hs-identifier hs-type">Imp.Function</span></a></span><span>
</span><span id="line-317"></span><span id="mapTransposeFunction"><span class="annot"><span class="annottext">mapTransposeFunction :: PrimType -&gt; Function HostOp
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#mapTransposeFunction"><span class="hs-identifier hs-var hs-var">mapTransposeFunction</span></a></span></span><span> </span><span id="local-6989586621684545016"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545016"><span class="hs-identifier hs-var">bt</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-318"></span><span>  </span><span class="annot"><span class="annottext">Maybe Name
-&gt; [Param]
-&gt; [Param]
-&gt; Code HostOp
-&gt; [ExternalValue]
-&gt; [(Name, ExternalValue)]
-&gt; Function HostOp
forall a.
Maybe Name
-&gt; [Param]
-&gt; [Param]
-&gt; Code a
-&gt; [ExternalValue]
-&gt; [(Name, ExternalValue)]
-&gt; FunctionT a
</span><a href="Futhark.CodeGen.ImpCode.html#Function"><span class="hs-identifier hs-var">Imp.Function</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Name
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Param]
</span><a href="#local-6989586621684545014"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">Code HostOp
</span><a href="#local-6989586621684545013"><span class="hs-identifier hs-var">transpose_code</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-319"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-320"></span><span>    </span><span id="local-6989586621684545014"><span class="annot"><span class="annottext">params :: [Param]
</span><a href="#local-6989586621684545014"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-321"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Param
</span><a href="#local-6989586621684545012"><span class="hs-identifier hs-var">memparam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545011"><span class="hs-identifier hs-var">destmem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-322"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; Param
</span><a href="#local-6989586621684545010"><span class="hs-identifier hs-var">intparam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545009"><span class="hs-identifier hs-var">destoffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-323"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; Param
</span><a href="#local-6989586621684545012"><span class="hs-identifier hs-var">memparam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545008"><span class="hs-identifier hs-var">srcmem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-324"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; Param
</span><a href="#local-6989586621684545010"><span class="hs-identifier hs-var">intparam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545007"><span class="hs-identifier hs-var">srcoffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-325"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; Param
</span><a href="#local-6989586621684545010"><span class="hs-identifier hs-var">intparam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545006"><span class="hs-identifier hs-var">num_arrays</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-326"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; Param
</span><a href="#local-6989586621684545010"><span class="hs-identifier hs-var">intparam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545005"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-327"></span><span>        </span><span class="annot"><span class="annottext">VName -&gt; Param
</span><a href="#local-6989586621684545010"><span class="hs-identifier hs-var">intparam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545004"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-328"></span><span>      </span><span class="hs-special">]</span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span>    </span><span id="local-6989586621684545003"><span class="annot"><span class="annottext">space :: Space
</span><a href="#local-6989586621684545003"><span class="hs-identifier hs-var hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Space
</span><a href="Futhark.IR.Syntax.Core.html#Space"><span class="hs-identifier hs-var">Space</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;device&quot;</span></span><span>
</span><span id="line-331"></span><span>    </span><span id="local-6989586621684545012"><span class="annot"><span class="annottext">memparam :: VName -&gt; Param
</span><a href="#local-6989586621684545012"><span class="hs-identifier hs-var hs-var">memparam</span></a></span></span><span> </span><span id="local-6989586621684545002"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545002"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Space -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#MemParam"><span class="hs-identifier hs-var">Imp.MemParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545002"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684545003"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-332"></span><span>    </span><span id="local-6989586621684545010"><span class="annot"><span class="annottext">intparam :: VName -&gt; Param
</span><a href="#local-6989586621684545010"><span class="hs-identifier hs-var hs-var">intparam</span></a></span></span><span> </span><span id="local-6989586621684545000"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545000"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; PrimType -&gt; Param
</span><a href="Futhark.CodeGen.ImpCode.html#ScalarParam"><span class="hs-identifier hs-var">Imp.ScalarParam</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545000"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; Param) -&gt; PrimType -&gt; Param
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span>
</span><span id="line-333"></span><span>
</span><span id="line-334"></span><span>    </span><span class="hs-special">[</span><span> </span><span id="local-6989586621684545011"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545011"><span class="hs-identifier hs-var">destmem</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-335"></span><span>      </span><span id="local-6989586621684545009"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545009"><span class="hs-identifier hs-var">destoffset</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-336"></span><span>      </span><span id="local-6989586621684545008"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545008"><span class="hs-identifier hs-var">srcmem</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-337"></span><span>      </span><span id="local-6989586621684545007"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545007"><span class="hs-identifier hs-var">srcoffset</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-338"></span><span>      </span><span id="local-6989586621684545006"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545006"><span class="hs-identifier hs-var">num_arrays</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-339"></span><span>      </span><span id="local-6989586621684545005"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545005"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-340"></span><span>      </span><span id="local-6989586621684545004"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545004"><span class="hs-identifier hs-var">y</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-341"></span><span>      </span><span id="local-6989586621684544994"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684544994"><span class="hs-identifier hs-var">mulx</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-342"></span><span>      </span><span id="local-6989586621684544993"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684544993"><span class="hs-identifier hs-var">muly</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-343"></span><span>      </span><span id="local-6989586621684544992"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684544992"><span class="hs-identifier hs-var">block</span></a></span></span><span>
</span><span id="line-344"></span><span>      </span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-345"></span><span>        </span><span class="annot"><span class="annottext">(String -&gt; Int -&gt; VName) -&gt; [String] -&gt; [Int] -&gt; [VName]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span>
</span><span id="line-346"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Int -&gt; VName
</span><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-var">VName</span></a></span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Int -&gt; VName)
-&gt; (String -&gt; Name) -&gt; String -&gt; Int -&gt; VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;destmem&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-348"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;destoffset&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-349"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;srcmem&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-350"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;srcoffset&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-351"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;num_arrays&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-352"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;x_elems&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-353"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;y_elems&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-354"></span><span>            </span><span class="hs-comment">-- The following is only used for low width/height</span><span>
</span><span id="line-355"></span><span>            </span><span class="hs-comment">-- transpose kernels</span><span>
</span><span id="line-356"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;mulx&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-357"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;muly&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-358"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;block&quot;</span></span><span>
</span><span id="line-359"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-360"></span><span>          </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-361"></span><span>
</span><span id="line-362"></span><span>    </span><span id="local-6989586621684544987"><span class="annot"><span class="annottext">block_dim_int :: Integer
</span><a href="#local-6989586621684544987"><span class="hs-identifier hs-var hs-var">block_dim_int</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">16</span></span><span>
</span><span id="line-363"></span><span>
</span><span id="line-364"></span><span>    </span><span id="local-6989586621684545573"><span class="annot"><a href="#local-6989586621684544986"><span class="hs-identifier hs-type">block_dim</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684545573"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684545573"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-365"></span><span>    </span><span id="local-6989586621684544986"><span class="annot"><span class="annottext">block_dim :: forall a. IntegralExp a =&gt; a
</span><a href="#local-6989586621684544986"><span class="hs-identifier hs-var hs-var">block_dim</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">16</span></span><span>
</span><span id="line-366"></span><span>
</span><span id="line-367"></span><span>    </span><span class="hs-comment">-- When an input array has either width==1 or height==1, performing a</span><span>
</span><span id="line-368"></span><span>    </span><span class="hs-comment">-- transpose will be the same as performing a copy.</span><span>
</span><span id="line-369"></span><span>    </span><span id="local-6989586621684544982"><span class="annot"><span class="annottext">can_use_copy :: TExp Bool
</span><a href="#local-6989586621684544982"><span class="hs-identifier hs-var hs-var">can_use_copy</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-370"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684544978"><span class="annot"><span class="annottext">onearr :: TExp Bool
</span><a href="#local-6989586621684544978"><span class="hs-identifier hs-var hs-var">onearr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545006"><span class="hs-identifier hs-var">num_arrays</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TPrimExp Int32 VName -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
</span><span class="hs-number">1</span></span><span>
</span><span id="line-371"></span><span>          </span><span id="local-6989586621684544972"><span class="annot"><span class="annottext">height_is_one :: TExp Bool
</span><a href="#local-6989586621684544972"><span class="hs-identifier hs-var hs-var">height_is_one</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545004"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TPrimExp Int32 VName -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
</span><span class="hs-number">1</span></span><span>
</span><span id="line-372"></span><span>          </span><span id="local-6989586621684544968"><span class="annot"><span class="annottext">width_is_one :: TExp Bool
</span><a href="#local-6989586621684544968"><span class="hs-identifier hs-var hs-var">width_is_one</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545005"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TPrimExp Int32 VName -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
</span><span class="hs-number">1</span></span><span>
</span><span id="line-373"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684544978"><span class="hs-identifier hs-var">onearr</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684544968"><span class="hs-identifier hs-var">width_is_one</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%7C%7C."><span class="hs-operator hs-var">.||.</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684544972"><span class="hs-identifier hs-var">height_is_one</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-374"></span><span>
</span><span id="line-375"></span><span>    </span><span id="local-6989586621684545013"><span class="annot"><span class="annottext">transpose_code :: Code HostOp
</span><a href="#local-6989586621684545013"><span class="hs-identifier hs-var hs-var">transpose_code</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-376"></span><span>      </span><span class="annot"><span class="annottext">TExp Bool -&gt; Code HostOp -&gt; Code HostOp -&gt; Code HostOp
forall a. TExp Bool -&gt; Code a -&gt; Code a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#If"><span class="hs-identifier hs-var">Imp.If</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684544966"><span class="hs-identifier hs-var">input_is_empty</span></a></span><span> </span><span class="annot"><span class="annottext">Code HostOp
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; Code HostOp) -&gt; Code HostOp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-377"></span><span>        </span><span class="annot"><span class="annottext">[Code HostOp] -&gt; Code HostOp
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span>
</span><span id="line-378"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Volatility -&gt; PrimType -&gt; Code HostOp
forall a. VName -&gt; Volatility -&gt; PrimType -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DeclareScalar"><span class="hs-identifier hs-var">Imp.DeclareScalar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684544993"><span class="hs-identifier hs-var">muly</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="Futhark.CodeGen.ImpCode.html#Nonvolatile"><span class="hs-identifier hs-var">Imp.Nonvolatile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-379"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; Exp -&gt; Code HostOp
forall a. VName -&gt; Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#SetScalar"><span class="hs-identifier hs-var">Imp.SetScalar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684544993"><span class="hs-identifier hs-var">muly</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Code HostOp) -&gt; Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int32 VName -&gt; Exp) -&gt; TPrimExp Int32 VName -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
forall a. IntegralExp a =&gt; a
</span><a href="#local-6989586621684544986"><span class="hs-identifier hs-var">block_dim</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
-&gt; TPrimExp Int32 VName -&gt; TPrimExp Int32 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545005"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-380"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; Volatility -&gt; PrimType -&gt; Code HostOp
forall a. VName -&gt; Volatility -&gt; PrimType -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#DeclareScalar"><span class="hs-identifier hs-var">Imp.DeclareScalar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684544994"><span class="hs-identifier hs-var">mulx</span></a></span><span> </span><span class="annot"><span class="annottext">Volatility
</span><a href="Futhark.CodeGen.ImpCode.html#Nonvolatile"><span class="hs-identifier hs-var">Imp.Nonvolatile</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Futhark.IR.Primitive.html#IntType"><span class="hs-identifier hs-var">IntType</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int32"><span class="hs-identifier hs-var">Int32</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-381"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; Exp -&gt; Code HostOp
forall a. VName -&gt; Exp -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#SetScalar"><span class="hs-identifier hs-var">Imp.SetScalar</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684544994"><span class="hs-identifier hs-var">mulx</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; Code HostOp) -&gt; Exp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; Exp
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int32 VName -&gt; Exp) -&gt; TPrimExp Int32 VName -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
forall a. IntegralExp a =&gt; a
</span><a href="#local-6989586621684544986"><span class="hs-identifier hs-var">block_dim</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
-&gt; TPrimExp Int32 VName -&gt; TPrimExp Int32 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545004"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-382"></span><span>            </span><span class="annot"><span class="annottext">TExp Bool -&gt; Code HostOp -&gt; Code HostOp -&gt; Code HostOp
forall a. TExp Bool -&gt; Code a -&gt; Code a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#If"><span class="hs-identifier hs-var">Imp.If</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684544982"><span class="hs-identifier hs-var">can_use_copy</span></a></span><span> </span><span class="annot"><span class="annottext">Code HostOp
</span><a href="#local-6989586621684544962"><span class="hs-identifier hs-var">copy_code</span></a></span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; Code HostOp) -&gt; Code HostOp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-383"></span><span>              </span><span class="annot"><span class="annottext">TExp Bool -&gt; Code HostOp -&gt; Code HostOp -&gt; Code HostOp
forall a. TExp Bool -&gt; Code a -&gt; Code a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#If"><span class="hs-identifier hs-var">Imp.If</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684544961"><span class="hs-identifier hs-var">should_use_lowwidth</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransposeType -&gt; Code HostOp
</span><a href="#local-6989586621684544960"><span class="hs-identifier hs-var">callTransposeKernel</span></a></span><span> </span><span class="annot"><span class="annottext">TransposeType
</span><a href="Futhark.CodeGen.ImpGen.GPU.Transpose.html#TransposeLowWidth"><span class="hs-identifier hs-var">TransposeLowWidth</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; Code HostOp) -&gt; Code HostOp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-384"></span><span>                </span><span class="annot"><span class="annottext">TExp Bool -&gt; Code HostOp -&gt; Code HostOp -&gt; Code HostOp
forall a. TExp Bool -&gt; Code a -&gt; Code a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#If"><span class="hs-identifier hs-var">Imp.If</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684544958"><span class="hs-identifier hs-var">should_use_lowheight</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransposeType -&gt; Code HostOp
</span><a href="#local-6989586621684544960"><span class="hs-identifier hs-var">callTransposeKernel</span></a></span><span> </span><span class="annot"><span class="annottext">TransposeType
</span><a href="Futhark.CodeGen.ImpGen.GPU.Transpose.html#TransposeLowHeight"><span class="hs-identifier hs-var">TransposeLowHeight</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; Code HostOp) -&gt; Code HostOp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-385"></span><span>                  </span><span class="annot"><span class="annottext">TExp Bool -&gt; Code HostOp -&gt; Code HostOp -&gt; Code HostOp
forall a. TExp Bool -&gt; Code a -&gt; Code a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#If"><span class="hs-identifier hs-var">Imp.If</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Bool
</span><a href="#local-6989586621684544956"><span class="hs-identifier hs-var">should_use_small</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TransposeType -&gt; Code HostOp
</span><a href="#local-6989586621684544960"><span class="hs-identifier hs-var">callTransposeKernel</span></a></span><span> </span><span class="annot"><span class="annottext">TransposeType
</span><a href="Futhark.CodeGen.ImpGen.GPU.Transpose.html#TransposeSmall"><span class="hs-identifier hs-var">TransposeSmall</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Code HostOp -&gt; Code HostOp) -&gt; Code HostOp -&gt; Code HostOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-386"></span><span>                    </span><span class="annot"><span class="annottext">TransposeType -&gt; Code HostOp
</span><a href="#local-6989586621684544960"><span class="hs-identifier hs-var">callTransposeKernel</span></a></span><span> </span><span class="annot"><span class="annottext">TransposeType
</span><a href="Futhark.CodeGen.ImpGen.GPU.Transpose.html#TransposeNormal"><span class="hs-identifier hs-var">TransposeNormal</span></a></span><span>
</span><span id="line-387"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-388"></span><span>
</span><span id="line-389"></span><span>    </span><span id="local-6989586621684544966"><span class="annot"><span class="annottext">input_is_empty :: TExp Bool
</span><a href="#local-6989586621684544966"><span class="hs-identifier hs-var hs-var">input_is_empty</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-390"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545006"><span class="hs-identifier hs-var">num_arrays</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TPrimExp Int32 VName -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%7C%7C."><span class="hs-operator hs-var">.||.</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545005"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TPrimExp Int32 VName -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%7C%7C."><span class="hs-operator hs-var">.||.</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545004"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TPrimExp Int32 VName -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3D%3D."><span class="hs-operator hs-var">.==.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
</span><span class="hs-number">0</span></span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span>    </span><span id="local-6989586621684544956"><span class="annot"><span class="annottext">should_use_small :: TExp Bool
</span><a href="#local-6989586621684544956"><span class="hs-identifier hs-var hs-var">should_use_small</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-393"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545005"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TPrimExp Int32 VName -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C%3D."><span class="hs-operator hs-var">.&lt;=.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int32 VName
forall a. IntegralExp a =&gt; a
</span><a href="#local-6989586621684544986"><span class="hs-identifier hs-var">block_dim</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
-&gt; TPrimExp Int32 VName -&gt; TPrimExp Int32 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span>
</span><span id="line-394"></span><span>        </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545004"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TPrimExp Int32 VName -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C%3D."><span class="hs-operator hs-var">.&lt;=.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int32 VName
forall a. IntegralExp a =&gt; a
</span><a href="#local-6989586621684544986"><span class="hs-identifier hs-var">block_dim</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
-&gt; TPrimExp Int32 VName -&gt; TPrimExp Int32 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span>
</span><span id="line-395"></span><span>
</span><span id="line-396"></span><span>    </span><span id="local-6989586621684544961"><span class="annot"><span class="annottext">should_use_lowwidth :: TExp Bool
</span><a href="#local-6989586621684544961"><span class="hs-identifier hs-var hs-var">should_use_lowwidth</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-397"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545005"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TPrimExp Int32 VName -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C%3D."><span class="hs-operator hs-var">.&lt;=.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int32 VName
forall a. IntegralExp a =&gt; a
</span><a href="#local-6989586621684544986"><span class="hs-identifier hs-var">block_dim</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
-&gt; TPrimExp Int32 VName -&gt; TPrimExp Int32 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span>        </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
forall a. IntegralExp a =&gt; a
</span><a href="#local-6989586621684544986"><span class="hs-identifier hs-var">block_dim</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TPrimExp Int32 VName -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545004"><span class="hs-identifier hs-var">y</span></a></span><span>
</span><span id="line-399"></span><span>
</span><span id="line-400"></span><span>    </span><span id="local-6989586621684544958"><span class="annot"><span class="annottext">should_use_lowheight :: TExp Bool
</span><a href="#local-6989586621684544958"><span class="hs-identifier hs-var hs-var">should_use_lowheight</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-401"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545004"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TPrimExp Int32 VName -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C%3D."><span class="hs-operator hs-var">.&lt;=.</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp Int32 VName
forall a. IntegralExp a =&gt; a
</span><a href="#local-6989586621684544986"><span class="hs-identifier hs-var">block_dim</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
-&gt; TPrimExp Int32 VName -&gt; TPrimExp Int32 VName
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#quot"><span class="hs-operator hs-var">`quot`</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
</span><span class="hs-number">2</span></span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>        </span><span class="annot"><span class="annottext">TExp Bool -&gt; TExp Bool -&gt; TExp Bool
forall v. TPrimExp Bool v -&gt; TPrimExp Bool v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%26%26."><span class="hs-operator hs-var">.&amp;&amp;.</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
forall a. IntegralExp a =&gt; a
</span><a href="#local-6989586621684544986"><span class="hs-identifier hs-var">block_dim</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TPrimExp Int32 VName -&gt; TExp Bool
forall t v. TPrimExp t v -&gt; TPrimExp t v -&gt; TPrimExp Bool v
</span><a href="Futhark.Analysis.PrimExp.html#.%3C."><span class="hs-operator hs-var">.&lt;.</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545005"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span>    </span><span id="local-6989586621684544962"><span class="annot"><span class="annottext">copy_code :: Code HostOp
</span><a href="#local-6989586621684544962"><span class="hs-identifier hs-var hs-var">copy_code</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-405"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684544924"><span class="annot"><span class="annottext">num_bytes :: TExp Int64
</span><a href="#local-6989586621684544924"><span class="hs-identifier hs-var hs-var">num_bytes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int32 VName -&gt; TExp Int64)
-&gt; TPrimExp Int32 VName -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545005"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
-&gt; TPrimExp Int32 VName -&gt; TPrimExp Int32 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545004"><span class="hs-identifier hs-var">y</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName
-&gt; TPrimExp Int32 VName -&gt; TPrimExp Int32 VName
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; TPrimExp Int32 VName
forall a. Num a =&gt; PrimType -&gt; a
</span><a href="Futhark.IR.Primitive.html#primByteSize"><span class="hs-identifier hs-var">primByteSize</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545016"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-406"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; Count Bytes (TExp Int64)
-&gt; Space
-&gt; VName
-&gt; Count Bytes (TExp Int64)
-&gt; Space
-&gt; Count Bytes (TExp Int64)
-&gt; Code HostOp
forall a.
VName
-&gt; Count Bytes (TExp Int64)
-&gt; Space
-&gt; VName
-&gt; Count Bytes (TExp Int64)
-&gt; Space
-&gt; Count Bytes (TExp Int64)
-&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Copy"><span class="hs-identifier hs-var">Imp.Copy</span></a></span><span>
</span><span id="line-407"></span><span>            </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545011"><span class="hs-identifier hs-var">destmem</span></a></span><span>
</span><span id="line-408"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Bytes (TExp Int64)
forall u e. e -&gt; Count u e
</span><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-var">Imp.Count</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; Count Bytes (TExp Int64))
-&gt; TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int32 VName -&gt; TExp Int64)
-&gt; TPrimExp Int32 VName -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545009"><span class="hs-identifier hs-var">destoffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-409"></span><span>            </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684545003"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-410"></span><span>            </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545008"><span class="hs-identifier hs-var">srcmem</span></a></span><span>
</span><span id="line-411"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Bytes (TExp Int64)
forall u e. e -&gt; Count u e
</span><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-var">Imp.Count</span></a></span><span> </span><span class="annot"><span class="annottext">(TExp Int64 -&gt; Count Bytes (TExp Int64))
-&gt; TExp Int64 -&gt; Count Bytes (TExp Int64)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp Int32 VName -&gt; TExp Int64
forall t v. IntExp t =&gt; TPrimExp t v -&gt; TPrimExp Int64 v
</span><a href="Futhark.Analysis.PrimExp.html#sExt64"><span class="hs-identifier hs-var">sExt64</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp Int32 VName -&gt; TExp Int64)
-&gt; TPrimExp Int32 VName -&gt; TExp Int64
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545007"><span class="hs-identifier hs-var">srcoffset</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-412"></span><span>            </span><span class="annot"><span class="annottext">Space
</span><a href="#local-6989586621684545003"><span class="hs-identifier hs-var">space</span></a></span><span>
</span><span id="line-413"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TExp Int64 -&gt; Count Bytes (TExp Int64)
forall u e. e -&gt; Count u e
</span><a href="Futhark.IR.GPU.Sizes.html#Count"><span class="hs-identifier hs-var">Imp.Count</span></a></span><span> </span><span class="annot"><span class="annottext">TExp Int64
</span><a href="#local-6989586621684544924"><span class="hs-identifier hs-var">num_bytes</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-414"></span><span>
</span><span id="line-415"></span><span>    </span><span id="local-6989586621684544960"><span class="annot"><span class="annottext">callTransposeKernel :: TransposeType -&gt; Code HostOp
</span><a href="#local-6989586621684544960"><span class="hs-identifier hs-var hs-var">callTransposeKernel</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-416"></span><span>      </span><span class="annot"><span class="annottext">HostOp -&gt; Code HostOp
forall a. a -&gt; Code a
</span><a href="Futhark.CodeGen.ImpCode.html#Op"><span class="hs-identifier hs-var">Imp.Op</span></a></span><span> </span><span class="annot"><span class="annottext">(HostOp -&gt; Code HostOp)
-&gt; (TransposeType -&gt; HostOp) -&gt; TransposeType -&gt; Code HostOp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Kernel -&gt; HostOp
</span><a href="Futhark.CodeGen.ImpCode.GPU.html#CallKernel"><span class="hs-identifier hs-var">Imp.CallKernel</span></a></span><span>
</span><span id="line-417"></span><span>        </span><span class="annot"><span class="annottext">(Kernel -&gt; HostOp)
-&gt; (TransposeType -&gt; Kernel) -&gt; TransposeType -&gt; HostOp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; Integer -&gt; TransposeArgs -&gt; PrimType -&gt; TransposeType -&gt; Kernel
</span><a href="Futhark.CodeGen.ImpGen.GPU.Transpose.html#mapTransposeKernel"><span class="hs-identifier hs-var">mapTransposeKernel</span></a></span><span>
</span><span id="line-418"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; String
</span><a href="Futhark.CodeGen.ImpGen.GPU.html#mapTransposeName"><span class="hs-identifier hs-var">mapTransposeName</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545016"><span class="hs-identifier hs-var">bt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-419"></span><span>          </span><span class="annot"><span class="annottext">Integer
</span><a href="#local-6989586621684544987"><span class="hs-identifier hs-var">block_dim_int</span></a></span><span>
</span><span id="line-420"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545011"><span class="hs-identifier hs-var">destmem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-421"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545009"><span class="hs-identifier hs-var">destoffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-422"></span><span>            </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545008"><span class="hs-identifier hs-var">srcmem</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-423"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545007"><span class="hs-identifier hs-var">srcoffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-424"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545005"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-425"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545004"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-426"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684544994"><span class="hs-identifier hs-var">mulx</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-427"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684544993"><span class="hs-identifier hs-var">muly</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-428"></span><span>            </span><span class="annot"><span class="annottext">VName -&gt; TPrimExp Int32 VName
forall a. a -&gt; TPrimExp Int32 a
</span><a href="Futhark.Analysis.PrimExp.Convert.html#le32"><span class="hs-identifier hs-var">Imp.le32</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684545006"><span class="hs-identifier hs-var">num_arrays</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-429"></span><span>            </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684544992"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-430"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>          </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684545016"><span class="hs-identifier hs-var">bt</span></a></span><span>
</span><span id="line-432"></span></pre></body></html>