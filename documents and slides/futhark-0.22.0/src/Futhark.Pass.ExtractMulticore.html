<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-comment">-- | Extraction of parallelism from a SOACs program.  This generates</span><span>
</span><span id="line-7"></span><span class="hs-comment">-- parallel constructs aimed at CPU execution, which in particular may</span><span>
</span><span id="line-8"></span><span class="hs-comment">-- involve ad-hoc irregular nested parallelism.</span><span>
</span><span id="line-9"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Pass.ExtractMulticore</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#extractMulticore"><span class="hs-identifier">extractMulticore</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-10"></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Identity</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bitraversable</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.Rephrase.html"><span class="hs-identifier">Futhark.Analysis.Rephrase</span></a></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.html"><span class="hs-identifier">Futhark.IR</span></a></span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.MC.html"><span class="hs-identifier">Futhark.IR.MC</span></a></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.MC.html"><span class="hs-identifier">Futhark.IR.MC</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">MC</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html"><span class="hs-identifier">Futhark.IR.SOACS</span></a></span><span> </span><span class="hs-keyword">hiding</span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#Body"><span class="hs-identifier">Body</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.html#Exp"><span class="hs-identifier">Exp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.html#LParam"><span class="hs-identifier">LParam</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.html#Lambda"><span class="hs-identifier">Lambda</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.html#Pat"><span class="hs-identifier">Pat</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Futhark.IR.SOACS.html#Stm"><span class="hs-identifier">Stm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html"><span class="hs-identifier">Futhark.IR.SOACS</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SOACS</span></span><span>
</span><span id="line-28"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.Simplify.html"><span class="hs-identifier">Futhark.IR.SOACS.Simplify</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SOACS</span></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.html"><span class="hs-identifier">Futhark.Pass</span></a></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.DistributeNests.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.DistributeNests</span></a></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractKernels.ToGPU.html"><span class="hs-identifier">Futhark.Pass.ExtractKernels.ToGPU</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Pass.ExtractKernels.ToGPU.html#injectSOACS"><span class="hs-identifier">injectSOACS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Tools.html"><span class="hs-identifier">Futhark.Tools</span></a></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Transform.FirstOrderTransform.html"><span class="hs-identifier">Futhark.Transform.FirstOrderTransform</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">FOT</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html"><span class="hs-identifier">Futhark.Transform.Rename</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Transform.Rename.html#Rename"><span class="hs-identifier">Rename</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html#renameSomething"><span class="hs-identifier">renameSomething</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.html"><span class="hs-identifier">Futhark.Util</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.html#takeLast"><span class="hs-identifier">takeLast</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.Log.html"><span class="hs-identifier">Futhark.Util.Log</span></a></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-keyword">newtype</span><span> </span><span id="ExtractM"><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-var">ExtractM</span></a></span></span><span> </span><span id="local-6989586621684419586"><span class="annot"><a href="#local-6989586621684419586"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="ExtractM"><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-var">ExtractM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Prop.Scope.html#Scope"><span class="hs-identifier hs-type">Scope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684419586"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-40"></span><span>    </span><span class="hs-special">(</span><span> </span><span id="local-6989586621684419577"><span id="local-6989586621684419583"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; ExtractM a -&gt; ExtractM b)
-&gt; (forall a b. a -&gt; ExtractM b -&gt; ExtractM a) -&gt; Functor ExtractM
forall a b. a -&gt; ExtractM b -&gt; ExtractM a
forall a b. (a -&gt; b) -&gt; ExtractM a -&gt; ExtractM b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: forall a b. a -&gt; ExtractM b -&gt; ExtractM a
$c&lt;$ :: forall a b. a -&gt; ExtractM b -&gt; ExtractM a
fmap :: forall a b. (a -&gt; b) -&gt; ExtractM a -&gt; ExtractM b
$cfmap :: forall a b. (a -&gt; b) -&gt; ExtractM a -&gt; ExtractM b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>      </span><span id="local-6989586621684419547"><span id="local-6989586621684419552"><span id="local-6989586621684419557"><span id="local-6989586621684419562"><span id="local-6989586621684419568"><span class="annot"><span class="annottext">Functor ExtractM
Functor ExtractM
-&gt; (forall a. a -&gt; ExtractM a)
-&gt; (forall a b. ExtractM (a -&gt; b) -&gt; ExtractM a -&gt; ExtractM b)
-&gt; (forall a b c.
    (a -&gt; b -&gt; c) -&gt; ExtractM a -&gt; ExtractM b -&gt; ExtractM c)
-&gt; (forall a b. ExtractM a -&gt; ExtractM b -&gt; ExtractM b)
-&gt; (forall a b. ExtractM a -&gt; ExtractM b -&gt; ExtractM a)
-&gt; Applicative ExtractM
forall a. a -&gt; ExtractM a
forall a b. ExtractM a -&gt; ExtractM b -&gt; ExtractM a
forall a b. ExtractM a -&gt; ExtractM b -&gt; ExtractM b
forall a b. ExtractM (a -&gt; b) -&gt; ExtractM a -&gt; ExtractM b
forall a b c.
(a -&gt; b -&gt; c) -&gt; ExtractM a -&gt; ExtractM b -&gt; ExtractM c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: forall a b. ExtractM a -&gt; ExtractM b -&gt; ExtractM a
$c&lt;* :: forall a b. ExtractM a -&gt; ExtractM b -&gt; ExtractM a
*&gt; :: forall a b. ExtractM a -&gt; ExtractM b -&gt; ExtractM b
$c*&gt; :: forall a b. ExtractM a -&gt; ExtractM b -&gt; ExtractM b
liftA2 :: forall a b c.
(a -&gt; b -&gt; c) -&gt; ExtractM a -&gt; ExtractM b -&gt; ExtractM c
$cliftA2 :: forall a b c.
(a -&gt; b -&gt; c) -&gt; ExtractM a -&gt; ExtractM b -&gt; ExtractM c
&lt;*&gt; :: forall a b. ExtractM (a -&gt; b) -&gt; ExtractM a -&gt; ExtractM b
$c&lt;*&gt; :: forall a b. ExtractM (a -&gt; b) -&gt; ExtractM a -&gt; ExtractM b
pure :: forall a. a -&gt; ExtractM a
$cpure :: forall a. a -&gt; ExtractM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span>      </span><span id="local-6989586621684419527"><span id="local-6989586621684419532"><span id="local-6989586621684419538"><span class="annot"><span class="annottext">Applicative ExtractM
Applicative ExtractM
-&gt; (forall a b. ExtractM a -&gt; (a -&gt; ExtractM b) -&gt; ExtractM b)
-&gt; (forall a b. ExtractM a -&gt; ExtractM b -&gt; ExtractM b)
-&gt; (forall a. a -&gt; ExtractM a)
-&gt; Monad ExtractM
forall a. a -&gt; ExtractM a
forall a b. ExtractM a -&gt; ExtractM b -&gt; ExtractM b
forall a b. ExtractM a -&gt; (a -&gt; ExtractM b) -&gt; ExtractM b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: forall a. a -&gt; ExtractM a
$creturn :: forall a. a -&gt; ExtractM a
&gt;&gt; :: forall a b. ExtractM a -&gt; ExtractM b -&gt; ExtractM b
$c&gt;&gt; :: forall a b. ExtractM a -&gt; ExtractM b -&gt; ExtractM b
&gt;&gt;= :: forall a b. ExtractM a -&gt; (a -&gt; ExtractM b) -&gt; ExtractM b
$c&gt;&gt;= :: forall a b. ExtractM a -&gt; (a -&gt; ExtractM b) -&gt; ExtractM b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-43"></span><span>      </span><span id="local-6989586621684419494"><span id="local-6989586621684419501"><span id="local-6989586621684419508"><span id="local-6989586621684419515"><span class="annot"><a href="Futhark.IR.Prop.Scope.html#HasScope"><span class="hs-identifier hs-type">HasScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-44"></span><span>      </span><span id="local-6989586621684419482"><span class="annot"><a href="Futhark.IR.Prop.Scope.html#LocalScope"><span class="hs-identifier hs-type">LocalScope</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span></span><span class="hs-special">,</span><span>
</span><span id="line-45"></span><span>      </span><span id="local-6989586621684419464"><span id="local-6989586621684419469"><span class="annot"><span class="annottext">Monad ExtractM
Applicative ExtractM
ExtractM VNameSource
Applicative ExtractM
-&gt; Monad ExtractM
-&gt; ExtractM VNameSource
-&gt; (VNameSource -&gt; ExtractM ())
-&gt; MonadFreshNames ExtractM
VNameSource -&gt; ExtractM ()
forall (m :: * -&gt; *).
Applicative m
-&gt; Monad m
-&gt; m VNameSource
-&gt; (VNameSource -&gt; m ())
-&gt; MonadFreshNames m
putNameSource :: VNameSource -&gt; ExtractM ()
$cputNameSource :: VNameSource -&gt; ExtractM ()
getNameSource :: ExtractM VNameSource
$cgetNameSource :: ExtractM VNameSource
</span><a href="Futhark.MonadFreshNames.html#C%3AMonadFreshNames"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">MonadFreshNames</span></a></span></span></span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-comment">-- XXX: throwing away the log here...</span><span>
</span><span id="line-49"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684419453"><span class="annot"><a href="Futhark.Util.Log.html#MonadLogger"><span class="hs-identifier hs-type">MonadLogger</span></a></span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-50"></span><span>  </span><span id="local-6989586621684419449"><span class="annot"><span class="annottext">addLog :: Log -&gt; ExtractM ()
</span><a href="Futhark.Util.Log.html#addLog"><span class="hs-identifier hs-var hs-var hs-var hs-var">addLog</span></a></span></span><span> </span><span class="annot"><span class="annottext">Log
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; ExtractM ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>
</span><span id="line-52"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#indexArray"><span class="hs-identifier hs-type">indexArray</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#LParam"><span class="hs-identifier hs-type">LParam</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span>
</span><span id="line-53"></span><span id="indexArray"><span class="annot"><span class="annottext">indexArray :: VName -&gt; LParam SOACS -&gt; VName -&gt; Stm MC
</span><a href="Futhark.Pass.ExtractMulticore.html#indexArray"><span class="hs-identifier hs-var hs-var">indexArray</span></a></span></span><span> </span><span id="local-6989586621684419446"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419446"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684419444"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419444"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684419443"><span class="annot"><span class="annottext">LParamInfo SOACS
</span><a href="#local-6989586621684419443"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684419442"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419442"><span class="hs-identifier hs-var">arr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-54"></span><span>  </span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatElemT (TypeBase Shape NoUniqueness)]
-&gt; PatT (TypeBase Shape NoUniqueness)
forall dec. [PatElemT dec] -&gt; PatT dec
</span><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-var">Pat</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName
-&gt; TypeBase Shape NoUniqueness
-&gt; PatElemT (TypeBase Shape NoUniqueness)
forall dec. VName -&gt; dec -&gt; PatElemT dec
</span><a href="Futhark.IR.Syntax.Core.html#PatElem"><span class="hs-identifier hs-var">PatElem</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419444"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
LParamInfo SOACS
</span><a href="#local-6989586621684419443"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stm MC) -&gt; (BasicOp -&gt; Exp MC) -&gt; BasicOp -&gt; Stm MC
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp MC
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; Stm MC) -&gt; BasicOp -&gt; Stm MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-55"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LParamInfo SOACS
</span><a href="#local-6989586621684419443"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-56"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Acc"><span class="hs-identifier hs-type">Acc</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419442"><span class="hs-identifier hs-var">arr</span></a></span><span>
</span><span id="line-57"></span><span>      </span><span class="annot"><span class="annottext">LParamInfo SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419442"><span class="hs-identifier hs-var">arr</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice SubExp -&gt; BasicOp) -&gt; Slice SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex SubExp] -&gt; Slice SubExp)
-&gt; [DimIndex SubExp] -&gt; Slice SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; DimIndex SubExp
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419446"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DimIndex SubExp -&gt; [DimIndex SubExp] -&gt; [DimIndex SubExp]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; DimIndex SubExp) -&gt; [SubExp] -&gt; [DimIndex SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; DimIndex SubExp
</span><a href="Futhark.Construct.html#sliceDim"><span class="hs-identifier hs-var">sliceDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; [SubExp]
forall u. TypeBase Shape u -&gt; [SubExp]
</span><a href="Futhark.IR.Prop.Types.html#arrayDims"><span class="hs-identifier hs-var">arrayDims</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
LParamInfo SOACS
</span><a href="#local-6989586621684419443"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#mapLambdaToBody"><span class="hs-identifier hs-type">mapLambdaToBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-60"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-61"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-62"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-63"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span id="mapLambdaToBody"><span class="annot"><span class="annottext">mapLambdaToBody :: (Body SOACS -&gt; ExtractM (Body MC))
-&gt; VName -&gt; Lambda SOACS -&gt; [VName] -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#mapLambdaToBody"><span class="hs-identifier hs-var hs-var">mapLambdaToBody</span></a></span></span><span> </span><span id="local-6989586621684419427"><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="#local-6989586621684419427"><span class="hs-identifier hs-var">onBody</span></a></span></span><span> </span><span id="local-6989586621684419426"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419426"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684419425"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419425"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684419424"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419424"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-66"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684419423"><span class="annot"><span class="annottext">indexings :: [Stm MC]
</span><a href="#local-6989586621684419423"><span class="hs-identifier hs-var hs-var">indexings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Param (TypeBase Shape NoUniqueness) -&gt; VName -&gt; Stm MC)
-&gt; [Param (TypeBase Shape NoUniqueness)] -&gt; [VName] -&gt; [Stm MC]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; LParam SOACS -&gt; VName -&gt; Stm MC
</span><a href="Futhark.Pass.ExtractMulticore.html#indexArray"><span class="hs-identifier hs-var">indexArray</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419426"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419425"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419424"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-67"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684419420"><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419420"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684419419"><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684419419"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Stm MC] -&gt; ExtractM (Body MC) -&gt; ExtractM (Body MC)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm MC]
</span><a href="#local-6989586621684419423"><span class="hs-identifier hs-var">indexings</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtractM (Body MC) -&gt; ExtractM (Body MC))
-&gt; ExtractM (Body MC) -&gt; ExtractM (Body MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="#local-6989586621684419427"><span class="hs-identifier hs-var">onBody</span></a></span><span> </span><span class="annot"><span class="annottext">(Body SOACS -&gt; ExtractM (Body MC))
-&gt; Body SOACS -&gt; ExtractM (Body MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; Body SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419425"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-68"></span><span>  </span><span class="annot"><span class="annottext">Body MC -&gt; ExtractM (Body MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Body MC -&gt; ExtractM (Body MC)) -&gt; Body MC -&gt; ExtractM (Body MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyDec MC -&gt; Stms MC -&gt; [SubExpRes] -&gt; Body MC
forall rep. BodyDec rep -&gt; Stms rep -&gt; [SubExpRes] -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stm MC] -&gt; Stms MC
forall rep. [Stm rep] -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#stmsFromList"><span class="hs-identifier hs-var">stmsFromList</span></a></span><span> </span><span class="annot"><span class="annottext">[Stm MC]
</span><a href="#local-6989586621684419423"><span class="hs-identifier hs-var">indexings</span></a></span><span> </span><span class="annot"><span class="annottext">Stms MC -&gt; Stms MC -&gt; Stms MC
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419420"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684419419"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-69"></span><span>
</span><span id="line-70"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#mapLambdaToKernelBody"><span class="hs-identifier hs-type">mapLambdaToKernelBody</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-71"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-72"></span><span>  </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-73"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-75"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-type">KernelBody</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-76"></span><span id="mapLambdaToKernelBody"><span class="annot"><span class="annottext">mapLambdaToKernelBody :: (Body SOACS -&gt; ExtractM (Body MC))
-&gt; VName -&gt; Lambda SOACS -&gt; [VName] -&gt; ExtractM (KernelBody MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#mapLambdaToKernelBody"><span class="hs-identifier hs-var hs-var">mapLambdaToKernelBody</span></a></span></span><span> </span><span id="local-6989586621684419414"><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="#local-6989586621684419414"><span class="hs-identifier hs-var">onBody</span></a></span></span><span> </span><span id="local-6989586621684419413"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419413"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684419412"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419412"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684419411"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419411"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-77"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684419410"><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419410"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684419409"><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684419409"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Body SOACS -&gt; ExtractM (Body MC))
-&gt; VName -&gt; Lambda SOACS -&gt; [VName] -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#mapLambdaToBody"><span class="hs-identifier hs-var">mapLambdaToBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="#local-6989586621684419414"><span class="hs-identifier hs-var">onBody</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419413"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419412"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419411"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-78"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684419408"><span class="annot"><span class="annottext">ret :: SubExpRes -&gt; KernelResult
</span><a href="#local-6989586621684419408"><span class="hs-identifier hs-var hs-var">ret</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684419406"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684419406"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684419405"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419405"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ResultManifest -&gt; Certs -&gt; SubExp -&gt; KernelResult
</span><a href="Futhark.IR.SegOp.html#Returns"><span class="hs-identifier hs-var">Returns</span></a></span><span> </span><span class="annot"><span class="annottext">ResultManifest
</span><a href="Futhark.IR.SegOp.html#ResultMaySimplify"><span class="hs-identifier hs-var">ResultMaySimplify</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684419406"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419405"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-79"></span><span>  </span><span class="annot"><span class="annottext">KernelBody MC -&gt; ExtractM (KernelBody MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(KernelBody MC -&gt; ExtractM (KernelBody MC))
-&gt; KernelBody MC -&gt; ExtractM (KernelBody MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BodyDec MC -&gt; Stms MC -&gt; [KernelResult] -&gt; KernelBody MC
forall rep.
BodyDec rep -&gt; Stms rep -&gt; [KernelResult] -&gt; KernelBody rep
</span><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-var">KernelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419410"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">([KernelResult] -&gt; KernelBody MC)
-&gt; [KernelResult] -&gt; KernelBody MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; KernelResult) -&gt; [SubExpRes] -&gt; [KernelResult]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; KernelResult
</span><a href="#local-6989586621684419408"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684419409"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#reduceToSegBinOp"><span class="hs-identifier hs-type">reduceToSegBinOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-82"></span><span id="reduceToSegBinOp"><span class="annot"><span class="annottext">reduceToSegBinOp :: Reduce SOACS -&gt; ExtractM (Stms MC, SegBinOp MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#reduceToSegBinOp"><span class="hs-identifier hs-var hs-var">reduceToSegBinOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span id="local-6989586621684419399"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684419399"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684419398"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419398"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684419397"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419397"><span class="hs-identifier hs-var">nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684419396"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419396"><span class="hs-identifier hs-var">lam'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419395"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419395"><span class="hs-identifier hs-var">nes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419394"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684419394"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419393"><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419393"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Builder MC (Lambda SOACS, [SubExp], Shape)
-&gt; ExtractM ((Lambda SOACS, [SubExp], Shape), Stms MC)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilder"><span class="hs-identifier hs-var">runBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder MC (Lambda SOACS, [SubExp], Shape)
 -&gt; ExtractM ((Lambda SOACS, [SubExp], Shape), Stms MC))
-&gt; Builder MC (Lambda SOACS, [SubExp], Shape)
-&gt; ExtractM ((Lambda SOACS, [SubExp], Shape), Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
-&gt; [SubExp] -&gt; Builder MC (Lambda SOACS, [SubExp], Shape)
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Lambda SOACS -&gt; [SubExp] -&gt; m (Lambda SOACS, [SubExp], Shape)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#determineReduceOp"><span class="hs-identifier hs-var">determineReduceOp</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419398"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419397"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-84"></span><span>  </span><span id="local-6989586621684419390"><span class="annot"><span class="annottext">Lambda MC
</span><a href="#local-6989586621684419390"><span class="hs-identifier hs-var">lam''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; ExtractM (Lambda MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformLambda"><span class="hs-identifier hs-var">transformLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419396"><span class="hs-identifier hs-var">lam'</span></a></span><span>
</span><span id="line-85"></span><span>  </span><span class="annot"><span class="annottext">(Stms MC, SegBinOp MC) -&gt; ExtractM (Stms MC, SegBinOp MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419393"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Commutativity -&gt; Lambda MC -&gt; [SubExp] -&gt; Shape -&gt; SegBinOp MC
forall rep.
Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Shape -&gt; SegBinOp rep
</span><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-var">SegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684419399"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda MC
</span><a href="#local-6989586621684419390"><span class="hs-identifier hs-var">lam''</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419395"><span class="hs-identifier hs-var">nes'</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684419394"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-86"></span><span>
</span><span id="line-87"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#scanToSegBinOp"><span class="hs-identifier hs-type">scanToSegBinOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-type">SegBinOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-88"></span><span id="scanToSegBinOp"><span class="annot"><span class="annottext">scanToSegBinOp :: Scan SOACS -&gt; ExtractM (Stms MC, SegBinOp MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#scanToSegBinOp"><span class="hs-identifier hs-var hs-var">scanToSegBinOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scan"><span class="hs-identifier hs-type">Scan</span></a></span><span> </span><span id="local-6989586621684419385"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419385"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684419384"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419384"><span class="hs-identifier hs-var">nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-89"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684419383"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419383"><span class="hs-identifier hs-var">lam'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419382"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419382"><span class="hs-identifier hs-var">nes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419381"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684419381"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419380"><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419380"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Builder MC (Lambda SOACS, [SubExp], Shape)
-&gt; ExtractM ((Lambda SOACS, [SubExp], Shape), Stms MC)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilder"><span class="hs-identifier hs-var">runBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder MC (Lambda SOACS, [SubExp], Shape)
 -&gt; ExtractM ((Lambda SOACS, [SubExp], Shape), Stms MC))
-&gt; Builder MC (Lambda SOACS, [SubExp], Shape)
-&gt; ExtractM ((Lambda SOACS, [SubExp], Shape), Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
-&gt; [SubExp] -&gt; Builder MC (Lambda SOACS, [SubExp], Shape)
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Lambda SOACS -&gt; [SubExp] -&gt; m (Lambda SOACS, [SubExp], Shape)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#determineReduceOp"><span class="hs-identifier hs-var">determineReduceOp</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419385"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419384"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-90"></span><span>  </span><span id="local-6989586621684419379"><span class="annot"><span class="annottext">Lambda MC
</span><a href="#local-6989586621684419379"><span class="hs-identifier hs-var">lam''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; ExtractM (Lambda MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformLambda"><span class="hs-identifier hs-var">transformLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419383"><span class="hs-identifier hs-var">lam'</span></a></span><span>
</span><span id="line-91"></span><span>  </span><span class="annot"><span class="annottext">(Stms MC, SegBinOp MC) -&gt; ExtractM (Stms MC, SegBinOp MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419380"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Commutativity -&gt; Lambda MC -&gt; [SubExp] -&gt; Shape -&gt; SegBinOp MC
forall rep.
Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Shape -&gt; SegBinOp rep
</span><a href="Futhark.IR.SegOp.html#SegBinOp"><span class="hs-identifier hs-var">SegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="Futhark.IR.Syntax.Core.html#Noncommutative"><span class="hs-identifier hs-var">Noncommutative</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda MC
</span><a href="#local-6989586621684419379"><span class="hs-identifier hs-var">lam''</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419382"><span class="hs-identifier hs-var">nes'</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684419381"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-92"></span><span>
</span><span id="line-93"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#histToSegBinOp"><span class="hs-identifier hs-type">histToSegBinOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-type">SOACS.HistOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-type">MC.HistOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span id="histToSegBinOp"><span class="annot"><span class="annottext">histToSegBinOp :: HistOp SOACS -&gt; ExtractM (Stms MC, HistOp MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#histToSegBinOp"><span class="hs-identifier hs-var hs-var">histToSegBinOp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-type">SOACS.HistOp</span></a></span><span> </span><span id="local-6989586621684419375"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684419375"><span class="hs-identifier hs-var">num_bins</span></a></span></span><span> </span><span id="local-6989586621684419374"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419374"><span class="hs-identifier hs-var">rf</span></a></span></span><span> </span><span id="local-6989586621684419373"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419373"><span class="hs-identifier hs-var">dests</span></a></span></span><span> </span><span id="local-6989586621684419372"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419372"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span id="local-6989586621684419371"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419371"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-95"></span><span>  </span><span class="hs-special">(</span><span class="hs-special">(</span><span id="local-6989586621684419370"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419370"><span class="hs-identifier hs-var">op'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419369"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419369"><span class="hs-identifier hs-var">nes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419368"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684419368"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419367"><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419367"><span class="hs-identifier hs-var">stms</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Builder MC (Lambda SOACS, [SubExp], Shape)
-&gt; ExtractM ((Lambda SOACS, [SubExp], Shape), Stms MC)
forall (m :: * -&gt; *) somerep rep a.
(MonadFreshNames m, HasScope somerep m, SameScope somerep rep) =&gt;
Builder rep a -&gt; m (a, Stms rep)
</span><a href="Futhark.Builder.html#runBuilder"><span class="hs-identifier hs-var">runBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder MC (Lambda SOACS, [SubExp], Shape)
 -&gt; ExtractM ((Lambda SOACS, [SubExp], Shape), Stms MC))
-&gt; Builder MC (Lambda SOACS, [SubExp], Shape)
-&gt; ExtractM ((Lambda SOACS, [SubExp], Shape), Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
-&gt; [SubExp] -&gt; Builder MC (Lambda SOACS, [SubExp], Shape)
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Lambda SOACS -&gt; [SubExp] -&gt; m (Lambda SOACS, [SubExp], Shape)
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#determineReduceOp"><span class="hs-identifier hs-var">determineReduceOp</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419371"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419372"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-96"></span><span>  </span><span id="local-6989586621684419366"><span class="annot"><span class="annottext">Lambda MC
</span><a href="#local-6989586621684419366"><span class="hs-identifier hs-var">op''</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; ExtractM (Lambda MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformLambda"><span class="hs-identifier hs-var">transformLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419370"><span class="hs-identifier hs-var">op'</span></a></span><span>
</span><span id="line-97"></span><span>  </span><span class="annot"><span class="annottext">(Stms MC, HistOp MC) -&gt; ExtractM (Stms MC, HistOp MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419367"><span class="hs-identifier hs-var">stms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Shape
-&gt; SubExp -&gt; [VName] -&gt; [SubExp] -&gt; Shape -&gt; Lambda MC -&gt; HistOp MC
forall rep.
Shape
-&gt; SubExp
-&gt; [VName]
-&gt; [SubExp]
-&gt; Shape
-&gt; Lambda rep
-&gt; HistOp rep
</span><a href="Futhark.IR.SegOp.html#HistOp"><span class="hs-identifier hs-var">MC.HistOp</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684419375"><span class="hs-identifier hs-var">num_bins</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419374"><span class="hs-identifier hs-var">rf</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419373"><span class="hs-identifier hs-var">dests</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419369"><span class="hs-identifier hs-var">nes'</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684419368"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda MC
</span><a href="#local-6989586621684419366"><span class="hs-identifier hs-var">op''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span id="local-6989586621684420104"><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#mkSegSpace"><span class="hs-identifier hs-type">mkSegSpace</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684420104"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684420104"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-type">SegSpace</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-100"></span><span id="mkSegSpace"><span class="annot"><span class="annottext">mkSegSpace :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
SubExp -&gt; m (VName, SegSpace)
</span><a href="Futhark.Pass.ExtractMulticore.html#mkSegSpace"><span class="hs-identifier hs-var hs-var">mkSegSpace</span></a></span></span><span> </span><span id="local-6989586621684419355"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419355"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-101"></span><span>  </span><span id="local-6989586621684419354"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419354"><span class="hs-identifier hs-var">flat</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;flat_tid&quot;</span></span><span>
</span><span id="line-102"></span><span>  </span><span id="local-6989586621684419352"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419352"><span class="hs-identifier hs-var">gtid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;gtid&quot;</span></span><span>
</span><span id="line-103"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684419351"><span class="annot"><span class="annottext">space :: SegSpace
</span><a href="#local-6989586621684419351"><span class="hs-identifier hs-var hs-var">space</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; [(VName, SubExp)] -&gt; SegSpace
</span><a href="Futhark.IR.SegOp.html#SegSpace"><span class="hs-identifier hs-var">SegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419354"><span class="hs-identifier hs-var">flat</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419352"><span class="hs-identifier hs-var">gtid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419355"><span class="hs-identifier hs-var">w</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-104"></span><span>  </span><span class="annot"><span class="annottext">(VName, SegSpace) -&gt; m (VName, SegSpace)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419352"><span class="hs-identifier hs-var">gtid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684419351"><span class="hs-identifier hs-var">space</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformLoopForm"><span class="hs-identifier hs-type">transformLoopForm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#LoopForm"><span class="hs-identifier hs-type">LoopForm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#LoopForm"><span class="hs-identifier hs-type">LoopForm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span>
</span><span id="line-107"></span><span id="transformLoopForm"><span class="annot"><span class="annottext">transformLoopForm :: LoopForm SOACS -&gt; LoopForm MC
</span><a href="Futhark.Pass.ExtractMulticore.html#transformLoopForm"><span class="hs-identifier hs-var hs-var">transformLoopForm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#WhileLoop"><span class="hs-identifier hs-type">WhileLoop</span></a></span><span> </span><span id="local-6989586621684419347"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419347"><span class="hs-identifier hs-var">cond</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; LoopForm MC
forall rep. VName -&gt; LoopForm rep
</span><a href="Futhark.IR.Syntax.html#WhileLoop"><span class="hs-identifier hs-var">WhileLoop</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419347"><span class="hs-identifier hs-var">cond</span></a></span><span>
</span><span id="line-108"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformLoopForm"><span class="hs-identifier hs-var">transformLoopForm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#ForLoop"><span class="hs-identifier hs-type">ForLoop</span></a></span><span> </span><span id="local-6989586621684419345"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419345"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684419344"><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684419344"><span class="hs-identifier hs-var">it</span></a></span></span><span> </span><span id="local-6989586621684419343"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419343"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span id="local-6989586621684419342"><span class="annot"><span class="annottext">[(LParam SOACS, VName)]
</span><a href="#local-6989586621684419342"><span class="hs-identifier hs-var">params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; IntType -&gt; SubExp -&gt; [(LParam MC, VName)] -&gt; LoopForm MC
forall rep.
VName -&gt; IntType -&gt; SubExp -&gt; [(LParam rep, VName)] -&gt; LoopForm rep
</span><a href="Futhark.IR.Syntax.html#ForLoop"><span class="hs-identifier hs-var">ForLoop</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419345"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="#local-6989586621684419344"><span class="hs-identifier hs-var">it</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419343"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="annot"><span class="annottext">[(LParam SOACS, VName)]
[(LParam MC, VName)]
</span><a href="#local-6989586621684419342"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-109"></span><span>
</span><span id="line-110"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformStm"><span class="hs-identifier hs-type">transformStm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stm"><span class="hs-identifier hs-type">Stm</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-111"></span><span id="transformStm"><span class="annot"><span class="annottext">transformStm :: Stm SOACS -&gt; ExtractM (Stms MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformStm"><span class="hs-identifier hs-var hs-var">transformStm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684419340"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684419340"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684419339"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684419339"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-type">BasicOp</span></a></span><span> </span><span id="local-6989586621684419338"><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684419338"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-112"></span><span>  </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; ExtractM (Stms MC)) -&gt; Stms MC -&gt; ExtractM (Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm MC -&gt; Stms MC) -&gt; Stm MC -&gt; Stms MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419340"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
StmAux (ExpDec MC)
</span><a href="#local-6989586621684419339"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stm MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; Exp MC
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">BasicOp
</span><a href="#local-6989586621684419338"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-113"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684419336"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684419336"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684419335"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684419335"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621684419333"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684419333"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684419332"><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684419332"><span class="hs-identifier hs-var">args</span></a></span></span><span> </span><span id="local-6989586621684419331"><span class="annot"><span class="annottext">[RetType SOACS]
</span><a href="#local-6989586621684419331"><span class="hs-identifier hs-var">ret</span></a></span></span><span> </span><span id="local-6989586621684419330"><span class="annot"><span class="annottext">(Safety, SrcLoc, [SrcLoc])
</span><a href="#local-6989586621684419330"><span class="hs-identifier hs-var">info</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-114"></span><span>  </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; ExtractM (Stms MC)) -&gt; Stms MC -&gt; ExtractM (Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm MC -&gt; Stms MC) -&gt; Stm MC -&gt; Stms MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419336"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
StmAux (ExpDec MC)
</span><a href="#local-6989586621684419335"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stm MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name
-&gt; [(SubExp, Diet)]
-&gt; [RetType MC]
-&gt; (Safety, SrcLoc, [SrcLoc])
-&gt; Exp MC
forall rep.
Name
-&gt; [(SubExp, Diet)]
-&gt; [RetType rep]
-&gt; (Safety, SrcLoc, [SrcLoc])
-&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684419333"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[(SubExp, Diet)]
</span><a href="#local-6989586621684419332"><span class="hs-identifier hs-var">args</span></a></span><span> </span><span class="annot"><span class="annottext">[RetType SOACS]
[RetType MC]
</span><a href="#local-6989586621684419331"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="annot"><span class="annottext">(Safety, SrcLoc, [SrcLoc])
</span><a href="#local-6989586621684419330"><span class="hs-identifier hs-var">info</span></a></span><span>
</span><span id="line-115"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684419329"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684419329"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684419328"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684419328"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span id="local-6989586621684419326"><span class="annot"><span class="annottext">[(FParam SOACS, SubExp)]
</span><a href="#local-6989586621684419326"><span class="hs-identifier hs-var">merge</span></a></span></span><span> </span><span id="local-6989586621684419325"><span class="annot"><span class="annottext">LoopForm SOACS
</span><a href="#local-6989586621684419325"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684419324"><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684419324"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684419323"><span class="annot"><span class="annottext">form' :: LoopForm MC
</span><a href="#local-6989586621684419323"><span class="hs-identifier hs-var hs-var">form'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LoopForm SOACS -&gt; LoopForm MC
</span><a href="Futhark.Pass.ExtractMulticore.html#transformLoopForm"><span class="hs-identifier hs-var">transformLoopForm</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm SOACS
</span><a href="#local-6989586621684419325"><span class="hs-identifier hs-var">form</span></a></span><span>
</span><span id="line-117"></span><span>  </span><span id="local-6989586621684419322"><span class="annot"><span class="annottext">Body MC
</span><a href="#local-6989586621684419322"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-118"></span><span>    </span><span class="annot"><span class="annottext">Scope MC -&gt; ExtractM (Body MC) -&gt; ExtractM (Body MC)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param DeclType] -&gt; Scope MC
forall rep dec. (FParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfFParams"><span class="hs-identifier hs-var">scopeOfFParams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Param DeclType, SubExp) -&gt; Param DeclType)
-&gt; [(Param DeclType, SubExp)] -&gt; [Param DeclType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Param DeclType, SubExp) -&gt; Param DeclType
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Param DeclType, SubExp)]
[(FParam SOACS, SubExp)]
</span><a href="#local-6989586621684419326"><span class="hs-identifier hs-var">merge</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope MC -&gt; Scope MC -&gt; Scope MC
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">LoopForm MC -&gt; Scope MC
forall rep a. Scoped rep a =&gt; a -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOf"><span class="hs-identifier hs-var">scopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm MC
</span><a href="#local-6989586621684419323"><span class="hs-identifier hs-var">form'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExtractM (Body MC) -&gt; ExtractM (Body MC))
-&gt; ExtractM (Body MC) -&gt; ExtractM (Body MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-119"></span><span>      </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684419324"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-120"></span><span>  </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; ExtractM (Stms MC)) -&gt; Stms MC -&gt; ExtractM (Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm MC -&gt; Stms MC) -&gt; Stm MC -&gt; Stms MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419329"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
StmAux (ExpDec MC)
</span><a href="#local-6989586621684419328"><span class="hs-identifier hs-var">aux</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stm MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(FParam MC, SubExp)] -&gt; LoopForm MC -&gt; Body MC -&gt; Exp MC
forall rep.
[(FParam rep, SubExp)] -&gt; LoopForm rep -&gt; BodyT rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#DoLoop"><span class="hs-identifier hs-var">DoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">[(FParam SOACS, SubExp)]
[(FParam MC, SubExp)]
</span><a href="#local-6989586621684419326"><span class="hs-identifier hs-var">merge</span></a></span><span> </span><span class="annot"><span class="annottext">LoopForm MC
</span><a href="#local-6989586621684419323"><span class="hs-identifier hs-var">form'</span></a></span><span> </span><span class="annot"><span class="annottext">Body MC
</span><a href="#local-6989586621684419322"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-121"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684419317"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684419317"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684419316"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684419316"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span id="local-6989586621684419314"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419314"><span class="hs-identifier hs-var">cond</span></a></span></span><span> </span><span id="local-6989586621684419313"><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684419313"><span class="hs-identifier hs-var">tbranch</span></a></span></span><span> </span><span id="local-6989586621684419312"><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684419312"><span class="hs-identifier hs-var">fbranch</span></a></span></span><span> </span><span id="local-6989586621684419311"><span class="annot"><span class="annottext">IfDec (BranchType SOACS)
</span><a href="#local-6989586621684419311"><span class="hs-identifier hs-var">ret</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-122"></span><span>  </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm MC -&gt; Stms MC) -&gt; (Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stms MC
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419317"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
StmAux (ExpDec MC)
</span><a href="#local-6989586621684419316"><span class="hs-identifier hs-var">aux</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stms MC) -&gt; ExtractM (Exp MC) -&gt; ExtractM (Stms MC)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; Body MC -&gt; Body MC -&gt; IfDec (BranchType MC) -&gt; Exp MC
forall rep.
SubExp
-&gt; BodyT rep -&gt; BodyT rep -&gt; IfDec (BranchType rep) -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419314"><span class="hs-identifier hs-var">cond</span></a></span><span> </span><span class="annot"><span class="annottext">(Body MC -&gt; Body MC -&gt; IfDec ExtType -&gt; Exp MC)
-&gt; ExtractM (Body MC)
-&gt; ExtractM (Body MC -&gt; IfDec ExtType -&gt; Exp MC)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684419313"><span class="hs-identifier hs-var">tbranch</span></a></span><span> </span><span class="annot"><span class="annottext">ExtractM (Body MC -&gt; IfDec ExtType -&gt; Exp MC)
-&gt; ExtractM (Body MC) -&gt; ExtractM (IfDec ExtType -&gt; Exp MC)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684419312"><span class="hs-identifier hs-var">fbranch</span></a></span><span> </span><span class="annot"><span class="annottext">ExtractM (IfDec ExtType -&gt; Exp MC)
-&gt; ExtractM (IfDec ExtType) -&gt; ExtractM (Exp MC)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">IfDec ExtType -&gt; ExtractM (IfDec ExtType)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">IfDec ExtType
IfDec (BranchType SOACS)
</span><a href="#local-6989586621684419311"><span class="hs-identifier hs-var">ret</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-124"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684419309"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684419309"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684419308"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684419308"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-type">WithAcc</span></a></span><span> </span><span id="local-6989586621684419306"><span class="annot"><span class="annottext">[WithAccInput SOACS]
</span><a href="#local-6989586621684419306"><span class="hs-identifier hs-var">inputs</span></a></span></span><span> </span><span id="local-6989586621684419305"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419305"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-125"></span><span>  </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm MC -&gt; Stms MC) -&gt; (Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stms MC
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419309"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
StmAux (ExpDec MC)
</span><a href="#local-6989586621684419308"><span class="hs-identifier hs-var">aux</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stms MC) -&gt; ExtractM (Exp MC) -&gt; ExtractM (Stms MC)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[WithAccInput MC] -&gt; Lambda MC -&gt; Exp MC
forall rep. [WithAccInput rep] -&gt; Lambda rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#WithAcc"><span class="hs-identifier hs-var">WithAcc</span></a></span><span> </span><span class="annot"><span class="annottext">([WithAccInput MC] -&gt; Lambda MC -&gt; Exp MC)
-&gt; ExtractM [WithAccInput MC] -&gt; ExtractM (Lambda MC -&gt; Exp MC)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(WithAccInput SOACS -&gt; ExtractM (WithAccInput MC))
-&gt; [WithAccInput SOACS] -&gt; ExtractM [WithAccInput MC]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">WithAccInput SOACS -&gt; ExtractM (WithAccInput MC)
forall {t :: * -&gt; *} {t :: * -&gt; * -&gt; *} {t} {t} {d}.
(Traversable t, Bitraversable t) =&gt;
(t, t, t (t (Lambda SOACS) d))
-&gt; ExtractM (t, t, t (t (Lambda MC) d))
</span><a href="#local-6989586621684419303"><span class="hs-identifier hs-var">transformInput</span></a></span><span> </span><span class="annot"><span class="annottext">[WithAccInput SOACS]
</span><a href="#local-6989586621684419306"><span class="hs-identifier hs-var">inputs</span></a></span><span> </span><span class="annot"><span class="annottext">ExtractM (Lambda MC -&gt; Exp MC)
-&gt; ExtractM (Lambda MC) -&gt; ExtractM (Exp MC)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; ExtractM (Lambda MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformLambda"><span class="hs-identifier hs-var">transformLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419305"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-127"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-128"></span><span>    </span><span id="local-6989586621684419303"><span class="annot"><span class="annottext">transformInput :: (t, t, t (t (Lambda SOACS) d))
-&gt; ExtractM (t, t, t (t (Lambda MC) d))
</span><a href="#local-6989586621684419303"><span class="hs-identifier hs-var hs-var">transformInput</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684419294"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684419294"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419293"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684419293"><span class="hs-identifier hs-var">arrs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419292"><span class="annot"><span class="annottext">t (t (Lambda SOACS) d)
</span><a href="#local-6989586621684419292"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-129"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684419294"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684419293"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">,</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(t (t (Lambda MC) d) -&gt; (t, t, t (t (Lambda MC) d)))
-&gt; ExtractM (t (t (Lambda MC) d))
-&gt; ExtractM (t, t, t (t (Lambda MC) d))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(t (Lambda SOACS) d -&gt; ExtractM (t (Lambda MC) d))
-&gt; t (t (Lambda SOACS) d) -&gt; ExtractM (t (t (Lambda MC) d))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Lambda SOACS -&gt; ExtractM (Lambda MC))
-&gt; (d -&gt; ExtractM d)
-&gt; t (Lambda SOACS) d
-&gt; ExtractM (t (Lambda MC) d)
forall (t :: * -&gt; * -&gt; *) (f :: * -&gt; *) a c b d.
(Bitraversable t, Applicative f) =&gt;
(a -&gt; f c) -&gt; (b -&gt; f d) -&gt; t a b -&gt; f (t c d)
</span><span class="hs-identifier hs-var">bitraverse</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; ExtractM (Lambda MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformLambda"><span class="hs-identifier hs-var">transformLambda</span></a></span><span> </span><span class="annot"><span class="annottext">d -&gt; ExtractM d
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">t (t (Lambda SOACS) d)
</span><a href="#local-6989586621684419292"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-130"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-type">Let</span></a></span><span> </span><span id="local-6989586621684419289"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684419289"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684419288"><span class="annot"><span class="annottext">StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684419288"><span class="hs-identifier hs-var">aux</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-type">Op</span></a></span><span> </span><span id="local-6989586621684419286"><span class="annot"><span class="annottext">Op SOACS
</span><a href="#local-6989586621684419286"><span class="hs-identifier hs-var">op</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-131"></span><span>  </span><span class="annot"><span class="annottext">(Stm MC -&gt; Stm MC) -&gt; Stms MC -&gt; Stms MC
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Certs -&gt; Stm MC -&gt; Stm MC
forall rep. Certs -&gt; Stm rep -&gt; Stm rep
</span><a href="Futhark.IR.Prop.html#certify"><span class="hs-identifier hs-var">certify</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StmAux () -&gt; Certs
forall dec. StmAux dec -&gt; Certs
</span><a href="Futhark.IR.Syntax.html#stmAuxCerts"><span class="hs-identifier hs-var hs-var">stmAuxCerts</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684419288"><span class="hs-identifier hs-var">aux</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; Stms MC) -&gt; ExtractM (Stms MC) -&gt; ExtractM (Stms MC)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Pat SOACS -&gt; Attrs -&gt; SOAC SOACS -&gt; ExtractM (Stms MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformSOAC"><span class="hs-identifier hs-var">transformSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684419289"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StmAux () -&gt; Attrs
forall dec. StmAux dec -&gt; Attrs
</span><a href="Futhark.IR.Syntax.html#stmAuxAttrs"><span class="hs-identifier hs-var hs-var">stmAuxAttrs</span></a></span><span> </span><span class="annot"><span class="annottext">StmAux ()
StmAux (ExpDec SOACS)
</span><a href="#local-6989586621684419288"><span class="hs-identifier hs-var">aux</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Op SOACS
SOAC SOACS
</span><a href="#local-6989586621684419286"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformLambda"><span class="hs-identifier hs-type">transformLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-134"></span><span id="transformLambda"><span class="annot"><span class="annottext">transformLambda :: Lambda SOACS -&gt; ExtractM (Lambda MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformLambda"><span class="hs-identifier hs-var hs-var">transformLambda</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span id="local-6989586621684419281"><span class="annot"><span class="annottext">[LParam SOACS]
</span><a href="#local-6989586621684419281"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684419280"><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684419280"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621684419279"><span class="annot"><span class="annottext">[TypeBase Shape NoUniqueness]
</span><a href="#local-6989586621684419279"><span class="hs-identifier hs-var">ret</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-135"></span><span>  </span><span class="annot"><span class="annottext">[LParam MC]
-&gt; Body MC -&gt; [TypeBase Shape NoUniqueness] -&gt; Lambda MC
forall rep.
[LParam rep]
-&gt; BodyT rep -&gt; [TypeBase Shape NoUniqueness] -&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[LParam SOACS]
[LParam MC]
</span><a href="#local-6989586621684419281"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="annot"><span class="annottext">(Body MC -&gt; [TypeBase Shape NoUniqueness] -&gt; Lambda MC)
-&gt; ExtractM (Body MC)
-&gt; ExtractM ([TypeBase Shape NoUniqueness] -&gt; Lambda MC)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Scope MC -&gt; ExtractM (Body MC) -&gt; ExtractM (Body MC)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)] -&gt; Scope MC
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)]
[LParam SOACS]
</span><a href="#local-6989586621684419281"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684419280"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-137"></span><span>    </span><span class="annot"><span class="annottext">ExtractM ([TypeBase Shape NoUniqueness] -&gt; Lambda MC)
-&gt; ExtractM [TypeBase Shape NoUniqueness] -&gt; ExtractM (Lambda MC)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[TypeBase Shape NoUniqueness]
-&gt; ExtractM [TypeBase Shape NoUniqueness]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[TypeBase Shape NoUniqueness]
</span><a href="#local-6989586621684419279"><span class="hs-identifier hs-var">ret</span></a></span><span>
</span><span id="line-138"></span><span>
</span><span id="line-139"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformStms"><span class="hs-identifier hs-type">transformStms</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span id="transformStms"><span class="annot"><span class="annottext">transformStms :: Stms SOACS -&gt; ExtractM (Stms MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformStms"><span class="hs-identifier hs-var hs-var">transformStms</span></a></span></span><span> </span><span id="local-6989586621684419276"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684419276"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; Maybe (Stm SOACS, Stms SOACS)
forall rep. Stms rep -&gt; Maybe (Stm rep, Stms rep)
</span><a href="Futhark.IR.Syntax.html#stmsHead"><span class="hs-identifier hs-var">stmsHead</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684419276"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-142"></span><span>    </span><span class="annot"><span class="annottext">Maybe (Stm SOACS, Stms SOACS)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Stms MC
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684419274"><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684419274"><span class="hs-identifier hs-var">stm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419273"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684419273"><span class="hs-identifier hs-var">stms'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-144"></span><span>      </span><span id="local-6989586621684419272"><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419272"><span class="hs-identifier hs-var">stm_stms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stm SOACS -&gt; ExtractM (Stms MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformStm"><span class="hs-identifier hs-var">transformStm</span></a></span><span> </span><span class="annot"><span class="annottext">Stm SOACS
</span><a href="#local-6989586621684419274"><span class="hs-identifier hs-var">stm</span></a></span><span>
</span><span id="line-145"></span><span>      </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC) -&gt; ExtractM (Stms MC)
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419272"><span class="hs-identifier hs-var">stm_stms</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtractM (Stms MC) -&gt; ExtractM (Stms MC))
-&gt; ExtractM (Stms MC) -&gt; ExtractM (Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419272"><span class="hs-identifier hs-var">stm_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms MC -&gt; Stms MC -&gt; Stms MC
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; Stms MC) -&gt; ExtractM (Stms MC) -&gt; ExtractM (Stms MC)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; ExtractM (Stms MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684419273"><span class="hs-identifier hs-var">stms'</span></a></span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformBody"><span class="hs-identifier hs-type">transformBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span id="transformBody"><span class="annot"><span class="annottext">transformBody :: Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformBody"><span class="hs-identifier hs-var hs-var">transformBody</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684419271"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684419271"><span class="hs-identifier hs-var">stms</span></a></span></span><span> </span><span id="local-6989586621684419270"><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684419270"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-149"></span><span>  </span><span class="annot"><span class="annottext">BodyDec MC -&gt; Stms MC -&gt; [SubExpRes] -&gt; Body MC
forall rep. BodyDec rep -&gt; Stms rep -&gt; [SubExpRes] -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-var">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; [SubExpRes] -&gt; Body MC)
-&gt; ExtractM (Stms MC) -&gt; ExtractM ([SubExpRes] -&gt; Body MC)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; ExtractM (Stms MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684419271"><span class="hs-identifier hs-var">stms</span></a></span><span> </span><span class="annot"><span class="annottext">ExtractM ([SubExpRes] -&gt; Body MC)
-&gt; ExtractM [SubExpRes] -&gt; ExtractM (Body MC)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SubExpRes] -&gt; ExtractM [SubExpRes]
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684419270"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-150"></span><span>
</span><span id="line-151"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#sequentialiseBody"><span class="hs-identifier hs-type">sequentialiseBody</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-152"></span><span id="sequentialiseBody"><span class="annot"><span class="annottext">sequentialiseBody :: Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#sequentialiseBody"><span class="hs-identifier hs-var hs-var">sequentialiseBody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Body MC -&gt; ExtractM (Body MC)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Body MC -&gt; ExtractM (Body MC))
-&gt; (Body SOACS -&gt; Body MC) -&gt; Body SOACS -&gt; ExtractM (Body MC)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Identity (Body MC) -&gt; Body MC
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity (Body MC) -&gt; Body MC)
-&gt; (Body SOACS -&gt; Identity (Body MC)) -&gt; Body SOACS -&gt; Body MC
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Rephraser Identity SOACS MC -&gt; Body SOACS -&gt; Identity (Body MC)
forall (m :: * -&gt; *) from to.
Monad m =&gt;
Rephraser m from to -&gt; Body from -&gt; m (Body to)
</span><a href="Futhark.Analysis.Rephrase.html#rephraseBody"><span class="hs-identifier hs-var">rephraseBody</span></a></span><span> </span><span class="annot"><span class="annottext">Rephraser Identity SOACS MC
</span><a href="#local-6989586621684419266"><span class="hs-identifier hs-var">toMC</span></a></span><span>
</span><span id="line-153"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-154"></span><span>    </span><span id="local-6989586621684419266"><span class="annot"><span class="annottext">toMC :: Rephraser Identity SOACS MC
</span><a href="#local-6989586621684419266"><span class="hs-identifier hs-var hs-var">toMC</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SOAC MC -&gt; Op MC) -&gt; Rephraser Identity SOACS MC
forall (m :: * -&gt; *) from to.
(Monad m, SameScope from to, ExpDec from ~ ExpDec to,
 BodyDec from ~ BodyDec to, RetType from ~ RetType to,
 BranchType from ~ BranchType to, Op from ~ SOAC from) =&gt;
(SOAC to -&gt; Op to) -&gt; Rephraser m from to
</span><a href="Futhark.Pass.ExtractKernels.ToGPU.html#injectSOACS"><span class="hs-identifier hs-var">injectSOACS</span></a></span><span> </span><span class="annot"><span class="annottext">SOAC MC -&gt; Op MC
forall rep op. op -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#OtherOp"><span class="hs-identifier hs-var">OtherOp</span></a></span><span>
</span><span id="line-155"></span><span>
</span><span id="line-156"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformFunDef"><span class="hs-identifier hs-type">transformFunDef</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-157"></span><span id="transformFunDef"><span class="annot"><span class="annottext">transformFunDef :: FunDef SOACS -&gt; ExtractM (FunDef MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformFunDef"><span class="hs-identifier hs-var hs-var">transformFunDef</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-type">FunDef</span></a></span><span> </span><span id="local-6989586621684419246"><span class="annot"><span class="annottext">Maybe EntryPoint
</span><a href="#local-6989586621684419246"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span id="local-6989586621684419245"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684419245"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684419244"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684419244"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684419243"><span class="annot"><span class="annottext">[RetType SOACS]
</span><a href="#local-6989586621684419243"><span class="hs-identifier hs-var">rettype</span></a></span></span><span> </span><span id="local-6989586621684419242"><span class="annot"><span class="annottext">[FParam SOACS]
</span><a href="#local-6989586621684419242"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684419241"><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684419241"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-158"></span><span>  </span><span id="local-6989586621684419240"><span class="annot"><span class="annottext">Body MC
</span><a href="#local-6989586621684419240"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scope MC -&gt; ExtractM (Body MC) -&gt; ExtractM (Body MC)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param DeclType] -&gt; Scope MC
forall rep dec. (FParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfFParams"><span class="hs-identifier hs-var">scopeOfFParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param DeclType]
[FParam SOACS]
</span><a href="#local-6989586621684419242"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ExtractM (Body MC) -&gt; ExtractM (Body MC))
-&gt; ExtractM (Body MC) -&gt; ExtractM (Body MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684419241"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-159"></span><span>  </span><span class="annot"><span class="annottext">FunDef MC -&gt; ExtractM (FunDef MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(FunDef MC -&gt; ExtractM (FunDef MC))
-&gt; FunDef MC -&gt; ExtractM (FunDef MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe EntryPoint
-&gt; Attrs
-&gt; Name
-&gt; [RetType MC]
-&gt; [FParam MC]
-&gt; Body MC
-&gt; FunDef MC
forall rep.
Maybe EntryPoint
-&gt; Attrs
-&gt; Name
-&gt; [RetType rep]
-&gt; [FParam rep]
-&gt; BodyT rep
-&gt; FunDef rep
</span><a href="Futhark.IR.Syntax.html#FunDef"><span class="hs-identifier hs-var">FunDef</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EntryPoint
</span><a href="#local-6989586621684419246"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684419245"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684419244"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[RetType SOACS]
[RetType MC]
</span><a href="#local-6989586621684419243"><span class="hs-identifier hs-var">rettype</span></a></span><span> </span><span class="annot"><span class="annottext">[FParam SOACS]
[FParam MC]
</span><a href="#local-6989586621684419242"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">Body MC
</span><a href="#local-6989586621684419240"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-160"></span><span>
</span><span id="line-161"></span><span class="hs-comment">-- Sets the chunk size to one.</span><span>
</span><span id="line-162"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#unstreamLambda"><span class="hs-identifier hs-type">unstreamLambda</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Attrs"><span class="hs-identifier hs-type">Attrs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-163"></span><span id="unstreamLambda"><span class="annot"><span class="annottext">unstreamLambda :: Attrs -&gt; [SubExp] -&gt; Lambda SOACS -&gt; ExtractM (Lambda SOACS)
</span><a href="Futhark.Pass.ExtractMulticore.html#unstreamLambda"><span class="hs-identifier hs-var hs-var">unstreamLambda</span></a></span></span><span> </span><span id="local-6989586621684419238"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684419238"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684419237"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419237"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span id="local-6989586621684419236"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419236"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-164"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684419235"><span class="annot"><span class="annottext">Param (TypeBase Shape NoUniqueness)
</span><a href="#local-6989586621684419235"><span class="hs-identifier hs-var">chunk_param</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419234"><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)]
</span><a href="#local-6989586621684419234"><span class="hs-identifier hs-var">acc_params</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419233"><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)]
</span><a href="#local-6989586621684419233"><span class="hs-identifier hs-var">slice_params</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-165"></span><span>        </span><span class="annot"><span class="annottext">Int
-&gt; [Param (TypeBase Shape NoUniqueness)]
-&gt; (Param (TypeBase Shape NoUniqueness),
    [Param (TypeBase Shape NoUniqueness)],
    [Param (TypeBase Shape NoUniqueness)])
forall dec.
Int -&gt; [Param dec] -&gt; (Param dec, [Param dec], [Param dec])
</span><a href="Futhark.Tools.html#partitionChunkedFoldParameters"><span class="hs-identifier hs-var">partitionChunkedFoldParameters</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419237"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [LParam SOACS]
forall rep. LambdaT rep -&gt; [LParam rep]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var hs-var">lambdaParams</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419236"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>  </span><span id="local-6989586621684419230"><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)]
</span><a href="#local-6989586621684419230"><span class="hs-identifier hs-var">inp_params</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)]
-&gt; (Param (TypeBase Shape NoUniqueness)
    -&gt; ExtractM (Param (TypeBase Shape NoUniqueness)))
-&gt; ExtractM [Param (TypeBase Shape NoUniqueness)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)]
</span><a href="#local-6989586621684419233"><span class="hs-identifier hs-var">slice_params</span></a></span><span> </span><span class="annot"><span class="annottext">((Param (TypeBase Shape NoUniqueness)
  -&gt; ExtractM (Param (TypeBase Shape NoUniqueness)))
 -&gt; ExtractM [Param (TypeBase Shape NoUniqueness)])
-&gt; (Param (TypeBase Shape NoUniqueness)
    -&gt; ExtractM (Param (TypeBase Shape NoUniqueness)))
-&gt; ExtractM [Param (TypeBase Shape NoUniqueness)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Param"><span class="hs-identifier hs-type">Param</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684419228"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419228"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684419227"><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684419227"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-168"></span><span>    </span><span class="annot"><span class="annottext">String
-&gt; TypeBase Shape NoUniqueness
-&gt; ExtractM (Param (TypeBase Shape NoUniqueness))
forall (m :: * -&gt; *) dec.
MonadFreshNames m =&gt;
String -&gt; dec -&gt; m (Param dec)
</span><a href="Futhark.MonadFreshNames.html#newParam"><span class="hs-identifier hs-var">newParam</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419228"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; TypeBase Shape NoUniqueness
forall u. TypeBase Shape u -&gt; TypeBase Shape u
</span><a href="Futhark.IR.Prop.Types.html#rowType"><span class="hs-identifier hs-var">rowType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684419227"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-169"></span><span>
</span><span id="line-170"></span><span>  </span><span id="local-6989586621684419223"><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684419223"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Builder SOACS (Body SOACS) -&gt; ExtractM (Body SOACS)
forall rep (m :: * -&gt; *) somerep.
(Buildable rep, MonadFreshNames m, HasScope somerep m,
 SameScope somerep rep) =&gt;
Builder rep (Body rep) -&gt; m (Body rep)
</span><a href="Futhark.Builder.html#runBodyBuilder"><span class="hs-identifier hs-var">runBodyBuilder</span></a></span><span> </span><span class="annot"><span class="annottext">(Builder SOACS (Body SOACS) -&gt; ExtractM (Body SOACS))
-&gt; Builder SOACS (Body SOACS) -&gt; ExtractM (Body SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><span class="annottext">Scope SOACS
-&gt; Builder SOACS (Body SOACS) -&gt; Builder SOACS (Body SOACS)
forall rep (m :: * -&gt; *) a.
LocalScope rep m =&gt;
Scope rep -&gt; m a -&gt; m a
</span><a href="Futhark.IR.Prop.Scope.html#localScope"><span class="hs-identifier hs-var">localScope</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)] -&gt; Scope SOACS
forall rep dec. (LParamInfo rep ~ dec) =&gt; [Param dec] -&gt; Scope rep
</span><a href="Futhark.IR.Prop.Scope.html#scopeOfLParams"><span class="hs-identifier hs-var">scopeOfLParams</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)]
</span><a href="#local-6989586621684419230"><span class="hs-identifier hs-var">inp_params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Builder SOACS (Body SOACS) -&gt; Builder SOACS (Body SOACS))
-&gt; Builder SOACS (Body SOACS) -&gt; Builder SOACS (Body SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-172"></span><span>      </span><span class="annot"><span class="annottext">[VName]
-&gt; Exp (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT SOACS (State VNameSource) ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param (TypeBase Shape NoUniqueness) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase Shape NoUniqueness)
</span><a href="#local-6989586621684419235"><span class="hs-identifier hs-var">chunk_param</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT SOACS (State VNameSource)))
 -&gt; BuilderT SOACS (State VNameSource) ())
-&gt; Exp (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT SOACS (State VNameSource) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-173"></span><span>        </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT SOACS) -&gt; BasicOp -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; BasicOp) -&gt; SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">1</span></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span>      </span><span class="annot"><span class="annottext">[(Param (TypeBase Shape NoUniqueness), SubExp)]
-&gt; ((Param (TypeBase Shape NoUniqueness), SubExp)
    -&gt; BuilderT SOACS (State VNameSource) ())
-&gt; BuilderT SOACS (State VNameSource) ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)]
-&gt; [SubExp] -&gt; [(Param (TypeBase Shape NoUniqueness), SubExp)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)]
</span><a href="#local-6989586621684419234"><span class="hs-identifier hs-var">acc_params</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419237"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param (TypeBase Shape NoUniqueness), SubExp)
  -&gt; BuilderT SOACS (State VNameSource) ())
 -&gt; BuilderT SOACS (State VNameSource) ())
-&gt; ((Param (TypeBase Shape NoUniqueness), SubExp)
    -&gt; BuilderT SOACS (State VNameSource) ())
-&gt; BuilderT SOACS (State VNameSource) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684419216"><span class="annot"><span class="annottext">Param (TypeBase Shape NoUniqueness)
</span><a href="#local-6989586621684419216"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419215"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419215"><span class="hs-identifier hs-var">ne</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-176"></span><span>        </span><span class="annot"><span class="annottext">[VName]
-&gt; Exp (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT SOACS (State VNameSource) ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param (TypeBase Shape NoUniqueness) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase Shape NoUniqueness)
</span><a href="#local-6989586621684419216"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT SOACS (State VNameSource)))
 -&gt; BuilderT SOACS (State VNameSource) ())
-&gt; Exp (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT SOACS (State VNameSource) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT SOACS) -&gt; BasicOp -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419215"><span class="hs-identifier hs-var">ne</span></a></span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span>      </span><span class="annot"><span class="annottext">[(Param (TypeBase Shape NoUniqueness),
  Param (TypeBase Shape NoUniqueness))]
-&gt; ((Param (TypeBase Shape NoUniqueness),
     Param (TypeBase Shape NoUniqueness))
    -&gt; BuilderT SOACS (State VNameSource) ())
-&gt; BuilderT SOACS (State VNameSource) ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><span class="hs-identifier hs-var">forM_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)]
-&gt; [Param (TypeBase Shape NoUniqueness)]
-&gt; [(Param (TypeBase Shape NoUniqueness),
     Param (TypeBase Shape NoUniqueness))]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)]
</span><a href="#local-6989586621684419233"><span class="hs-identifier hs-var">slice_params</span></a></span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)]
</span><a href="#local-6989586621684419230"><span class="hs-identifier hs-var">inp_params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(((Param (TypeBase Shape NoUniqueness),
   Param (TypeBase Shape NoUniqueness))
  -&gt; BuilderT SOACS (State VNameSource) ())
 -&gt; BuilderT SOACS (State VNameSource) ())
-&gt; ((Param (TypeBase Shape NoUniqueness),
     Param (TypeBase Shape NoUniqueness))
    -&gt; BuilderT SOACS (State VNameSource) ())
-&gt; BuilderT SOACS (State VNameSource) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684419214"><span class="annot"><span class="annottext">Param (TypeBase Shape NoUniqueness)
</span><a href="#local-6989586621684419214"><span class="hs-identifier hs-var">slice</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419213"><span class="annot"><span class="annottext">Param (TypeBase Shape NoUniqueness)
</span><a href="#local-6989586621684419213"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-179"></span><span>        </span><span class="annot"><span class="annottext">[VName]
-&gt; Exp (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT SOACS (State VNameSource) ()
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
[VName] -&gt; Exp (Rep m) -&gt; m ()
</span><a href="Futhark.Builder.Class.html#letBindNames"><span class="hs-identifier hs-var">letBindNames</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Param (TypeBase Shape NoUniqueness) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase Shape NoUniqueness)
</span><a href="#local-6989586621684419214"><span class="hs-identifier hs-var">slice</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT SOACS (State VNameSource)))
 -&gt; BuilderT SOACS (State VNameSource) ())
-&gt; Exp (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT SOACS (State VNameSource) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-180"></span><span>          </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT SOACS) -&gt; BasicOp -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; TypeBase Shape NoUniqueness -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#ArrayLit"><span class="hs-identifier hs-var">ArrayLit</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">VName -&gt; SubExp
</span><a href="Futhark.IR.Syntax.Core.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SubExp) -&gt; VName -&gt; SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase Shape NoUniqueness) -&gt; VName
forall dec. Param dec -&gt; VName
</span><a href="Futhark.IR.Syntax.Core.html#paramName"><span class="hs-identifier hs-var hs-var">paramName</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase Shape NoUniqueness)
</span><a href="#local-6989586621684419213"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Param (TypeBase Shape NoUniqueness) -&gt; TypeBase Shape NoUniqueness
forall dec. Typed dec =&gt; Param dec -&gt; TypeBase Shape NoUniqueness
</span><a href="Futhark.IR.Prop.Patterns.html#paramType"><span class="hs-identifier hs-var">paramType</span></a></span><span> </span><span class="annot"><span class="annottext">Param (TypeBase Shape NoUniqueness)
</span><a href="#local-6989586621684419213"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684419210"><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684419210"><span class="hs-identifier hs-var">red_res</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419209"><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684419209"><span class="hs-identifier hs-var">map_res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [SubExpRes] -&gt; ([SubExpRes], [SubExpRes])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419237"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; ([SubExpRes], [SubExpRes]))
-&gt; BuilderT SOACS (State VNameSource) [SubExpRes]
-&gt; BuilderT SOACS (State VNameSource) ([SubExpRes], [SubExpRes])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Body (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT SOACS (State VNameSource) [SubExpRes]
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
Body (Rep m) -&gt; m [SubExpRes]
</span><a href="Futhark.Builder.Class.html#bodyBind"><span class="hs-identifier hs-var">bodyBind</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; Body SOACS
forall rep. LambdaT rep -&gt; BodyT rep
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var hs-var">lambdaBody</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419236"><span class="hs-identifier hs-var">lam</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span>      </span><span id="local-6989586621684419206"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419206"><span class="hs-identifier hs-var">map_res'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
-&gt; (SubExpRes -&gt; BuilderT SOACS (State VNameSource) SubExp)
-&gt; BuilderT SOACS (State VNameSource) [SubExp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684419209"><span class="hs-identifier hs-var">map_res</span></a></span><span> </span><span class="annot"><span class="annottext">((SubExpRes -&gt; BuilderT SOACS (State VNameSource) SubExp)
 -&gt; BuilderT SOACS (State VNameSource) [SubExp])
-&gt; (SubExpRes -&gt; BuilderT SOACS (State VNameSource) SubExp)
-&gt; BuilderT SOACS (State VNameSource) [SubExp]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#SubExpRes"><span class="hs-identifier hs-type">SubExpRes</span></a></span><span> </span><span id="local-6989586621684419205"><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684419205"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684419204"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419204"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-185"></span><span>        </span><span id="local-6989586621684419203"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419203"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT SOACS (State VNameSource) VName
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m VName
</span><a href="Futhark.Construct.html#letExp"><span class="hs-identifier hs-var">letExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;map_res&quot;</span></span><span> </span><span class="annot"><span class="annottext">(Exp (Rep (BuilderT SOACS (State VNameSource)))
 -&gt; BuilderT SOACS (State VNameSource) VName)
-&gt; Exp (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT SOACS (State VNameSource) VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; ExpT SOACS) -&gt; BasicOp -&gt; ExpT SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#SubExp"><span class="hs-identifier hs-var">SubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419204"><span class="hs-identifier hs-var">se</span></a></span><span>
</span><span id="line-186"></span><span>        </span><span id="local-6989586621684419201"><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684419201"><span class="hs-identifier hs-var">v_t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">VName
-&gt; BuilderT SOACS (State VNameSource) (TypeBase Shape NoUniqueness)
forall rep (m :: * -&gt; *).
HasScope rep m =&gt;
VName -&gt; m (TypeBase Shape NoUniqueness)
</span><a href="Futhark.IR.Prop.Scope.html#lookupType"><span class="hs-identifier hs-var">lookupType</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419203"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-187"></span><span>        </span><span class="annot"><span class="annottext">Certs
-&gt; BuilderT SOACS (State VNameSource) SubExp
-&gt; BuilderT SOACS (State VNameSource) SubExp
forall (m :: * -&gt; *) a. MonadBuilder m =&gt; Certs -&gt; m a -&gt; m a
</span><a href="Futhark.Builder.Class.html#certifying"><span class="hs-identifier hs-var">certifying</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684419205"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT SOACS (State VNameSource) SubExp
 -&gt; BuilderT SOACS (State VNameSource) SubExp)
-&gt; (BasicOp -&gt; BuilderT SOACS (State VNameSource) SubExp)
-&gt; BasicOp
-&gt; BuilderT SOACS (State VNameSource) SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">String
-&gt; Exp (Rep (BuilderT SOACS (State VNameSource)))
-&gt; BuilderT SOACS (State VNameSource) SubExp
forall (m :: * -&gt; *).
MonadBuilder m =&gt;
String -&gt; Exp (Rep m) -&gt; m SubExp
</span><a href="Futhark.Construct.html#letSubExp"><span class="hs-identifier hs-var">letSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;chunk&quot;</span></span><span> </span><span class="annot"><span class="annottext">(ExpT SOACS -&gt; BuilderT SOACS (State VNameSource) SubExp)
-&gt; (BasicOp -&gt; ExpT SOACS)
-&gt; BasicOp
-&gt; BuilderT SOACS (State VNameSource) SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">BasicOp -&gt; ExpT SOACS
forall rep. BasicOp -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#BasicOp"><span class="hs-identifier hs-var">BasicOp</span></a></span><span> </span><span class="annot"><span class="annottext">(BasicOp -&gt; BuilderT SOACS (State VNameSource) SubExp)
-&gt; BasicOp -&gt; BuilderT SOACS (State VNameSource) SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-188"></span><span>          </span><span class="annot"><span class="annottext">VName -&gt; Slice SubExp -&gt; BasicOp
</span><a href="Futhark.IR.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419203"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Slice SubExp -&gt; BasicOp) -&gt; Slice SubExp -&gt; BasicOp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; [DimIndex SubExp] -&gt; Slice SubExp
</span><a href="Futhark.Construct.html#fullSlice"><span class="hs-identifier hs-var">fullSlice</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness
</span><a href="#local-6989586621684419201"><span class="hs-identifier hs-var">v_t</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SubExp -&gt; DimIndex SubExp
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; DimIndex SubExp) -&gt; SubExp -&gt; DimIndex SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; Integer -&gt; SubExp
</span><a href="Futhark.IR.Prop.Constants.html#intConst"><span class="hs-identifier hs-var">intConst</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span> </span><span class="annot"><span class="annottext">Integer
</span><span class="hs-number">0</span></span><span class="hs-special">]</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span>      </span><span class="annot"><span class="annottext">Body SOACS -&gt; Builder SOACS (Body SOACS)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Body SOACS -&gt; Builder SOACS (Body SOACS))
-&gt; Body SOACS -&gt; Builder SOACS (Body SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; [SubExpRes] -&gt; Body SOACS
forall rep. Buildable rep =&gt; Stms rep -&gt; [SubExpRes] -&gt; Body rep
</span><a href="Futhark.Builder.Class.html#mkBody"><span class="hs-identifier hs-var">mkBody</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; Body SOACS) -&gt; [SubExpRes] -&gt; Body SOACS
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684419210"><span class="hs-identifier hs-var">red_res</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExpRes] -&gt; [SubExpRes] -&gt; [SubExpRes]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; [SubExpRes]
</span><a href="Futhark.IR.Syntax.html#subExpsRes"><span class="hs-identifier hs-var">subExpsRes</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419206"><span class="hs-identifier hs-var">map_res'</span></a></span><span>
</span><span id="line-191"></span><span>
</span><span id="line-192"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684419194"><span class="annot"><span class="annottext">[TypeBase Shape NoUniqueness]
</span><a href="#local-6989586621684419194"><span class="hs-identifier hs-var">red_ts</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419193"><span class="annot"><span class="annottext">[TypeBase Shape NoUniqueness]
</span><a href="#local-6989586621684419193"><span class="hs-identifier hs-var">map_ts</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [TypeBase Shape NoUniqueness]
-&gt; ([TypeBase Shape NoUniqueness], [TypeBase Shape NoUniqueness])
forall a. Int -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">splitAt</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SubExp] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419237"><span class="hs-identifier hs-var">nes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TypeBase Shape NoUniqueness]
 -&gt; ([TypeBase Shape NoUniqueness], [TypeBase Shape NoUniqueness]))
-&gt; [TypeBase Shape NoUniqueness]
-&gt; ([TypeBase Shape NoUniqueness], [TypeBase Shape NoUniqueness])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase Shape NoUniqueness]
forall rep. LambdaT rep -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419236"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-193"></span><span>      </span><span id="local-6989586621684419191"><span class="annot"><span class="annottext">map_lam :: Lambda SOACS
</span><a href="#local-6989586621684419191"><span class="hs-identifier hs-var hs-var">map_lam</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-194"></span><span>        </span><span class="annot"><span class="annottext">Lambda :: forall rep.
[LParam rep]
-&gt; BodyT rep -&gt; [TypeBase Shape NoUniqueness] -&gt; LambdaT rep
</span><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span>
</span><span id="line-195"></span><span>          </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">lambdaReturnType :: [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var">lambdaReturnType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeBase Shape NoUniqueness]
</span><a href="#local-6989586621684419194"><span class="hs-identifier hs-var">red_ts</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase Shape NoUniqueness]
-&gt; [TypeBase Shape NoUniqueness] -&gt; [TypeBase Shape NoUniqueness]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase Shape NoUniqueness -&gt; TypeBase Shape NoUniqueness)
-&gt; [TypeBase Shape NoUniqueness] -&gt; [TypeBase Shape NoUniqueness]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeBase Shape NoUniqueness -&gt; TypeBase Shape NoUniqueness
forall u. TypeBase Shape u -&gt; TypeBase Shape u
</span><a href="Futhark.IR.Prop.Types.html#rowType"><span class="hs-identifier hs-var">rowType</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase Shape NoUniqueness]
</span><a href="#local-6989586621684419193"><span class="hs-identifier hs-var">map_ts</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-196"></span><span>            </span><span class="annot"><span class="annottext">lambdaParams :: [LParam SOACS]
</span><a href="Futhark.IR.Syntax.html#lambdaParams"><span class="hs-identifier hs-var">lambdaParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Param (TypeBase Shape NoUniqueness)]
[LParam SOACS]
</span><a href="#local-6989586621684419230"><span class="hs-identifier hs-var">inp_params</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-197"></span><span>            </span><span class="annot"><span class="annottext">lambdaBody :: Body SOACS
</span><a href="Futhark.IR.Syntax.html#lambdaBody"><span class="hs-identifier hs-var">lambdaBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Body SOACS
</span><a href="#local-6989586621684419223"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-198"></span><span>          </span><span class="hs-special">}</span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span>  </span><span id="local-6989586621684419190"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684419190"><span class="hs-identifier hs-var">soacs_scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scope MC -&gt; Scope SOACS
forall fromrep torep.
SameScope fromrep torep =&gt;
Scope fromrep -&gt; Scope torep
</span><a href="Futhark.IR.Prop.Scope.html#castScope"><span class="hs-identifier hs-var">castScope</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope MC -&gt; Scope SOACS)
-&gt; ExtractM (Scope MC) -&gt; ExtractM (Scope SOACS)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ExtractM (Scope MC)
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-201"></span><span>  </span><span id="local-6989586621684419187"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419187"><span class="hs-identifier hs-var">map_lam'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT (Scope SOACS) ExtractM (Lambda SOACS)
-&gt; Scope SOACS -&gt; ExtractM (Lambda SOACS)
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; ReaderT (Scope SOACS) ExtractM (Lambda SOACS)
forall (m :: * -&gt; *).
(HasScope SOACS m, MonadFreshNames m) =&gt;
Lambda SOACS -&gt; m (Lambda SOACS)
</span><a href="Futhark.IR.SOACS.Simplify.html#simplifyLambda"><span class="hs-identifier hs-var">SOACS.simplifyLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419191"><span class="hs-identifier hs-var">map_lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684419190"><span class="hs-identifier hs-var">soacs_scope</span></a></span><span>
</span><span id="line-202"></span><span>
</span><span id="line-203"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Attr
</span><span class="hs-string">&quot;sequential_inner&quot;</span></span><span> </span><span class="annot"><span class="annottext">Attr -&gt; Attrs -&gt; Bool
</span><a href="Futhark.IR.Syntax.Core.html#inAttrs"><span class="hs-operator hs-var">`inAttrs`</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684419238"><span class="hs-identifier hs-var">attrs</span></a></span><span>
</span><span id="line-204"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; ExtractM (Lambda SOACS)
forall (m :: * -&gt; *) rep somerep.
(MonadFreshNames m, Buildable rep, BuilderOps rep,
 LocalScope somerep m, SameScope somerep rep,
 LetDec rep ~ LetDec SOACS, CanBeAliased (Op rep)) =&gt;
Lambda SOACS -&gt; m (Lambda rep)
</span><a href="Futhark.Transform.FirstOrderTransform.html#transformLambda"><span class="hs-identifier hs-var">FOT.transformLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419187"><span class="hs-identifier hs-var">map_lam'</span></a></span><span>
</span><span id="line-205"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; ExtractM (Lambda SOACS)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419187"><span class="hs-identifier hs-var">map_lam'</span></a></span><span>
</span><span id="line-206"></span><span>
</span><span id="line-207"></span><span class="hs-comment">-- Code generation for each parallel basic block is parameterised over</span><span>
</span><span id="line-208"></span><span class="hs-comment">-- how we handle parallelism in the body (whether it's sequentialised</span><span>
</span><span id="line-209"></span><span class="hs-comment">-- by keeping it as SOACs, or turned into SegOps).</span><span>
</span><span id="line-210"></span><span>
</span><span id="line-211"></span><span class="hs-keyword">data</span><span> </span><span id="NeedsRename"><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#NeedsRename"><span class="hs-identifier hs-var">NeedsRename</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="DoRename"><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#DoRename"><span class="hs-identifier hs-var">DoRename</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="DoNotRename"><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#DoNotRename"><span class="hs-identifier hs-var">DoNotRename</span></a></span></span><span>
</span><span id="line-212"></span><span>
</span><span id="line-213"></span><span id="local-6989586621684420001"><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#renameIfNeeded"><span class="hs-identifier hs-type">renameIfNeeded</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html#Rename"><span class="hs-identifier hs-type">Rename</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684420001"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#NeedsRename"><span class="hs-identifier hs-type">NeedsRename</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684420001"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684420001"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-214"></span><span id="renameIfNeeded"><span class="annot"><span class="annottext">renameIfNeeded :: forall a. Rename a =&gt; NeedsRename -&gt; a -&gt; ExtractM a
</span><a href="Futhark.Pass.ExtractMulticore.html#renameIfNeeded"><span class="hs-identifier hs-var hs-var">renameIfNeeded</span></a></span></span><span> </span><span class="annot"><span class="annottext">NeedsRename
</span><a href="Futhark.Pass.ExtractMulticore.html#DoRename"><span class="hs-identifier hs-var">DoRename</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; ExtractM a
forall a (m :: * -&gt; *). (Rename a, MonadFreshNames m) =&gt; a -&gt; m a
</span><a href="Futhark.Transform.Rename.html#renameSomething"><span class="hs-identifier hs-var">renameSomething</span></a></span><span>
</span><span id="line-215"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#renameIfNeeded"><span class="hs-identifier hs-var">renameIfNeeded</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsRename
</span><a href="Futhark.Pass.ExtractMulticore.html#DoNotRename"><span class="hs-identifier hs-var">DoNotRename</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a -&gt; ExtractM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-216"></span><span>
</span><span id="line-217"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformMap"><span class="hs-identifier hs-type">transformMap</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-218"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#NeedsRename"><span class="hs-identifier hs-type">NeedsRename</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-219"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-220"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-221"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-222"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-223"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SegOp.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-224"></span><span id="transformMap"><span class="annot"><span class="annottext">transformMap :: NeedsRename
-&gt; (Body SOACS -&gt; ExtractM (Body MC))
-&gt; SubExp
-&gt; Lambda SOACS
-&gt; [VName]
-&gt; ExtractM (SegOp () MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformMap"><span class="hs-identifier hs-var hs-var">transformMap</span></a></span></span><span> </span><span id="local-6989586621684419174"><span class="annot"><span class="annottext">NeedsRename
</span><a href="#local-6989586621684419174"><span class="hs-identifier hs-var">rename</span></a></span></span><span> </span><span id="local-6989586621684419173"><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="#local-6989586621684419173"><span class="hs-identifier hs-var">onBody</span></a></span></span><span> </span><span id="local-6989586621684419172"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419172"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684419171"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419171"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span> </span><span id="local-6989586621684419170"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419170"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-225"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684419169"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419169"><span class="hs-identifier hs-var">gtid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419168"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684419168"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ExtractM (VName, SegSpace)
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
SubExp -&gt; m (VName, SegSpace)
</span><a href="Futhark.Pass.ExtractMulticore.html#mkSegSpace"><span class="hs-identifier hs-var">mkSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419172"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-226"></span><span>  </span><span id="local-6989586621684419167"><span class="annot"><span class="annottext">KernelBody MC
</span><a href="#local-6989586621684419167"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Body SOACS -&gt; ExtractM (Body MC))
-&gt; VName -&gt; Lambda SOACS -&gt; [VName] -&gt; ExtractM (KernelBody MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#mapLambdaToKernelBody"><span class="hs-identifier hs-var">mapLambdaToKernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="#local-6989586621684419173"><span class="hs-identifier hs-var">onBody</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419169"><span class="hs-identifier hs-var">gtid</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419171"><span class="hs-identifier hs-var">map_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419170"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-227"></span><span>  </span><span class="annot"><span class="annottext">NeedsRename -&gt; SegOp () MC -&gt; ExtractM (SegOp () MC)
forall a. Rename a =&gt; NeedsRename -&gt; a -&gt; ExtractM a
</span><a href="Futhark.Pass.ExtractMulticore.html#renameIfNeeded"><span class="hs-identifier hs-var">renameIfNeeded</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsRename
</span><a href="#local-6989586621684419174"><span class="hs-identifier hs-var">rename</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp () MC -&gt; ExtractM (SegOp () MC))
-&gt; SegOp () MC -&gt; ExtractM (SegOp () MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="annottext">()
-&gt; SegSpace
-&gt; [TypeBase Shape NoUniqueness]
-&gt; KernelBody MC
-&gt; SegOp () MC
forall lvl rep.
lvl
-&gt; SegSpace
-&gt; [TypeBase Shape NoUniqueness]
-&gt; KernelBody rep
-&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-var">SegMap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684419168"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase Shape NoUniqueness]
forall rep. LambdaT rep -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419171"><span class="hs-identifier hs-var">map_lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KernelBody MC
</span><a href="#local-6989586621684419167"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformRedomap"><span class="hs-identifier hs-type">transformRedomap</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-231"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#NeedsRename"><span class="hs-identifier hs-type">NeedsRename</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-233"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-234"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-type">Reduce</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-235"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-236"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-237"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-238"></span><span id="transformRedomap"><span class="annot"><span class="annottext">transformRedomap :: NeedsRename
-&gt; (Body SOACS -&gt; ExtractM (Body MC))
-&gt; SubExp
-&gt; [Reduce SOACS]
-&gt; Lambda SOACS
-&gt; [VName]
-&gt; ExtractM ([Stms MC], SegOp () MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformRedomap"><span class="hs-identifier hs-var hs-var">transformRedomap</span></a></span></span><span> </span><span id="local-6989586621684419164"><span class="annot"><span class="annottext">NeedsRename
</span><a href="#local-6989586621684419164"><span class="hs-identifier hs-var">rename</span></a></span></span><span> </span><span id="local-6989586621684419163"><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="#local-6989586621684419163"><span class="hs-identifier hs-var">onBody</span></a></span></span><span> </span><span id="local-6989586621684419162"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419162"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684419161"><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684419161"><span class="hs-identifier hs-var">reds</span></a></span></span><span> </span><span id="local-6989586621684419160"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419160"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span> </span><span id="local-6989586621684419159"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419159"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684419158"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419158"><span class="hs-identifier hs-var">gtid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419157"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684419157"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ExtractM (VName, SegSpace)
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
SubExp -&gt; m (VName, SegSpace)
</span><a href="Futhark.Pass.ExtractMulticore.html#mkSegSpace"><span class="hs-identifier hs-var">mkSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419162"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-240"></span><span>  </span><span id="local-6989586621684419156"><span class="annot"><span class="annottext">KernelBody MC
</span><a href="#local-6989586621684419156"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Body SOACS -&gt; ExtractM (Body MC))
-&gt; VName -&gt; Lambda SOACS -&gt; [VName] -&gt; ExtractM (KernelBody MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#mapLambdaToKernelBody"><span class="hs-identifier hs-var">mapLambdaToKernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="#local-6989586621684419163"><span class="hs-identifier hs-var">onBody</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419158"><span class="hs-identifier hs-var">gtid</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419160"><span class="hs-identifier hs-var">map_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419159"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-241"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684419155"><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419155"><span class="hs-identifier hs-var">reds_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419154"><span class="annot"><span class="annottext">[SegBinOp MC]
</span><a href="#local-6989586621684419154"><span class="hs-identifier hs-var">reds'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Stms MC, SegBinOp MC)] -&gt; ([Stms MC], [SegBinOp MC])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Stms MC, SegBinOp MC)] -&gt; ([Stms MC], [SegBinOp MC]))
-&gt; ExtractM [(Stms MC, SegBinOp MC)]
-&gt; ExtractM ([Stms MC], [SegBinOp MC])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Reduce SOACS -&gt; ExtractM (Stms MC, SegBinOp MC))
-&gt; [Reduce SOACS] -&gt; ExtractM [(Stms MC, SegBinOp MC)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Reduce SOACS -&gt; ExtractM (Stms MC, SegBinOp MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#reduceToSegBinOp"><span class="hs-identifier hs-var">reduceToSegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684419161"><span class="hs-identifier hs-var">reds</span></a></span><span>
</span><span id="line-242"></span><span>  </span><span id="local-6989586621684419152"><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419152"><span class="hs-identifier hs-var">op'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-243"></span><span>    </span><span class="annot"><span class="annottext">NeedsRename -&gt; SegOp () MC -&gt; ExtractM (SegOp () MC)
forall a. Rename a =&gt; NeedsRename -&gt; a -&gt; ExtractM a
</span><a href="Futhark.Pass.ExtractMulticore.html#renameIfNeeded"><span class="hs-identifier hs-var">renameIfNeeded</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsRename
</span><a href="#local-6989586621684419164"><span class="hs-identifier hs-var">rename</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp () MC -&gt; ExtractM (SegOp () MC))
-&gt; SegOp () MC -&gt; ExtractM (SegOp () MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-244"></span><span>      </span><span class="annot"><span class="annottext">()
-&gt; SegSpace
-&gt; [SegBinOp MC]
-&gt; [TypeBase Shape NoUniqueness]
-&gt; KernelBody MC
-&gt; SegOp () MC
forall lvl rep.
lvl
-&gt; SegSpace
-&gt; [SegBinOp rep]
-&gt; [TypeBase Shape NoUniqueness]
-&gt; KernelBody rep
-&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegRed"><span class="hs-identifier hs-var">SegRed</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684419157"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MC]
</span><a href="#local-6989586621684419154"><span class="hs-identifier hs-var">reds'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase Shape NoUniqueness]
forall rep. LambdaT rep -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419160"><span class="hs-identifier hs-var">map_lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KernelBody MC
</span><a href="#local-6989586621684419156"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-245"></span><span>  </span><span class="annot"><span class="annottext">([Stms MC], SegOp () MC) -&gt; ExtractM ([Stms MC], SegOp () MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419155"><span class="hs-identifier hs-var">reds_stms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419152"><span class="hs-identifier hs-var">op'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>
</span><span id="line-247"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformHist"><span class="hs-identifier hs-type">transformHist</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-248"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#NeedsRename"><span class="hs-identifier hs-type">NeedsRename</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-250"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-251"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#HistOp"><span class="hs-identifier hs-type">SOACS.HistOp</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-252"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-253"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-254"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-255"></span><span id="transformHist"><span class="annot"><span class="annottext">transformHist :: NeedsRename
-&gt; (Body SOACS -&gt; ExtractM (Body MC))
-&gt; SubExp
-&gt; [HistOp SOACS]
-&gt; Lambda SOACS
-&gt; [VName]
-&gt; ExtractM ([Stms MC], SegOp () MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformHist"><span class="hs-identifier hs-var hs-var">transformHist</span></a></span></span><span> </span><span id="local-6989586621684419149"><span class="annot"><span class="annottext">NeedsRename
</span><a href="#local-6989586621684419149"><span class="hs-identifier hs-var">rename</span></a></span></span><span> </span><span id="local-6989586621684419148"><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="#local-6989586621684419148"><span class="hs-identifier hs-var">onBody</span></a></span></span><span> </span><span id="local-6989586621684419147"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419147"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684419146"><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684419146"><span class="hs-identifier hs-var">hists</span></a></span></span><span> </span><span id="local-6989586621684419145"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419145"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span> </span><span id="local-6989586621684419144"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419144"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684419143"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419143"><span class="hs-identifier hs-var">gtid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419142"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684419142"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ExtractM (VName, SegSpace)
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
SubExp -&gt; m (VName, SegSpace)
</span><a href="Futhark.Pass.ExtractMulticore.html#mkSegSpace"><span class="hs-identifier hs-var">mkSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419147"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-257"></span><span>  </span><span id="local-6989586621684419141"><span class="annot"><span class="annottext">KernelBody MC
</span><a href="#local-6989586621684419141"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Body SOACS -&gt; ExtractM (Body MC))
-&gt; VName -&gt; Lambda SOACS -&gt; [VName] -&gt; ExtractM (KernelBody MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#mapLambdaToKernelBody"><span class="hs-identifier hs-var">mapLambdaToKernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="#local-6989586621684419148"><span class="hs-identifier hs-var">onBody</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419143"><span class="hs-identifier hs-var">gtid</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419145"><span class="hs-identifier hs-var">map_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419144"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-258"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684419140"><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419140"><span class="hs-identifier hs-var">hists_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419139"><span class="annot"><span class="annottext">[HistOp MC]
</span><a href="#local-6989586621684419139"><span class="hs-identifier hs-var">hists'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Stms MC, HistOp MC)] -&gt; ([Stms MC], [HistOp MC])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Stms MC, HistOp MC)] -&gt; ([Stms MC], [HistOp MC]))
-&gt; ExtractM [(Stms MC, HistOp MC)]
-&gt; ExtractM ([Stms MC], [HistOp MC])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(HistOp SOACS -&gt; ExtractM (Stms MC, HistOp MC))
-&gt; [HistOp SOACS] -&gt; ExtractM [(Stms MC, HistOp MC)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">HistOp SOACS -&gt; ExtractM (Stms MC, HistOp MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#histToSegBinOp"><span class="hs-identifier hs-var">histToSegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684419146"><span class="hs-identifier hs-var">hists</span></a></span><span>
</span><span id="line-259"></span><span>  </span><span id="local-6989586621684419138"><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419138"><span class="hs-identifier hs-var">op'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-260"></span><span>    </span><span class="annot"><span class="annottext">NeedsRename -&gt; SegOp () MC -&gt; ExtractM (SegOp () MC)
forall a. Rename a =&gt; NeedsRename -&gt; a -&gt; ExtractM a
</span><a href="Futhark.Pass.ExtractMulticore.html#renameIfNeeded"><span class="hs-identifier hs-var">renameIfNeeded</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsRename
</span><a href="#local-6989586621684419149"><span class="hs-identifier hs-var">rename</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp () MC -&gt; ExtractM (SegOp () MC))
-&gt; SegOp () MC -&gt; ExtractM (SegOp () MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-261"></span><span>      </span><span class="annot"><span class="annottext">()
-&gt; SegSpace
-&gt; [HistOp MC]
-&gt; [TypeBase Shape NoUniqueness]
-&gt; KernelBody MC
-&gt; SegOp () MC
forall lvl rep.
lvl
-&gt; SegSpace
-&gt; [HistOp rep]
-&gt; [TypeBase Shape NoUniqueness]
-&gt; KernelBody rep
-&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegHist"><span class="hs-identifier hs-var">SegHist</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684419142"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp MC]
</span><a href="#local-6989586621684419139"><span class="hs-identifier hs-var">hists'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase Shape NoUniqueness]
forall rep. LambdaT rep -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419145"><span class="hs-identifier hs-var">map_lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KernelBody MC
</span><a href="#local-6989586621684419141"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-262"></span><span>  </span><span class="annot"><span class="annottext">([Stms MC], SegOp () MC) -&gt; ExtractM ([Stms MC], SegOp () MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419140"><span class="hs-identifier hs-var">hists_stms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419138"><span class="hs-identifier hs-var">op'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformParStream"><span class="hs-identifier hs-type">transformParStream</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-265"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#NeedsRename"><span class="hs-identifier hs-type">NeedsRename</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-267"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-268"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Commutativity"><span class="hs-identifier hs-type">Commutativity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-269"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-270"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#SubExp"><span class="hs-identifier hs-type">SubExp</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-271"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-272"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-273"></span><span>  </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.SegOp.html#SegOp"><span class="hs-identifier hs-type">SegOp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-274"></span><span id="transformParStream"><span class="annot"><span class="annottext">transformParStream :: NeedsRename
-&gt; (Body SOACS -&gt; ExtractM (Body MC))
-&gt; SubExp
-&gt; Commutativity
-&gt; Lambda SOACS
-&gt; [SubExp]
-&gt; Lambda SOACS
-&gt; [VName]
-&gt; ExtractM (Stms MC, SegOp () MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformParStream"><span class="hs-identifier hs-var hs-var">transformParStream</span></a></span></span><span> </span><span id="local-6989586621684419135"><span class="annot"><span class="annottext">NeedsRename
</span><a href="#local-6989586621684419135"><span class="hs-identifier hs-var">rename</span></a></span></span><span> </span><span id="local-6989586621684419134"><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="#local-6989586621684419134"><span class="hs-identifier hs-var">onBody</span></a></span></span><span> </span><span id="local-6989586621684419133"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419133"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684419132"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684419132"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684419131"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419131"><span class="hs-identifier hs-var">red_lam</span></a></span></span><span> </span><span id="local-6989586621684419130"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419130"><span class="hs-identifier hs-var">red_nes</span></a></span></span><span> </span><span id="local-6989586621684419129"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419129"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span> </span><span id="local-6989586621684419128"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419128"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-275"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684419127"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419127"><span class="hs-identifier hs-var">gtid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419126"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684419126"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ExtractM (VName, SegSpace)
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
SubExp -&gt; m (VName, SegSpace)
</span><a href="Futhark.Pass.ExtractMulticore.html#mkSegSpace"><span class="hs-identifier hs-var">mkSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419133"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-276"></span><span>  </span><span id="local-6989586621684419125"><span class="annot"><span class="annottext">KernelBody MC
</span><a href="#local-6989586621684419125"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Body SOACS -&gt; ExtractM (Body MC))
-&gt; VName -&gt; Lambda SOACS -&gt; [VName] -&gt; ExtractM (KernelBody MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#mapLambdaToKernelBody"><span class="hs-identifier hs-var">mapLambdaToKernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="#local-6989586621684419134"><span class="hs-identifier hs-var">onBody</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419127"><span class="hs-identifier hs-var">gtid</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419129"><span class="hs-identifier hs-var">map_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419128"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-277"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684419124"><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419124"><span class="hs-identifier hs-var">red_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419123"><span class="annot"><span class="annottext">SegBinOp MC
</span><a href="#local-6989586621684419123"><span class="hs-identifier hs-var">red</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Reduce SOACS -&gt; ExtractM (Stms MC, SegBinOp MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#reduceToSegBinOp"><span class="hs-identifier hs-var">reduceToSegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">(Reduce SOACS -&gt; ExtractM (Stms MC, SegBinOp MC))
-&gt; Reduce SOACS -&gt; ExtractM (Stms MC, SegBinOp MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Commutativity -&gt; Lambda SOACS -&gt; [SubExp] -&gt; Reduce SOACS
forall rep. Commutativity -&gt; Lambda rep -&gt; [SubExp] -&gt; Reduce rep
</span><a href="Futhark.IR.SOACS.SOAC.html#Reduce"><span class="hs-identifier hs-var">Reduce</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684419132"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419131"><span class="hs-identifier hs-var">red_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419130"><span class="hs-identifier hs-var">red_nes</span></a></span><span>
</span><span id="line-278"></span><span>  </span><span id="local-6989586621684419122"><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419122"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-279"></span><span>    </span><span class="annot"><span class="annottext">NeedsRename -&gt; SegOp () MC -&gt; ExtractM (SegOp () MC)
forall a. Rename a =&gt; NeedsRename -&gt; a -&gt; ExtractM a
</span><a href="Futhark.Pass.ExtractMulticore.html#renameIfNeeded"><span class="hs-identifier hs-var">renameIfNeeded</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsRename
</span><a href="#local-6989586621684419135"><span class="hs-identifier hs-var">rename</span></a></span><span> </span><span class="annot"><span class="annottext">(SegOp () MC -&gt; ExtractM (SegOp () MC))
-&gt; SegOp () MC -&gt; ExtractM (SegOp () MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-280"></span><span>      </span><span class="annot"><span class="annottext">()
-&gt; SegSpace
-&gt; [SegBinOp MC]
-&gt; [TypeBase Shape NoUniqueness]
-&gt; KernelBody MC
-&gt; SegOp () MC
forall lvl rep.
lvl
-&gt; SegSpace
-&gt; [SegBinOp rep]
-&gt; [TypeBase Shape NoUniqueness]
-&gt; KernelBody rep
-&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegRed"><span class="hs-identifier hs-var">SegRed</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684419126"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">SegBinOp MC
</span><a href="#local-6989586621684419123"><span class="hs-identifier hs-var">red</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase Shape NoUniqueness]
forall rep. LambdaT rep -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419129"><span class="hs-identifier hs-var">map_lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KernelBody MC
</span><a href="#local-6989586621684419125"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-281"></span><span>  </span><span class="annot"><span class="annottext">(Stms MC, SegOp () MC) -&gt; ExtractM (Stms MC, SegOp () MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419124"><span class="hs-identifier hs-var">red_stms</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419122"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>
</span><span id="line-283"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformSOAC"><span class="hs-identifier hs-type">transformSOAC</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Attrs"><span class="hs-identifier hs-type">Attrs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#SOAC"><span class="hs-identifier hs-type">SOAC</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Stms"><span class="hs-identifier hs-type">Stms</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-284"></span><span id="transformSOAC"><span class="annot"><span class="annottext">transformSOAC :: Pat SOACS -&gt; Attrs -&gt; SOAC SOACS -&gt; ExtractM (Stms MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformSOAC"><span class="hs-identifier hs-var hs-var">transformSOAC</span></a></span></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#JVP"><span class="hs-identifier hs-type">JVP</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-285"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; ExtractM (Stms MC)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;transformSOAC: unhandled JVP&quot;</span></span><span>
</span><span id="line-286"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformSOAC"><span class="hs-identifier hs-var">transformSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#VJP"><span class="hs-identifier hs-type">VJP</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-287"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; ExtractM (Stms MC)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;transformSOAC: unhandled VJP&quot;</span></span><span>
</span><span id="line-288"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformSOAC"><span class="hs-identifier hs-var">transformSOAC</span></a></span><span> </span><span id="local-6989586621684419118"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684419118"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Screma"><span class="hs-identifier hs-type">Screma</span></a></span><span> </span><span id="local-6989586621684419116"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419116"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684419115"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419115"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684419114"><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684419114"><span class="hs-identifier hs-var">form</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684419113"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419113"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS -&gt; Maybe (Lambda SOACS)
forall rep. ScremaForm rep -&gt; Maybe (Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isMapSOAC"><span class="hs-identifier hs-var">isMapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684419114"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-290"></span><span>    </span><span id="local-6989586621684419111"><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419111"><span class="hs-identifier hs-var">seq_op</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NeedsRename
-&gt; (Body SOACS -&gt; ExtractM (Body MC))
-&gt; SubExp
-&gt; Lambda SOACS
-&gt; [VName]
-&gt; ExtractM (SegOp () MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformMap"><span class="hs-identifier hs-var">transformMap</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsRename
</span><a href="Futhark.Pass.ExtractMulticore.html#DoNotRename"><span class="hs-identifier hs-var">DoNotRename</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#sequentialiseBody"><span class="hs-identifier hs-var">sequentialiseBody</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419116"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419113"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419115"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-291"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#lambdaContainsParallelism"><span class="hs-identifier hs-var">lambdaContainsParallelism</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419113"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-292"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-293"></span><span>        </span><span id="local-6989586621684419109"><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419109"><span class="hs-identifier hs-var">par_op</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NeedsRename
-&gt; (Body SOACS -&gt; ExtractM (Body MC))
-&gt; SubExp
-&gt; Lambda SOACS
-&gt; [VName]
-&gt; ExtractM (SegOp () MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformMap"><span class="hs-identifier hs-var">transformMap</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsRename
</span><a href="Futhark.Pass.ExtractMulticore.html#DoRename"><span class="hs-identifier hs-var">DoRename</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419116"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419113"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419115"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-294"></span><span>        </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; ExtractM (Stms MC)) -&gt; Stms MC -&gt; ExtractM (Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419118"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stm MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op MC -&gt; Exp MC
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op MC -&gt; Exp MC) -&gt; Op MC -&gt; Exp MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MC) -&gt; SegOp () MC -&gt; MCOp MC (SOAC MC)
forall rep op. Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-var">ParOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOp () MC -&gt; Maybe (SegOp () MC)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419109"><span class="hs-identifier hs-var">par_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419111"><span class="hs-identifier hs-var">seq_op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-295"></span><span>      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; ExtractM (Stms MC)) -&gt; Stms MC -&gt; ExtractM (Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419118"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stm MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op MC -&gt; Exp MC
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op MC -&gt; Exp MC) -&gt; Op MC -&gt; Exp MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MC) -&gt; SegOp () MC -&gt; MCOp MC (SOAC MC)
forall rep op. Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-var">ParOp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MC)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419111"><span class="hs-identifier hs-var">seq_op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-296"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684419107"><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684419107"><span class="hs-identifier hs-var">reds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419106"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419106"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS -&gt; Maybe ([Reduce SOACS], Lambda SOACS)
forall rep. ScremaForm rep -&gt; Maybe ([Reduce rep], Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isRedomapSOAC"><span class="hs-identifier hs-var">isRedomapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684419114"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-297"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684419104"><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419104"><span class="hs-identifier hs-var">seq_reds_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419103"><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419103"><span class="hs-identifier hs-var">seq_op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-298"></span><span>      </span><span class="annot"><span class="annottext">NeedsRename
-&gt; (Body SOACS -&gt; ExtractM (Body MC))
-&gt; SubExp
-&gt; [Reduce SOACS]
-&gt; Lambda SOACS
-&gt; [VName]
-&gt; ExtractM ([Stms MC], SegOp () MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformRedomap"><span class="hs-identifier hs-var">transformRedomap</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsRename
</span><a href="Futhark.Pass.ExtractMulticore.html#DoNotRename"><span class="hs-identifier hs-var">DoNotRename</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#sequentialiseBody"><span class="hs-identifier hs-var">sequentialiseBody</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419116"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684419107"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419106"><span class="hs-identifier hs-var">map_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419115"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#lambdaContainsParallelism"><span class="hs-identifier hs-var">lambdaContainsParallelism</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419106"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-300"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-301"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684419102"><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419102"><span class="hs-identifier hs-var">par_reds_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419101"><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419101"><span class="hs-identifier hs-var">par_op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-302"></span><span>          </span><span class="annot"><span class="annottext">NeedsRename
-&gt; (Body SOACS -&gt; ExtractM (Body MC))
-&gt; SubExp
-&gt; [Reduce SOACS]
-&gt; Lambda SOACS
-&gt; [VName]
-&gt; ExtractM ([Stms MC], SegOp () MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformRedomap"><span class="hs-identifier hs-var">transformRedomap</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsRename
</span><a href="Futhark.Pass.ExtractMulticore.html#DoRename"><span class="hs-identifier hs-var">DoRename</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419116"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[Reduce SOACS]
</span><a href="#local-6989586621684419107"><span class="hs-identifier hs-var">reds</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419106"><span class="hs-identifier hs-var">map_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419115"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-303"></span><span>        </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; ExtractM (Stms MC)) -&gt; Stms MC -&gt; ExtractM (Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-304"></span><span>          </span><span class="annot"><span class="annottext">[Stms MC] -&gt; Stms MC
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419104"><span class="hs-identifier hs-var">seq_reds_stms</span></a></span><span> </span><span class="annot"><span class="annottext">[Stms MC] -&gt; [Stms MC] -&gt; [Stms MC]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419102"><span class="hs-identifier hs-var">par_reds_stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-305"></span><span>            </span><span class="annot"><span class="annottext">Stms MC -&gt; Stms MC -&gt; Stms MC
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419118"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stm MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op MC -&gt; Exp MC
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op MC -&gt; Exp MC) -&gt; Op MC -&gt; Exp MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MC) -&gt; SegOp () MC -&gt; MCOp MC (SOAC MC)
forall rep op. Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-var">ParOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOp () MC -&gt; Maybe (SegOp () MC)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419101"><span class="hs-identifier hs-var">par_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419103"><span class="hs-identifier hs-var">seq_op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-307"></span><span>        </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; ExtractM (Stms MC)) -&gt; Stms MC -&gt; ExtractM (Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-308"></span><span>          </span><span class="annot"><span class="annottext">[Stms MC] -&gt; Stms MC
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419104"><span class="hs-identifier hs-var">seq_reds_stms</span></a></span><span>
</span><span id="line-309"></span><span>            </span><span class="annot"><span class="annottext">Stms MC -&gt; Stms MC -&gt; Stms MC
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419118"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stm MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op MC -&gt; Exp MC
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op MC -&gt; Exp MC) -&gt; Op MC -&gt; Exp MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MC) -&gt; SegOp () MC -&gt; MCOp MC (SOAC MC)
forall rep op. Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-var">ParOp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MC)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419103"><span class="hs-identifier hs-var">seq_op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-310"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684419100"><span class="annot"><span class="annottext">[Scan SOACS]
</span><a href="#local-6989586621684419100"><span class="hs-identifier hs-var">scans</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419099"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419099"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS -&gt; Maybe ([Scan SOACS], Lambda SOACS)
forall rep. ScremaForm rep -&gt; Maybe ([Scan rep], Lambda rep)
</span><a href="Futhark.IR.SOACS.SOAC.html#isScanomapSOAC"><span class="hs-identifier hs-var">isScanomapSOAC</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm SOACS
</span><a href="#local-6989586621684419114"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-311"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684419097"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419097"><span class="hs-identifier hs-var">gtid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419096"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684419096"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ExtractM (VName, SegSpace)
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
SubExp -&gt; m (VName, SegSpace)
</span><a href="Futhark.Pass.ExtractMulticore.html#mkSegSpace"><span class="hs-identifier hs-var">mkSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419116"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-312"></span><span>    </span><span id="local-6989586621684419095"><span class="annot"><span class="annottext">KernelBody MC
</span><a href="#local-6989586621684419095"><span class="hs-identifier hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Body SOACS -&gt; ExtractM (Body MC))
-&gt; VName -&gt; Lambda SOACS -&gt; [VName] -&gt; ExtractM (KernelBody MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#mapLambdaToKernelBody"><span class="hs-identifier hs-var">mapLambdaToKernelBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419097"><span class="hs-identifier hs-var">gtid</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419099"><span class="hs-identifier hs-var">map_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419115"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-313"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684419094"><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419094"><span class="hs-identifier hs-var">scans_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419093"><span class="annot"><span class="annottext">[SegBinOp MC]
</span><a href="#local-6989586621684419093"><span class="hs-identifier hs-var">scans'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Stms MC, SegBinOp MC)] -&gt; ([Stms MC], [SegBinOp MC])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Stms MC, SegBinOp MC)] -&gt; ([Stms MC], [SegBinOp MC]))
-&gt; ExtractM [(Stms MC, SegBinOp MC)]
-&gt; ExtractM ([Stms MC], [SegBinOp MC])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Scan SOACS -&gt; ExtractM (Stms MC, SegBinOp MC))
-&gt; [Scan SOACS] -&gt; ExtractM [(Stms MC, SegBinOp MC)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Scan SOACS -&gt; ExtractM (Stms MC, SegBinOp MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#scanToSegBinOp"><span class="hs-identifier hs-var">scanToSegBinOp</span></a></span><span> </span><span class="annot"><span class="annottext">[Scan SOACS]
</span><a href="#local-6989586621684419100"><span class="hs-identifier hs-var">scans</span></a></span><span>
</span><span id="line-314"></span><span>    </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; ExtractM (Stms MC)) -&gt; Stms MC -&gt; ExtractM (Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-315"></span><span>      </span><span class="annot"><span class="annottext">[Stms MC] -&gt; Stms MC
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419094"><span class="hs-identifier hs-var">scans_stms</span></a></span><span>
</span><span id="line-316"></span><span>        </span><span class="annot"><span class="annottext">Stms MC -&gt; Stms MC -&gt; Stms MC
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span>
</span><span id="line-317"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419118"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stm MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-318"></span><span>              </span><span class="annot"><span class="annottext">Op MC -&gt; Exp MC
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op MC -&gt; Exp MC) -&gt; Op MC -&gt; Exp MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-319"></span><span>                </span><span class="annot"><span class="annottext">Maybe (SegOp () MC) -&gt; SegOp () MC -&gt; MCOp MC (SOAC MC)
forall rep op. Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-var">ParOp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MC)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(SegOp () MC -&gt; MCOp MC (SOAC MC))
-&gt; SegOp () MC -&gt; MCOp MC (SOAC MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-320"></span><span>                  </span><span class="annot"><span class="annottext">()
-&gt; SegSpace
-&gt; [SegBinOp MC]
-&gt; [TypeBase Shape NoUniqueness]
-&gt; KernelBody MC
-&gt; SegOp () MC
forall lvl rep.
lvl
-&gt; SegSpace
-&gt; [SegBinOp rep]
-&gt; [TypeBase Shape NoUniqueness]
-&gt; KernelBody rep
-&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegScan"><span class="hs-identifier hs-var">SegScan</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684419096"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[SegBinOp MC]
</span><a href="#local-6989586621684419093"><span class="hs-identifier hs-var">scans'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase Shape NoUniqueness]
forall rep. LambdaT rep -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419099"><span class="hs-identifier hs-var">map_lam</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">KernelBody MC
</span><a href="#local-6989586621684419095"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-321"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-322"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-323"></span><span>    </span><span class="hs-comment">-- This screma is too complicated for us to immediately do</span><span>
</span><span id="line-324"></span><span>    </span><span class="hs-comment">-- anything, so split it up and try again.</span><span>
</span><span id="line-325"></span><span>    </span><span id="local-6989586621684419091"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684419091"><span class="hs-identifier hs-var">scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scope MC -&gt; Scope SOACS
forall fromrep torep.
SameScope fromrep torep =&gt;
Scope fromrep -&gt; Scope torep
</span><a href="Futhark.IR.Prop.Scope.html#castScope"><span class="hs-identifier hs-var">castScope</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope MC -&gt; Scope SOACS)
-&gt; ExtractM (Scope MC) -&gt; ExtractM (Scope SOACS)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ExtractM (Scope MC)
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-326"></span><span>    </span><span class="annot"><span class="annottext">Stms SOACS -&gt; ExtractM (Stms MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">(Stms SOACS -&gt; ExtractM (Stms MC))
-&gt; ExtractM (Stms SOACS) -&gt; ExtractM (Stms MC)
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">BuilderT SOACS ExtractM () -&gt; Scope SOACS -&gt; ExtractM (Stms SOACS)
forall (m :: * -&gt; *) rep.
MonadFreshNames m =&gt;
BuilderT rep m () -&gt; Scope rep -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT_"><span class="hs-identifier hs-var">runBuilderT_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS ExtractM))
-&gt; SubExp
-&gt; ScremaForm (Rep (BuilderT SOACS ExtractM))
-&gt; [VName]
-&gt; BuilderT SOACS ExtractM ()
forall (m :: * -&gt; *).
(MonadBuilder m, Op (Rep m) ~ SOAC (Rep m), Buildable (Rep m)) =&gt;
Pat (Rep m) -&gt; SubExp -&gt; ScremaForm (Rep m) -&gt; [VName] -&gt; m ()
</span><a href="Futhark.Tools.html#dissectScrema"><span class="hs-identifier hs-var">dissectScrema</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS ExtractM))
Pat SOACS
</span><a href="#local-6989586621684419118"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419116"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">ScremaForm (Rep (BuilderT SOACS ExtractM))
ScremaForm SOACS
</span><a href="#local-6989586621684419114"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419115"><span class="hs-identifier hs-var">arrs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684419091"><span class="hs-identifier hs-var">scope</span></a></span><span>
</span><span id="line-327"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformSOAC"><span class="hs-identifier hs-var">transformSOAC</span></a></span><span> </span><span id="local-6989586621684419087"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684419087"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Scatter"><span class="hs-identifier hs-type">Scatter</span></a></span><span> </span><span id="local-6989586621684419085"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419085"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684419084"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419084"><span class="hs-identifier hs-var">ivs</span></a></span></span><span> </span><span id="local-6989586621684419083"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419083"><span class="hs-identifier hs-var">lam</span></a></span></span><span> </span><span id="local-6989586621684419082"><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684419082"><span class="hs-identifier hs-var">dests</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-328"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684419081"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419081"><span class="hs-identifier hs-var">gtid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419080"><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684419080"><span class="hs-identifier hs-var">space</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">SubExp -&gt; ExtractM (VName, SegSpace)
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
SubExp -&gt; m (VName, SegSpace)
</span><a href="Futhark.Pass.ExtractMulticore.html#mkSegSpace"><span class="hs-identifier hs-var">mkSegSpace</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419085"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-329"></span><span>
</span><span id="line-330"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#Body"><span class="hs-identifier hs-type">Body</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684419079"><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419079"><span class="hs-identifier hs-var">kstms</span></a></span></span><span> </span><span id="local-6989586621684419078"><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684419078"><span class="hs-identifier hs-var">res</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Body SOACS -&gt; ExtractM (Body MC))
-&gt; VName -&gt; Lambda SOACS -&gt; [VName] -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#mapLambdaToBody"><span class="hs-identifier hs-var">mapLambdaToBody</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419081"><span class="hs-identifier hs-var">gtid</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419083"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419084"><span class="hs-identifier hs-var">ivs</span></a></span><span>
</span><span id="line-331"></span><span>
</span><span id="line-332"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684419077"><span class="annot"><span class="annottext">rets :: [TypeBase Shape NoUniqueness]
</span><a href="#local-6989586621684419077"><span class="hs-identifier hs-var hs-var">rets</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
-&gt; [TypeBase Shape NoUniqueness] -&gt; [TypeBase Shape NoUniqueness]
forall a. Int -&gt; [a] -&gt; [a]
</span><a href="Futhark.Util.html#takeLast"><span class="hs-identifier hs-var">takeLast</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Shape, Int, VName)] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684419082"><span class="hs-identifier hs-var">dests</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([TypeBase Shape NoUniqueness] -&gt; [TypeBase Shape NoUniqueness])
-&gt; [TypeBase Shape NoUniqueness] -&gt; [TypeBase Shape NoUniqueness]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; [TypeBase Shape NoUniqueness]
forall rep. LambdaT rep -&gt; [TypeBase Shape NoUniqueness]
</span><a href="Futhark.IR.Syntax.html#lambdaReturnType"><span class="hs-identifier hs-var hs-var">lambdaReturnType</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419083"><span class="hs-identifier hs-var">lam</span></a></span><span>
</span><span id="line-333"></span><span>      </span><span id="local-6989586621684419076"><span class="annot"><span class="annottext">kres :: [KernelResult]
</span><a href="#local-6989586621684419076"><span class="hs-identifier hs-var hs-var">kres</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-334"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684419075"><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684419075"><span class="hs-identifier hs-var">a_w</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419074"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419074"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419073"><span class="annot"><span class="annottext">[([SubExpRes], SubExpRes)]
</span><a href="#local-6989586621684419073"><span class="hs-identifier hs-var">is_vs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, VName)]
-&gt; [SubExpRes] -&gt; [(Shape, VName, [([SubExpRes], SubExpRes)])]
forall array a.
[(Shape, Int, array)] -&gt; [a] -&gt; [(Shape, array, [([a], a)])]
</span><a href="Futhark.IR.SOACS.SOAC.html#groupScatterResults"><span class="hs-identifier hs-var">groupScatterResults</span></a></span><span> </span><span class="annot"><span class="annottext">[(Shape, Int, VName)]
</span><a href="#local-6989586621684419082"><span class="hs-identifier hs-var">dests</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684419078"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-335"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684419071"><span class="annot"><span class="annottext">cs :: Certs
</span><a href="#local-6989586621684419071"><span class="hs-identifier hs-var hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-336"></span><span>              </span><span class="annot"><span class="annottext">(([SubExpRes], SubExpRes) -&gt; Certs)
-&gt; [([SubExpRes], SubExpRes)] -&gt; Certs
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(SubExpRes -&gt; Certs) -&gt; [SubExpRes] -&gt; Certs
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; Certs
</span><a href="Futhark.IR.Syntax.html#resCerts"><span class="hs-identifier hs-var hs-var">resCerts</span></a></span><span> </span><span class="annot"><span class="annottext">([SubExpRes] -&gt; Certs)
-&gt; (([SubExpRes], SubExpRes) -&gt; [SubExpRes])
-&gt; ([SubExpRes], SubExpRes)
-&gt; Certs
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([SubExpRes], SubExpRes) -&gt; [SubExpRes]
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[([SubExpRes], SubExpRes)]
</span><a href="#local-6989586621684419073"><span class="hs-identifier hs-var">is_vs</span></a></span><span>
</span><span id="line-337"></span><span>                </span><span class="annot"><span class="annottext">Certs -&gt; Certs -&gt; Certs
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(([SubExpRes], SubExpRes) -&gt; Certs)
-&gt; [([SubExpRes], SubExpRes)] -&gt; Certs
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExpRes -&gt; Certs
</span><a href="Futhark.IR.Syntax.html#resCerts"><span class="hs-identifier hs-var hs-var">resCerts</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; Certs)
-&gt; (([SubExpRes], SubExpRes) -&gt; SubExpRes)
-&gt; ([SubExpRes], SubExpRes)
-&gt; Certs
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([SubExpRes], SubExpRes) -&gt; SubExpRes
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[([SubExpRes], SubExpRes)]
</span><a href="#local-6989586621684419073"><span class="hs-identifier hs-var">is_vs</span></a></span><span>
</span><span id="line-338"></span><span>            </span><span id="local-6989586621684419068"><span class="annot"><span class="annottext">is_vs' :: [(Slice SubExp, SubExp)]
</span><a href="#local-6989586621684419068"><span class="hs-identifier hs-var hs-var">is_vs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex SubExp] -&gt; Slice SubExp
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex SubExp] -&gt; Slice SubExp)
-&gt; [DimIndex SubExp] -&gt; Slice SubExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(SubExpRes -&gt; DimIndex SubExp) -&gt; [SubExpRes] -&gt; [DimIndex SubExp]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SubExp -&gt; DimIndex SubExp
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(SubExp -&gt; DimIndex SubExp)
-&gt; (SubExpRes -&gt; SubExp) -&gt; SubExpRes -&gt; DimIndex SubExp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684419066"><span class="hs-identifier hs-var">is</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubExpRes -&gt; SubExp
</span><a href="Futhark.IR.Syntax.html#resSubExp"><span class="hs-identifier hs-var hs-var">resSubExp</span></a></span><span> </span><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684419065"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684419066"><span class="annot"><span class="annottext">[SubExpRes]
</span><a href="#local-6989586621684419066"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419065"><span class="annot"><span class="annottext">SubExpRes
</span><a href="#local-6989586621684419065"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[([SubExpRes], SubExpRes)]
</span><a href="#local-6989586621684419073"><span class="hs-identifier hs-var">is_vs</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-339"></span><span>        </span><span class="annot"><span class="annottext">KernelResult -&gt; [KernelResult]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(KernelResult -&gt; [KernelResult]) -&gt; KernelResult -&gt; [KernelResult]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Certs -&gt; Shape -&gt; VName -&gt; [(Slice SubExp, SubExp)] -&gt; KernelResult
</span><a href="Futhark.IR.SegOp.html#WriteReturns"><span class="hs-identifier hs-var">WriteReturns</span></a></span><span> </span><span class="annot"><span class="annottext">Certs
</span><a href="#local-6989586621684419071"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Shape
</span><a href="#local-6989586621684419075"><span class="hs-identifier hs-var">a_w</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684419074"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">[(Slice SubExp, SubExp)]
</span><a href="#local-6989586621684419068"><span class="hs-identifier hs-var">is_vs'</span></a></span><span>
</span><span id="line-340"></span><span>      </span><span id="local-6989586621684419063"><span class="annot"><span class="annottext">kbody :: KernelBody MC
</span><a href="#local-6989586621684419063"><span class="hs-identifier hs-var hs-var">kbody</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">BodyDec MC -&gt; Stms MC -&gt; [KernelResult] -&gt; KernelBody MC
forall rep.
BodyDec rep -&gt; Stms rep -&gt; [KernelResult] -&gt; KernelBody rep
</span><a href="Futhark.IR.SegOp.html#KernelBody"><span class="hs-identifier hs-var">KernelBody</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419079"><span class="hs-identifier hs-var">kstms</span></a></span><span> </span><span class="annot"><span class="annottext">[KernelResult]
</span><a href="#local-6989586621684419076"><span class="hs-identifier hs-var">kres</span></a></span><span>
</span><span id="line-341"></span><span>  </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; ExtractM (Stms MC)) -&gt; Stms MC -&gt; ExtractM (Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-342"></span><span>    </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="annot"><span class="annottext">(Stm MC -&gt; Stms MC) -&gt; Stm MC -&gt; Stms MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-343"></span><span>      </span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419087"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stm MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-344"></span><span>        </span><span class="annot"><span class="annottext">Op MC -&gt; Exp MC
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op MC -&gt; Exp MC) -&gt; Op MC -&gt; Exp MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-345"></span><span>          </span><span class="annot"><span class="annottext">Maybe (SegOp () MC) -&gt; SegOp () MC -&gt; MCOp MC (SOAC MC)
forall rep op. Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-var">ParOp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MC)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(SegOp () MC -&gt; MCOp MC (SOAC MC))
-&gt; SegOp () MC -&gt; MCOp MC (SOAC MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-346"></span><span>            </span><span class="annot"><span class="annottext">()
-&gt; SegSpace
-&gt; [TypeBase Shape NoUniqueness]
-&gt; KernelBody MC
-&gt; SegOp () MC
forall lvl rep.
lvl
-&gt; SegSpace
-&gt; [TypeBase Shape NoUniqueness]
-&gt; KernelBody rep
-&gt; SegOp lvl rep
</span><a href="Futhark.IR.SegOp.html#SegMap"><span class="hs-identifier hs-var">SegMap</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegSpace
</span><a href="#local-6989586621684419080"><span class="hs-identifier hs-var">space</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeBase Shape NoUniqueness]
</span><a href="#local-6989586621684419077"><span class="hs-identifier hs-var">rets</span></a></span><span> </span><span class="annot"><span class="annottext">KernelBody MC
</span><a href="#local-6989586621684419063"><span class="hs-identifier hs-var">kbody</span></a></span><span>
</span><span id="line-347"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformSOAC"><span class="hs-identifier hs-var">transformSOAC</span></a></span><span> </span><span id="local-6989586621684419062"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684419062"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Hist"><span class="hs-identifier hs-type">Hist</span></a></span><span> </span><span id="local-6989586621684419060"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419060"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684419059"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419059"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span id="local-6989586621684419058"><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684419058"><span class="hs-identifier hs-var">hists</span></a></span></span><span> </span><span id="local-6989586621684419057"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419057"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684419056"><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419056"><span class="hs-identifier hs-var">seq_hist_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419055"><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419055"><span class="hs-identifier hs-var">seq_op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-349"></span><span>    </span><span class="annot"><span class="annottext">NeedsRename
-&gt; (Body SOACS -&gt; ExtractM (Body MC))
-&gt; SubExp
-&gt; [HistOp SOACS]
-&gt; Lambda SOACS
-&gt; [VName]
-&gt; ExtractM ([Stms MC], SegOp () MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformHist"><span class="hs-identifier hs-var">transformHist</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsRename
</span><a href="Futhark.Pass.ExtractMulticore.html#DoNotRename"><span class="hs-identifier hs-var">DoNotRename</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#sequentialiseBody"><span class="hs-identifier hs-var">sequentialiseBody</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419060"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684419058"><span class="hs-identifier hs-var">hists</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419057"><span class="hs-identifier hs-var">map_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419059"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-350"></span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#lambdaContainsParallelism"><span class="hs-identifier hs-var">lambdaContainsParallelism</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419057"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-352"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-353"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684419054"><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419054"><span class="hs-identifier hs-var">par_hist_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419053"><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419053"><span class="hs-identifier hs-var">par_op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-354"></span><span>        </span><span class="annot"><span class="annottext">NeedsRename
-&gt; (Body SOACS -&gt; ExtractM (Body MC))
-&gt; SubExp
-&gt; [HistOp SOACS]
-&gt; Lambda SOACS
-&gt; [VName]
-&gt; ExtractM ([Stms MC], SegOp () MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformHist"><span class="hs-identifier hs-var">transformHist</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsRename
</span><a href="Futhark.Pass.ExtractMulticore.html#DoRename"><span class="hs-identifier hs-var">DoRename</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419060"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[HistOp SOACS]
</span><a href="#local-6989586621684419058"><span class="hs-identifier hs-var">hists</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419057"><span class="hs-identifier hs-var">map_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419059"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-355"></span><span>      </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; ExtractM (Stms MC)) -&gt; Stms MC -&gt; ExtractM (Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-356"></span><span>        </span><span class="annot"><span class="annottext">[Stms MC] -&gt; Stms MC
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419056"><span class="hs-identifier hs-var">seq_hist_stms</span></a></span><span> </span><span class="annot"><span class="annottext">[Stms MC] -&gt; [Stms MC] -&gt; [Stms MC]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419054"><span class="hs-identifier hs-var">par_hist_stms</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-357"></span><span>          </span><span class="annot"><span class="annottext">Stms MC -&gt; Stms MC -&gt; Stms MC
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419062"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stm MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op MC -&gt; Exp MC
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op MC -&gt; Exp MC) -&gt; Op MC -&gt; Exp MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MC) -&gt; SegOp () MC -&gt; MCOp MC (SOAC MC)
forall rep op. Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-var">ParOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOp () MC -&gt; Maybe (SegOp () MC)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419053"><span class="hs-identifier hs-var">par_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419055"><span class="hs-identifier hs-var">seq_op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-358"></span><span>    </span><span class="hs-keyword">else</span><span>
</span><span id="line-359"></span><span>      </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; ExtractM (Stms MC)) -&gt; Stms MC -&gt; ExtractM (Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-360"></span><span>        </span><span class="annot"><span class="annottext">[Stms MC] -&gt; Stms MC
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">[Stms MC]
</span><a href="#local-6989586621684419056"><span class="hs-identifier hs-var">seq_hist_stms</span></a></span><span>
</span><span id="line-361"></span><span>          </span><span class="annot"><span class="annottext">Stms MC -&gt; Stms MC -&gt; Stms MC
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419062"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stm MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op MC -&gt; Exp MC
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op MC -&gt; Exp MC) -&gt; Op MC -&gt; Exp MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MC) -&gt; SegOp () MC -&gt; MCOp MC (SOAC MC)
forall rep op. Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-var">ParOp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MC)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419055"><span class="hs-identifier hs-var">seq_op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-362"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformSOAC"><span class="hs-identifier hs-var">transformSOAC</span></a></span><span> </span><span id="local-6989586621684419052"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684419052"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684419051"><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684419051"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621684419049"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419049"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684419048"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419048"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Parallel"><span class="hs-identifier hs-type">Parallel</span></a></span><span> </span><span class="annot"><span class="annottext">StreamOrd
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684419046"><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684419046"><span class="hs-identifier hs-var">comm</span></a></span></span><span> </span><span id="local-6989586621684419045"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419045"><span class="hs-identifier hs-var">red_lam</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684419044"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419044"><span class="hs-identifier hs-var">red_nes</span></a></span></span><span> </span><span id="local-6989586621684419043"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419043"><span class="hs-identifier hs-var">fold_lam</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-363"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[SubExp] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419044"><span class="hs-identifier hs-var">red_nes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-364"></span><span>    </span><span id="local-6989586621684419040"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419040"><span class="hs-identifier hs-var">map_lam</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Attrs -&gt; [SubExp] -&gt; Lambda SOACS -&gt; ExtractM (Lambda SOACS)
</span><a href="Futhark.Pass.ExtractMulticore.html#unstreamLambda"><span class="hs-identifier hs-var">unstreamLambda</span></a></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><a href="#local-6989586621684419051"><span class="hs-identifier hs-var">attrs</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419044"><span class="hs-identifier hs-var">red_nes</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419043"><span class="hs-identifier hs-var">fold_lam</span></a></span><span>
</span><span id="line-365"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684419039"><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419039"><span class="hs-identifier hs-var">seq_red_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419038"><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419038"><span class="hs-identifier hs-var">seq_op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-366"></span><span>      </span><span class="annot"><span class="annottext">NeedsRename
-&gt; (Body SOACS -&gt; ExtractM (Body MC))
-&gt; SubExp
-&gt; Commutativity
-&gt; Lambda SOACS
-&gt; [SubExp]
-&gt; Lambda SOACS
-&gt; [VName]
-&gt; ExtractM (Stms MC, SegOp () MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformParStream"><span class="hs-identifier hs-var">transformParStream</span></a></span><span>
</span><span id="line-367"></span><span>        </span><span class="annot"><span class="annottext">NeedsRename
</span><a href="Futhark.Pass.ExtractMulticore.html#DoNotRename"><span class="hs-identifier hs-var">DoNotRename</span></a></span><span>
</span><span id="line-368"></span><span>        </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#sequentialiseBody"><span class="hs-identifier hs-var">sequentialiseBody</span></a></span><span>
</span><span id="line-369"></span><span>        </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419049"><span class="hs-identifier hs-var">w</span></a></span><span>
</span><span id="line-370"></span><span>        </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684419046"><span class="hs-identifier hs-var">comm</span></a></span><span>
</span><span id="line-371"></span><span>        </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419045"><span class="hs-identifier hs-var">red_lam</span></a></span><span>
</span><span id="line-372"></span><span>        </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419044"><span class="hs-identifier hs-var">red_nes</span></a></span><span>
</span><span id="line-373"></span><span>        </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419040"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-374"></span><span>        </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419048"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-375"></span><span>
</span><span id="line-376"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Lambda SOACS -&gt; Bool
</span><a href="Futhark.Pass.ExtractKernels.DistributeNests.html#lambdaContainsParallelism"><span class="hs-identifier hs-var">lambdaContainsParallelism</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419040"><span class="hs-identifier hs-var">map_lam</span></a></span><span>
</span><span id="line-377"></span><span>      </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-378"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684419037"><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419037"><span class="hs-identifier hs-var">par_red_stms</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684419036"><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419036"><span class="hs-identifier hs-var">par_op</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-379"></span><span>          </span><span class="annot"><span class="annottext">NeedsRename
-&gt; (Body SOACS -&gt; ExtractM (Body MC))
-&gt; SubExp
-&gt; Commutativity
-&gt; Lambda SOACS
-&gt; [SubExp]
-&gt; Lambda SOACS
-&gt; [VName]
-&gt; ExtractM (Stms MC, SegOp () MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformParStream"><span class="hs-identifier hs-var">transformParStream</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsRename
</span><a href="Futhark.Pass.ExtractMulticore.html#DoRename"><span class="hs-identifier hs-var">DoRename</span></a></span><span> </span><span class="annot"><span class="annottext">Body SOACS -&gt; ExtractM (Body MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformBody"><span class="hs-identifier hs-var">transformBody</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419049"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">Commutativity
</span><a href="#local-6989586621684419046"><span class="hs-identifier hs-var">comm</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419045"><span class="hs-identifier hs-var">red_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419044"><span class="hs-identifier hs-var">red_nes</span></a></span><span> </span><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419040"><span class="hs-identifier hs-var">map_lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419048"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-380"></span><span>        </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; ExtractM (Stms MC)) -&gt; Stms MC -&gt; ExtractM (Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-381"></span><span>          </span><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419039"><span class="hs-identifier hs-var">seq_red_stms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms MC -&gt; Stms MC -&gt; Stms MC
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419037"><span class="hs-identifier hs-var">par_red_stms</span></a></span><span>
</span><span id="line-382"></span><span>            </span><span class="annot"><span class="annottext">Stms MC -&gt; Stms MC -&gt; Stms MC
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419052"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stm MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op MC -&gt; Exp MC
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op MC -&gt; Exp MC) -&gt; Op MC -&gt; Exp MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MC) -&gt; SegOp () MC -&gt; MCOp MC (SOAC MC)
forall rep op. Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-var">ParOp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SegOp () MC -&gt; Maybe (SegOp () MC)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419036"><span class="hs-identifier hs-var">par_op</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419038"><span class="hs-identifier hs-var">seq_op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>      </span><span class="hs-keyword">else</span><span>
</span><span id="line-384"></span><span>        </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM (Stms MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Stms MC -&gt; ExtractM (Stms MC)) -&gt; Stms MC -&gt; ExtractM (Stms MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-385"></span><span>          </span><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419039"><span class="hs-identifier hs-var">seq_red_stms</span></a></span><span>
</span><span id="line-386"></span><span>            </span><span class="annot"><span class="annottext">Stms MC -&gt; Stms MC -&gt; Stms MC
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Stm MC -&gt; Stms MC
forall rep. Stm rep -&gt; Stms rep
</span><a href="Futhark.IR.Syntax.html#oneStm"><span class="hs-identifier hs-var">oneStm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Pat MC -&gt; StmAux (ExpDec MC) -&gt; Exp MC -&gt; Stm MC
forall rep. Pat rep -&gt; StmAux (ExpDec rep) -&gt; Exp rep -&gt; Stm rep
</span><a href="Futhark.IR.Syntax.html#Let"><span class="hs-identifier hs-var">Let</span></a></span><span> </span><span class="annot"><span class="annottext">Pat SOACS
Pat MC
</span><a href="#local-6989586621684419052"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; StmAux ()
forall dec. dec -&gt; StmAux dec
</span><a href="Futhark.IR.Prop.html#defAux"><span class="hs-identifier hs-var">defAux</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Exp MC -&gt; Stm MC) -&gt; Exp MC -&gt; Stm MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Op MC -&gt; Exp MC
forall rep. Op rep -&gt; ExpT rep
</span><a href="Futhark.IR.Syntax.html#Op"><span class="hs-identifier hs-var">Op</span></a></span><span> </span><span class="annot"><span class="annottext">(Op MC -&gt; Exp MC) -&gt; Op MC -&gt; Exp MC
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MC) -&gt; SegOp () MC -&gt; MCOp MC (SOAC MC)
forall rep op. Maybe (SegOp () rep) -&gt; SegOp () rep -&gt; MCOp rep op
</span><a href="Futhark.IR.MC.Op.html#ParOp"><span class="hs-identifier hs-var">ParOp</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (SegOp () MC)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">SegOp () MC
</span><a href="#local-6989586621684419038"><span class="hs-identifier hs-var">seq_op</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-387"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformSOAC"><span class="hs-identifier hs-var">transformSOAC</span></a></span><span> </span><span id="local-6989586621684419035"><span class="annot"><span class="annottext">Pat SOACS
</span><a href="#local-6989586621684419035"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">Attrs
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.SOACS.SOAC.html#Stream"><span class="hs-identifier hs-type">Stream</span></a></span><span> </span><span id="local-6989586621684419034"><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419034"><span class="hs-identifier hs-var">w</span></a></span></span><span> </span><span id="local-6989586621684419033"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419033"><span class="hs-identifier hs-var">arrs</span></a></span></span><span> </span><span class="annot"><span class="annottext">StreamForm SOACS
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684419032"><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419032"><span class="hs-identifier hs-var">nes</span></a></span></span><span> </span><span id="local-6989586621684419031"><span class="annot"><span class="annottext">Lambda SOACS
</span><a href="#local-6989586621684419031"><span class="hs-identifier hs-var">lam</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-388"></span><span>  </span><span class="hs-comment">-- Just remove the stream and transform the resulting stms.</span><span>
</span><span id="line-389"></span><span>  </span><span id="local-6989586621684419030"><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684419030"><span class="hs-identifier hs-var">soacs_scope</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Scope MC -&gt; Scope SOACS
forall fromrep torep.
SameScope fromrep torep =&gt;
Scope fromrep -&gt; Scope torep
</span><a href="Futhark.IR.Prop.Scope.html#castScope"><span class="hs-identifier hs-var">castScope</span></a></span><span> </span><span class="annot"><span class="annottext">(Scope MC -&gt; Scope SOACS)
-&gt; ExtractM (Scope MC) -&gt; ExtractM (Scope SOACS)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">ExtractM (Scope MC)
forall rep (m :: * -&gt; *). HasScope rep m =&gt; m (Scope rep)
</span><a href="Futhark.IR.Prop.Scope.html#askScope"><span class="hs-identifier hs-var">askScope</span></a></span><span>
</span><span id="line-390"></span><span>  </span><span id="local-6989586621684419029"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684419029"><span class="hs-identifier hs-var">stream_stms</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-391"></span><span>    </span><span class="annot"><span class="annottext">(BuilderT SOACS ExtractM ()
 -&gt; Scope SOACS -&gt; ExtractM (Stms SOACS))
-&gt; Scope SOACS
-&gt; BuilderT SOACS ExtractM ()
-&gt; ExtractM (Stms SOACS)
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">BuilderT SOACS ExtractM () -&gt; Scope SOACS -&gt; ExtractM (Stms SOACS)
forall (m :: * -&gt; *) rep.
MonadFreshNames m =&gt;
BuilderT rep m () -&gt; Scope rep -&gt; m (Stms rep)
</span><a href="Futhark.Builder.html#runBuilderT_"><span class="hs-identifier hs-var">runBuilderT_</span></a></span><span> </span><span class="annot"><span class="annottext">Scope SOACS
</span><a href="#local-6989586621684419030"><span class="hs-identifier hs-var">soacs_scope</span></a></span><span> </span><span class="annot"><span class="annottext">(BuilderT SOACS ExtractM () -&gt; ExtractM (Stms SOACS))
-&gt; BuilderT SOACS ExtractM () -&gt; ExtractM (Stms SOACS)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-392"></span><span>      </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS ExtractM))
-&gt; SubExp
-&gt; [SubExp]
-&gt; LambdaT (Rep (BuilderT SOACS ExtractM))
-&gt; [VName]
-&gt; BuilderT SOACS ExtractM ()
forall (m :: * -&gt; *).
(MonadBuilder m, Buildable (Rep m)) =&gt;
Pat (Rep m)
-&gt; SubExp -&gt; [SubExp] -&gt; LambdaT (Rep m) -&gt; [VName] -&gt; m ()
</span><a href="Futhark.Tools.html#sequentialStreamWholeArray"><span class="hs-identifier hs-var">sequentialStreamWholeArray</span></a></span><span> </span><span class="annot"><span class="annottext">Pat (Rep (BuilderT SOACS ExtractM))
Pat SOACS
</span><a href="#local-6989586621684419035"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">SubExp
</span><a href="#local-6989586621684419034"><span class="hs-identifier hs-var">w</span></a></span><span> </span><span class="annot"><span class="annottext">[SubExp]
</span><a href="#local-6989586621684419032"><span class="hs-identifier hs-var">nes</span></a></span><span> </span><span class="annot"><span class="annottext">LambdaT (Rep (BuilderT SOACS ExtractM))
Lambda SOACS
</span><a href="#local-6989586621684419031"><span class="hs-identifier hs-var">lam</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684419033"><span class="hs-identifier hs-var">arrs</span></a></span><span>
</span><span id="line-393"></span><span>  </span><span class="annot"><span class="annottext">Stms SOACS -&gt; ExtractM (Stms MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684419029"><span class="hs-identifier hs-var">stream_stms</span></a></span><span>
</span><span id="line-394"></span><span>
</span><span id="line-395"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#transformProg"><span class="hs-identifier hs-type">transformProg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Pass.html#PassM"><span class="hs-identifier hs-type">PassM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-396"></span><span id="transformProg"><span class="annot"><span class="annottext">transformProg :: Prog SOACS -&gt; PassM (Prog MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformProg"><span class="hs-identifier hs-var hs-var">transformProg</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-type">Prog</span></a></span><span> </span><span id="local-6989586621684419024"><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684419024"><span class="hs-identifier hs-var">consts</span></a></span></span><span> </span><span id="local-6989586621684419023"><span class="annot"><span class="annottext">[FunDef SOACS]
</span><a href="#local-6989586621684419023"><span class="hs-identifier hs-var">funs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-397"></span><span>  </span><span class="annot"><span class="annottext">(VNameSource -&gt; (Prog MC, VNameSource)) -&gt; PassM (Prog MC)
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
(VNameSource -&gt; (a, VNameSource)) -&gt; m a
</span><a href="Futhark.MonadFreshNames.html#modifyNameSource"><span class="hs-identifier hs-var">modifyNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">((VNameSource -&gt; (Prog MC, VNameSource)) -&gt; PassM (Prog MC))
-&gt; (VNameSource -&gt; (Prog MC, VNameSource)) -&gt; PassM (Prog MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">State VNameSource (Prog MC)
-&gt; VNameSource -&gt; (Prog MC, VNameSource)
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT (Scope MC) (State VNameSource) (Prog MC)
-&gt; Scope MC -&gt; State VNameSource (Prog MC)
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (Scope MC) (State VNameSource) (Prog MC)
</span><a href="#local-6989586621684419020"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">Scope MC
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-398"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-399"></span><span>    </span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#ExtractM"><span class="hs-identifier hs-type">ExtractM</span></a></span><span> </span><span id="local-6989586621684419020"><span class="annot"><span class="annottext">ReaderT (Scope MC) (State VNameSource) (Prog MC)
</span><a href="#local-6989586621684419020"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-400"></span><span>      </span><span id="local-6989586621684419019"><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419019"><span class="hs-identifier hs-var">consts'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stms SOACS -&gt; ExtractM (Stms MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformStms"><span class="hs-identifier hs-var">transformStms</span></a></span><span> </span><span class="annot"><span class="annottext">Stms SOACS
</span><a href="#local-6989586621684419024"><span class="hs-identifier hs-var">consts</span></a></span><span>
</span><span id="line-401"></span><span>      </span><span id="local-6989586621684419018"><span class="annot"><span class="annottext">[FunDef MC]
</span><a href="#local-6989586621684419018"><span class="hs-identifier hs-var">funs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Stms MC -&gt; ExtractM [FunDef MC] -&gt; ExtractM [FunDef MC]
forall rep a (m :: * -&gt; *) b.
(Scoped rep a, LocalScope rep m) =&gt;
a -&gt; m b -&gt; m b
</span><a href="Futhark.IR.Prop.Scope.html#inScopeOf"><span class="hs-identifier hs-var">inScopeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419019"><span class="hs-identifier hs-var">consts'</span></a></span><span> </span><span class="annot"><span class="annottext">(ExtractM [FunDef MC] -&gt; ExtractM [FunDef MC])
-&gt; ExtractM [FunDef MC] -&gt; ExtractM [FunDef MC]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(FunDef SOACS -&gt; ExtractM (FunDef MC))
-&gt; [FunDef SOACS] -&gt; ExtractM [FunDef MC]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">FunDef SOACS -&gt; ExtractM (FunDef MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformFunDef"><span class="hs-identifier hs-var">transformFunDef</span></a></span><span> </span><span class="annot"><span class="annottext">[FunDef SOACS]
</span><a href="#local-6989586621684419023"><span class="hs-identifier hs-var">funs</span></a></span><span>
</span><span id="line-402"></span><span>      </span><span class="annot"><span class="annottext">Prog MC -&gt; ExtractM (Prog MC)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Prog MC -&gt; ExtractM (Prog MC)) -&gt; Prog MC -&gt; ExtractM (Prog MC)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Stms MC -&gt; [FunDef MC] -&gt; Prog MC
forall rep. Stms rep -&gt; [FunDef rep] -&gt; Prog rep
</span><a href="Futhark.IR.Syntax.html#Prog"><span class="hs-identifier hs-var">Prog</span></a></span><span> </span><span class="annot"><span class="annottext">Stms MC
</span><a href="#local-6989586621684419019"><span class="hs-identifier hs-var">consts'</span></a></span><span> </span><span class="annot"><span class="annottext">[FunDef MC]
</span><a href="#local-6989586621684419018"><span class="hs-identifier hs-var">funs'</span></a></span><span>
</span><span id="line-403"></span><span>
</span><span id="line-404"></span><span class="hs-comment">-- | Transform a program using SOACs to a program in the 'MC'</span><span>
</span><span id="line-405"></span><span class="hs-comment">-- representation, using some amount of flattening.</span><span>
</span><span id="line-406"></span><span class="annot"><a href="Futhark.Pass.ExtractMulticore.html#extractMulticore"><span class="hs-identifier hs-type">extractMulticore</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.SOACS.html#SOACS"><span class="hs-identifier hs-type">SOACS</span></a></span><span> </span><span class="annot"><a href="Futhark.IR.MC.html#MC"><span class="hs-identifier hs-type">MC</span></a></span><span>
</span><span id="line-407"></span><span id="extractMulticore"><span class="annot"><span class="annottext">extractMulticore :: Pass SOACS MC
</span><a href="Futhark.Pass.ExtractMulticore.html#extractMulticore"><span class="hs-identifier hs-var hs-var">extractMulticore</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-408"></span><span>  </span><span class="annot"><span class="annottext">Pass :: forall fromrep torep.
String
-&gt; String
-&gt; (Prog fromrep -&gt; PassM (Prog torep))
-&gt; Pass fromrep torep
</span><a href="Futhark.Pass.html#Pass"><span class="hs-identifier hs-type">Pass</span></a></span><span>
</span><span id="line-409"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">passName :: String
</span><a href="Futhark.Pass.html#passName"><span class="hs-identifier hs-var">passName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;extract multicore parallelism&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-410"></span><span>      </span><span class="annot"><span class="annottext">passDescription :: String
</span><a href="Futhark.Pass.html#passDescription"><span class="hs-identifier hs-var">passDescription</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Extract multicore parallelism&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-411"></span><span>      </span><span class="annot"><span class="annottext">passFunction :: Prog SOACS -&gt; PassM (Prog MC)
</span><a href="Futhark.Pass.html#passFunction"><span class="hs-identifier hs-var">passFunction</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Prog SOACS -&gt; PassM (Prog MC)
</span><a href="Futhark.Pass.ExtractMulticore.html#transformProg"><span class="hs-identifier hs-var">transformProg</span></a></span><span>
</span><span id="line-412"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-413"></span></pre></body></html>