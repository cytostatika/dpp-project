<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-redundant-constraints #-}</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-comment">-- | This module contains a representation for the index function based on</span><span>
</span><span id="line-6"></span><span class="hs-comment">-- linear-memory accessor descriptors; see Zhu, Hoeflinger and David work.</span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.IR.Mem.IxFun</span><span>
</span><span id="line-8"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-9"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier">LMAD</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-10"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier">LMADDim</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-11"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Monotonicity"><span class="hs-identifier">Monotonicity</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-12"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#index"><span class="hs-identifier">index</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-13"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier">iota</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-14"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#iotaOffset"><span class="hs-identifier">iotaOffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-15"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#permute"><span class="hs-identifier">permute</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-16"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#rotate"><span class="hs-identifier">rotate</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-17"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#reshape"><span class="hs-identifier">reshape</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#slice"><span class="hs-identifier">slice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#flatSlice"><span class="hs-identifier">flatSlice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#rebase"><span class="hs-identifier">rebase</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#shape"><span class="hs-identifier">shape</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#rank"><span class="hs-identifier">rank</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#linearWithOffset"><span class="hs-identifier">linearWithOffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-24"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#rearrangeWithOffset"><span class="hs-identifier">rearrangeWithOffset</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-25"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#isDirect"><span class="hs-identifier">isDirect</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-26"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#isLinear"><span class="hs-identifier">isLinear</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-27"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#substituteInIxFun"><span class="hs-identifier">substituteInIxFun</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#leastGeneralGeneralization"><span class="hs-identifier">leastGeneralGeneralization</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#existentialize"><span class="hs-identifier">existentialize</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-30"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#closeEnough"><span class="hs-identifier">closeEnough</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-31"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#equivalent"><span class="hs-identifier">equivalent</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">where</span><span>
</span><span id="line-34"></span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Category</span></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Identity</span></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Writer</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Function</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">on</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(&amp;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">sort</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sortBy</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">zip4</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">zip5</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">zipWith5</span></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">isJust</span></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html"><span class="hs-identifier">Futhark.Analysis.PrimExp</span></a></span><span>
</span><span id="line-46"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#IntExp"><span class="hs-identifier">IntExp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-47"></span><span>    </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#PrimExp"><span class="hs-identifier">PrimExp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-48"></span><span>    </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier">TPrimExp</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-49"></span><span>    </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#primExpType"><span class="hs-identifier">primExpType</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.Convert.html"><span class="hs-identifier">Futhark.Analysis.PrimExp.Convert</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.Convert.html#substituteInPrimExp"><span class="hs-identifier">substituteInPrimExp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.Generalize.html"><span class="hs-identifier">Futhark.Analysis.PrimExp.Generalize</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">PEG</span></span><span>
</span><span id="line-53"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.html"><span class="hs-identifier">Futhark.IR.Prop</span></a></span><span>
</span><span id="line-54"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html"><span class="hs-identifier">Futhark.IR.Syntax</span></a></span><span>
</span><span id="line-55"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#DimChange"><span class="hs-identifier">DimChange</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-56"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimIndex"><span class="hs-identifier">DimIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-57"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#FlatDimIndex"><span class="hs-identifier">FlatDimIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-58"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#FlatSlice"><span class="hs-identifier">FlatSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-59"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.html#ShapeChange"><span class="hs-identifier">ShapeChange</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-60"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier">Slice</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-61"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#dimFix"><span class="hs-identifier">dimFix</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-62"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#flatSliceDims"><span class="hs-identifier">flatSliceDims</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-63"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#flatSliceStrides"><span class="hs-identifier">flatSliceStrides</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-64"></span><span>    </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#unitSlice"><span class="hs-identifier">unitSlice</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-65"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html"><span class="hs-identifier">Futhark.IR.Syntax.Core</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier">Ext</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html"><span class="hs-identifier">Futhark.Transform.Rename</span></a></span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Transform.Substitute.html"><span class="hs-identifier">Futhark.Transform.Substitute</span></a></span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html"><span class="hs-identifier">Futhark.Util.IntegralExp</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.Util.Pretty.html"><span class="hs-identifier">Futhark.Util.Pretty</span></a></span><span>
</span><span id="line-71"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">id</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">mod</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-operator">(.)</span></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>
</span><span id="line-73"></span><span class="hs-keyword">type</span><span> </span><span id="Shape"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Shape"><span class="hs-identifier hs-var">Shape</span></a></span></span><span> </span><span id="local-6989586621684361861"><span class="annot"><a href="#local-6989586621684361861"><span class="hs-identifier hs-type">num</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684361861"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span class="hs-keyword">type</span><span> </span><span id="Indices"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Indices"><span class="hs-identifier hs-var">Indices</span></a></span></span><span> </span><span id="local-6989586621684361860"><span class="annot"><a href="#local-6989586621684361860"><span class="hs-identifier hs-type">num</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684361860"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-76"></span><span>
</span><span id="line-77"></span><span class="hs-keyword">type</span><span> </span><span id="Permutation"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Permutation"><span class="hs-identifier hs-var">Permutation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span>
</span><span id="line-78"></span><span>
</span><span id="line-79"></span><span class="hs-keyword">data</span><span> </span><span id="Monotonicity"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Monotonicity"><span class="hs-identifier hs-var">Monotonicity</span></a></span></span><span>
</span><span id="line-80"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Inc"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span></span><span>
</span><span id="line-81"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="Dec"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Dec"><span class="hs-identifier hs-var">Dec</span></a></span></span><span>
</span><span id="line-82"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | monotonously increasing, decreasing or unknown</span><span>
</span><span id="line-83"></span><span>    </span><span id="Unknown"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span></span><span>
</span><span id="line-84"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361851"><span id="local-6989586621684361853"><span id="local-6989586621684361855"><span class="annot"><span class="annottext">Int -&gt; Monotonicity -&gt; ShowS
[Monotonicity] -&gt; ShowS
Monotonicity -&gt; String
(Int -&gt; Monotonicity -&gt; ShowS)
-&gt; (Monotonicity -&gt; String)
-&gt; ([Monotonicity] -&gt; ShowS)
-&gt; Show Monotonicity
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Monotonicity] -&gt; ShowS
$cshowList :: [Monotonicity] -&gt; ShowS
show :: Monotonicity -&gt; String
$cshow :: Monotonicity -&gt; String
showsPrec :: Int -&gt; Monotonicity -&gt; ShowS
$cshowsPrec :: Int -&gt; Monotonicity -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684361846"><span id="local-6989586621684361848"><span class="annot"><span class="annottext">Monotonicity -&gt; Monotonicity -&gt; Bool
(Monotonicity -&gt; Monotonicity -&gt; Bool)
-&gt; (Monotonicity -&gt; Monotonicity -&gt; Bool) -&gt; Eq Monotonicity
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: Monotonicity -&gt; Monotonicity -&gt; Bool
$c/= :: Monotonicity -&gt; Monotonicity -&gt; Bool
== :: Monotonicity -&gt; Monotonicity -&gt; Bool
$c== :: Monotonicity -&gt; Monotonicity -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="hs-keyword">data</span><span> </span><span id="LMADDim"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span></span><span> </span><span id="local-6989586621684362415"><span class="annot"><a href="#local-6989586621684362415"><span class="hs-identifier hs-type">num</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LMADDim"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span></span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="ldStride"><span class="annot"><span class="annottext">forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldStride"><span class="hs-identifier hs-var hs-var">ldStride</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621684362415"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-88"></span><span>    </span><span id="ldRotate"><span class="annot"><span class="annottext">forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldRotate"><span class="hs-identifier hs-var hs-var">ldRotate</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621684362415"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-89"></span><span>    </span><span id="ldShape"><span class="annot"><span class="annottext">forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldShape"><span class="hs-identifier hs-var hs-var">ldShape</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621684362415"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-90"></span><span>    </span><span id="ldPerm"><span class="annot"><span class="annottext">forall num. LMADDim num -&gt; Int
</span><a href="Futhark.IR.Mem.IxFun.html#ldPerm"><span class="hs-identifier hs-var hs-var">ldPerm</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span>
</span><span id="line-91"></span><span>    </span><span id="ldMon"><span class="annot"><span class="annottext">forall num. LMADDim num -&gt; Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#ldMon"><span class="hs-identifier hs-var hs-var">ldMon</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Monotonicity"><span class="hs-identifier hs-type">Monotonicity</span></a></span><span>
</span><span id="line-92"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-93"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361825"><span id="local-6989586621684361827"><span id="local-6989586621684361837"><span class="annot"><span class="annottext">Int -&gt; LMADDim num -&gt; ShowS
[LMADDim num] -&gt; ShowS
LMADDim num -&gt; String
(Int -&gt; LMADDim num -&gt; ShowS)
-&gt; (LMADDim num -&gt; String)
-&gt; ([LMADDim num] -&gt; ShowS)
-&gt; Show (LMADDim num)
forall num. Show num =&gt; Int -&gt; LMADDim num -&gt; ShowS
forall num. Show num =&gt; [LMADDim num] -&gt; ShowS
forall num. Show num =&gt; LMADDim num -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [LMADDim num] -&gt; ShowS
$cshowList :: forall num. Show num =&gt; [LMADDim num] -&gt; ShowS
show :: LMADDim num -&gt; String
$cshow :: forall num. Show num =&gt; LMADDim num -&gt; String
showsPrec :: Int -&gt; LMADDim num -&gt; ShowS
$cshowsPrec :: forall num. Show num =&gt; Int -&gt; LMADDim num -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684361816"><span id="local-6989586621684361823"><span class="annot"><span class="annottext">LMADDim num -&gt; LMADDim num -&gt; Bool
(LMADDim num -&gt; LMADDim num -&gt; Bool)
-&gt; (LMADDim num -&gt; LMADDim num -&gt; Bool) -&gt; Eq (LMADDim num)
forall num. Eq num =&gt; LMADDim num -&gt; LMADDim num -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: LMADDim num -&gt; LMADDim num -&gt; Bool
$c/= :: forall num. Eq num =&gt; LMADDim num -&gt; LMADDim num -&gt; Bool
== :: LMADDim num -&gt; LMADDim num -&gt; Bool
$c== :: forall num. Eq num =&gt; LMADDim num -&gt; LMADDim num -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="hs-comment">-- | LMAD's representation consists of a general offset and for each dimension a</span><span>
</span><span id="line-96"></span><span class="hs-comment">-- stride, rotate factor, number of elements (or shape), permutation, and</span><span>
</span><span id="line-97"></span><span class="hs-comment">-- monotonicity. Note that the permutation is not strictly necessary in that the</span><span>
</span><span id="line-98"></span><span class="hs-comment">-- permutation can be performed directly on LMAD dimensions, but then it is</span><span>
</span><span id="line-99"></span><span class="hs-comment">-- difficult to extract the permutation back from an LMAD.</span><span>
</span><span id="line-100"></span><span class="hs-comment">--</span><span>
</span><span id="line-101"></span><span class="hs-comment">-- LMAD algebra is closed under composition w.r.t. operators such as</span><span>
</span><span id="line-102"></span><span class="hs-comment">-- permute, index and slice.  However, other operations, such as</span><span>
</span><span id="line-103"></span><span class="hs-comment">-- reshape, cannot always be represented inside the LMAD algebra.</span><span>
</span><span id="line-104"></span><span class="hs-comment">--</span><span>
</span><span id="line-105"></span><span class="hs-comment">-- It follows that the general representation of an index function is a list of</span><span>
</span><span id="line-106"></span><span class="hs-comment">-- LMADS, in which each following LMAD in the list implicitly corresponds to an</span><span>
</span><span id="line-107"></span><span class="hs-comment">-- irregular reshaping operation.</span><span>
</span><span id="line-108"></span><span class="hs-comment">--</span><span>
</span><span id="line-109"></span><span class="hs-comment">-- However, we expect that the common case is when the index function is one</span><span>
</span><span id="line-110"></span><span class="hs-comment">-- LMAD -- we call this the &quot;nice&quot; representation.</span><span>
</span><span id="line-111"></span><span class="hs-comment">--</span><span>
</span><span id="line-112"></span><span class="hs-comment">-- Finally, the list of LMADs is kept in an @IxFun@ together with the shape of</span><span>
</span><span id="line-113"></span><span class="hs-comment">-- the original array, and a bit to indicate whether the index function is</span><span>
</span><span id="line-114"></span><span class="hs-comment">-- contiguous, i.e., if we instantiate all the points of the current index</span><span>
</span><span id="line-115"></span><span class="hs-comment">-- function, do we get a contiguous memory interval?</span><span>
</span><span id="line-116"></span><span class="hs-comment">--</span><span>
</span><span id="line-117"></span><span class="hs-comment">-- By definition, the LMAD denotes the set of points (simplified):</span><span>
</span><span id="line-118"></span><span class="hs-comment">--</span><span>
</span><span id="line-119"></span><span class="hs-comment">--   \{ o + \Sigma_{j=0}^{k} ((i_j+r_j) `mod` n_j)*s_j,</span><span>
</span><span id="line-120"></span><span class="hs-comment">--      \forall i_j such that 0&lt;=i_j&lt;n_j, j=1..k \}</span><span>
</span><span id="line-121"></span><span class="hs-keyword">data</span><span> </span><span id="LMAD"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span></span><span> </span><span id="local-6989586621684362409"><span class="annot"><a href="#local-6989586621684362409"><span class="hs-identifier hs-type">num</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="LMAD"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span></span><span>
</span><span id="line-122"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="lmadOffset"><span class="annot"><span class="annottext">forall num. LMAD num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadOffset"><span class="hs-identifier hs-var hs-var">lmadOffset</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="#local-6989586621684362409"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-123"></span><span>    </span><span id="lmadDims"><span class="annot"><span class="annottext">forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362409"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-124"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-125"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361802"><span id="local-6989586621684361804"><span id="local-6989586621684361811"><span class="annot"><span class="annottext">Int -&gt; LMAD num -&gt; ShowS
[LMAD num] -&gt; ShowS
LMAD num -&gt; String
(Int -&gt; LMAD num -&gt; ShowS)
-&gt; (LMAD num -&gt; String) -&gt; ([LMAD num] -&gt; ShowS) -&gt; Show (LMAD num)
forall num. Show num =&gt; Int -&gt; LMAD num -&gt; ShowS
forall num. Show num =&gt; [LMAD num] -&gt; ShowS
forall num. Show num =&gt; LMAD num -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [LMAD num] -&gt; ShowS
$cshowList :: forall num. Show num =&gt; [LMAD num] -&gt; ShowS
show :: LMAD num -&gt; String
$cshow :: forall num. Show num =&gt; LMAD num -&gt; String
showsPrec :: Int -&gt; LMAD num -&gt; ShowS
$cshowsPrec :: forall num. Show num =&gt; Int -&gt; LMAD num -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684361794"><span id="local-6989586621684361800"><span class="annot"><span class="annottext">LMAD num -&gt; LMAD num -&gt; Bool
(LMAD num -&gt; LMAD num -&gt; Bool)
-&gt; (LMAD num -&gt; LMAD num -&gt; Bool) -&gt; Eq (LMAD num)
forall num. Eq num =&gt; LMAD num -&gt; LMAD num -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: LMAD num -&gt; LMAD num -&gt; Bool
$c/= :: forall num. Eq num =&gt; LMAD num -&gt; LMAD num -&gt; Bool
== :: LMAD num -&gt; LMAD num -&gt; Bool
$c== :: forall num. Eq num =&gt; LMAD num -&gt; LMAD num -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-126"></span><span>
</span><span id="line-127"></span><span class="hs-comment">-- | An index function is a mapping from a multidimensional array</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- index space (the domain) to a one-dimensional memory index space.</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- Essentially, it explains where the element at position @[i,j,p]@ of</span><span>
</span><span id="line-130"></span><span class="hs-comment">-- some array is stored inside the flat one-dimensional array that</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- constitutes its memory.  For example, we can use this to</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- distinguish row-major and column-major representations.</span><span>
</span><span id="line-133"></span><span class="hs-comment">--</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- An index function is represented as a sequence of 'LMAD's.</span><span>
</span><span id="line-135"></span><span class="hs-keyword">data</span><span> </span><span id="IxFun"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span></span><span> </span><span id="local-6989586621684362404"><span class="annot"><a href="#local-6989586621684362404"><span class="hs-identifier hs-type">num</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="IxFun"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span></span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="ixfunLMADs"><span class="annot"><span class="annottext">forall num. IxFun num -&gt; NonEmpty (LMAD num)
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunLMADs"><span class="hs-identifier hs-var hs-var">ixfunLMADs</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362404"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-137"></span><span>    </span><span id="base"><span class="annot"><span class="annottext">forall num. IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#base"><span class="hs-identifier hs-var hs-var">base</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362404"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-138"></span><span>    </span><span class="hs-comment">-- | ignoring permutations, is the index function contiguous?</span><span>
</span><span id="line-139"></span><span>    </span><span id="ixfunContig"><span class="annot"><span class="annottext">forall num. IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunContig"><span class="hs-identifier hs-var hs-var">ixfunContig</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-140"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-141"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361777"><span id="local-6989586621684361779"><span id="local-6989586621684361788"><span class="annot"><span class="annottext">Int -&gt; IxFun num -&gt; ShowS
[IxFun num] -&gt; ShowS
IxFun num -&gt; String
(Int -&gt; IxFun num -&gt; ShowS)
-&gt; (IxFun num -&gt; String)
-&gt; ([IxFun num] -&gt; ShowS)
-&gt; Show (IxFun num)
forall num. Show num =&gt; Int -&gt; IxFun num -&gt; ShowS
forall num. Show num =&gt; [IxFun num] -&gt; ShowS
forall num. Show num =&gt; IxFun num -&gt; String
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [IxFun num] -&gt; ShowS
$cshowList :: forall num. Show num =&gt; [IxFun num] -&gt; ShowS
show :: IxFun num -&gt; String
$cshow :: forall num. Show num =&gt; IxFun num -&gt; String
showsPrec :: Int -&gt; IxFun num -&gt; ShowS
$cshowsPrec :: forall num. Show num =&gt; Int -&gt; IxFun num -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684361767"><span id="local-6989586621684361775"><span class="annot"><span class="annottext">IxFun num -&gt; IxFun num -&gt; Bool
(IxFun num -&gt; IxFun num -&gt; Bool)
-&gt; (IxFun num -&gt; IxFun num -&gt; Bool) -&gt; Eq (IxFun num)
forall num. Eq num =&gt; IxFun num -&gt; IxFun num -&gt; Bool
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: IxFun num -&gt; IxFun num -&gt; Bool
$c/= :: forall num. Eq num =&gt; IxFun num -&gt; IxFun num -&gt; Bool
== :: IxFun num -&gt; IxFun num -&gt; Bool
$c== :: forall num. Eq num =&gt; IxFun num -&gt; IxFun num -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684361762"><span id="local-6989586621684361764"><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Monotonicity"><span class="hs-identifier hs-type">Monotonicity</span></a></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-144"></span><span>  </span><span id="local-6989586621684361757"><span class="annot"><span class="annottext">ppr :: Monotonicity -&gt; Doc
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Doc
</span><span class="hs-identifier hs-var">text</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Doc) -&gt; (Monotonicity -&gt; String) -&gt; Monotonicity -&gt; Doc
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span>
</span><span id="line-145"></span><span>
</span><span id="line-146"></span><span id="local-6989586621684362388"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684361748"><span id="local-6989586621684361750"><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="#local-6989586621684362388"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362388"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-147"></span><span>  </span><span id="local-6989586621684361726"><span class="annot"><span class="annottext">ppr :: LMAD num -&gt; Doc
</span><a href="#local-6989586621684361726"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684361725"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361725"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span id="local-6989586621684361724"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361724"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-148"></span><span>    </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">braces</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; Doc) -&gt; Doc -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-149"></span><span>      </span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">semisep</span></span><span>
</span><span id="line-150"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;offset: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Futhark.Util.Pretty.html#oneLine"><span class="hs-identifier hs-var">oneLine</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361725"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-151"></span><span>          </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;strides: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; num) -&gt; Doc
forall {b}. Pretty b =&gt; (LMADDim num -&gt; b) -&gt; Doc
</span><a href="#local-6989586621684361720"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; num
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldStride"><span class="hs-identifier hs-var hs-var">ldStride</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-152"></span><span>          </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;rotates: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; num) -&gt; Doc
forall {b}. Pretty b =&gt; (LMADDim num -&gt; b) -&gt; Doc
</span><a href="#local-6989586621684361720"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; num
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldRotate"><span class="hs-identifier hs-var hs-var">ldRotate</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-153"></span><span>          </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;shape: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; num) -&gt; Doc
forall {b}. Pretty b =&gt; (LMADDim num -&gt; b) -&gt; Doc
</span><a href="#local-6989586621684361720"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; num
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldShape"><span class="hs-identifier hs-var hs-var">ldShape</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-154"></span><span>          </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;permutation: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; Int) -&gt; Doc
forall {b}. Pretty b =&gt; (LMADDim num -&gt; b) -&gt; Doc
</span><a href="#local-6989586621684361720"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; Int
forall num. LMADDim num -&gt; Int
</span><a href="Futhark.IR.Mem.IxFun.html#ldPerm"><span class="hs-identifier hs-var hs-var">ldPerm</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-155"></span><span>          </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;monotonicity: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; Monotonicity) -&gt; Doc
forall {b}. Pretty b =&gt; (LMADDim num -&gt; b) -&gt; Doc
</span><a href="#local-6989586621684361720"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; Monotonicity
forall num. LMADDim num -&gt; Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#ldMon"><span class="hs-identifier hs-var hs-var">ldMon</span></a></span><span>
</span><span id="line-156"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-157"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-158"></span><span>      </span><span id="local-6989586621684361720"><span class="annot"><span class="annottext">p :: (LMADDim num -&gt; b) -&gt; Doc
</span><a href="#local-6989586621684361720"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684361716"><span class="annot"><span class="annottext">LMADDim num -&gt; b
</span><a href="#local-6989586621684361716"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><a href="Futhark.Util.Pretty.html#oneLine"><span class="hs-identifier hs-var">oneLine</span></a></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; Doc) -&gt; Doc -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">brackets</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; Doc) -&gt; Doc -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; Doc) -&gt; [LMADDim num] -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">(b -&gt; Doc) -&gt; (LMADDim num -&gt; b) -&gt; LMADDim num -&gt; Doc
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; b
</span><a href="#local-6989586621684361716"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361724"><span class="hs-identifier hs-var">dims</span></a></span></span><span>
</span><span id="line-159"></span><span>
</span><span id="line-160"></span><span id="local-6989586621684362380"><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684361709"><span id="local-6989586621684361711"><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="#local-6989586621684362380"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362380"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-161"></span><span>  </span><span id="local-6989586621684361698"><span class="annot"><span class="annottext">ppr :: IxFun num -&gt; Doc
</span><a href="#local-6989586621684361698"><span class="hs-identifier hs-var hs-var hs-var hs-var">ppr</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span id="local-6989586621684361697"><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684361697"><span class="hs-identifier hs-var">lmads</span></a></span></span><span> </span><span id="local-6989586621684361696"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361696"><span class="hs-identifier hs-var">oshp</span></a></span></span><span> </span><span id="local-6989586621684361695"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361695"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-162"></span><span>    </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">braces</span></span><span> </span><span class="annot"><span class="annottext">(Doc -&gt; Doc) -&gt; Doc -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-163"></span><span>      </span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">semisep</span></span><span>
</span><span id="line-164"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;base: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">brackets</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><span class="hs-identifier hs-var">commasep</span></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(num -&gt; Doc) -&gt; Shape num -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361696"><span class="hs-identifier hs-var">oshp</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-165"></span><span>          </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;contiguous: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361695"><span class="hs-identifier hs-var">cg</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;true&quot;</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;false&quot;</span></span><span class="hs-special">,</span><span>
</span><span id="line-166"></span><span>          </span><span class="annot"><span class="annottext">Doc
</span><span class="hs-string">&quot;LMADs: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc -&gt; Doc
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Doc -&gt; Doc
</span><span class="hs-identifier hs-var">brackets</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Doc] -&gt; Doc
</span><a href="Futhark.Util.Pretty.html#commastack"><span class="hs-identifier hs-var">commastack</span></a></span><span> </span><span class="annot"><span class="annottext">([Doc] -&gt; Doc) -&gt; [Doc] -&gt; Doc
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty Doc -&gt; [Doc]
forall a. NonEmpty a -&gt; [a]
</span><span class="hs-identifier hs-var">NE.toList</span></span><span> </span><span class="annot"><span class="annottext">(NonEmpty Doc -&gt; [Doc]) -&gt; NonEmpty Doc -&gt; [Doc]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(LMAD num -&gt; Doc) -&gt; NonEmpty (LMAD num) -&gt; NonEmpty Doc
forall a b. (a -&gt; b) -&gt; NonEmpty a -&gt; NonEmpty b
</span><span class="hs-identifier hs-var">NE.map</span></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Doc
forall a. Pretty a =&gt; a -&gt; Doc
</span><span class="hs-identifier hs-var">ppr</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684361697"><span class="hs-identifier hs-var">lmads</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-167"></span><span>        </span><span class="hs-special">]</span></span><span>
</span><span id="line-168"></span><span>
</span><span id="line-169"></span><span id="local-6989586621684362371"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Transform.Substitute.html#Substitute"><span class="hs-identifier hs-type">Substitute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362371"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Transform.Substitute.html#Substitute"><span class="hs-identifier hs-type">Substitute</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362371"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-170"></span><span>  </span><span id="local-6989586621684361685"><span class="annot"><span class="annottext">substituteNames :: Map VName VName -&gt; LMAD num -&gt; LMAD num
</span><a href="Futhark.Transform.Substitute.html#substituteNames"><span class="hs-identifier hs-var hs-var hs-var hs-var">substituteNames</span></a></span></span><span> </span><span id="local-6989586621684361683"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684361683"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(num -&gt; num) -&gt; LMAD num -&gt; LMAD num
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">((num -&gt; num) -&gt; LMAD num -&gt; LMAD num)
-&gt; (num -&gt; num) -&gt; LMAD num -&gt; LMAD num
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; num -&gt; num
forall a. Substitute a =&gt; Map VName VName -&gt; a -&gt; a
</span><a href="Futhark.Transform.Substitute.html#substituteNames"><span class="hs-identifier hs-var">substituteNames</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684361683"><span class="hs-identifier hs-var">substs</span></a></span></span><span>
</span><span id="line-171"></span><span>
</span><span id="line-172"></span><span id="local-6989586621684362366"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Transform.Substitute.html#Substitute"><span class="hs-identifier hs-type">Substitute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362366"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Transform.Substitute.html#Substitute"><span class="hs-identifier hs-type">Substitute</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362366"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-173"></span><span>  </span><span id="local-6989586621684361677"><span class="annot"><span class="annottext">substituteNames :: Map VName VName -&gt; IxFun num -&gt; IxFun num
</span><a href="#local-6989586621684361677"><span class="hs-identifier hs-var hs-var hs-var hs-var">substituteNames</span></a></span></span><span> </span><span id="local-6989586621684361676"><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684361676"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(num -&gt; num) -&gt; IxFun num -&gt; IxFun num
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">((num -&gt; num) -&gt; IxFun num -&gt; IxFun num)
-&gt; (num -&gt; num) -&gt; IxFun num -&gt; IxFun num
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName VName -&gt; num -&gt; num
forall a. Substitute a =&gt; Map VName VName -&gt; a -&gt; a
</span><a href="Futhark.Transform.Substitute.html#substituteNames"><span class="hs-identifier hs-var">substituteNames</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684361676"><span class="hs-identifier hs-var">substs</span></a></span></span><span>
</span><span id="line-174"></span><span>
</span><span id="line-175"></span><span id="local-6989586621684362361"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Transform.Substitute.html#Substitute"><span class="hs-identifier hs-type">Substitute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362361"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html#Rename"><span class="hs-identifier hs-type">Rename</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362361"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-176"></span><span>  </span><span id="local-6989586621684361670"><span class="annot"><span class="annottext">rename :: LMAD num -&gt; RenameM (LMAD num)
</span><a href="Futhark.Transform.Rename.html#rename"><span class="hs-identifier hs-var hs-var hs-var hs-var">rename</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; RenameM (LMAD num)
forall a. Substitute a =&gt; a -&gt; RenameM a
</span><a href="Futhark.Transform.Rename.html#substituteRename"><span class="hs-identifier hs-var">substituteRename</span></a></span></span><span>
</span><span id="line-177"></span><span>
</span><span id="line-178"></span><span id="local-6989586621684362358"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.Transform.Substitute.html#Substitute"><span class="hs-identifier hs-type">Substitute</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362358"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.Transform.Rename.html#Rename"><span class="hs-identifier hs-type">Rename</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362358"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-179"></span><span>  </span><span id="local-6989586621684361663"><span class="annot"><span class="annottext">rename :: IxFun num -&gt; RenameM (IxFun num)
</span><a href="#local-6989586621684361663"><span class="hs-identifier hs-var hs-var hs-var hs-var">rename</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; RenameM (IxFun num)
forall a. Substitute a =&gt; a -&gt; RenameM a
</span><a href="Futhark.Transform.Rename.html#substituteRename"><span class="hs-identifier hs-var">substituteRename</span></a></span></span><span>
</span><span id="line-180"></span><span>
</span><span id="line-181"></span><span id="local-6989586621684362353"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#FreeIn"><span class="hs-identifier hs-type">FreeIn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362353"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#FreeIn"><span class="hs-identifier hs-type">FreeIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362353"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-182"></span><span>  </span><span id="local-6989586621684361654"><span class="annot"><span class="annottext">freeIn' :: LMAD num -&gt; FV
</span><a href="Futhark.IR.Prop.Names.html#freeIn%27"><span class="hs-identifier hs-var hs-var hs-var hs-var">freeIn'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(num -&gt; FV) -&gt; LMAD num -&gt; FV
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; FV
forall a. FreeIn a =&gt; a -&gt; FV
</span><a href="Futhark.IR.Prop.Names.html#freeIn%27"><span class="hs-identifier hs-var">freeIn'</span></a></span></span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span id="local-6989586621684362348"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#FreeIn"><span class="hs-identifier hs-type">FreeIn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362348"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Prop.Names.html#FreeIn"><span class="hs-identifier hs-type">FreeIn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362348"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-185"></span><span>  </span><span id="local-6989586621684361645"><span class="annot"><span class="annottext">freeIn' :: IxFun num -&gt; FV
</span><a href="#local-6989586621684361645"><span class="hs-identifier hs-var hs-var hs-var hs-var">freeIn'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(num -&gt; FV) -&gt; IxFun num -&gt; FV
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; FV
forall a. FreeIn a =&gt; a -&gt; FV
</span><a href="Futhark.IR.Prop.Names.html#freeIn%27"><span class="hs-identifier hs-var">freeIn'</span></a></span></span><span>
</span><span id="line-186"></span><span>
</span><span id="line-187"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684361642"><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-188"></span><span>  </span><span id="local-6989586621684361633"><span class="annot"><span class="annottext">fmap :: forall a b. (a -&gt; b) -&gt; LMAD a -&gt; LMAD b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">fmap</span></span></span><span> </span><span id="local-6989586621684361632"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621684361632"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity (LMAD b) -&gt; LMAD b
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity (LMAD b) -&gt; LMAD b)
-&gt; (LMAD a -&gt; Identity (LMAD b)) -&gt; LMAD a -&gt; LMAD b
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Identity b) -&gt; LMAD a -&gt; Identity (LMAD b)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Identity b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(b -&gt; Identity b) -&gt; (a -&gt; b) -&gt; a -&gt; Identity b
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621684361632"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-189"></span><span>
</span><span id="line-190"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684361627"><span class="annot"><span class="hs-identifier hs-type">Functor</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-191"></span><span>  </span><span id="local-6989586621684361621"><span class="annot"><span class="annottext">fmap :: forall a b. (a -&gt; b) -&gt; IxFun a -&gt; IxFun b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var">fmap</span></span></span><span> </span><span id="local-6989586621684361620"><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621684361620"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity (IxFun b) -&gt; IxFun b
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity (IxFun b) -&gt; IxFun b)
-&gt; (IxFun a -&gt; Identity (IxFun b)) -&gt; IxFun a -&gt; IxFun b
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; Identity b) -&gt; IxFun a -&gt; Identity (IxFun b)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">b -&gt; Identity b
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(b -&gt; Identity b) -&gt; (a -&gt; b) -&gt; a -&gt; Identity b
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; b
</span><a href="#local-6989586621684361620"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>
</span><span id="line-193"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684361587"><span id="local-6989586621684361589"><span id="local-6989586621684361591"><span id="local-6989586621684361593"><span id="local-6989586621684361595"><span id="local-6989586621684361597"><span id="local-6989586621684361599"><span id="local-6989586621684361601"><span id="local-6989586621684361603"><span id="local-6989586621684361605"><span id="local-6989586621684361607"><span id="local-6989586621684361609"><span id="local-6989586621684361611"><span id="local-6989586621684361613"><span id="local-6989586621684361615"><span id="local-6989586621684361618"><span class="annot"><span class="hs-identifier hs-type">Foldable</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-194"></span><span>  </span><span id="local-6989586621684361575"><span class="annot"><span class="annottext">foldMap :: forall m a. Monoid m =&gt; (a -&gt; m) -&gt; LMAD a -&gt; m
</span><a href="#local-6989586621684361575"><span class="hs-identifier hs-var hs-var hs-var hs-var">foldMap</span></a></span></span><span> </span><span id="local-6989586621684361574"><span class="annot"><span class="annottext">a -&gt; m
</span><a href="#local-6989586621684361574"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Writer m (LMAD ()) -&gt; m
forall w a. Writer w a -&gt; w
</span><span class="hs-identifier hs-var">execWriter</span></span><span> </span><span class="annot"><span class="annottext">(Writer m (LMAD ()) -&gt; m)
-&gt; (LMAD a -&gt; Writer m (LMAD ())) -&gt; LMAD a -&gt; m
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; WriterT m Identity ()) -&gt; LMAD a -&gt; Writer m (LMAD ())
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m -&gt; WriterT m Identity ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">(m -&gt; WriterT m Identity ())
-&gt; (a -&gt; m) -&gt; a -&gt; WriterT m Identity ()
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m
</span><a href="#local-6989586621684361574"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-195"></span><span>
</span><span id="line-196"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684361539"><span id="local-6989586621684361541"><span id="local-6989586621684361543"><span id="local-6989586621684361545"><span id="local-6989586621684361547"><span id="local-6989586621684361549"><span id="local-6989586621684361551"><span id="local-6989586621684361553"><span id="local-6989586621684361555"><span id="local-6989586621684361557"><span id="local-6989586621684361559"><span id="local-6989586621684361561"><span id="local-6989586621684361563"><span id="local-6989586621684361565"><span id="local-6989586621684361567"><span id="local-6989586621684361570"><span class="annot"><span class="hs-identifier hs-type">Foldable</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-197"></span><span>  </span><span id="local-6989586621684361530"><span class="annot"><span class="annottext">foldMap :: forall m a. Monoid m =&gt; (a -&gt; m) -&gt; IxFun a -&gt; m
</span><a href="#local-6989586621684361530"><span class="hs-identifier hs-var hs-var hs-var hs-var">foldMap</span></a></span></span><span> </span><span id="local-6989586621684361529"><span class="annot"><span class="annottext">a -&gt; m
</span><a href="#local-6989586621684361529"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Writer m (IxFun ()) -&gt; m
forall w a. Writer w a -&gt; w
</span><span class="hs-identifier hs-var">execWriter</span></span><span> </span><span class="annot"><span class="annottext">(Writer m (IxFun ()) -&gt; m)
-&gt; (IxFun a -&gt; Writer m (IxFun ())) -&gt; IxFun a -&gt; m
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; WriterT m Identity ()) -&gt; IxFun a -&gt; Writer m (IxFun ())
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">m -&gt; WriterT m Identity ()
forall w (m :: * -&gt; *). MonadWriter w m =&gt; w -&gt; m ()
</span><span class="hs-identifier hs-var">tell</span></span><span> </span><span class="annot"><span class="annottext">(m -&gt; WriterT m Identity ())
-&gt; (a -&gt; m) -&gt; a -&gt; WriterT m Identity ()
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; m
</span><a href="#local-6989586621684361529"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>
</span><span id="line-199"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684361518"><span id="local-6989586621684361520"><span id="local-6989586621684361522"><span class="annot"><span class="hs-identifier hs-type">Traversable</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-200"></span><span>  </span><span id="local-6989586621684361508"><span class="annot"><span class="annottext">traverse :: forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; LMAD a -&gt; f (LMAD b)
</span><a href="#local-6989586621684361508"><span class="hs-identifier hs-var hs-var hs-var hs-var">traverse</span></a></span></span><span> </span><span id="local-6989586621684361507"><span class="annot"><span class="annottext">a -&gt; f b
</span><a href="#local-6989586621684361507"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684361506"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361506"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span id="local-6989586621684361505"><span class="annot"><span class="annottext">[LMADDim a]
</span><a href="#local-6989586621684361505"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-201"></span><span>    </span><span class="annot"><span class="annottext">b -&gt; [LMADDim b] -&gt; LMAD b
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">(b -&gt; [LMADDim b] -&gt; LMAD b) -&gt; f b -&gt; f ([LMADDim b] -&gt; LMAD b)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; f b
</span><a href="#local-6989586621684361507"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361506"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">f ([LMADDim b] -&gt; LMAD b) -&gt; f [LMADDim b] -&gt; f (LMAD b)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim a -&gt; f (LMADDim b)) -&gt; [LMADDim a] -&gt; f [LMADDim b]
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">LMADDim a -&gt; f (LMADDim b)
</span><a href="#local-6989586621684361503"><span class="hs-identifier hs-var">f'</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim a]
</span><a href="#local-6989586621684361505"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-202"></span><span>    </span><span class="hs-keyword">where</span><span>
</span><span id="line-203"></span><span>      </span><span id="local-6989586621684361503"><span class="annot"><span class="annottext">f' :: LMADDim a -&gt; f (LMADDim b)
</span><a href="#local-6989586621684361503"><span class="hs-identifier hs-var hs-var">f'</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span id="local-6989586621684361495"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361495"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684361494"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361494"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684361493"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361493"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684361492"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361492"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684361491"><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684361491"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-204"></span><span>        </span><span class="annot"><span class="annottext">b -&gt; b -&gt; b -&gt; Int -&gt; Monotonicity -&gt; LMADDim b
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">(b -&gt; b -&gt; b -&gt; Int -&gt; Monotonicity -&gt; LMADDim b)
-&gt; f b -&gt; f (b -&gt; b -&gt; Int -&gt; Monotonicity -&gt; LMADDim b)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; f b
</span><a href="#local-6989586621684361507"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361495"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">f (b -&gt; b -&gt; Int -&gt; Monotonicity -&gt; LMADDim b)
-&gt; f b -&gt; f (b -&gt; Int -&gt; Monotonicity -&gt; LMADDim b)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; f b
</span><a href="#local-6989586621684361507"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361494"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">f (b -&gt; Int -&gt; Monotonicity -&gt; LMADDim b)
-&gt; f b -&gt; f (Int -&gt; Monotonicity -&gt; LMADDim b)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; f b
</span><a href="#local-6989586621684361507"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361493"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">f (Int -&gt; Monotonicity -&gt; LMADDim b)
-&gt; f Int -&gt; f (Monotonicity -&gt; LMADDim b)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; f Int
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361492"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">f (Monotonicity -&gt; LMADDim b) -&gt; f Monotonicity -&gt; f (LMADDim b)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity -&gt; f Monotonicity
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684361491"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621684361480"><span id="local-6989586621684361482"><span id="local-6989586621684361484"><span class="annot"><span class="hs-identifier hs-type">Traversable</span></span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span></span></span></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-207"></span><span>  </span><span id="local-6989586621684361466"><span class="annot"><span class="annottext">traverse :: forall (f :: * -&gt; *) a b.
Applicative f =&gt;
(a -&gt; f b) -&gt; IxFun a -&gt; f (IxFun b)
</span><a href="#local-6989586621684361466"><span class="hs-identifier hs-var hs-var hs-var hs-var">traverse</span></a></span></span><span> </span><span id="local-6989586621684361465"><span class="annot"><span class="annottext">a -&gt; f b
</span><a href="#local-6989586621684361465"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span id="local-6989586621684361464"><span class="annot"><span class="annottext">NonEmpty (LMAD a)
</span><a href="#local-6989586621684361464"><span class="hs-identifier hs-var">lmads</span></a></span></span><span> </span><span id="local-6989586621684361463"><span class="annot"><span class="annottext">Shape a
</span><a href="#local-6989586621684361463"><span class="hs-identifier hs-var">oshp</span></a></span></span><span> </span><span id="local-6989586621684361462"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361462"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-208"></span><span>    </span><span class="annot"><span class="annottext">NonEmpty (LMAD b) -&gt; Shape b -&gt; Bool -&gt; IxFun b
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmpty (LMAD b) -&gt; Shape b -&gt; Bool -&gt; IxFun b)
-&gt; f (NonEmpty (LMAD b)) -&gt; f (Shape b -&gt; Bool -&gt; IxFun b)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(LMAD a -&gt; f (LMAD b))
-&gt; NonEmpty (LMAD a) -&gt; f (NonEmpty (LMAD b))
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(a -&gt; f b) -&gt; LMAD a -&gt; f (LMAD b)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; f b
</span><a href="#local-6989586621684361465"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD a)
</span><a href="#local-6989586621684361464"><span class="hs-identifier hs-var">lmads</span></a></span><span> </span><span class="annot"><span class="annottext">f (Shape b -&gt; Bool -&gt; IxFun b)
-&gt; f (Shape b) -&gt; f (Bool -&gt; IxFun b)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; f b) -&gt; Shape a -&gt; f (Shape b)
forall (t :: * -&gt; *) (f :: * -&gt; *) a b.
(Traversable t, Applicative f) =&gt;
(a -&gt; f b) -&gt; t a -&gt; f (t b)
</span><span class="hs-identifier hs-var">traverse</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; f b
</span><a href="#local-6989586621684361465"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">Shape a
</span><a href="#local-6989586621684361463"><span class="hs-identifier hs-var">oshp</span></a></span><span> </span><span class="annot"><span class="annottext">f (Bool -&gt; IxFun b) -&gt; f Bool -&gt; f (IxFun b)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; f Bool
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361462"><span class="hs-identifier hs-var">cg</span></a></span><span>
</span><span id="line-209"></span><span>
</span><span id="line-210"></span><span id="local-6989586621684362286"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#%2B%2B%40"><span class="hs-operator hs-type">(++@)</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684362286"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><a href="#local-6989586621684362286"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><a href="#local-6989586621684362286"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-211"></span><span id="local-6989586621684361460"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684361460"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="%2B%2B%40"><span class="annot"><span class="annottext">++@ :: forall a. [a] -&gt; NonEmpty a -&gt; NonEmpty a
</span><a href="Futhark.IR.Mem.IxFun.html#%2B%2B%40"><span class="hs-operator hs-var hs-var">++@</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361459"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361459"><span class="hs-identifier hs-var">ne</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684361457"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684361457"><span class="hs-identifier hs-var">nes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684361460"><span class="hs-identifier hs-var">es</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-212"></span><span>  </span><span id="local-6989586621684361456"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361456"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684361455"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684361455"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361456"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; NonEmpty a
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684361455"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361459"><span class="hs-identifier hs-var">ne</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684361457"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-213"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361459"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; NonEmpty a
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684361457"><span class="hs-identifier hs-var">nes</span></a></span><span>
</span><span id="line-214"></span><span>
</span><span id="line-215"></span><span id="local-6989586621684362282"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#%40%2B%2B%40"><span class="hs-operator hs-type">(@++@)</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><a href="#local-6989586621684362282"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><a href="#local-6989586621684362282"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="annot"><a href="#local-6989586621684362282"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-216"></span><span class="hs-special">(</span><span id="local-6989586621684361453"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361453"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684361452"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684361452"><span class="hs-identifier hs-var">xs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="%40%2B%2B%40"><span class="annot"><span class="annottext">@++@ :: forall a. NonEmpty a -&gt; NonEmpty a -&gt; NonEmpty a
</span><a href="Futhark.IR.Mem.IxFun.html#%40%2B%2B%40"><span class="hs-operator hs-var hs-var">@++@</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361451"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361451"><span class="hs-identifier hs-var">y</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684361450"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684361450"><span class="hs-identifier hs-var">ys</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361453"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; [a] -&gt; NonEmpty a
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684361452"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361451"><span class="hs-identifier hs-var">y</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[a] -&gt; [a] -&gt; [a]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684361450"><span class="hs-identifier hs-var">ys</span></a></span><span>
</span><span id="line-217"></span><span>
</span><span id="line-218"></span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#invertMonotonicity"><span class="hs-identifier hs-type">invertMonotonicity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Monotonicity"><span class="hs-identifier hs-type">Monotonicity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Monotonicity"><span class="hs-identifier hs-type">Monotonicity</span></a></span><span>
</span><span id="line-219"></span><span id="invertMonotonicity"><span class="annot"><span class="annottext">invertMonotonicity :: Monotonicity -&gt; Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#invertMonotonicity"><span class="hs-identifier hs-var hs-var">invertMonotonicity</span></a></span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Dec"><span class="hs-identifier hs-var">Dec</span></a></span><span>
</span><span id="line-220"></span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#invertMonotonicity"><span class="hs-identifier hs-var">invertMonotonicity</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Dec"><span class="hs-identifier hs-var">Dec</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span>
</span><span id="line-221"></span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#invertMonotonicity"><span class="hs-identifier hs-var">invertMonotonicity</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>
</span><span id="line-222"></span><span>
</span><span id="line-223"></span><span id="local-6989586621684362280"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-type">lmadPermutation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362280"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Permutation"><span class="hs-identifier hs-type">Permutation</span></a></span></span><span>
</span><span id="line-224"></span><span id="lmadPermutation"><span class="annot"><span class="annottext">lmadPermutation :: forall num. LMAD num -&gt; Permutation
</span><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-var hs-var">lmadPermutation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; Int) -&gt; [LMADDim num] -&gt; Permutation
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; Int
forall num. LMADDim num -&gt; Int
</span><a href="Futhark.IR.Mem.IxFun.html#ldPerm"><span class="hs-identifier hs-var hs-var">ldPerm</span></a></span><span> </span><span class="annot"><span class="annottext">([LMADDim num] -&gt; Permutation)
-&gt; (LMAD num -&gt; [LMADDim num]) -&gt; LMAD num -&gt; Permutation
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMADDim num]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span>
</span><span id="line-225"></span><span>
</span><span id="line-226"></span><span id="local-6989586621684362277"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#setLMADPermutation"><span class="hs-identifier hs-type">setLMADPermutation</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Permutation"><span class="hs-identifier hs-type">Permutation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362277"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362277"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-227"></span><span id="setLMADPermutation"><span class="annot"><span class="annottext">setLMADPermutation :: forall num. Permutation -&gt; LMAD num -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#setLMADPermutation"><span class="hs-identifier hs-var hs-var">setLMADPermutation</span></a></span></span><span> </span><span id="local-6989586621684361445"><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684361445"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684361444"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361444"><span class="hs-identifier hs-var">lmad</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-228"></span><span>  </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361444"><span class="hs-identifier hs-var">lmad</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lmadDims :: [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var">lmadDims</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; Int -&gt; LMADDim num)
-&gt; [LMADDim num] -&gt; Permutation -&gt; [LMADDim num]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684361442"><span class="annot"><span class="annottext">LMADDim num
</span><a href="#local-6989586621684361442"><span class="hs-identifier hs-var">dim</span></a></span></span><span> </span><span id="local-6989586621684361441"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361441"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LMADDim num
</span><a href="#local-6989586621684361442"><span class="hs-identifier hs-var">dim</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ldPerm :: Int
</span><a href="Futhark.IR.Mem.IxFun.html#ldPerm"><span class="hs-identifier hs-var">ldPerm</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361441"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num -&gt; [LMADDim num]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361444"><span class="hs-identifier hs-var">lmad</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684361445"><span class="hs-identifier hs-var">perm</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span id="local-6989586621684362272"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#setLMADShape"><span class="hs-identifier hs-type">setLMADShape</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362272"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362272"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362272"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-231"></span><span id="setLMADShape"><span class="annot"><span class="annottext">setLMADShape :: forall num. Shape num -&gt; LMAD num -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#setLMADShape"><span class="hs-identifier hs-var hs-var">setLMADShape</span></a></span></span><span> </span><span id="local-6989586621684361439"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361439"><span class="hs-identifier hs-var">shp</span></a></span></span><span> </span><span id="local-6989586621684361438"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361438"><span class="hs-identifier hs-var">lmad</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361438"><span class="hs-identifier hs-var">lmad</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">lmadDims :: [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var">lmadDims</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; num -&gt; LMADDim num)
-&gt; [LMADDim num] -&gt; Shape num -&gt; [LMADDim num]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684361437"><span class="annot"><span class="annottext">LMADDim num
</span><a href="#local-6989586621684361437"><span class="hs-identifier hs-var">dim</span></a></span></span><span> </span><span id="local-6989586621684361436"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361436"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LMADDim num
</span><a href="#local-6989586621684361437"><span class="hs-identifier hs-var">dim</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ldShape :: num
</span><a href="Futhark.IR.Mem.IxFun.html#ldShape"><span class="hs-identifier hs-var">ldShape</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361436"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num -&gt; [LMADDim num]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361438"><span class="hs-identifier hs-var">lmad</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361439"><span class="hs-identifier hs-var">shp</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-232"></span><span>
</span><span id="line-233"></span><span class="hs-comment">-- | Substitute a name with a PrimExp in an LMAD.</span><span>
</span><span id="line-234"></span><span id="local-6989586621684362270"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#substituteInLMAD"><span class="hs-identifier hs-type">substituteInLMAD</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-235"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621684362270"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-236"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="#local-6989586621684362270"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#PrimExp"><span class="hs-identifier hs-type">PrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362270"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-237"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#PrimExp"><span class="hs-identifier hs-type">PrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362270"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-238"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#PrimExp"><span class="hs-identifier hs-type">PrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362270"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-239"></span><span id="substituteInLMAD"><span class="annot"><span class="annottext">substituteInLMAD :: forall a.
Ord a =&gt;
Map a (PrimExp a) -&gt; LMAD (PrimExp a) -&gt; LMAD (PrimExp a)
</span><a href="Futhark.IR.Mem.IxFun.html#substituteInLMAD"><span class="hs-identifier hs-var hs-var">substituteInLMAD</span></a></span></span><span> </span><span id="local-6989586621684361433"><span class="annot"><span class="annottext">Map a (PrimExp a)
</span><a href="#local-6989586621684361433"><span class="hs-identifier hs-var">tab</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684361432"><span class="annot"><span class="annottext">PrimExp a
</span><a href="#local-6989586621684361432"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span id="local-6989586621684361431"><span class="annot"><span class="annottext">[LMADDim (PrimExp a)]
</span><a href="#local-6989586621684361431"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684361429"><span class="annot"><span class="annottext">offset' :: PrimExp a
</span><a href="#local-6989586621684361429"><span class="hs-identifier hs-var hs-var">offset'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map a (PrimExp a) -&gt; PrimExp a -&gt; PrimExp a
forall v. Ord v =&gt; Map v (PrimExp v) -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.Convert.html#substituteInPrimExp"><span class="hs-identifier hs-var">substituteInPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map a (PrimExp a)
</span><a href="#local-6989586621684361433"><span class="hs-identifier hs-var">tab</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp a
</span><a href="#local-6989586621684361432"><span class="hs-identifier hs-var">offset</span></a></span><span>
</span><span id="line-241"></span><span>      </span><span id="local-6989586621684361425"><span class="annot"><span class="annottext">dims' :: [LMADDim (PrimExp a)]
</span><a href="#local-6989586621684361425"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-242"></span><span>        </span><span class="annot"><span class="annottext">(LMADDim (PrimExp a) -&gt; LMADDim (PrimExp a))
-&gt; [LMADDim (PrimExp a)] -&gt; [LMADDim (PrimExp a)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span>
</span><span id="line-243"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span id="local-6989586621684361424"><span class="annot"><span class="annottext">PrimExp a
</span><a href="#local-6989586621684361424"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684361423"><span class="annot"><span class="annottext">PrimExp a
</span><a href="#local-6989586621684361423"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684361422"><span class="annot"><span class="annottext">PrimExp a
</span><a href="#local-6989586621684361422"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684361421"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361421"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684361420"><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684361420"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-244"></span><span>              </span><span class="annot"><span class="annottext">PrimExp a
-&gt; PrimExp a
-&gt; PrimExp a
-&gt; Int
-&gt; Monotonicity
-&gt; LMADDim (PrimExp a)
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span>
</span><span id="line-245"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map a (PrimExp a) -&gt; PrimExp a -&gt; PrimExp a
forall v. Ord v =&gt; Map v (PrimExp v) -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.Convert.html#substituteInPrimExp"><span class="hs-identifier hs-var">substituteInPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map a (PrimExp a)
</span><a href="#local-6989586621684361433"><span class="hs-identifier hs-var">tab</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp a
</span><a href="#local-6989586621684361424"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-246"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map a (PrimExp a) -&gt; PrimExp a -&gt; PrimExp a
forall v. Ord v =&gt; Map v (PrimExp v) -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.Convert.html#substituteInPrimExp"><span class="hs-identifier hs-var">substituteInPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map a (PrimExp a)
</span><a href="#local-6989586621684361433"><span class="hs-identifier hs-var">tab</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp a
</span><a href="#local-6989586621684361423"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map a (PrimExp a) -&gt; PrimExp a -&gt; PrimExp a
forall v. Ord v =&gt; Map v (PrimExp v) -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.Convert.html#substituteInPrimExp"><span class="hs-identifier hs-var">substituteInPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map a (PrimExp a)
</span><a href="#local-6989586621684361433"><span class="hs-identifier hs-var">tab</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp a
</span><a href="#local-6989586621684361422"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-248"></span><span>                </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361421"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-249"></span><span>                </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684361420"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-250"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-251"></span><span>          </span><span class="annot"><span class="annottext">[LMADDim (PrimExp a)]
</span><a href="#local-6989586621684361431"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-252"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">PrimExp a -&gt; [LMADDim (PrimExp a)] -&gt; LMAD (PrimExp a)
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp a
</span><a href="#local-6989586621684361429"><span class="hs-identifier hs-var">offset'</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim (PrimExp a)]
</span><a href="#local-6989586621684361425"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-253"></span><span>
</span><span id="line-254"></span><span class="hs-comment">-- | Substitute a name with a PrimExp in an index function.</span><span>
</span><span id="line-255"></span><span id="local-6989586621684362265"><span id="local-6989586621684362266"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#substituteInIxFun"><span class="hs-identifier hs-type">substituteInIxFun</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-256"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Ord</span></span><span> </span><span class="annot"><a href="#local-6989586621684362266"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-257"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="#local-6989586621684362266"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362265"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362266"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-258"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362265"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362266"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-259"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362265"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362266"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span></span></span><span>
</span><span id="line-260"></span><span id="substituteInIxFun"><span class="annot"><span class="annottext">substituteInIxFun :: forall a t.
Ord a =&gt;
Map a (TPrimExp t a)
-&gt; IxFun (TPrimExp t a) -&gt; IxFun (TPrimExp t a)
</span><a href="Futhark.IR.Mem.IxFun.html#substituteInIxFun"><span class="hs-identifier hs-var hs-var">substituteInIxFun</span></a></span></span><span> </span><span id="local-6989586621684361410"><span class="annot"><span class="annottext">Map a (TPrimExp t a)
</span><a href="#local-6989586621684361410"><span class="hs-identifier hs-var">tab</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span id="local-6989586621684361409"><span class="annot"><span class="annottext">NonEmpty (LMAD (TPrimExp t a))
</span><a href="#local-6989586621684361409"><span class="hs-identifier hs-var">lmads</span></a></span></span><span> </span><span id="local-6989586621684361408"><span class="annot"><span class="annottext">Shape (TPrimExp t a)
</span><a href="#local-6989586621684361408"><span class="hs-identifier hs-var">oshp</span></a></span></span><span> </span><span id="local-6989586621684361407"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361407"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-261"></span><span>  </span><span class="annot"><span class="annottext">NonEmpty (LMAD (TPrimExp t a))
-&gt; Shape (TPrimExp t a) -&gt; Bool -&gt; IxFun (TPrimExp t a)
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span>
</span><span id="line-262"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LMAD (TPrimExp t a) -&gt; LMAD (TPrimExp t a))
-&gt; NonEmpty (LMAD (TPrimExp t a)) -&gt; NonEmpty (LMAD (TPrimExp t a))
forall a b. (a -&gt; b) -&gt; NonEmpty a -&gt; NonEmpty b
</span><span class="hs-identifier hs-var">NE.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PrimExp a -&gt; TPrimExp t a)
-&gt; LMAD (PrimExp a) -&gt; LMAD (TPrimExp t a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">PrimExp a -&gt; TPrimExp t a
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(LMAD (PrimExp a) -&gt; LMAD (TPrimExp t a))
-&gt; (LMAD (TPrimExp t a) -&gt; LMAD (PrimExp a))
-&gt; LMAD (TPrimExp t a)
-&gt; LMAD (TPrimExp t a)
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map a (PrimExp a) -&gt; LMAD (PrimExp a) -&gt; LMAD (PrimExp a)
forall a.
Ord a =&gt;
Map a (PrimExp a) -&gt; LMAD (PrimExp a) -&gt; LMAD (PrimExp a)
</span><a href="Futhark.IR.Mem.IxFun.html#substituteInLMAD"><span class="hs-identifier hs-var">substituteInLMAD</span></a></span><span> </span><span class="annot"><span class="annottext">Map a (PrimExp a)
</span><a href="#local-6989586621684361405"><span class="hs-identifier hs-var">tab'</span></a></span><span> </span><span class="annot"><span class="annottext">(LMAD (PrimExp a) -&gt; LMAD (PrimExp a))
-&gt; (LMAD (TPrimExp t a) -&gt; LMAD (PrimExp a))
-&gt; LMAD (TPrimExp t a)
-&gt; LMAD (PrimExp a)
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp t a -&gt; PrimExp a)
-&gt; LMAD (TPrimExp t a) -&gt; LMAD (PrimExp a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp t a -&gt; PrimExp a
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD (TPrimExp t a))
</span><a href="#local-6989586621684361409"><span class="hs-identifier hs-var">lmads</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-263"></span><span>    </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TPrimExp t a -&gt; TPrimExp t a)
-&gt; Shape (TPrimExp t a) -&gt; Shape (TPrimExp t a)
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimExp a -&gt; TPrimExp t a
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp a -&gt; TPrimExp t a)
-&gt; (TPrimExp t a -&gt; PrimExp a) -&gt; TPrimExp t a -&gt; TPrimExp t a
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map a (PrimExp a) -&gt; PrimExp a -&gt; PrimExp a
forall v. Ord v =&gt; Map v (PrimExp v) -&gt; PrimExp v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.Convert.html#substituteInPrimExp"><span class="hs-identifier hs-var">substituteInPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map a (PrimExp a)
</span><a href="#local-6989586621684361405"><span class="hs-identifier hs-var">tab'</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp a -&gt; PrimExp a)
-&gt; (TPrimExp t a -&gt; PrimExp a) -&gt; TPrimExp t a -&gt; PrimExp a
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp t a -&gt; PrimExp a
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape (TPrimExp t a)
</span><a href="#local-6989586621684361408"><span class="hs-identifier hs-var">oshp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-264"></span><span>    </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361407"><span class="hs-identifier hs-var">cg</span></a></span><span>
</span><span id="line-265"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-266"></span><span>    </span><span id="local-6989586621684361405"><span class="annot"><span class="annottext">tab' :: Map a (PrimExp a)
</span><a href="#local-6989586621684361405"><span class="hs-identifier hs-var hs-var">tab'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TPrimExp t a -&gt; PrimExp a)
-&gt; Map a (TPrimExp t a) -&gt; Map a (PrimExp a)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp t a -&gt; PrimExp a
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">Map a (TPrimExp t a)
</span><a href="#local-6989586621684361410"><span class="hs-identifier hs-var">tab</span></a></span><span>
</span><span id="line-267"></span><span>
</span><span id="line-268"></span><span class="hs-comment">-- | Is this is a row-major array?</span><span>
</span><span id="line-269"></span><span id="local-6989586621684362258"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#isDirect"><span class="hs-identifier hs-type">isDirect</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362258"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362258"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362258"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-270"></span><span id="isDirect"><span class="annot"><span class="annottext">isDirect :: forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#isDirect"><span class="hs-identifier hs-var hs-var">isDirect</span></a></span></span><span> </span><span id="local-6989586621684361381"><span class="annot"><span class="annottext">ixfun :: IxFun num
</span><a href="#local-6989586621684361381"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684361380"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361380"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span id="local-6989586621684361379"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361379"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684361378"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361378"><span class="hs-identifier hs-var">oshp</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-271"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684361375"><span class="annot"><span class="annottext">strides_expected :: Shape num
</span><a href="#local-6989586621684361375"><span class="hs-identifier hs-var hs-var">strides_expected</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Shape num -&gt; Shape num
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">(Shape num -&gt; Shape num) -&gt; Shape num -&gt; Shape num
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(num -&gt; num -&gt; num) -&gt; num -&gt; Shape num -&gt; Shape num
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">scanl</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(*)</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape num -&gt; Shape num
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape num -&gt; Shape num
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">tail</span></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361378"><span class="hs-identifier hs-var">oshp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-272"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; Bool
forall num. IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#hasContiguousPerm"><span class="hs-identifier hs-var">hasContiguousPerm</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684361381"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-273"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Shape num -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361378"><span class="hs-identifier hs-var">oshp</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361379"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-274"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361380"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span>
</span><span id="line-275"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">((LMADDim num, Int, num, num) -&gt; Bool)
-&gt; [(LMADDim num, Int, num, num)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span>
</span><span id="line-276"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span id="local-6989586621684361366"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361366"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684361365"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361365"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684361364"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361364"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684361363"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361363"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684361362"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361362"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684361361"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361361"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684361360"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361360"><span class="hs-identifier hs-var">se</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-277"></span><span>              </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361366"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361360"><span class="hs-identifier hs-var">se</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361365"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361364"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361361"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361363"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361362"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-278"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-279"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LMADDim num]
-&gt; Permutation
-&gt; Shape num
-&gt; Shape num
-&gt; [(LMADDim num, Int, num, num)]
forall a b c d. [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [(a, b, c, d)]
</span><span class="hs-identifier hs-var">zip4</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361379"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361379"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361378"><span class="hs-identifier hs-var">oshp</span></a></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361375"><span class="hs-identifier hs-var">strides_expected</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-280"></span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#isDirect"><span class="hs-identifier hs-var">isDirect</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-281"></span><span>
</span><span id="line-282"></span><span class="hs-comment">-- | Does the index function have an ascending permutation?</span><span>
</span><span id="line-283"></span><span id="local-6989586621684361359"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#hasContiguousPerm"><span class="hs-identifier hs-type">hasContiguousPerm</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684361359"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-284"></span><span id="hasContiguousPerm"><span class="annot"><span class="annottext">hasContiguousPerm :: forall num. IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#hasContiguousPerm"><span class="hs-identifier hs-var hs-var">hasContiguousPerm</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361356"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361356"><span class="hs-identifier hs-var">lmad</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-285"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684361355"><span class="annot"><span class="annottext">perm :: Permutation
</span><a href="#local-6989586621684361355"><span class="hs-identifier hs-var hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Permutation
forall num. LMAD num -&gt; Permutation
</span><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-var">lmadPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361356"><span class="hs-identifier hs-var">lmad</span></a></span><span>
</span><span id="line-286"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684361355"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; Permutation -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; Permutation
forall a. Ord a =&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sort</span></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684361355"><span class="hs-identifier hs-var">perm</span></a></span><span>
</span><span id="line-287"></span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#hasContiguousPerm"><span class="hs-identifier hs-var">hasContiguousPerm</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-288"></span><span>
</span><span id="line-289"></span><span class="hs-comment">-- | Shape of an index function.</span><span>
</span><span id="line-290"></span><span id="local-6989586621684362242"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#shape"><span class="hs-identifier hs-type">shape</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362242"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362242"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362242"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362242"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-291"></span><span id="shape"><span class="annot"><span class="annottext">shape :: forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#shape"><span class="hs-identifier hs-var hs-var">shape</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361350"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361350"><span class="hs-identifier hs-var">lmad</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Shape num
forall num. (Eq num, IntegralExp num) =&gt; LMAD num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadShape"><span class="hs-identifier hs-var">lmadShape</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361350"><span class="hs-identifier hs-var">lmad</span></a></span><span>
</span><span id="line-292"></span><span>
</span><span id="line-293"></span><span class="hs-comment">-- | Shape of an LMAD.</span><span>
</span><span id="line-294"></span><span id="local-6989586621684362240"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#lmadShape"><span class="hs-identifier hs-type">lmadShape</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362240"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362240"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362240"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362240"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-295"></span><span id="lmadShape"><span class="annot"><span class="annottext">lmadShape :: forall num. (Eq num, IntegralExp num) =&gt; LMAD num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadShape"><span class="hs-identifier hs-var hs-var">lmadShape</span></a></span></span><span> </span><span id="local-6989586621684361344"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361344"><span class="hs-identifier hs-var">lmad</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; [num] -&gt; [num]
forall a. Permutation -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Mem.IxFun.html#permuteInv"><span class="hs-identifier hs-var">permuteInv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num -&gt; Permutation
forall num. LMAD num -&gt; Permutation
</span><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-var">lmadPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361344"><span class="hs-identifier hs-var">lmad</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([num] -&gt; [num]) -&gt; [num] -&gt; [num]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [num]
forall num. (Eq num, IntegralExp num) =&gt; LMAD num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadShapeBase"><span class="hs-identifier hs-var">lmadShapeBase</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361344"><span class="hs-identifier hs-var">lmad</span></a></span><span>
</span><span id="line-296"></span><span>
</span><span id="line-297"></span><span class="hs-comment">-- | Shape of an LMAD, ignoring permutations.</span><span>
</span><span id="line-298"></span><span id="local-6989586621684361341"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#lmadShapeBase"><span class="hs-identifier hs-type">lmadShapeBase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684361341"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684361341"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684361341"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684361341"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-299"></span><span id="lmadShapeBase"><span class="annot"><span class="annottext">lmadShapeBase :: forall num. (Eq num, IntegralExp num) =&gt; LMAD num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadShapeBase"><span class="hs-identifier hs-var hs-var">lmadShapeBase</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; num) -&gt; [LMADDim num] -&gt; [num]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; num
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldShape"><span class="hs-identifier hs-var hs-var">ldShape</span></a></span><span> </span><span class="annot"><span class="annottext">([LMADDim num] -&gt; [num])
-&gt; (LMAD num -&gt; [LMADDim num]) -&gt; LMAD num -&gt; [num]
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMADDim num]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span>
</span><span id="line-300"></span><span>
</span><span id="line-301"></span><span class="hs-comment">-- | Compute the flat memory index for a complete set @inds@ of array indices</span><span>
</span><span id="line-302"></span><span class="hs-comment">-- and a certain element size @elem_size@.</span><span>
</span><span id="line-303"></span><span id="local-6989586621684362236"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#index"><span class="hs-identifier hs-type">index</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-304"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362236"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362236"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-305"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362236"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-306"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Indices"><span class="hs-identifier hs-type">Indices</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362236"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-307"></span><span>  </span><span class="annot"><a href="#local-6989586621684362236"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-308"></span><span id="index"><span class="annot"><span class="annottext">index :: forall num.
(IntegralExp num, Eq num) =&gt;
IxFun num -&gt; Indices num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#index"><span class="hs-identifier hs-var hs-var">index</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Indices num -&gt; num
forall num.
(IntegralExp num, Eq num) =&gt;
NonEmpty (LMAD num) -&gt; Indices num -&gt; num
</span><a href="#local-6989586621684361332"><span class="hs-identifier hs-var">indexFromLMADs</span></a></span><span> </span><span class="annot"><span class="annottext">(NonEmpty (LMAD num) -&gt; Indices num -&gt; num)
-&gt; (IxFun num -&gt; NonEmpty (LMAD num))
-&gt; IxFun num
-&gt; Indices num
-&gt; num
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; NonEmpty (LMAD num)
forall num. IxFun num -&gt; NonEmpty (LMAD num)
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunLMADs"><span class="hs-identifier hs-var hs-var">ixfunLMADs</span></a></span><span>
</span><span id="line-309"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-310"></span><span>    </span><span id="local-6989586621684362233"><span class="annot"><a href="#local-6989586621684361332"><span class="hs-identifier hs-type">indexFromLMADs</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-311"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362233"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362233"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-312"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">NonEmpty</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362233"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-313"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Indices"><span class="hs-identifier hs-type">Indices</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362233"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-314"></span><span>      </span><span class="annot"><a href="#local-6989586621684362233"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-315"></span><span>    </span><span id="local-6989586621684361332"><span class="annot"><span class="annottext">indexFromLMADs :: forall num.
(IntegralExp num, Eq num) =&gt;
NonEmpty (LMAD num) -&gt; Indices num -&gt; num
</span><a href="#local-6989586621684361332"><span class="hs-identifier hs-var hs-var">indexFromLMADs</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361325"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361325"><span class="hs-identifier hs-var">lmad</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684361324"><span class="annot"><span class="annottext">Indices num
</span><a href="#local-6989586621684361324"><span class="hs-identifier hs-var">inds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Indices num -&gt; num
forall num.
(IntegralExp num, Eq num) =&gt;
LMAD num -&gt; Indices num -&gt; num
</span><a href="#local-6989586621684361323"><span class="hs-identifier hs-var">indexLMAD</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361325"><span class="hs-identifier hs-var">lmad</span></a></span><span> </span><span class="annot"><span class="annottext">Indices num
</span><a href="#local-6989586621684361324"><span class="hs-identifier hs-var">inds</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span class="annot"><a href="#local-6989586621684361332"><span class="hs-identifier hs-var">indexFromLMADs</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361322"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361322"><span class="hs-identifier hs-var">lmad1</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684361321"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361321"><span class="hs-identifier hs-var">lmad2</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684361320"><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684361320"><span class="hs-identifier hs-var">lmads</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684361319"><span class="annot"><span class="annottext">Indices num
</span><a href="#local-6989586621684361319"><span class="hs-identifier hs-var">inds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-317"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684361316"><span class="annot"><span class="annottext">i_flat :: num
</span><a href="#local-6989586621684361316"><span class="hs-identifier hs-var hs-var">i_flat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Indices num -&gt; num
forall num.
(IntegralExp num, Eq num) =&gt;
LMAD num -&gt; Indices num -&gt; num
</span><a href="#local-6989586621684361323"><span class="hs-identifier hs-var">indexLMAD</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361322"><span class="hs-identifier hs-var">lmad1</span></a></span><span> </span><span class="annot"><span class="annottext">Indices num
</span><a href="#local-6989586621684361319"><span class="hs-identifier hs-var">inds</span></a></span><span>
</span><span id="line-318"></span><span>          </span><span id="local-6989586621684361312"><span class="annot"><span class="annottext">new_inds :: Indices num
</span><a href="#local-6989586621684361312"><span class="hs-identifier hs-var hs-var">new_inds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Indices num -&gt; num -&gt; Indices num
forall num. IntegralExp num =&gt; [num] -&gt; num -&gt; [num]
</span><a href="Futhark.IR.Prop.Reshape.html#unflattenIndex"><span class="hs-identifier hs-var">unflattenIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Permutation -&gt; Indices num -&gt; Indices num
forall a. Permutation -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Mem.IxFun.html#permuteFwd"><span class="hs-identifier hs-var">permuteFwd</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num -&gt; Permutation
forall num. LMAD num -&gt; Permutation
</span><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-var">lmadPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361321"><span class="hs-identifier hs-var">lmad2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Indices num -&gt; Indices num) -&gt; Indices num -&gt; Indices num
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Indices num
forall num. (Eq num, IntegralExp num) =&gt; LMAD num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadShapeBase"><span class="hs-identifier hs-var">lmadShapeBase</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361321"><span class="hs-identifier hs-var">lmad2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361316"><span class="hs-identifier hs-var">i_flat</span></a></span><span>
</span><span id="line-319"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Indices num -&gt; num
forall num.
(IntegralExp num, Eq num) =&gt;
NonEmpty (LMAD num) -&gt; Indices num -&gt; num
</span><a href="#local-6989586621684361332"><span class="hs-identifier hs-var">indexFromLMADs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361321"><span class="hs-identifier hs-var">lmad2</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; NonEmpty (LMAD num)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684361320"><span class="hs-identifier hs-var">lmads</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Indices num
</span><a href="#local-6989586621684361312"><span class="hs-identifier hs-var">new_inds</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span id="local-6989586621684362231"><span class="annot"><a href="#local-6989586621684361323"><span class="hs-identifier hs-type">indexLMAD</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-321"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362231"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362231"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-322"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362231"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-323"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Indices"><span class="hs-identifier hs-type">Indices</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362231"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-324"></span><span>      </span><span class="annot"><a href="#local-6989586621684362231"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-325"></span><span>    </span><span id="local-6989586621684361323"><span class="annot"><span class="annottext">indexLMAD :: forall num.
(IntegralExp num, Eq num) =&gt;
LMAD num -&gt; Indices num -&gt; num
</span><a href="#local-6989586621684361323"><span class="hs-identifier hs-var hs-var">indexLMAD</span></a></span></span><span> </span><span id="local-6989586621684361305"><span class="annot"><span class="annottext">lmad :: LMAD num
</span><a href="#local-6989586621684361305"><span class="hs-identifier hs-var">lmad</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684361304"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361304"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621684361303"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361303"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684361302"><span class="annot"><span class="annottext">Indices num
</span><a href="#local-6989586621684361302"><span class="hs-identifier hs-var">inds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-326"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684361297"><span class="annot"><span class="annottext">prod :: num
</span><a href="#local-6989586621684361297"><span class="hs-identifier hs-var hs-var">prod</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-327"></span><span>            </span><span class="annot"><span class="annottext">Indices num -&gt; num
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">(Indices num -&gt; num) -&gt; Indices num -&gt; num
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-328"></span><span>              </span><span class="annot"><span class="annottext">((num, num, num) -&gt; num -&gt; num)
-&gt; [(num, num, num)] -&gt; Indices num -&gt; Indices num
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span>
</span><span id="line-329"></span><span>                </span><span class="annot"><span class="annottext">(num, num, num) -&gt; num -&gt; num
forall num.
(Eq num, IntegralExp num) =&gt;
(num, num, num) -&gt; num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#flatOneDim"><span class="hs-identifier hs-var">flatOneDim</span></a></span><span>
</span><span id="line-330"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LMADDim num -&gt; (num, num, num))
-&gt; [LMADDim num] -&gt; [(num, num, num)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span id="local-6989586621684361294"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361294"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684361293"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361293"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684361292"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361292"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361294"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361293"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361292"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361303"><span class="hs-identifier hs-var">dims</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-331"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Permutation -&gt; Indices num -&gt; Indices num
forall a. Permutation -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Mem.IxFun.html#permuteInv"><span class="hs-identifier hs-var">permuteInv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num -&gt; Permutation
forall num. LMAD num -&gt; Permutation
</span><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-var">lmadPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361305"><span class="hs-identifier hs-var">lmad</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Indices num
</span><a href="#local-6989586621684361302"><span class="hs-identifier hs-var">inds</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-332"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361304"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361297"><span class="hs-identifier hs-var">prod</span></a></span><span>
</span><span id="line-333"></span><span>
</span><span id="line-334"></span><span class="hs-comment">-- | iota with offset.</span><span>
</span><span id="line-335"></span><span id="local-6989586621684362227"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#iotaOffset"><span class="hs-identifier hs-type">iotaOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362227"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684362227"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362227"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362227"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-336"></span><span id="iotaOffset"><span class="annot"><span class="annottext">iotaOffset :: forall num. IntegralExp num =&gt; num -&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iotaOffset"><span class="hs-identifier hs-var hs-var">iotaOffset</span></a></span></span><span> </span><span id="local-6989586621684361287"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361287"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span id="local-6989586621684361286"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361286"><span class="hs-identifier hs-var">ns</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-337"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684361283"><span class="annot"><span class="annottext">rs :: Shape num
</span><a href="#local-6989586621684361283"><span class="hs-identifier hs-var hs-var">rs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; num -&gt; Shape num
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape num -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361286"><span class="hs-identifier hs-var">ns</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span>
</span><span id="line-338"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Monotonicity -&gt; num -&gt; [(num, num)] -&gt; LMAD num
forall num.
IntegralExp num =&gt;
Monotonicity -&gt; num -&gt; [(num, num)] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#makeRotIota"><span class="hs-identifier hs-var">makeRotIota</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361287"><span class="hs-identifier hs-var">o</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape num -&gt; Shape num -&gt; [(num, num)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361283"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361286"><span class="hs-identifier hs-var">ns</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; NonEmpty (LMAD num)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361286"><span class="hs-identifier hs-var">ns</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-339"></span><span>
</span><span id="line-340"></span><span class="hs-comment">-- | iota.</span><span>
</span><span id="line-341"></span><span id="local-6989586621684362220"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-type">iota</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362220"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Shape"><span class="hs-identifier hs-type">Shape</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362220"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362220"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-342"></span><span id="iota"><span class="annot"><span class="annottext">iota :: forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var hs-var">iota</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num -&gt; Shape num -&gt; IxFun num
forall num. IntegralExp num =&gt; num -&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iotaOffset"><span class="hs-identifier hs-var">iotaOffset</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span>
</span><span id="line-343"></span><span>
</span><span id="line-344"></span><span class="hs-comment">-- | Permute dimensions.</span><span>
</span><span id="line-345"></span><span id="local-6989586621684362218"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#permute"><span class="hs-identifier hs-type">permute</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-346"></span><span>  </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362218"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-347"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362218"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-348"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Permutation"><span class="hs-identifier hs-type">Permutation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-349"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362218"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-350"></span><span id="permute"><span class="annot"><span class="annottext">permute :: forall num.
IntegralExp num =&gt;
IxFun num -&gt; Permutation -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#permute"><span class="hs-identifier hs-var hs-var">permute</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361275"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361275"><span class="hs-identifier hs-var">lmad</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684361274"><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684361274"><span class="hs-identifier hs-var">lmads</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684361273"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361273"><span class="hs-identifier hs-var">oshp</span></a></span></span><span> </span><span id="local-6989586621684361272"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361272"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684361271"><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684361271"><span class="hs-identifier hs-var">perm_new</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-351"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684361270"><span class="annot"><span class="annottext">perm_cur :: Permutation
</span><a href="#local-6989586621684361270"><span class="hs-identifier hs-var hs-var">perm_cur</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Permutation
forall num. LMAD num -&gt; Permutation
</span><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-var">lmadPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361275"><span class="hs-identifier hs-var">lmad</span></a></span><span>
</span><span id="line-352"></span><span>      </span><span id="local-6989586621684361269"><span class="annot"><span class="annottext">perm :: Permutation
</span><a href="#local-6989586621684361269"><span class="hs-identifier hs-var hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; Permutation -&gt; Permutation
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684361270"><span class="hs-identifier hs-var">perm_cur</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; Int -&gt; Int
forall a. [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684361271"><span class="hs-identifier hs-var">perm_new</span></a></span><span>
</span><span id="line-353"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Permutation -&gt; LMAD num -&gt; LMAD num
forall num. Permutation -&gt; LMAD num -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#setLMADPermutation"><span class="hs-identifier hs-var">setLMADPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684361269"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361275"><span class="hs-identifier hs-var">lmad</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; NonEmpty (LMAD num)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684361274"><span class="hs-identifier hs-var">lmads</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361273"><span class="hs-identifier hs-var">oshp</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361272"><span class="hs-identifier hs-var">cg</span></a></span><span>
</span><span id="line-354"></span><span>
</span><span id="line-355"></span><span class="hs-comment">-- | Rotate an index function.</span><span>
</span><span id="line-356"></span><span id="local-6989586621684362215"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#rotate"><span class="hs-identifier hs-type">rotate</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-357"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362215"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362215"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-358"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362215"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-359"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Indices"><span class="hs-identifier hs-type">Indices</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362215"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-360"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362215"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-361"></span><span id="rotate"><span class="annot"><span class="annottext">rotate :: forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; Indices num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#rotate"><span class="hs-identifier hs-var hs-var">rotate</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361264"><span class="annot"><span class="annottext">lmad :: LMAD num
</span><a href="#local-6989586621684361264"><span class="hs-identifier hs-var">lmad</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684361263"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361263"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621684361262"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361262"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684361261"><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684361261"><span class="hs-identifier hs-var">lmads</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684361260"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361260"><span class="hs-identifier hs-var">oshp</span></a></span></span><span> </span><span id="local-6989586621684361259"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361259"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684361258"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361258"><span class="hs-identifier hs-var">offs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-362"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684361252"><span class="annot"><span class="annottext">dims' :: [LMADDim num]
</span><a href="#local-6989586621684361252"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-363"></span><span>        </span><span class="annot"><span class="annottext">(LMADDim num -&gt; num -&gt; LMADDim num)
-&gt; [LMADDim num] -&gt; Shape num -&gt; [LMADDim num]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span>
</span><span id="line-364"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span id="local-6989586621684361251"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361251"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684361250"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361250"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684361249"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361249"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684361248"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361248"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684361247"><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684361247"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684361246"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361246"><span class="hs-identifier hs-var">o</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-365"></span><span>              </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361251"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span>
</span><span id="line-366"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361249"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361248"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>
</span><span id="line-367"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361251"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361250"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361246"><span class="hs-identifier hs-var">o</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361249"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361248"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684361247"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-368"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-369"></span><span>          </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361262"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-370"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Permutation -&gt; Shape num -&gt; Shape num
forall a. Permutation -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Mem.IxFun.html#permuteInv"><span class="hs-identifier hs-var">permuteInv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num -&gt; Permutation
forall num. LMAD num -&gt; Permutation
</span><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-var">lmadPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361264"><span class="hs-identifier hs-var">lmad</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361258"><span class="hs-identifier hs-var">offs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-371"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361263"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361252"><span class="hs-identifier hs-var">dims'</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; NonEmpty (LMAD num)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684361261"><span class="hs-identifier hs-var">lmads</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361260"><span class="hs-identifier hs-var">oshp</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361259"><span class="hs-identifier hs-var">cg</span></a></span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span class="hs-comment">-- | Handle the case where a slice can stay within a single LMAD.</span><span>
</span><span id="line-374"></span><span id="local-6989586621684362213"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#sliceOneLMAD"><span class="hs-identifier hs-type">sliceOneLMAD</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-375"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362213"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362213"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-376"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362213"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-377"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362213"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-378"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362213"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-379"></span><span id="sliceOneLMAD"><span class="annot"><span class="annottext">sliceOneLMAD :: forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; Slice num -&gt; Maybe (IxFun num)
</span><a href="Futhark.IR.Mem.IxFun.html#sliceOneLMAD"><span class="hs-identifier hs-var hs-var">sliceOneLMAD</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361235"><span class="annot"><span class="annottext">lmad :: LMAD num
</span><a href="#local-6989586621684361235"><span class="hs-identifier hs-var">lmad</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684361234"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361234"><span class="hs-identifier hs-var">ldims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684361233"><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684361233"><span class="hs-identifier hs-var">lmads</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684361232"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361232"><span class="hs-identifier hs-var">oshp</span></a></span></span><span> </span><span id="local-6989586621684361231"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361231"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span id="local-6989586621684361229"><span class="annot"><span class="annottext">[DimIndex num]
</span><a href="#local-6989586621684361229"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-380"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684361228"><span class="annot"><span class="annottext">perm :: Permutation
</span><a href="#local-6989586621684361228"><span class="hs-identifier hs-var hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Permutation
forall num. LMAD num -&gt; Permutation
</span><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-var">lmadPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361235"><span class="hs-identifier hs-var">lmad</span></a></span><span>
</span><span id="line-381"></span><span>      </span><span id="local-6989586621684361227"><span class="annot"><span class="annottext">is' :: [DimIndex num]
</span><a href="#local-6989586621684361227"><span class="hs-identifier hs-var hs-var">is'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; [DimIndex num] -&gt; [DimIndex num]
forall a. Permutation -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Mem.IxFun.html#permuteInv"><span class="hs-identifier hs-var">permuteInv</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684361228"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex num]
</span><a href="#local-6989586621684361229"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-382"></span><span>      </span><span id="local-6989586621684361224"><span class="annot"><span class="annottext">cg' :: Bool
</span><a href="#local-6989586621684361224"><span class="hs-identifier hs-var hs-var">cg'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361231"><span class="hs-identifier hs-var">cg</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Slice num -&gt; Bool
forall num.
(Eq num, IntegralExp num) =&gt;
LMAD num -&gt; Slice num -&gt; Bool
</span><a href="#local-6989586621684361223"><span class="hs-identifier hs-var">slicePreservesContiguous</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361235"><span class="hs-identifier hs-var">lmad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex num] -&gt; Slice num
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex num]
</span><a href="#local-6989586621684361227"><span class="hs-identifier hs-var">is'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-383"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Slice num -&gt; Bool
forall num.
(Eq num, IntegralExp num) =&gt;
LMAD num -&gt; Slice num -&gt; Bool
</span><a href="#local-6989586621684361222"><span class="hs-identifier hs-var">harmlessRotation</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361235"><span class="hs-identifier hs-var">lmad</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[DimIndex num] -&gt; Slice num
forall d. [DimIndex d] -&gt; Slice d
</span><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-var">Slice</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex num]
</span><a href="#local-6989586621684361227"><span class="hs-identifier hs-var">is'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-384"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684361218"><span class="annot"><span class="annottext">lmad' :: LMAD num
</span><a href="#local-6989586621684361218"><span class="hs-identifier hs-var hs-var">lmad'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LMAD num -&gt; (DimIndex num, LMADDim num) -&gt; LMAD num)
-&gt; LMAD num -&gt; [(DimIndex num, LMADDim num)] -&gt; LMAD num
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; (DimIndex num, LMADDim num) -&gt; LMAD num
forall num.
(Eq num, IntegralExp num) =&gt;
LMAD num -&gt; (DimIndex num, LMADDim num) -&gt; LMAD num
</span><a href="#local-6989586621684361216"><span class="hs-identifier hs-var">sliceOne</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num -&gt; num
forall num. LMAD num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadOffset"><span class="hs-identifier hs-var hs-var">lmadOffset</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361235"><span class="hs-identifier hs-var">lmad</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(DimIndex num, LMADDim num)] -&gt; LMAD num)
-&gt; [(DimIndex num, LMADDim num)] -&gt; LMAD num
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex num] -&gt; [LMADDim num] -&gt; [(DimIndex num, LMADDim num)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex num]
</span><a href="#local-6989586621684361227"><span class="hs-identifier hs-var">is'</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361234"><span class="hs-identifier hs-var">ldims</span></a></span><span>
</span><span id="line-385"></span><span>      </span><span class="hs-comment">-- need to remove the fixed dims from the permutation</span><span>
</span><span id="line-386"></span><span>      </span><span id="local-6989586621684361204"><span class="annot"><span class="annottext">perm' :: Permutation
</span><a href="#local-6989586621684361204"><span class="hs-identifier hs-var hs-var">perm'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-387"></span><span>        </span><span class="annot"><span class="annottext">Permutation -&gt; Permutation -&gt; Permutation
forall {t :: * -&gt; *} {b} {t :: * -&gt; *}.
(Foldable t, Ord b, Foldable t, Num b) =&gt;
t b -&gt; t b -&gt; [b]
</span><a href="#local-6989586621684361203"><span class="hs-identifier hs-var">updatePerm</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684361228"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">(Permutation -&gt; Permutation) -&gt; Permutation -&gt; Permutation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-388"></span><span>          </span><span class="annot"><span class="annottext">((Int, DimIndex num) -&gt; Int)
-&gt; [(Int, DimIndex num)] -&gt; Permutation
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Int, DimIndex num) -&gt; Int
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">([(Int, DimIndex num)] -&gt; Permutation)
-&gt; [(Int, DimIndex num)] -&gt; Permutation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-389"></span><span>            </span><span class="annot"><span class="annottext">((Int, DimIndex num) -&gt; Bool)
-&gt; [(Int, DimIndex num)] -&gt; [(Int, DimIndex num)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe num -&gt; Bool
forall a. Maybe a -&gt; Bool
</span><span class="hs-identifier hs-var">isJust</span></span><span> </span><span class="annot"><span class="annottext">(Maybe num -&gt; Bool)
-&gt; ((Int, DimIndex num) -&gt; Maybe num)
-&gt; (Int, DimIndex num)
-&gt; Bool
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">DimIndex num -&gt; Maybe num
forall d. DimIndex d -&gt; Maybe d
</span><a href="Futhark.IR.Syntax.Core.html#dimFix"><span class="hs-identifier hs-var">dimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(DimIndex num -&gt; Maybe num)
-&gt; ((Int, DimIndex num) -&gt; DimIndex num)
-&gt; (Int, DimIndex num)
-&gt; Maybe num
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Int, DimIndex num) -&gt; DimIndex num
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Int, DimIndex num)] -&gt; [(Int, DimIndex num)])
-&gt; [(Int, DimIndex num)] -&gt; [(Int, DimIndex num)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-390"></span><span>              </span><span class="annot"><span class="annottext">Permutation -&gt; [DimIndex num] -&gt; [(Int, DimIndex num)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">[DimIndex num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex num]
</span><a href="#local-6989586621684361227"><span class="hs-identifier hs-var">is'</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[DimIndex num]
</span><a href="#local-6989586621684361227"><span class="hs-identifier hs-var">is'</span></a></span><span>
</span><span id="line-391"></span><span>
</span><span id="line-392"></span><span>  </span><span class="annot"><span class="annottext">IxFun num -&gt; Maybe (IxFun num)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(IxFun num -&gt; Maybe (IxFun num)) -&gt; IxFun num -&gt; Maybe (IxFun num)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Permutation -&gt; LMAD num -&gt; LMAD num
forall num. Permutation -&gt; LMAD num -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#setLMADPermutation"><span class="hs-identifier hs-var">setLMADPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684361204"><span class="hs-identifier hs-var">perm'</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684361218"><span class="hs-identifier hs-var">lmad'</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; NonEmpty (LMAD num)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684361233"><span class="hs-identifier hs-var">lmads</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684361232"><span class="hs-identifier hs-var">oshp</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361224"><span class="hs-identifier hs-var">cg'</span></a></span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-394"></span><span>    </span><span id="local-6989586621684361203"><span class="annot"><span class="annottext">updatePerm :: t b -&gt; t b -&gt; [b]
</span><a href="#local-6989586621684361203"><span class="hs-identifier hs-var hs-var">updatePerm</span></a></span></span><span> </span><span id="local-6989586621684361195"><span class="annot"><span class="annottext">t b
</span><a href="#local-6989586621684361195"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621684361194"><span class="annot"><span class="annottext">t b
</span><a href="#local-6989586621684361194"><span class="hs-identifier hs-var">inds</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(b -&gt; [b]) -&gt; t b -&gt; [b]
forall (t :: * -&gt; *) a b. Foldable t =&gt; (a -&gt; [b]) -&gt; t a -&gt; [b]
</span><span class="hs-identifier hs-var">concatMap</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; [b]
</span><a href="#local-6989586621684361192"><span class="hs-identifier hs-var">decrease</span></a></span><span> </span><span class="annot"><span class="annottext">t b
</span><a href="#local-6989586621684361195"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-395"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-396"></span><span>        </span><span id="local-6989586621684361192"><span class="annot"><span class="annottext">decrease :: b -&gt; [b]
</span><a href="#local-6989586621684361192"><span class="hs-identifier hs-var hs-var">decrease</span></a></span></span><span> </span><span id="local-6989586621684361187"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684361187"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-397"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684361175"><span class="annot"><span class="annottext">f :: a -&gt; b -&gt; a
</span><a href="#local-6989586621684361175"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684361174"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361174"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684361173"><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684361173"><span class="hs-identifier hs-var">i</span></a></span></span><span>
</span><span id="line-398"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684361173"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; b -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684361187"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span>
</span><span id="line-399"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684361173"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; b -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684361187"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361174"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-400"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361174"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361174"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span>
</span><span id="line-401"></span><span>                </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684361174"><span class="hs-identifier hs-var">n</span></a></span><span>
</span><span id="line-402"></span><span>              </span><span id="local-6989586621684361166"><span class="annot"><span class="annottext">d :: b
</span><a href="#local-6989586621684361166"><span class="hs-identifier hs-var hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(b -&gt; b -&gt; b) -&gt; b -&gt; t b -&gt; b
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span> </span><span class="annot"><span class="annottext">b -&gt; b -&gt; b
forall {a}. (Num a, Eq a) =&gt; a -&gt; b -&gt; a
</span><a href="#local-6989586621684361175"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">t b
</span><a href="#local-6989586621684361194"><span class="hs-identifier hs-var">inds</span></a></span><span>
</span><span id="line-403"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684361187"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; b -&gt; b
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684361166"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">b
</span><a href="#local-6989586621684361166"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">b -&gt; b -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">b
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-404"></span><span>
</span><span id="line-405"></span><span>    </span><span id="local-6989586621684362189"><span class="annot"><a href="#local-6989586621684361165"><span class="hs-identifier hs-type">harmlessRotation'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-406"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362189"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362189"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-407"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362189"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-408"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimIndex"><span class="hs-identifier hs-type">DimIndex</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362189"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-409"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-410"></span><span>    </span><span id="local-6989586621684361165"><span class="annot"><span class="annottext">harmlessRotation' :: forall num.
(Eq num, IntegralExp num) =&gt;
LMADDim num -&gt; DimIndex num -&gt; Bool
</span><a href="#local-6989586621684361165"><span class="hs-identifier hs-var hs-var">harmlessRotation'</span></a></span></span><span> </span><span class="annot"><span class="annottext">LMADDim num
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-411"></span><span>    </span><span class="annot"><a href="#local-6989586621684361165"><span class="hs-identifier hs-var">harmlessRotation'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DimIndex num
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-412"></span><span>    </span><span class="annot"><a href="#local-6989586621684361165"><span class="hs-identifier hs-var">harmlessRotation'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">DimIndex num
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-413"></span><span>    </span><span class="annot"><a href="#local-6989586621684361165"><span class="hs-identifier hs-var">harmlessRotation'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684361147"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361147"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684361146"><span class="annot"><span class="annottext">DimIndex num
</span><a href="#local-6989586621684361146"><span class="hs-identifier hs-var">dslc</span></a></span></span><span>
</span><span id="line-414"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DimIndex num
</span><a href="#local-6989586621684361146"><span class="hs-identifier hs-var">dslc</span></a></span><span> </span><span class="annot"><span class="annottext">DimIndex num -&gt; DimIndex num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num -&gt; DimIndex num
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361147"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361147"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-415"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">DimIndex num
</span><a href="#local-6989586621684361146"><span class="hs-identifier hs-var">dslc</span></a></span><span> </span><span class="annot"><span class="annottext">DimIndex num -&gt; DimIndex num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; DimIndex num
forall d. Num d =&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#unitSlice"><span class="hs-identifier hs-var">unitSlice</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361147"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-416"></span><span>        </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-417"></span><span>    </span><span class="annot"><a href="#local-6989586621684361165"><span class="hs-identifier hs-var">harmlessRotation'</span></a></span><span> </span><span class="annot"><span class="annottext">LMADDim num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">DimIndex num
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-418"></span><span>
</span><span id="line-419"></span><span>    </span><span id="local-6989586621684361143"><span class="annot"><a href="#local-6989586621684361222"><span class="hs-identifier hs-type">harmlessRotation</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-420"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684361143"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684361143"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-421"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684361143"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-422"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684361143"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-423"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-424"></span><span>    </span><span id="local-6989586621684361222"><span class="annot"><span class="annottext">harmlessRotation :: forall num.
(Eq num, IntegralExp num) =&gt;
LMAD num -&gt; Slice num -&gt; Bool
</span><a href="#local-6989586621684361222"><span class="hs-identifier hs-var hs-var">harmlessRotation</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684361137"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361137"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span id="local-6989586621684361136"><span class="annot"><span class="annottext">[DimIndex num]
</span><a href="#local-6989586621684361136"><span class="hs-identifier hs-var">iss</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-425"></span><span>      </span><span class="annot"><span class="annottext">[Bool] -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><span class="hs-identifier hs-var">and</span></span><span> </span><span class="annot"><span class="annottext">([Bool] -&gt; Bool) -&gt; [Bool] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; DimIndex num -&gt; Bool)
-&gt; [LMADDim num] -&gt; [DimIndex num] -&gt; [Bool]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; DimIndex num -&gt; Bool
forall num.
(Eq num, IntegralExp num) =&gt;
LMADDim num -&gt; DimIndex num -&gt; Bool
</span><a href="#local-6989586621684361165"><span class="hs-identifier hs-var">harmlessRotation'</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361137"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex num]
</span><a href="#local-6989586621684361136"><span class="hs-identifier hs-var">iss</span></a></span><span>
</span><span id="line-426"></span><span>
</span><span id="line-427"></span><span>    </span><span class="hs-comment">-- XXX: TODO: what happens to r on a negative-stride slice; is there</span><span>
</span><span id="line-428"></span><span>    </span><span class="hs-comment">-- such a case?</span><span>
</span><span id="line-429"></span><span>    </span><span id="local-6989586621684362205"><span class="annot"><a href="#local-6989586621684361216"><span class="hs-identifier hs-type">sliceOne</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-430"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362205"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362205"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-431"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362205"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-432"></span><span>      </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimIndex"><span class="hs-identifier hs-type">DimIndex</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362205"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362205"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-433"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362205"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-434"></span><span>    </span><span id="local-6989586621684361216"><span class="annot"><span class="annottext">sliceOne :: forall num.
(Eq num, IntegralExp num) =&gt;
LMAD num -&gt; (DimIndex num, LMADDim num) -&gt; LMAD num
</span><a href="#local-6989586621684361216"><span class="hs-identifier hs-var hs-var">sliceOne</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684361098"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361098"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621684361097"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361097"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span id="local-6989586621684361096"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361096"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span id="local-6989586621684361095"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361095"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684361094"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361094"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684361093"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361093"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-435"></span><span>      </span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361098"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">(num, num, num) -&gt; num -&gt; num
forall num.
(Eq num, IntegralExp num) =&gt;
(num, num, num) -&gt; num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#flatOneDim"><span class="hs-identifier hs-var">flatOneDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361095"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361094"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361093"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361096"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361097"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-436"></span><span>    </span><span class="annot"><a href="#local-6989586621684361216"><span class="hs-identifier hs-var">sliceOne</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684361092"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361092"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621684361091"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361091"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-type">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684361090"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361090"><span class="hs-identifier hs-var">ne</span></a></span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684361089"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361089"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-437"></span><span>      </span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361092"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361091"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361090"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361089"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>    </span><span class="annot"><a href="#local-6989586621684361216"><span class="hs-identifier hs-var">sliceOne</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684361088"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361088"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621684361087"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361087"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361086"><span class="annot"><span class="annottext">DimIndex num
</span><a href="#local-6989586621684361086"><span class="hs-identifier hs-var">dmind</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684361085"><span class="annot"><span class="annottext">dim :: LMADDim num
</span><a href="#local-6989586621684361085"><span class="hs-identifier hs-var">dim</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684361084"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361084"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DimIndex num
</span><a href="#local-6989586621684361086"><span class="hs-identifier hs-var">dmind</span></a></span><span> </span><span class="annot"><span class="annottext">DimIndex num -&gt; DimIndex num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; DimIndex num
forall d. Num d =&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#unitSlice"><span class="hs-identifier hs-var">unitSlice</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361084"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361088"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361087"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">LMADDim num
</span><a href="#local-6989586621684361085"><span class="hs-identifier hs-var">dim</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-440"></span><span>    </span><span class="annot"><a href="#local-6989586621684361216"><span class="hs-identifier hs-var">sliceOne</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684361083"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361083"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621684361082"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361082"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361081"><span class="annot"><span class="annottext">DimIndex num
</span><a href="#local-6989586621684361081"><span class="hs-identifier hs-var">dmind</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span id="local-6989586621684361080"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361080"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684361079"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361079"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684361078"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361078"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684361077"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361077"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684361076"><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684361076"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">DimIndex num
</span><a href="#local-6989586621684361081"><span class="hs-identifier hs-var">dmind</span></a></span><span> </span><span class="annot"><span class="annottext">DimIndex num -&gt; DimIndex num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num -&gt; DimIndex num
forall d. d -&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361078"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361078"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-442"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684361071"><span class="annot"><span class="annottext">r' :: num
</span><a href="#local-6989586621684361071"><span class="hs-identifier hs-var hs-var">r'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361079"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361078"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361079"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-443"></span><span>            </span><span id="local-6989586621684361064"><span class="annot"><span class="annottext">off' :: num
</span><a href="#local-6989586621684361064"><span class="hs-identifier hs-var hs-var">off'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361083"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">(num, num, num) -&gt; num -&gt; num
forall num.
(Eq num, IntegralExp num) =&gt;
(num, num, num) -&gt; num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#flatOneDim"><span class="hs-identifier hs-var">flatOneDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361080"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361078"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361078"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-444"></span><span>         </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361064"><span class="hs-identifier hs-var">off'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361082"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361080"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361071"><span class="hs-identifier hs-var">r'</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361078"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361077"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Monotonicity -&gt; Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#invertMonotonicity"><span class="hs-identifier hs-var">invertMonotonicity</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684361076"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span>    </span><span class="annot"><a href="#local-6989586621684361216"><span class="hs-identifier hs-var">sliceOne</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684361063"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361063"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621684361062"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361062"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-type">DimSlice</span></a></span><span> </span><span id="local-6989586621684361061"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361061"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span id="local-6989586621684361060"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361060"><span class="hs-identifier hs-var">ne</span></a></span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span id="local-6989586621684361059"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361059"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684361058"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361058"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684361057"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361057"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684361056"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361056"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-446"></span><span>      </span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361063"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">(num, num, num) -&gt; num -&gt; num
forall num.
(Eq num, IntegralExp num) =&gt;
(num, num, num) -&gt; num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#flatOneDim"><span class="hs-identifier hs-var">flatOneDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361059"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361058"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361057"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361061"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361062"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361060"><span class="hs-identifier hs-var">ne</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361056"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span>    </span><span class="annot"><a href="#local-6989586621684361216"><span class="hs-identifier hs-var">sliceOne</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684361055"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361055"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621684361054"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361054"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-type">DimSlice</span></a></span><span> </span><span id="local-6989586621684361053"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361053"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span id="local-6989586621684361052"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361052"><span class="hs-identifier hs-var">ns</span></a></span></span><span> </span><span id="local-6989586621684361051"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361051"><span class="hs-identifier hs-var">ss</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span id="local-6989586621684361050"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361050"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684361049"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361049"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684361048"><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684361048"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-448"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684361041"><span class="annot"><span class="annottext">m' :: Monotonicity
</span><a href="#local-6989586621684361041"><span class="hs-identifier hs-var hs-var">m'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">num -&gt; Maybe Int
forall e. IntegralExp e =&gt; e -&gt; Maybe Int
</span><a href="Futhark.Util.IntegralExp.html#sgn"><span class="hs-identifier hs-var">sgn</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361051"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-449"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684361048"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-450"></span><span>            </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Monotonicity -&gt; Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#invertMonotonicity"><span class="hs-identifier hs-var">invertMonotonicity</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684361048"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-451"></span><span>            </span><span class="annot"><span class="annottext">Maybe Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>
</span><span id="line-452"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361055"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361050"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361053"><span class="hs-identifier hs-var">bs</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361054"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361051"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361050"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361052"><span class="hs-identifier hs-var">ns</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684361049"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684361041"><span class="hs-identifier hs-var">m'</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-453"></span><span>    </span><span class="annot"><a href="#local-6989586621684361216"><span class="hs-identifier hs-var">sliceOne</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">(DimIndex num, LMADDim num)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; LMAD num
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;slice: reached impossible case&quot;</span></span><span>
</span><span id="line-454"></span><span>
</span><span id="line-455"></span><span>    </span><span id="local-6989586621684362208"><span class="annot"><a href="#local-6989586621684361223"><span class="hs-identifier hs-type">slicePreservesContiguous</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-456"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362208"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362208"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-457"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362208"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-458"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362208"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-459"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-460"></span><span>    </span><span id="local-6989586621684361223"><span class="annot"><span class="annottext">slicePreservesContiguous :: forall num.
(Eq num, IntegralExp num) =&gt;
LMAD num -&gt; Slice num -&gt; Bool
</span><a href="#local-6989586621684361223"><span class="hs-identifier hs-var hs-var">slicePreservesContiguous</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684361035"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361035"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span id="local-6989586621684361034"><span class="annot"><span class="annottext">[DimIndex num]
</span><a href="#local-6989586621684361034"><span class="hs-identifier hs-var">slc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-461"></span><span>      </span><span class="hs-comment">-- remove from the slice the LMAD dimensions that have stride 0.</span><span>
</span><span id="line-462"></span><span>      </span><span class="hs-comment">-- If the LMAD was contiguous in mem, then these dims will not</span><span>
</span><span id="line-463"></span><span>      </span><span class="hs-comment">-- influence the contiguousness of the result.</span><span>
</span><span id="line-464"></span><span>      </span><span class="hs-comment">-- Also normalize the input slice, i.e., 0-stride and size-1</span><span>
</span><span id="line-465"></span><span>      </span><span class="hs-comment">-- slices are rewritten as DimFixed.</span><span>
</span><span id="line-466"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361027"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361027"><span class="hs-identifier hs-var">dims'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684361026"><span class="annot"><span class="annottext">[DimIndex num]
</span><a href="#local-6989586621684361026"><span class="hs-identifier hs-var">slc'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-467"></span><span>            </span><span class="annot"><span class="annottext">[(LMADDim num, DimIndex num)] -&gt; ([LMADDim num], [DimIndex num])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(LMADDim num, DimIndex num)] -&gt; ([LMADDim num], [DimIndex num]))
-&gt; [(LMADDim num, DimIndex num)] -&gt; ([LMADDim num], [DimIndex num])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-468"></span><span>              </span><span class="annot"><span class="annottext">((LMADDim num, DimIndex num) -&gt; Bool)
-&gt; [(LMADDim num, DimIndex num)] -&gt; [(LMADDim num, DimIndex num)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(num -&gt; Bool)
-&gt; ((LMADDim num, DimIndex num) -&gt; num)
-&gt; (LMADDim num, DimIndex num)
-&gt; Bool
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; num
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldStride"><span class="hs-identifier hs-var hs-var">ldStride</span></a></span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; num)
-&gt; ((LMADDim num, DimIndex num) -&gt; LMADDim num)
-&gt; (LMADDim num, DimIndex num)
-&gt; num
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim num, DimIndex num) -&gt; LMADDim num
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(LMADDim num, DimIndex num)] -&gt; [(LMADDim num, DimIndex num)])
-&gt; [(LMADDim num, DimIndex num)] -&gt; [(LMADDim num, DimIndex num)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-469"></span><span>                </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; [DimIndex num] -&gt; [(LMADDim num, DimIndex num)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361035"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">([DimIndex num] -&gt; [(LMADDim num, DimIndex num)])
-&gt; [DimIndex num] -&gt; [(LMADDim num, DimIndex num)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DimIndex num -&gt; DimIndex num) -&gt; [DimIndex num] -&gt; [DimIndex num]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">DimIndex num -&gt; DimIndex num
forall num.
(Eq num, IntegralExp num) =&gt;
DimIndex num -&gt; DimIndex num
</span><a href="#local-6989586621684361024"><span class="hs-identifier hs-var">normIndex</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex num]
</span><a href="#local-6989586621684361034"><span class="hs-identifier hs-var">slc</span></a></span><span>
</span><span id="line-470"></span><span>          </span><span class="hs-comment">-- Check that:</span><span>
</span><span id="line-471"></span><span>          </span><span class="hs-comment">-- 1. a clean split point exists between Fixed and Sliced dims</span><span>
</span><span id="line-472"></span><span>          </span><span class="hs-comment">-- 2. the outermost sliced dim has +/- 1 stride AND is unrotated or full.</span><span>
</span><span id="line-473"></span><span>          </span><span class="hs-comment">-- 3. the rest of inner sliced dims are full.</span><span>
</span><span id="line-474"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684361022"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361022"><span class="hs-identifier hs-var">success</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-475"></span><span>            </span><span class="annot"><span class="annottext">((Bool, Bool) -&gt; (DimIndex num, LMADDim num) -&gt; (Bool, Bool))
-&gt; (Bool, Bool) -&gt; [(DimIndex num, LMADDim num)] -&gt; (Bool, Bool)
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span>
</span><span id="line-476"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684361021"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361021"><span class="hs-identifier hs-var">found</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684361020"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361020"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684361019"><span class="annot"><span class="annottext">DimIndex num
</span><a href="#local-6989586621684361019"><span class="hs-identifier hs-var">slcdim</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684361018"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361018"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621684361017"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361017"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-477"></span><span>                  </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">DimIndex num
</span><a href="#local-6989586621684361019"><span class="hs-identifier hs-var">slcdim</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361021"><span class="hs-identifier hs-var">found</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-478"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361021"><span class="hs-identifier hs-var">found</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span>
</span><span id="line-479"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361021"><span class="hs-identifier hs-var">found</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361020"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-type">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684361016"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361016"><span class="hs-identifier hs-var">ne</span></a></span></span><span> </span><span id="local-6989586621684361015"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361015"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-481"></span><span>                      </span><span class="hs-comment">-- outermost sliced dim: +/-1 stride</span><span>
</span><span id="line-482"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684361006"><span class="annot"><span class="annottext">res' :: Bool
</span><a href="#local-6989586621684361006"><span class="hs-identifier hs-var hs-var">res'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361018"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361017"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361016"><span class="hs-identifier hs-var">ne</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361015"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361015"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-483"></span><span>                       </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361020"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361006"><span class="hs-identifier hs-var">res'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-type">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684361005"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361005"><span class="hs-identifier hs-var">ne</span></a></span></span><span> </span><span id="local-6989586621684361004"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361004"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-485"></span><span>                      </span><span class="hs-comment">-- inner sliced dim: needs to be full</span><span>
</span><span id="line-486"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360997"><span class="annot"><span class="annottext">res' :: Bool
</span><a href="#local-6989586621684360997"><span class="hs-identifier hs-var hs-var">res'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361017"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361005"><span class="hs-identifier hs-var">ne</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361004"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684361004"><span class="hs-identifier hs-var">ds</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-487"></span><span>                       </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361021"><span class="hs-identifier hs-var">found</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361020"><span class="hs-identifier hs-var">res</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360997"><span class="hs-identifier hs-var">res'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-488"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-489"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-490"></span><span>              </span><span class="annot"><span class="annottext">([(DimIndex num, LMADDim num)] -&gt; (Bool, Bool))
-&gt; [(DimIndex num, LMADDim num)] -&gt; (Bool, Bool)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex num] -&gt; [LMADDim num] -&gt; [(DimIndex num, LMADDim num)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[DimIndex num]
</span><a href="#local-6989586621684361026"><span class="hs-identifier hs-var">slc'</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684361027"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-491"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684361022"><span class="hs-identifier hs-var">success</span></a></span><span>
</span><span id="line-492"></span><span>
</span><span id="line-493"></span><span>    </span><span id="local-6989586621684362176"><span class="annot"><a href="#local-6989586621684361024"><span class="hs-identifier hs-type">normIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-494"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362176"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362176"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-495"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimIndex"><span class="hs-identifier hs-type">DimIndex</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362176"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-496"></span><span>      </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimIndex"><span class="hs-identifier hs-type">DimIndex</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362176"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-497"></span><span>    </span><span id="local-6989586621684361024"><span class="annot"><span class="annottext">normIndex :: forall num.
(Eq num, IntegralExp num) =&gt;
DimIndex num -&gt; DimIndex num
</span><a href="#local-6989586621684361024"><span class="hs-identifier hs-var hs-var">normIndex</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-type">DimSlice</span></a></span><span> </span><span id="local-6989586621684360989"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360989"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num -&gt; DimIndex num
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360989"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-498"></span><span>    </span><span class="annot"><a href="#local-6989586621684361024"><span class="hs-identifier hs-var">normIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#DimSlice"><span class="hs-identifier hs-type">DimSlice</span></a></span><span> </span><span id="local-6989586621684360988"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360988"><span class="hs-identifier hs-var">b</span></a></span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num -&gt; DimIndex num
forall d. d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360988"><span class="hs-identifier hs-var">b</span></a></span><span>
</span><span id="line-499"></span><span>    </span><span class="annot"><a href="#local-6989586621684361024"><span class="hs-identifier hs-var">normIndex</span></a></span><span> </span><span id="local-6989586621684360987"><span class="annot"><span class="annottext">DimIndex num
</span><a href="#local-6989586621684360987"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimIndex num
</span><a href="#local-6989586621684360987"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-500"></span><span>
</span><span id="line-501"></span><span class="hs-comment">-- | Slice an index function.</span><span>
</span><span id="line-502"></span><span id="local-6989586621684362174"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#slice"><span class="hs-identifier hs-type">slice</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-503"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362174"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362174"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-504"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362174"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-505"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Slice"><span class="hs-identifier hs-type">Slice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362174"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-506"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362174"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-507"></span><span id="slice"><span class="annot"><span class="annottext">slice :: forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; Slice num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#slice"><span class="hs-identifier hs-var hs-var">slice</span></a></span></span><span> </span><span id="local-6989586621684360968"><span class="annot"><span class="annottext">ixfun :: IxFun num
</span><a href="#local-6989586621684360968"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360967"><span class="annot"><span class="annottext">lmad :: LMAD num
</span><a href="#local-6989586621684360967"><span class="hs-identifier hs-var">lmad</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684360966"><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360966"><span class="hs-identifier hs-var">lmads</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360965"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360965"><span class="hs-identifier hs-var">oshp</span></a></span></span><span> </span><span id="local-6989586621684360964"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360964"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360963"><span class="annot"><span class="annottext">Slice num
</span><a href="#local-6989586621684360963"><span class="hs-identifier hs-var">dim_slices</span></a></span></span><span>
</span><span id="line-508"></span><span>  </span><span class="hs-comment">-- Avoid identity slicing.</span><span>
</span><span id="line-509"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Slice num -&gt; [DimIndex num]
forall d. Slice d -&gt; [DimIndex d]
</span><a href="Futhark.IR.Syntax.Core.html#unSlice"><span class="hs-identifier hs-var hs-var">unSlice</span></a></span><span> </span><span class="annot"><span class="annottext">Slice num
</span><a href="#local-6989586621684360963"><span class="hs-identifier hs-var">dim_slices</span></a></span><span> </span><span class="annot"><span class="annottext">[DimIndex num] -&gt; [DimIndex num] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">(num -&gt; DimIndex num) -&gt; Shape num -&gt; [DimIndex num]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num -&gt; num -&gt; DimIndex num
forall d. Num d =&gt; d -&gt; d -&gt; DimIndex d
</span><a href="Futhark.IR.Syntax.Core.html#unitSlice"><span class="hs-identifier hs-var">unitSlice</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun num -&gt; Shape num
forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#shape"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360968"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360968"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-510"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684360961"><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360961"><span class="hs-identifier hs-var">ixfun'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; Slice num -&gt; Maybe (IxFun num)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; Slice num -&gt; Maybe (IxFun num)
</span><a href="Futhark.IR.Mem.IxFun.html#sliceOneLMAD"><span class="hs-identifier hs-var">sliceOneLMAD</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360968"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">Slice num
</span><a href="#local-6989586621684360963"><span class="hs-identifier hs-var">dim_slices</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360961"><span class="hs-identifier hs-var">ixfun'</span></a></span><span>
</span><span id="line-511"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-512"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; Slice num -&gt; Maybe (IxFun num)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; Slice num -&gt; Maybe (IxFun num)
</span><a href="Futhark.IR.Mem.IxFun.html#sliceOneLMAD"><span class="hs-identifier hs-var">sliceOneLMAD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Shape num -&gt; IxFun num
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">iota</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num -&gt; Shape num
forall num. (Eq num, IntegralExp num) =&gt; LMAD num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadShape"><span class="hs-identifier hs-var">lmadShape</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360967"><span class="hs-identifier hs-var">lmad</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Slice num
</span><a href="#local-6989586621684360963"><span class="hs-identifier hs-var">dim_slices</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-513"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360960"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360960"><span class="hs-identifier hs-var">lmad'</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684360959"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360959"><span class="hs-identifier hs-var">cg'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-514"></span><span>        </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360960"><span class="hs-identifier hs-var">lmad'</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; NonEmpty (LMAD num)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360967"><span class="hs-identifier hs-var">lmad</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; [LMAD num]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360966"><span class="hs-identifier hs-var">lmads</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360965"><span class="hs-identifier hs-var">oshp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360964"><span class="hs-identifier hs-var">cg</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360959"><span class="hs-identifier hs-var">cg'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-515"></span><span>      </span><span class="annot"><span class="annottext">Maybe (IxFun num)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IxFun num
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;slice: reached impossible case&quot;</span></span><span>
</span><span id="line-516"></span><span>
</span><span id="line-517"></span><span class="hs-comment">-- | Flat-slice an index function.</span><span>
</span><span id="line-518"></span><span id="local-6989586621684362172"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#flatSlice"><span class="hs-identifier hs-type">flatSlice</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-519"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362172"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362172"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-520"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362172"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-521"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#FlatSlice"><span class="hs-identifier hs-type">FlatSlice</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362172"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-522"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362172"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-523"></span><span id="flatSlice"><span class="annot"><span class="annottext">flatSlice :: forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; FlatSlice num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#flatSlice"><span class="hs-identifier hs-var hs-var">flatSlice</span></a></span></span><span> </span><span id="local-6989586621684360950"><span class="annot"><span class="annottext">ixfun :: IxFun num
</span><a href="#local-6989586621684360950"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684360949"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360949"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360948"><span class="annot"><span class="annottext">LMADDim num
</span><a href="#local-6989586621684360948"><span class="hs-identifier hs-var">dim</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684360947"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360947"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684360946"><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360946"><span class="hs-identifier hs-var">lmads</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360945"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360945"><span class="hs-identifier hs-var">oshp</span></a></span></span><span> </span><span id="local-6989586621684360944"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360944"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#FlatSlice"><span class="hs-identifier hs-type">FlatSlice</span></a></span><span> </span><span id="local-6989586621684360942"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360942"><span class="hs-identifier hs-var">new_offset</span></a></span></span><span> </span><span id="local-6989586621684360941"><span class="annot"><span class="annottext">[FlatDimIndex num]
</span><a href="#local-6989586621684360941"><span class="hs-identifier hs-var">is</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-524"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; Bool
forall num. IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#hasContiguousPerm"><span class="hs-identifier hs-var">hasContiguousPerm</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360950"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-525"></span><span>    </span><span class="annot"><span class="annottext">LMADDim num -&gt; num
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldRotate"><span class="hs-identifier hs-var hs-var">ldRotate</span></a></span><span> </span><span class="annot"><span class="annottext">LMADDim num
</span><a href="#local-6989586621684360948"><span class="hs-identifier hs-var">dim</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-526"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360934"><span class="annot"><span class="annottext">lmad :: LMAD num
</span><a href="#local-6989586621684360934"><span class="hs-identifier hs-var hs-var">lmad</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-527"></span><span>          </span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span>
</span><span id="line-528"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360949"><span class="hs-identifier hs-var">offset</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360942"><span class="hs-identifier hs-var">new_offset</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; num
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldStride"><span class="hs-identifier hs-var hs-var">ldStride</span></a></span><span> </span><span class="annot"><span class="annottext">LMADDim num
</span><a href="#local-6989586621684360948"><span class="hs-identifier hs-var">dim</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-529"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(FlatDimIndex num -&gt; LMADDim num)
-&gt; [FlatDimIndex num] -&gt; [LMADDim num]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num -&gt; FlatDimIndex num -&gt; LMADDim num
forall {num}.
(Eq num, Num num) =&gt;
num -&gt; FlatDimIndex num -&gt; LMADDim num
</span><a href="#local-6989586621684360933"><span class="hs-identifier hs-var">helper</span></a></span><span> </span><span class="annot"><span class="annottext">(num -&gt; FlatDimIndex num -&gt; LMADDim num)
-&gt; num -&gt; FlatDimIndex num -&gt; LMADDim num
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; num
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldStride"><span class="hs-identifier hs-var hs-var">ldStride</span></a></span><span> </span><span class="annot"><span class="annottext">LMADDim num
</span><a href="#local-6989586621684360948"><span class="hs-identifier hs-var">dim</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[FlatDimIndex num]
</span><a href="#local-6989586621684360941"><span class="hs-identifier hs-var">is</span></a></span><span>
</span><span id="line-530"></span><span>                </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360947"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-531"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-532"></span><span>            </span><span class="annot"><span class="annottext">LMAD num -&gt; (LMAD num -&gt; LMAD num) -&gt; LMAD num
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><span class="hs-operator hs-var">&amp;</span></span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; LMAD num -&gt; LMAD num
forall num. Permutation -&gt; LMAD num -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#setLMADPermutation"><span class="hs-identifier hs-var">setLMADPermutation</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-533"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360934"><span class="hs-identifier hs-var">lmad</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; NonEmpty (LMAD num)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360946"><span class="hs-identifier hs-var">lmads</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360945"><span class="hs-identifier hs-var">oshp</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360944"><span class="hs-identifier hs-var">cg</span></a></span><span>
</span><span id="line-534"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-535"></span><span>    </span><span id="local-6989586621684360933"><span class="annot"><span class="annottext">helper :: num -&gt; FlatDimIndex num -&gt; LMADDim num
</span><a href="#local-6989586621684360933"><span class="hs-identifier hs-var hs-var">helper</span></a></span></span><span> </span><span id="local-6989586621684360928"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360928"><span class="hs-identifier hs-var">s0</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#FlatDimIndex"><span class="hs-identifier hs-type">FlatDimIndex</span></a></span><span> </span><span id="local-6989586621684360926"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360926"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span id="local-6989586621684360925"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360925"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-536"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360921"><span class="annot"><span class="annottext">new_mon :: Monotonicity
</span><a href="#local-6989586621684360921"><span class="hs-identifier hs-var hs-var">new_mon</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360928"><span class="hs-identifier hs-var">s0</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360925"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>
</span><span id="line-537"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360928"><span class="hs-identifier hs-var">s0</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360925"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360926"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360921"><span class="hs-identifier hs-var">new_mon</span></a></span><span>
</span><span id="line-538"></span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#flatSlice"><span class="hs-identifier hs-var">flatSlice</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360920"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360920"><span class="hs-identifier hs-var">lmad</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684360919"><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360919"><span class="hs-identifier hs-var">lmads</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360918"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360918"><span class="hs-identifier hs-var">oshp</span></a></span></span><span> </span><span id="local-6989586621684360917"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360917"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360916"><span class="annot"><span class="annottext">s :: FlatSlice num
</span><a href="#local-6989586621684360916"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#FlatSlice"><span class="hs-identifier hs-type">FlatSlice</span></a></span><span> </span><span id="local-6989586621684360915"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360915"><span class="hs-identifier hs-var">new_offset</span></a></span></span><span> </span><span class="annot"><span class="annottext">[FlatDimIndex num]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-539"></span><span>  </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360915"><span class="hs-identifier hs-var">new_offset</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360914"><span class="hs-identifier hs-var">base_stride</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360913"><span class="hs-identifier hs-var">new_dims</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360912"><span class="hs-identifier hs-var">tail_dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; NonEmpty (LMAD num)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360920"><span class="hs-identifier hs-var">lmad</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; [LMAD num]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360919"><span class="hs-identifier hs-var">lmads</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360918"><span class="hs-identifier hs-var">oshp</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360917"><span class="hs-identifier hs-var">cg</span></a></span><span>
</span><span id="line-540"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-541"></span><span>    </span><span id="local-6989586621684360909"><span class="annot"><span class="annottext">tail_shapes :: Shape num
</span><a href="#local-6989586621684360909"><span class="hs-identifier hs-var hs-var">tail_shapes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Shape num -&gt; Shape num
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">tail</span></span><span> </span><span class="annot"><span class="annottext">(Shape num -&gt; Shape num) -&gt; Shape num -&gt; Shape num
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Shape num
forall num. (Eq num, IntegralExp num) =&gt; LMAD num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadShape"><span class="hs-identifier hs-var">lmadShape</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360920"><span class="hs-identifier hs-var">lmad</span></a></span><span>
</span><span id="line-542"></span><span>    </span><span id="local-6989586621684360914"><span class="annot"><span class="annottext">base_stride :: num
</span><a href="#local-6989586621684360914"><span class="hs-identifier hs-var hs-var">base_stride</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Shape num -&gt; num
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">product</span></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360909"><span class="hs-identifier hs-var">tail_shapes</span></a></span><span>
</span><span id="line-543"></span><span>    </span><span id="local-6989586621684360903"><span class="annot"><span class="annottext">tail_strides :: Shape num
</span><a href="#local-6989586621684360903"><span class="hs-identifier hs-var hs-var">tail_strides</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Shape num -&gt; Shape num
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">tail</span></span><span> </span><span class="annot"><span class="annottext">(Shape num -&gt; Shape num) -&gt; Shape num -&gt; Shape num
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(num -&gt; num -&gt; num) -&gt; num -&gt; Shape num -&gt; Shape num
forall a b. (a -&gt; b -&gt; b) -&gt; b -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">scanr</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(*)</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360909"><span class="hs-identifier hs-var">tail_shapes</span></a></span><span>
</span><span id="line-544"></span><span>    </span><span id="local-6989586621684360912"><span class="annot"><span class="annottext">tail_dims :: [LMADDim num]
</span><a href="#local-6989586621684360912"><span class="hs-identifier hs-var hs-var">tail_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num)
-&gt; Shape num
-&gt; Shape num
-&gt; Shape num
-&gt; Permutation
-&gt; [Monotonicity]
-&gt; [LMADDim num]
forall a b c d e f.
(a -&gt; b -&gt; c -&gt; d -&gt; e -&gt; f)
-&gt; [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [e] -&gt; [f]
</span><span class="hs-identifier hs-var">zipWith5</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360903"><span class="hs-identifier hs-var">tail_strides</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num -&gt; Shape num
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360909"><span class="hs-identifier hs-var">tail_shapes</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Shape num -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360897"><span class="hs-identifier hs-var">new_shapes</span></a></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Monotonicity -&gt; [Monotonicity]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-545"></span><span>    </span><span id="local-6989586621684360897"><span class="annot"><span class="annottext">new_shapes :: Shape num
</span><a href="#local-6989586621684360897"><span class="hs-identifier hs-var hs-var">new_shapes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">FlatSlice num -&gt; Shape num
forall d. FlatSlice d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#flatSliceDims"><span class="hs-identifier hs-var">flatSliceDims</span></a></span><span> </span><span class="annot"><span class="annottext">FlatSlice num
</span><a href="#local-6989586621684360916"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-546"></span><span>    </span><span id="local-6989586621684360895"><span class="annot"><span class="annottext">new_strides :: Shape num
</span><a href="#local-6989586621684360895"><span class="hs-identifier hs-var hs-var">new_strides</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(num -&gt; num) -&gt; Shape num -&gt; Shape num
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360914"><span class="hs-identifier hs-var">base_stride</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Shape num -&gt; Shape num) -&gt; Shape num -&gt; Shape num
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">FlatSlice num -&gt; Shape num
forall d. FlatSlice d -&gt; [d]
</span><a href="Futhark.IR.Syntax.Core.html#flatSliceStrides"><span class="hs-identifier hs-var">flatSliceStrides</span></a></span><span> </span><span class="annot"><span class="annottext">FlatSlice num
</span><a href="#local-6989586621684360916"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-547"></span><span>    </span><span id="local-6989586621684360913"><span class="annot"><span class="annottext">new_dims :: [LMADDim num]
</span><a href="#local-6989586621684360913"><span class="hs-identifier hs-var hs-var">new_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num)
-&gt; Shape num
-&gt; Shape num
-&gt; Shape num
-&gt; Permutation
-&gt; [Monotonicity]
-&gt; [LMADDim num]
forall a b c d e f.
(a -&gt; b -&gt; c -&gt; d -&gt; e -&gt; f)
-&gt; [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [e] -&gt; [f]
</span><span class="hs-identifier hs-var">zipWith5</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360895"><span class="hs-identifier hs-var">new_strides</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num -&gt; Shape num
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360897"><span class="hs-identifier hs-var">new_shapes</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Monotonicity -&gt; [Monotonicity]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>
</span><span id="line-549"></span><span class="hs-comment">-- | Handle the simple case where all reshape dimensions are coercions.</span><span>
</span><span id="line-550"></span><span id="local-6989586621684362154"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#reshapeCoercion"><span class="hs-identifier hs-type">reshapeCoercion</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-551"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362154"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362154"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-552"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362154"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-553"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#ShapeChange"><span class="hs-identifier hs-type">ShapeChange</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362154"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-554"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362154"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-555"></span><span id="reshapeCoercion"><span class="annot"><span class="annottext">reshapeCoercion :: forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; ShapeChange num -&gt; Maybe (IxFun num)
</span><a href="Futhark.IR.Mem.IxFun.html#reshapeCoercion"><span class="hs-identifier hs-var hs-var">reshapeCoercion</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360875"><span class="annot"><span class="annottext">lmad :: LMAD num
</span><a href="#local-6989586621684360875"><span class="hs-identifier hs-var">lmad</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684360874"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360874"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621684360873"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360873"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684360872"><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360872"><span class="hs-identifier hs-var">lmads</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360871"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360871"><span class="hs-identifier hs-var">oldbase</span></a></span></span><span> </span><span id="local-6989586621684360870"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360870"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360869"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360869"><span class="hs-identifier hs-var">newshape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-556"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360868"><span class="annot"><span class="annottext">perm :: Permutation
</span><a href="#local-6989586621684360868"><span class="hs-identifier hs-var hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Permutation
forall num. LMAD num -&gt; Permutation
</span><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-var">lmadPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360875"><span class="hs-identifier hs-var">lmad</span></a></span><span>
</span><span id="line-557"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684360867"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360867"><span class="hs-identifier hs-var">head_coercions</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360866"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360866"><span class="hs-identifier hs-var">reshapes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360865"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360865"><span class="hs-identifier hs-var">tail_coercions</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ShapeChange num
-&gt; Maybe (ShapeChange num, ShapeChange num, ShapeChange num)
forall num.
(Eq num, IntegralExp num) =&gt;
ShapeChange num
-&gt; Maybe (ShapeChange num, ShapeChange num, ShapeChange num)
</span><a href="Futhark.IR.Mem.IxFun.html#splitCoercions"><span class="hs-identifier hs-var">splitCoercions</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360869"><span class="hs-identifier hs-var">newshape</span></a></span><span>
</span><span id="line-558"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360862"><span class="annot"><span class="annottext">hd_len :: Int
</span><a href="#local-6989586621684360862"><span class="hs-identifier hs-var hs-var">hd_len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ShapeChange num -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360867"><span class="hs-identifier hs-var">head_coercions</span></a></span><span>
</span><span id="line-559"></span><span>      </span><span id="local-6989586621684360859"><span class="annot"><span class="annottext">num_coercions :: Int
</span><a href="#local-6989586621684360859"><span class="hs-identifier hs-var hs-var">num_coercions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360862"><span class="hs-identifier hs-var">hd_len</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange num -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360865"><span class="hs-identifier hs-var">tail_coercions</span></a></span><span>
</span><span id="line-560"></span><span>      </span><span id="local-6989586621684360858"><span class="annot"><span class="annottext">dims' :: [LMADDim num]
</span><a href="#local-6989586621684360858"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. Permutation -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Mem.IxFun.html#permuteFwd"><span class="hs-identifier hs-var">permuteFwd</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360868"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360873"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-561"></span><span>      </span><span id="local-6989586621684360855"><span class="annot"><span class="annottext">mid_dims :: [LMADDim num]
</span><a href="#local-6989586621684360855"><span class="hs-identifier hs-var hs-var">mid_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360873"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360859"><span class="hs-identifier hs-var">num_coercions</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([LMADDim num] -&gt; [LMADDim num]) -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360862"><span class="hs-identifier hs-var">hd_len</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360858"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-562"></span><span>      </span><span id="local-6989586621684360851"><span class="annot"><span class="annottext">num_rshps :: Int
</span><a href="#local-6989586621684360851"><span class="hs-identifier hs-var hs-var">num_rshps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ShapeChange num -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360866"><span class="hs-identifier hs-var">reshapes</span></a></span><span>
</span><span id="line-563"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360851"><span class="hs-identifier hs-var">num_rshps</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360851"><span class="hs-identifier hs-var">num_rshps</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360855"><span class="hs-identifier hs-var">mid_dims</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-564"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360850"><span class="annot"><span class="annottext">dims'' :: [LMADDim num]
</span><a href="#local-6989586621684360850"><span class="hs-identifier hs-var hs-var">dims''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-565"></span><span>        </span><span class="annot"><span class="annottext">Permutation -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. Permutation -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Mem.IxFun.html#permuteInv"><span class="hs-identifier hs-var">permuteInv</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360868"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">([LMADDim num] -&gt; [LMADDim num]) -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-566"></span><span>          </span><span class="annot"><span class="annottext">(LMADDim num -&gt; num -&gt; LMADDim num)
-&gt; [LMADDim num] -&gt; Shape num -&gt; [LMADDim num]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span>
</span><span id="line-567"></span><span>            </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684360849"><span class="annot"><span class="annottext">LMADDim num
</span><a href="#local-6989586621684360849"><span class="hs-identifier hs-var">ld</span></a></span></span><span> </span><span id="local-6989586621684360848"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360848"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">LMADDim num
</span><a href="#local-6989586621684360849"><span class="hs-identifier hs-var">ld</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">ldShape :: num
</span><a href="Futhark.IR.Mem.IxFun.html#ldShape"><span class="hs-identifier hs-var">ldShape</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360848"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-568"></span><span>            </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360858"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-569"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeChange num -&gt; Shape num
forall d. ShapeChange d -&gt; [d]
</span><a href="Futhark.IR.Prop.Reshape.html#newDims"><span class="hs-identifier hs-var">newDims</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360869"><span class="hs-identifier hs-var">newshape</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-570"></span><span>      </span><span id="local-6989586621684360846"><span class="annot"><span class="annottext">lmad' :: LMAD num
</span><a href="#local-6989586621684360846"><span class="hs-identifier hs-var hs-var">lmad'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360874"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360850"><span class="hs-identifier hs-var">dims''</span></a></span><span>
</span><span id="line-571"></span><span>  </span><span class="annot"><span class="annottext">IxFun num -&gt; Maybe (IxFun num)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(IxFun num -&gt; Maybe (IxFun num)) -&gt; IxFun num -&gt; Maybe (IxFun num)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360846"><span class="hs-identifier hs-var">lmad'</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; NonEmpty (LMAD num)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360872"><span class="hs-identifier hs-var">lmads</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360871"><span class="hs-identifier hs-var">oldbase</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360870"><span class="hs-identifier hs-var">cg</span></a></span><span>
</span><span id="line-572"></span><span>
</span><span id="line-573"></span><span class="hs-comment">-- | Handle the case where a reshape operation can stay inside a single LMAD.</span><span>
</span><span id="line-574"></span><span class="hs-comment">--</span><span>
</span><span id="line-575"></span><span class="hs-comment">-- There are four conditions that all must hold for the result of a reshape</span><span>
</span><span id="line-576"></span><span class="hs-comment">-- operation to remain in the one-LMAD domain:</span><span>
</span><span id="line-577"></span><span class="hs-comment">--</span><span>
</span><span id="line-578"></span><span class="hs-comment">--   (1) the permutation of the underlying LMAD must leave unchanged</span><span>
</span><span id="line-579"></span><span class="hs-comment">--       the LMAD dimensions that were *not* reshape coercions.</span><span>
</span><span id="line-580"></span><span class="hs-comment">--   (2) the repetition of dimensions of the underlying LMAD must</span><span>
</span><span id="line-581"></span><span class="hs-comment">--       refer only to the coerced-dimensions of the reshape operation.</span><span>
</span><span id="line-582"></span><span class="hs-comment">--   (3) similarly, the rotated dimensions must refer only to</span><span>
</span><span id="line-583"></span><span class="hs-comment">--       dimensions that are coerced by the reshape operation.</span><span>
</span><span id="line-584"></span><span class="hs-comment">--   (4) finally, the underlying memory is contiguous (and monotonous).</span><span>
</span><span id="line-585"></span><span class="hs-comment">--</span><span>
</span><span id="line-586"></span><span class="hs-comment">-- If any of these conditions do not hold, then the reshape operation will</span><span>
</span><span id="line-587"></span><span class="hs-comment">-- conservatively add a new LMAD to the list, leading to a representation that</span><span>
</span><span id="line-588"></span><span class="hs-comment">-- provides less opportunities for further analysis.</span><span>
</span><span id="line-589"></span><span id="local-6989586621684360845"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#reshapeOneLMAD"><span class="hs-identifier hs-type">reshapeOneLMAD</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-590"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684360845"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684360845"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-591"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684360845"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-592"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#ShapeChange"><span class="hs-identifier hs-type">ShapeChange</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684360845"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-593"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684360845"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-594"></span><span id="reshapeOneLMAD"><span class="annot"><span class="annottext">reshapeOneLMAD :: forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; ShapeChange num -&gt; Maybe (IxFun num)
</span><a href="Futhark.IR.Mem.IxFun.html#reshapeOneLMAD"><span class="hs-identifier hs-var hs-var">reshapeOneLMAD</span></a></span></span><span> </span><span id="local-6989586621684360824"><span class="annot"><span class="annottext">ixfun :: IxFun num
</span><a href="#local-6989586621684360824"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360823"><span class="annot"><span class="annottext">lmad :: LMAD num
</span><a href="#local-6989586621684360823"><span class="hs-identifier hs-var">lmad</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684360822"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360822"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621684360821"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360821"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684360820"><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360820"><span class="hs-identifier hs-var">lmads</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360819"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360819"><span class="hs-identifier hs-var">oldbase</span></a></span></span><span> </span><span id="local-6989586621684360818"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360818"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360817"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360817"><span class="hs-identifier hs-var">newshape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-595"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360816"><span class="annot"><span class="annottext">perm :: Permutation
</span><a href="#local-6989586621684360816"><span class="hs-identifier hs-var hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Permutation
forall num. LMAD num -&gt; Permutation
</span><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-var">lmadPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360823"><span class="hs-identifier hs-var">lmad</span></a></span><span>
</span><span id="line-596"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684360815"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360815"><span class="hs-identifier hs-var">head_coercions</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360814"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360814"><span class="hs-identifier hs-var">reshapes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360813"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360813"><span class="hs-identifier hs-var">tail_coercions</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ShapeChange num
-&gt; Maybe (ShapeChange num, ShapeChange num, ShapeChange num)
forall num.
(Eq num, IntegralExp num) =&gt;
ShapeChange num
-&gt; Maybe (ShapeChange num, ShapeChange num, ShapeChange num)
</span><a href="Futhark.IR.Mem.IxFun.html#splitCoercions"><span class="hs-identifier hs-var">splitCoercions</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360817"><span class="hs-identifier hs-var">newshape</span></a></span><span>
</span><span id="line-597"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360811"><span class="annot"><span class="annottext">hd_len :: Int
</span><a href="#local-6989586621684360811"><span class="hs-identifier hs-var hs-var">hd_len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ShapeChange num -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360815"><span class="hs-identifier hs-var">head_coercions</span></a></span><span>
</span><span id="line-598"></span><span>      </span><span id="local-6989586621684360808"><span class="annot"><span class="annottext">num_coercions :: Int
</span><a href="#local-6989586621684360808"><span class="hs-identifier hs-var hs-var">num_coercions</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360811"><span class="hs-identifier hs-var">hd_len</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange num -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360813"><span class="hs-identifier hs-var">tail_coercions</span></a></span><span>
</span><span id="line-599"></span><span>      </span><span id="local-6989586621684360807"><span class="annot"><span class="annottext">dims_perm :: [LMADDim num]
</span><a href="#local-6989586621684360807"><span class="hs-identifier hs-var hs-var">dims_perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. Permutation -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Mem.IxFun.html#permuteFwd"><span class="hs-identifier hs-var">permuteFwd</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360816"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360821"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-600"></span><span>      </span><span id="local-6989586621684360804"><span class="annot"><span class="annottext">mid_dims :: [LMADDim num]
</span><a href="#local-6989586621684360804"><span class="hs-identifier hs-var hs-var">mid_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360821"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360808"><span class="hs-identifier hs-var">num_coercions</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([LMADDim num] -&gt; [LMADDim num]) -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360811"><span class="hs-identifier hs-var">hd_len</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360807"><span class="hs-identifier hs-var">dims_perm</span></a></span><span>
</span><span id="line-601"></span><span>      </span><span class="hs-comment">-- Ignore rotates, as we only care about not having rotates in the</span><span>
</span><span id="line-602"></span><span>      </span><span class="hs-comment">-- dimensions that aren't coercions (@mid_dims@), which we check</span><span>
</span><span id="line-603"></span><span>      </span><span class="hs-comment">-- separately.</span><span>
</span><span id="line-604"></span><span>      </span><span id="local-6989586621684360801"><span class="annot"><span class="annottext">mon :: Monotonicity
</span><a href="#local-6989586621684360801"><span class="hs-identifier hs-var hs-var">mon</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IxFun num -&gt; Monotonicity
forall num.
(Eq num, IntegralExp num) =&gt;
Bool -&gt; IxFun num -&gt; Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunMonotonicityRots"><span class="hs-identifier hs-var">ixfunMonotonicityRots</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360824"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-605"></span><span>
</span><span id="line-606"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-607"></span><span>    </span><span class="hs-comment">-- checking conditions (2) and (3)</span><span>
</span><span id="line-608"></span><span>    </span><span class="annot"><span class="annottext">(LMADDim num -&gt; Bool) -&gt; [LMADDim num] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span id="local-6989586621684360799"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360799"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684360798"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360798"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360799"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360798"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360804"><span class="hs-identifier hs-var">mid_dims</span></a></span><span>
</span><span id="line-609"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span>
</span><span id="line-610"></span><span>      </span><span class="hs-comment">-- checking condition (1)</span><span>
</span><span id="line-611"></span><span>      </span><span class="annot"><span class="annottext">Int -&gt; Permutation -&gt; Bool
forall {a}. (Eq a, Num a, Enum a) =&gt; a -&gt; [a] -&gt; Bool
</span><a href="#local-6989586621684360797"><span class="hs-identifier hs-var">consecutive</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360811"><span class="hs-identifier hs-var">hd_len</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LMADDim num -&gt; Int) -&gt; [LMADDim num] -&gt; Permutation
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; Int
forall num. LMADDim num -&gt; Int
</span><a href="Futhark.IR.Mem.IxFun.html#ldPerm"><span class="hs-identifier hs-var hs-var">ldPerm</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360804"><span class="hs-identifier hs-var">mid_dims</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-612"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span>
</span><span id="line-613"></span><span>      </span><span class="hs-comment">-- checking condition (4)</span><span>
</span><span id="line-614"></span><span>      </span><span class="annot"><span class="annottext">IxFun num -&gt; Bool
forall num. IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#hasContiguousPerm"><span class="hs-identifier hs-var">hasContiguousPerm</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360824"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-615"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360818"><span class="hs-identifier hs-var">cg</span></a></span><span>
</span><span id="line-616"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360801"><span class="hs-identifier hs-var">mon</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity -&gt; Monotonicity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360801"><span class="hs-identifier hs-var">mon</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity -&gt; Monotonicity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Dec"><span class="hs-identifier hs-var">Dec</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-617"></span><span>
</span><span id="line-618"></span><span>  </span><span class="hs-comment">-- make new permutation</span><span>
</span><span id="line-619"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360795"><span class="annot"><span class="annottext">rsh_len :: Int
</span><a href="#local-6989586621684360795"><span class="hs-identifier hs-var hs-var">rsh_len</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ShapeChange num -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360814"><span class="hs-identifier hs-var">reshapes</span></a></span><span>
</span><span id="line-620"></span><span>      </span><span id="local-6989586621684360791"><span class="annot"><span class="annottext">diff :: Int
</span><a href="#local-6989586621684360791"><span class="hs-identifier hs-var hs-var">diff</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ShapeChange num -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360817"><span class="hs-identifier hs-var">newshape</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360821"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-621"></span><span>      </span><span id="local-6989586621684360785"><span class="annot"><span class="annottext">iota_shape :: Permutation
</span><a href="#local-6989586621684360785"><span class="hs-identifier hs-var hs-var">iota_shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">ShapeChange num -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360817"><span class="hs-identifier hs-var">newshape</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-622"></span><span>      </span><span id="local-6989586621684360779"><span class="annot"><span class="annottext">perm' :: Permutation
</span><a href="#local-6989586621684360779"><span class="hs-identifier hs-var hs-var">perm'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-623"></span><span>        </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; Permutation -&gt; Permutation
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span>
</span><span id="line-624"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684360778"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360778"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-625"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360775"><span class="annot"><span class="annottext">ind :: Int
</span><a href="#local-6989586621684360775"><span class="hs-identifier hs-var hs-var">ind</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-626"></span><span>                    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360778"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360811"><span class="hs-identifier hs-var">hd_len</span></a></span><span>
</span><span id="line-627"></span><span>                      </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360778"><span class="hs-identifier hs-var">i</span></a></span><span>
</span><span id="line-628"></span><span>                      </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360778"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360791"><span class="hs-identifier hs-var">diff</span></a></span><span>
</span><span id="line-629"></span><span>               </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360778"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360811"><span class="hs-identifier hs-var">hd_len</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360778"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360811"><span class="hs-identifier hs-var">hd_len</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360795"><span class="hs-identifier hs-var">rsh_len</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-630"></span><span>                    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360778"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-comment">-- already checked mid_dims not affected</span><span>
</span><span id="line-631"></span><span>                    </span><span class="hs-keyword">else</span><span>
</span><span id="line-632"></span><span>                      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360773"><span class="annot"><span class="annottext">p :: Int
</span><a href="#local-6989586621684360773"><span class="hs-identifier hs-var hs-var">p</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; Int
forall num. LMADDim num -&gt; Int
</span><a href="Futhark.IR.Mem.IxFun.html#ldPerm"><span class="hs-identifier hs-var hs-var">ldPerm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360821"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int -&gt; LMADDim num
forall a. [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360775"><span class="hs-identifier hs-var">ind</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-633"></span><span>                       </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360773"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360811"><span class="hs-identifier hs-var">hd_len</span></a></span><span>
</span><span id="line-634"></span><span>                            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360773"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-635"></span><span>                            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360773"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360791"><span class="hs-identifier hs-var">diff</span></a></span><span>
</span><span id="line-636"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-637"></span><span>          </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360785"><span class="hs-identifier hs-var">iota_shape</span></a></span><span>
</span><span id="line-638"></span><span>      </span><span class="hs-comment">-- split the dimensions</span><span>
</span><span id="line-639"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684360760"><span class="annot"><span class="annottext">[(Int, (num, num))]
</span><a href="#local-6989586621684360760"><span class="hs-identifier hs-var">support_inds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360759"><span class="annot"><span class="annottext">[(Int, num)]
</span><a href="#local-6989586621684360759"><span class="hs-identifier hs-var">repeat_inds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-640"></span><span>        </span><span class="annot"><span class="annottext">(([(Int, (num, num))], [(Int, num)])
 -&gt; (Int, DimChange num, Int)
 -&gt; ([(Int, (num, num))], [(Int, num)]))
-&gt; ([(Int, (num, num))], [(Int, num)])
-&gt; [(Int, DimChange num, Int)]
-&gt; ([(Int, (num, num))], [(Int, num)])
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl</span></span><span>
</span><span id="line-641"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684360758"><span class="annot"><span class="annottext">[(Int, (num, num))]
</span><a href="#local-6989586621684360758"><span class="hs-identifier hs-var">sup</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360757"><span class="annot"><span class="annottext">[(Int, num)]
</span><a href="#local-6989586621684360757"><span class="hs-identifier hs-var">rpt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360756"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360756"><span class="hs-identifier hs-var">i</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360755"><span class="annot"><span class="annottext">DimChange num
</span><a href="#local-6989586621684360755"><span class="hs-identifier hs-var">shpdim</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360754"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360754"><span class="hs-identifier hs-var">ip</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-642"></span><span>              </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360756"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360811"><span class="hs-identifier hs-var">hd_len</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360756"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360811"><span class="hs-identifier hs-var">hd_len</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360795"><span class="hs-identifier hs-var">rsh_len</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DimChange num
</span><a href="#local-6989586621684360755"><span class="hs-identifier hs-var">shpdim</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-643"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#DimCoercion"><span class="hs-identifier hs-type">DimCoercion</span></a></span><span> </span><span id="local-6989586621684360752"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360752"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-644"></span><span>                  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360807"><span class="hs-identifier hs-var">dims_perm</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int -&gt; LMADDim num
forall a. [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360756"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-645"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Int, (num, num))]
</span><a href="#local-6989586621684360758"><span class="hs-identifier hs-var">sup</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360754"><span class="hs-identifier hs-var">ip</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360752"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int, num) -&gt; [(Int, num)] -&gt; [(Int, num)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Int, num)]
</span><a href="#local-6989586621684360757"><span class="hs-identifier hs-var">rpt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-646"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684360751"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360751"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360754"><span class="hs-identifier hs-var">ip</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360751"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360752"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int, (num, num)) -&gt; [(Int, (num, num))] -&gt; [(Int, (num, num))]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Int, (num, num))]
</span><a href="#local-6989586621684360758"><span class="hs-identifier hs-var">sup</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Int, num)]
</span><a href="#local-6989586621684360757"><span class="hs-identifier hs-var">rpt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-647"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#DimCoercion"><span class="hs-identifier hs-type">DimCoercion</span></a></span><span> </span><span id="local-6989586621684360750"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360750"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-648"></span><span>                  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360807"><span class="hs-identifier hs-var">dims_perm</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int -&gt; LMADDim num
forall a. [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360756"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360791"><span class="hs-identifier hs-var">diff</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-649"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Int, (num, num))]
</span><a href="#local-6989586621684360758"><span class="hs-identifier hs-var">sup</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360754"><span class="hs-identifier hs-var">ip</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360750"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int, num) -&gt; [(Int, num)] -&gt; [(Int, num)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Int, num)]
</span><a href="#local-6989586621684360757"><span class="hs-identifier hs-var">rpt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-650"></span><span>                    </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684360749"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360749"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360754"><span class="hs-identifier hs-var">ip</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360749"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360750"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int, (num, num)) -&gt; [(Int, (num, num))] -&gt; [(Int, (num, num))]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Int, (num, num))]
</span><a href="#local-6989586621684360758"><span class="hs-identifier hs-var">sup</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Int, num)]
</span><a href="#local-6989586621684360757"><span class="hs-identifier hs-var">rpt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-651"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DimChange num
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-652"></span><span>                  </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360754"><span class="hs-identifier hs-var">ip</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">DimChange num -&gt; num
forall d. DimChange d -&gt; d
</span><a href="Futhark.IR.Prop.Reshape.html#newDim"><span class="hs-identifier hs-var">newDim</span></a></span><span> </span><span class="annot"><span class="annottext">DimChange num
</span><a href="#local-6989586621684360755"><span class="hs-identifier hs-var">shpdim</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Int, (num, num)) -&gt; [(Int, (num, num))] -&gt; [(Int, (num, num))]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(Int, (num, num))]
</span><a href="#local-6989586621684360758"><span class="hs-identifier hs-var">sup</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Int, num)]
</span><a href="#local-6989586621684360757"><span class="hs-identifier hs-var">rpt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-653"></span><span>                </span><span class="hs-comment">-- already checked that the reshaped</span><span>
</span><span id="line-654"></span><span>                </span><span class="hs-comment">-- dims cannot be rotates</span><span>
</span><span id="line-655"></span><span>                </span><span class="annot"><span class="annottext">(Bool, Bool, DimChange num)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; ([(Int, (num, num))], [(Int, num)])
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reshape: reached impossible case&quot;</span></span><span>
</span><span id="line-656"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-657"></span><span>          </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-658"></span><span>          </span><span class="annot"><span class="annottext">([(Int, DimChange num, Int)]
 -&gt; ([(Int, (num, num))], [(Int, num)]))
-&gt; [(Int, DimChange num, Int)]
-&gt; ([(Int, (num, num))], [(Int, num)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Int, DimChange num, Int)] -&gt; [(Int, DimChange num, Int)]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([(Int, DimChange num, Int)] -&gt; [(Int, DimChange num, Int)])
-&gt; [(Int, DimChange num, Int)] -&gt; [(Int, DimChange num, Int)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Permutation
-&gt; ShapeChange num -&gt; Permutation -&gt; [(Int, DimChange num, Int)]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360785"><span class="hs-identifier hs-var">iota_shape</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360817"><span class="hs-identifier hs-var">newshape</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360779"><span class="hs-identifier hs-var">perm'</span></a></span><span>
</span><span id="line-659"></span><span>
</span><span id="line-660"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684360745"><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360745"><span class="hs-identifier hs-var">sup_inds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360744"><span class="annot"><span class="annottext">[(num, num)]
</span><a href="#local-6989586621684360744"><span class="hs-identifier hs-var">support</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Int, (num, num))] -&gt; (Permutation, [(num, num)])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Int, (num, num))] -&gt; (Permutation, [(num, num)]))
-&gt; [(Int, (num, num))] -&gt; (Permutation, [(num, num)])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Int, (num, num)) -&gt; (Int, (num, num)) -&gt; Ordering)
-&gt; [(Int, (num, num))] -&gt; [(Int, (num, num))]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortBy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-identifier hs-var">compare</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Ordering)
-&gt; ((Int, (num, num)) -&gt; Int)
-&gt; (Int, (num, num))
-&gt; (Int, (num, num))
-&gt; Ordering
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="annot"><span class="annottext">(Int, (num, num)) -&gt; Int
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Int, (num, num))]
</span><a href="#local-6989586621684360760"><span class="hs-identifier hs-var">support_inds</span></a></span><span>
</span><span id="line-661"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684360742"><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360742"><span class="hs-identifier hs-var">rpt_inds</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360741"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360741"><span class="hs-identifier hs-var">repeats</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Int, num)] -&gt; (Permutation, Shape num)
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Int, num)]
</span><a href="#local-6989586621684360759"><span class="hs-identifier hs-var">repeat_inds</span></a></span><span>
</span><span id="line-662"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span id="local-6989586621684360739"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360739"><span class="hs-identifier hs-var">off'</span></a></span></span><span> </span><span id="local-6989586621684360738"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360738"><span class="hs-identifier hs-var">dims_sup</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Monotonicity -&gt; num -&gt; [(num, num)] -&gt; LMAD num
forall num.
IntegralExp num =&gt;
Monotonicity -&gt; num -&gt; [(num, num)] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#makeRotIota"><span class="hs-identifier hs-var">makeRotIota</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360801"><span class="hs-identifier hs-var">mon</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360822"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">[(num, num)]
</span><a href="#local-6989586621684360744"><span class="hs-identifier hs-var">support</span></a></span><span>
</span><span id="line-663"></span><span>      </span><span id="local-6989586621684360735"><span class="annot"><span class="annottext">repeats' :: [LMADDim num]
</span><a href="#local-6989586621684360735"><span class="hs-identifier hs-var hs-var">repeats'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(num -&gt; LMADDim num) -&gt; Shape num -&gt; [LMADDim num]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684360734"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360734"><span class="hs-identifier hs-var">n</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360734"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360741"><span class="hs-identifier hs-var">repeats</span></a></span><span>
</span><span id="line-664"></span><span>      </span><span id="local-6989586621684360732"><span class="annot"><span class="annottext">dims' :: [LMADDim num]
</span><a href="#local-6989586621684360732"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-665"></span><span>        </span><span class="annot"><span class="annottext">((Int, LMADDim num) -&gt; LMADDim num)
-&gt; [(Int, LMADDim num)] -&gt; [LMADDim num]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Int, LMADDim num) -&gt; LMADDim num
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([(Int, LMADDim num)] -&gt; [LMADDim num])
-&gt; [(Int, LMADDim num)] -&gt; [LMADDim num]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-666"></span><span>          </span><span class="annot"><span class="annottext">((Int, LMADDim num) -&gt; (Int, LMADDim num) -&gt; Ordering)
-&gt; [(Int, LMADDim num)] -&gt; [(Int, LMADDim num)]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortBy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-identifier hs-var">compare</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Ordering)
-&gt; ((Int, LMADDim num) -&gt; Int)
-&gt; (Int, LMADDim num)
-&gt; (Int, LMADDim num)
-&gt; Ordering
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="annot"><span class="annottext">(Int, LMADDim num) -&gt; Int
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Int, LMADDim num)] -&gt; [(Int, LMADDim num)])
-&gt; [(Int, LMADDim num)] -&gt; [(Int, LMADDim num)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-667"></span><span>            </span><span class="annot"><span class="annottext">Permutation -&gt; [LMADDim num] -&gt; [(Int, LMADDim num)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360745"><span class="hs-identifier hs-var">sup_inds</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360738"><span class="hs-identifier hs-var">dims_sup</span></a></span><span> </span><span class="annot"><span class="annottext">[(Int, LMADDim num)]
-&gt; [(Int, LMADDim num)] -&gt; [(Int, LMADDim num)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; [LMADDim num] -&gt; [(Int, LMADDim num)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360742"><span class="hs-identifier hs-var">rpt_inds</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360735"><span class="hs-identifier hs-var">repeats'</span></a></span><span>
</span><span id="line-668"></span><span>      </span><span id="local-6989586621684360731"><span class="annot"><span class="annottext">lmad' :: LMAD num
</span><a href="#local-6989586621684360731"><span class="hs-identifier hs-var hs-var">lmad'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360739"><span class="hs-identifier hs-var">off'</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360732"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-669"></span><span>  </span><span class="annot"><span class="annottext">IxFun num -&gt; Maybe (IxFun num)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(IxFun num -&gt; Maybe (IxFun num)) -&gt; IxFun num -&gt; Maybe (IxFun num)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Permutation -&gt; LMAD num -&gt; LMAD num
forall num. Permutation -&gt; LMAD num -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#setLMADPermutation"><span class="hs-identifier hs-var">setLMADPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360779"><span class="hs-identifier hs-var">perm'</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360731"><span class="hs-identifier hs-var">lmad'</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; NonEmpty (LMAD num)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360820"><span class="hs-identifier hs-var">lmads</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360819"><span class="hs-identifier hs-var">oldbase</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360818"><span class="hs-identifier hs-var">cg</span></a></span><span>
</span><span id="line-670"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-671"></span><span>    </span><span id="local-6989586621684360797"><span class="annot"><span class="annottext">consecutive :: a -&gt; [a] -&gt; Bool
</span><a href="#local-6989586621684360797"><span class="hs-identifier hs-var hs-var">consecutive</span></a></span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-672"></span><span>    </span><span class="annot"><a href="#local-6989586621684360797"><span class="hs-identifier hs-var">consecutive</span></a></span><span> </span><span id="local-6989586621684360721"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684360721"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">[</span><span id="local-6989586621684360720"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684360720"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684360721"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684360720"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-673"></span><span>    </span><span class="annot"><a href="#local-6989586621684360797"><span class="hs-identifier hs-var">consecutive</span></a></span><span> </span><span id="local-6989586621684360719"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684360719"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span id="local-6989586621684360718"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684360718"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><span class="hs-identifier hs-var">and</span></span><span> </span><span class="annot"><span class="annottext">([Bool] -&gt; Bool) -&gt; [Bool] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(a -&gt; a -&gt; Bool) -&gt; [a] -&gt; [a] -&gt; [Bool]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">(==)</span></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684360718"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684360719"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684360719"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; a -&gt; a
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">a
</span><span class="hs-number">1</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-674"></span><span>
</span><span id="line-675"></span><span id="local-6989586621684362151"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#splitCoercions"><span class="hs-identifier hs-type">splitCoercions</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-676"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362151"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362151"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-677"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#ShapeChange"><span class="hs-identifier hs-type">ShapeChange</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362151"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-678"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.html#ShapeChange"><span class="hs-identifier hs-type">ShapeChange</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362151"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#ShapeChange"><span class="hs-identifier hs-type">ShapeChange</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362151"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#ShapeChange"><span class="hs-identifier hs-type">ShapeChange</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362151"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-679"></span><span id="splitCoercions"><span class="annot"><span class="annottext">splitCoercions :: forall num.
(Eq num, IntegralExp num) =&gt;
ShapeChange num
-&gt; Maybe (ShapeChange num, ShapeChange num, ShapeChange num)
</span><a href="Futhark.IR.Mem.IxFun.html#splitCoercions"><span class="hs-identifier hs-var hs-var">splitCoercions</span></a></span></span><span> </span><span id="local-6989586621684360711"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360711"><span class="hs-identifier hs-var">newshape'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-680"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360710"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360710"><span class="hs-identifier hs-var">head_coercions</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360709"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360709"><span class="hs-identifier hs-var">newshape''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DimChange num -&gt; Bool)
-&gt; ShapeChange num -&gt; (ShapeChange num, ShapeChange num)
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">span</span></span><span> </span><span class="annot"><span class="annottext">DimChange num -&gt; Bool
forall {d}. DimChange d -&gt; Bool
</span><a href="#local-6989586621684360707"><span class="hs-identifier hs-var">isCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360711"><span class="hs-identifier hs-var">newshape'</span></a></span><span>
</span><span id="line-681"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684360706"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360706"><span class="hs-identifier hs-var">reshapes</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360705"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360705"><span class="hs-identifier hs-var">tail_coercions</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DimChange num -&gt; Bool)
-&gt; ShapeChange num -&gt; (ShapeChange num, ShapeChange num)
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">break</span></span><span> </span><span class="annot"><span class="annottext">DimChange num -&gt; Bool
forall {d}. DimChange d -&gt; Bool
</span><a href="#local-6989586621684360707"><span class="hs-identifier hs-var">isCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360709"><span class="hs-identifier hs-var">newshape''</span></a></span><span>
</span><span id="line-682"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(DimChange num -&gt; Bool) -&gt; ShapeChange num -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">DimChange num -&gt; Bool
forall {d}. DimChange d -&gt; Bool
</span><a href="#local-6989586621684360707"><span class="hs-identifier hs-var">isCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360705"><span class="hs-identifier hs-var">tail_coercions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-683"></span><span>  </span><span class="annot"><span class="annottext">(ShapeChange num, ShapeChange num, ShapeChange num)
-&gt; Maybe (ShapeChange num, ShapeChange num, ShapeChange num)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360710"><span class="hs-identifier hs-var">head_coercions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360706"><span class="hs-identifier hs-var">reshapes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360705"><span class="hs-identifier hs-var">tail_coercions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-684"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-685"></span><span>    </span><span id="local-6989586621684360707"><span class="annot"><span class="annottext">isCoercion :: DimChange d -&gt; Bool
</span><a href="#local-6989586621684360707"><span class="hs-identifier hs-var hs-var">isCoercion</span></a></span></span><span> </span><span class="annot"><a href="Futhark.IR.Syntax.html#DimCoercion"><span class="hs-identifier hs-type">DimCoercion</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-686"></span><span>    </span><span class="annot"><a href="#local-6989586621684360707"><span class="hs-identifier hs-var">isCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">DimChange d
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-687"></span><span>
</span><span id="line-688"></span><span class="hs-comment">-- | Reshape an index function.</span><span>
</span><span id="line-689"></span><span id="local-6989586621684362133"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#reshape"><span class="hs-identifier hs-type">reshape</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-690"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362133"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362133"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-691"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362133"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-692"></span><span>  </span><span class="annot"><a href="Futhark.IR.Syntax.html#ShapeChange"><span class="hs-identifier hs-type">ShapeChange</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362133"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-693"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362133"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-694"></span><span id="reshape"><span class="annot"><span class="annottext">reshape :: forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; ShapeChange num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#reshape"><span class="hs-identifier hs-var hs-var">reshape</span></a></span></span><span> </span><span id="local-6989586621684360694"><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360694"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span> </span><span id="local-6989586621684360693"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360693"><span class="hs-identifier hs-var">new_shape</span></a></span></span><span>
</span><span id="line-695"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684360692"><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360692"><span class="hs-identifier hs-var">ixfun'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; ShapeChange num -&gt; Maybe (IxFun num)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; ShapeChange num -&gt; Maybe (IxFun num)
</span><a href="Futhark.IR.Mem.IxFun.html#reshapeCoercion"><span class="hs-identifier hs-var">reshapeCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360694"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360693"><span class="hs-identifier hs-var">new_shape</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360692"><span class="hs-identifier hs-var">ixfun'</span></a></span><span>
</span><span id="line-696"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684360691"><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360691"><span class="hs-identifier hs-var">ixfun'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; ShapeChange num -&gt; Maybe (IxFun num)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; ShapeChange num -&gt; Maybe (IxFun num)
</span><a href="Futhark.IR.Mem.IxFun.html#reshapeOneLMAD"><span class="hs-identifier hs-var">reshapeOneLMAD</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360694"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360693"><span class="hs-identifier hs-var">new_shape</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360691"><span class="hs-identifier hs-var">ixfun'</span></a></span><span>
</span><span id="line-697"></span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#reshape"><span class="hs-identifier hs-var">reshape</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360690"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360690"><span class="hs-identifier hs-var">lmad0</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684360689"><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360689"><span class="hs-identifier hs-var">lmad0s</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360688"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360688"><span class="hs-identifier hs-var">oshp</span></a></span></span><span> </span><span id="local-6989586621684360687"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360687"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360686"><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360686"><span class="hs-identifier hs-var">new_shape</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-698"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Shape num -&gt; IxFun num
forall num. IntegralExp num =&gt; Shape num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#iota"><span class="hs-identifier hs-var">iota</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeChange num -&gt; Shape num
forall d. ShapeChange d -&gt; [d]
</span><a href="Futhark.IR.Prop.Reshape.html#newDims"><span class="hs-identifier hs-var">newDims</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeChange num
</span><a href="#local-6989586621684360686"><span class="hs-identifier hs-var">new_shape</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-699"></span><span>    </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360685"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360685"><span class="hs-identifier hs-var">lmad</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360685"><span class="hs-identifier hs-var">lmad</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; NonEmpty (LMAD num)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360690"><span class="hs-identifier hs-var">lmad0</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; [LMAD num]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360689"><span class="hs-identifier hs-var">lmad0s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360688"><span class="hs-identifier hs-var">oshp</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360687"><span class="hs-identifier hs-var">cg</span></a></span><span>
</span><span id="line-700"></span><span>    </span><span class="annot"><span class="annottext">IxFun num
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; IxFun num
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;reshape: reached impossible case&quot;</span></span><span>
</span><span id="line-701"></span><span>
</span><span id="line-702"></span><span class="hs-comment">-- | The number of dimensions in the domain of the input function.</span><span>
</span><span id="line-703"></span><span id="local-6989586621684362131"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#rank"><span class="hs-identifier hs-type">rank</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-704"></span><span>  </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362131"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-705"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362131"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-706"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span></span><span>
</span><span id="line-707"></span><span id="rank"><span class="annot"><span class="annottext">rank :: forall num. IntegralExp num =&gt; IxFun num -&gt; Int
</span><a href="Futhark.IR.Mem.IxFun.html#rank"><span class="hs-identifier hs-var hs-var">rank</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684360682"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360682"><span class="hs-identifier hs-var">sss</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360682"><span class="hs-identifier hs-var">sss</span></a></span><span>
</span><span id="line-708"></span><span>
</span><span id="line-709"></span><span class="hs-comment">-- | Handle the case where a rebase operation can stay within m + n - 1 LMADs,</span><span>
</span><span id="line-710"></span><span class="hs-comment">-- where m is the number of LMADs in the index function, and n is the number of</span><span>
</span><span id="line-711"></span><span class="hs-comment">-- LMADs in the new base.  If both index function have only on LMAD, this means</span><span>
</span><span id="line-712"></span><span class="hs-comment">-- that we stay within the single-LMAD domain.</span><span>
</span><span id="line-713"></span><span class="hs-comment">--</span><span>
</span><span id="line-714"></span><span class="hs-comment">-- We can often stay in that domain if the original ixfun is essentially a</span><span>
</span><span id="line-715"></span><span class="hs-comment">-- slice, e.g. `x[i, (k1,m,s1), (k2,n,s2)] = orig`.</span><span>
</span><span id="line-716"></span><span class="hs-comment">--</span><span>
</span><span id="line-717"></span><span class="hs-comment">-- XXX: TODO: handle repetitions in both lmads.</span><span>
</span><span id="line-718"></span><span class="hs-comment">--</span><span>
</span><span id="line-719"></span><span class="hs-comment">-- How to handle repeated dimensions in the original?</span><span>
</span><span id="line-720"></span><span class="hs-comment">--</span><span>
</span><span id="line-721"></span><span class="hs-comment">--   (a) Shave them off of the last lmad of original</span><span>
</span><span id="line-722"></span><span class="hs-comment">--   (b) Compose the result from (a) with the first</span><span>
</span><span id="line-723"></span><span class="hs-comment">--       lmad of the new base</span><span>
</span><span id="line-724"></span><span class="hs-comment">--   (c) apply a repeat operation on the result of (b).</span><span>
</span><span id="line-725"></span><span class="hs-comment">--</span><span>
</span><span id="line-726"></span><span class="hs-comment">-- However, I strongly suspect that for in-place update what we need is actually</span><span>
</span><span id="line-727"></span><span class="hs-comment">-- the INVERSE of the rebase function, i.e., given an index function new-base</span><span>
</span><span id="line-728"></span><span class="hs-comment">-- and another one orig, compute the index function ixfun0 such that:</span><span>
</span><span id="line-729"></span><span class="hs-comment">--</span><span>
</span><span id="line-730"></span><span class="hs-comment">--   new-base == rebase ixfun0 ixfun, or equivalently:</span><span>
</span><span id="line-731"></span><span class="hs-comment">--   new-base == ixfun o ixfun0</span><span>
</span><span id="line-732"></span><span class="hs-comment">--</span><span>
</span><span id="line-733"></span><span class="hs-comment">-- because then I can go bottom up and compose with ixfun0 all the index</span><span>
</span><span id="line-734"></span><span class="hs-comment">-- functions corresponding to the memory block associated with ixfun.</span><span>
</span><span id="line-735"></span><span id="local-6989586621684362129"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#rebaseNice"><span class="hs-identifier hs-type">rebaseNice</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-736"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362129"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362129"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-737"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362129"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-738"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362129"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-739"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362129"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-740"></span><span id="rebaseNice"><span class="annot"><span class="annottext">rebaseNice :: forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; IxFun num -&gt; Maybe (IxFun num)
</span><a href="Futhark.IR.Mem.IxFun.html#rebaseNice"><span class="hs-identifier hs-var hs-var">rebaseNice</span></a></span></span><span>
</span><span id="line-741"></span><span>  </span><span id="local-6989586621684360658"><span class="annot"><span class="annottext">new_base :: IxFun num
</span><a href="#local-6989586621684360658"><span class="hs-identifier hs-var">new_base</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360657"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360657"><span class="hs-identifier hs-var">lmad_base</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684360656"><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360656"><span class="hs-identifier hs-var">lmads_base</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684360655"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360655"><span class="hs-identifier hs-var">cg_base</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-742"></span><span>  </span><span id="local-6989586621684360654"><span class="annot"><span class="annottext">ixfun :: IxFun num
</span><a href="#local-6989586621684360654"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span id="local-6989586621684360653"><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684360653"><span class="hs-identifier hs-var">lmads</span></a></span></span><span> </span><span id="local-6989586621684360652"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360652"><span class="hs-identifier hs-var">shp</span></a></span></span><span> </span><span id="local-6989586621684360651"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360651"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-743"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360650"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360650"><span class="hs-identifier hs-var">lmad</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684360649"><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360649"><span class="hs-identifier hs-var">lmads'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; NonEmpty (LMAD num)
forall a. NonEmpty a -&gt; NonEmpty a
</span><span class="hs-identifier hs-var">NE.reverse</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684360653"><span class="hs-identifier hs-var">lmads</span></a></span><span>
</span><span id="line-744"></span><span>        </span><span id="local-6989586621684360647"><span class="annot"><span class="annottext">dims :: [LMADDim num]
</span><a href="#local-6989586621684360647"><span class="hs-identifier hs-var hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMADDim num]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360650"><span class="hs-identifier hs-var">lmad</span></a></span><span>
</span><span id="line-745"></span><span>        </span><span id="local-6989586621684360646"><span class="annot"><span class="annottext">perm :: Permutation
</span><a href="#local-6989586621684360646"><span class="hs-identifier hs-var hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Permutation
forall num. LMAD num -&gt; Permutation
</span><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-var">lmadPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360650"><span class="hs-identifier hs-var">lmad</span></a></span><span>
</span><span id="line-746"></span><span>        </span><span id="local-6989586621684360645"><span class="annot"><span class="annottext">perm_base :: Permutation
</span><a href="#local-6989586621684360645"><span class="hs-identifier hs-var hs-var">perm_base</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Permutation
forall num. LMAD num -&gt; Permutation
</span><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-var">lmadPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360657"><span class="hs-identifier hs-var">lmad_base</span></a></span><span>
</span><span id="line-747"></span><span>
</span><span id="line-748"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-749"></span><span>      </span><span class="hs-comment">-- Core rebase condition.</span><span>
</span><span id="line-750"></span><span>      </span><span class="annot"><span class="annottext">IxFun num -&gt; Shape num
forall num. IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#base"><span class="hs-identifier hs-var hs-var">base</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360654"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">Shape num -&gt; Shape num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; Shape num
forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#shape"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360658"><span class="hs-identifier hs-var">new_base</span></a></span><span>
</span><span id="line-751"></span><span>        </span><span class="hs-comment">-- Conservative safety conditions: ixfun is contiguous and has known</span><span>
</span><span id="line-752"></span><span>        </span><span class="hs-comment">-- monotonicity for all dimensions.</span><span>
</span><span id="line-753"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360651"><span class="hs-identifier hs-var">cg</span></a></span><span>
</span><span id="line-754"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; Bool) -&gt; [LMADDim num] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Monotonicity -&gt; Monotonicity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Monotonicity -&gt; Bool)
-&gt; (LMADDim num -&gt; Monotonicity) -&gt; LMADDim num -&gt; Bool
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; Monotonicity
forall num. LMADDim num -&gt; Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#ldMon"><span class="hs-identifier hs-var hs-var">ldMon</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360647"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-755"></span><span>        </span><span class="hs-comment">-- XXX: We should be able to handle some basic cases where both index</span><span>
</span><span id="line-756"></span><span>        </span><span class="hs-comment">-- functions have non-trivial permutations.</span><span>
</span><span id="line-757"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun num -&gt; Bool
forall num. IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#hasContiguousPerm"><span class="hs-identifier hs-var">hasContiguousPerm</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360654"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; Bool
forall num. IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#hasContiguousPerm"><span class="hs-identifier hs-var">hasContiguousPerm</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360658"><span class="hs-identifier hs-var">new_base</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-758"></span><span>        </span><span class="hs-comment">-- We need the permutations to be of the same size if we want to compose</span><span>
</span><span id="line-759"></span><span>        </span><span class="hs-comment">-- them.  They don't have to be of the same size if the ixfun has a trivial</span><span>
</span><span id="line-760"></span><span>        </span><span class="hs-comment">-- permutation.  Supporting this latter case allows us to rebase when ixfun</span><span>
</span><span id="line-761"></span><span>        </span><span class="hs-comment">-- has been created by slicing with fixed dimensions.</span><span>
</span><span id="line-762"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Permutation -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360646"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360645"><span class="hs-identifier hs-var">perm_base</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; Bool
forall num. IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#hasContiguousPerm"><span class="hs-identifier hs-var">hasContiguousPerm</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360654"><span class="hs-identifier hs-var">ixfun</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-763"></span><span>        </span><span class="hs-comment">-- To not have to worry about ixfun having non-1 strides, we also check that</span><span>
</span><span id="line-764"></span><span>        </span><span class="hs-comment">-- it is a row-major array (modulo permutation, which is handled</span><span>
</span><span id="line-765"></span><span>        </span><span class="hs-comment">-- separately).  Accept a non-full innermost dimension.  XXX: Maybe this can</span><span>
</span><span id="line-766"></span><span>        </span><span class="hs-comment">-- be less conservative?</span><span>
</span><span id="line-767"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; Bool
forall (t :: * -&gt; *). Foldable t =&gt; t Bool -&gt; Bool
</span><span class="hs-identifier hs-var">and</span></span><span>
</span><span id="line-768"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">(num -&gt; LMADDim num -&gt; Bool -&gt; Bool)
-&gt; Shape num -&gt; [LMADDim num] -&gt; [Bool] -&gt; [Bool]
forall a b c d. (a -&gt; b -&gt; c -&gt; d) -&gt; [a] -&gt; [b] -&gt; [c] -&gt; [d]
</span><span class="hs-identifier hs-var">zipWith3</span></span><span>
</span><span id="line-769"></span><span>              </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684360643"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360643"><span class="hs-identifier hs-var">sn</span></a></span></span><span> </span><span id="local-6989586621684360642"><span class="annot"><span class="annottext">LMADDim num
</span><a href="#local-6989586621684360642"><span class="hs-identifier hs-var">ld</span></a></span></span><span> </span><span id="local-6989586621684360641"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360641"><span class="hs-identifier hs-var">inner</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360643"><span class="hs-identifier hs-var">sn</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; num
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldShape"><span class="hs-identifier hs-var hs-var">ldShape</span></a></span><span> </span><span class="annot"><span class="annottext">LMADDim num
</span><a href="#local-6989586621684360642"><span class="hs-identifier hs-var">ld</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360641"><span class="hs-identifier hs-var">inner</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; num
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldStride"><span class="hs-identifier hs-var hs-var">ldStride</span></a></span><span> </span><span class="annot"><span class="annottext">LMADDim num
</span><a href="#local-6989586621684360642"><span class="hs-identifier hs-var">ld</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-770"></span><span>              </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360652"><span class="hs-identifier hs-var">shp</span></a></span><span>
</span><span id="line-771"></span><span>              </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360647"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-772"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Bool -&gt; [Bool]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360647"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="annot"><span class="annottext">[Bool] -&gt; [Bool] -&gt; [Bool]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-773"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-774"></span><span>
</span><span id="line-775"></span><span>    </span><span class="hs-comment">-- Compose permutations, reverse strides and adjust offset if necessary.</span><span>
</span><span id="line-776"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360640"><span class="annot"><span class="annottext">perm_base' :: Permutation
</span><a href="#local-6989586621684360640"><span class="hs-identifier hs-var hs-var">perm_base'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-777"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; Bool
forall num. IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#hasContiguousPerm"><span class="hs-identifier hs-var">hasContiguousPerm</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360654"><span class="hs-identifier hs-var">ixfun</span></a></span><span>
</span><span id="line-778"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360645"><span class="hs-identifier hs-var">perm_base</span></a></span><span>
</span><span id="line-779"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; Permutation -&gt; Permutation
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360646"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; Int -&gt; Int
forall a. [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360645"><span class="hs-identifier hs-var">perm_base</span></a></span><span>
</span><span id="line-780"></span><span>        </span><span id="local-6989586621684360639"><span class="annot"><span class="annottext">lmad_base' :: LMAD num
</span><a href="#local-6989586621684360639"><span class="hs-identifier hs-var hs-var">lmad_base'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; LMAD num -&gt; LMAD num
forall num. Permutation -&gt; LMAD num -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#setLMADPermutation"><span class="hs-identifier hs-var">setLMADPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360640"><span class="hs-identifier hs-var">perm_base'</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360657"><span class="hs-identifier hs-var">lmad_base</span></a></span><span>
</span><span id="line-781"></span><span>        </span><span id="local-6989586621684360638"><span class="annot"><span class="annottext">dims_base :: [LMADDim num]
</span><a href="#local-6989586621684360638"><span class="hs-identifier hs-var hs-var">dims_base</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMADDim num]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360639"><span class="hs-identifier hs-var">lmad_base'</span></a></span><span>
</span><span id="line-782"></span><span>        </span><span id="local-6989586621684360634"><span class="annot"><span class="annottext">n_fewer_dims :: Int
</span><a href="#local-6989586621684360634"><span class="hs-identifier hs-var hs-var">n_fewer_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360638"><span class="hs-identifier hs-var">dims_base</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360647"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-783"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684360632"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360632"><span class="hs-identifier hs-var">dims_base'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360631"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360631"><span class="hs-identifier hs-var">offs_contrib</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-784"></span><span>          </span><span class="annot"><span class="annottext">[(LMADDim num, num)] -&gt; ([LMADDim num], Shape num)
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(LMADDim num, num)] -&gt; ([LMADDim num], Shape num))
-&gt; [(LMADDim num, num)] -&gt; ([LMADDim num], Shape num)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-785"></span><span>            </span><span class="annot"><span class="annottext">(LMADDim num -&gt; LMADDim num -&gt; (LMADDim num, num))
-&gt; [LMADDim num] -&gt; [LMADDim num] -&gt; [(LMADDim num, num)]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span>
</span><span id="line-786"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span id="local-6989586621684360630"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360630"><span class="hs-identifier hs-var">s1</span></a></span></span><span> </span><span id="local-6989586621684360629"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360629"><span class="hs-identifier hs-var">r1</span></a></span></span><span> </span><span id="local-6989586621684360628"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360628"><span class="hs-identifier hs-var">n1</span></a></span></span><span> </span><span id="local-6989586621684360627"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360627"><span class="hs-identifier hs-var">p1</span></a></span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684360626"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360626"><span class="hs-identifier hs-var">r2</span></a></span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684360625"><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360625"><span class="hs-identifier hs-var">m2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-787"></span><span>                  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360616"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360616"><span class="hs-identifier hs-var">s'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360615"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360615"><span class="hs-identifier hs-var">off'</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-788"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360625"><span class="hs-identifier hs-var">m2</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity -&gt; Monotonicity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360630"><span class="hs-identifier hs-var">s1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span>
</span><span id="line-789"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360630"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360630"><span class="hs-identifier hs-var">s1</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360628"><span class="hs-identifier hs-var">n1</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-790"></span><span>                      </span><span id="local-6989586621684360603"><span class="annot"><span class="annottext">r' :: num
</span><a href="#local-6989586621684360603"><span class="hs-identifier hs-var hs-var">r'</span></a></span></span><span>
</span><span id="line-791"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360625"><span class="hs-identifier hs-var">m2</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity -&gt; Monotonicity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360626"><span class="hs-identifier hs-var">r2</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360629"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360629"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360626"><span class="hs-identifier hs-var">r2</span></a></span><span>
</span><span id="line-792"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360629"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360626"><span class="hs-identifier hs-var">r2</span></a></span><span>
</span><span id="line-793"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360626"><span class="hs-identifier hs-var">r2</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360628"><span class="hs-identifier hs-var">n1</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360629"><span class="hs-identifier hs-var">r1</span></a></span><span>
</span><span id="line-794"></span><span>                        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360628"><span class="hs-identifier hs-var">n1</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360629"><span class="hs-identifier hs-var">r1</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360626"><span class="hs-identifier hs-var">r2</span></a></span><span>
</span><span id="line-795"></span><span>                   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360616"><span class="hs-identifier hs-var">s'</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360603"><span class="hs-identifier hs-var">r'</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360628"><span class="hs-identifier hs-var">n1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360627"><span class="hs-identifier hs-var">p1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360634"><span class="hs-identifier hs-var">n_fewer_dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360615"><span class="hs-identifier hs-var">off'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-796"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-797"></span><span>              </span><span class="hs-comment">-- If @dims@ is morally a slice, it might have fewer dimensions than</span><span>
</span><span id="line-798"></span><span>              </span><span class="hs-comment">-- @dims_base@.  Drop extraneous outer dimensions.</span><span>
</span><span id="line-799"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [LMADDim num] -&gt; [LMADDim num]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360634"><span class="hs-identifier hs-var">n_fewer_dims</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360638"><span class="hs-identifier hs-var">dims_base</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-800"></span><span>              </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360647"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-801"></span><span>        </span><span id="local-6989586621684360599"><span class="annot"><span class="annottext">off_base :: num
</span><a href="#local-6989586621684360599"><span class="hs-identifier hs-var hs-var">off_base</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; num
forall num. LMAD num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadOffset"><span class="hs-identifier hs-var hs-var">lmadOffset</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360639"><span class="hs-identifier hs-var">lmad_base'</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Shape num -&gt; num
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><span class="hs-identifier hs-var">sum</span></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360631"><span class="hs-identifier hs-var">offs_contrib</span></a></span><span>
</span><span id="line-802"></span><span>        </span><span id="local-6989586621684360592"><span class="annot"><span class="annottext">lmad_base'' :: LMAD num
</span><a href="#local-6989586621684360592"><span class="hs-identifier hs-var hs-var">lmad_base''</span></a></span></span><span>
</span><span id="line-803"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; num
forall num. LMAD num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadOffset"><span class="hs-identifier hs-var hs-var">lmadOffset</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360650"><span class="hs-identifier hs-var">lmad</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360599"><span class="hs-identifier hs-var">off_base</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360632"><span class="hs-identifier hs-var">dims_base'</span></a></span><span>
</span><span id="line-804"></span><span>          </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-805"></span><span>            </span><span class="hs-comment">-- If the innermost dimension of the ixfun was not full (but still</span><span>
</span><span id="line-806"></span><span>            </span><span class="hs-comment">-- had a stride of 1), add its offset relative to the new base.</span><span>
</span><span id="line-807"></span><span>            </span><span class="annot"><span class="annottext">Shape num -&gt; LMAD num -&gt; LMAD num
forall num. Shape num -&gt; LMAD num -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#setLMADShape"><span class="hs-identifier hs-var">setLMADShape</span></a></span><span>
</span><span id="line-808"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num -&gt; Shape num
forall num. (Eq num, IntegralExp num) =&gt; LMAD num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadShape"><span class="hs-identifier hs-var">lmadShape</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360650"><span class="hs-identifier hs-var">lmad</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-809"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span>
</span><span id="line-810"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360599"><span class="hs-identifier hs-var">off_base</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; num
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldStride"><span class="hs-identifier hs-var hs-var">ldStride</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[LMADDim num] -&gt; LMADDim num
forall a. [a] -&gt; a
</span><span class="hs-identifier hs-var">last</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360638"><span class="hs-identifier hs-var">dims_base</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; num
forall num. LMAD num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadOffset"><span class="hs-identifier hs-var hs-var">lmadOffset</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360650"><span class="hs-identifier hs-var">lmad</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-811"></span><span>                  </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360632"><span class="hs-identifier hs-var">dims_base'</span></a></span><span>
</span><span id="line-812"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-813"></span><span>        </span><span id="local-6989586621684360590"><span class="annot"><span class="annottext">new_base' :: IxFun num
</span><a href="#local-6989586621684360590"><span class="hs-identifier hs-var hs-var">new_base'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360592"><span class="hs-identifier hs-var">lmad_base''</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; NonEmpty (LMAD num)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360656"><span class="hs-identifier hs-var">lmads_base</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360652"><span class="hs-identifier hs-var">shp</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360655"><span class="hs-identifier hs-var">cg_base</span></a></span><span>
</span><span id="line-814"></span><span>        </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span id="local-6989586621684360589"><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684360589"><span class="hs-identifier hs-var">lmads_base'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360590"><span class="hs-identifier hs-var">new_base'</span></a></span><span>
</span><span id="line-815"></span><span>        </span><span id="local-6989586621684360588"><span class="annot"><span class="annottext">lmads'' :: NonEmpty (LMAD num)
</span><a href="#local-6989586621684360588"><span class="hs-identifier hs-var hs-var">lmads''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360649"><span class="hs-identifier hs-var">lmads'</span></a></span><span> </span><span class="annot"><span class="annottext">[LMAD num] -&gt; NonEmpty (LMAD num) -&gt; NonEmpty (LMAD num)
forall a. [a] -&gt; NonEmpty a -&gt; NonEmpty a
</span><a href="Futhark.IR.Mem.IxFun.html#%2B%2B%40"><span class="hs-operator hs-var">++@</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684360589"><span class="hs-identifier hs-var">lmads_base'</span></a></span><span>
</span><span id="line-816"></span><span>    </span><span class="annot"><span class="annottext">IxFun num -&gt; Maybe (IxFun num)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(IxFun num -&gt; Maybe (IxFun num)) -&gt; IxFun num -&gt; Maybe (IxFun num)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684360588"><span class="hs-identifier hs-var">lmads''</span></a></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360652"><span class="hs-identifier hs-var">shp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360651"><span class="hs-identifier hs-var">cg</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360655"><span class="hs-identifier hs-var">cg_base</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-817"></span><span>
</span><span id="line-818"></span><span class="hs-comment">-- | Rebase an index function on top of a new base.</span><span>
</span><span id="line-819"></span><span id="local-6989586621684362121"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#rebase"><span class="hs-identifier hs-type">rebase</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-820"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362121"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362121"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-821"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362121"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-822"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362121"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-823"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362121"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-824"></span><span id="rebase"><span class="annot"><span class="annottext">rebase :: forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; IxFun num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#rebase"><span class="hs-identifier hs-var hs-var">rebase</span></a></span></span><span> </span><span id="local-6989586621684360583"><span class="annot"><span class="annottext">new_base :: IxFun num
</span><a href="#local-6989586621684360583"><span class="hs-identifier hs-var">new_base</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span id="local-6989586621684360582"><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684360582"><span class="hs-identifier hs-var">lmads_base</span></a></span></span><span> </span><span id="local-6989586621684360581"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360581"><span class="hs-identifier hs-var">shp_base</span></a></span></span><span> </span><span id="local-6989586621684360580"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360580"><span class="hs-identifier hs-var">cg_base</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360579"><span class="annot"><span class="annottext">ixfun :: IxFun num
</span><a href="#local-6989586621684360579"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span id="local-6989586621684360578"><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684360578"><span class="hs-identifier hs-var">lmads</span></a></span></span><span> </span><span id="local-6989586621684360577"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360577"><span class="hs-identifier hs-var">shp</span></a></span></span><span> </span><span id="local-6989586621684360576"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360576"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-825"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684360575"><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360575"><span class="hs-identifier hs-var">ixfun'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; IxFun num -&gt; Maybe (IxFun num)
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; IxFun num -&gt; Maybe (IxFun num)
</span><a href="Futhark.IR.Mem.IxFun.html#rebaseNice"><span class="hs-identifier hs-var">rebaseNice</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360583"><span class="hs-identifier hs-var">new_base</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360579"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360575"><span class="hs-identifier hs-var">ixfun'</span></a></span><span>
</span><span id="line-826"></span><span>  </span><span class="hs-comment">-- In the general case just concatenate LMADs since this refers to index</span><span>
</span><span id="line-827"></span><span>  </span><span class="hs-comment">-- function composition, which is always safe.</span><span>
</span><span id="line-828"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-829"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360570"><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684360570"><span class="hs-identifier hs-var">lmads_base'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360569"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360569"><span class="hs-identifier hs-var">shp_base'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-830"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; Shape num
forall num. IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#base"><span class="hs-identifier hs-var hs-var">base</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360579"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">Shape num -&gt; Shape num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; Shape num
forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#shape"><span class="hs-identifier hs-var">shape</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360583"><span class="hs-identifier hs-var">new_base</span></a></span><span>
</span><span id="line-831"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684360582"><span class="hs-identifier hs-var">lmads_base</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360581"><span class="hs-identifier hs-var">shp_base</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-832"></span><span>            </span><span class="hs-keyword">else</span><span>
</span><span id="line-833"></span><span>              </span><span class="hs-keyword">let</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span id="local-6989586621684360566"><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684360566"><span class="hs-identifier hs-var">lmads'</span></a></span></span><span> </span><span id="local-6989586621684360565"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360565"><span class="hs-identifier hs-var">shp_base''</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; ShapeChange num -&gt; IxFun num
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; ShapeChange num -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#reshape"><span class="hs-identifier hs-var">reshape</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360583"><span class="hs-identifier hs-var">new_base</span></a></span><span> </span><span class="annot"><span class="annottext">(ShapeChange num -&gt; IxFun num) -&gt; ShapeChange num -&gt; IxFun num
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(num -&gt; DimChange num) -&gt; Shape num -&gt; ShapeChange num
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; DimChange num
forall d. d -&gt; DimChange d
</span><a href="Futhark.IR.Syntax.html#DimCoercion"><span class="hs-identifier hs-var">DimCoercion</span></a></span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360577"><span class="hs-identifier hs-var">shp</span></a></span><span>
</span><span id="line-834"></span><span>               </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684360566"><span class="hs-identifier hs-var">lmads'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360565"><span class="hs-identifier hs-var">shp_base''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-835"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684360578"><span class="hs-identifier hs-var">lmads</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; NonEmpty (LMAD num) -&gt; NonEmpty (LMAD num)
forall a. NonEmpty a -&gt; NonEmpty a -&gt; NonEmpty a
</span><a href="Futhark.IR.Mem.IxFun.html#%40%2B%2B%40"><span class="hs-operator hs-var">@++@</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num)
</span><a href="#local-6989586621684360570"><span class="hs-identifier hs-var">lmads_base'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360569"><span class="hs-identifier hs-var">shp_base'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360576"><span class="hs-identifier hs-var">cg</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360580"><span class="hs-identifier hs-var">cg_base</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-836"></span><span>
</span><span id="line-837"></span><span id="local-6989586621684362118"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#ixfunMonotonicity"><span class="hs-identifier hs-type">ixfunMonotonicity</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362118"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362118"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362118"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Monotonicity"><span class="hs-identifier hs-type">Monotonicity</span></a></span></span><span>
</span><span id="line-838"></span><span id="ixfunMonotonicity"><span class="annot"><span class="annottext">ixfunMonotonicity :: forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunMonotonicity"><span class="hs-identifier hs-var hs-var">ixfunMonotonicity</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; IxFun num -&gt; Monotonicity
forall num.
(Eq num, IntegralExp num) =&gt;
Bool -&gt; IxFun num -&gt; Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunMonotonicityRots"><span class="hs-identifier hs-var">ixfunMonotonicityRots</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-839"></span><span>
</span><span id="line-840"></span><span class="hs-comment">-- | If the memory support of the index function is contiguous and row-major</span><span>
</span><span id="line-841"></span><span class="hs-comment">-- (i.e., no transpositions, repetitions, rotates, etc.), then this should</span><span>
</span><span id="line-842"></span><span class="hs-comment">-- return the offset from which the memory-support of this index function</span><span>
</span><span id="line-843"></span><span class="hs-comment">-- starts.</span><span>
</span><span id="line-844"></span><span id="local-6989586621684362116"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#linearWithOffset"><span class="hs-identifier hs-type">linearWithOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-845"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362116"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362116"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-846"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362116"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-847"></span><span>  </span><span class="annot"><a href="#local-6989586621684362116"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-848"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621684362116"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-849"></span><span id="linearWithOffset"><span class="annot"><span class="annottext">linearWithOffset :: forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; num -&gt; Maybe num
</span><a href="Futhark.IR.Mem.IxFun.html#linearWithOffset"><span class="hs-identifier hs-var hs-var">linearWithOffset</span></a></span></span><span> </span><span id="local-6989586621684360552"><span class="annot"><span class="annottext">ixfun :: IxFun num
</span><a href="#local-6989586621684360552"><span class="hs-identifier hs-var">ixfun</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360551"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360551"><span class="hs-identifier hs-var">lmad</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684360550"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360550"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360549"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360549"><span class="hs-identifier hs-var">elem_size</span></a></span></span><span>
</span><span id="line-850"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; Bool
forall num. IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#hasContiguousPerm"><span class="hs-identifier hs-var">hasContiguousPerm</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360552"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360550"><span class="hs-identifier hs-var">cg</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; Monotonicity
forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunMonotonicity"><span class="hs-identifier hs-var">ixfunMonotonicity</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360552"><span class="hs-identifier hs-var">ixfun</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity -&gt; Monotonicity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-851"></span><span>    </span><span class="annot"><span class="annottext">num -&gt; Maybe num
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(num -&gt; Maybe num) -&gt; num -&gt; Maybe num
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; num
forall num. LMAD num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadOffset"><span class="hs-identifier hs-var hs-var">lmadOffset</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360551"><span class="hs-identifier hs-var">lmad</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360549"><span class="hs-identifier hs-var">elem_size</span></a></span><span>
</span><span id="line-852"></span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#linearWithOffset"><span class="hs-identifier hs-var">linearWithOffset</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe num
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-853"></span><span>
</span><span id="line-854"></span><span class="hs-comment">-- | Similar restrictions to @linearWithOffset@ except for transpositions, which</span><span>
</span><span id="line-855"></span><span class="hs-comment">-- are returned together with the offset.</span><span>
</span><span id="line-856"></span><span id="local-6989586621684362114"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#rearrangeWithOffset"><span class="hs-identifier hs-type">rearrangeWithOffset</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-857"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362114"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362114"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-858"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362114"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-859"></span><span>  </span><span class="annot"><a href="#local-6989586621684362114"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-860"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684362114"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684362114"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-861"></span><span id="rearrangeWithOffset"><span class="annot"><span class="annottext">rearrangeWithOffset :: forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; num -&gt; Maybe (num, [(Int, num)])
</span><a href="Futhark.IR.Mem.IxFun.html#rearrangeWithOffset"><span class="hs-identifier hs-var hs-var">rearrangeWithOffset</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360540"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360540"><span class="hs-identifier hs-var">lmad</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360539"><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360539"><span class="hs-identifier hs-var">oshp</span></a></span></span><span> </span><span id="local-6989586621684360538"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360538"><span class="hs-identifier hs-var">cg</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360537"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360537"><span class="hs-identifier hs-var">elem_size</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-862"></span><span>  </span><span class="hs-comment">-- Note that @cg@ describes whether the index function is</span><span>
</span><span id="line-863"></span><span>  </span><span class="hs-comment">-- contiguous, *ignoring permutations*.  This function requires that</span><span>
</span><span id="line-864"></span><span>  </span><span class="hs-comment">-- functionality.</span><span>
</span><span id="line-865"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360536"><span class="annot"><span class="annottext">perm :: Permutation
</span><a href="#local-6989586621684360536"><span class="hs-identifier hs-var hs-var">perm</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Permutation
forall num. LMAD num -&gt; Permutation
</span><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-var">lmadPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360540"><span class="hs-identifier hs-var">lmad</span></a></span><span>
</span><span id="line-866"></span><span>      </span><span id="local-6989586621684360530"><span class="annot"><span class="annottext">perm_contig :: Permutation
</span><a href="#local-6989586621684360530"><span class="hs-identifier hs-var hs-var">perm_contig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360536"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-867"></span><span>  </span><span id="local-6989586621684360529"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360529"><span class="hs-identifier hs-var">offset</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-868"></span><span>    </span><span class="annot"><span class="annottext">IxFun num -&gt; num -&gt; Maybe num
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; num -&gt; Maybe num
</span><a href="Futhark.IR.Mem.IxFun.html#linearWithOffset"><span class="hs-identifier hs-var">linearWithOffset</span></a></span><span>
</span><span id="line-869"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Permutation -&gt; LMAD num -&gt; LMAD num
forall num. Permutation -&gt; LMAD num -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#setLMADPermutation"><span class="hs-identifier hs-var">setLMADPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360530"><span class="hs-identifier hs-var">perm_contig</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360540"><span class="hs-identifier hs-var">lmad</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMAD num] -&gt; NonEmpty (LMAD num)
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><a href="#local-6989586621684360539"><span class="hs-identifier hs-var">oshp</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360538"><span class="hs-identifier hs-var">cg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-870"></span><span>      </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360537"><span class="hs-identifier hs-var">elem_size</span></a></span><span>
</span><span id="line-871"></span><span>  </span><span class="annot"><span class="annottext">(num, [(Int, num)]) -&gt; Maybe (num, [(Int, num)])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360529"><span class="hs-identifier hs-var">offset</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; Shape num -&gt; [(Int, num)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360536"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Permutation -&gt; Shape num -&gt; Shape num
forall a. Permutation -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Mem.IxFun.html#permuteFwd"><span class="hs-identifier hs-var">permuteFwd</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360536"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num -&gt; Shape num
forall num. (Eq num, IntegralExp num) =&gt; LMAD num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadShapeBase"><span class="hs-identifier hs-var">lmadShapeBase</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360540"><span class="hs-identifier hs-var">lmad</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-872"></span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#rearrangeWithOffset"><span class="hs-identifier hs-var">rearrangeWithOffset</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (num, [(Int, num)])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-873"></span><span>
</span><span id="line-874"></span><span class="hs-comment">-- | Is this a row-major array starting at offset zero?</span><span>
</span><span id="line-875"></span><span id="local-6989586621684360528"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#isLinear"><span class="hs-identifier hs-type">isLinear</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684360528"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684360528"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684360528"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-876"></span><span id="isLinear"><span class="annot"><span class="annottext">isLinear :: forall num. (Eq num, IntegralExp num) =&gt; IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#isLinear"><span class="hs-identifier hs-var hs-var">isLinear</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe num -&gt; Maybe num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; Maybe num
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe num -&gt; Bool)
-&gt; (IxFun num -&gt; Maybe num) -&gt; IxFun num -&gt; Bool
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(IxFun num -&gt; num -&gt; Maybe num) -&gt; num -&gt; IxFun num -&gt; Maybe num
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">IxFun num -&gt; num -&gt; Maybe num
forall num.
(Eq num, IntegralExp num) =&gt;
IxFun num -&gt; num -&gt; Maybe num
</span><a href="Futhark.IR.Mem.IxFun.html#linearWithOffset"><span class="hs-identifier hs-var">linearWithOffset</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span>
</span><span id="line-877"></span><span>
</span><span id="line-878"></span><span id="local-6989586621684360516"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#permuteFwd"><span class="hs-identifier hs-type">permuteFwd</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Permutation"><span class="hs-identifier hs-type">Permutation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684360516"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684360516"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-879"></span><span id="permuteFwd"><span class="annot"><span class="annottext">permuteFwd :: forall a. Permutation -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Mem.IxFun.html#permuteFwd"><span class="hs-identifier hs-var hs-var">permuteFwd</span></a></span></span><span> </span><span id="local-6989586621684360515"><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360515"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621684360514"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684360514"><span class="hs-identifier hs-var">elems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; a) -&gt; Permutation -&gt; [a]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684360514"><span class="hs-identifier hs-var">elems</span></a></span><span> </span><span class="annot"><span class="annottext">[a] -&gt; Int -&gt; a
forall a. [a] -&gt; Int -&gt; a
</span><span class="hs-operator hs-var">!!</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360515"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-880"></span><span>
</span><span id="line-881"></span><span id="local-6989586621684362238"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#permuteInv"><span class="hs-identifier hs-type">permuteInv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Permutation"><span class="hs-identifier hs-type">Permutation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684362238"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="#local-6989586621684362238"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-882"></span><span id="permuteInv"><span class="annot"><span class="annottext">permuteInv :: forall a. Permutation -&gt; [a] -&gt; [a]
</span><a href="Futhark.IR.Mem.IxFun.html#permuteInv"><span class="hs-identifier hs-var hs-var">permuteInv</span></a></span></span><span> </span><span id="local-6989586621684360512"><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360512"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621684360511"><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684360511"><span class="hs-identifier hs-var">elems</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Int, a) -&gt; a) -&gt; [(Int, a)] -&gt; [a]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Int, a) -&gt; a
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">([(Int, a)] -&gt; [a]) -&gt; [(Int, a)] -&gt; [a]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Int, a) -&gt; (Int, a) -&gt; Ordering) -&gt; [(Int, a)] -&gt; [(Int, a)]
forall a. (a -&gt; a -&gt; Ordering) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortBy</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Ordering
forall a. Ord a =&gt; a -&gt; a -&gt; Ordering
</span><span class="hs-identifier hs-var">compare</span></span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Ordering)
-&gt; ((Int, a) -&gt; Int) -&gt; (Int, a) -&gt; (Int, a) -&gt; Ordering
forall b c a. (b -&gt; b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; a -&gt; c
</span><span class="hs-operator hs-var">`on`</span></span><span> </span><span class="annot"><span class="annottext">(Int, a) -&gt; Int
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Int, a)] -&gt; [(Int, a)]) -&gt; [(Int, a)] -&gt; [(Int, a)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; [a] -&gt; [(Int, a)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360512"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">[a]
</span><a href="#local-6989586621684360511"><span class="hs-identifier hs-var">elems</span></a></span><span>
</span><span id="line-883"></span><span>
</span><span id="line-884"></span><span id="local-6989586621684362228"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#flatOneDim"><span class="hs-identifier hs-type">flatOneDim</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-885"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362228"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362228"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-886"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684362228"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684362228"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684362228"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-887"></span><span>  </span><span class="annot"><a href="#local-6989586621684362228"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-888"></span><span>  </span><span class="annot"><a href="#local-6989586621684362228"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-889"></span><span id="flatOneDim"><span class="annot"><span class="annottext">flatOneDim :: forall num.
(Eq num, IntegralExp num) =&gt;
(num, num, num) -&gt; num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#flatOneDim"><span class="hs-identifier hs-var hs-var">flatOneDim</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360498"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360498"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360497"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360497"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360496"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360496"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360495"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360495"><span class="hs-identifier hs-var">i</span></a></span></span><span>
</span><span id="line-890"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360498"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span>
</span><span id="line-891"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360497"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360495"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360498"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-892"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360495"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360497"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall e. IntegralExp e =&gt; e -&gt; e -&gt; e
</span><a href="Futhark.Util.IntegralExp.html#mod"><span class="hs-operator hs-var">`mod`</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360496"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360498"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-893"></span><span>
</span><span id="line-894"></span><span class="hs-comment">-- | Generalised iota with user-specified offset and rotates.</span><span>
</span><span id="line-895"></span><span id="local-6989586621684362224"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#makeRotIota"><span class="hs-identifier hs-type">makeRotIota</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-896"></span><span>  </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362224"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-897"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Monotonicity"><span class="hs-identifier hs-type">Monotonicity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-898"></span><span>  </span><span class="hs-comment">-- | Offset</span><span>
</span><span id="line-899"></span><span>  </span><span class="annot"><a href="#local-6989586621684362224"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-900"></span><span>  </span><span class="hs-comment">-- | Pairs of shape and rotation</span><span>
</span><span id="line-901"></span><span>  </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684362224"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="#local-6989586621684362224"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-902"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362224"><span class="hs-identifier hs-type">num</span></a></span></span><span>
</span><span id="line-903"></span><span id="makeRotIota"><span class="annot"><span class="annottext">makeRotIota :: forall num.
IntegralExp num =&gt;
Monotonicity -&gt; num -&gt; [(num, num)] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#makeRotIota"><span class="hs-identifier hs-var hs-var">makeRotIota</span></a></span></span><span> </span><span id="local-6989586621684360487"><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360487"><span class="hs-identifier hs-var">mon</span></a></span></span><span> </span><span id="local-6989586621684360486"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360486"><span class="hs-identifier hs-var">off</span></a></span></span><span> </span><span id="local-6989586621684360485"><span class="annot"><span class="annottext">[(num, num)]
</span><a href="#local-6989586621684360485"><span class="hs-identifier hs-var">support</span></a></span></span><span>
</span><span id="line-904"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360487"><span class="hs-identifier hs-var">mon</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity -&gt; Monotonicity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360487"><span class="hs-identifier hs-var">mon</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity -&gt; Monotonicity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Dec"><span class="hs-identifier hs-var">Dec</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-905"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360483"><span class="annot"><span class="annottext">rk :: Int
</span><a href="#local-6989586621684360483"><span class="hs-identifier hs-var hs-var">rk</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(num, num)] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[(num, num)]
</span><a href="#local-6989586621684360485"><span class="hs-identifier hs-var">support</span></a></span><span>
</span><span id="line-906"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684360482"><span class="annot"><span class="annottext">[num]
</span><a href="#local-6989586621684360482"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360481"><span class="annot"><span class="annottext">[num]
</span><a href="#local-6989586621684360481"><span class="hs-identifier hs-var">ns</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(num, num)] -&gt; ([num], [num])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(num, num)]
</span><a href="#local-6989586621684360485"><span class="hs-identifier hs-var">support</span></a></span><span>
</span><span id="line-907"></span><span>        </span><span id="local-6989586621684360478"><span class="annot"><span class="annottext">ss0 :: [num]
</span><a href="#local-6989586621684360478"><span class="hs-identifier hs-var hs-var">ss0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[num] -&gt; [num]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">([num] -&gt; [num]) -&gt; [num] -&gt; [num]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; [num] -&gt; [num]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360483"><span class="hs-identifier hs-var">rk</span></a></span><span> </span><span class="annot"><span class="annottext">([num] -&gt; [num]) -&gt; [num] -&gt; [num]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(num -&gt; num -&gt; num) -&gt; num -&gt; [num] -&gt; [num]
forall b a. (b -&gt; a -&gt; b) -&gt; b -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">scanl</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">(*)</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">([num] -&gt; [num]) -&gt; [num] -&gt; [num]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[num] -&gt; [num]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[num]
</span><a href="#local-6989586621684360481"><span class="hs-identifier hs-var">ns</span></a></span><span>
</span><span id="line-908"></span><span>        </span><span id="local-6989586621684360473"><span class="annot"><span class="annottext">ss :: [num]
</span><a href="#local-6989586621684360473"><span class="hs-identifier hs-var hs-var">ss</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-909"></span><span>          </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360487"><span class="hs-identifier hs-var">mon</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity -&gt; Monotonicity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span>
</span><span id="line-910"></span><span>            </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[num]
</span><a href="#local-6989586621684360478"><span class="hs-identifier hs-var">ss0</span></a></span><span>
</span><span id="line-911"></span><span>            </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(num -&gt; num) -&gt; [num] -&gt; [num]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">num -&gt; num -&gt; num
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">*</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">-</span><span class="annot"><span class="annottext">num
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[num]
</span><a href="#local-6989586621684360478"><span class="hs-identifier hs-var">ss0</span></a></span><span>
</span><span id="line-912"></span><span>        </span><span id="local-6989586621684360465"><span class="annot"><span class="annottext">ps :: Permutation
</span><a href="#local-6989586621684360465"><span class="hs-identifier hs-var hs-var">ps</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Int -&gt; Int) -&gt; Permutation -&gt; Permutation
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360483"><span class="hs-identifier hs-var">rk</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">]</span><span>
</span><span id="line-913"></span><span>        </span><span id="local-6989586621684360464"><span class="annot"><span class="annottext">fi :: [Monotonicity]
</span><a href="#local-6989586621684360464"><span class="hs-identifier hs-var hs-var">fi</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Monotonicity -&gt; [Monotonicity]
forall a. Int -&gt; a -&gt; [a]
</span><span class="hs-identifier hs-var">replicate</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360483"><span class="hs-identifier hs-var">rk</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360487"><span class="hs-identifier hs-var">mon</span></a></span><span>
</span><span id="line-914"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">num -&gt; [LMADDim num] -&gt; LMAD num
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360486"><span class="hs-identifier hs-var">off</span></a></span><span> </span><span class="annot"><span class="annottext">([LMADDim num] -&gt; LMAD num) -&gt; [LMADDim num] -&gt; LMAD num
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num)
-&gt; [num]
-&gt; [num]
-&gt; [num]
-&gt; Permutation
-&gt; [Monotonicity]
-&gt; [LMADDim num]
forall a b c d e f.
(a -&gt; b -&gt; c -&gt; d -&gt; e -&gt; f)
-&gt; [a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [e] -&gt; [f]
</span><span class="hs-identifier hs-var">zipWith5</span></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">[num]
</span><a href="#local-6989586621684360473"><span class="hs-identifier hs-var">ss</span></a></span><span> </span><span class="annot"><span class="annottext">[num]
</span><a href="#local-6989586621684360482"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="annot"><span class="annottext">[num]
</span><a href="#local-6989586621684360481"><span class="hs-identifier hs-var">ns</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360465"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">[Monotonicity]
</span><a href="#local-6989586621684360464"><span class="hs-identifier hs-var">fi</span></a></span><span>
</span><span id="line-915"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; LMAD num
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;makeRotIota: requires Inc or Dec&quot;</span></span><span>
</span><span id="line-916"></span><span>
</span><span id="line-917"></span><span class="hs-comment">-- | Check monotonicity of an index function.</span><span>
</span><span id="line-918"></span><span id="local-6989586621684362147"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#ixfunMonotonicityRots"><span class="hs-identifier hs-type">ixfunMonotonicityRots</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-919"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362147"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362147"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-920"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-921"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362147"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-922"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Monotonicity"><span class="hs-identifier hs-type">Monotonicity</span></a></span></span><span>
</span><span id="line-923"></span><span id="ixfunMonotonicityRots"><span class="annot"><span class="annottext">ixfunMonotonicityRots :: forall num.
(Eq num, IntegralExp num) =&gt;
Bool -&gt; IxFun num -&gt; Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunMonotonicityRots"><span class="hs-identifier hs-var hs-var">ixfunMonotonicityRots</span></a></span></span><span> </span><span id="local-6989586621684360456"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360456"><span class="hs-identifier hs-var">ignore_rots</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360455"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360455"><span class="hs-identifier hs-var">lmad</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span id="local-6989586621684360454"><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360454"><span class="hs-identifier hs-var">lmads</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Shape num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-924"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360451"><span class="annot"><span class="annottext">mon0 :: Monotonicity
</span><a href="#local-6989586621684360451"><span class="hs-identifier hs-var hs-var">mon0</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Monotonicity
forall num. (Eq num, IntegralExp num) =&gt; LMAD num -&gt; Monotonicity
</span><a href="#local-6989586621684360450"><span class="hs-identifier hs-var">lmadMonotonicityRots</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360455"><span class="hs-identifier hs-var">lmad</span></a></span><span>
</span><span id="line-925"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">(LMAD num -&gt; Bool) -&gt; [LMAD num] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Monotonicity -&gt; Monotonicity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360451"><span class="hs-identifier hs-var">mon0</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Monotonicity -&gt; Bool)
-&gt; (LMAD num -&gt; Monotonicity) -&gt; LMAD num -&gt; Bool
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; Monotonicity
forall num. (Eq num, IntegralExp num) =&gt; LMAD num -&gt; Monotonicity
</span><a href="#local-6989586621684360450"><span class="hs-identifier hs-var">lmadMonotonicityRots</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LMAD num]
</span><a href="#local-6989586621684360454"><span class="hs-identifier hs-var">lmads</span></a></span><span>
</span><span id="line-926"></span><span>        </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360451"><span class="hs-identifier hs-var">mon0</span></a></span><span>
</span><span id="line-927"></span><span>        </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>
</span><span id="line-928"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-929"></span><span>    </span><span id="local-6989586621684362100"><span class="annot"><a href="#local-6989586621684360450"><span class="hs-identifier hs-type">lmadMonotonicityRots</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-930"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362100"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362100"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-931"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362100"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-932"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Monotonicity"><span class="hs-identifier hs-type">Monotonicity</span></a></span></span><span>
</span><span id="line-933"></span><span>    </span><span id="local-6989586621684360450"><span class="annot"><span class="annottext">lmadMonotonicityRots :: forall num. (Eq num, IntegralExp num) =&gt; LMAD num -&gt; Monotonicity
</span><a href="#local-6989586621684360450"><span class="hs-identifier hs-var hs-var">lmadMonotonicityRots</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684360441"><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360441"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-934"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; Bool) -&gt; [LMADDim num] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Monotonicity -&gt; LMADDim num -&gt; Bool
forall num.
(Eq num, IntegralExp num) =&gt;
Monotonicity -&gt; LMADDim num -&gt; Bool
</span><a href="#local-6989586621684360440"><span class="hs-identifier hs-var">isMonDim</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360441"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Inc"><span class="hs-identifier hs-var">Inc</span></a></span><span>
</span><span id="line-935"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; Bool) -&gt; [LMADDim num] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Monotonicity -&gt; LMADDim num -&gt; Bool
forall num.
(Eq num, IntegralExp num) =&gt;
Monotonicity -&gt; LMADDim num -&gt; Bool
</span><a href="#local-6989586621684360440"><span class="hs-identifier hs-var">isMonDim</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Dec"><span class="hs-identifier hs-var">Dec</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[LMADDim num]
</span><a href="#local-6989586621684360441"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Dec"><span class="hs-identifier hs-var">Dec</span></a></span><span>
</span><span id="line-936"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#Unknown"><span class="hs-identifier hs-var">Unknown</span></a></span><span>
</span><span id="line-937"></span><span>
</span><span id="line-938"></span><span>    </span><span id="local-6989586621684362098"><span class="annot"><a href="#local-6989586621684360440"><span class="hs-identifier hs-type">isMonDim</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-939"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362098"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Util.IntegralExp.html#IntegralExp"><span class="hs-identifier hs-type">IntegralExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362098"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-940"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#Monotonicity"><span class="hs-identifier hs-type">Monotonicity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-941"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362098"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-942"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-943"></span><span>    </span><span id="local-6989586621684360440"><span class="annot"><span class="annottext">isMonDim :: forall num.
(Eq num, IntegralExp num) =&gt;
Monotonicity -&gt; LMADDim num -&gt; Bool
</span><a href="#local-6989586621684360440"><span class="hs-identifier hs-var hs-var">isMonDim</span></a></span></span><span> </span><span id="local-6989586621684360431"><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360431"><span class="hs-identifier hs-var">mon</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span id="local-6989586621684360430"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360430"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684360429"><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360429"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684360428"><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360428"><span class="hs-identifier hs-var">ldmon</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-944"></span><span>      </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360430"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360456"><span class="hs-identifier hs-var">ignore_rots</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">||</span></span><span> </span><span class="annot"><span class="annottext">num
</span><a href="#local-6989586621684360429"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">num -&gt; num -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">num
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360431"><span class="hs-identifier hs-var">mon</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity -&gt; Monotonicity -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360428"><span class="hs-identifier hs-var">ldmon</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-945"></span><span>
</span><span id="line-946"></span><span class="hs-comment">-- | Generalization (anti-unification)</span><span>
</span><span id="line-947"></span><span class="hs-comment">--</span><span>
</span><span id="line-948"></span><span class="hs-comment">-- Anti-unification of two index functions is supported under the following conditions:</span><span>
</span><span id="line-949"></span><span class="hs-comment">--   0. Both index functions are represented by ONE lmad (assumed common case!)</span><span>
</span><span id="line-950"></span><span class="hs-comment">--   1. The support array of the two indexfuns have the same dimensionality</span><span>
</span><span id="line-951"></span><span class="hs-comment">--      (we can relax this condition if we use a 1D support, as we probably should!)</span><span>
</span><span id="line-952"></span><span class="hs-comment">--   2. The contiguous property and the per-dimension monotonicity are the same</span><span>
</span><span id="line-953"></span><span class="hs-comment">--      (otherwise we might loose important information; this can be relaxed!)</span><span>
</span><span id="line-954"></span><span class="hs-comment">--   3. Most importantly, both index functions correspond to the same permutation</span><span>
</span><span id="line-955"></span><span class="hs-comment">--      (since the permutation is represented by INTs, this restriction cannot</span><span>
</span><span id="line-956"></span><span class="hs-comment">--       be relaxed, unless we move to a gated-LMAD representation!)</span><span>
</span><span id="line-957"></span><span id="local-6989586621684362096"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#leastGeneralGeneralization"><span class="hs-identifier hs-type">leastGeneralGeneralization</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-958"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362096"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-959"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#PrimExp"><span class="hs-identifier hs-type">PrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362096"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-960"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#PrimExp"><span class="hs-identifier hs-type">PrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362096"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-961"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#PrimExp"><span class="hs-identifier hs-type">PrimExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362096"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#PrimExp"><span class="hs-identifier hs-type">PrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362096"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#PrimExp"><span class="hs-identifier hs-type">PrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362096"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-962"></span><span id="leastGeneralGeneralization"><span class="annot"><span class="annottext">leastGeneralGeneralization :: forall v.
Eq v =&gt;
IxFun (PrimExp v)
-&gt; IxFun (PrimExp v)
-&gt; Maybe (IxFun (PrimExp (Ext v)), [(PrimExp v, PrimExp v)])
</span><a href="Futhark.IR.Mem.IxFun.html#leastGeneralGeneralization"><span class="hs-identifier hs-var hs-var">leastGeneralGeneralization</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360404"><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360404"><span class="hs-identifier hs-var">lmad1</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360403"><span class="annot"><span class="annottext">Shape (PrimExp v)
</span><a href="#local-6989586621684360403"><span class="hs-identifier hs-var">oshp1</span></a></span></span><span> </span><span id="local-6989586621684360402"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360402"><span class="hs-identifier hs-var">ctg1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360401"><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360401"><span class="hs-identifier hs-var">lmad2</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360400"><span class="annot"><span class="annottext">Shape (PrimExp v)
</span><a href="#local-6989586621684360400"><span class="hs-identifier hs-var">oshp2</span></a></span></span><span> </span><span id="local-6989586621684360399"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360399"><span class="hs-identifier hs-var">ctg2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-963"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-964"></span><span>    </span><span class="annot"><span class="annottext">Shape (PrimExp v) -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Shape (PrimExp v)
</span><a href="#local-6989586621684360403"><span class="hs-identifier hs-var">oshp1</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Shape (PrimExp v) -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">Shape (PrimExp v)
</span><a href="#local-6989586621684360400"><span class="hs-identifier hs-var">oshp2</span></a></span><span>
</span><span id="line-965"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360402"><span class="hs-identifier hs-var">ctg1</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360399"><span class="hs-identifier hs-var">ctg2</span></a></span><span>
</span><span id="line-966"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim (PrimExp v) -&gt; Int)
-&gt; [LMADDim (PrimExp v)] -&gt; Permutation
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim (PrimExp v) -&gt; Int
forall num. LMADDim num -&gt; Int
</span><a href="Futhark.IR.Mem.IxFun.html#ldPerm"><span class="hs-identifier hs-var hs-var">ldPerm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD (PrimExp v) -&gt; [LMADDim (PrimExp v)]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360404"><span class="hs-identifier hs-var">lmad1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; Permutation -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim (PrimExp v) -&gt; Int)
-&gt; [LMADDim (PrimExp v)] -&gt; Permutation
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim (PrimExp v) -&gt; Int
forall num. LMADDim num -&gt; Int
</span><a href="Futhark.IR.Mem.IxFun.html#ldPerm"><span class="hs-identifier hs-var hs-var">ldPerm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD (PrimExp v) -&gt; [LMADDim (PrimExp v)]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360401"><span class="hs-identifier hs-var">lmad2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-967"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v) -&gt; [Monotonicity]
forall {num}. LMAD num -&gt; [Monotonicity]
</span><a href="#local-6989586621684360398"><span class="hs-identifier hs-var">lmadDMon</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360404"><span class="hs-identifier hs-var">lmad1</span></a></span><span> </span><span class="annot"><span class="annottext">[Monotonicity] -&gt; [Monotonicity] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v) -&gt; [Monotonicity]
forall {num}. LMAD num -&gt; [Monotonicity]
</span><a href="#local-6989586621684360398"><span class="hs-identifier hs-var">lmadDMon</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360401"><span class="hs-identifier hs-var">lmad2</span></a></span><span>
</span><span id="line-968"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360397"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360397"><span class="hs-identifier hs-var">ctg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360396"><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360396"><span class="hs-identifier hs-var">dperm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360395"><span class="annot"><span class="annottext">[Monotonicity]
</span><a href="#local-6989586621684360395"><span class="hs-identifier hs-var">dmon</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360402"><span class="hs-identifier hs-var">ctg1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v) -&gt; Permutation
forall num. LMAD num -&gt; Permutation
</span><a href="Futhark.IR.Mem.IxFun.html#lmadPermutation"><span class="hs-identifier hs-var">lmadPermutation</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360404"><span class="hs-identifier hs-var">lmad1</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v) -&gt; [Monotonicity]
forall {num}. LMAD num -&gt; [Monotonicity]
</span><a href="#local-6989586621684360398"><span class="hs-identifier hs-var">lmadDMon</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360404"><span class="hs-identifier hs-var">lmad1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-969"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684360394"><span class="annot"><span class="annottext">[PrimExp (Ext v)]
</span><a href="#local-6989586621684360394"><span class="hs-identifier hs-var">dshp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360393"><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360393"><span class="hs-identifier hs-var">m1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
-&gt; Shape (PrimExp v)
-&gt; Shape (PrimExp v)
-&gt; Maybe ([PrimExp (Ext v)], [(PrimExp v, PrimExp v)])
forall {m :: * -&gt; *} {v}.
(Monad m, Eq v) =&gt;
[(PrimExp v, PrimExp v)]
-&gt; [PrimExp v]
-&gt; [PrimExp v]
-&gt; m ([PrimExp (Ext v)], [(PrimExp v, PrimExp v)])
</span><a href="#local-6989586621684360392"><span class="hs-identifier hs-var">generalize</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD (PrimExp v) -&gt; Shape (PrimExp v)
forall a. LMAD a -&gt; [a]
</span><a href="#local-6989586621684360391"><span class="hs-identifier hs-var">lmadDShp</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360404"><span class="hs-identifier hs-var">lmad1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD (PrimExp v) -&gt; Shape (PrimExp v)
forall a. LMAD a -&gt; [a]
</span><a href="#local-6989586621684360391"><span class="hs-identifier hs-var">lmadDShp</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360401"><span class="hs-identifier hs-var">lmad2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-970"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684360390"><span class="annot"><span class="annottext">[PrimExp (Ext v)]
</span><a href="#local-6989586621684360390"><span class="hs-identifier hs-var">oshp</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360389"><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360389"><span class="hs-identifier hs-var">m2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
-&gt; Shape (PrimExp v)
-&gt; Shape (PrimExp v)
-&gt; Maybe ([PrimExp (Ext v)], [(PrimExp v, PrimExp v)])
forall {m :: * -&gt; *} {v}.
(Monad m, Eq v) =&gt;
[(PrimExp v, PrimExp v)]
-&gt; [PrimExp v]
-&gt; [PrimExp v]
-&gt; m ([PrimExp (Ext v)], [(PrimExp v, PrimExp v)])
</span><a href="#local-6989586621684360392"><span class="hs-identifier hs-var">generalize</span></a></span><span> </span><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360393"><span class="hs-identifier hs-var">m1</span></a></span><span> </span><span class="annot"><span class="annottext">Shape (PrimExp v)
</span><a href="#local-6989586621684360403"><span class="hs-identifier hs-var">oshp1</span></a></span><span> </span><span class="annot"><span class="annottext">Shape (PrimExp v)
</span><a href="#local-6989586621684360400"><span class="hs-identifier hs-var">oshp2</span></a></span><span>
</span><span id="line-971"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684360388"><span class="annot"><span class="annottext">[PrimExp (Ext v)]
</span><a href="#local-6989586621684360388"><span class="hs-identifier hs-var">dstd</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360387"><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360387"><span class="hs-identifier hs-var">m3</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
-&gt; Shape (PrimExp v)
-&gt; Shape (PrimExp v)
-&gt; Maybe ([PrimExp (Ext v)], [(PrimExp v, PrimExp v)])
forall {m :: * -&gt; *} {v}.
(Monad m, Eq v) =&gt;
[(PrimExp v, PrimExp v)]
-&gt; [PrimExp v]
-&gt; [PrimExp v]
-&gt; m ([PrimExp (Ext v)], [(PrimExp v, PrimExp v)])
</span><a href="#local-6989586621684360392"><span class="hs-identifier hs-var">generalize</span></a></span><span> </span><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360389"><span class="hs-identifier hs-var">m2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD (PrimExp v) -&gt; Shape (PrimExp v)
forall a. LMAD a -&gt; [a]
</span><a href="#local-6989586621684360386"><span class="hs-identifier hs-var">lmadDSrd</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360404"><span class="hs-identifier hs-var">lmad1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD (PrimExp v) -&gt; Shape (PrimExp v)
forall a. LMAD a -&gt; [a]
</span><a href="#local-6989586621684360386"><span class="hs-identifier hs-var">lmadDSrd</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360401"><span class="hs-identifier hs-var">lmad2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-972"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684360385"><span class="annot"><span class="annottext">[PrimExp (Ext v)]
</span><a href="#local-6989586621684360385"><span class="hs-identifier hs-var">drot</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360384"><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360384"><span class="hs-identifier hs-var">m4</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
-&gt; Shape (PrimExp v)
-&gt; Shape (PrimExp v)
-&gt; Maybe ([PrimExp (Ext v)], [(PrimExp v, PrimExp v)])
forall {m :: * -&gt; *} {v}.
(Monad m, Eq v) =&gt;
[(PrimExp v, PrimExp v)]
-&gt; [PrimExp v]
-&gt; [PrimExp v]
-&gt; m ([PrimExp (Ext v)], [(PrimExp v, PrimExp v)])
</span><a href="#local-6989586621684360392"><span class="hs-identifier hs-var">generalize</span></a></span><span> </span><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360387"><span class="hs-identifier hs-var">m3</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD (PrimExp v) -&gt; Shape (PrimExp v)
forall a. LMAD a -&gt; [a]
</span><a href="#local-6989586621684360383"><span class="hs-identifier hs-var">lmadDRot</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360404"><span class="hs-identifier hs-var">lmad1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD (PrimExp v) -&gt; Shape (PrimExp v)
forall a. LMAD a -&gt; [a]
</span><a href="#local-6989586621684360383"><span class="hs-identifier hs-var">lmadDRot</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360401"><span class="hs-identifier hs-var">lmad2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-973"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360381"><span class="annot"><span class="annottext">PrimExp (Ext v)
</span><a href="#local-6989586621684360381"><span class="hs-identifier hs-var">offt</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360380"><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360380"><span class="hs-identifier hs-var">m5</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
-&gt; PrimExp v
-&gt; PrimExp v
-&gt; (PrimExp (Ext v), [(PrimExp v, PrimExp v)])
forall v.
Eq v =&gt;
[(PrimExp v, PrimExp v)]
-&gt; PrimExp v
-&gt; PrimExp v
-&gt; (PrimExp (Ext v), [(PrimExp v, PrimExp v)])
</span><a href="Futhark.Analysis.PrimExp.Generalize.html#leastGeneralGeneralization"><span class="hs-identifier hs-var">PEG.leastGeneralGeneralization</span></a></span><span> </span><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360384"><span class="hs-identifier hs-var">m4</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD (PrimExp v) -&gt; PrimExp v
forall num. LMAD num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadOffset"><span class="hs-identifier hs-var hs-var">lmadOffset</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360404"><span class="hs-identifier hs-var">lmad1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD (PrimExp v) -&gt; PrimExp v
forall num. LMAD num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadOffset"><span class="hs-identifier hs-var hs-var">lmadOffset</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp v)
</span><a href="#local-6989586621684360401"><span class="hs-identifier hs-var">lmad2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-974"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360378"><span class="annot"><span class="annottext">lmad_dims :: [LMADDim (PrimExp (Ext v))]
</span><a href="#local-6989586621684360378"><span class="hs-identifier hs-var hs-var">lmad_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-975"></span><span>        </span><span class="annot"><span class="annottext">((PrimExp (Ext v), PrimExp (Ext v), PrimExp (Ext v), Int,
  Monotonicity)
 -&gt; LMADDim (PrimExp (Ext v)))
-&gt; [(PrimExp (Ext v), PrimExp (Ext v), PrimExp (Ext v), Int,
     Monotonicity)]
-&gt; [LMADDim (PrimExp (Ext v))]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684360377"><span class="annot"><span class="annottext">PrimExp (Ext v)
</span><a href="#local-6989586621684360377"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360376"><span class="annot"><span class="annottext">PrimExp (Ext v)
</span><a href="#local-6989586621684360376"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360375"><span class="annot"><span class="annottext">PrimExp (Ext v)
</span><a href="#local-6989586621684360375"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360374"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360374"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360373"><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360373"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PrimExp (Ext v)
-&gt; PrimExp (Ext v)
-&gt; PrimExp (Ext v)
-&gt; Int
-&gt; Monotonicity
-&gt; LMADDim (PrimExp (Ext v))
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp (Ext v)
</span><a href="#local-6989586621684360377"><span class="hs-identifier hs-var">a</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp (Ext v)
</span><a href="#local-6989586621684360376"><span class="hs-identifier hs-var">b</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp (Ext v)
</span><a href="#local-6989586621684360375"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360374"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360373"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(PrimExp (Ext v), PrimExp (Ext v), PrimExp (Ext v), Int,
   Monotonicity)]
 -&gt; [LMADDim (PrimExp (Ext v))])
-&gt; [(PrimExp (Ext v), PrimExp (Ext v), PrimExp (Ext v), Int,
     Monotonicity)]
-&gt; [LMADDim (PrimExp (Ext v))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-976"></span><span>          </span><span class="annot"><span class="annottext">[PrimExp (Ext v)]
-&gt; [PrimExp (Ext v)]
-&gt; [PrimExp (Ext v)]
-&gt; Permutation
-&gt; [Monotonicity]
-&gt; [(PrimExp (Ext v), PrimExp (Ext v), PrimExp (Ext v), Int,
     Monotonicity)]
forall a b c d e.
[a] -&gt; [b] -&gt; [c] -&gt; [d] -&gt; [e] -&gt; [(a, b, c, d, e)]
</span><span class="hs-identifier hs-var">zip5</span></span><span> </span><span class="annot"><span class="annottext">[PrimExp (Ext v)]
</span><a href="#local-6989586621684360388"><span class="hs-identifier hs-var">dstd</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimExp (Ext v)]
</span><a href="#local-6989586621684360385"><span class="hs-identifier hs-var">drot</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimExp (Ext v)]
</span><a href="#local-6989586621684360394"><span class="hs-identifier hs-var">dshp</span></a></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360396"><span class="hs-identifier hs-var">dperm</span></a></span><span> </span><span class="annot"><span class="annottext">[Monotonicity]
</span><a href="#local-6989586621684360395"><span class="hs-identifier hs-var">dmon</span></a></span><span>
</span><span id="line-977"></span><span>      </span><span id="local-6989586621684360372"><span class="annot"><span class="annottext">lmad :: LMAD (PrimExp (Ext v))
</span><a href="#local-6989586621684360372"><span class="hs-identifier hs-var hs-var">lmad</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimExp (Ext v)
-&gt; [LMADDim (PrimExp (Ext v))] -&gt; LMAD (PrimExp (Ext v))
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp (Ext v)
</span><a href="#local-6989586621684360381"><span class="hs-identifier hs-var">offt</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim (PrimExp (Ext v))]
</span><a href="#local-6989586621684360378"><span class="hs-identifier hs-var">lmad_dims</span></a></span><span>
</span><span id="line-978"></span><span>  </span><span class="annot"><span class="annottext">(IxFun (PrimExp (Ext v)), [(PrimExp v, PrimExp v)])
-&gt; Maybe (IxFun (PrimExp (Ext v)), [(PrimExp v, PrimExp v)])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (LMAD (PrimExp (Ext v)))
-&gt; [PrimExp (Ext v)] -&gt; Bool -&gt; IxFun (PrimExp (Ext v))
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD (PrimExp (Ext v))
</span><a href="#local-6989586621684360372"><span class="hs-identifier hs-var">lmad</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (PrimExp (Ext v))
-&gt; [LMAD (PrimExp (Ext v))] -&gt; NonEmpty (LMAD (PrimExp (Ext v)))
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PrimExp (Ext v)]
</span><a href="#local-6989586621684360390"><span class="hs-identifier hs-var">oshp</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621684360397"><span class="hs-identifier hs-var">ctg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360380"><span class="hs-identifier hs-var">m5</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-979"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-980"></span><span>    </span><span id="local-6989586621684360398"><span class="annot"><span class="annottext">lmadDMon :: LMAD num -&gt; [Monotonicity]
</span><a href="#local-6989586621684360398"><span class="hs-identifier hs-var hs-var">lmadDMon</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; Monotonicity) -&gt; [LMADDim num] -&gt; [Monotonicity]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; Monotonicity
forall num. LMADDim num -&gt; Monotonicity
</span><a href="Futhark.IR.Mem.IxFun.html#ldMon"><span class="hs-identifier hs-var hs-var">ldMon</span></a></span><span> </span><span class="annot"><span class="annottext">([LMADDim num] -&gt; [Monotonicity])
-&gt; (LMAD num -&gt; [LMADDim num]) -&gt; LMAD num -&gt; [Monotonicity]
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LMAD num -&gt; [LMADDim num]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span>
</span><span id="line-981"></span><span>    </span><span id="local-6989586621684360386"><span class="annot"><span class="annottext">lmadDSrd :: LMAD b -&gt; [b]
</span><a href="#local-6989586621684360386"><span class="hs-identifier hs-var hs-var">lmadDSrd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LMADDim b -&gt; b) -&gt; [LMADDim b] -&gt; [b]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim b -&gt; b
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldStride"><span class="hs-identifier hs-var hs-var">ldStride</span></a></span><span> </span><span class="annot"><span class="annottext">([LMADDim b] -&gt; [b]) -&gt; (LMAD b -&gt; [LMADDim b]) -&gt; LMAD b -&gt; [b]
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LMAD b -&gt; [LMADDim b]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span>
</span><span id="line-982"></span><span>    </span><span id="local-6989586621684360391"><span class="annot"><span class="annottext">lmadDShp :: LMAD b -&gt; [b]
</span><a href="#local-6989586621684360391"><span class="hs-identifier hs-var hs-var">lmadDShp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LMADDim b -&gt; b) -&gt; [LMADDim b] -&gt; [b]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim b -&gt; b
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldShape"><span class="hs-identifier hs-var hs-var">ldShape</span></a></span><span> </span><span class="annot"><span class="annottext">([LMADDim b] -&gt; [b]) -&gt; (LMAD b -&gt; [LMADDim b]) -&gt; LMAD b -&gt; [b]
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LMAD b -&gt; [LMADDim b]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span>
</span><span id="line-983"></span><span>    </span><span id="local-6989586621684360383"><span class="annot"><span class="annottext">lmadDRot :: LMAD b -&gt; [b]
</span><a href="#local-6989586621684360383"><span class="hs-identifier hs-var hs-var">lmadDRot</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(LMADDim b -&gt; b) -&gt; [LMADDim b] -&gt; [b]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim b -&gt; b
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldRotate"><span class="hs-identifier hs-var hs-var">ldRotate</span></a></span><span> </span><span class="annot"><span class="annottext">([LMADDim b] -&gt; [b]) -&gt; (LMAD b -&gt; [LMADDim b]) -&gt; LMAD b -&gt; [b]
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LMAD b -&gt; [LMADDim b]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span>
</span><span id="line-984"></span><span>    </span><span id="local-6989586621684360392"><span class="annot"><span class="annottext">generalize :: [(PrimExp v, PrimExp v)]
-&gt; [PrimExp v]
-&gt; [PrimExp v]
-&gt; m ([PrimExp (Ext v)], [(PrimExp v, PrimExp v)])
</span><a href="#local-6989586621684360392"><span class="hs-identifier hs-var hs-var">generalize</span></a></span></span><span> </span><span id="local-6989586621684360362"><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360362"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span id="local-6989586621684360361"><span class="annot"><span class="annottext">[PrimExp v]
</span><a href="#local-6989586621684360361"><span class="hs-identifier hs-var">l1</span></a></span></span><span> </span><span id="local-6989586621684360360"><span class="annot"><span class="annottext">[PrimExp v]
</span><a href="#local-6989586621684360360"><span class="hs-identifier hs-var">l2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-985"></span><span>      </span><span class="annot"><span class="annottext">(([PrimExp (Ext v)], [(PrimExp v, PrimExp v)])
 -&gt; (PrimExp v, PrimExp v)
 -&gt; m ([PrimExp (Ext v)], [(PrimExp v, PrimExp v)]))
-&gt; ([PrimExp (Ext v)], [(PrimExp v, PrimExp v)])
-&gt; [(PrimExp v, PrimExp v)]
-&gt; m ([PrimExp (Ext v)], [(PrimExp v, PrimExp v)])
forall (t :: * -&gt; *) (m :: * -&gt; *) b a.
(Foldable t, Monad m) =&gt;
(b -&gt; a -&gt; m b) -&gt; b -&gt; t a -&gt; m b
</span><span class="hs-identifier hs-var">foldM</span></span><span>
</span><span id="line-986"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684360358"><span class="annot"><span class="annottext">[PrimExp (Ext v)]
</span><a href="#local-6989586621684360358"><span class="hs-identifier hs-var">l_acc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360357"><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360357"><span class="hs-identifier hs-var">m'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360356"><span class="annot"><span class="annottext">PrimExp v
</span><a href="#local-6989586621684360356"><span class="hs-identifier hs-var">pe1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360355"><span class="annot"><span class="annottext">PrimExp v
</span><a href="#local-6989586621684360355"><span class="hs-identifier hs-var">pe2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-987"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360353"><span class="annot"><span class="annottext">PrimExp (Ext v)
</span><a href="#local-6989586621684360353"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360352"><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360352"><span class="hs-identifier hs-var">m''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
-&gt; PrimExp v
-&gt; PrimExp v
-&gt; (PrimExp (Ext v), [(PrimExp v, PrimExp v)])
forall v.
Eq v =&gt;
[(PrimExp v, PrimExp v)]
-&gt; PrimExp v
-&gt; PrimExp v
-&gt; (PrimExp (Ext v), [(PrimExp v, PrimExp v)])
</span><a href="Futhark.Analysis.PrimExp.Generalize.html#leastGeneralGeneralization"><span class="hs-identifier hs-var">PEG.leastGeneralGeneralization</span></a></span><span> </span><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360357"><span class="hs-identifier hs-var">m'</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp v
</span><a href="#local-6989586621684360356"><span class="hs-identifier hs-var">pe1</span></a></span><span> </span><span class="annot"><span class="annottext">PrimExp v
</span><a href="#local-6989586621684360355"><span class="hs-identifier hs-var">pe2</span></a></span><span>
</span><span id="line-988"></span><span>            </span><span class="annot"><span class="annottext">([PrimExp (Ext v)], [(PrimExp v, PrimExp v)])
-&gt; m ([PrimExp (Ext v)], [(PrimExp v, PrimExp v)])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PrimExp (Ext v)]
</span><a href="#local-6989586621684360358"><span class="hs-identifier hs-var">l_acc</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimExp (Ext v)] -&gt; [PrimExp (Ext v)] -&gt; [PrimExp (Ext v)]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PrimExp (Ext v)
</span><a href="#local-6989586621684360353"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360352"><span class="hs-identifier hs-var">m''</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-989"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-990"></span><span>        </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(PrimExp v, PrimExp v)]
</span><a href="#local-6989586621684360362"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-991"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PrimExp v] -&gt; [PrimExp v] -&gt; [(PrimExp v, PrimExp v)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[PrimExp v]
</span><a href="#local-6989586621684360361"><span class="hs-identifier hs-var">l1</span></a></span><span> </span><span class="annot"><span class="annottext">[PrimExp v]
</span><a href="#local-6989586621684360360"><span class="hs-identifier hs-var">l2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-992"></span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#leastGeneralGeneralization"><span class="hs-identifier hs-var">leastGeneralGeneralization</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (PrimExp v)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">IxFun (PrimExp v)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (IxFun (PrimExp (Ext v)), [(PrimExp v, PrimExp v)])
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-993"></span><span>
</span><span id="line-994"></span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#isSequential"><span class="hs-identifier hs-type">isSequential</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-995"></span><span id="isSequential"><span class="annot"><span class="annottext">isSequential :: Permutation -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#isSequential"><span class="hs-identifier hs-var hs-var">isSequential</span></a></span></span><span> </span><span id="local-6989586621684360350"><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360350"><span class="hs-identifier hs-var">xs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-996"></span><span>  </span><span class="annot"><span class="annottext">((Int, Int) -&gt; Bool) -&gt; [(Int, Int)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Int -&gt; Int -&gt; Bool) -&gt; (Int, Int) -&gt; Bool
forall a b c. (a -&gt; b -&gt; c) -&gt; (a, b) -&gt; c
</span><span class="hs-identifier hs-var">uncurry</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">(==)</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Int, Int)] -&gt; Bool) -&gt; [(Int, Int)] -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Permutation -&gt; Permutation -&gt; [(Int, Int)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">Permutation
</span><a href="#local-6989586621684360350"><span class="hs-identifier hs-var">xs</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">..</span><span class="hs-special">]</span><span>
</span><span id="line-997"></span><span>
</span><span id="line-998"></span><span id="local-6989586621684362073"><span id="local-6989586621684362074"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#existentializeExp"><span class="hs-identifier hs-type">existentializeExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362074"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362073"><span class="hs-identifier hs-type">v</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362074"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362073"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362074"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362073"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-999"></span><span id="existentializeExp"><span class="annot"><span class="annottext">existentializeExp :: forall t v.
TPrimExp t v -&gt; State [TPrimExp t v] (TPrimExp t (Ext v))
</span><a href="Futhark.IR.Mem.IxFun.html#existentializeExp"><span class="hs-identifier hs-var hs-var">existentializeExp</span></a></span></span><span> </span><span id="local-6989586621684360338"><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684360338"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1000"></span><span>  </span><span id="local-6989586621684360337"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360337"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([TPrimExp t v] -&gt; Int) -&gt; StateT [TPrimExp t v] Identity Int
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp t v] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span>
</span><span id="line-1001"></span><span>  </span><span class="annot"><span class="annottext">([TPrimExp t v] -&gt; [TPrimExp t v])
-&gt; StateT [TPrimExp t v] Identity ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TPrimExp t v] -&gt; [TPrimExp t v] -&gt; [TPrimExp t v]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684360338"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><span id="line-1002"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360334"><span class="annot"><span class="annottext">t :: PrimType
</span><a href="#local-6989586621684360334"><span class="hs-identifier hs-var hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimExp v -&gt; PrimType
forall v. PrimExp v -&gt; PrimType
</span><a href="Futhark.Analysis.PrimExp.html#primExpType"><span class="hs-identifier hs-var">primExpType</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp v -&gt; PrimType) -&gt; PrimExp v -&gt; PrimType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v -&gt; PrimExp v
forall t v. TPrimExp t v -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#untyped"><span class="hs-identifier hs-var hs-var">untyped</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684360338"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-1003"></span><span>  </span><span class="annot"><span class="annottext">TPrimExp t (Ext v) -&gt; State [TPrimExp t v] (TPrimExp t (Ext v))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(TPrimExp t (Ext v) -&gt; State [TPrimExp t v] (TPrimExp t (Ext v)))
-&gt; TPrimExp t (Ext v) -&gt; State [TPrimExp t v] (TPrimExp t (Ext v))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimExp (Ext v) -&gt; TPrimExp t (Ext v)
forall t v. PrimExp v -&gt; TPrimExp t v
</span><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-var">TPrimExp</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimExp (Ext v) -&gt; TPrimExp t (Ext v))
-&gt; PrimExp (Ext v) -&gt; TPrimExp t (Ext v)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Ext v -&gt; PrimType -&gt; PrimExp (Ext v)
forall v. v -&gt; PrimType -&gt; PrimExp v
</span><a href="Futhark.Analysis.PrimExp.html#LeafExp"><span class="hs-identifier hs-var">LeafExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Ext v
forall a. Int -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-var">Ext</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360337"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684360334"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1004"></span><span>
</span><span id="line-1005"></span><span class="hs-comment">-- We require that there's only one lmad, and that the index function is contiguous, and the base shape has only one dimension</span><span>
</span><span id="line-1006"></span><span id="local-6989586621684362052"><span id="local-6989586621684362054"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#existentialize"><span class="hs-identifier hs-type">existentialize</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1007"></span><span>  </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#IntExp"><span class="hs-identifier hs-type">IntExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362054"><span class="hs-identifier hs-type">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684362052"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Pretty</span></span><span> </span><span class="annot"><a href="#local-6989586621684362052"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-1008"></span><span>  </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362054"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362052"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1009"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362054"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362052"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362054"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362052"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1010"></span><span id="existentialize"><span class="annot"><span class="annottext">existentialize :: forall t v.
(IntExp t, Eq v, Pretty v) =&gt;
IxFun (TPrimExp t v)
-&gt; State [TPrimExp t v] (Maybe (IxFun (TPrimExp t (Ext v))))
</span><a href="Futhark.IR.Mem.IxFun.html#existentialize"><span class="hs-identifier hs-var hs-var">existentialize</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360304"><span class="annot"><span class="annottext">LMAD (TPrimExp t v)
</span><a href="#local-6989586621684360304"><span class="hs-identifier hs-var">lmad</span></a></span></span><span> </span><span class="annot"><span class="hs-operator hs-type">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684360303"><span class="annot"><span class="annottext">[TPrimExp t v]
</span><a href="#local-6989586621684360303"><span class="hs-identifier hs-var">oshp</span></a></span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span class="hs-special">)</span><span>
</span><span id="line-1011"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(LMADDim (TPrimExp t v) -&gt; Bool)
-&gt; [LMADDim (TPrimExp t v)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">TPrimExp t v -&gt; TPrimExp t v -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v
</span><span class="hs-number">0</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(TPrimExp t v -&gt; Bool)
-&gt; (LMADDim (TPrimExp t v) -&gt; TPrimExp t v)
-&gt; LMADDim (TPrimExp t v)
-&gt; Bool
forall {k} (cat :: k -&gt; k -&gt; *) (b :: k) (c :: k) (a :: k).
Category cat =&gt;
cat b c -&gt; cat a b -&gt; cat a c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">LMADDim (TPrimExp t v) -&gt; TPrimExp t v
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldRotate"><span class="hs-identifier hs-var hs-var">ldRotate</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD (TPrimExp t v) -&gt; [LMADDim (TPrimExp t v)]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (TPrimExp t v)
</span><a href="#local-6989586621684360304"><span class="hs-identifier hs-var">lmad</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1012"></span><span>    </span><span class="annot"><span class="annottext">[TPrimExp t v] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD (TPrimExp t v) -&gt; [TPrimExp t v]
forall num. (Eq num, IntegralExp num) =&gt; LMAD num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadShape"><span class="hs-identifier hs-var">lmadShape</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (TPrimExp t v)
</span><a href="#local-6989586621684360304"><span class="hs-identifier hs-var">lmad</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp t v] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[TPrimExp t v]
</span><a href="#local-6989586621684360303"><span class="hs-identifier hs-var">oshp</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1013"></span><span>    </span><span class="annot"><span class="annottext">Permutation -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#isSequential"><span class="hs-identifier hs-var">isSequential</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(LMADDim (TPrimExp t v) -&gt; Int)
-&gt; [LMADDim (TPrimExp t v)] -&gt; Permutation
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim (TPrimExp t v) -&gt; Int
forall num. LMADDim num -&gt; Int
</span><a href="Futhark.IR.Mem.IxFun.html#ldPerm"><span class="hs-identifier hs-var hs-var">ldPerm</span></a></span><span> </span><span class="annot"><span class="annottext">([LMADDim (TPrimExp t v)] -&gt; Permutation)
-&gt; [LMADDim (TPrimExp t v)] -&gt; Permutation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LMAD (TPrimExp t v) -&gt; [LMADDim (TPrimExp t v)]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (TPrimExp t v)
</span><a href="#local-6989586621684360304"><span class="hs-identifier hs-var">lmad</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1014"></span><span>    </span><span id="local-6989586621684360302"><span class="annot"><span class="annottext">[TPrimExp t (Ext v)]
</span><a href="#local-6989586621684360302"><span class="hs-identifier hs-var">oshp'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(TPrimExp t v
 -&gt; StateT [TPrimExp t v] Identity (TPrimExp t (Ext v)))
-&gt; [TPrimExp t v]
-&gt; StateT [TPrimExp t v] Identity [TPrimExp t (Ext v)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v -&gt; StateT [TPrimExp t v] Identity (TPrimExp t (Ext v))
forall t v.
TPrimExp t v -&gt; State [TPrimExp t v] (TPrimExp t (Ext v))
</span><a href="Futhark.IR.Mem.IxFun.html#existentializeExp"><span class="hs-identifier hs-var">existentializeExp</span></a></span><span> </span><span class="annot"><span class="annottext">[TPrimExp t v]
</span><a href="#local-6989586621684360303"><span class="hs-identifier hs-var">oshp</span></a></span><span>
</span><span id="line-1015"></span><span>    </span><span id="local-6989586621684360300"><span class="annot"><span class="annottext">TPrimExp t (Ext v)
</span><a href="#local-6989586621684360300"><span class="hs-identifier hs-var">lmadOffset'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TPrimExp t v -&gt; StateT [TPrimExp t v] Identity (TPrimExp t (Ext v))
forall t v.
TPrimExp t v -&gt; State [TPrimExp t v] (TPrimExp t (Ext v))
</span><a href="Futhark.IR.Mem.IxFun.html#existentializeExp"><span class="hs-identifier hs-var">existentializeExp</span></a></span><span> </span><span class="annot"><span class="annottext">(TPrimExp t v
 -&gt; StateT [TPrimExp t v] Identity (TPrimExp t (Ext v)))
-&gt; TPrimExp t v
-&gt; StateT [TPrimExp t v] Identity (TPrimExp t (Ext v))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LMAD (TPrimExp t v) -&gt; TPrimExp t v
forall num. LMAD num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadOffset"><span class="hs-identifier hs-var hs-var">lmadOffset</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (TPrimExp t v)
</span><a href="#local-6989586621684360304"><span class="hs-identifier hs-var">lmad</span></a></span><span>
</span><span id="line-1016"></span><span>    </span><span id="local-6989586621684360299"><span class="annot"><span class="annottext">[LMADDim (TPrimExp t (Ext v))]
</span><a href="#local-6989586621684360299"><span class="hs-identifier hs-var">lmadDims'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(LMADDim (TPrimExp t v)
 -&gt; StateT [TPrimExp t v] Identity (LMADDim (TPrimExp t (Ext v))))
-&gt; [LMADDim (TPrimExp t v)]
-&gt; StateT [TPrimExp t v] Identity [LMADDim (TPrimExp t (Ext v))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">LMADDim (TPrimExp t v)
-&gt; StateT [TPrimExp t v] Identity (LMADDim (TPrimExp t (Ext v)))
forall t v.
LMADDim (TPrimExp t v)
-&gt; State [TPrimExp t v] (LMADDim (TPrimExp t (Ext v)))
</span><a href="#local-6989586621684360298"><span class="hs-identifier hs-var">existentializeLMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">([LMADDim (TPrimExp t v)]
 -&gt; StateT [TPrimExp t v] Identity [LMADDim (TPrimExp t (Ext v))])
-&gt; [LMADDim (TPrimExp t v)]
-&gt; StateT [TPrimExp t v] Identity [LMADDim (TPrimExp t (Ext v))]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">LMAD (TPrimExp t v) -&gt; [LMADDim (TPrimExp t v)]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (TPrimExp t v)
</span><a href="#local-6989586621684360304"><span class="hs-identifier hs-var">lmad</span></a></span><span>
</span><span id="line-1017"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684360297"><span class="annot"><span class="annottext">lmad' :: LMAD (TPrimExp t (Ext v))
</span><a href="#local-6989586621684360297"><span class="hs-identifier hs-var hs-var">lmad'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TPrimExp t (Ext v)
-&gt; [LMADDim (TPrimExp t (Ext v))] -&gt; LMAD (TPrimExp t (Ext v))
forall num. num -&gt; [LMADDim num] -&gt; LMAD num
</span><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-var">LMAD</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t (Ext v)
</span><a href="#local-6989586621684360300"><span class="hs-identifier hs-var">lmadOffset'</span></a></span><span> </span><span class="annot"><span class="annottext">[LMADDim (TPrimExp t (Ext v))]
</span><a href="#local-6989586621684360299"><span class="hs-identifier hs-var">lmadDims'</span></a></span><span>
</span><span id="line-1018"></span><span>    </span><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp t (Ext v)))
-&gt; State [TPrimExp t v] (Maybe (IxFun (TPrimExp t (Ext v))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Maybe (IxFun (TPrimExp t (Ext v)))
 -&gt; State [TPrimExp t v] (Maybe (IxFun (TPrimExp t (Ext v)))))
-&gt; Maybe (IxFun (TPrimExp t (Ext v)))
-&gt; State [TPrimExp t v] (Maybe (IxFun (TPrimExp t (Ext v))))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp t (Ext v)) -&gt; Maybe (IxFun (TPrimExp t (Ext v)))
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(IxFun (TPrimExp t (Ext v)) -&gt; Maybe (IxFun (TPrimExp t (Ext v))))
-&gt; IxFun (TPrimExp t (Ext v)) -&gt; Maybe (IxFun (TPrimExp t (Ext v)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD (TPrimExp t (Ext v)))
-&gt; [TPrimExp t (Ext v)] -&gt; Bool -&gt; IxFun (TPrimExp t (Ext v))
forall num. NonEmpty (LMAD num) -&gt; Shape num -&gt; Bool -&gt; IxFun num
</span><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-var">IxFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD (TPrimExp t (Ext v))
</span><a href="#local-6989586621684360297"><span class="hs-identifier hs-var">lmad'</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD (TPrimExp t (Ext v))
-&gt; [LMAD (TPrimExp t (Ext v))]
-&gt; NonEmpty (LMAD (TPrimExp t (Ext v)))
forall a. a -&gt; [a] -&gt; NonEmpty a
</span><span class="hs-operator hs-var">:|</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TPrimExp t (Ext v)]
</span><a href="#local-6989586621684360302"><span class="hs-identifier hs-var">oshp'</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1019"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1020"></span><span>    </span><span id="local-6989586621684362042"><span id="local-6989586621684362043"><span class="annot"><a href="#local-6989586621684360298"><span class="hs-identifier hs-type">existentializeLMADDim</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-1021"></span><span>      </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362043"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362042"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1022"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362043"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362042"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Analysis.PrimExp.html#TPrimExp"><span class="hs-identifier hs-type">TPrimExp</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362043"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Syntax.Core.html#Ext"><span class="hs-identifier hs-type">Ext</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362042"><span class="hs-identifier hs-type">v</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span></span></span><span>
</span><span id="line-1023"></span><span>    </span><span id="local-6989586621684360298"><span class="annot"><span class="annottext">existentializeLMADDim :: forall t v.
LMADDim (TPrimExp t v)
-&gt; State [TPrimExp t v] (LMADDim (TPrimExp t (Ext v)))
</span><a href="#local-6989586621684360298"><span class="hs-identifier hs-var hs-var">existentializeLMADDim</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-type">LMADDim</span></a></span><span> </span><span id="local-6989586621684360291"><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684360291"><span class="hs-identifier hs-var">str</span></a></span></span><span> </span><span id="local-6989586621684360290"><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684360290"><span class="hs-identifier hs-var">rot</span></a></span></span><span> </span><span id="local-6989586621684360289"><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684360289"><span class="hs-identifier hs-var">shp</span></a></span></span><span> </span><span id="local-6989586621684360288"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360288"><span class="hs-identifier hs-var">perm</span></a></span></span><span> </span><span id="local-6989586621684360287"><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360287"><span class="hs-identifier hs-var">mon</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1024"></span><span>      </span><span id="local-6989586621684360286"><span class="annot"><span class="annottext">TPrimExp t (Ext v)
</span><a href="#local-6989586621684360286"><span class="hs-identifier hs-var">stride'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TPrimExp t v -&gt; State [TPrimExp t v] (TPrimExp t (Ext v))
forall t v.
TPrimExp t v -&gt; State [TPrimExp t v] (TPrimExp t (Ext v))
</span><a href="Futhark.IR.Mem.IxFun.html#existentializeExp"><span class="hs-identifier hs-var">existentializeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684360291"><span class="hs-identifier hs-var">str</span></a></span><span>
</span><span id="line-1025"></span><span>      </span><span id="local-6989586621684360285"><span class="annot"><span class="annottext">TPrimExp t (Ext v)
</span><a href="#local-6989586621684360285"><span class="hs-identifier hs-var">shape'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TPrimExp t v -&gt; State [TPrimExp t v] (TPrimExp t (Ext v))
forall t v.
TPrimExp t v -&gt; State [TPrimExp t v] (TPrimExp t (Ext v))
</span><a href="Futhark.IR.Mem.IxFun.html#existentializeExp"><span class="hs-identifier hs-var">existentializeExp</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684360289"><span class="hs-identifier hs-var">shp</span></a></span><span>
</span><span id="line-1026"></span><span>      </span><span class="annot"><span class="annottext">LMADDim (TPrimExp t (Ext v))
-&gt; State [TPrimExp t v] (LMADDim (TPrimExp t (Ext v)))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim (TPrimExp t (Ext v))
 -&gt; State [TPrimExp t v] (LMADDim (TPrimExp t (Ext v))))
-&gt; LMADDim (TPrimExp t (Ext v))
-&gt; State [TPrimExp t v] (LMADDim (TPrimExp t (Ext v)))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TPrimExp t (Ext v)
-&gt; TPrimExp t (Ext v)
-&gt; TPrimExp t (Ext v)
-&gt; Int
-&gt; Monotonicity
-&gt; LMADDim (TPrimExp t (Ext v))
forall num. num -&gt; num -&gt; num -&gt; Int -&gt; Monotonicity -&gt; LMADDim num
</span><a href="Futhark.IR.Mem.IxFun.html#LMADDim"><span class="hs-identifier hs-var">LMADDim</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t (Ext v)
</span><a href="#local-6989586621684360286"><span class="hs-identifier hs-var">stride'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(v -&gt; Ext v) -&gt; TPrimExp t v -&gt; TPrimExp t (Ext v)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">v -&gt; Ext v
forall a. a -&gt; Ext a
</span><a href="Futhark.IR.Syntax.Core.html#Free"><span class="hs-identifier hs-var">Free</span></a></span><span> </span><span class="annot"><span class="annottext">TPrimExp t v
</span><a href="#local-6989586621684360290"><span class="hs-identifier hs-var">rot</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TPrimExp t (Ext v)
</span><a href="#local-6989586621684360285"><span class="hs-identifier hs-var">shape'</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684360288"><span class="hs-identifier hs-var">perm</span></a></span><span> </span><span class="annot"><span class="annottext">Monotonicity
</span><a href="#local-6989586621684360287"><span class="hs-identifier hs-var">mon</span></a></span><span>
</span><span id="line-1027"></span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#existentialize"><span class="hs-identifier hs-var">existentialize</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun (TPrimExp t v)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp t (Ext v)))
-&gt; State [TPrimExp t v] (Maybe (IxFun (TPrimExp t (Ext v))))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Maybe (IxFun (TPrimExp t (Ext v)))
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1028"></span><span>
</span><span id="line-1029"></span><span class="hs-comment">-- | When comparing index functions as part of the type check in KernelsMem,</span><span>
</span><span id="line-1030"></span><span class="hs-comment">-- we may run into problems caused by the simplifier. As index functions can be</span><span>
</span><span id="line-1031"></span><span class="hs-comment">-- generalized over if-then-else expressions, the simplifier might hoist some of</span><span>
</span><span id="line-1032"></span><span class="hs-comment">-- the code from inside the if-then-else (computing the offset of an array, for</span><span>
</span><span id="line-1033"></span><span class="hs-comment">-- instance), but now the type checker cannot verify that the generalized index</span><span>
</span><span id="line-1034"></span><span class="hs-comment">-- function is valid, because some of the existentials are computed somewhere</span><span>
</span><span id="line-1035"></span><span class="hs-comment">-- else. To Work around this, we've had to relax the KernelsMem type-checker</span><span>
</span><span id="line-1036"></span><span class="hs-comment">-- a bit, specifically, we've introduced this function to verify whether two</span><span>
</span><span id="line-1037"></span><span class="hs-comment">-- index functions are &quot;close enough&quot; that we can assume that they match. We use</span><span>
</span><span id="line-1038"></span><span class="hs-comment">-- this instead of `ixfun1 == ixfun2` and hope that it's good enough.</span><span>
</span><span id="line-1039"></span><span id="local-6989586621684362038"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#closeEnough"><span class="hs-identifier hs-type">closeEnough</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362038"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362038"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-1040"></span><span id="closeEnough"><span class="annot"><span class="annottext">closeEnough :: forall num. IxFun num -&gt; IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#closeEnough"><span class="hs-identifier hs-var hs-var">closeEnough</span></a></span></span><span> </span><span id="local-6989586621684360277"><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360277"><span class="hs-identifier hs-var">ixf1</span></a></span></span><span> </span><span id="local-6989586621684360276"><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360276"><span class="hs-identifier hs-var">ixf2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1041"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun num -&gt; [num]
forall num. IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#base"><span class="hs-identifier hs-var hs-var">base</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360277"><span class="hs-identifier hs-var">ixf1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun num -&gt; [num]
forall num. IxFun num -&gt; Shape num
</span><a href="Futhark.IR.Mem.IxFun.html#base"><span class="hs-identifier hs-var hs-var">base</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360276"><span class="hs-identifier hs-var">ixf2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1042"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Int
forall a. NonEmpty a -&gt; Int
</span><span class="hs-identifier hs-var">NE.length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun num -&gt; NonEmpty (LMAD num)
forall num. IxFun num -&gt; NonEmpty (LMAD num)
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunLMADs"><span class="hs-identifier hs-var hs-var">ixfunLMADs</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360277"><span class="hs-identifier hs-var">ixf1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Int
forall a. NonEmpty a -&gt; Int
</span><span class="hs-identifier hs-var">NE.length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun num -&gt; NonEmpty (LMAD num)
forall num. IxFun num -&gt; NonEmpty (LMAD num)
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunLMADs"><span class="hs-identifier hs-var hs-var">ixfunLMADs</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360276"><span class="hs-identifier hs-var">ixf2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1043"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">((LMAD num, LMAD num) -&gt; Bool)
-&gt; NonEmpty (LMAD num, LMAD num) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">(LMAD num, LMAD num) -&gt; Bool
forall num. (LMAD num, LMAD num) -&gt; Bool
</span><a href="#local-6989586621684360274"><span class="hs-identifier hs-var">closeEnoughLMADs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (LMAD num)
-&gt; NonEmpty (LMAD num) -&gt; NonEmpty (LMAD num, LMAD num)
forall a b. NonEmpty a -&gt; NonEmpty b -&gt; NonEmpty (a, b)
</span><span class="hs-identifier hs-var">NE.zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun num -&gt; NonEmpty (LMAD num)
forall num. IxFun num -&gt; NonEmpty (LMAD num)
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunLMADs"><span class="hs-identifier hs-var hs-var">ixfunLMADs</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360277"><span class="hs-identifier hs-var">ixf1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun num -&gt; NonEmpty (LMAD num)
forall num. IxFun num -&gt; NonEmpty (LMAD num)
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunLMADs"><span class="hs-identifier hs-var hs-var">ixfunLMADs</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360276"><span class="hs-identifier hs-var">ixf2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1044"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1045"></span><span>    </span><span id="local-6989586621684362035"><span class="annot"><a href="#local-6989586621684360274"><span class="hs-identifier hs-type">closeEnoughLMADs</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362035"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#LMAD"><span class="hs-identifier hs-type">LMAD</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684362035"><span class="hs-identifier hs-type">num</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-1046"></span><span>    </span><span id="local-6989586621684360274"><span class="annot"><span class="annottext">closeEnoughLMADs :: forall num. (LMAD num, LMAD num) -&gt; Bool
</span><a href="#local-6989586621684360274"><span class="hs-identifier hs-var hs-var">closeEnoughLMADs</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360268"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360268"><span class="hs-identifier hs-var">lmad1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360267"><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360267"><span class="hs-identifier hs-var">lmad2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1047"></span><span>      </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num -&gt; [LMADDim num]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360268"><span class="hs-identifier hs-var">lmad1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim num] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num -&gt; [LMADDim num]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360267"><span class="hs-identifier hs-var">lmad2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1048"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; Int) -&gt; [LMADDim num] -&gt; Permutation
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; Int
forall num. LMADDim num -&gt; Int
</span><a href="Futhark.IR.Mem.IxFun.html#ldPerm"><span class="hs-identifier hs-var hs-var">ldPerm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num -&gt; [LMADDim num]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360268"><span class="hs-identifier hs-var">lmad1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1049"></span><span>        </span><span class="annot"><span class="annottext">Permutation -&gt; Permutation -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim num -&gt; Int) -&gt; [LMADDim num] -&gt; Permutation
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim num -&gt; Int
forall num. LMADDim num -&gt; Int
</span><a href="Futhark.IR.Mem.IxFun.html#ldPerm"><span class="hs-identifier hs-var hs-var">ldPerm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD num -&gt; [LMADDim num]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD num
</span><a href="#local-6989586621684360267"><span class="hs-identifier hs-var">lmad2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1050"></span><span>
</span><span id="line-1051"></span><span class="hs-comment">-- | Returns true if two 'IxFun's are equivalent.</span><span>
</span><span id="line-1052"></span><span class="hs-comment">--</span><span>
</span><span id="line-1053"></span><span class="hs-comment">-- Equivalence in this case is defined as having the same number of LMADs, with</span><span>
</span><span id="line-1054"></span><span class="hs-comment">-- each pair of LMADs matching in permutation, offsets, strides and rotations.</span><span>
</span><span id="line-1055"></span><span id="local-6989586621684360266"><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#equivalent"><span class="hs-identifier hs-type">equivalent</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Eq</span></span><span> </span><span class="annot"><a href="#local-6989586621684360266"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684360266"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.IR.Mem.IxFun.html#IxFun"><span class="hs-identifier hs-type">IxFun</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684360266"><span class="hs-identifier hs-type">num</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span></span><span>
</span><span id="line-1056"></span><span id="equivalent"><span class="annot"><span class="annottext">equivalent :: forall num. Eq num =&gt; IxFun num -&gt; IxFun num -&gt; Bool
</span><a href="Futhark.IR.Mem.IxFun.html#equivalent"><span class="hs-identifier hs-var hs-var">equivalent</span></a></span></span><span> </span><span id="local-6989586621684360261"><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360261"><span class="hs-identifier hs-var">ixf1</span></a></span></span><span> </span><span id="local-6989586621684360260"><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360260"><span class="hs-identifier hs-var">ixf2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1057"></span><span>  </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Int
forall a. NonEmpty a -&gt; Int
</span><span class="hs-identifier hs-var">NE.length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun num -&gt; NonEmpty (LMAD num)
forall num. IxFun num -&gt; NonEmpty (LMAD num)
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunLMADs"><span class="hs-identifier hs-var hs-var">ixfunLMADs</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360261"><span class="hs-identifier hs-var">ixf1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (LMAD num) -&gt; Int
forall a. NonEmpty a -&gt; Int
</span><span class="hs-identifier hs-var">NE.length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun num -&gt; NonEmpty (LMAD num)
forall num. IxFun num -&gt; NonEmpty (LMAD num)
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunLMADs"><span class="hs-identifier hs-var hs-var">ixfunLMADs</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360260"><span class="hs-identifier hs-var">ixf2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1058"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">((LMAD num, LMAD num) -&gt; Bool)
-&gt; NonEmpty (LMAD num, LMAD num) -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="annot"><span class="annottext">(LMAD num, LMAD num) -&gt; Bool
forall {b}. Eq b =&gt; (LMAD b, LMAD b) -&gt; Bool
</span><a href="#local-6989586621684360259"><span class="hs-identifier hs-var">closeEnoughLMADs</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">NonEmpty (LMAD num)
-&gt; NonEmpty (LMAD num) -&gt; NonEmpty (LMAD num, LMAD num)
forall a b. NonEmpty a -&gt; NonEmpty b -&gt; NonEmpty (a, b)
</span><span class="hs-identifier hs-var">NE.zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun num -&gt; NonEmpty (LMAD num)
forall num. IxFun num -&gt; NonEmpty (LMAD num)
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunLMADs"><span class="hs-identifier hs-var hs-var">ixfunLMADs</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360261"><span class="hs-identifier hs-var">ixf1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IxFun num -&gt; NonEmpty (LMAD num)
forall num. IxFun num -&gt; NonEmpty (LMAD num)
</span><a href="Futhark.IR.Mem.IxFun.html#ixfunLMADs"><span class="hs-identifier hs-var hs-var">ixfunLMADs</span></a></span><span> </span><span class="annot"><span class="annottext">IxFun num
</span><a href="#local-6989586621684360260"><span class="hs-identifier hs-var">ixf2</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1059"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1060"></span><span>    </span><span id="local-6989586621684360259"><span class="annot"><span class="annottext">closeEnoughLMADs :: (LMAD b, LMAD b) -&gt; Bool
</span><a href="#local-6989586621684360259"><span class="hs-identifier hs-var hs-var">closeEnoughLMADs</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684360250"><span class="annot"><span class="annottext">LMAD b
</span><a href="#local-6989586621684360250"><span class="hs-identifier hs-var">lmad1</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684360249"><span class="annot"><span class="annottext">LMAD b
</span><a href="#local-6989586621684360249"><span class="hs-identifier hs-var">lmad2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1061"></span><span>      </span><span class="annot"><span class="annottext">[LMADDim b] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD b -&gt; [LMADDim b]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD b
</span><a href="#local-6989586621684360250"><span class="hs-identifier hs-var">lmad1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[LMADDim b] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD b -&gt; [LMADDim b]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD b
</span><a href="#local-6989586621684360249"><span class="hs-identifier hs-var">lmad2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1062"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim b -&gt; Int) -&gt; [LMADDim b] -&gt; Permutation
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim b -&gt; Int
forall num. LMADDim num -&gt; Int
</span><a href="Futhark.IR.Mem.IxFun.html#ldPerm"><span class="hs-identifier hs-var hs-var">ldPerm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD b -&gt; [LMADDim b]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD b
</span><a href="#local-6989586621684360250"><span class="hs-identifier hs-var">lmad1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1063"></span><span>        </span><span class="annot"><span class="annottext">Permutation -&gt; Permutation -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim b -&gt; Int) -&gt; [LMADDim b] -&gt; Permutation
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim b -&gt; Int
forall num. LMADDim num -&gt; Int
</span><a href="Futhark.IR.Mem.IxFun.html#ldPerm"><span class="hs-identifier hs-var hs-var">ldPerm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD b -&gt; [LMADDim b]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD b
</span><a href="#local-6989586621684360249"><span class="hs-identifier hs-var">lmad2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1064"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">LMAD b -&gt; b
forall num. LMAD num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadOffset"><span class="hs-identifier hs-var hs-var">lmadOffset</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD b
</span><a href="#local-6989586621684360250"><span class="hs-identifier hs-var">lmad1</span></a></span><span>
</span><span id="line-1065"></span><span>        </span><span class="annot"><span class="annottext">b -&gt; b -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">LMAD b -&gt; b
forall num. LMAD num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#lmadOffset"><span class="hs-identifier hs-var hs-var">lmadOffset</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD b
</span><a href="#local-6989586621684360249"><span class="hs-identifier hs-var">lmad2</span></a></span><span>
</span><span id="line-1066"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim b -&gt; b) -&gt; [LMADDim b] -&gt; [b]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim b -&gt; b
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldStride"><span class="hs-identifier hs-var hs-var">ldStride</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD b -&gt; [LMADDim b]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD b
</span><a href="#local-6989586621684360250"><span class="hs-identifier hs-var">lmad1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1067"></span><span>        </span><span class="annot"><span class="annottext">[b] -&gt; [b] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim b -&gt; b) -&gt; [LMADDim b] -&gt; [b]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim b -&gt; b
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldStride"><span class="hs-identifier hs-var hs-var">ldStride</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD b -&gt; [LMADDim b]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD b
</span><a href="#local-6989586621684360249"><span class="hs-identifier hs-var">lmad2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1068"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim b -&gt; b) -&gt; [LMADDim b] -&gt; [b]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim b -&gt; b
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldRotate"><span class="hs-identifier hs-var hs-var">ldRotate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD b -&gt; [LMADDim b]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD b
</span><a href="#local-6989586621684360250"><span class="hs-identifier hs-var">lmad1</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1069"></span><span>        </span><span class="annot"><span class="annottext">[b] -&gt; [b] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">(LMADDim b -&gt; b) -&gt; [LMADDim b] -&gt; [b]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">LMADDim b -&gt; b
forall num. LMADDim num -&gt; num
</span><a href="Futhark.IR.Mem.IxFun.html#ldRotate"><span class="hs-identifier hs-var hs-var">ldRotate</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LMAD b -&gt; [LMADDim b]
forall num. LMAD num -&gt; [LMADDim num]
</span><a href="Futhark.IR.Mem.IxFun.html#lmadDims"><span class="hs-identifier hs-var hs-var">lmadDims</span></a></span><span> </span><span class="annot"><span class="annottext">LMAD b
</span><a href="#local-6989586621684360249"><span class="hs-identifier hs-var">lmad2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1070"></span></pre></body></html>