<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span id="local-6989586621684525036"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE FlexibleInstances #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE GeneralizedNewtypeDeriving #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE TupleSections #-}</span><span>
</span><span id="line-5"></span><span>
</span><span id="line-6"></span><span class="hs-comment">-- | Defunctionalization of typed, monomorphic Futhark programs without modules.</span><span>
</span><span id="line-7"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Futhark.Internalise.Defunctionalise</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#transformProg"><span class="hs-identifier">transformProg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-8"></span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Control.Arrow</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">Arrow</span></span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Identity</span></span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.State</span></span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bifunctor</span></span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Bitraversable</span></span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Foldable</span></span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.List</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">partition</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">sortOn</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">tails</span></span><span class="hs-special">)</span><span>
</span><span id="line-17"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.List.NonEmpty</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">NE</span></span><span>
</span><span id="line-18"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-19"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Data.Maybe</span></span><span>
</span><span id="line-20"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Set</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-21"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.IR.Pretty.html"><span class="hs-identifier">Futhark.IR.Pretty</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-22"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Futhark.Internalise.FreeVars.html"><span class="hs-identifier">Futhark.Internalise.FreeVars</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">FV</span></span><span>
</span><span id="line-23"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html"><span class="hs-identifier">Futhark.MonadFreshNames</span></a></span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.html"><span class="hs-identifier">Language.Futhark</span></a></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Language.Futhark.Traversals.html"><span class="hs-identifier">Language.Futhark.Traversals</span></a></span><span>
</span><span id="line-26"></span><span>
</span><span id="line-27"></span><span class="hs-comment">-- | An expression or an extended 'Lambda' (with size parameters,</span><span>
</span><span id="line-28"></span><span class="hs-comment">-- which AST lambdas do not support).</span><span>
</span><span id="line-29"></span><span class="hs-keyword">data</span><span> </span><span id="ExtExp"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#ExtExp"><span class="hs-identifier hs-var">ExtExp</span></a></span></span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="ExtLambda"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#ExtLambda"><span class="hs-identifier hs-var">ExtLambda</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructRetType"><span class="hs-identifier hs-type">StructRetType</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="ExtExp"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#ExtExp"><span class="hs-identifier hs-var">ExtExp</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684524605"><span id="local-6989586621684524607"><span id="local-6989586621684524624"><span class="annot"><span class="annottext">Int -&gt; ExtExp -&gt; ShowS
[ExtExp] -&gt; ShowS
ExtExp -&gt; String
(Int -&gt; ExtExp -&gt; ShowS)
-&gt; (ExtExp -&gt; String) -&gt; ([ExtExp] -&gt; ShowS) -&gt; Show ExtExp
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [ExtExp] -&gt; ShowS
$cshowList :: [ExtExp] -&gt; ShowS
show :: ExtExp -&gt; String
$cshow :: ExtExp -&gt; String
showsPrec :: Int -&gt; ExtExp -&gt; ShowS
$cshowsPrec :: Int -&gt; ExtExp -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>
</span><span id="line-34"></span><span class="hs-comment">-- | A static value stores additional information about the result of</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- defunctionalization of an expression, aside from the residual expression.</span><span>
</span><span id="line-36"></span><span class="hs-keyword">data</span><span> </span><span id="StaticVal"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-var">StaticVal</span></a></span></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="Dynamic"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="LambdaSV"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#LambdaSV"><span class="hs-identifier hs-var">LambdaSV</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructRetType"><span class="hs-identifier hs-type">StructRetType</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#ExtExp"><span class="hs-identifier hs-type">ExtExp</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="RecordSV"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-var">RecordSV</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | The constructor that is actually present, plus</span><span>
</span><span id="line-41"></span><span>    </span><span class="hs-comment">-- the others that are not.</span><span>
</span><span id="line-42"></span><span>    </span><span id="SumSV"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SumSV"><span class="hs-identifier hs-var">SumSV</span></a></span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Core.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><span id="line-43"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-comment">-- | The pair is the StaticVal and residual expression of this</span><span>
</span><span id="line-44"></span><span>    </span><span class="hs-comment">-- function as a whole, while the second StaticVal is its</span><span>
</span><span id="line-45"></span><span>    </span><span class="hs-comment">-- body. (Don't trust this too much, my understanding may have</span><span>
</span><span id="line-46"></span><span>    </span><span class="hs-comment">-- holes.)</span><span>
</span><span id="line-47"></span><span>    </span><span id="DynamicFun"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-var">DynamicFun</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="IntrinsicSV"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#IntrinsicSV"><span class="hs-identifier hs-var">IntrinsicSV</span></a></span></span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684524557"><span id="local-6989586621684524559"><span id="local-6989586621684524590"><span class="annot"><span class="annottext">Int -&gt; StaticVal -&gt; ShowS
[StaticVal] -&gt; ShowS
StaticVal -&gt; String
(Int -&gt; StaticVal -&gt; ShowS)
-&gt; (StaticVal -&gt; String)
-&gt; ([StaticVal] -&gt; ShowS)
-&gt; Show StaticVal
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [StaticVal] -&gt; ShowS
$cshowList :: [StaticVal] -&gt; ShowS
show :: StaticVal -&gt; String
$cshow :: StaticVal -&gt; String
showsPrec :: Int -&gt; StaticVal -&gt; ShowS
$cshowsPrec :: Int -&gt; StaticVal -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-comment">-- | The type is Just if this is a polymorphic binding that must be</span><span>
</span><span id="line-52"></span><span class="hs-comment">-- instantiated.</span><span>
</span><span id="line-53"></span><span class="hs-keyword">data</span><span> </span><span id="Binding"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Binding"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684524540"><span id="local-6989586621684524542"><span id="local-6989586621684524549"><span class="annot"><span class="annottext">Int -&gt; Binding -&gt; ShowS
[Binding] -&gt; ShowS
Binding -&gt; String
(Int -&gt; Binding -&gt; ShowS)
-&gt; (Binding -&gt; String) -&gt; ([Binding] -&gt; ShowS) -&gt; Show Binding
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [Binding] -&gt; ShowS
$cshowList :: [Binding] -&gt; ShowS
show :: Binding -&gt; String
$cshow :: Binding -&gt; String
showsPrec :: Int -&gt; Binding -&gt; ShowS
$cshowsPrec :: Int -&gt; Binding -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span>
</span><span id="line-56"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#bindingSV"><span class="hs-identifier hs-type">bindingSV</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span>
</span><span id="line-57"></span><span id="bindingSV"><span class="annot"><span class="annottext">bindingSV :: Binding -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#bindingSV"><span class="hs-identifier hs-var hs-var">bindingSV</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684524533"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524533"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524533"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-58"></span><span>
</span><span id="line-59"></span><span class="hs-comment">-- | Environment mapping variable names to their associated static</span><span>
</span><span id="line-60"></span><span class="hs-comment">-- value.</span><span>
</span><span id="line-61"></span><span class="hs-keyword">type</span><span> </span><span id="Env"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Env"><span class="hs-identifier hs-var">Env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span id="local-6989586621684525460"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#localEnv"><span class="hs-identifier hs-type">localEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684525460"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684525460"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-64"></span><span id="localEnv"><span class="annot"><span class="annottext">localEnv :: forall a. Env -&gt; DefM a -&gt; DefM a
</span><a href="Futhark.Internalise.Defunctionalise.html#localEnv"><span class="hs-identifier hs-var hs-var">localEnv</span></a></span></span><span> </span><span id="local-6989586621684524527"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524527"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Set VName, Env) -&gt; (Set VName, Env)) -&gt; DefM a -&gt; DefM a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">(((Set VName, Env) -&gt; (Set VName, Env)) -&gt; DefM a -&gt; DefM a)
-&gt; ((Set VName, Env) -&gt; (Set VName, Env)) -&gt; DefM a -&gt; DefM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Env -&gt; Env) -&gt; (Set VName, Env) -&gt; (Set VName, Env)
forall (a :: * -&gt; * -&gt; *) b c d.
Arrow a =&gt;
a b c -&gt; a (d, b) (d, c)
</span><span class="hs-identifier hs-var">Arrow.second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524527"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Env -&gt; Env
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span class="hs-comment">-- Even when using a &quot;new&quot; environment (for evaluating closures) we</span><span>
</span><span id="line-67"></span><span class="hs-comment">-- still ram the global environment of DynamicFuns in there.</span><span>
</span><span id="line-68"></span><span id="local-6989586621684524524"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#localNewEnv"><span class="hs-identifier hs-type">localNewEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684524524"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684524524"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-69"></span><span id="localNewEnv"><span class="annot"><span class="annottext">localNewEnv :: forall a. Env -&gt; DefM a -&gt; DefM a
</span><a href="Futhark.Internalise.Defunctionalise.html#localNewEnv"><span class="hs-identifier hs-var hs-var">localNewEnv</span></a></span></span><span> </span><span id="local-6989586621684524519"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524519"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Set VName, Env) -&gt; (Set VName, Env)) -&gt; DefM a -&gt; DefM a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">(((Set VName, Env) -&gt; (Set VName, Env)) -&gt; DefM a -&gt; DefM a)
-&gt; ((Set VName, Env) -&gt; (Set VName, Env)) -&gt; DefM a -&gt; DefM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684524518"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684524518"><span class="hs-identifier hs-var">globals</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684524517"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524517"><span class="hs-identifier hs-var">old_env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-70"></span><span>  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684524518"><span class="hs-identifier hs-var">globals</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Binding -&gt; Bool) -&gt; Env -&gt; Env
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.filterWithKey</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684524515"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684524515"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">Binding
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684524515"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684524518"><span class="hs-identifier hs-var">globals</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524517"><span class="hs-identifier hs-var">old_env</span></a></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Env -&gt; Env
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524519"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#askEnv"><span class="hs-identifier hs-type">askEnv</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span>
</span><span id="line-73"></span><span id="askEnv"><span class="annot"><span class="annottext">askEnv :: DefM Env
</span><a href="Futhark.Internalise.Defunctionalise.html#askEnv"><span class="hs-identifier hs-var hs-var">askEnv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Set VName, Env) -&gt; Env) -&gt; DefM Env
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">(Set VName, Env) -&gt; Env
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span>
</span><span id="line-74"></span><span>
</span><span id="line-75"></span><span id="local-6989586621684525437"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#areGlobal"><span class="hs-identifier hs-type">areGlobal</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684525437"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684525437"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-76"></span><span id="areGlobal"><span class="annot"><span class="annottext">areGlobal :: forall a. [VName] -&gt; DefM a -&gt; DefM a
</span><a href="Futhark.Internalise.Defunctionalise.html#areGlobal"><span class="hs-identifier hs-var hs-var">areGlobal</span></a></span></span><span> </span><span id="local-6989586621684524506"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684524506"><span class="hs-identifier hs-var">vs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Set VName, Env) -&gt; (Set VName, Env)) -&gt; DefM a -&gt; DefM a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="annot"><span class="annottext">(((Set VName, Env) -&gt; (Set VName, Env)) -&gt; DefM a -&gt; DefM a)
-&gt; ((Set VName, Env) -&gt; (Set VName, Env)) -&gt; DefM a -&gt; DefM a
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Set VName -&gt; Set VName) -&gt; (Set VName, Env) -&gt; (Set VName, Env)
forall (a :: * -&gt; * -&gt; *) b c d.
Arrow a =&gt;
a b c -&gt; a (b, d) (c, d)
</span><span class="hs-identifier hs-var">Arrow.first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684524506"><span class="hs-identifier hs-var">vs</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span class="hs-special">)</span><span>
</span><span id="line-77"></span><span>
</span><span id="line-78"></span><span id="local-6989586621684525431"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#replaceTypeSizes"><span class="hs-identifier hs-type">replaceTypeSizes</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-79"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-80"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684525431"><span class="hs-identifier hs-type">als</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-81"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684525431"><span class="hs-identifier hs-type">als</span></a></span></span><span>
</span><span id="line-82"></span><span id="replaceTypeSizes"><span class="annot"><span class="annottext">replaceTypeSizes :: forall als.
Map VName SizeSubst
-&gt; TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceTypeSizes"><span class="hs-identifier hs-var hs-var">replaceTypeSizes</span></a></span></span><span> </span><span id="local-6989586621684524502"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524502"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; DimDecl VName)
-&gt; TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; DimDecl VName
</span><a href="#local-6989586621684524500"><span class="hs-identifier hs-var">onDim</span></a></span><span>
</span><span id="line-83"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-84"></span><span>    </span><span id="local-6989586621684524500"><span class="annot"><span class="annottext">onDim :: DimDecl VName -&gt; DimDecl VName
</span><a href="#local-6989586621684524500"><span class="hs-identifier hs-var hs-var">onDim</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684524497"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524497"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-85"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName SizeSubst -&gt; Maybe SizeSubst
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524497"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524502"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-86"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SubstNamed"><span class="hs-identifier hs-type">SubstNamed</span></a></span><span> </span><span id="local-6989586621684524493"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524493"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524493"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-87"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SubstConst"><span class="hs-identifier hs-type">SubstConst</span></a></span><span> </span><span id="local-6989586621684524491"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684524491"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Int -&gt; DimDecl VName
forall vn. Int -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#ConstDim"><span class="hs-identifier hs-var">ConstDim</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684524491"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-88"></span><span>        </span><span class="annot"><span class="annottext">Maybe SizeSubst
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524497"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-89"></span><span>    </span><span class="annot"><a href="#local-6989586621684524500"><span class="hs-identifier hs-var">onDim</span></a></span><span> </span><span id="local-6989586621684524489"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684524489"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684524489"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#replaceStaticValSizes"><span class="hs-identifier hs-type">replaceStaticValSizes</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-92"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-94"></span><span>  </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-95"></span><span>  </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span>
</span><span id="line-96"></span><span id="replaceStaticValSizes"><span class="annot"><span class="annottext">replaceStaticValSizes :: Set VName -&gt; Map VName SizeSubst -&gt; StaticVal -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceStaticValSizes"><span class="hs-identifier hs-var hs-var">replaceStaticValSizes</span></a></span></span><span> </span><span id="local-6989586621684524487"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684524487"><span class="hs-identifier hs-var">globals</span></a></span></span><span> </span><span id="local-6989586621684524486"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524486"><span class="hs-identifier hs-var">orig_substs</span></a></span></span><span> </span><span id="local-6989586621684524485"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524485"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-97"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524485"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-98"></span><span>    </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; Bool
forall k a. Map k a -&gt; Bool
</span><span class="hs-identifier hs-var">M.null</span></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524486"><span class="hs-identifier hs-var">orig_substs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524485"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-99"></span><span>    </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#LambdaSV"><span class="hs-identifier hs-type">LambdaSV</span></a></span><span> </span><span id="local-6989586621684524483"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684524483"><span class="hs-identifier hs-var">param</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684524481"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684524481"><span class="hs-identifier hs-var">t_dims</span></a></span></span><span> </span><span id="local-6989586621684524480"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684524480"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684524479"><span class="annot"><span class="annottext">ExtExp
</span><a href="#local-6989586621684524479"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684524478"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524478"><span class="hs-identifier hs-var">closure_env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-100"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684524474"><span class="annot"><span class="annottext">substs :: Map VName SizeSubst
</span><a href="#local-6989586621684524474"><span class="hs-identifier hs-var hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-101"></span><span>            </span><span class="annot"><span class="annottext">(Map VName SizeSubst -&gt; VName -&gt; Map VName SizeSubst)
-&gt; Map VName SizeSubst -&gt; Set VName -&gt; Map VName SizeSubst
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; Map VName SizeSubst -&gt; Map VName SizeSubst)
-&gt; Map VName SizeSubst -&gt; VName -&gt; Map VName SizeSubst
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName SizeSubst -&gt; Map VName SizeSubst
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.delete</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524486"><span class="hs-identifier hs-var">orig_substs</span></a></span><span> </span><span class="annot"><span class="annottext">(Set VName -&gt; Map VName SizeSubst)
-&gt; Set VName -&gt; Map VName SizeSubst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-102"></span><span>              </span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env -&gt; [VName]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524478"><span class="hs-identifier hs-var">closure_env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-103"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StructRetType -&gt; ExtExp -&gt; Env -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#LambdaSV"><span class="hs-identifier hs-var">LambdaSV</span></a></span><span>
</span><span id="line-104"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; PatBase Info VName -&gt; PatBase Info VName
forall x. ASTMappable x =&gt; Map VName SizeSubst -&gt; x -&gt; x
</span><a href="#local-6989586621684524469"><span class="hs-identifier hs-var">onAST</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524474"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684524483"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-105"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684524481"><span class="hs-identifier hs-var">t_dims</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; StructType -&gt; StructType
forall als.
Map VName SizeSubst
-&gt; TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceTypeSizes"><span class="hs-identifier hs-var">replaceTypeSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524474"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684524480"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-106"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; ExtExp -&gt; ExtExp
</span><a href="#local-6989586621684524468"><span class="hs-identifier hs-var">onExtExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524474"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">ExtExp
</span><a href="#local-6989586621684524479"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-107"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; Env -&gt; Env
forall {k}.
Ord k =&gt;
Map VName SizeSubst -&gt; Map k Binding -&gt; Map k Binding
</span><a href="#local-6989586621684524467"><span class="hs-identifier hs-var">onEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524486"><span class="hs-identifier hs-var">orig_substs</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524478"><span class="hs-identifier hs-var">closure_env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">--intentional</span><span>
</span><span id="line-108"></span><span>    </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a></span><span> </span><span id="local-6989586621684524466"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684524466"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-109"></span><span>      </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; PatType -&gt; PatType
forall als.
Map VName SizeSubst
-&gt; TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceTypeSizes"><span class="hs-identifier hs-var">replaceTypeSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524486"><span class="hs-identifier hs-var">orig_substs</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684524466"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-110"></span><span>    </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-type">RecordSV</span></a></span><span> </span><span id="local-6989586621684524465"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684524465"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-111"></span><span>      </span><span class="annot"><span class="annottext">[(Name, StaticVal)] -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-var">RecordSV</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, StaticVal)] -&gt; StaticVal)
-&gt; [(Name, StaticVal)] -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Name, StaticVal) -&gt; (Name, StaticVal))
-&gt; [(Name, StaticVal)] -&gt; [(Name, StaticVal)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StaticVal -&gt; StaticVal) -&gt; (Name, StaticVal) -&gt; (Name, StaticVal)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set VName -&gt; Map VName SizeSubst -&gt; StaticVal -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceStaticValSizes"><span class="hs-identifier hs-var">replaceStaticValSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684524487"><span class="hs-identifier hs-var">globals</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524486"><span class="hs-identifier hs-var">orig_substs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684524465"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-112"></span><span>    </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SumSV"><span class="hs-identifier hs-type">SumSV</span></a></span><span> </span><span id="local-6989586621684524464"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684524464"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621684524463"><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684524463"><span class="hs-identifier hs-var">svs</span></a></span></span><span> </span><span id="local-6989586621684524462"><span class="annot"><span class="annottext">[(Name, [PatType])]
</span><a href="#local-6989586621684524462"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-113"></span><span>      </span><span class="annot"><span class="annottext">Name -&gt; [StaticVal] -&gt; [(Name, [PatType])] -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#SumSV"><span class="hs-identifier hs-var">SumSV</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684524464"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StaticVal -&gt; StaticVal) -&gt; [StaticVal] -&gt; [StaticVal]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set VName -&gt; Map VName SizeSubst -&gt; StaticVal -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceStaticValSizes"><span class="hs-identifier hs-var">replaceStaticValSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684524487"><span class="hs-identifier hs-var">globals</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524486"><span class="hs-identifier hs-var">orig_substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684524463"><span class="hs-identifier hs-var">svs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(Name, [PatType])] -&gt; StaticVal)
-&gt; [(Name, [PatType])] -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-114"></span><span>        </span><span class="annot"><span class="annottext">((Name, [PatType]) -&gt; (Name, [PatType]))
-&gt; [(Name, [PatType])] -&gt; [(Name, [PatType])]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([PatType] -&gt; [PatType]) -&gt; (Name, [PatType]) -&gt; (Name, [PatType])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(([PatType] -&gt; [PatType])
 -&gt; (Name, [PatType]) -&gt; (Name, [PatType]))
-&gt; ([PatType] -&gt; [PatType])
-&gt; (Name, [PatType])
-&gt; (Name, [PatType])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; PatType) -&gt; [PatType] -&gt; [PatType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">((PatType -&gt; PatType) -&gt; [PatType] -&gt; [PatType])
-&gt; (PatType -&gt; PatType) -&gt; [PatType] -&gt; [PatType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; PatType -&gt; PatType
forall als.
Map VName SizeSubst
-&gt; TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceTypeSizes"><span class="hs-identifier hs-var">replaceTypeSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524486"><span class="hs-identifier hs-var">orig_substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, [PatType])]
</span><a href="#local-6989586621684524462"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-115"></span><span>    </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-type">DynamicFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684524461"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684524461"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684524460"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524460"><span class="hs-identifier hs-var">sv1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684524459"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524459"><span class="hs-identifier hs-var">sv2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-116"></span><span>      </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; StaticVal -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-var">DynamicFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; Exp -&gt; Exp
</span><a href="#local-6989586621684524458"><span class="hs-identifier hs-var">onExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524486"><span class="hs-identifier hs-var">orig_substs</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684524461"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Map VName SizeSubst -&gt; StaticVal -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceStaticValSizes"><span class="hs-identifier hs-var">replaceStaticValSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684524487"><span class="hs-identifier hs-var">globals</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524486"><span class="hs-identifier hs-var">orig_substs</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524460"><span class="hs-identifier hs-var">sv1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; StaticVal) -&gt; StaticVal -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-117"></span><span>        </span><span class="annot"><span class="annottext">Set VName -&gt; Map VName SizeSubst -&gt; StaticVal -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceStaticValSizes"><span class="hs-identifier hs-var">replaceStaticValSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684524487"><span class="hs-identifier hs-var">globals</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524486"><span class="hs-identifier hs-var">orig_substs</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524459"><span class="hs-identifier hs-var">sv2</span></a></span><span>
</span><span id="line-118"></span><span>    </span><span class="annot"><span class="annottext">StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#IntrinsicSV"><span class="hs-identifier hs-var">IntrinsicSV</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-119"></span><span>      </span><span class="annot"><span class="annottext">StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#IntrinsicSV"><span class="hs-identifier hs-var">IntrinsicSV</span></a></span><span>
</span><span id="line-120"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-121"></span><span>    </span><span id="local-6989586621684524449"><span class="annot"><span class="annottext">tv :: Map VName SizeSubst -&gt; ASTMapper m
</span><a href="#local-6989586621684524449"><span class="hs-identifier hs-var hs-var">tv</span></a></span></span><span> </span><span id="local-6989586621684524448"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524448"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-122"></span><span>      </span><span class="annot"><span class="annottext">ASTMapper m
forall (m :: * -&gt; *). Monad m =&gt; ASTMapper m
</span><a href="Language.Futhark.Traversals.html#identityMapper"><span class="hs-identifier hs-var">identityMapper</span></a></span><span>
</span><span id="line-123"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">mapOnPatType :: PatType -&gt; m PatType
</span><a href="Language.Futhark.Traversals.html#mapOnPatType"><span class="hs-identifier hs-var">mapOnPatType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; m PatType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; m PatType)
-&gt; (PatType -&gt; PatType) -&gt; PatType -&gt; m PatType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; PatType -&gt; PatType
forall als.
Map VName SizeSubst
-&gt; TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceTypeSizes"><span class="hs-identifier hs-var">replaceTypeSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524448"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-124"></span><span>          </span><span class="annot"><span class="annottext">mapOnStructType :: StructType -&gt; m StructType
</span><a href="Language.Futhark.Traversals.html#mapOnStructType"><span class="hs-identifier hs-var">mapOnStructType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StructType -&gt; m StructType
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; m StructType)
-&gt; (StructType -&gt; StructType) -&gt; StructType -&gt; m StructType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; StructType -&gt; StructType
forall als.
Map VName SizeSubst
-&gt; TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceTypeSizes"><span class="hs-identifier hs-var">replaceTypeSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524448"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-125"></span><span>          </span><span class="annot"><span class="annottext">mapOnExp :: Exp -&gt; m Exp
</span><a href="Language.Futhark.Traversals.html#mapOnExp"><span class="hs-identifier hs-var">mapOnExp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; m Exp
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; m Exp) -&gt; (Exp -&gt; Exp) -&gt; Exp -&gt; m Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; Exp -&gt; Exp
</span><a href="#local-6989586621684524458"><span class="hs-identifier hs-var">onExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524448"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-126"></span><span>          </span><span class="annot"><span class="annottext">mapOnName :: VName -&gt; m VName
</span><a href="Language.Futhark.Traversals.html#mapOnName"><span class="hs-identifier hs-var">mapOnName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; m VName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; m VName) -&gt; (VName -&gt; VName) -&gt; VName -&gt; m VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; VName -&gt; VName
</span><a href="#local-6989586621684524441"><span class="hs-identifier hs-var">onName</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524448"><span class="hs-identifier hs-var">substs</span></a></span><span>
</span><span id="line-127"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-128"></span><span>
</span><span id="line-129"></span><span>    </span><span id="local-6989586621684524441"><span class="annot"><span class="annottext">onName :: Map VName SizeSubst -&gt; VName -&gt; VName
</span><a href="#local-6989586621684524441"><span class="hs-identifier hs-var hs-var">onName</span></a></span></span><span> </span><span id="local-6989586621684524439"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524439"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span id="local-6989586621684524438"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684524438"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-130"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName SizeSubst -&gt; Maybe SizeSubst
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684524438"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524439"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-131"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SubstNamed"><span class="hs-identifier hs-type">SubstNamed</span></a></span><span> </span><span id="local-6989586621684524437"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524437"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524437"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-132"></span><span>        </span><span class="annot"><span class="annottext">Maybe SizeSubst
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684524438"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-133"></span><span>
</span><span id="line-134"></span><span>    </span><span id="local-6989586621684524458"><span class="annot"><span class="annottext">onExp :: Map VName SizeSubst -&gt; Exp -&gt; Exp
</span><a href="#local-6989586621684524458"><span class="hs-identifier hs-var hs-var">onExp</span></a></span></span><span> </span><span id="local-6989586621684524428"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524428"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684524426"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524426"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684524425"><span class="annot"><span class="annottext">Info PatType
</span><a href="#local-6989586621684524425"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684524424"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524424"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-135"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName SizeSubst -&gt; Maybe SizeSubst
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524426"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524428"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-136"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SubstNamed"><span class="hs-identifier hs-type">SubstNamed</span></a></span><span> </span><span id="local-6989586621684524423"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524423"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-137"></span><span>          </span><span class="annot"><span class="annottext">QualName VName -&gt; Info PatType -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
QualName vn -&gt; f PatType -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524423"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><a href="#local-6989586621684524425"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524424"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-138"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SubstConst"><span class="hs-identifier hs-type">SubstConst</span></a></span><span> </span><span id="local-6989586621684524422"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684524422"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-139"></span><span>          </span><span class="annot"><span class="annottext">PrimValue -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn. PrimValue -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Literal"><span class="hs-identifier hs-var">Literal</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntValue -&gt; PrimValue
</span><a href="Language.Futhark.Syntax.html#SignedValue"><span class="hs-identifier hs-var">SignedValue</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int64 -&gt; IntValue
</span><a href="Futhark.IR.Primitive.html#Int64Value"><span class="hs-identifier hs-var">Int64Value</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; Int64
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">fromIntegral</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684524422"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524424"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-140"></span><span>        </span><span class="annot"><span class="annottext">Maybe SizeSubst
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-141"></span><span>          </span><span class="annot"><span class="annottext">QualName VName -&gt; Info PatType -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
QualName vn -&gt; f PatType -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524426"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; PatType -&gt; PatType
forall als.
Map VName SizeSubst
-&gt; TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceTypeSizes"><span class="hs-identifier hs-var">replaceTypeSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524428"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; PatType) -&gt; Info PatType -&gt; Info PatType
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><a href="#local-6989586621684524425"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524424"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-142"></span><span>    </span><span class="annot"><a href="#local-6989586621684524458"><span class="hs-identifier hs-var">onExp</span></a></span><span> </span><span id="local-6989586621684524417"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524417"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Coerce"><span class="hs-identifier hs-type">Coerce</span></a></span><span> </span><span id="local-6989586621684524414"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684524414"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684524413"><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><a href="#local-6989586621684524413"><span class="hs-identifier hs-var">tdecl</span></a></span></span><span> </span><span id="local-6989586621684524412"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524412"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppRes"><span class="hs-identifier hs-type">AppRes</span></a></span><span> </span><span id="local-6989586621684524409"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684524409"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684524408"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684524408"><span class="hs-identifier hs-var">ext</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-143"></span><span>      </span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; TypeDeclBase Info VName -&gt; SrcLoc -&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
ExpBase f vn -&gt; TypeDeclBase f vn -&gt; SrcLoc -&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Coerce"><span class="hs-identifier hs-var">Coerce</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; Exp -&gt; Exp
</span><a href="#local-6989586621684524458"><span class="hs-identifier hs-var">onExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524417"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684524414"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><a href="#local-6989586621684524407"><span class="hs-identifier hs-var">tdecl'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524412"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AppRes -&gt; Info AppRes
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; [VName] -&gt; AppRes
</span><a href="Language.Futhark.Syntax.html#AppRes"><span class="hs-identifier hs-var">AppRes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; PatType -&gt; PatType
forall als.
Map VName SizeSubst
-&gt; TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceTypeSizes"><span class="hs-identifier hs-var">replaceTypeSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524417"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684524409"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684524408"><span class="hs-identifier hs-var">ext</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-145"></span><span>        </span><span id="local-6989586621684524407"><span class="annot"><span class="annottext">tdecl' :: TypeDeclBase Info VName
</span><a href="#local-6989586621684524407"><span class="hs-identifier hs-var hs-var">tdecl'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-146"></span><span>          </span><span class="annot"><span class="annottext">TypeDecl :: forall (f :: * -&gt; *) vn.
TypeExp vn -&gt; f StructType -&gt; TypeDeclBase f vn
</span><a href="Language.Futhark.Syntax.html#TypeDecl"><span class="hs-identifier hs-type">TypeDecl</span></a></span><span>
</span><span id="line-147"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">declaredType :: TypeExp VName
</span><a href="Language.Futhark.Syntax.html#declaredType"><span class="hs-identifier hs-var">declaredType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; TypeExp VName -&gt; TypeExp VName
</span><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524417"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeExp VName -&gt; TypeExp VName) -&gt; TypeExp VName -&gt; TypeExp VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info VName -&gt; TypeExp VName
forall (f :: * -&gt; *) vn. TypeDeclBase f vn -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#declaredType"><span class="hs-identifier hs-var hs-var">declaredType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><a href="#local-6989586621684524413"><span class="hs-identifier hs-var">tdecl</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-148"></span><span>              </span><span class="annot"><span class="annottext">expandedType :: Info StructType
</span><a href="Language.Futhark.Syntax.html#expandedType"><span class="hs-identifier hs-var">expandedType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; StructType -&gt; StructType
forall als.
Map VName SizeSubst
-&gt; TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceTypeSizes"><span class="hs-identifier hs-var">replaceTypeSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524417"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; StructType) -&gt; Info StructType -&gt; Info StructType
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info VName -&gt; Info StructType
forall (f :: * -&gt; *) vn. TypeDeclBase f vn -&gt; f StructType
</span><a href="Language.Futhark.Syntax.html#expandedType"><span class="hs-identifier hs-var hs-var">expandedType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><a href="#local-6989586621684524413"><span class="hs-identifier hs-var">tdecl</span></a></span><span>
</span><span id="line-149"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-150"></span><span>    </span><span class="annot"><a href="#local-6989586621684524458"><span class="hs-identifier hs-var">onExp</span></a></span><span> </span><span id="local-6989586621684524401"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524401"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span id="local-6989586621684524400"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684524400"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; Exp -&gt; Exp
forall x. ASTMappable x =&gt; Map VName SizeSubst -&gt; x -&gt; x
</span><a href="#local-6989586621684524469"><span class="hs-identifier hs-var">onAST</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524401"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684524400"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-151"></span><span>
</span><span id="line-152"></span><span>    </span><span id="local-6989586621684524398"><span class="annot"><span class="annottext">onTypeExpDim :: Map VName SizeSubst -&gt; DimExp VName -&gt; DimExp VName
</span><a href="#local-6989586621684524398"><span class="hs-identifier hs-var hs-var">onTypeExpDim</span></a></span></span><span> </span><span id="local-6989586621684524397"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524397"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span id="local-6989586621684524396"><span class="annot"><span class="annottext">d :: DimExp VName
</span><a href="#local-6989586621684524396"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimExpNamed"><span class="hs-identifier hs-type">DimExpNamed</span></a></span><span> </span><span id="local-6989586621684524394"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524394"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684524393"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524393"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-153"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName SizeSubst -&gt; Maybe SizeSubst
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524394"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524397"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-154"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SubstNamed"><span class="hs-identifier hs-type">SubstNamed</span></a></span><span> </span><span id="local-6989586621684524392"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524392"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-155"></span><span>          </span><span class="annot"><span class="annottext">QualName VName -&gt; SrcLoc -&gt; DimExp VName
forall vn. QualName vn -&gt; SrcLoc -&gt; DimExp vn
</span><a href="Language.Futhark.Syntax.html#DimExpNamed"><span class="hs-identifier hs-var">DimExpNamed</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524392"><span class="hs-identifier hs-var">v'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524393"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-156"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SubstConst"><span class="hs-identifier hs-type">SubstConst</span></a></span><span> </span><span id="local-6989586621684524391"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684524391"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-157"></span><span>          </span><span class="annot"><span class="annottext">Int -&gt; SrcLoc -&gt; DimExp VName
forall vn. Int -&gt; SrcLoc -&gt; DimExp vn
</span><a href="Language.Futhark.Syntax.html#DimExpConst"><span class="hs-identifier hs-var">DimExpConst</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684524391"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524393"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-158"></span><span>        </span><span class="annot"><span class="annottext">Maybe SizeSubst
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-159"></span><span>          </span><span class="annot"><span class="annottext">DimExp VName
</span><a href="#local-6989586621684524396"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-160"></span><span>    </span><span class="annot"><a href="#local-6989586621684524398"><span class="hs-identifier hs-var">onTypeExpDim</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684524389"><span class="annot"><span class="annottext">DimExp VName
</span><a href="#local-6989586621684524389"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimExp VName
</span><a href="#local-6989586621684524389"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-161"></span><span>
</span><span id="line-162"></span><span>    </span><span id="local-6989586621684524386"><span class="annot"><span class="annottext">onTypeArgExp :: Map VName SizeSubst -&gt; TypeArgExp VName -&gt; TypeArgExp VName
</span><a href="#local-6989586621684524386"><span class="hs-identifier hs-var hs-var">onTypeArgExp</span></a></span></span><span> </span><span id="local-6989586621684524385"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524385"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgExpDim"><span class="hs-identifier hs-type">TypeArgExpDim</span></a></span><span> </span><span id="local-6989586621684524383"><span class="annot"><span class="annottext">DimExp VName
</span><a href="#local-6989586621684524383"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621684524382"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524382"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-163"></span><span>      </span><span class="annot"><span class="annottext">DimExp VName -&gt; SrcLoc -&gt; TypeArgExp VName
forall vn. DimExp vn -&gt; SrcLoc -&gt; TypeArgExp vn
</span><a href="Language.Futhark.Syntax.html#TypeArgExpDim"><span class="hs-identifier hs-var">TypeArgExpDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; DimExp VName -&gt; DimExp VName
</span><a href="#local-6989586621684524398"><span class="hs-identifier hs-var">onTypeExpDim</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524385"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">DimExp VName
</span><a href="#local-6989586621684524383"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524382"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-164"></span><span>    </span><span class="annot"><a href="#local-6989586621684524386"><span class="hs-identifier hs-var">onTypeArgExp</span></a></span><span> </span><span id="local-6989586621684524381"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524381"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgExpType"><span class="hs-identifier hs-type">TypeArgExpType</span></a></span><span> </span><span id="local-6989586621684524379"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684524379"><span class="hs-identifier hs-var">te</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-165"></span><span>      </span><span class="annot"><span class="annottext">TypeExp VName -&gt; TypeArgExp VName
forall vn. TypeExp vn -&gt; TypeArgExp vn
</span><a href="Language.Futhark.Syntax.html#TypeArgExpType"><span class="hs-identifier hs-var">TypeArgExpType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; TypeExp VName -&gt; TypeExp VName
</span><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524381"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684524379"><span class="hs-identifier hs-var">te</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-166"></span><span>
</span><span id="line-167"></span><span>    </span><span id="local-6989586621684524403"><span class="annot"><span class="annottext">onTypeExp :: Map VName SizeSubst -&gt; TypeExp VName -&gt; TypeExp VName
</span><a href="#local-6989586621684524403"><span class="hs-identifier hs-var hs-var">onTypeExp</span></a></span></span><span> </span><span id="local-6989586621684524378"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524378"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEArray"><span class="hs-identifier hs-type">TEArray</span></a></span><span> </span><span id="local-6989586621684524376"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684524376"><span class="hs-identifier hs-var">te</span></a></span></span><span> </span><span id="local-6989586621684524375"><span class="annot"><span class="annottext">DimExp VName
</span><a href="#local-6989586621684524375"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621684524374"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524374"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-168"></span><span>      </span><span class="annot"><span class="annottext">TypeExp VName -&gt; DimExp VName -&gt; SrcLoc -&gt; TypeExp VName
forall vn. TypeExp vn -&gt; DimExp vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEArray"><span class="hs-identifier hs-var">TEArray</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; TypeExp VName -&gt; TypeExp VName
</span><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524378"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684524376"><span class="hs-identifier hs-var">te</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; DimExp VName -&gt; DimExp VName
</span><a href="#local-6989586621684524398"><span class="hs-identifier hs-var">onTypeExpDim</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524378"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">DimExp VName
</span><a href="#local-6989586621684524375"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524374"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-169"></span><span>    </span><span class="annot"><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span id="local-6989586621684524373"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524373"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEUnique"><span class="hs-identifier hs-type">TEUnique</span></a></span><span> </span><span id="local-6989586621684524371"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684524371"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684524370"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524370"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-170"></span><span>      </span><span class="annot"><span class="annottext">TypeExp VName -&gt; SrcLoc -&gt; TypeExp VName
forall vn. TypeExp vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEUnique"><span class="hs-identifier hs-var">TEUnique</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; TypeExp VName -&gt; TypeExp VName
</span><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524373"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684524371"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524370"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-171"></span><span>    </span><span class="annot"><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span id="local-6989586621684524369"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524369"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEApply"><span class="hs-identifier hs-type">TEApply</span></a></span><span> </span><span id="local-6989586621684524367"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684524367"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684524366"><span class="annot"><span class="annottext">TypeArgExp VName
</span><a href="#local-6989586621684524366"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span id="local-6989586621684524365"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524365"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-172"></span><span>      </span><span class="annot"><span class="annottext">TypeExp VName -&gt; TypeArgExp VName -&gt; SrcLoc -&gt; TypeExp VName
forall vn. TypeExp vn -&gt; TypeArgExp vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEApply"><span class="hs-identifier hs-var">TEApply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; TypeExp VName -&gt; TypeExp VName
</span><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524369"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684524367"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; TypeArgExp VName -&gt; TypeArgExp VName
</span><a href="#local-6989586621684524386"><span class="hs-identifier hs-var">onTypeArgExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524369"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">TypeArgExp VName
</span><a href="#local-6989586621684524366"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524365"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-173"></span><span>    </span><span class="annot"><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span id="local-6989586621684524364"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524364"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEArrow"><span class="hs-identifier hs-type">TEArrow</span></a></span><span> </span><span id="local-6989586621684524362"><span class="annot"><span class="annottext">Maybe VName
</span><a href="#local-6989586621684524362"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684524361"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684524361"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684524360"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684524360"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span id="local-6989586621684524359"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524359"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-174"></span><span>      </span><span class="annot"><span class="annottext">Maybe VName
-&gt; TypeExp VName -&gt; TypeExp VName -&gt; SrcLoc -&gt; TypeExp VName
forall vn.
Maybe vn -&gt; TypeExp vn -&gt; TypeExp vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEArrow"><span class="hs-identifier hs-var">TEArrow</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe VName
</span><a href="#local-6989586621684524362"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; TypeExp VName -&gt; TypeExp VName
</span><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524364"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684524361"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; TypeExp VName -&gt; TypeExp VName
</span><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524364"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684524360"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524359"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-175"></span><span>    </span><span class="annot"><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span id="local-6989586621684524358"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524358"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TETuple"><span class="hs-identifier hs-type">TETuple</span></a></span><span> </span><span id="local-6989586621684524356"><span class="annot"><span class="annottext">[TypeExp VName]
</span><a href="#local-6989586621684524356"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684524355"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524355"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-176"></span><span>      </span><span class="annot"><span class="annottext">[TypeExp VName] -&gt; SrcLoc -&gt; TypeExp VName
forall vn. [TypeExp vn] -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TETuple"><span class="hs-identifier hs-var">TETuple</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeExp VName -&gt; TypeExp VName)
-&gt; [TypeExp VName] -&gt; [TypeExp VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; TypeExp VName -&gt; TypeExp VName
</span><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524358"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[TypeExp VName]
</span><a href="#local-6989586621684524356"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524355"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-177"></span><span>    </span><span class="annot"><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span id="local-6989586621684524354"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524354"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TERecord"><span class="hs-identifier hs-type">TERecord</span></a></span><span> </span><span id="local-6989586621684524352"><span class="annot"><span class="annottext">[(Name, TypeExp VName)]
</span><a href="#local-6989586621684524352"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684524351"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524351"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-178"></span><span>      </span><span class="annot"><span class="annottext">[(Name, TypeExp VName)] -&gt; SrcLoc -&gt; TypeExp VName
forall vn. [(Name, TypeExp vn)] -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TERecord"><span class="hs-identifier hs-var">TERecord</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, TypeExp VName) -&gt; (Name, TypeExp VName))
-&gt; [(Name, TypeExp VName)] -&gt; [(Name, TypeExp VName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeExp VName -&gt; TypeExp VName)
-&gt; (Name, TypeExp VName) -&gt; (Name, TypeExp VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">((TypeExp VName -&gt; TypeExp VName)
 -&gt; (Name, TypeExp VName) -&gt; (Name, TypeExp VName))
-&gt; (TypeExp VName -&gt; TypeExp VName)
-&gt; (Name, TypeExp VName)
-&gt; (Name, TypeExp VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; TypeExp VName -&gt; TypeExp VName
</span><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524354"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, TypeExp VName)]
</span><a href="#local-6989586621684524352"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524351"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-179"></span><span>    </span><span class="annot"><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span id="local-6989586621684524350"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524350"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TESum"><span class="hs-identifier hs-type">TESum</span></a></span><span> </span><span id="local-6989586621684524348"><span class="annot"><span class="annottext">[(Name, [TypeExp VName])]
</span><a href="#local-6989586621684524348"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span id="local-6989586621684524347"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524347"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-180"></span><span>      </span><span class="annot"><span class="annottext">[(Name, [TypeExp VName])] -&gt; SrcLoc -&gt; TypeExp VName
forall vn. [(Name, [TypeExp vn])] -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TESum"><span class="hs-identifier hs-var">TESum</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, [TypeExp VName]) -&gt; (Name, [TypeExp VName]))
-&gt; [(Name, [TypeExp VName])] -&gt; [(Name, [TypeExp VName])]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([TypeExp VName] -&gt; [TypeExp VName])
-&gt; (Name, [TypeExp VName]) -&gt; (Name, [TypeExp VName])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(([TypeExp VName] -&gt; [TypeExp VName])
 -&gt; (Name, [TypeExp VName]) -&gt; (Name, [TypeExp VName]))
-&gt; ([TypeExp VName] -&gt; [TypeExp VName])
-&gt; (Name, [TypeExp VName])
-&gt; (Name, [TypeExp VName])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeExp VName -&gt; TypeExp VName)
-&gt; [TypeExp VName] -&gt; [TypeExp VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">((TypeExp VName -&gt; TypeExp VName)
 -&gt; [TypeExp VName] -&gt; [TypeExp VName])
-&gt; (TypeExp VName -&gt; TypeExp VName)
-&gt; [TypeExp VName]
-&gt; [TypeExp VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; TypeExp VName -&gt; TypeExp VName
</span><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524350"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, [TypeExp VName])]
</span><a href="#local-6989586621684524348"><span class="hs-identifier hs-var">ts</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524347"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-181"></span><span>    </span><span class="annot"><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span id="local-6989586621684524346"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524346"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEDim"><span class="hs-identifier hs-type">TEDim</span></a></span><span> </span><span id="local-6989586621684524344"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684524344"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684524343"><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684524343"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684524342"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524342"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-182"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; TypeExp VName -&gt; SrcLoc -&gt; TypeExp VName
forall vn. [vn] -&gt; TypeExp vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEDim"><span class="hs-identifier hs-var">TEDim</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684524344"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; TypeExp VName -&gt; TypeExp VName
</span><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524346"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">TypeExp VName
</span><a href="#local-6989586621684524343"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524342"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-183"></span><span>    </span><span class="annot"><a href="#local-6989586621684524403"><span class="hs-identifier hs-var">onTypeExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TEVar"><span class="hs-identifier hs-type">TEVar</span></a></span><span> </span><span id="local-6989586621684524340"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524340"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684524339"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524339"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-184"></span><span>      </span><span class="annot"><span class="annottext">QualName VName -&gt; SrcLoc -&gt; TypeExp VName
forall vn. QualName vn -&gt; SrcLoc -&gt; TypeExp vn
</span><a href="Language.Futhark.Syntax.html#TEVar"><span class="hs-identifier hs-var">TEVar</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524340"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524339"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-185"></span><span>
</span><span id="line-186"></span><span>    </span><span id="local-6989586621684524468"><span class="annot"><span class="annottext">onExtExp :: Map VName SizeSubst -&gt; ExtExp -&gt; ExtExp
</span><a href="#local-6989586621684524468"><span class="hs-identifier hs-var hs-var">onExtExp</span></a></span></span><span> </span><span id="local-6989586621684524337"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524337"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#ExtExp"><span class="hs-identifier hs-type">ExtExp</span></a></span><span> </span><span id="local-6989586621684524336"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684524336"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-187"></span><span>      </span><span class="annot"><span class="annottext">Exp -&gt; ExtExp
</span><a href="Futhark.Internalise.Defunctionalise.html#ExtExp"><span class="hs-identifier hs-var">ExtExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; ExtExp) -&gt; Exp -&gt; ExtExp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; Exp -&gt; Exp
</span><a href="#local-6989586621684524458"><span class="hs-identifier hs-var">onExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524337"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684524336"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-188"></span><span>    </span><span class="annot"><a href="#local-6989586621684524468"><span class="hs-identifier hs-var">onExtExp</span></a></span><span> </span><span id="local-6989586621684524335"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524335"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#ExtLambda"><span class="hs-identifier hs-type">ExtLambda</span></a></span><span> </span><span id="local-6989586621684524334"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684524334"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684524333"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684524333"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684524332"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684524332"><span class="hs-identifier hs-var">t_dims</span></a></span></span><span> </span><span id="local-6989586621684524331"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684524331"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684524330"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524330"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-189"></span><span>      </span><span class="annot"><span class="annottext">[PatBase Info VName] -&gt; Exp -&gt; StructRetType -&gt; SrcLoc -&gt; ExtExp
</span><a href="Futhark.Internalise.Defunctionalise.html#ExtLambda"><span class="hs-identifier hs-var">ExtLambda</span></a></span><span>
</span><span id="line-190"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; PatBase Info VName)
-&gt; [PatBase Info VName] -&gt; [PatBase Info VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; PatBase Info VName -&gt; PatBase Info VName
forall x. ASTMappable x =&gt; Map VName SizeSubst -&gt; x -&gt; x
</span><a href="#local-6989586621684524469"><span class="hs-identifier hs-var">onAST</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524335"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684524334"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-191"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; Exp -&gt; Exp
</span><a href="#local-6989586621684524458"><span class="hs-identifier hs-var">onExp</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524335"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684524333"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684524332"><span class="hs-identifier hs-var">t_dims</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; StructType -&gt; StructType
forall als.
Map VName SizeSubst
-&gt; TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceTypeSizes"><span class="hs-identifier hs-var">replaceTypeSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524335"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684524331"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-193"></span><span>        </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684524330"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-194"></span><span>
</span><span id="line-195"></span><span>    </span><span id="local-6989586621684524467"><span class="annot"><span class="annottext">onEnv :: Map VName SizeSubst -&gt; Map k Binding -&gt; Map k Binding
</span><a href="#local-6989586621684524467"><span class="hs-identifier hs-var hs-var">onEnv</span></a></span></span><span> </span><span id="local-6989586621684524326"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524326"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-196"></span><span>      </span><span class="annot"><span class="annottext">[(k, Binding)] -&gt; Map k Binding
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span>
</span><span id="line-197"></span><span>        </span><span class="annot"><span class="annottext">([(k, Binding)] -&gt; Map k Binding)
-&gt; (Map k Binding -&gt; [(k, Binding)])
-&gt; Map k Binding
-&gt; Map k Binding
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((k, Binding) -&gt; (k, Binding)) -&gt; [(k, Binding)] -&gt; [(k, Binding)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Binding -&gt; Binding) -&gt; (k, Binding) -&gt; (k, Binding)
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; Binding -&gt; Binding
</span><a href="#local-6989586621684524323"><span class="hs-identifier hs-var">onBinding</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524326"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-198"></span><span>        </span><span class="annot"><span class="annottext">([(k, Binding)] -&gt; [(k, Binding)])
-&gt; (Map k Binding -&gt; [(k, Binding)])
-&gt; Map k Binding
-&gt; [(k, Binding)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map k Binding -&gt; [(k, Binding)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span>
</span><span id="line-199"></span><span>
</span><span id="line-200"></span><span>    </span><span id="local-6989586621684524323"><span class="annot"><span class="annottext">onBinding :: Map VName SizeSubst -&gt; Binding -&gt; Binding
</span><a href="#local-6989586621684524323"><span class="hs-identifier hs-var hs-var">onBinding</span></a></span></span><span> </span><span id="local-6989586621684524318"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524318"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span id="local-6989586621684524317"><span class="annot"><span class="annottext">Maybe ([VName], StructType)
</span><a href="#local-6989586621684524317"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684524316"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524316"><span class="hs-identifier hs-var">bsv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-201"></span><span>      </span><span class="annot"><span class="annottext">Maybe ([VName], StructType) -&gt; StaticVal -&gt; Binding
</span><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span><span>
</span><span id="line-202"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StructType -&gt; StructType)
-&gt; ([VName], StructType) -&gt; ([VName], StructType)
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; StructType -&gt; StructType
forall als.
Map VName SizeSubst
-&gt; TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceTypeSizes"><span class="hs-identifier hs-var">replaceTypeSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524318"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(([VName], StructType) -&gt; ([VName], StructType))
-&gt; Maybe ([VName], StructType) -&gt; Maybe ([VName], StructType)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
</span><a href="#local-6989586621684524317"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set VName -&gt; Map VName SizeSubst -&gt; StaticVal -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceStaticValSizes"><span class="hs-identifier hs-var">replaceStaticValSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684524487"><span class="hs-identifier hs-var">globals</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524318"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524316"><span class="hs-identifier hs-var">bsv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>
</span><span id="line-205"></span><span>    </span><span id="local-6989586621684525409"><span class="annot"><a href="#local-6989586621684524469"><span class="hs-identifier hs-type">onAST</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Traversals.html#ASTMappable"><span class="hs-identifier hs-type">ASTMappable</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684525409"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684525409"><span class="hs-identifier hs-type">x</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684525409"><span class="hs-identifier hs-type">x</span></a></span></span><span>
</span><span id="line-206"></span><span>    </span><span id="local-6989586621684524469"><span class="annot"><span class="annottext">onAST :: forall x. ASTMappable x =&gt; Map VName SizeSubst -&gt; x -&gt; x
</span><a href="#local-6989586621684524469"><span class="hs-identifier hs-var hs-var">onAST</span></a></span></span><span> </span><span id="local-6989586621684524310"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524310"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity x -&gt; x
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity x -&gt; x) -&gt; (x -&gt; Identity x) -&gt; x -&gt; x
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">ASTMapper Identity -&gt; x -&gt; Identity x
forall x (m :: * -&gt; *).
(ASTMappable x, Monad m) =&gt;
ASTMapper m -&gt; x -&gt; m x
</span><a href="Language.Futhark.Traversals.html#astMap"><span class="hs-identifier hs-var">astMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; ASTMapper Identity
forall {m :: * -&gt; *}. Monad m =&gt; Map VName SizeSubst -&gt; ASTMapper m
</span><a href="#local-6989586621684524449"><span class="hs-identifier hs-var">tv</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684524310"><span class="hs-identifier hs-var">substs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-207"></span><span>
</span><span id="line-208"></span><span class="hs-comment">-- | Returns the defunctionalization environment restricted</span><span>
</span><span id="line-209"></span><span class="hs-comment">-- to the given set of variable names and types.</span><span>
</span><span id="line-210"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#restrictEnvTo"><span class="hs-identifier hs-type">restrictEnvTo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.FreeVars.html#NameSet"><span class="hs-identifier hs-type">FV.NameSet</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span>
</span><span id="line-211"></span><span id="restrictEnvTo"><span class="annot"><span class="annottext">restrictEnvTo :: NameSet -&gt; DefM Env
</span><a href="Futhark.Internalise.Defunctionalise.html#restrictEnvTo"><span class="hs-identifier hs-var hs-var">restrictEnvTo</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.FreeVars.html#NameSet"><span class="hs-identifier hs-type">FV.NameSet</span></a></span><span> </span><span id="local-6989586621684524305"><span class="annot"><span class="annottext">Map VName StructType
</span><a href="#local-6989586621684524305"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Set VName, Env) -&gt; Env) -&gt; DefM Env
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">(Set VName, Env) -&gt; Env
</span><a href="#local-6989586621684524304"><span class="hs-identifier hs-var">restrict</span></a></span><span>
</span><span id="line-212"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-213"></span><span>    </span><span id="local-6989586621684524304"><span class="annot"><span class="annottext">restrict :: (Set VName, Env) -&gt; Env
</span><a href="#local-6989586621684524304"><span class="hs-identifier hs-var hs-var">restrict</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684524303"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684524303"><span class="hs-identifier hs-var">globals</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684524302"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524302"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Binding -&gt; Maybe Binding) -&gt; Env -&gt; Env
forall k a b. (k -&gt; a -&gt; Maybe b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.mapMaybeWithKey</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Binding -&gt; Maybe Binding
</span><a href="#local-6989586621684524300"><span class="hs-identifier hs-var">keep</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524302"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-214"></span><span>      </span><span class="hs-keyword">where</span><span>
</span><span id="line-215"></span><span>        </span><span id="local-6989586621684524300"><span class="annot"><span class="annottext">keep :: VName -&gt; Binding -&gt; Maybe Binding
</span><a href="#local-6989586621684524300"><span class="hs-identifier hs-var hs-var">keep</span></a></span></span><span> </span><span id="local-6989586621684524291"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684524291"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span id="local-6989586621684524290"><span class="annot"><span class="annottext">Maybe ([VName], StructType)
</span><a href="#local-6989586621684524290"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684524289"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524289"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-216"></span><span>          </span><span class="annot"><span class="annottext">Bool -&gt; Maybe ()
forall (f :: * -&gt; *). Alternative f =&gt; Bool -&gt; f ()
</span><span class="hs-identifier hs-var">guard</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Maybe ()) -&gt; Bool -&gt; Maybe ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684524291"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684524303"><span class="hs-identifier hs-var">globals</span></a></span><span>
</span><span id="line-217"></span><span>          </span><span id="local-6989586621684524287"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684524287"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Uniqueness
forall shape as. TypeBase shape as -&gt; Uniqueness
</span><a href="Language.Futhark.Prop.html#uniqueness"><span class="hs-identifier hs-var">uniqueness</span></a></span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; Uniqueness) -&gt; Maybe StructType -&gt; Maybe Uniqueness
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName StructType -&gt; Maybe StructType
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684524291"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName StructType
</span><a href="#local-6989586621684524305"><span class="hs-identifier hs-var">m</span></a></span><span>
</span><span id="line-218"></span><span>          </span><span class="annot"><span class="annottext">Binding -&gt; Maybe Binding
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(Binding -&gt; Maybe Binding) -&gt; Binding -&gt; Maybe Binding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType) -&gt; StaticVal -&gt; Binding
</span><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
</span><a href="#local-6989586621684524290"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; Binding) -&gt; StaticVal -&gt; Binding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; StaticVal -&gt; StaticVal
</span><a href="#local-6989586621684524285"><span class="hs-identifier hs-var">restrict'</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684524287"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524289"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-219"></span><span>    </span><span id="local-6989586621684524285"><span class="annot"><span class="annottext">restrict' :: Uniqueness -&gt; StaticVal -&gt; StaticVal
</span><a href="#local-6989586621684524285"><span class="hs-identifier hs-var hs-var">restrict'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a></span><span> </span><span id="local-6989586621684524282"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684524282"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-220"></span><span>      </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684524282"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Uniqueness -&gt; PatType
forall dim as. TypeBase dim as -&gt; Uniqueness -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#setUniqueness"><span class="hs-operator hs-var">`setUniqueness`</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span>
</span><span id="line-221"></span><span>    </span><span class="annot"><a href="#local-6989586621684524285"><span class="hs-identifier hs-var">restrict'</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a></span><span> </span><span id="local-6989586621684524280"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684524280"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-222"></span><span>      </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684524280"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-223"></span><span>    </span><span class="annot"><a href="#local-6989586621684524285"><span class="hs-identifier hs-var">restrict'</span></a></span><span> </span><span id="local-6989586621684524279"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684524279"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#LambdaSV"><span class="hs-identifier hs-type">LambdaSV</span></a></span><span> </span><span id="local-6989586621684524278"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684524278"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684524277"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684524277"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684524276"><span class="annot"><span class="annottext">ExtExp
</span><a href="#local-6989586621684524276"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684524275"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524275"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-224"></span><span>      </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StructRetType -&gt; ExtExp -&gt; Env -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#LambdaSV"><span class="hs-identifier hs-var">LambdaSV</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684524278"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684524277"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">ExtExp
</span><a href="#local-6989586621684524276"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">(Env -&gt; StaticVal) -&gt; Env -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Binding -&gt; Binding) -&gt; Env -&gt; Env
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uniqueness -&gt; Binding -&gt; Binding
</span><a href="#local-6989586621684524273"><span class="hs-identifier hs-var">restrict''</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684524279"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524275"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-225"></span><span>    </span><span class="annot"><a href="#local-6989586621684524285"><span class="hs-identifier hs-var">restrict'</span></a></span><span> </span><span id="local-6989586621684524272"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684524272"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-type">RecordSV</span></a></span><span> </span><span id="local-6989586621684524271"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684524271"><span class="hs-identifier hs-var">fields</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-226"></span><span>      </span><span class="annot"><span class="annottext">[(Name, StaticVal)] -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-var">RecordSV</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, StaticVal)] -&gt; StaticVal)
-&gt; [(Name, StaticVal)] -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Name, StaticVal) -&gt; (Name, StaticVal))
-&gt; [(Name, StaticVal)] -&gt; [(Name, StaticVal)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StaticVal -&gt; StaticVal) -&gt; (Name, StaticVal) -&gt; (Name, StaticVal)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">((StaticVal -&gt; StaticVal)
 -&gt; (Name, StaticVal) -&gt; (Name, StaticVal))
-&gt; (StaticVal -&gt; StaticVal)
-&gt; (Name, StaticVal)
-&gt; (Name, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; StaticVal -&gt; StaticVal
</span><a href="#local-6989586621684524285"><span class="hs-identifier hs-var">restrict'</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684524272"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684524271"><span class="hs-identifier hs-var">fields</span></a></span><span>
</span><span id="line-227"></span><span>    </span><span class="annot"><a href="#local-6989586621684524285"><span class="hs-identifier hs-var">restrict'</span></a></span><span> </span><span id="local-6989586621684524270"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684524270"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SumSV"><span class="hs-identifier hs-type">SumSV</span></a></span><span> </span><span id="local-6989586621684524269"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684524269"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span id="local-6989586621684524268"><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684524268"><span class="hs-identifier hs-var">svs</span></a></span></span><span> </span><span id="local-6989586621684524267"><span class="annot"><span class="annottext">[(Name, [PatType])]
</span><a href="#local-6989586621684524267"><span class="hs-identifier hs-var">fields</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-228"></span><span>      </span><span class="annot"><span class="annottext">Name -&gt; [StaticVal] -&gt; [(Name, [PatType])] -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#SumSV"><span class="hs-identifier hs-var">SumSV</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684524269"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StaticVal -&gt; StaticVal) -&gt; [StaticVal] -&gt; [StaticVal]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Uniqueness -&gt; StaticVal -&gt; StaticVal
</span><a href="#local-6989586621684524285"><span class="hs-identifier hs-var">restrict'</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684524270"><span class="hs-identifier hs-var">u</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684524268"><span class="hs-identifier hs-var">svs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, [PatType])]
</span><a href="#local-6989586621684524267"><span class="hs-identifier hs-var">fields</span></a></span><span>
</span><span id="line-229"></span><span>    </span><span class="annot"><a href="#local-6989586621684524285"><span class="hs-identifier hs-var">restrict'</span></a></span><span> </span><span id="local-6989586621684524266"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684524266"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-type">DynamicFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684524265"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684524265"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684524264"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524264"><span class="hs-identifier hs-var">sv1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684524263"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524263"><span class="hs-identifier hs-var">sv2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-230"></span><span>      </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; StaticVal -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-var">DynamicFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684524265"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; StaticVal -&gt; StaticVal
</span><a href="#local-6989586621684524285"><span class="hs-identifier hs-var">restrict'</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684524266"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524264"><span class="hs-identifier hs-var">sv1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; StaticVal) -&gt; StaticVal -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; StaticVal -&gt; StaticVal
</span><a href="#local-6989586621684524285"><span class="hs-identifier hs-var">restrict'</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684524266"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524263"><span class="hs-identifier hs-var">sv2</span></a></span><span>
</span><span id="line-231"></span><span>    </span><span class="annot"><a href="#local-6989586621684524285"><span class="hs-identifier hs-var">restrict'</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#IntrinsicSV"><span class="hs-identifier hs-var">IntrinsicSV</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#IntrinsicSV"><span class="hs-identifier hs-var">IntrinsicSV</span></a></span><span>
</span><span id="line-232"></span><span>    </span><span id="local-6989586621684524273"><span class="annot"><span class="annottext">restrict'' :: Uniqueness -&gt; Binding -&gt; Binding
</span><a href="#local-6989586621684524273"><span class="hs-identifier hs-var hs-var">restrict''</span></a></span></span><span> </span><span id="local-6989586621684524262"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684524262"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span id="local-6989586621684524261"><span class="annot"><span class="annottext">Maybe ([VName], StructType)
</span><a href="#local-6989586621684524261"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684524260"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524260"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType) -&gt; StaticVal -&gt; Binding
</span><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
</span><a href="#local-6989586621684524261"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; Binding) -&gt; StaticVal -&gt; Binding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness -&gt; StaticVal -&gt; StaticVal
</span><a href="#local-6989586621684524285"><span class="hs-identifier hs-var">restrict'</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684524262"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524260"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-233"></span><span>
</span><span id="line-234"></span><span class="hs-comment">-- | Defunctionalization monad.  The Reader environment tracks both</span><span>
</span><span id="line-235"></span><span class="hs-comment">-- the current Env as well as the set of globally defined dynamic</span><span>
</span><span id="line-236"></span><span class="hs-comment">-- functions.  This is used to avoid unnecessarily large closure</span><span>
</span><span id="line-237"></span><span class="hs-comment">-- environments.</span><span>
</span><span id="line-238"></span><span class="hs-keyword">newtype</span><span> </span><span id="DefM"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-var">DefM</span></a></span></span><span> </span><span id="local-6989586621684524259"><span class="annot"><a href="#local-6989586621684524259"><span class="hs-identifier hs-type">a</span></a></span></span><span>
</span><span id="line-239"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="DefM"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-var">DefM</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">State</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#ValBind"><span class="hs-identifier hs-type">ValBind</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684524259"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-240"></span><span>  </span><span class="hs-keyword">deriving</span><span>
</span><span id="line-241"></span><span>    </span><span class="hs-special">(</span><span> </span><span id="local-6989586621684524250"><span id="local-6989586621684524256"><span class="annot"><span class="annottext">(forall a b. (a -&gt; b) -&gt; DefM a -&gt; DefM b)
-&gt; (forall a b. a -&gt; DefM b -&gt; DefM a) -&gt; Functor DefM
forall a b. a -&gt; DefM b -&gt; DefM a
forall a b. (a -&gt; b) -&gt; DefM a -&gt; DefM b
forall (f :: * -&gt; *).
(forall a b. (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b. a -&gt; f b -&gt; f a) -&gt; Functor f
&lt;$ :: forall a b. a -&gt; DefM b -&gt; DefM a
$c&lt;$ :: forall a b. a -&gt; DefM b -&gt; DefM a
fmap :: forall a b. (a -&gt; b) -&gt; DefM a -&gt; DefM b
$cfmap :: forall a b. (a -&gt; b) -&gt; DefM a -&gt; DefM b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Functor</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-242"></span><span>      </span><span id="local-6989586621684524217"><span id="local-6989586621684524222"><span id="local-6989586621684524227"><span id="local-6989586621684524232"><span id="local-6989586621684524238"><span class="annot"><span class="annottext">Functor DefM
Functor DefM
-&gt; (forall a. a -&gt; DefM a)
-&gt; (forall a b. DefM (a -&gt; b) -&gt; DefM a -&gt; DefM b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; DefM a -&gt; DefM b -&gt; DefM c)
-&gt; (forall a b. DefM a -&gt; DefM b -&gt; DefM b)
-&gt; (forall a b. DefM a -&gt; DefM b -&gt; DefM a)
-&gt; Applicative DefM
forall a. a -&gt; DefM a
forall a b. DefM a -&gt; DefM b -&gt; DefM a
forall a b. DefM a -&gt; DefM b -&gt; DefM b
forall a b. DefM (a -&gt; b) -&gt; DefM a -&gt; DefM b
forall a b c. (a -&gt; b -&gt; c) -&gt; DefM a -&gt; DefM b -&gt; DefM c
forall (f :: * -&gt; *).
Functor f
-&gt; (forall a. a -&gt; f a)
-&gt; (forall a b. f (a -&gt; b) -&gt; f a -&gt; f b)
-&gt; (forall a b c. (a -&gt; b -&gt; c) -&gt; f a -&gt; f b -&gt; f c)
-&gt; (forall a b. f a -&gt; f b -&gt; f b)
-&gt; (forall a b. f a -&gt; f b -&gt; f a)
-&gt; Applicative f
&lt;* :: forall a b. DefM a -&gt; DefM b -&gt; DefM a
$c&lt;* :: forall a b. DefM a -&gt; DefM b -&gt; DefM a
*&gt; :: forall a b. DefM a -&gt; DefM b -&gt; DefM b
$c*&gt; :: forall a b. DefM a -&gt; DefM b -&gt; DefM b
liftA2 :: forall a b c. (a -&gt; b -&gt; c) -&gt; DefM a -&gt; DefM b -&gt; DefM c
$cliftA2 :: forall a b c. (a -&gt; b -&gt; c) -&gt; DefM a -&gt; DefM b -&gt; DefM c
&lt;*&gt; :: forall a b. DefM (a -&gt; b) -&gt; DefM a -&gt; DefM b
$c&lt;*&gt; :: forall a b. DefM (a -&gt; b) -&gt; DefM a -&gt; DefM b
pure :: forall a. a -&gt; DefM a
$cpure :: forall a. a -&gt; DefM a
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Applicative</span></span></span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-243"></span><span>      </span><span id="local-6989586621684524187"><span id="local-6989586621684524192"><span id="local-6989586621684524198"><span class="annot"><span class="annottext">Applicative DefM
Applicative DefM
-&gt; (forall a b. DefM a -&gt; (a -&gt; DefM b) -&gt; DefM b)
-&gt; (forall a b. DefM a -&gt; DefM b -&gt; DefM b)
-&gt; (forall a. a -&gt; DefM a)
-&gt; Monad DefM
forall a. a -&gt; DefM a
forall a b. DefM a -&gt; DefM b -&gt; DefM b
forall a b. DefM a -&gt; (a -&gt; DefM b) -&gt; DefM b
forall (m :: * -&gt; *).
Applicative m
-&gt; (forall a b. m a -&gt; (a -&gt; m b) -&gt; m b)
-&gt; (forall a b. m a -&gt; m b -&gt; m b)
-&gt; (forall a. a -&gt; m a)
-&gt; Monad m
return :: forall a. a -&gt; DefM a
$creturn :: forall a. a -&gt; DefM a
&gt;&gt; :: forall a b. DefM a -&gt; DefM b -&gt; DefM b
$c&gt;&gt; :: forall a b. DefM a -&gt; DefM b -&gt; DefM b
&gt;&gt;= :: forall a b. DefM a -&gt; (a -&gt; DefM b) -&gt; DefM b
$c&gt;&gt;= :: forall a b. DefM a -&gt; (a -&gt; DefM b) -&gt; DefM b
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Monad</span></span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-244"></span><span>      </span><span id="local-6989586621684524164"><span id="local-6989586621684524169"><span id="local-6989586621684524175"><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">)</span></span></span></span><span class="hs-special">,</span><span>
</span><span id="line-245"></span><span>      </span><span id="local-6989586621684524142"><span id="local-6989586621684524147"><span id="local-6989586621684524153"><span class="annot"><span class="hs-identifier hs-type">MonadState</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#ValBind"><span class="hs-identifier hs-type">ValBind</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span class="hs-special">)</span></span></span></span><span>
</span><span id="line-246"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-247"></span><span>
</span><span id="line-248"></span><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-249"></span><span>  </span><span id="local-6989586621684524125"><span class="annot"><span class="annottext">putNameSource :: VNameSource -&gt; DefM ()
</span><a href="Futhark.MonadFreshNames.html#putNameSource"><span class="hs-identifier hs-var hs-var hs-var hs-var">putNameSource</span></a></span></span><span> </span><span id="local-6989586621684524123"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684524123"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(([ValBind], VNameSource) -&gt; ([ValBind], VNameSource)) -&gt; DefM ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((([ValBind], VNameSource) -&gt; ([ValBind], VNameSource)) -&gt; DefM ())
-&gt; (([ValBind], VNameSource) -&gt; ([ValBind], VNameSource))
-&gt; DefM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684524121"><span class="annot"><span class="annottext">[ValBind]
</span><a href="#local-6989586621684524121"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ValBind]
</span><a href="#local-6989586621684524121"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684524123"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-250"></span><span>  </span><span id="local-6989586621684524119"><span class="annot"><span class="annottext">getNameSource :: DefM VNameSource
</span><a href="Futhark.MonadFreshNames.html#getNameSource"><span class="hs-identifier hs-var hs-var hs-var hs-var">getNameSource</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(([ValBind], VNameSource) -&gt; VNameSource) -&gt; DefM VNameSource
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">gets</span></span><span> </span><span class="annot"><span class="annottext">([ValBind], VNameSource) -&gt; VNameSource
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span>
</span><span id="line-251"></span><span>
</span><span id="line-252"></span><span class="hs-comment">-- | Run a computation in the defunctionalization monad. Returns the result of</span><span>
</span><span id="line-253"></span><span class="hs-comment">-- the computation, a new name source, and a list of lifted function declations.</span><span>
</span><span id="line-254"></span><span id="local-6989586621684525273"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#runDefM"><span class="hs-identifier hs-type">runDefM</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684525273"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621684525273"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.FreshNames.html#VNameSource"><span class="hs-identifier hs-type">VNameSource</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#ValBind"><span class="hs-identifier hs-type">ValBind</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-255"></span><span id="runDefM"><span class="annot"><span class="annottext">runDefM :: forall a. VNameSource -&gt; DefM a -&gt; (a, VNameSource, [ValBind])
</span><a href="Futhark.Internalise.Defunctionalise.html#runDefM"><span class="hs-identifier hs-var hs-var">runDefM</span></a></span></span><span> </span><span id="local-6989586621684524115"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684524115"><span class="hs-identifier hs-var">src</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span id="local-6989586621684524114"><span class="annot"><span class="annottext">ReaderT (Set VName, Env) (State ([ValBind], VNameSource)) a
</span><a href="#local-6989586621684524114"><span class="hs-identifier hs-var">m</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-256"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684524106"><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684524106"><span class="hs-identifier hs-var">x</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684524105"><span class="annot"><span class="annottext">[ValBind]
</span><a href="#local-6989586621684524105"><span class="hs-identifier hs-var">vbs</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684524104"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684524104"><span class="hs-identifier hs-var">src'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State ([ValBind], VNameSource) a
-&gt; ([ValBind], VNameSource) -&gt; (a, ([ValBind], VNameSource))
forall s a. State s a -&gt; s -&gt; (a, s)
</span><span class="hs-identifier hs-var">runState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ReaderT (Set VName, Env) (State ([ValBind], VNameSource)) a
-&gt; (Set VName, Env) -&gt; State ([ValBind], VNameSource) a
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (Set VName, Env) (State ([ValBind], VNameSource)) a
</span><a href="#local-6989586621684524114"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="annot"><span class="annottext">(Set VName, Env)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ValBind]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684524115"><span class="hs-identifier hs-var">src</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-257"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">a
</span><a href="#local-6989586621684524106"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684524104"><span class="hs-identifier hs-var">src'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[ValBind] -&gt; [ValBind]
forall a. [a] -&gt; [a]
</span><span class="hs-identifier hs-var">reverse</span></span><span> </span><span class="annot"><span class="annottext">[ValBind]
</span><a href="#local-6989586621684524105"><span class="hs-identifier hs-var">vbs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-258"></span><span>
</span><span id="line-259"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#addValBind"><span class="hs-identifier hs-type">addValBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#ValBind"><span class="hs-identifier hs-type">ValBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-260"></span><span id="addValBind"><span class="annot"><span class="annottext">addValBind :: ValBind -&gt; DefM ()
</span><a href="Futhark.Internalise.Defunctionalise.html#addValBind"><span class="hs-identifier hs-var hs-var">addValBind</span></a></span></span><span> </span><span id="local-6989586621684524099"><span class="annot"><span class="annottext">ValBind
</span><a href="#local-6989586621684524099"><span class="hs-identifier hs-var">vb</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(([ValBind], VNameSource) -&gt; ([ValBind], VNameSource)) -&gt; DefM ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((([ValBind], VNameSource) -&gt; ([ValBind], VNameSource)) -&gt; DefM ())
-&gt; (([ValBind], VNameSource) -&gt; ([ValBind], VNameSource))
-&gt; DefM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([ValBind] -&gt; [ValBind])
-&gt; ([ValBind], VNameSource) -&gt; ([ValBind], VNameSource)
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValBind
</span><a href="#local-6989586621684524099"><span class="hs-identifier hs-var">vb</span></a></span><span> </span><span class="annot"><span class="annottext">ValBind -&gt; [ValBind] -&gt; [ValBind]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span class="hs-comment">-- | Looks up the associated static value for a given name in the environment.</span><span>
</span><span id="line-263"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#lookupVar"><span class="hs-identifier hs-type">lookupVar</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span>
</span><span id="line-264"></span><span id="lookupVar"><span class="annot"><span class="annottext">lookupVar :: StructType -&gt; VName -&gt; DefM StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#lookupVar"><span class="hs-identifier hs-var hs-var">lookupVar</span></a></span></span><span> </span><span id="local-6989586621684524097"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684524097"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684524096"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684524096"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-265"></span><span>  </span><span id="local-6989586621684524095"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524095"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">DefM Env
</span><a href="Futhark.Internalise.Defunctionalise.html#askEnv"><span class="hs-identifier hs-var">askEnv</span></a></span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Env -&gt; Maybe Binding
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684524096"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684524095"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-267"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684524094"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684524094"><span class="hs-identifier hs-var">dims</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684524093"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684524093"><span class="hs-identifier hs-var">sv_t</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684524092"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524092"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-268"></span><span>      </span><span id="local-6989586621684524091"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684524091"><span class="hs-identifier hs-var">globals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Set VName, Env) -&gt; Set VName) -&gt; DefM (Set VName)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">(Set VName, Env) -&gt; Set VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span>
</span><span id="line-269"></span><span>      </span><span class="annot"><span class="annottext">Set VName
-&gt; [VName]
-&gt; StructType
-&gt; StructType
-&gt; StaticVal
-&gt; DefM StaticVal
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Set VName
-&gt; [VName] -&gt; StructType -&gt; StructType -&gt; StaticVal -&gt; m StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#instStaticVal"><span class="hs-identifier hs-var">instStaticVal</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684524091"><span class="hs-identifier hs-var">globals</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684524094"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684524097"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684524093"><span class="hs-identifier hs-var">sv_t</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524092"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-270"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span id="local-6989586621684524089"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524089"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-271"></span><span>      </span><span class="annot"><span class="annottext">StaticVal -&gt; DefM StaticVal
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684524089"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-272"></span><span>    </span><span class="annot"><span class="annottext">Maybe Binding
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-comment">-- If the variable is unknown, it may refer to the 'intrinsics'</span><span>
</span><span id="line-273"></span><span>    </span><span class="hs-comment">-- module, which we will have to treat specially.</span><span>
</span><span id="line-274"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Int
</span><a href="Language.Futhark.Core.html#baseTag"><span class="hs-identifier hs-var">baseTag</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684524096"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Language.Futhark.Prop.html#maxIntrinsicTag"><span class="hs-identifier hs-var">maxIntrinsicTag</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; DefM StaticVal
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#IntrinsicSV"><span class="hs-identifier hs-var">IntrinsicSV</span></a></span><span>
</span><span id="line-275"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-276"></span><span>        </span><span class="hs-comment">-- Anything not in scope is going to be an existential size.</span><span>
</span><span id="line-277"></span><span>        </span><span class="annot"><span class="annottext">StaticVal -&gt; DefM StaticVal
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; DefM StaticVal) -&gt; StaticVal -&gt; DefM StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType)
-&gt; ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias))
-&gt; PrimType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Language.Futhark.Syntax.html#Signed"><span class="hs-identifier hs-var">Signed</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-278"></span><span>
</span><span id="line-279"></span><span class="hs-comment">-- Like patternDimNames, but ignores sizes that are only found in</span><span>
</span><span id="line-280"></span><span class="hs-comment">-- funtion types.</span><span>
</span><span id="line-281"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#arraySizes"><span class="hs-identifier hs-type">arraySizes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-282"></span><span id="arraySizes"><span class="annot"><span class="annottext">arraySizes :: StructType -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#arraySizes"><span class="hs-identifier hs-var hs-var">arraySizes</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-283"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#arraySizes"><span class="hs-identifier hs-var">arraySizes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684524078"><span class="annot"><span class="annottext">Map Name StructType
</span><a href="#local-6989586621684524078"><span class="hs-identifier hs-var">fields</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; Set VName) -&gt; Map Name StructType -&gt; Set VName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#arraySizes"><span class="hs-identifier hs-var">arraySizes</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name StructType
</span><a href="#local-6989586621684524078"><span class="hs-identifier hs-var">fields</span></a></span><span>
</span><span id="line-284"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#arraySizes"><span class="hs-identifier hs-var">arraySizes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span id="local-6989586621684524075"><span class="annot"><span class="annottext">Map Name [StructType]
</span><a href="#local-6989586621684524075"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">([StructType] -&gt; Set VName) -&gt; Map Name [StructType] -&gt; Set VName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StructType -&gt; Set VName) -&gt; [StructType] -&gt; Set VName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#arraySizes"><span class="hs-identifier hs-var">arraySizes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name [StructType]
</span><a href="#local-6989586621684524075"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-285"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#arraySizes"><span class="hs-identifier hs-var">arraySizes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-type">TypeVar</span></a></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">TypeName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684524073"><span class="annot"><span class="annottext">[TypeArg (DimDecl VName)]
</span><a href="#local-6989586621684524073"><span class="hs-identifier hs-var">targs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-286"></span><span>  </span><span class="annot"><span class="annottext">[Set VName] -&gt; Set VName
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Set VName] -&gt; Set VName) -&gt; [Set VName] -&gt; Set VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeArg (DimDecl VName) -&gt; Set VName)
-&gt; [TypeArg (DimDecl VName)] -&gt; [Set VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeArg (DimDecl VName) -&gt; Set VName
</span><a href="#local-6989586621684524072"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeArg (DimDecl VName)]
</span><a href="#local-6989586621684524073"><span class="hs-identifier hs-var">targs</span></a></span><span>
</span><span id="line-287"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-288"></span><span>    </span><span id="local-6989586621684524072"><span class="annot"><span class="annottext">f :: TypeArg (DimDecl VName) -&gt; Set VName
</span><a href="#local-6989586621684524072"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgDim"><span class="hs-identifier hs-type">TypeArgDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684524068"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524068"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Set VName
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Set VName) -&gt; VName -&gt; Set VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524068"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-289"></span><span>    </span><span class="annot"><a href="#local-6989586621684524072"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgDim"><span class="hs-identifier hs-type">TypeArgDim</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-290"></span><span>    </span><span class="annot"><a href="#local-6989586621684524072"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeArgType"><span class="hs-identifier hs-type">TypeArgType</span></a></span><span> </span><span id="local-6989586621684524065"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684524065"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#arraySizes"><span class="hs-identifier hs-var">arraySizes</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684524065"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-291"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#arraySizes"><span class="hs-identifier hs-var">arraySizes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-292"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#arraySizes"><span class="hs-identifier hs-var">arraySizes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="annot"><span class="annottext">()
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684524063"><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684524063"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684524062"><span class="annot"><span class="annottext">ShapeDecl (DimDecl VName)
</span><a href="#local-6989586621684524062"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-293"></span><span>  </span><span class="annot"><span class="annottext">StructType -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#arraySizes"><span class="hs-identifier hs-var">arraySizes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) () -&gt; StructType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684524063"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; Set VName) -&gt; [DimDecl VName] -&gt; Set VName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; Set VName
</span><a href="#local-6989586621684524061"><span class="hs-identifier hs-var">dimName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ShapeDecl (DimDecl VName) -&gt; [DimDecl VName]
forall dim. ShapeDecl dim -&gt; [dim]
</span><a href="Language.Futhark.Syntax.html#shapeDims"><span class="hs-identifier hs-var hs-var">shapeDims</span></a></span><span> </span><span class="annot"><span class="annottext">ShapeDecl (DimDecl VName)
</span><a href="#local-6989586621684524062"><span class="hs-identifier hs-var">shape</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-294"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-295"></span><span>    </span><span class="annot"><a href="#local-6989586621684524061"><span class="hs-identifier hs-type">dimName</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-296"></span><span>    </span><span id="local-6989586621684524061"><span class="annot"><span class="annottext">dimName :: DimDecl VName -&gt; Set VName
</span><a href="#local-6989586621684524061"><span class="hs-identifier hs-var hs-var">dimName</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684524059"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524059"><span class="hs-identifier hs-var">qn</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Set VName
forall a. a -&gt; Set a
</span><span class="hs-identifier hs-var">S.singleton</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Set VName) -&gt; VName -&gt; Set VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684524059"><span class="hs-identifier hs-var">qn</span></a></span><span>
</span><span id="line-297"></span><span>    </span><span class="annot"><a href="#local-6989586621684524061"><span class="hs-identifier hs-var">dimName</span></a></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-298"></span><span>
</span><span id="line-299"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#patternArraySizes"><span class="hs-identifier hs-type">patternArraySizes</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-300"></span><span id="patternArraySizes"><span class="annot"><span class="annottext">patternArraySizes :: PatBase Info VName -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#patternArraySizes"><span class="hs-identifier hs-var hs-var">patternArraySizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#arraySizes"><span class="hs-identifier hs-var">arraySizes</span></a></span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; Set VName)
-&gt; (PatBase Info VName -&gt; StructType)
-&gt; PatBase Info VName
-&gt; Set VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StructType
</span><a href="Language.Futhark.Prop.html#patternStructType"><span class="hs-identifier hs-var">patternStructType</span></a></span><span>
</span><span id="line-301"></span><span>
</span><span id="line-302"></span><span class="hs-keyword">data</span><span> </span><span id="SizeSubst"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SizeSubst"><span class="hs-identifier hs-var">SizeSubst</span></a></span></span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="SubstNamed"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SubstNamed"><span class="hs-identifier hs-var">SubstNamed</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualName"><span class="hs-identifier hs-type">QualName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-304"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="SubstConst"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SubstConst"><span class="hs-identifier hs-var">SubstConst</span></a></span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span>
</span><span id="line-305"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684524050"><span id="local-6989586621684524055"><span class="annot"><span class="annottext">SizeSubst -&gt; SizeSubst -&gt; Bool
(SizeSubst -&gt; SizeSubst -&gt; Bool)
-&gt; (SizeSubst -&gt; SizeSubst -&gt; Bool) -&gt; Eq SizeSubst
forall a. (a -&gt; a -&gt; Bool) -&gt; (a -&gt; a -&gt; Bool) -&gt; Eq a
/= :: SizeSubst -&gt; SizeSubst -&gt; Bool
$c/= :: SizeSubst -&gt; SizeSubst -&gt; Bool
== :: SizeSubst -&gt; SizeSubst -&gt; Bool
$c== :: SizeSubst -&gt; SizeSubst -&gt; Bool
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var">Eq</span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684524025"><span id="local-6989586621684524027"><span id="local-6989586621684524030"><span id="local-6989586621684524033"><span id="local-6989586621684524036"><span id="local-6989586621684524040"><span id="local-6989586621684524045"><span class="annot"><span class="annottext">Eq SizeSubst
Eq SizeSubst
-&gt; (SizeSubst -&gt; SizeSubst -&gt; Ordering)
-&gt; (SizeSubst -&gt; SizeSubst -&gt; Bool)
-&gt; (SizeSubst -&gt; SizeSubst -&gt; Bool)
-&gt; (SizeSubst -&gt; SizeSubst -&gt; Bool)
-&gt; (SizeSubst -&gt; SizeSubst -&gt; Bool)
-&gt; (SizeSubst -&gt; SizeSubst -&gt; SizeSubst)
-&gt; (SizeSubst -&gt; SizeSubst -&gt; SizeSubst)
-&gt; Ord SizeSubst
SizeSubst -&gt; SizeSubst -&gt; Bool
SizeSubst -&gt; SizeSubst -&gt; Ordering
SizeSubst -&gt; SizeSubst -&gt; SizeSubst
forall a.
Eq a
-&gt; (a -&gt; a -&gt; Ordering)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; Bool)
-&gt; (a -&gt; a -&gt; a)
-&gt; (a -&gt; a -&gt; a)
-&gt; Ord a
min :: SizeSubst -&gt; SizeSubst -&gt; SizeSubst
$cmin :: SizeSubst -&gt; SizeSubst -&gt; SizeSubst
max :: SizeSubst -&gt; SizeSubst -&gt; SizeSubst
$cmax :: SizeSubst -&gt; SizeSubst -&gt; SizeSubst
&gt;= :: SizeSubst -&gt; SizeSubst -&gt; Bool
$c&gt;= :: SizeSubst -&gt; SizeSubst -&gt; Bool
&gt; :: SizeSubst -&gt; SizeSubst -&gt; Bool
$c&gt; :: SizeSubst -&gt; SizeSubst -&gt; Bool
&lt;= :: SizeSubst -&gt; SizeSubst -&gt; Bool
$c&lt;= :: SizeSubst -&gt; SizeSubst -&gt; Bool
&lt; :: SizeSubst -&gt; SizeSubst -&gt; Bool
$c&lt; :: SizeSubst -&gt; SizeSubst -&gt; Bool
compare :: SizeSubst -&gt; SizeSubst -&gt; Ordering
$ccompare :: SizeSubst -&gt; SizeSubst -&gt; Ordering
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Ord</span></span></span></span></span></span></span></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684524012"><span id="local-6989586621684524014"><span id="local-6989586621684524022"><span class="annot"><span class="annottext">Int -&gt; SizeSubst -&gt; ShowS
[SizeSubst] -&gt; ShowS
SizeSubst -&gt; String
(Int -&gt; SizeSubst -&gt; ShowS)
-&gt; (SizeSubst -&gt; String)
-&gt; ([SizeSubst] -&gt; ShowS)
-&gt; Show SizeSubst
forall a.
(Int -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
showList :: [SizeSubst] -&gt; ShowS
$cshowList :: [SizeSubst] -&gt; ShowS
show :: SizeSubst -&gt; String
$cshow :: SizeSubst -&gt; String
showsPrec :: Int -&gt; SizeSubst -&gt; ShowS
$cshowsPrec :: Int -&gt; SizeSubst -&gt; ShowS
</span><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-306"></span><span>
</span><span id="line-307"></span><span id="local-6989586621684525245"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#dimMapping"><span class="hs-identifier hs-type">dimMapping</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-308"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621684525245"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-309"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684525245"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-310"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684525245"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-311"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SizeSubst"><span class="hs-identifier hs-type">SizeSubst</span></a></span></span><span>
</span><span id="line-312"></span><span id="dimMapping"><span class="annot"><span class="annottext">dimMapping :: forall a.
Monoid a =&gt;
TypeBase (DimDecl VName) a
-&gt; TypeBase (DimDecl VName) a -&gt; Map VName SizeSubst
</span><a href="Futhark.Internalise.Defunctionalise.html#dimMapping"><span class="hs-identifier hs-var hs-var">dimMapping</span></a></span></span><span> </span><span id="local-6989586621684524002"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) a
</span><a href="#local-6989586621684524002"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684524001"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) a
</span><a href="#local-6989586621684524001"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">State (Map VName SizeSubst) (TypeBase (DimDecl VName) a)
-&gt; Map VName SizeSubst -&gt; Map VName SizeSubst
forall s a. State s a -&gt; s -&gt; s
</span><span class="hs-identifier hs-var">execState</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([VName]
 -&gt; DimDecl VName
 -&gt; DimDecl VName
 -&gt; StateT (Map VName SizeSubst) Identity (DimDecl VName))
-&gt; TypeBase (DimDecl VName) a
-&gt; TypeBase (DimDecl VName) a
-&gt; State (Map VName SizeSubst) (TypeBase (DimDecl VName) a)
forall as (m :: * -&gt; *) d1 d2.
(Monoid as, Monad m) =&gt;
([VName] -&gt; d1 -&gt; d2 -&gt; m d1)
-&gt; TypeBase d1 as -&gt; TypeBase d2 as -&gt; m (TypeBase d1 as)
</span><a href="Language.Futhark.Prop.html#matchDims"><span class="hs-identifier hs-var">matchDims</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; DimDecl VName
-&gt; DimDecl VName
-&gt; StateT (Map VName SizeSubst) Identity (DimDecl VName)
forall {t :: * -&gt; *} {f :: * -&gt; *} {vn}.
(Foldable t, MonadState (Map vn SizeSubst) f, Ord vn) =&gt;
t VName -&gt; DimDecl vn -&gt; DimDecl VName -&gt; f (DimDecl vn)
</span><a href="#local-6989586621684523998"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) a
</span><a href="#local-6989586621684524002"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) a
</span><a href="#local-6989586621684524001"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-313"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-314"></span><span>    </span><span id="local-6989586621684523998"><span class="annot"><span class="annottext">f :: t VName -&gt; DimDecl vn -&gt; DimDecl VName -&gt; f (DimDecl vn)
</span><a href="#local-6989586621684523998"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span id="local-6989586621684523979"><span class="annot"><span class="annottext">t VName
</span><a href="#local-6989586621684523979"><span class="hs-identifier hs-var">bound</span></a></span></span><span> </span><span id="local-6989586621684523978"><span class="annot"><span class="annottext">DimDecl vn
</span><a href="#local-6989586621684523978"><span class="hs-identifier hs-var">d1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684523977"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523977"><span class="hs-identifier hs-var">d2</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523977"><span class="hs-identifier hs-var">d2</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; t VName -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">t VName
</span><a href="#local-6989586621684523979"><span class="hs-identifier hs-var">bound</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl vn -&gt; f (DimDecl vn)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DimDecl vn
</span><a href="#local-6989586621684523978"><span class="hs-identifier hs-var">d1</span></a></span><span>
</span><span id="line-316"></span><span>    </span><span class="annot"><a href="#local-6989586621684523998"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">t VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684523975"><span class="annot"><span class="annottext">QualName vn
</span><a href="#local-6989586621684523975"><span class="hs-identifier hs-var">d1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684523974"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523974"><span class="hs-identifier hs-var">d2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-317"></span><span>      </span><span class="annot"><span class="annottext">(Map vn SizeSubst -&gt; Map vn SizeSubst) -&gt; f ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((Map vn SizeSubst -&gt; Map vn SizeSubst) -&gt; f ())
-&gt; (Map vn SizeSubst -&gt; Map vn SizeSubst) -&gt; f ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">vn -&gt; SizeSubst -&gt; Map vn SizeSubst -&gt; Map vn SizeSubst
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName vn -&gt; vn
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName vn
</span><a href="#local-6989586621684523975"><span class="hs-identifier hs-var">d1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SizeSubst -&gt; Map vn SizeSubst -&gt; Map vn SizeSubst)
-&gt; SizeSubst -&gt; Map vn SizeSubst -&gt; Map vn SizeSubst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; SizeSubst
</span><a href="Futhark.Internalise.Defunctionalise.html#SubstNamed"><span class="hs-identifier hs-var">SubstNamed</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523974"><span class="hs-identifier hs-var">d2</span></a></span><span>
</span><span id="line-318"></span><span>      </span><span class="annot"><span class="annottext">DimDecl vn -&gt; f (DimDecl vn)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DimDecl vn -&gt; f (DimDecl vn)) -&gt; DimDecl vn -&gt; f (DimDecl vn)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName vn -&gt; DimDecl vn
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">QualName vn
</span><a href="#local-6989586621684523975"><span class="hs-identifier hs-var">d1</span></a></span><span>
</span><span id="line-319"></span><span>    </span><span class="annot"><a href="#local-6989586621684523998"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">t VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684523972"><span class="annot"><span class="annottext">QualName vn
</span><a href="#local-6989586621684523972"><span class="hs-identifier hs-var">d1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ConstDim"><span class="hs-identifier hs-type">ConstDim</span></a></span><span> </span><span id="local-6989586621684523971"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523971"><span class="hs-identifier hs-var">d2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-320"></span><span>      </span><span class="annot"><span class="annottext">(Map vn SizeSubst -&gt; Map vn SizeSubst) -&gt; f ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((Map vn SizeSubst -&gt; Map vn SizeSubst) -&gt; f ())
-&gt; (Map vn SizeSubst -&gt; Map vn SizeSubst) -&gt; f ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">vn -&gt; SizeSubst -&gt; Map vn SizeSubst -&gt; Map vn SizeSubst
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName vn -&gt; vn
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName vn
</span><a href="#local-6989586621684523972"><span class="hs-identifier hs-var">d1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(SizeSubst -&gt; Map vn SizeSubst -&gt; Map vn SizeSubst)
-&gt; SizeSubst -&gt; Map vn SizeSubst -&gt; Map vn SizeSubst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; SizeSubst
</span><a href="Futhark.Internalise.Defunctionalise.html#SubstConst"><span class="hs-identifier hs-var">SubstConst</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523971"><span class="hs-identifier hs-var">d2</span></a></span><span>
</span><span id="line-321"></span><span>      </span><span class="annot"><span class="annottext">DimDecl vn -&gt; f (DimDecl vn)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DimDecl vn -&gt; f (DimDecl vn)) -&gt; DimDecl vn -&gt; f (DimDecl vn)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName vn -&gt; DimDecl vn
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">QualName vn
</span><a href="#local-6989586621684523972"><span class="hs-identifier hs-var">d1</span></a></span><span>
</span><span id="line-322"></span><span>    </span><span class="annot"><a href="#local-6989586621684523998"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">t VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523970"><span class="annot"><span class="annottext">DimDecl vn
</span><a href="#local-6989586621684523970"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl vn -&gt; f (DimDecl vn)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DimDecl vn
</span><a href="#local-6989586621684523970"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-323"></span><span>
</span><span id="line-324"></span><span id="local-6989586621684525231"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#dimMapping%27"><span class="hs-identifier hs-type">dimMapping'</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-325"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621684525231"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-326"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684525231"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-327"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684525231"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-328"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span></span><span>
</span><span id="line-329"></span><span id="dimMapping%27"><span class="annot"><span class="annottext">dimMapping' :: forall a.
Monoid a =&gt;
TypeBase (DimDecl VName) a
-&gt; TypeBase (DimDecl VName) a -&gt; Map VName VName
</span><a href="Futhark.Internalise.Defunctionalise.html#dimMapping%27"><span class="hs-identifier hs-var hs-var">dimMapping'</span></a></span></span><span> </span><span id="local-6989586621684523966"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) a
</span><a href="#local-6989586621684523966"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684523965"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) a
</span><a href="#local-6989586621684523965"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SizeSubst -&gt; Maybe VName)
-&gt; Map VName SizeSubst -&gt; Map VName VName
forall a b k. (a -&gt; Maybe b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">SizeSubst -&gt; Maybe VName
</span><a href="#local-6989586621684523963"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName SizeSubst -&gt; Map VName VName)
-&gt; Map VName SizeSubst -&gt; Map VName VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) a
-&gt; TypeBase (DimDecl VName) a -&gt; Map VName SizeSubst
forall a.
Monoid a =&gt;
TypeBase (DimDecl VName) a
-&gt; TypeBase (DimDecl VName) a -&gt; Map VName SizeSubst
</span><a href="Futhark.Internalise.Defunctionalise.html#dimMapping"><span class="hs-identifier hs-var">dimMapping</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) a
</span><a href="#local-6989586621684523966"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) a
</span><a href="#local-6989586621684523965"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-330"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-331"></span><span>    </span><span id="local-6989586621684523963"><span class="annot"><span class="annottext">f :: SizeSubst -&gt; Maybe VName
</span><a href="#local-6989586621684523963"><span class="hs-identifier hs-var hs-var">f</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SubstNamed"><span class="hs-identifier hs-type">SubstNamed</span></a></span><span> </span><span id="local-6989586621684523962"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523962"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe VName
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Maybe VName) -&gt; VName -&gt; Maybe VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523962"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-332"></span><span>    </span><span class="annot"><a href="#local-6989586621684523963"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">SizeSubst
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe VName
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-333"></span><span>
</span><span id="line-334"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#sizesToRename"><span class="hs-identifier hs-type">sizesToRename</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span>
</span><span id="line-335"></span><span id="sizesToRename"><span class="annot"><span class="annottext">sizesToRename :: StaticVal -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#sizesToRename"><span class="hs-identifier hs-var hs-var">sizesToRename</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-type">DynamicFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523960"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523960"><span class="hs-identifier hs-var">sv1</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523959"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523959"><span class="hs-identifier hs-var">sv2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-336"></span><span>  </span><span class="annot"><span class="annottext">StaticVal -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#sizesToRename"><span class="hs-identifier hs-var">sizesToRename</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523960"><span class="hs-identifier hs-var">sv1</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#sizesToRename"><span class="hs-identifier hs-var">sizesToRename</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523959"><span class="hs-identifier hs-var">sv2</span></a></span><span>
</span><span id="line-337"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#sizesToRename"><span class="hs-identifier hs-var">sizesToRename</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#IntrinsicSV"><span class="hs-identifier hs-var">IntrinsicSV</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-338"></span><span>  </span><span class="annot"><span class="annottext">Set VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-339"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#sizesToRename"><span class="hs-identifier hs-var">sizesToRename</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-340"></span><span>  </span><span class="annot"><span class="annottext">Set VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-341"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#sizesToRename"><span class="hs-identifier hs-var">sizesToRename</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-type">RecordSV</span></a></span><span> </span><span id="local-6989586621684523958"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684523958"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-342"></span><span>  </span><span class="annot"><span class="annottext">((Name, StaticVal) -&gt; Set VName)
-&gt; [(Name, StaticVal)] -&gt; Set VName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticVal -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#sizesToRename"><span class="hs-identifier hs-var">sizesToRename</span></a></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; Set VName)
-&gt; ((Name, StaticVal) -&gt; StaticVal)
-&gt; (Name, StaticVal)
-&gt; Set VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, StaticVal) -&gt; StaticVal
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684523958"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-343"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#sizesToRename"><span class="hs-identifier hs-var">sizesToRename</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SumSV"><span class="hs-identifier hs-type">SumSV</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523957"><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684523957"><span class="hs-identifier hs-var">svs</span></a></span></span><span> </span><span class="annot"><span class="annottext">[(Name, [PatType])]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-344"></span><span>  </span><span class="annot"><span class="annottext">(StaticVal -&gt; Set VName) -&gt; [StaticVal] -&gt; Set VName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#sizesToRename"><span class="hs-identifier hs-var">sizesToRename</span></a></span><span> </span><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684523957"><span class="hs-identifier hs-var">svs</span></a></span><span>
</span><span id="line-345"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#sizesToRename"><span class="hs-identifier hs-var">sizesToRename</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#LambdaSV"><span class="hs-identifier hs-type">LambdaSV</span></a></span><span> </span><span id="local-6989586621684523956"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523956"><span class="hs-identifier hs-var">param</span></a></span></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExtExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-346"></span><span>  </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Set VName
</span><a href="Language.Futhark.Prop.html#patternDimNames"><span class="hs-identifier hs-var">patternDimNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523956"><span class="hs-identifier hs-var">param</span></a></span><span>
</span><span id="line-347"></span><span>    </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(IdentBase Info VName -&gt; VName)
-&gt; Set (IdentBase Info VName) -&gt; Set VName
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName -&gt; VName
forall (f :: * -&gt; *) vn. IdentBase f vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(IdentBase Info VName -&gt; Bool)
-&gt; Set (IdentBase Info VName) -&gt; Set (IdentBase Info VName)
forall a. (a -&gt; Bool) -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.filter</span></span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName -&gt; Bool
forall {vn}. IdentBase Info vn -&gt; Bool
</span><a href="#local-6989586621684523951"><span class="hs-identifier hs-var">couldBeSize</span></a></span><span> </span><span class="annot"><span class="annottext">(Set (IdentBase Info VName) -&gt; Set (IdentBase Info VName))
-&gt; Set (IdentBase Info VName) -&gt; Set (IdentBase Info VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Set (IdentBase Info VName)
forall (f :: * -&gt; *) vn.
(Functor f, Ord vn) =&gt;
PatBase f vn -&gt; Set (IdentBase f vn)
</span><a href="Language.Futhark.Prop.html#patIdents"><span class="hs-identifier hs-var">patIdents</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523956"><span class="hs-identifier hs-var">param</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-348"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-349"></span><span>    </span><span id="local-6989586621684523951"><span class="annot"><span class="annottext">couldBeSize :: IdentBase Info vn -&gt; Bool
</span><a href="#local-6989586621684523951"><span class="hs-identifier hs-var hs-var">couldBeSize</span></a></span></span><span> </span><span id="local-6989586621684523941"><span class="annot"><span class="annottext">IdentBase Info vn
</span><a href="#local-6989586621684523941"><span class="hs-identifier hs-var">ident</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-350"></span><span>      </span><span class="annot"><span class="annottext">Info PatType -&gt; PatType
forall a. Info a -&gt; a
</span><a href="Language.Futhark.Syntax.html#unInfo"><span class="hs-identifier hs-var hs-var">unInfo</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdentBase Info vn -&gt; Info PatType
forall (f :: * -&gt; *) vn. IdentBase f vn -&gt; f PatType
</span><a href="Language.Futhark.Syntax.html#identType"><span class="hs-identifier hs-var hs-var">identType</span></a></span><span> </span><span class="annot"><span class="annottext">IdentBase Info vn
</span><a href="#local-6989586621684523941"><span class="hs-identifier hs-var">ident</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; PatType -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Language.Futhark.Syntax.html#Signed"><span class="hs-identifier hs-var">Signed</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-351"></span><span>
</span><span id="line-352"></span><span class="hs-comment">-- When we instantiate a polymorphic StaticVal, we rename all the</span><span>
</span><span id="line-353"></span><span class="hs-comment">-- sizes to avoid name conflicts later on.  This is a bit of a hack...</span><span>
</span><span id="line-354"></span><span id="local-6989586621684525259"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#instStaticVal"><span class="hs-identifier hs-type">instStaticVal</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-355"></span><span>  </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684525259"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-356"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-357"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-358"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-359"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-360"></span><span>  </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-361"></span><span>  </span><span class="annot"><a href="#local-6989586621684525259"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span></span><span>
</span><span id="line-362"></span><span id="instStaticVal"><span class="annot"><span class="annottext">instStaticVal :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Set VName
-&gt; [VName] -&gt; StructType -&gt; StructType -&gt; StaticVal -&gt; m StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#instStaticVal"><span class="hs-identifier hs-var hs-var">instStaticVal</span></a></span></span><span> </span><span id="local-6989586621684523928"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523928"><span class="hs-identifier hs-var">globals</span></a></span></span><span> </span><span id="local-6989586621684523927"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523927"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684523926"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523926"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684523925"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523925"><span class="hs-identifier hs-var">sv_t</span></a></span></span><span> </span><span id="local-6989586621684523924"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523924"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-363"></span><span>  </span><span id="local-6989586621684523923"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684523923"><span class="hs-identifier hs-var">fresh_substs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; m (Map VName SizeSubst)
forall {f :: * -&gt; *}.
MonadFreshNames f =&gt;
[VName] -&gt; f (Map VName SizeSubst)
</span><a href="#local-6989586621684523922"><span class="hs-identifier hs-var">mkSubsts</span></a></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; m (Map VName SizeSubst))
-&gt; [VName] -&gt; m (Map VName SizeSubst)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; [VName]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set VName -&gt; [VName]) -&gt; Set VName -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523927"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#sizesToRename"><span class="hs-identifier hs-var">sizesToRename</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523924"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-364"></span><span>
</span><span id="line-365"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523920"><span class="annot"><span class="annottext">dims' :: [VName]
</span><a href="#local-6989586621684523920"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; VName) -&gt; [VName] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; VName -&gt; VName
</span><a href="#local-6989586621684523919"><span class="hs-identifier hs-var">onName</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684523923"><span class="hs-identifier hs-var">fresh_substs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523927"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-366"></span><span>      </span><span id="local-6989586621684523916"><span class="annot"><span class="annottext">isDim :: VName -&gt; p -&gt; Bool
</span><a href="#local-6989586621684523916"><span class="hs-identifier hs-var hs-var">isDim</span></a></span></span><span> </span><span id="local-6989586621684523915"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523915"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="annot"><span class="annottext">p
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523915"><span class="hs-identifier hs-var">k</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523920"><span class="hs-identifier hs-var">dims'</span></a></span><span>
</span><span id="line-367"></span><span>      </span><span id="local-6989586621684523912"><span class="annot"><span class="annottext">dim_substs :: Map VName SizeSubst
</span><a href="#local-6989586621684523912"><span class="hs-identifier hs-var hs-var">dim_substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-368"></span><span>        </span><span class="annot"><span class="annottext">(VName -&gt; SizeSubst -&gt; Bool)
-&gt; Map VName SizeSubst -&gt; Map VName SizeSubst
forall k a. (k -&gt; a -&gt; Bool) -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.filterWithKey</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; SizeSubst -&gt; Bool
forall {p}. VName -&gt; p -&gt; Bool
</span><a href="#local-6989586621684523916"><span class="hs-identifier hs-var">isDim</span></a></span><span> </span><span class="annot"><span class="annottext">(Map VName SizeSubst -&gt; Map VName SizeSubst)
-&gt; Map VName SizeSubst -&gt; Map VName SizeSubst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; StructType -&gt; Map VName SizeSubst
forall a.
Monoid a =&gt;
TypeBase (DimDecl VName) a
-&gt; TypeBase (DimDecl VName) a -&gt; Map VName SizeSubst
</span><a href="Futhark.Internalise.Defunctionalise.html#dimMapping"><span class="hs-identifier hs-var">dimMapping</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; StructType -&gt; StructType
forall als.
Map VName SizeSubst
-&gt; TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceTypeSizes"><span class="hs-identifier hs-var">replaceTypeSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684523923"><span class="hs-identifier hs-var">fresh_substs</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523925"><span class="hs-identifier hs-var">sv_t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523926"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-369"></span><span>      </span><span id="local-6989586621684523910"><span class="annot"><span class="annottext">replace :: SizeSubst -&gt; SizeSubst
</span><a href="#local-6989586621684523910"><span class="hs-identifier hs-var hs-var">replace</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SubstNamed"><span class="hs-identifier hs-type">SubstNamed</span></a></span><span> </span><span id="local-6989586621684523909"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523909"><span class="hs-identifier hs-var">k</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SizeSubst -&gt; Maybe SizeSubst -&gt; SizeSubst
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; SizeSubst
</span><a href="Futhark.Internalise.Defunctionalise.html#SubstNamed"><span class="hs-identifier hs-var">SubstNamed</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523909"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe SizeSubst -&gt; SizeSubst) -&gt; Maybe SizeSubst -&gt; SizeSubst
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName SizeSubst -&gt; Maybe SizeSubst
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523909"><span class="hs-identifier hs-var">k</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684523912"><span class="hs-identifier hs-var">dim_substs</span></a></span><span>
</span><span id="line-370"></span><span>      </span><span class="annot"><a href="#local-6989586621684523910"><span class="hs-identifier hs-var">replace</span></a></span><span> </span><span id="local-6989586621684523907"><span class="annot"><span class="annottext">SizeSubst
</span><a href="#local-6989586621684523907"><span class="hs-identifier hs-var">k</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SizeSubst
</span><a href="#local-6989586621684523907"><span class="hs-identifier hs-var">k</span></a></span><span>
</span><span id="line-371"></span><span>      </span><span id="local-6989586621684523904"><span class="annot"><span class="annottext">substs :: Map VName SizeSubst
</span><a href="#local-6989586621684523904"><span class="hs-identifier hs-var hs-var">substs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(SizeSubst -&gt; SizeSubst)
-&gt; Map VName SizeSubst -&gt; Map VName SizeSubst
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">SizeSubst -&gt; SizeSubst
</span><a href="#local-6989586621684523910"><span class="hs-identifier hs-var">replace</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684523923"><span class="hs-identifier hs-var">fresh_substs</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst -&gt; Map VName SizeSubst -&gt; Map VName SizeSubst
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684523912"><span class="hs-identifier hs-var">dim_substs</span></a></span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span>  </span><span class="annot"><span class="annottext">StaticVal -&gt; m StaticVal
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; m StaticVal) -&gt; StaticVal -&gt; m StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Map VName SizeSubst -&gt; StaticVal -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#replaceStaticValSizes"><span class="hs-identifier hs-var">replaceStaticValSizes</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523928"><span class="hs-identifier hs-var">globals</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684523904"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523924"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-374"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-375"></span><span>    </span><span id="local-6989586621684523922"><span class="annot"><span class="annottext">mkSubsts :: [VName] -&gt; f (Map VName SizeSubst)
</span><a href="#local-6989586621684523922"><span class="hs-identifier hs-var hs-var">mkSubsts</span></a></span></span><span> </span><span id="local-6989586621684523893"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523893"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-376"></span><span>      </span><span class="annot"><span class="annottext">[(VName, SizeSubst)] -&gt; Map VName SizeSubst
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, SizeSubst)] -&gt; Map VName SizeSubst)
-&gt; ([VName] -&gt; [(VName, SizeSubst)])
-&gt; [VName]
-&gt; Map VName SizeSubst
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [SizeSubst] -&gt; [(VName, SizeSubst)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523893"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">([SizeSubst] -&gt; [(VName, SizeSubst)])
-&gt; ([VName] -&gt; [SizeSubst]) -&gt; [VName] -&gt; [(VName, SizeSubst)]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; SizeSubst) -&gt; [VName] -&gt; [SizeSubst]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; SizeSubst
</span><a href="Futhark.Internalise.Defunctionalise.html#SubstNamed"><span class="hs-identifier hs-var">SubstNamed</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; SizeSubst)
-&gt; (VName -&gt; QualName VName) -&gt; VName -&gt; SizeSubst
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-377"></span><span>        </span><span class="annot"><span class="annottext">([VName] -&gt; Map VName SizeSubst)
-&gt; f [VName] -&gt; f (Map VName SizeSubst)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; f VName) -&gt; [VName] -&gt; f [VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; f VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; VName -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newName"><span class="hs-identifier hs-var">newName</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523893"><span class="hs-identifier hs-var">names</span></a></span><span>
</span><span id="line-378"></span><span>
</span><span id="line-379"></span><span>    </span><span id="local-6989586621684523919"><span class="annot"><span class="annottext">onName :: Map VName SizeSubst -&gt; VName -&gt; VName
</span><a href="#local-6989586621684523919"><span class="hs-identifier hs-var hs-var">onName</span></a></span></span><span> </span><span id="local-6989586621684523888"><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684523888"><span class="hs-identifier hs-var">substs</span></a></span></span><span> </span><span id="local-6989586621684523887"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523887"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-380"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName SizeSubst -&gt; Maybe SizeSubst
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523887"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName SizeSubst
</span><a href="#local-6989586621684523888"><span class="hs-identifier hs-var">substs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-381"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SubstNamed"><span class="hs-identifier hs-type">SubstNamed</span></a></span><span> </span><span id="local-6989586621684523886"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523886"><span class="hs-identifier hs-var">v'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523886"><span class="hs-identifier hs-var">v'</span></a></span><span>
</span><span id="line-382"></span><span>        </span><span class="annot"><span class="annottext">Maybe SizeSubst
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523887"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-383"></span><span>
</span><span id="line-384"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncFun"><span class="hs-identifier hs-type">defuncFun</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-385"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-386"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-387"></span><span>  </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-388"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructRetType"><span class="hs-identifier hs-type">StructRetType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-389"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">SrcLoc</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-390"></span><span>  </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-391"></span><span id="defuncFun"><span class="annot"><span class="annottext">defuncFun :: [VName]
-&gt; [PatBase Info VName]
-&gt; Exp
-&gt; StructRetType
-&gt; SrcLoc
-&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncFun"><span class="hs-identifier hs-var hs-var">defuncFun</span></a></span></span><span> </span><span id="local-6989586621684523884"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523884"><span class="hs-identifier hs-var">tparams</span></a></span></span><span> </span><span id="local-6989586621684523883"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523883"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span id="local-6989586621684523882"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523882"><span class="hs-identifier hs-var">e0</span></a></span></span><span> </span><span id="local-6989586621684523881"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523881"><span class="hs-identifier hs-var">ret</span></a></span></span><span> </span><span id="local-6989586621684523880"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523880"><span class="hs-identifier hs-var">loc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-392"></span><span>  </span><span class="hs-comment">-- Extract the first parameter of the lambda and &quot;push&quot; the</span><span>
</span><span id="line-393"></span><span>  </span><span class="hs-comment">-- remaining ones (if there are any) into the body of the lambda.</span><span>
</span><span id="line-394"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523876"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523876"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523875"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523875"><span class="hs-identifier hs-var">ret'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523874"><span class="annot"><span class="annottext">ExtExp
</span><a href="#local-6989586621684523874"><span class="hs-identifier hs-var">e0'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523883"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-395"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; (PatBase Info VName, StructRetType, ExtExp)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Received a lambda with no parameters.&quot;</span></span><span>
</span><span id="line-396"></span><span>        </span><span class="hs-special">[</span><span id="local-6989586621684523872"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523872"><span class="hs-identifier hs-var">pat'</span></a></span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523872"><span class="hs-identifier hs-var">pat'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523881"><span class="hs-identifier hs-var">ret</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; ExtExp
</span><a href="Futhark.Internalise.Defunctionalise.html#ExtExp"><span class="hs-identifier hs-var">ExtExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523882"><span class="hs-identifier hs-var">e0</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-397"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684523871"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523871"><span class="hs-identifier hs-var">pat'</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684523870"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523870"><span class="hs-identifier hs-var">pats'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-398"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523871"><span class="hs-identifier hs-var">pat'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-399"></span><span>            </span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; StructRetType) -&gt; StructType -&gt; StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[StructType] -&gt; StructRetType -&gt; StructType
forall as dim.
Monoid as =&gt;
[TypeBase dim as] -&gt; RetTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#foldFunType"><span class="hs-identifier hs-var">foldFunType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; StructType)
-&gt; [PatBase Info VName] -&gt; [StructType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StructType)
-&gt; (PatBase Info VName -&gt; PatType)
-&gt; PatBase Info VName
-&gt; StructType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; PatType
</span><a href="Language.Futhark.Prop.html#patternType"><span class="hs-identifier hs-var">patternType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523870"><span class="hs-identifier hs-var">pats'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523881"><span class="hs-identifier hs-var">ret</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-400"></span><span>            </span><span class="annot"><span class="annottext">[PatBase Info VName] -&gt; Exp -&gt; StructRetType -&gt; SrcLoc -&gt; ExtExp
</span><a href="Futhark.Internalise.Defunctionalise.html#ExtLambda"><span class="hs-identifier hs-var">ExtLambda</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523870"><span class="hs-identifier hs-var">pats'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523882"><span class="hs-identifier hs-var">e0</span></a></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523881"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523880"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-401"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-402"></span><span>
</span><span id="line-403"></span><span>  </span><span class="hs-comment">-- Construct a record literal that closes over the environment of</span><span>
</span><span id="line-404"></span><span>  </span><span class="hs-comment">-- the lambda.  Closed-over 'DynamicFun's are converted to their</span><span>
</span><span id="line-405"></span><span>  </span><span class="hs-comment">-- closure representation.</span><span>
</span><span id="line-406"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523863"><span class="annot"><span class="annottext">used :: NameSet
</span><a href="#local-6989586621684523863"><span class="hs-identifier hs-var hs-var">used</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-407"></span><span>        </span><span class="annot"><span class="annottext">Exp -&gt; NameSet
</span><a href="Futhark.Internalise.FreeVars.html#freeVars"><span class="hs-identifier hs-var">FV.freeVars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatBase Info VName]
-&gt; Exp
-&gt; Maybe (TypeExp VName)
-&gt; Info (Set Alias, StructRetType)
-&gt; SrcLoc
-&gt; Exp
forall (f :: * -&gt; *) vn.
[PatBase f vn]
-&gt; ExpBase f vn
-&gt; Maybe (TypeExp vn)
-&gt; f (Set Alias, StructRetType)
-&gt; SrcLoc
-&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523883"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523882"><span class="hs-identifier hs-var">e0</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TypeExp VName)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Set Alias, StructRetType) -&gt; Info (Set Alias, StructRetType)
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Alias
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523881"><span class="hs-identifier hs-var">ret</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523880"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-408"></span><span>          </span><span class="annot"><span class="annottext">NameSet -&gt; Set VName -&gt; NameSet
</span><a href="Futhark.Internalise.FreeVars.html#without"><span class="hs-operator hs-var">`FV.without`</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523884"><span class="hs-identifier hs-var">tparams</span></a></span><span>
</span><span id="line-409"></span><span>  </span><span id="local-6989586621684523859"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523859"><span class="hs-identifier hs-var">used_env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">NameSet -&gt; DefM Env
</span><a href="Futhark.Internalise.Defunctionalise.html#restrictEnvTo"><span class="hs-identifier hs-var">restrictEnvTo</span></a></span><span> </span><span class="annot"><span class="annottext">NameSet
</span><a href="#local-6989586621684523863"><span class="hs-identifier hs-var">used</span></a></span><span>
</span><span id="line-410"></span><span>
</span><span id="line-411"></span><span>  </span><span class="hs-comment">-- The closure parts that are sizes are proactively turned into size</span><span>
</span><span id="line-412"></span><span>  </span><span class="hs-comment">-- parameters.</span><span>
</span><span id="line-413"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523854"><span class="annot"><span class="annottext">sizes_of_arrays :: Set VName
</span><a href="#local-6989586621684523854"><span class="hs-identifier hs-var hs-var">sizes_of_arrays</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-414"></span><span>        </span><span class="annot"><span class="annottext">(Binding -&gt; Set VName) -&gt; Env -&gt; Set VName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#arraySizes"><span class="hs-identifier hs-var">arraySizes</span></a></span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; Set VName)
-&gt; (Binding -&gt; StructType) -&gt; Binding -&gt; Set VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StructType)
-&gt; (Binding -&gt; PatType) -&gt; Binding -&gt; StructType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; PatType)
-&gt; (Binding -&gt; StaticVal) -&gt; Binding -&gt; PatType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Binding -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#bindingSV"><span class="hs-identifier hs-var">bindingSV</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523859"><span class="hs-identifier hs-var">used_env</span></a></span><span>
</span><span id="line-415"></span><span>          </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#patternArraySizes"><span class="hs-identifier hs-var">patternArraySizes</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523876"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-416"></span><span>      </span><span id="local-6989586621684523851"><span class="annot"><span class="annottext">notSize :: VName -&gt; Bool
</span><a href="#local-6989586621684523851"><span class="hs-identifier hs-var hs-var">notSize</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; (VName -&gt; Bool) -&gt; VName -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523854"><span class="hs-identifier hs-var">sizes_of_arrays</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-417"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684523848"><span class="annot"><span class="annottext">[FieldBase Info VName]
</span><a href="#local-6989586621684523848"><span class="hs-identifier hs-var">fields</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523847"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523847"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-418"></span><span>        </span><span class="annot"><span class="annottext">([(VName, Binding)] -&gt; Env)
-&gt; ([FieldBase Info VName], [(VName, Binding)])
-&gt; ([FieldBase Info VName], Env)
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="annot"><span class="annottext">[(VName, Binding)] -&gt; Env
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">(([FieldBase Info VName], [(VName, Binding)])
 -&gt; ([FieldBase Info VName], Env))
-&gt; ([(VName, Binding)]
    -&gt; ([FieldBase Info VName], [(VName, Binding)]))
-&gt; [(VName, Binding)]
-&gt; ([FieldBase Info VName], Env)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(FieldBase Info VName, (VName, Binding))]
-&gt; ([FieldBase Info VName], [(VName, Binding)])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(FieldBase Info VName, (VName, Binding))]
 -&gt; ([FieldBase Info VName], [(VName, Binding)]))
-&gt; ([(VName, Binding)]
    -&gt; [(FieldBase Info VName, (VName, Binding))])
-&gt; [(VName, Binding)]
-&gt; ([FieldBase Info VName], [(VName, Binding)])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((VName, Binding) -&gt; (FieldBase Info VName, (VName, Binding)))
-&gt; [(VName, Binding)] -&gt; [(FieldBase Info VName, (VName, Binding))]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, Binding) -&gt; (FieldBase Info VName, (VName, Binding))
</span><a href="#local-6989586621684523845"><span class="hs-identifier hs-var">closureFromDynamicFun</span></a></span><span>
</span><span id="line-419"></span><span>          </span><span class="annot"><span class="annottext">([(VName, Binding)] -&gt; [(FieldBase Info VName, (VName, Binding))])
-&gt; ([(VName, Binding)] -&gt; [(VName, Binding)])
-&gt; [(VName, Binding)]
-&gt; [(FieldBase Info VName, (VName, Binding))]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">((VName, Binding) -&gt; Bool)
-&gt; [(VName, Binding)] -&gt; [(VName, Binding)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Bool
</span><a href="#local-6989586621684523851"><span class="hs-identifier hs-var">notSize</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; ((VName, Binding) -&gt; VName) -&gt; (VName, Binding) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(VName, Binding) -&gt; VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span>          </span><span class="annot"><span class="annottext">([(VName, Binding)] -&gt; ([FieldBase Info VName], Env))
-&gt; [(VName, Binding)] -&gt; ([FieldBase Info VName], Env)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; [(VName, Binding)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523859"><span class="hs-identifier hs-var">used_env</span></a></span><span>
</span><span id="line-421"></span><span>
</span><span id="line-422"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-423"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[FieldBase Info VName] -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn. [FieldBase f vn] -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#RecordLit"><span class="hs-identifier hs-var">RecordLit</span></a></span><span> </span><span class="annot"><span class="annottext">[FieldBase Info VName]
</span><a href="#local-6989586621684523848"><span class="hs-identifier hs-var">fields</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523880"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-424"></span><span>      </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StructRetType -&gt; ExtExp -&gt; Env -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#LambdaSV"><span class="hs-identifier hs-var">LambdaSV</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523876"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523875"><span class="hs-identifier hs-var">ret'</span></a></span><span> </span><span class="annot"><span class="annottext">ExtExp
</span><a href="#local-6989586621684523874"><span class="hs-identifier hs-var">e0'</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523847"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-425"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-426"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-427"></span><span>    </span><span id="local-6989586621684523845"><span class="annot"><span class="annottext">closureFromDynamicFun :: (VName, Binding) -&gt; (FieldBase Info VName, (VName, Binding))
</span><a href="#local-6989586621684523845"><span class="hs-identifier hs-var hs-var">closureFromDynamicFun</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523840"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523840"><span class="hs-identifier hs-var">vn</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-type">DynamicFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523839"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523839"><span class="hs-identifier hs-var">clsr_env</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523838"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523838"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-428"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523836"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621684523836"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523840"><span class="hs-identifier hs-var">vn</span></a></span><span>
</span><span id="line-429"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Exp -&gt; SrcLoc -&gt; FieldBase Info VName
forall (f :: * -&gt; *) vn.
Name -&gt; ExpBase f vn -&gt; SrcLoc -&gt; FieldBase f vn
</span><a href="Language.Futhark.Syntax.html#RecordFieldExplicit"><span class="hs-identifier hs-var">RecordFieldExplicit</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523836"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523839"><span class="hs-identifier hs-var">clsr_env</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-430"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523840"><span class="hs-identifier hs-var">vn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType) -&gt; StaticVal -&gt; Binding
</span><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523838"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-431"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-432"></span><span>    </span><span class="annot"><a href="#local-6989586621684523845"><span class="hs-identifier hs-var">closureFromDynamicFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523832"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523832"><span class="hs-identifier hs-var">vn</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523831"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523831"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-433"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523829"><span class="annot"><span class="annottext">name :: Name
</span><a href="#local-6989586621684523829"><span class="hs-identifier hs-var hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; String -&gt; Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523832"><span class="hs-identifier hs-var">vn</span></a></span><span>
</span><span id="line-434"></span><span>          </span><span id="local-6989586621684523828"><span class="annot"><span class="annottext">tp' :: PatType
</span><a href="#local-6989586621684523828"><span class="hs-identifier hs-var hs-var">tp'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523831"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-435"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Exp -&gt; SrcLoc -&gt; FieldBase Info VName
forall (f :: * -&gt; *) vn.
Name -&gt; ExpBase f vn -&gt; SrcLoc -&gt; FieldBase f vn
</span><a href="Language.Futhark.Syntax.html#RecordFieldExplicit"><span class="hs-identifier hs-var">RecordFieldExplicit</span></a></span><span>
</span><span id="line-436"></span><span>              </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523829"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-437"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; Info PatType -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
QualName vn -&gt; f PatType -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523832"><span class="hs-identifier hs-var">vn</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523828"><span class="hs-identifier hs-var">tp'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>              </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-439"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523832"><span class="hs-identifier hs-var">vn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType) -&gt; StaticVal -&gt; Binding
</span><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523831"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-440"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>
</span><span id="line-442"></span><span class="hs-comment">-- | Defunctionalization of an expression. Returns the residual expression and</span><span>
</span><span id="line-443"></span><span class="hs-comment">-- the associated static value in the defunctionalization monad.</span><span>
</span><span id="line-444"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-type">defuncExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-445"></span><span id="defuncExp"><span class="annot"><span class="annottext">defuncExp :: Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var hs-var">defuncExp</span></a></span></span><span> </span><span id="local-6989586621684523826"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684523826"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Language.Futhark.Syntax.html#Literal"><span class="hs-identifier hs-type">Literal</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-446"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523826"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523826"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-447"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span id="local-6989586621684523824"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684523824"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Language.Futhark.Syntax.html#IntLit"><span class="hs-identifier hs-type">IntLit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-448"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523824"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523824"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-449"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span id="local-6989586621684523822"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684523822"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Language.Futhark.Syntax.html#FloatLit"><span class="hs-identifier hs-type">FloatLit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-450"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523822"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523822"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-451"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span id="local-6989586621684523820"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684523820"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Language.Futhark.Syntax.html#StringLit"><span class="hs-identifier hs-type">StringLit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-452"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523820"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523820"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-453"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Parens"><span class="hs-identifier hs-type">Parens</span></a></span><span> </span><span id="local-6989586621684523817"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523817"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684523816"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523816"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-454"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523815"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523815"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523814"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523814"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523817"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-455"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn. ExpBase f vn -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Parens"><span class="hs-identifier hs-var">Parens</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523815"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523816"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523814"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-456"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#QualParens"><span class="hs-identifier hs-type">QualParens</span></a></span><span> </span><span id="local-6989586621684523812"><span class="annot"><span class="annottext">(QualName VName, SrcLoc)
</span><a href="#local-6989586621684523812"><span class="hs-identifier hs-var">qn</span></a></span></span><span> </span><span id="local-6989586621684523811"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523811"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684523810"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523810"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-457"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523809"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523809"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523808"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523808"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523811"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-458"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(QualName VName, SrcLoc) -&gt; Exp -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
(QualName vn, SrcLoc) -&gt; ExpBase f vn -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#QualParens"><span class="hs-identifier hs-var">QualParens</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName, SrcLoc)
</span><a href="#local-6989586621684523812"><span class="hs-identifier hs-var">qn</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523809"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523810"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523808"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-459"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TupLit"><span class="hs-identifier hs-type">TupLit</span></a></span><span> </span><span id="local-6989586621684523806"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523806"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621684523805"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523805"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-460"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523804"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523804"><span class="hs-identifier hs-var">es'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523803"><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684523803"><span class="hs-identifier hs-var">svs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Exp, StaticVal)] -&gt; ([Exp], [StaticVal])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Exp, StaticVal)] -&gt; ([Exp], [StaticVal]))
-&gt; DefM [(Exp, StaticVal)] -&gt; DefM ([Exp], [StaticVal])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; DefM (Exp, StaticVal)) -&gt; [Exp] -&gt; DefM [(Exp, StaticVal)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523806"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-461"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Exp] -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn. [ExpBase f vn] -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#TupLit"><span class="hs-identifier hs-var">TupLit</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523804"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523805"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)] -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-var">RecordSV</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, StaticVal)] -&gt; StaticVal)
-&gt; [(Name, StaticVal)] -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [StaticVal] -&gt; [(Name, StaticVal)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="Language.Futhark.Prop.html#tupleFieldNames"><span class="hs-identifier hs-var">tupleFieldNames</span></a></span><span> </span><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684523803"><span class="hs-identifier hs-var">svs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-462"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RecordLit"><span class="hs-identifier hs-type">RecordLit</span></a></span><span> </span><span id="local-6989586621684523801"><span class="annot"><span class="annottext">[FieldBase Info VName]
</span><a href="#local-6989586621684523801"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span id="local-6989586621684523800"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523800"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-463"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523799"><span class="annot"><span class="annottext">[FieldBase Info VName]
</span><a href="#local-6989586621684523799"><span class="hs-identifier hs-var">fs'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523798"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684523798"><span class="hs-identifier hs-var">names_svs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(FieldBase Info VName, (Name, StaticVal))]
-&gt; ([FieldBase Info VName], [(Name, StaticVal)])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(FieldBase Info VName, (Name, StaticVal))]
 -&gt; ([FieldBase Info VName], [(Name, StaticVal)]))
-&gt; DefM [(FieldBase Info VName, (Name, StaticVal))]
-&gt; DefM ([FieldBase Info VName], [(Name, StaticVal)])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(FieldBase Info VName
 -&gt; DefM (FieldBase Info VName, (Name, StaticVal)))
-&gt; [FieldBase Info VName]
-&gt; DefM [(FieldBase Info VName, (Name, StaticVal))]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">FieldBase Info VName
-&gt; DefM (FieldBase Info VName, (Name, StaticVal))
</span><a href="#local-6989586621684523797"><span class="hs-identifier hs-var">defuncField</span></a></span><span> </span><span class="annot"><span class="annottext">[FieldBase Info VName]
</span><a href="#local-6989586621684523801"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-464"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[FieldBase Info VName] -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn. [FieldBase f vn] -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#RecordLit"><span class="hs-identifier hs-var">RecordLit</span></a></span><span> </span><span class="annot"><span class="annottext">[FieldBase Info VName]
</span><a href="#local-6989586621684523799"><span class="hs-identifier hs-var">fs'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523800"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)] -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-var">RecordSV</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684523798"><span class="hs-identifier hs-var">names_svs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-465"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-466"></span><span>    </span><span id="local-6989586621684523797"><span class="annot"><span class="annottext">defuncField :: FieldBase Info VName
-&gt; DefM (FieldBase Info VName, (Name, StaticVal))
</span><a href="#local-6989586621684523797"><span class="hs-identifier hs-var hs-var">defuncField</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RecordFieldExplicit"><span class="hs-identifier hs-type">RecordFieldExplicit</span></a></span><span> </span><span id="local-6989586621684523791"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523791"><span class="hs-identifier hs-var">vn</span></a></span></span><span> </span><span id="local-6989586621684523790"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523790"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684523789"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523789"><span class="hs-identifier hs-var">loc'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-467"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684523788"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523788"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523787"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523787"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523790"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-468"></span><span>      </span><span class="annot"><span class="annottext">(FieldBase Info VName, (Name, StaticVal))
-&gt; DefM (FieldBase Info VName, (Name, StaticVal))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Exp -&gt; SrcLoc -&gt; FieldBase Info VName
forall (f :: * -&gt; *) vn.
Name -&gt; ExpBase f vn -&gt; SrcLoc -&gt; FieldBase f vn
</span><a href="Language.Futhark.Syntax.html#RecordFieldExplicit"><span class="hs-identifier hs-var">RecordFieldExplicit</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523791"><span class="hs-identifier hs-var">vn</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523788"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523789"><span class="hs-identifier hs-var">loc'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523791"><span class="hs-identifier hs-var">vn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523787"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-469"></span><span>    </span><span class="annot"><a href="#local-6989586621684523797"><span class="hs-identifier hs-var">defuncField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RecordFieldImplicit"><span class="hs-identifier hs-type">RecordFieldImplicit</span></a></span><span> </span><span id="local-6989586621684523785"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523785"><span class="hs-identifier hs-var">vn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684523784"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523784"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523783"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523783"><span class="hs-identifier hs-var">loc'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-470"></span><span>      </span><span id="local-6989586621684523782"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523782"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StructType -&gt; VName -&gt; DefM StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523784"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523785"><span class="hs-identifier hs-var">vn</span></a></span><span>
</span><span id="line-471"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523782"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-472"></span><span>        </span><span class="hs-comment">-- If the implicit field refers to a dynamic function, we</span><span>
</span><span id="line-473"></span><span>        </span><span class="hs-comment">-- convert it to an explicit field with a record closing over</span><span>
</span><span id="line-474"></span><span>        </span><span class="hs-comment">-- the environment and bind the corresponding static value.</span><span>
</span><span id="line-475"></span><span>        </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-type">DynamicFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523781"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523781"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523780"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523780"><span class="hs-identifier hs-var">sv'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-476"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523779"><span class="annot"><span class="annottext">vn' :: Name
</span><a href="#local-6989586621684523779"><span class="hs-identifier hs-var hs-var">vn'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Name
</span><a href="Language.Futhark.Core.html#baseName"><span class="hs-identifier hs-var">baseName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523785"><span class="hs-identifier hs-var">vn</span></a></span><span>
</span><span id="line-477"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(FieldBase Info VName, (Name, StaticVal))
-&gt; DefM (FieldBase Info VName, (Name, StaticVal))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-478"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Exp -&gt; SrcLoc -&gt; FieldBase Info VName
forall (f :: * -&gt; *) vn.
Name -&gt; ExpBase f vn -&gt; SrcLoc -&gt; FieldBase f vn
</span><a href="Language.Futhark.Syntax.html#RecordFieldExplicit"><span class="hs-identifier hs-var">RecordFieldExplicit</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523779"><span class="hs-identifier hs-var">vn'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523781"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523783"><span class="hs-identifier hs-var">loc'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-479"></span><span>                  </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523779"><span class="hs-identifier hs-var">vn'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523780"><span class="hs-identifier hs-var">sv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-480"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-481"></span><span>        </span><span class="hs-comment">-- The field may refer to a functional expression, so we get the</span><span>
</span><span id="line-482"></span><span>        </span><span class="hs-comment">-- type from the static value and not the one from the AST.</span><span>
</span><span id="line-483"></span><span>        </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-484"></span><span>          </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523777"><span class="annot"><span class="annottext">tp :: Info PatType
</span><a href="#local-6989586621684523777"><span class="hs-identifier hs-var hs-var">tp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; Info PatType) -&gt; PatType -&gt; Info PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523782"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-485"></span><span>           </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(FieldBase Info VName, (Name, StaticVal))
-&gt; DefM (FieldBase Info VName, (Name, StaticVal))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Info PatType -&gt; SrcLoc -&gt; FieldBase Info VName
forall (f :: * -&gt; *) vn.
vn -&gt; f PatType -&gt; SrcLoc -&gt; FieldBase f vn
</span><a href="Language.Futhark.Syntax.html#RecordFieldImplicit"><span class="hs-identifier hs-var">RecordFieldImplicit</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523785"><span class="hs-identifier hs-var">vn</span></a></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><a href="#local-6989586621684523777"><span class="hs-identifier hs-var">tp</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523783"><span class="hs-identifier hs-var">loc'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Name
</span><a href="Language.Futhark.Core.html#baseName"><span class="hs-identifier hs-var">baseName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523785"><span class="hs-identifier hs-var">vn</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523782"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-486"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ArrayLit"><span class="hs-identifier hs-type">ArrayLit</span></a></span><span> </span><span id="local-6989586621684523775"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523775"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621684523774"><span class="annot"><span class="annottext">t :: Info PatType
</span><a href="#local-6989586621684523774"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684523773"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523773"><span class="hs-identifier hs-var">t'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523772"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523772"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-487"></span><span>  </span><span id="local-6989586621684523771"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523771"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; DefM Exp) -&gt; [Exp] -&gt; DefM [Exp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-var">defuncExp'</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523775"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-488"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Exp] -&gt; Info PatType -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
[ExpBase f vn] -&gt; f PatType -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#ArrayLit"><span class="hs-identifier hs-var">ArrayLit</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523771"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><a href="#local-6989586621684523774"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523772"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523773"><span class="hs-identifier hs-var">t'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-489"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Range"><span class="hs-identifier hs-type">Range</span></a></span><span> </span><span id="local-6989586621684523768"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523768"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621684523767"><span class="annot"><span class="annottext">Maybe Exp
</span><a href="#local-6989586621684523767"><span class="hs-identifier hs-var">me</span></a></span></span><span> </span><span id="local-6989586621684523766"><span class="annot"><span class="annottext">Inclusiveness Exp
</span><a href="#local-6989586621684523766"><span class="hs-identifier hs-var">incl</span></a></span></span><span> </span><span id="local-6989586621684523765"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523765"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523764"><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523764"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-490"></span><span>  </span><span id="local-6989586621684523763"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523763"><span class="hs-identifier hs-var">e1'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-var">defuncExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523768"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-491"></span><span>  </span><span id="local-6989586621684523762"><span class="annot"><span class="annottext">Maybe Exp
</span><a href="#local-6989586621684523762"><span class="hs-identifier hs-var">me'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; DefM Exp) -&gt; Maybe Exp -&gt; DefM (Maybe Exp)
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-var">defuncExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
</span><a href="#local-6989586621684523767"><span class="hs-identifier hs-var">me</span></a></span><span>
</span><span id="line-492"></span><span>  </span><span id="local-6989586621684523761"><span class="annot"><span class="annottext">Inclusiveness Exp
</span><a href="#local-6989586621684523761"><span class="hs-identifier hs-var">incl'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; DefM Exp) -&gt; Inclusiveness Exp -&gt; DefM (Inclusiveness Exp)
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-var">defuncExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Inclusiveness Exp
</span><a href="#local-6989586621684523766"><span class="hs-identifier hs-var">incl</span></a></span><span>
</span><span id="line-493"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-494"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
-&gt; Maybe Exp
-&gt; Inclusiveness Exp
-&gt; SrcLoc
-&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
ExpBase f vn
-&gt; Maybe (ExpBase f vn)
-&gt; Inclusiveness (ExpBase f vn)
-&gt; SrcLoc
-&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Range"><span class="hs-identifier hs-var">Range</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523763"><span class="hs-identifier hs-var">e1'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
</span><a href="#local-6989586621684523762"><span class="hs-identifier hs-var">me'</span></a></span><span> </span><span class="annot"><span class="annottext">Inclusiveness Exp
</span><a href="#local-6989586621684523761"><span class="hs-identifier hs-var">incl'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523765"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523764"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-495"></span><span>      </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">AppRes -&gt; PatType
</span><a href="Language.Futhark.Syntax.html#appResType"><span class="hs-identifier hs-var hs-var">appResType</span></a></span><span> </span><span class="annot"><span class="annottext">(AppRes -&gt; PatType) -&gt; AppRes -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Info AppRes -&gt; AppRes
forall a. Info a -&gt; a
</span><a href="Language.Futhark.Syntax.html#unInfo"><span class="hs-identifier hs-var hs-var">unInfo</span></a></span><span> </span><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523764"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-496"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-497"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span id="local-6989586621684523759"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684523759"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684523758"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523758"><span class="hs-identifier hs-var">qn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684523757"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523757"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523756"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523756"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-498"></span><span>  </span><span id="local-6989586621684523755"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523755"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StructType -&gt; VName -&gt; DefM StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523757"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523758"><span class="hs-identifier hs-var">qn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-499"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523755"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-500"></span><span>    </span><span class="hs-comment">-- If the variable refers to a dynamic function, we return its closure</span><span>
</span><span id="line-501"></span><span>    </span><span class="hs-comment">-- representation (i.e., a record expression capturing the free variables</span><span>
</span><span id="line-502"></span><span>    </span><span class="hs-comment">-- and a 'LambdaSV' static value) instead of the variable itself.</span><span>
</span><span id="line-503"></span><span>    </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-type">DynamicFun</span></a></span><span> </span><span id="local-6989586621684523754"><span class="annot"><span class="annottext">(Exp, StaticVal)
</span><a href="#local-6989586621684523754"><span class="hs-identifier hs-var">closure</span></a></span></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal)
</span><a href="#local-6989586621684523754"><span class="hs-identifier hs-var">closure</span></a></span><span>
</span><span id="line-504"></span><span>    </span><span class="hs-comment">-- Intrinsic functions used as variables are eta-expanded, so we</span><span>
</span><span id="line-505"></span><span>    </span><span class="hs-comment">-- can get rid of them.</span><span>
</span><span id="line-506"></span><span>    </span><span class="annot"><span class="annottext">StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#IntrinsicSV"><span class="hs-identifier hs-var">IntrinsicSV</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-507"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684523753"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523753"><span class="hs-identifier hs-var">pats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523752"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523752"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523751"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523751"><span class="hs-identifier hs-var">tp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Exp -&gt; DefM ([PatBase Info VName], Exp, StructRetType)
</span><a href="Futhark.Internalise.Defunctionalise.html#etaExpand"><span class="hs-identifier hs-var">etaExpand</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523759"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523759"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-508"></span><span>      </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; DefM (Exp, StaticVal)) -&gt; Exp -&gt; DefM (Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
-&gt; Exp
-&gt; Maybe (TypeExp VName)
-&gt; Info (Set Alias, StructRetType)
-&gt; SrcLoc
-&gt; Exp
forall (f :: * -&gt; *) vn.
[PatBase f vn]
-&gt; ExpBase f vn
-&gt; Maybe (TypeExp vn)
-&gt; f (Set Alias, StructRetType)
-&gt; SrcLoc
-&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523753"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523752"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TypeExp VName)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Set Alias, StructRetType) -&gt; Info (Set Alias, StructRetType)
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Alias
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523751"><span class="hs-identifier hs-var">tp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-509"></span><span>    </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-510"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523749"><span class="annot"><span class="annottext">tp :: PatType
</span><a href="#local-6989586621684523749"><span class="hs-identifier hs-var hs-var">tp</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523755"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-511"></span><span>       </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; Info PatType -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
QualName vn -&gt; f PatType -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523758"><span class="hs-identifier hs-var">qn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523749"><span class="hs-identifier hs-var">tp</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523756"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523755"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-512"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Ascript"><span class="hs-identifier hs-type">Ascript</span></a></span><span> </span><span id="local-6989586621684523747"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523747"><span class="hs-identifier hs-var">e0</span></a></span></span><span> </span><span id="local-6989586621684523746"><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><a href="#local-6989586621684523746"><span class="hs-identifier hs-var">tydecl</span></a></span></span><span> </span><span id="local-6989586621684523745"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523745"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-513"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Bool
forall dim as. TypeBase dim as -&gt; Bool
</span><a href="Language.Futhark.Prop.html#orderZero"><span class="hs-identifier hs-var">orderZero</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523747"><span class="hs-identifier hs-var">e0</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-514"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684523743"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523743"><span class="hs-identifier hs-var">e0'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523742"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523742"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523747"><span class="hs-identifier hs-var">e0</span></a></span><span>
</span><span id="line-515"></span><span>    </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; TypeDeclBase Info VName -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
ExpBase f vn -&gt; TypeDeclBase f vn -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Ascript"><span class="hs-identifier hs-var">Ascript</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523743"><span class="hs-identifier hs-var">e0'</span></a></span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><a href="#local-6989586621684523746"><span class="hs-identifier hs-var">tydecl</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523745"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523742"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-516"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523747"><span class="hs-identifier hs-var">e0</span></a></span><span>
</span><span id="line-517"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Coerce"><span class="hs-identifier hs-type">Coerce</span></a></span><span> </span><span id="local-6989586621684523741"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523741"><span class="hs-identifier hs-var">e0</span></a></span></span><span> </span><span id="local-6989586621684523740"><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><a href="#local-6989586621684523740"><span class="hs-identifier hs-var">tydecl</span></a></span></span><span> </span><span id="local-6989586621684523739"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523739"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523738"><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523738"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-518"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Bool
forall dim as. TypeBase dim as -&gt; Bool
</span><a href="Language.Futhark.Prop.html#orderZero"><span class="hs-identifier hs-var">orderZero</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523741"><span class="hs-identifier hs-var">e0</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-519"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684523737"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523737"><span class="hs-identifier hs-var">e0'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523736"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523736"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523741"><span class="hs-identifier hs-var">e0</span></a></span><span>
</span><span id="line-520"></span><span>    </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; TypeDeclBase Info VName -&gt; SrcLoc -&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
ExpBase f vn -&gt; TypeDeclBase f vn -&gt; SrcLoc -&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Coerce"><span class="hs-identifier hs-var">Coerce</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523737"><span class="hs-identifier hs-var">e0'</span></a></span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><a href="#local-6989586621684523740"><span class="hs-identifier hs-var">tydecl</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523739"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523738"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523736"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-521"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523741"><span class="hs-identifier hs-var">e0</span></a></span><span>
</span><span id="line-522"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#LetPat"><span class="hs-identifier hs-type">LetPat</span></a></span><span> </span><span id="local-6989586621684523734"><span class="annot"><span class="annottext">[SizeBinder VName]
</span><a href="#local-6989586621684523734"><span class="hs-identifier hs-var">sizes</span></a></span></span><span> </span><span id="local-6989586621684523733"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523733"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684523732"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523732"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621684523731"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523731"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621684523730"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523730"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppRes"><span class="hs-identifier hs-type">AppRes</span></a></span><span> </span><span id="local-6989586621684523729"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523729"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684523728"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523728"><span class="hs-identifier hs-var">retext</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-523"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523727"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523727"><span class="hs-identifier hs-var">e1'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523726"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523726"><span class="hs-identifier hs-var">sv1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523732"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-524"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523725"><span class="annot"><span class="annottext">env :: Env
</span><a href="#local-6989586621684523725"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523733"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523726"><span class="hs-identifier hs-var">sv1</span></a></span><span>
</span><span id="line-525"></span><span>      </span><span id="local-6989586621684523723"><span class="annot"><span class="annottext">pat' :: PatBase Info VName
</span><a href="#local-6989586621684523723"><span class="hs-identifier hs-var hs-var">pat'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; PatBase Info VName
</span><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523733"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523726"><span class="hs-identifier hs-var">sv1</span></a></span><span>
</span><span id="line-526"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523721"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523721"><span class="hs-identifier hs-var">e2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523720"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523720"><span class="hs-identifier hs-var">sv2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env -&gt; DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall a. Env -&gt; DefM a -&gt; DefM a
</span><a href="Futhark.Internalise.Defunctionalise.html#localEnv"><span class="hs-identifier hs-var">localEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523725"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal))
-&gt; DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523731"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-527"></span><span>  </span><span class="hs-comment">-- To maintain any sizes going out of scope, we need to compute the</span><span>
</span><span id="line-528"></span><span>  </span><span class="hs-comment">-- old size substitution induced by retext and also apply it to the</span><span>
</span><span id="line-529"></span><span>  </span><span class="hs-comment">-- newly computed body type.</span><span>
</span><span id="line-530"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523717"><span class="annot"><span class="annottext">mapping :: Map VName VName
</span><a href="#local-6989586621684523717"><span class="hs-identifier hs-var hs-var">mapping</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; PatType -&gt; Map VName VName
forall a.
Monoid a =&gt;
TypeBase (DimDecl VName) a
-&gt; TypeBase (DimDecl VName) a -&gt; Map VName VName
</span><a href="Futhark.Internalise.Defunctionalise.html#dimMapping%27"><span class="hs-identifier hs-var">dimMapping'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523731"><span class="hs-identifier hs-var">e2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523729"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-531"></span><span>      </span><span id="local-6989586621684523715"><span class="annot"><span class="annottext">subst :: VName -&gt; VName
</span><a href="#local-6989586621684523715"><span class="hs-identifier hs-var hs-var">subst</span></a></span></span><span> </span><span id="local-6989586621684523714"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523714"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe VName -&gt; VName
forall a. a -&gt; Maybe a -&gt; a
</span><span class="hs-identifier hs-var">fromMaybe</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523714"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe VName -&gt; VName) -&gt; Maybe VName -&gt; VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Map VName VName -&gt; Maybe VName
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523714"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Map VName VName
</span><a href="#local-6989586621684523717"><span class="hs-identifier hs-var">mapping</span></a></span><span>
</span><span id="line-532"></span><span>      </span><span id="local-6989586621684523710"><span class="annot"><span class="annottext">t' :: PatType
</span><a href="#local-6989586621684523710"><span class="hs-identifier hs-var hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; DimDecl VName) -&gt; PatType -&gt; PatType
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; VName) -&gt; DimDecl VName -&gt; DimDecl VName
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; VName
</span><a href="#local-6989586621684523715"><span class="hs-identifier hs-var">subst</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; PatType) -&gt; PatType -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523721"><span class="hs-identifier hs-var">e2'</span></a></span><span>
</span><span id="line-533"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[SizeBinder VName]
-&gt; PatBase Info VName
-&gt; Exp
-&gt; Exp
-&gt; SrcLoc
-&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
[SizeBinder vn]
-&gt; PatBase f vn
-&gt; ExpBase f vn
-&gt; ExpBase f vn
-&gt; SrcLoc
-&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#LetPat"><span class="hs-identifier hs-var">LetPat</span></a></span><span> </span><span class="annot"><span class="annottext">[SizeBinder VName]
</span><a href="#local-6989586621684523734"><span class="hs-identifier hs-var">sizes</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523723"><span class="hs-identifier hs-var">pat'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523727"><span class="hs-identifier hs-var">e1'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523721"><span class="hs-identifier hs-var">e2'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523730"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AppRes -&gt; Info AppRes
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; [VName] -&gt; AppRes
</span><a href="Language.Futhark.Syntax.html#AppRes"><span class="hs-identifier hs-var">AppRes</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523710"><span class="hs-identifier hs-var">t'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523728"><span class="hs-identifier hs-var">retext</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523720"><span class="hs-identifier hs-var">sv2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-534"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#LetFun"><span class="hs-identifier hs-type">LetFun</span></a></span><span> </span><span id="local-6989586621684523708"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523708"><span class="hs-identifier hs-var">vn</span></a></span></span><span> </span><span class="annot"><span class="annottext">([TypeParamBase VName], [PatBase Info VName],
 Maybe (TypeExp VName), Info StructRetType, Exp)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Info AppRes
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-535"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; DefM (Exp, StaticVal)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; DefM (Exp, StaticVal))
-&gt; String -&gt; DefM (Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defuncExp: Unexpected LetFun: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
forall v. IsName v =&gt; v -&gt; String
</span><a href="Language.Futhark.Pretty.html#prettyName"><span class="hs-identifier hs-var">prettyName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523708"><span class="hs-identifier hs-var">vn</span></a></span><span>
</span><span id="line-536"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#If"><span class="hs-identifier hs-type">If</span></a></span><span> </span><span id="local-6989586621684523705"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523705"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621684523704"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523704"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621684523703"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523703"><span class="hs-identifier hs-var">e3</span></a></span></span><span> </span><span id="local-6989586621684523702"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523702"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523701"><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523701"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-537"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523700"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523700"><span class="hs-identifier hs-var">e1'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523705"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-538"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523699"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523699"><span class="hs-identifier hs-var">e2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523698"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523698"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523704"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-539"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523697"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523697"><span class="hs-identifier hs-var">e3'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523703"><span class="hs-identifier hs-var">e3</span></a></span><span>
</span><span id="line-540"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp -&gt; Exp -&gt; SrcLoc -&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
ExpBase f vn
-&gt; ExpBase f vn -&gt; ExpBase f vn -&gt; SrcLoc -&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#If"><span class="hs-identifier hs-var">If</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523700"><span class="hs-identifier hs-var">e1'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523699"><span class="hs-identifier hs-var">e2'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523697"><span class="hs-identifier hs-var">e3'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523702"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523701"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523698"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-541"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span id="local-6989586621684523696"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684523696"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621684523694"><span class="annot"><span class="annottext">f :: Exp
</span><a href="#local-6989586621684523694"><span class="hs-identifier hs-var">f</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684523693"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523693"><span class="hs-identifier hs-var">f'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523692"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523692"><span class="hs-identifier hs-var">arg</span></a></span></span><span> </span><span id="local-6989586621684523691"><span class="annot"><span class="annottext">Info (Diet, Maybe VName)
</span><a href="#local-6989586621684523691"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621684523690"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523690"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523689"><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523689"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-542"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Int
</span><a href="Language.Futhark.Core.html#baseTag"><span class="hs-identifier hs-var">baseTag</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523693"><span class="hs-identifier hs-var">f'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&lt;=</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="Language.Futhark.Prop.html#maxIntrinsicTag"><span class="hs-identifier hs-var">maxIntrinsicTag</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-543"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#TupLit"><span class="hs-identifier hs-type">TupLit</span></a></span><span> </span><span id="local-6989586621684523688"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523688"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span id="local-6989586621684523687"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523687"><span class="hs-identifier hs-var">tuploc</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523692"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-544"></span><span>    </span><span class="hs-comment">-- defuncSoacExp also works fine for non-SOACs.</span><span>
</span><span id="line-545"></span><span>    </span><span id="local-6989586621684523686"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523686"><span class="hs-identifier hs-var">es'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; DefM Exp) -&gt; [Exp] -&gt; DefM [Exp]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncSoacExp"><span class="hs-identifier hs-var">defuncSoacExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523688"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-546"></span><span>    </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-547"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
-&gt; Exp
-&gt; Info (Diet, Maybe VName)
-&gt; SrcLoc
-&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
ExpBase f vn
-&gt; ExpBase f vn
-&gt; f (Diet, Maybe VName)
-&gt; SrcLoc
-&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523694"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Exp] -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn. [ExpBase f vn] -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#TupLit"><span class="hs-identifier hs-var">TupLit</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523686"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523687"><span class="hs-identifier hs-var">tuploc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Info (Diet, Maybe VName)
</span><a href="#local-6989586621684523691"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523690"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523689"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-548"></span><span>        </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523696"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-549"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-550"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span id="local-6989586621684523684"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684523684"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">Info AppRes
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncApply"><span class="hs-identifier hs-var">defuncApply</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523684"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-551"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Negate"><span class="hs-identifier hs-type">Negate</span></a></span><span> </span><span id="local-6989586621684523681"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523681"><span class="hs-identifier hs-var">e0</span></a></span></span><span> </span><span id="local-6989586621684523680"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523680"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-552"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523679"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523679"><span class="hs-identifier hs-var">e0'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523678"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523678"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523681"><span class="hs-identifier hs-var">e0</span></a></span><span>
</span><span id="line-553"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn. ExpBase f vn -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Negate"><span class="hs-identifier hs-var">Negate</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523679"><span class="hs-identifier hs-var">e0'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523680"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523678"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-554"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Not"><span class="hs-identifier hs-type">Not</span></a></span><span> </span><span id="local-6989586621684523676"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523676"><span class="hs-identifier hs-var">e0</span></a></span></span><span> </span><span id="local-6989586621684523675"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523675"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-555"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523674"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523674"><span class="hs-identifier hs-var">e0'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523673"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523673"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523676"><span class="hs-identifier hs-var">e0</span></a></span><span>
</span><span id="line-556"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn. ExpBase f vn -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Not"><span class="hs-identifier hs-var">Not</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523674"><span class="hs-identifier hs-var">e0'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523675"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523673"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-557"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span id="local-6989586621684523672"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523672"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span id="local-6989586621684523671"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523671"><span class="hs-identifier hs-var">e0</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (TypeExp VName)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Alias
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523670"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523670"><span class="hs-identifier hs-var">ret</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523669"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523669"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-558"></span><span>  </span><span class="annot"><span class="annottext">[VName]
-&gt; [PatBase Info VName]
-&gt; Exp
-&gt; StructRetType
-&gt; SrcLoc
-&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncFun"><span class="hs-identifier hs-var">defuncFun</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523672"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523671"><span class="hs-identifier hs-var">e0</span></a></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523670"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523669"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-559"></span><span class="hs-comment">-- Operator sections are expected to be converted to lambda-expressions</span><span>
</span><span id="line-560"></span><span class="hs-comment">-- by the monomorphizer, so they should no longer occur at this point.</span><span>
</span><span id="line-561"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#OpSection"><span class="hs-identifier hs-type">OpSection</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; DefM (Exp, StaticVal)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defuncExp: unexpected operator section.&quot;</span></span><span>
</span><span id="line-562"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#OpSectionLeft"><span class="hs-identifier hs-type">OpSectionLeft</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; DefM (Exp, StaticVal)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defuncExp: unexpected operator section.&quot;</span></span><span>
</span><span id="line-563"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#OpSectionRight"><span class="hs-identifier hs-type">OpSectionRight</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; DefM (Exp, StaticVal)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defuncExp: unexpected operator section.&quot;</span></span><span>
</span><span id="line-564"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#ProjectSection"><span class="hs-identifier hs-type">ProjectSection</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; DefM (Exp, StaticVal)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defuncExp: unexpected projection section.&quot;</span></span><span>
</span><span id="line-565"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#IndexSection"><span class="hs-identifier hs-type">IndexSection</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String -&gt; DefM (Exp, StaticVal)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defuncExp: unexpected projection section.&quot;</span></span><span>
</span><span id="line-566"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DoLoop"><span class="hs-identifier hs-type">DoLoop</span></a></span><span> </span><span id="local-6989586621684523662"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523662"><span class="hs-identifier hs-var">sparams</span></a></span></span><span> </span><span id="local-6989586621684523661"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523661"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684523660"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523660"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621684523659"><span class="annot"><span class="annottext">LoopFormBase Info VName
</span><a href="#local-6989586621684523659"><span class="hs-identifier hs-var">form</span></a></span></span><span> </span><span id="local-6989586621684523658"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523658"><span class="hs-identifier hs-var">e3</span></a></span></span><span> </span><span id="local-6989586621684523657"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523657"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523656"><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523656"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-567"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523655"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523655"><span class="hs-identifier hs-var">e1'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523654"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523654"><span class="hs-identifier hs-var">sv1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523660"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-568"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523653"><span class="annot"><span class="annottext">env1 :: Env
</span><a href="#local-6989586621684523653"><span class="hs-identifier hs-var hs-var">env1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523661"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523654"><span class="hs-identifier hs-var">sv1</span></a></span><span>
</span><span id="line-569"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523652"><span class="annot"><span class="annottext">LoopFormBase Info VName
</span><a href="#local-6989586621684523652"><span class="hs-identifier hs-var">form'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523651"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523651"><span class="hs-identifier hs-var">env2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">LoopFormBase Info VName
</span><a href="#local-6989586621684523659"><span class="hs-identifier hs-var">form</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-570"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#For"><span class="hs-identifier hs-type">For</span></a></span><span> </span><span id="local-6989586621684523649"><span class="annot"><span class="annottext">IdentBase Info VName
</span><a href="#local-6989586621684523649"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span id="local-6989586621684523648"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523648"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-571"></span><span>      </span><span id="local-6989586621684523647"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523647"><span class="hs-identifier hs-var">e2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-var">defuncExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523648"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-572"></span><span>      </span><span class="annot"><span class="annottext">(LoopFormBase Info VName, Env)
-&gt; DefM (LoopFormBase Info VName, Env)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdentBase Info VName -&gt; Exp -&gt; LoopFormBase Info VName
forall (f :: * -&gt; *) vn.
IdentBase f vn -&gt; ExpBase f vn -&gt; LoopFormBase f vn
</span><a href="Language.Futhark.Syntax.html#For"><span class="hs-identifier hs-var">For</span></a></span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName
</span><a href="#local-6989586621684523649"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523647"><span class="hs-identifier hs-var">e2'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName -&gt; Env
forall {k}. IdentBase Info k -&gt; Map k Binding
</span><a href="#local-6989586621684523646"><span class="hs-identifier hs-var">envFromIdent</span></a></span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName
</span><a href="#local-6989586621684523649"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-573"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#ForIn"><span class="hs-identifier hs-type">ForIn</span></a></span><span> </span><span id="local-6989586621684523644"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523644"><span class="hs-identifier hs-var">pat2</span></a></span></span><span> </span><span id="local-6989586621684523643"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523643"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-574"></span><span>      </span><span id="local-6989586621684523642"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523642"><span class="hs-identifier hs-var">e2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-var">defuncExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523643"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-575"></span><span>      </span><span class="annot"><span class="annottext">(LoopFormBase Info VName, Env)
-&gt; DefM (LoopFormBase Info VName, Env)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Exp -&gt; LoopFormBase Info VName
forall (f :: * -&gt; *) vn.
PatBase f vn -&gt; ExpBase f vn -&gt; LoopFormBase f vn
</span><a href="Language.Futhark.Syntax.html#ForIn"><span class="hs-identifier hs-var">ForIn</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523644"><span class="hs-identifier hs-var">pat2</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523642"><span class="hs-identifier hs-var">e2'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#envFromPat"><span class="hs-identifier hs-var">envFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523644"><span class="hs-identifier hs-var">pat2</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-576"></span><span>    </span><span class="annot"><a href="Language.Futhark.Syntax.html#While"><span class="hs-identifier hs-type">While</span></a></span><span> </span><span id="local-6989586621684523639"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523639"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-577"></span><span>      </span><span id="local-6989586621684523638"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523638"><span class="hs-identifier hs-var">e2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env -&gt; DefM Exp -&gt; DefM Exp
forall a. Env -&gt; DefM a -&gt; DefM a
</span><a href="Futhark.Internalise.Defunctionalise.html#localEnv"><span class="hs-identifier hs-var">localEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523653"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">(DefM Exp -&gt; DefM Exp) -&gt; DefM Exp -&gt; DefM Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-var">defuncExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523639"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-578"></span><span>      </span><span class="annot"><span class="annottext">(LoopFormBase Info VName, Env)
-&gt; DefM (LoopFormBase Info VName, Env)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; LoopFormBase Info VName
forall (f :: * -&gt; *) vn. ExpBase f vn -&gt; LoopFormBase f vn
</span><a href="Language.Futhark.Syntax.html#While"><span class="hs-identifier hs-var">While</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523638"><span class="hs-identifier hs-var">e2'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Env
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-579"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523637"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523637"><span class="hs-identifier hs-var">e3'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523636"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523636"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env -&gt; DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall a. Env -&gt; DefM a -&gt; DefM a
</span><a href="Futhark.Internalise.Defunctionalise.html#localEnv"><span class="hs-identifier hs-var">localEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523653"><span class="hs-identifier hs-var">env1</span></a></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Env -&gt; Env
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523651"><span class="hs-identifier hs-var">env2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal))
-&gt; DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523658"><span class="hs-identifier hs-var">e3</span></a></span><span>
</span><span id="line-580"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
-&gt; PatBase Info VName
-&gt; Exp
-&gt; LoopFormBase Info VName
-&gt; Exp
-&gt; SrcLoc
-&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
[VName]
-&gt; PatBase f vn
-&gt; ExpBase f vn
-&gt; LoopFormBase f vn
-&gt; ExpBase f vn
-&gt; SrcLoc
-&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#DoLoop"><span class="hs-identifier hs-var">DoLoop</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523662"><span class="hs-identifier hs-var">sparams</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523661"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523655"><span class="hs-identifier hs-var">e1'</span></a></span><span> </span><span class="annot"><span class="annottext">LoopFormBase Info VName
</span><a href="#local-6989586621684523652"><span class="hs-identifier hs-var">form'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523637"><span class="hs-identifier hs-var">e3'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523657"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523656"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523636"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-581"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-582"></span><span>    </span><span id="local-6989586621684523646"><span class="annot"><span class="annottext">envFromIdent :: IdentBase Info k -&gt; Map k Binding
</span><a href="#local-6989586621684523646"><span class="hs-identifier hs-var hs-var">envFromIdent</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Ident"><span class="hs-identifier hs-type">Ident</span></a></span><span> </span><span id="local-6989586621684523634"><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684523634"><span class="hs-identifier hs-var">vn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684523633"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523633"><span class="hs-identifier hs-var">tp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-583"></span><span>      </span><span class="annot"><span class="annottext">k -&gt; Binding -&gt; Map k Binding
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">k
</span><a href="#local-6989586621684523634"><span class="hs-identifier hs-var">vn</span></a></span><span> </span><span class="annot"><span class="annottext">(Binding -&gt; Map k Binding) -&gt; Binding -&gt; Map k Binding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType) -&gt; StaticVal -&gt; Binding
</span><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; Binding) -&gt; StaticVal -&gt; Binding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523633"><span class="hs-identifier hs-var">tp</span></a></span><span>
</span><span id="line-584"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span id="local-6989586621684523631"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684523631"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#BinOp"><span class="hs-identifier hs-type">BinOp</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">Info AppRes
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-585"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; DefM (Exp, StaticVal)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; DefM (Exp, StaticVal))
-&gt; String -&gt; DefM (Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defuncExp: unexpected binary operator: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523631"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-586"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Project"><span class="hs-identifier hs-type">Project</span></a></span><span> </span><span id="local-6989586621684523628"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523628"><span class="hs-identifier hs-var">vn</span></a></span></span><span> </span><span id="local-6989586621684523627"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523627"><span class="hs-identifier hs-var">e0</span></a></span></span><span> </span><span id="local-6989586621684523626"><span class="annot"><span class="annottext">tp :: Info PatType
</span><a href="#local-6989586621684523626"><span class="hs-identifier hs-var">tp</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684523625"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523625"><span class="hs-identifier hs-var">tp'</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523624"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523624"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-587"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523623"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523623"><span class="hs-identifier hs-var">e0'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523622"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523622"><span class="hs-identifier hs-var">sv0</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523627"><span class="hs-identifier hs-var">e0</span></a></span><span>
</span><span id="line-588"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523622"><span class="hs-identifier hs-var">sv0</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-589"></span><span>    </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-type">RecordSV</span></a></span><span> </span><span id="local-6989586621684523621"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684523621"><span class="hs-identifier hs-var">svs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [(Name, StaticVal)] -&gt; Maybe StaticVal
forall a b. Eq a =&gt; a -&gt; [(a, b)] -&gt; Maybe b
</span><span class="hs-identifier hs-var">lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523628"><span class="hs-identifier hs-var">vn</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684523621"><span class="hs-identifier hs-var">svs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-590"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684523619"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523619"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Exp -&gt; Info PatType -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
Name -&gt; ExpBase f vn -&gt; f PatType -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Project"><span class="hs-identifier hs-var">Project</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523628"><span class="hs-identifier hs-var">vn</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523623"><span class="hs-identifier hs-var">e0'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; Info PatType) -&gt; PatType -&gt; Info PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523619"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523624"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523619"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-591"></span><span>      </span><span class="annot"><span class="annottext">Maybe StaticVal
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; DefM (Exp, StaticVal)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Invalid record projection.&quot;</span></span><span>
</span><span id="line-592"></span><span>    </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Exp -&gt; Info PatType -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
Name -&gt; ExpBase f vn -&gt; f PatType -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Project"><span class="hs-identifier hs-var">Project</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523628"><span class="hs-identifier hs-var">vn</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523623"><span class="hs-identifier hs-var">e0'</span></a></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><a href="#local-6989586621684523626"><span class="hs-identifier hs-var">tp</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523624"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523625"><span class="hs-identifier hs-var">tp'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-593"></span><span>    </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; DefM (Exp, StaticVal)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; DefM (Exp, StaticVal))
-&gt; String -&gt; DefM (Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Projection of an expression with static value &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523622"><span class="hs-identifier hs-var">sv0</span></a></span><span>
</span><span id="line-594"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#LetWith"><span class="hs-identifier hs-type">LetWith</span></a></span><span> </span><span id="local-6989586621684523616"><span class="annot"><span class="annottext">IdentBase Info VName
</span><a href="#local-6989586621684523616"><span class="hs-identifier hs-var">id1</span></a></span></span><span> </span><span id="local-6989586621684523615"><span class="annot"><span class="annottext">IdentBase Info VName
</span><a href="#local-6989586621684523615"><span class="hs-identifier hs-var">id2</span></a></span></span><span> </span><span id="local-6989586621684523614"><span class="annot"><span class="annottext">SliceBase Info VName
</span><a href="#local-6989586621684523614"><span class="hs-identifier hs-var">idxs</span></a></span></span><span> </span><span id="local-6989586621684523613"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523613"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621684523612"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523612"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span id="local-6989586621684523611"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523611"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523610"><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523610"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-595"></span><span>  </span><span id="local-6989586621684523609"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523609"><span class="hs-identifier hs-var">e1'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-var">defuncExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523613"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-596"></span><span>  </span><span id="local-6989586621684523608"><span class="annot"><span class="annottext">SliceBase Info VName
</span><a href="#local-6989586621684523608"><span class="hs-identifier hs-var">idxs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DimIndexBase Info VName -&gt; DefM (DimIndexBase Info VName))
-&gt; SliceBase Info VName -&gt; DefM (SliceBase Info VName)
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DimIndexBase Info VName -&gt; DefM (DimIndexBase Info VName)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncDimIndex"><span class="hs-identifier hs-var">defuncDimIndex</span></a></span><span> </span><span class="annot"><span class="annottext">SliceBase Info VName
</span><a href="#local-6989586621684523614"><span class="hs-identifier hs-var">idxs</span></a></span><span>
</span><span id="line-597"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523606"><span class="annot"><span class="annottext">id1_binding :: Binding
</span><a href="#local-6989586621684523606"><span class="hs-identifier hs-var hs-var">id1_binding</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType) -&gt; StaticVal -&gt; Binding
</span><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; Binding) -&gt; StaticVal -&gt; Binding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Info PatType -&gt; PatType
forall a. Info a -&gt; a
</span><a href="Language.Futhark.Syntax.html#unInfo"><span class="hs-identifier hs-var hs-var">unInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(Info PatType -&gt; PatType) -&gt; Info PatType -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName -&gt; Info PatType
forall (f :: * -&gt; *) vn. IdentBase f vn -&gt; f PatType
</span><a href="Language.Futhark.Syntax.html#identType"><span class="hs-identifier hs-var hs-var">identType</span></a></span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName
</span><a href="#local-6989586621684523616"><span class="hs-identifier hs-var">id1</span></a></span><span>
</span><span id="line-598"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523605"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523605"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523604"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523604"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-599"></span><span>    </span><span class="annot"><span class="annottext">Env -&gt; DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall a. Env -&gt; DefM a -&gt; DefM a
</span><a href="Futhark.Internalise.Defunctionalise.html#localEnv"><span class="hs-identifier hs-var">localEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Binding -&gt; Env
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdentBase Info VName -&gt; VName
forall (f :: * -&gt; *) vn. IdentBase f vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName
</span><a href="#local-6989586621684523616"><span class="hs-identifier hs-var">id1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Binding
</span><a href="#local-6989586621684523606"><span class="hs-identifier hs-var">id1_binding</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal))
-&gt; DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-600"></span><span>      </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523612"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-601"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IdentBase Info VName
-&gt; IdentBase Info VName
-&gt; SliceBase Info VName
-&gt; Exp
-&gt; Exp
-&gt; SrcLoc
-&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
IdentBase f vn
-&gt; IdentBase f vn
-&gt; SliceBase f vn
-&gt; ExpBase f vn
-&gt; ExpBase f vn
-&gt; SrcLoc
-&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#LetWith"><span class="hs-identifier hs-var">LetWith</span></a></span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName
</span><a href="#local-6989586621684523616"><span class="hs-identifier hs-var">id1</span></a></span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName
</span><a href="#local-6989586621684523615"><span class="hs-identifier hs-var">id2</span></a></span><span> </span><span class="annot"><span class="annottext">SliceBase Info VName
</span><a href="#local-6989586621684523608"><span class="hs-identifier hs-var">idxs'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523609"><span class="hs-identifier hs-var">e1'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523605"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523611"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523610"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523604"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-602"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span id="local-6989586621684523603"><span class="annot"><span class="annottext">expr :: Exp
</span><a href="#local-6989586621684523603"><span class="hs-identifier hs-var">expr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Index"><span class="hs-identifier hs-type">Index</span></a></span><span> </span><span id="local-6989586621684523601"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523601"><span class="hs-identifier hs-var">e0</span></a></span></span><span> </span><span id="local-6989586621684523600"><span class="annot"><span class="annottext">SliceBase Info VName
</span><a href="#local-6989586621684523600"><span class="hs-identifier hs-var">idxs</span></a></span></span><span> </span><span id="local-6989586621684523599"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523599"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523598"><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523598"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-603"></span><span>  </span><span id="local-6989586621684523597"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523597"><span class="hs-identifier hs-var">e0'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-var">defuncExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523601"><span class="hs-identifier hs-var">e0</span></a></span><span>
</span><span id="line-604"></span><span>  </span><span id="local-6989586621684523596"><span class="annot"><span class="annottext">SliceBase Info VName
</span><a href="#local-6989586621684523596"><span class="hs-identifier hs-var">idxs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DimIndexBase Info VName -&gt; DefM (DimIndexBase Info VName))
-&gt; SliceBase Info VName -&gt; DefM (SliceBase Info VName)
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DimIndexBase Info VName -&gt; DefM (DimIndexBase Info VName)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncDimIndex"><span class="hs-identifier hs-var">defuncDimIndex</span></a></span><span> </span><span class="annot"><span class="annottext">SliceBase Info VName
</span><a href="#local-6989586621684523600"><span class="hs-identifier hs-var">idxs</span></a></span><span>
</span><span id="line-605"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-606"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; SliceBase Info VName -&gt; SrcLoc -&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
ExpBase f vn -&gt; SliceBase f vn -&gt; SrcLoc -&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Index"><span class="hs-identifier hs-var">Index</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523597"><span class="hs-identifier hs-var">e0'</span></a></span><span> </span><span class="annot"><span class="annottext">SliceBase Info VName
</span><a href="#local-6989586621684523596"><span class="hs-identifier hs-var">idxs'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523599"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523598"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-607"></span><span>      </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523603"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-608"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Update"><span class="hs-identifier hs-type">Update</span></a></span><span> </span><span id="local-6989586621684523594"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523594"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621684523593"><span class="annot"><span class="annottext">SliceBase Info VName
</span><a href="#local-6989586621684523593"><span class="hs-identifier hs-var">idxs</span></a></span></span><span> </span><span id="local-6989586621684523592"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523592"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621684523591"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523591"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-610"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523590"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523590"><span class="hs-identifier hs-var">e1'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523589"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523589"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523594"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-611"></span><span>  </span><span id="local-6989586621684523588"><span class="annot"><span class="annottext">SliceBase Info VName
</span><a href="#local-6989586621684523588"><span class="hs-identifier hs-var">idxs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(DimIndexBase Info VName -&gt; DefM (DimIndexBase Info VName))
-&gt; SliceBase Info VName -&gt; DefM (SliceBase Info VName)
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">DimIndexBase Info VName -&gt; DefM (DimIndexBase Info VName)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncDimIndex"><span class="hs-identifier hs-var">defuncDimIndex</span></a></span><span> </span><span class="annot"><span class="annottext">SliceBase Info VName
</span><a href="#local-6989586621684523593"><span class="hs-identifier hs-var">idxs</span></a></span><span>
</span><span id="line-612"></span><span>  </span><span id="local-6989586621684523587"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523587"><span class="hs-identifier hs-var">e2'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-var">defuncExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523592"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-613"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; SliceBase Info VName -&gt; Exp -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
ExpBase f vn
-&gt; SliceBase f vn -&gt; ExpBase f vn -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Update"><span class="hs-identifier hs-var">Update</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523590"><span class="hs-identifier hs-var">e1'</span></a></span><span> </span><span class="annot"><span class="annottext">SliceBase Info VName
</span><a href="#local-6989586621684523588"><span class="hs-identifier hs-var">idxs'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523587"><span class="hs-identifier hs-var">e2'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523591"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523589"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-614"></span><span>
</span><span id="line-615"></span><span class="hs-comment">-- Note that we might change the type of the record field here.  This</span><span>
</span><span id="line-616"></span><span class="hs-comment">-- is not permitted in the type checker due to problems with type</span><span>
</span><span id="line-617"></span><span class="hs-comment">-- inference, but it actually works fine.</span><span>
</span><span id="line-618"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RecordUpdate"><span class="hs-identifier hs-type">RecordUpdate</span></a></span><span> </span><span id="local-6989586621684523585"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523585"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621684523584"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684523584"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span id="local-6989586621684523583"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523583"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523582"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523582"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-619"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523581"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523581"><span class="hs-identifier hs-var">e1'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523580"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523580"><span class="hs-identifier hs-var">sv1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523585"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-620"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523579"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523579"><span class="hs-identifier hs-var">e2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523578"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523578"><span class="hs-identifier hs-var">sv2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523583"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-621"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523577"><span class="annot"><span class="annottext">sv :: StaticVal
</span><a href="#local-6989586621684523577"><span class="hs-identifier hs-var hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; StaticVal -&gt; [Name] -&gt; StaticVal
</span><a href="#local-6989586621684523576"><span class="hs-identifier hs-var">staticField</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523580"><span class="hs-identifier hs-var">sv1</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523578"><span class="hs-identifier hs-var">sv2</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684523584"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-622"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-623"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; [Name] -&gt; Exp -&gt; Info PatType -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
ExpBase f vn
-&gt; [Name] -&gt; ExpBase f vn -&gt; f PatType -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#RecordUpdate"><span class="hs-identifier hs-var">RecordUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523581"><span class="hs-identifier hs-var">e1'</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684523584"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523579"><span class="hs-identifier hs-var">e2'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; Info PatType) -&gt; PatType -&gt; Info PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523580"><span class="hs-identifier hs-var">sv1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523582"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-624"></span><span>      </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523577"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-625"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-626"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-627"></span><span>    </span><span id="local-6989586621684523576"><span class="annot"><span class="annottext">staticField :: StaticVal -&gt; StaticVal -&gt; [Name] -&gt; StaticVal
</span><a href="#local-6989586621684523576"><span class="hs-identifier hs-var hs-var">staticField</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-type">RecordSV</span></a></span><span> </span><span id="local-6989586621684523571"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684523571"><span class="hs-identifier hs-var">svs</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523570"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523570"><span class="hs-identifier hs-var">sv2</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523569"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523569"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684523568"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684523568"><span class="hs-identifier hs-var">fs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-628"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [(Name, StaticVal)] -&gt; Maybe StaticVal
forall a b. Eq a =&gt; a -&gt; [(a, b)] -&gt; Maybe b
</span><span class="hs-identifier hs-var">lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523569"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684523571"><span class="hs-identifier hs-var">svs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-629"></span><span>        </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684523567"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523567"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-630"></span><span>          </span><span class="annot"><span class="annottext">[(Name, StaticVal)] -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-var">RecordSV</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, StaticVal)] -&gt; StaticVal)
-&gt; [(Name, StaticVal)] -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-631"></span><span>            </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523569"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; StaticVal -&gt; [Name] -&gt; StaticVal
</span><a href="#local-6989586621684523576"><span class="hs-identifier hs-var">staticField</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523567"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523570"><span class="hs-identifier hs-var">sv2</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684523568"><span class="hs-identifier hs-var">fs'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name, StaticVal) -&gt; [(Name, StaticVal)] -&gt; [(Name, StaticVal)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">((Name, StaticVal) -&gt; Bool)
-&gt; [(Name, StaticVal)] -&gt; [(Name, StaticVal)]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">/=</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523569"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Bool)
-&gt; ((Name, StaticVal) -&gt; Name) -&gt; (Name, StaticVal) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, StaticVal) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684523571"><span class="hs-identifier hs-var">svs</span></a></span><span>
</span><span id="line-632"></span><span>        </span><span class="annot"><span class="annottext">Maybe StaticVal
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; StaticVal
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Invalid record projection.&quot;</span></span><span>
</span><span id="line-633"></span><span>    </span><span class="annot"><a href="#local-6989586621684523576"><span class="hs-identifier hs-var">staticField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a></span><span> </span><span id="local-6989586621684523565"><span class="annot"><span class="annottext">t :: PatType
</span><a href="#local-6989586621684523565"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523564"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523564"><span class="hs-identifier hs-var">sv2</span></a></span></span><span> </span><span id="local-6989586621684523563"><span class="annot"><span class="annottext">fs' :: [Name]
</span><a href="#local-6989586621684523563"><span class="hs-identifier hs-var">fs'</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-634"></span><span>      </span><span class="annot"><span class="annottext">StaticVal -&gt; StaticVal -&gt; [Name] -&gt; StaticVal
</span><a href="#local-6989586621684523576"><span class="hs-identifier hs-var">staticField</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#svFromType"><span class="hs-identifier hs-var">svFromType</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523565"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523564"><span class="hs-identifier hs-var">sv2</span></a></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621684523563"><span class="hs-identifier hs-var">fs'</span></a></span><span>
</span><span id="line-635"></span><span>    </span><span class="annot"><a href="#local-6989586621684523576"><span class="hs-identifier hs-var">staticField</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523561"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523561"><span class="hs-identifier hs-var">sv2</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523561"><span class="hs-identifier hs-var">sv2</span></a></span><span>
</span><span id="line-636"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Assert"><span class="hs-identifier hs-type">Assert</span></a></span><span> </span><span id="local-6989586621684523559"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523559"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621684523558"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523558"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621684523557"><span class="annot"><span class="annottext">Info String
</span><a href="#local-6989586621684523557"><span class="hs-identifier hs-var">desc</span></a></span></span><span> </span><span id="local-6989586621684523556"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523556"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-637"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523555"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523555"><span class="hs-identifier hs-var">e1'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523559"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-638"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523554"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523554"><span class="hs-identifier hs-var">e2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523553"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523553"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523558"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-639"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; Exp -&gt; Info String -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
ExpBase f vn -&gt; ExpBase f vn -&gt; f String -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Assert"><span class="hs-identifier hs-var">Assert</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523555"><span class="hs-identifier hs-var">e1'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523554"><span class="hs-identifier hs-var">e2'</span></a></span><span> </span><span class="annot"><span class="annottext">Info String
</span><a href="#local-6989586621684523557"><span class="hs-identifier hs-var">desc</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523556"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523553"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-640"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Constr"><span class="hs-identifier hs-type">Constr</span></a></span><span> </span><span id="local-6989586621684523551"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523551"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684523550"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523550"><span class="hs-identifier hs-var">es</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span id="local-6989586621684523549"><span class="annot"><span class="annottext">Map Name [PatType]
</span><a href="#local-6989586621684523549"><span class="hs-identifier hs-var">all_fs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523548"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523548"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-641"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523547"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523547"><span class="hs-identifier hs-var">es'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523546"><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684523546"><span class="hs-identifier hs-var">svs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[(Exp, StaticVal)] -&gt; ([Exp], [StaticVal])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">([(Exp, StaticVal)] -&gt; ([Exp], [StaticVal]))
-&gt; DefM [(Exp, StaticVal)] -&gt; DefM ([Exp], [StaticVal])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; DefM (Exp, StaticVal)) -&gt; [Exp] -&gt; DefM [(Exp, StaticVal)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523550"><span class="hs-identifier hs-var">es</span></a></span><span>
</span><span id="line-642"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523542"><span class="annot"><span class="annottext">sv :: StaticVal
</span><a href="#local-6989586621684523542"><span class="hs-identifier hs-var hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-643"></span><span>        </span><span class="annot"><span class="annottext">Name -&gt; [StaticVal] -&gt; [(Name, [PatType])] -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#SumSV"><span class="hs-identifier hs-var">SumSV</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523551"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684523546"><span class="hs-identifier hs-var">svs</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, [PatType])] -&gt; StaticVal)
-&gt; [(Name, [PatType])] -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-644"></span><span>          </span><span class="annot"><span class="annottext">Map Name [PatType] -&gt; [(Name, [PatType])]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">(Map Name [PatType] -&gt; [(Name, [PatType])])
-&gt; Map Name [PatType] -&gt; [(Name, [PatType])]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-645"></span><span>            </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523551"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Map Name [PatType] -&gt; Map Name [PatType]
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Map k a
</span><span class="hs-operator hs-var">`M.delete`</span></span><span> </span><span class="annot"><span class="annottext">([PatType] -&gt; [PatType])
-&gt; Map Name [PatType] -&gt; Map Name [PatType]
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatType -&gt; PatType) -&gt; [PatType] -&gt; [PatType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; PatType
forall als.
Monoid als =&gt;
TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="#local-6989586621684523541"><span class="hs-identifier hs-var">defuncType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name [PatType]
</span><a href="#local-6989586621684523549"><span class="hs-identifier hs-var">all_fs</span></a></span><span>
</span><span id="line-646"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name -&gt; [Exp] -&gt; Info PatType -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
Name -&gt; [ExpBase f vn] -&gt; f PatType -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Constr"><span class="hs-identifier hs-var">Constr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523551"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523547"><span class="hs-identifier hs-var">es'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523542"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523548"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523542"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-647"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-648"></span><span>    </span><span id="local-6989586621684525173"><span class="annot"><a href="#local-6989586621684523541"><span class="hs-identifier hs-type">defuncType</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-649"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621684525173"><span class="hs-identifier hs-type">als</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-650"></span><span>      </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684525173"><span class="hs-identifier hs-type">als</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-651"></span><span>      </span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeBase"><span class="hs-identifier hs-type">TypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684525173"><span class="hs-identifier hs-type">als</span></a></span></span><span>
</span><span id="line-652"></span><span>    </span><span id="local-6989586621684523541"><span class="annot"><span class="annottext">defuncType :: forall als.
Monoid als =&gt;
TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="#local-6989586621684523541"><span class="hs-identifier hs-var hs-var">defuncType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span id="local-6989586621684523537"><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684523537"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621684523536"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684523536"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621684523535"><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684523535"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621684523534"><span class="annot"><span class="annottext">ShapeDecl (DimDecl VName)
</span><a href="#local-6989586621684523534"><span class="hs-identifier hs-var">shape</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">als
-&gt; Uniqueness
-&gt; ScalarTypeBase (DimDecl VName) ()
-&gt; ShapeDecl (DimDecl VName)
-&gt; TypeBase (DimDecl VName) als
forall dim as.
as
-&gt; Uniqueness
-&gt; ScalarTypeBase dim ()
-&gt; ShapeDecl dim
-&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Array"><span class="hs-identifier hs-var">Array</span></a></span><span> </span><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684523537"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684523536"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) ()
-&gt; ScalarTypeBase (DimDecl VName) ()
forall als.
Monoid als =&gt;
ScalarTypeBase (DimDecl VName) als
-&gt; ScalarTypeBase (DimDecl VName) als
</span><a href="#local-6989586621684523533"><span class="hs-identifier hs-var">defuncScalar</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) ()
</span><a href="#local-6989586621684523535"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ShapeDecl (DimDecl VName)
</span><a href="#local-6989586621684523534"><span class="hs-identifier hs-var">shape</span></a></span><span>
</span><span id="line-653"></span><span>    </span><span class="annot"><a href="#local-6989586621684523541"><span class="hs-identifier hs-var">defuncType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span id="local-6989586621684523532"><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) als
</span><a href="#local-6989586621684523532"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) als
 -&gt; TypeBase (DimDecl VName) als)
-&gt; ScalarTypeBase (DimDecl VName) als
-&gt; TypeBase (DimDecl VName) als
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) als
-&gt; ScalarTypeBase (DimDecl VName) als
forall als.
Monoid als =&gt;
ScalarTypeBase (DimDecl VName) als
-&gt; ScalarTypeBase (DimDecl VName) als
</span><a href="#local-6989586621684523533"><span class="hs-identifier hs-var">defuncScalar</span></a></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) als
</span><a href="#local-6989586621684523532"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-654"></span><span>
</span><span id="line-655"></span><span>    </span><span id="local-6989586621684525171"><span class="annot"><a href="#local-6989586621684523533"><span class="hs-identifier hs-type">defuncScalar</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-656"></span><span>      </span><span class="annot"><span class="hs-identifier hs-type">Monoid</span></span><span> </span><span class="annot"><a href="#local-6989586621684525171"><span class="hs-identifier hs-type">als</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-657"></span><span>      </span><span class="annot"><a href="Language.Futhark.Syntax.html#ScalarTypeBase"><span class="hs-identifier hs-type">ScalarTypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684525171"><span class="hs-identifier hs-type">als</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-658"></span><span>      </span><span class="annot"><a href="Language.Futhark.Syntax.html#ScalarTypeBase"><span class="hs-identifier hs-type">ScalarTypeBase</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimDecl"><span class="hs-identifier hs-type">DimDecl</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621684525171"><span class="hs-identifier hs-type">als</span></a></span></span><span>
</span><span id="line-659"></span><span>    </span><span id="local-6989586621684523533"><span class="annot"><span class="annottext">defuncScalar :: forall als.
Monoid als =&gt;
ScalarTypeBase (DimDecl VName) als
-&gt; ScalarTypeBase (DimDecl VName) als
</span><a href="#local-6989586621684523533"><span class="hs-identifier hs-var hs-var">defuncScalar</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684523527"><span class="annot"><span class="annottext">Map Name (TypeBase (DimDecl VName) als)
</span><a href="#local-6989586621684523527"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase (DimDecl VName) als)
-&gt; ScalarTypeBase (DimDecl VName) als
forall dim as. Map Name (TypeBase dim as) -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-var">Record</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name (TypeBase (DimDecl VName) als)
 -&gt; ScalarTypeBase (DimDecl VName) als)
-&gt; Map Name (TypeBase (DimDecl VName) als)
-&gt; ScalarTypeBase (DimDecl VName) als
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als)
-&gt; Map Name (TypeBase (DimDecl VName) als)
-&gt; Map Name (TypeBase (DimDecl VName) als)
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
forall als.
Monoid als =&gt;
TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="#local-6989586621684523541"><span class="hs-identifier hs-var">defuncType</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase (DimDecl VName) als)
</span><a href="#local-6989586621684523527"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-660"></span><span>    </span><span class="annot"><a href="#local-6989586621684523533"><span class="hs-identifier hs-var">defuncScalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase (DimDecl VName) als)
-&gt; ScalarTypeBase (DimDecl VName) als
forall dim as. Map Name (TypeBase dim as) -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-var">Record</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase (DimDecl VName) als)
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-661"></span><span>    </span><span class="annot"><a href="#local-6989586621684523533"><span class="hs-identifier hs-var">defuncScalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span id="local-6989586621684523526"><span class="annot"><span class="annottext">Map Name [TypeBase (DimDecl VName) als]
</span><a href="#local-6989586621684523526"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase (DimDecl VName) als]
-&gt; ScalarTypeBase (DimDecl VName) als
forall dim as. Map Name [TypeBase dim as] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-var">Sum</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name [TypeBase (DimDecl VName) als]
 -&gt; ScalarTypeBase (DimDecl VName) als)
-&gt; Map Name [TypeBase (DimDecl VName) als]
-&gt; ScalarTypeBase (DimDecl VName) als
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([TypeBase (DimDecl VName) als] -&gt; [TypeBase (DimDecl VName) als])
-&gt; Map Name [TypeBase (DimDecl VName) als]
-&gt; Map Name [TypeBase (DimDecl VName) als]
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als)
-&gt; [TypeBase (DimDecl VName) als] -&gt; [TypeBase (DimDecl VName) als]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
forall als.
Monoid als =&gt;
TypeBase (DimDecl VName) als -&gt; TypeBase (DimDecl VName) als
</span><a href="#local-6989586621684523541"><span class="hs-identifier hs-var">defuncType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase (DimDecl VName) als]
</span><a href="#local-6989586621684523526"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-662"></span><span>    </span><span class="annot"><a href="#local-6989586621684523533"><span class="hs-identifier hs-var">defuncScalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-type">Prim</span></a></span><span> </span><span id="local-6989586621684523525"><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684523525"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase (DimDecl VName) als
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">PrimType
</span><a href="#local-6989586621684523525"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-663"></span><span>    </span><span class="annot"><a href="#local-6989586621684523533"><span class="hs-identifier hs-var">defuncScalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-type">TypeVar</span></a></span><span> </span><span id="local-6989586621684523524"><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684523524"><span class="hs-keyword hs-var">as</span></a></span></span><span> </span><span id="local-6989586621684523523"><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684523523"><span class="hs-identifier hs-var">u</span></a></span></span><span> </span><span id="local-6989586621684523522"><span class="annot"><span class="annottext">TypeName
</span><a href="#local-6989586621684523522"><span class="hs-identifier hs-var">tn</span></a></span></span><span> </span><span id="local-6989586621684523521"><span class="annot"><span class="annottext">[TypeArg (DimDecl VName)]
</span><a href="#local-6989586621684523521"><span class="hs-identifier hs-var">targs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">als
-&gt; Uniqueness
-&gt; TypeName
-&gt; [TypeArg (DimDecl VName)]
-&gt; ScalarTypeBase (DimDecl VName) als
forall dim as.
as
-&gt; Uniqueness -&gt; TypeName -&gt; [TypeArg dim] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#TypeVar"><span class="hs-identifier hs-var">TypeVar</span></a></span><span> </span><span class="annot"><span class="annottext">als
</span><a href="#local-6989586621684523524"><span class="hs-keyword hs-var">as</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="#local-6989586621684523523"><span class="hs-identifier hs-var">u</span></a></span><span> </span><span class="annot"><span class="annottext">TypeName
</span><a href="#local-6989586621684523522"><span class="hs-identifier hs-var">tn</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeArg (DimDecl VName)]
</span><a href="#local-6989586621684523521"><span class="hs-identifier hs-var">targs</span></a></span><span>
</span><span id="line-664"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Constr"><span class="hs-identifier hs-type">Constr</span></a></span><span> </span><span id="local-6989586621684523520"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523520"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684523519"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523519"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523518"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523518"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-665"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; DefM (Exp, StaticVal)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; DefM (Exp, StaticVal))
-&gt; String -&gt; DefM (Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-666"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Constructor &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523520"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; given type &quot;</span></span><span>
</span><span id="line-667"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523519"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-668"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; at &quot;</span></span><span>
</span><span id="line-669"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; String
forall a. Located a =&gt; a -&gt; String
</span><a href="Language.Futhark.Core.html#locStr"><span class="hs-identifier hs-var">locStr</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523518"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-670"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Match"><span class="hs-identifier hs-type">Match</span></a></span><span> </span><span id="local-6989586621684523515"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523515"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684523514"><span class="annot"><span class="annottext">NonEmpty (CaseBase Info VName)
</span><a href="#local-6989586621684523514"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span id="local-6989586621684523513"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523513"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523512"><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523512"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-671"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523511"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523511"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523510"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523510"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523515"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-672"></span><span>  </span><span id="local-6989586621684523509"><span class="annot"><span class="annottext">NonEmpty (CaseBase Info VName, StaticVal)
</span><a href="#local-6989586621684523509"><span class="hs-identifier hs-var">csPairs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(CaseBase Info VName -&gt; DefM (CaseBase Info VName, StaticVal))
-&gt; NonEmpty (CaseBase Info VName)
-&gt; DefM (NonEmpty (CaseBase Info VName, StaticVal))
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticVal
-&gt; CaseBase Info VName -&gt; DefM (CaseBase Info VName, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncCase"><span class="hs-identifier hs-var">defuncCase</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523510"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">NonEmpty (CaseBase Info VName)
</span><a href="#local-6989586621684523514"><span class="hs-identifier hs-var">cs</span></a></span><span>
</span><span id="line-673"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523505"><span class="annot"><span class="annottext">cs' :: NonEmpty (CaseBase Info VName)
</span><a href="#local-6989586621684523505"><span class="hs-identifier hs-var hs-var">cs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((CaseBase Info VName, StaticVal) -&gt; CaseBase Info VName)
-&gt; NonEmpty (CaseBase Info VName, StaticVal)
-&gt; NonEmpty (CaseBase Info VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(CaseBase Info VName, StaticVal) -&gt; CaseBase Info VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (CaseBase Info VName, StaticVal)
</span><a href="#local-6989586621684523509"><span class="hs-identifier hs-var">csPairs</span></a></span><span>
</span><span id="line-674"></span><span>      </span><span id="local-6989586621684523504"><span class="annot"><span class="annottext">sv' :: StaticVal
</span><a href="#local-6989586621684523504"><span class="hs-identifier hs-var hs-var">sv'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CaseBase Info VName, StaticVal) -&gt; StaticVal
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">((CaseBase Info VName, StaticVal) -&gt; StaticVal)
-&gt; (CaseBase Info VName, StaticVal) -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (CaseBase Info VName, StaticVal)
-&gt; (CaseBase Info VName, StaticVal)
forall a. NonEmpty a -&gt; a
</span><span class="hs-identifier hs-var">NE.head</span></span><span> </span><span class="annot"><span class="annottext">NonEmpty (CaseBase Info VName, StaticVal)
</span><a href="#local-6989586621684523509"><span class="hs-identifier hs-var">csPairs</span></a></span><span>
</span><span id="line-675"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
-&gt; NonEmpty (CaseBase Info VName)
-&gt; SrcLoc
-&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
ExpBase f vn
-&gt; NonEmpty (CaseBase f vn) -&gt; SrcLoc -&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Match"><span class="hs-identifier hs-var">Match</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523511"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">NonEmpty (CaseBase Info VName)
</span><a href="#local-6989586621684523505"><span class="hs-identifier hs-var">cs'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523513"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523512"><span class="hs-identifier hs-var">res</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523504"><span class="hs-identifier hs-var">sv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-676"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Attr"><span class="hs-identifier hs-type">Attr</span></a></span><span> </span><span id="local-6989586621684523501"><span class="annot"><span class="annottext">AttrInfo VName
</span><a href="#local-6989586621684523501"><span class="hs-identifier hs-var">info</span></a></span></span><span> </span><span id="local-6989586621684523500"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523500"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684523499"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523499"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-677"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523498"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523498"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523497"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523497"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523500"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-678"></span><span>  </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AttrInfo VName -&gt; Exp -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
AttrInfo vn -&gt; ExpBase f vn -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Attr"><span class="hs-identifier hs-var">Attr</span></a></span><span> </span><span class="annot"><span class="annottext">AttrInfo VName
</span><a href="#local-6989586621684523501"><span class="hs-identifier hs-var">info</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523498"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523499"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523497"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-679"></span><span>
</span><span id="line-680"></span><span class="hs-comment">-- | Same as 'defuncExp', except it ignores the static value.</span><span>
</span><span id="line-681"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-type">defuncExp'</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span>
</span><span id="line-682"></span><span id="defuncExp%27"><span class="annot"><span class="annottext">defuncExp' :: Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-var hs-var">defuncExp'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Exp, StaticVal) -&gt; Exp) -&gt; DefM (Exp, StaticVal) -&gt; DefM Exp
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; Exp
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">(DefM (Exp, StaticVal) -&gt; DefM Exp)
-&gt; (Exp -&gt; DefM (Exp, StaticVal)) -&gt; Exp -&gt; DefM Exp
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span>
</span><span id="line-683"></span><span>
</span><span id="line-684"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExtExp"><span class="hs-identifier hs-type">defuncExtExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#ExtExp"><span class="hs-identifier hs-type">ExtExp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-685"></span><span id="defuncExtExp"><span class="annot"><span class="annottext">defuncExtExp :: ExtExp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExtExp"><span class="hs-identifier hs-var hs-var">defuncExtExp</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#ExtExp"><span class="hs-identifier hs-type">ExtExp</span></a></span><span> </span><span id="local-6989586621684523495"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523495"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523495"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-686"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncExtExp"><span class="hs-identifier hs-var">defuncExtExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#ExtLambda"><span class="hs-identifier hs-type">ExtLambda</span></a></span><span> </span><span id="local-6989586621684523494"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523494"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span id="local-6989586621684523493"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523493"><span class="hs-identifier hs-var">e0</span></a></span></span><span> </span><span id="local-6989586621684523492"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523492"><span class="hs-identifier hs-var">ret</span></a></span></span><span> </span><span id="local-6989586621684523491"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523491"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-687"></span><span>  </span><span class="annot"><span class="annottext">[VName]
-&gt; [PatBase Info VName]
-&gt; Exp
-&gt; StructRetType
-&gt; SrcLoc
-&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncFun"><span class="hs-identifier hs-var">defuncFun</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523494"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523493"><span class="hs-identifier hs-var">e0</span></a></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523492"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523491"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-688"></span><span>
</span><span id="line-689"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncCase"><span class="hs-identifier hs-type">defuncCase</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.html#Case"><span class="hs-identifier hs-type">Case</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-690"></span><span id="defuncCase"><span class="annot"><span class="annottext">defuncCase :: StaticVal
-&gt; CaseBase Info VName -&gt; DefM (CaseBase Info VName, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncCase"><span class="hs-identifier hs-var hs-var">defuncCase</span></a></span></span><span> </span><span id="local-6989586621684523489"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523489"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#CasePat"><span class="hs-identifier hs-type">CasePat</span></a></span><span> </span><span id="local-6989586621684523487"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523487"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684523486"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523486"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684523485"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523485"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-691"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523484"><span class="annot"><span class="annottext">p' :: PatBase Info VName
</span><a href="#local-6989586621684523484"><span class="hs-identifier hs-var hs-var">p'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; PatBase Info VName
</span><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523487"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523489"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-692"></span><span>      </span><span id="local-6989586621684523483"><span class="annot"><span class="annottext">env :: Env
</span><a href="#local-6989586621684523483"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523487"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523489"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-693"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523482"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523482"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523481"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523481"><span class="hs-identifier hs-var">sv'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env -&gt; DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall a. Env -&gt; DefM a -&gt; DefM a
</span><a href="Futhark.Internalise.Defunctionalise.html#localEnv"><span class="hs-identifier hs-var">localEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523483"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal))
-&gt; DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523486"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-694"></span><span>  </span><span class="annot"><span class="annottext">(CaseBase Info VName, StaticVal)
-&gt; DefM (CaseBase Info VName, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Exp -&gt; SrcLoc -&gt; CaseBase Info VName
forall (f :: * -&gt; *) vn.
PatBase f vn -&gt; ExpBase f vn -&gt; SrcLoc -&gt; CaseBase f vn
</span><a href="Language.Futhark.Syntax.html#CasePat"><span class="hs-identifier hs-var">CasePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523484"><span class="hs-identifier hs-var">p'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523482"><span class="hs-identifier hs-var">e'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523485"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523481"><span class="hs-identifier hs-var">sv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-695"></span><span>
</span><span id="line-696"></span><span class="hs-comment">-- | Defunctionalize the function argument to a SOAC by eta-expanding if</span><span>
</span><span id="line-697"></span><span class="hs-comment">-- necessary and then defunctionalizing the body of the introduced lambda.</span><span>
</span><span id="line-698"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncSoacExp"><span class="hs-identifier hs-type">defuncSoacExp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span>
</span><span id="line-699"></span><span id="defuncSoacExp"><span class="annot"><span class="annottext">defuncSoacExp :: Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncSoacExp"><span class="hs-identifier hs-var hs-var">defuncSoacExp</span></a></span></span><span> </span><span id="local-6989586621684523480"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684523480"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Language.Futhark.Syntax.html#OpSection"><span class="hs-identifier hs-type">OpSection</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523480"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-700"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncSoacExp"><span class="hs-identifier hs-var">defuncSoacExp</span></a></span><span> </span><span id="local-6989586621684523479"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684523479"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Language.Futhark.Syntax.html#OpSectionLeft"><span class="hs-identifier hs-type">OpSectionLeft</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523479"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-701"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncSoacExp"><span class="hs-identifier hs-var">defuncSoacExp</span></a></span><span> </span><span id="local-6989586621684523478"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684523478"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Language.Futhark.Syntax.html#OpSectionRight"><span class="hs-identifier hs-type">OpSectionRight</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523478"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-702"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncSoacExp"><span class="hs-identifier hs-var">defuncSoacExp</span></a></span><span> </span><span id="local-6989586621684523477"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684523477"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Language.Futhark.Syntax.html#ProjectSection"><span class="hs-identifier hs-type">ProjectSection</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523477"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-703"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncSoacExp"><span class="hs-identifier hs-var">defuncSoacExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Parens"><span class="hs-identifier hs-type">Parens</span></a></span><span> </span><span id="local-6989586621684523476"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523476"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span id="local-6989586621684523475"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523475"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-704"></span><span>  </span><span class="annot"><span class="annottext">Exp -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn. ExpBase f vn -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Parens"><span class="hs-identifier hs-var">Parens</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; SrcLoc -&gt; Exp) -&gt; DefM Exp -&gt; DefM (SrcLoc -&gt; Exp)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncSoacExp"><span class="hs-identifier hs-var">defuncSoacExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523476"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="annot"><span class="annottext">DefM (SrcLoc -&gt; Exp) -&gt; DefM SrcLoc -&gt; DefM Exp
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc -&gt; DefM SrcLoc
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523475"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-705"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncSoacExp"><span class="hs-identifier hs-var">defuncSoacExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Lambda"><span class="hs-identifier hs-type">Lambda</span></a></span><span> </span><span id="local-6989586621684523474"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523474"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684523473"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523473"><span class="hs-identifier hs-var">e0</span></a></span></span><span> </span><span id="local-6989586621684523472"><span class="annot"><span class="annottext">Maybe (TypeExp VName)
</span><a href="#local-6989586621684523472"><span class="hs-identifier hs-var">decl</span></a></span></span><span> </span><span id="local-6989586621684523471"><span class="annot"><span class="annottext">Info (Set Alias, StructRetType)
</span><a href="#local-6989586621684523471"><span class="hs-identifier hs-var">tp</span></a></span></span><span> </span><span id="local-6989586621684523470"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523470"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-706"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523466"><span class="annot"><span class="annottext">env :: Env
</span><a href="#local-6989586621684523466"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; Env) -&gt; [PatBase Info VName] -&gt; Env
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#envFromPat"><span class="hs-identifier hs-var">envFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523474"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-707"></span><span>  </span><span id="local-6989586621684523465"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523465"><span class="hs-identifier hs-var">e0'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env -&gt; DefM Exp -&gt; DefM Exp
forall a. Env -&gt; DefM a -&gt; DefM a
</span><a href="Futhark.Internalise.Defunctionalise.html#localEnv"><span class="hs-identifier hs-var">localEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523466"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(DefM Exp -&gt; DefM Exp) -&gt; DefM Exp -&gt; DefM Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncSoacExp"><span class="hs-identifier hs-var">defuncSoacExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523473"><span class="hs-identifier hs-var">e0</span></a></span><span>
</span><span id="line-708"></span><span>  </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; DefM Exp) -&gt; Exp -&gt; DefM Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
-&gt; Exp
-&gt; Maybe (TypeExp VName)
-&gt; Info (Set Alias, StructRetType)
-&gt; SrcLoc
-&gt; Exp
forall (f :: * -&gt; *) vn.
[PatBase f vn]
-&gt; ExpBase f vn
-&gt; Maybe (TypeExp vn)
-&gt; f (Set Alias, StructRetType)
-&gt; SrcLoc
-&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523474"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523465"><span class="hs-identifier hs-var">e0'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TypeExp VName)
</span><a href="#local-6989586621684523472"><span class="hs-identifier hs-var">decl</span></a></span><span> </span><span class="annot"><span class="annottext">Info (Set Alias, StructRetType)
</span><a href="#local-6989586621684523471"><span class="hs-identifier hs-var">tp</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523470"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-709"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncSoacExp"><span class="hs-identifier hs-var">defuncSoacExp</span></a></span><span> </span><span id="local-6989586621684523464"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523464"><span class="hs-identifier hs-var">e</span></a></span></span><span>
</span><span id="line-710"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523464"><span class="hs-identifier hs-var">e</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-711"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684523463"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523463"><span class="hs-identifier hs-var">pats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523462"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523462"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523461"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523461"><span class="hs-identifier hs-var">tp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Exp -&gt; DefM ([PatBase Info VName], Exp, StructRetType)
</span><a href="Futhark.Internalise.Defunctionalise.html#etaExpand"><span class="hs-identifier hs-var">etaExpand</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523464"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523464"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-712"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523457"><span class="annot"><span class="annottext">env :: Env
</span><a href="#local-6989586621684523457"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; Env) -&gt; [PatBase Info VName] -&gt; Env
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#envFromPat"><span class="hs-identifier hs-var">envFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523463"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-713"></span><span>    </span><span id="local-6989586621684523456"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523456"><span class="hs-identifier hs-var">body'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Env -&gt; DefM Exp -&gt; DefM Exp
forall a. Env -&gt; DefM a -&gt; DefM a
</span><a href="Futhark.Internalise.Defunctionalise.html#localEnv"><span class="hs-identifier hs-var">localEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523457"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(DefM Exp -&gt; DefM Exp) -&gt; DefM Exp -&gt; DefM Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-var">defuncExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523462"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-714"></span><span>    </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; DefM Exp) -&gt; Exp -&gt; DefM Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
-&gt; Exp
-&gt; Maybe (TypeExp VName)
-&gt; Info (Set Alias, StructRetType)
-&gt; SrcLoc
-&gt; Exp
forall (f :: * -&gt; *) vn.
[PatBase f vn]
-&gt; ExpBase f vn
-&gt; Maybe (TypeExp vn)
-&gt; f (Set Alias, StructRetType)
-&gt; SrcLoc
-&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523463"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523456"><span class="hs-identifier hs-var">body'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TypeExp VName)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Set Alias, StructRetType) -&gt; Info (Set Alias, StructRetType)
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Alias
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523461"><span class="hs-identifier hs-var">tp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-715"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-var">defuncExp'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523464"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-716"></span><span>
</span><span id="line-717"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#etaExpand"><span class="hs-identifier hs-type">etaExpand</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructRetType"><span class="hs-identifier hs-type">StructRetType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-718"></span><span id="etaExpand"><span class="annot"><span class="annottext">etaExpand :: PatType -&gt; Exp -&gt; DefM ([PatBase Info VName], Exp, StructRetType)
</span><a href="Futhark.Internalise.Defunctionalise.html#etaExpand"><span class="hs-identifier hs-var hs-var">etaExpand</span></a></span></span><span> </span><span id="local-6989586621684523455"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523455"><span class="hs-identifier hs-var">e_t</span></a></span></span><span> </span><span id="local-6989586621684523454"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523454"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-719"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523453"><span class="annot"><span class="annottext">[(PName, PatType)]
</span><a href="#local-6989586621684523453"><span class="hs-identifier hs-var">ps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523452"><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) (Set Alias)
</span><a href="#local-6989586621684523452"><span class="hs-identifier hs-var">ret</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) (Set Alias)
-&gt; ([(PName, PatType)], RetTypeBase (DimDecl VName) (Set Alias))
forall {dim} {as}.
RetTypeBase dim as
-&gt; ([(PName, TypeBase dim as)], RetTypeBase dim as)
</span><a href="#local-6989586621684523451"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) (Set Alias)
 -&gt; ([(PName, PatType)], RetTypeBase (DimDecl VName) (Set Alias)))
-&gt; RetTypeBase (DimDecl VName) (Set Alias)
-&gt; ([(PName, PatType)], RetTypeBase (DimDecl VName) (Set Alias))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; PatType -&gt; RetTypeBase (DimDecl VName) (Set Alias)
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523455"><span class="hs-identifier hs-var">e_t</span></a></span><span>
</span><span id="line-720"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523450"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523450"><span class="hs-identifier hs-var">pats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523449"><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523449"><span class="hs-identifier hs-var">vars</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">([(PatBase Info VName, Exp)] -&gt; ([PatBase Info VName], [Exp]))
-&gt; DefM [(PatBase Info VName, Exp)]
-&gt; DefM ([PatBase Info VName], [Exp])
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">[(PatBase Info VName, Exp)] -&gt; ([PatBase Info VName], [Exp])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">(DefM [(PatBase Info VName, Exp)]
 -&gt; DefM ([PatBase Info VName], [Exp]))
-&gt; (((PName, PatType) -&gt; DefM (PatBase Info VName, Exp))
    -&gt; DefM [(PatBase Info VName, Exp)])
-&gt; ((PName, PatType) -&gt; DefM (PatBase Info VName, Exp))
-&gt; DefM ([PatBase Info VName], [Exp])
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(PName, PatType)]
-&gt; ((PName, PatType) -&gt; DefM (PatBase Info VName, Exp))
-&gt; DefM [(PatBase Info VName, Exp)]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m (t b)
</span><span class="hs-identifier hs-var">forM</span></span><span> </span><span class="annot"><span class="annottext">[(PName, PatType)]
</span><a href="#local-6989586621684523453"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">(((PName, PatType) -&gt; DefM (PatBase Info VName, Exp))
 -&gt; DefM ([PatBase Info VName], [Exp]))
-&gt; ((PName, PatType) -&gt; DefM (PatBase Info VName, Exp))
-&gt; DefM ([PatBase Info VName], [Exp])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684523447"><span class="annot"><span class="annottext">PName
</span><a href="#local-6989586621684523447"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523446"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523446"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-721"></span><span>    </span><span id="local-6989586621684523445"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523445"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PName
</span><a href="#local-6989586621684523447"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-722"></span><span>      </span><span class="annot"><a href="Language.Futhark.Syntax.html#Named"><span class="hs-identifier hs-type">Named</span></a></span><span> </span><span id="local-6989586621684523443"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523443"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; DefM VName
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523443"><span class="hs-identifier hs-var">x</span></a></span><span>
</span><span id="line-723"></span><span>      </span><span class="annot"><span class="annottext">PName
</span><a href="Language.Futhark.Syntax.html#Unnamed"><span class="hs-identifier hs-var">Unnamed</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">String -&gt; DefM VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newNameFromString"><span class="hs-identifier hs-var">newNameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;x&quot;</span></span><span>
</span><span id="line-724"></span><span>    </span><span class="annot"><span class="annottext">(PatBase Info VName, Exp) -&gt; DefM (PatBase Info VName, Exp)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-725"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Info PatType -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn. vn -&gt; f PatType -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#Id"><span class="hs-identifier hs-var">Id</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523445"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523446"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-726"></span><span>        </span><span class="annot"><span class="annottext">QualName VName -&gt; Info PatType -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
QualName vn -&gt; f PatType -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523445"><span class="hs-identifier hs-var">x</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523446"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-727"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-728"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523435"><span class="annot"><span class="annottext">e' :: Exp
</span><a href="#local-6989586621684523435"><span class="hs-identifier hs-var hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-729"></span><span>        </span><span class="annot"><span class="annottext">(Exp -&gt; (Exp, PatType, [PatType]) -&gt; Exp)
-&gt; Exp -&gt; [(Exp, PatType, [PatType])] -&gt; Exp
forall (t :: * -&gt; *) b a.
Foldable t =&gt;
(b -&gt; a -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><span class="hs-identifier hs-var">foldl'</span></span><span>
</span><span id="line-730"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684523434"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523434"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523433"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523433"><span class="hs-identifier hs-var">e2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523432"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523432"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523431"><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523431"><span class="hs-identifier hs-var">argtypes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-731"></span><span>              </span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span>
</span><span id="line-732"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
-&gt; Exp
-&gt; Info (Diet, Maybe VName)
-&gt; SrcLoc
-&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
ExpBase f vn
-&gt; ExpBase f vn
-&gt; f (Diet, Maybe VName)
-&gt; SrcLoc
-&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523434"><span class="hs-identifier hs-var">e1</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523433"><span class="hs-identifier hs-var">e2</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Diet, Maybe VName) -&gt; Info (Diet, Maybe VName)
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Diet
forall shape as. TypeBase shape as -&gt; Diet
</span><a href="Language.Futhark.Prop.html#diet"><span class="hs-identifier hs-var">diet</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523432"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe VName
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span>
</span><span id="line-733"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AppRes -&gt; Info AppRes
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; [VName] -&gt; AppRes
</span><a href="Language.Futhark.Syntax.html#AppRes"><span class="hs-identifier hs-var">AppRes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatType] -&gt; RetTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall as dim.
Monoid as =&gt;
[TypeBase dim as] -&gt; RetTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#foldFunType"><span class="hs-identifier hs-var">foldFunType</span></a></span><span> </span><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523431"><span class="hs-identifier hs-var">argtypes</span></a></span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) (Set Alias)
</span><a href="#local-6989586621684523452"><span class="hs-identifier hs-var">ret</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-734"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-735"></span><span>          </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523454"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-736"></span><span>          </span><span class="annot"><span class="annottext">([(Exp, PatType, [PatType])] -&gt; Exp)
-&gt; [(Exp, PatType, [PatType])] -&gt; Exp
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Exp] -&gt; [PatType] -&gt; [[PatType]] -&gt; [(Exp, PatType, [PatType])]
forall a b c. [a] -&gt; [b] -&gt; [c] -&gt; [(a, b, c)]
</span><span class="hs-identifier hs-var">zip3</span></span><span> </span><span class="annot"><span class="annottext">[Exp]
</span><a href="#local-6989586621684523449"><span class="hs-identifier hs-var">vars</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((PName, PatType) -&gt; PatType) -&gt; [(PName, PatType)] -&gt; [PatType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(PName, PatType) -&gt; PatType
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(PName, PatType)]
</span><a href="#local-6989586621684523453"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int -&gt; [[PatType]] -&gt; [[PatType]]
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">drop</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span> </span><span class="annot"><span class="annottext">([[PatType]] -&gt; [[PatType]]) -&gt; [[PatType]] -&gt; [[PatType]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PatType] -&gt; [[PatType]]
forall a. [a] -&gt; [[a]]
</span><span class="hs-identifier hs-var">tails</span></span><span> </span><span class="annot"><span class="annottext">([PatType] -&gt; [[PatType]]) -&gt; [PatType] -&gt; [[PatType]]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((PName, PatType) -&gt; PatType) -&gt; [(PName, PatType)] -&gt; [PatType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(PName, PatType) -&gt; PatType
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(PName, PatType)]
</span><a href="#local-6989586621684523453"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-737"></span><span>  </span><span class="annot"><span class="annottext">([PatBase Info VName], Exp, StructRetType)
-&gt; DefM ([PatBase Info VName], Exp, StructRetType)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523450"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523435"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Set Alias -&gt; ())
-&gt; RetTypeBase (DimDecl VName) (Set Alias) -&gt; StructRetType
forall (p :: * -&gt; * -&gt; *) b c a.
Bifunctor p =&gt;
(b -&gt; c) -&gt; p a b -&gt; p a c
</span><span class="hs-identifier hs-var">second</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; Set Alias -&gt; ()
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">RetTypeBase (DimDecl VName) (Set Alias)
</span><a href="#local-6989586621684523452"><span class="hs-identifier hs-var">ret</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-738"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-739"></span><span>    </span><span id="local-6989586621684523451"><span class="annot"><span class="annottext">getType :: RetTypeBase dim as
-&gt; ([(PName, TypeBase dim as)], RetTypeBase dim as)
</span><a href="#local-6989586621684523451"><span class="hs-identifier hs-var hs-var">getType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">as
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523426"><span class="annot"><span class="annottext">PName
</span><a href="#local-6989586621684523426"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span id="local-6989586621684523425"><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684523425"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span id="local-6989586621684523424"><span class="annot"><span class="annottext">RetTypeBase dim as
</span><a href="#local-6989586621684523424"><span class="hs-identifier hs-var">t2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-740"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523423"><span class="annot"><span class="annottext">[(PName, TypeBase dim as)]
</span><a href="#local-6989586621684523423"><span class="hs-identifier hs-var">ps</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523422"><span class="annot"><span class="annottext">RetTypeBase dim as
</span><a href="#local-6989586621684523422"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RetTypeBase dim as
-&gt; ([(PName, TypeBase dim as)], RetTypeBase dim as)
</span><a href="#local-6989586621684523451"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span class="annot"><span class="annottext">RetTypeBase dim as
</span><a href="#local-6989586621684523424"><span class="hs-identifier hs-var">t2</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">PName
</span><a href="#local-6989586621684523426"><span class="hs-identifier hs-var">p</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684523425"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PName, TypeBase dim as)
-&gt; [(PName, TypeBase dim as)] -&gt; [(PName, TypeBase dim as)]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[(PName, TypeBase dim as)]
</span><a href="#local-6989586621684523423"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RetTypeBase dim as
</span><a href="#local-6989586621684523422"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-741"></span><span>    </span><span class="annot"><a href="#local-6989586621684523451"><span class="hs-identifier hs-var">getType</span></a></span><span> </span><span id="local-6989586621684523421"><span class="annot"><span class="annottext">RetTypeBase dim as
</span><a href="#local-6989586621684523421"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">RetTypeBase dim as
</span><a href="#local-6989586621684523421"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-742"></span><span>
</span><span id="line-743"></span><span class="hs-comment">-- | Defunctionalize an indexing of a single array dimension.</span><span>
</span><span id="line-744"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncDimIndex"><span class="hs-identifier hs-type">defuncDimIndex</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#DimIndexBase"><span class="hs-identifier hs-type">DimIndexBase</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimIndexBase"><span class="hs-identifier hs-type">DimIndexBase</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-745"></span><span id="defuncDimIndex"><span class="annot"><span class="annottext">defuncDimIndex :: DimIndexBase Info VName -&gt; DefM (DimIndexBase Info VName)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncDimIndex"><span class="hs-identifier hs-var hs-var">defuncDimIndex</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimFix"><span class="hs-identifier hs-type">DimFix</span></a></span><span> </span><span id="local-6989586621684523419"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523419"><span class="hs-identifier hs-var">e1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DimIndexBase Info VName
forall (f :: * -&gt; *) vn. ExpBase f vn -&gt; DimIndexBase f vn
</span><a href="Language.Futhark.Syntax.html#DimFix"><span class="hs-identifier hs-var">DimFix</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; DimIndexBase Info VName)
-&gt; ((Exp, StaticVal) -&gt; Exp)
-&gt; (Exp, StaticVal)
-&gt; DimIndexBase Info VName
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; Exp
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">((Exp, StaticVal) -&gt; DimIndexBase Info VName)
-&gt; DefM (Exp, StaticVal) -&gt; DefM (DimIndexBase Info VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523419"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-746"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncDimIndex"><span class="hs-identifier hs-var">defuncDimIndex</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#DimSlice"><span class="hs-identifier hs-type">DimSlice</span></a></span><span> </span><span id="local-6989586621684523417"><span class="annot"><span class="annottext">Maybe Exp
</span><a href="#local-6989586621684523417"><span class="hs-identifier hs-var">me1</span></a></span></span><span> </span><span id="local-6989586621684523416"><span class="annot"><span class="annottext">Maybe Exp
</span><a href="#local-6989586621684523416"><span class="hs-identifier hs-var">me2</span></a></span></span><span> </span><span id="local-6989586621684523415"><span class="annot"><span class="annottext">Maybe Exp
</span><a href="#local-6989586621684523415"><span class="hs-identifier hs-var">me3</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-747"></span><span>  </span><span class="annot"><span class="annottext">Maybe Exp -&gt; Maybe Exp -&gt; Maybe Exp -&gt; DimIndexBase Info VName
forall (f :: * -&gt; *) vn.
Maybe (ExpBase f vn)
-&gt; Maybe (ExpBase f vn)
-&gt; Maybe (ExpBase f vn)
-&gt; DimIndexBase f vn
</span><a href="Language.Futhark.Syntax.html#DimSlice"><span class="hs-identifier hs-var">DimSlice</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Exp -&gt; Maybe Exp -&gt; Maybe Exp -&gt; DimIndexBase Info VName)
-&gt; DefM (Maybe Exp)
-&gt; DefM (Maybe Exp -&gt; Maybe Exp -&gt; DimIndexBase Info VName)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;$&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp -&gt; DefM (Maybe Exp)
</span><a href="#local-6989586621684523414"><span class="hs-identifier hs-var">defunc'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
</span><a href="#local-6989586621684523417"><span class="hs-identifier hs-var">me1</span></a></span><span> </span><span class="annot"><span class="annottext">DefM (Maybe Exp -&gt; Maybe Exp -&gt; DimIndexBase Info VName)
-&gt; DefM (Maybe Exp) -&gt; DefM (Maybe Exp -&gt; DimIndexBase Info VName)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp -&gt; DefM (Maybe Exp)
</span><a href="#local-6989586621684523414"><span class="hs-identifier hs-var">defunc'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
</span><a href="#local-6989586621684523416"><span class="hs-identifier hs-var">me2</span></a></span><span> </span><span class="annot"><span class="annottext">DefM (Maybe Exp -&gt; DimIndexBase Info VName)
-&gt; DefM (Maybe Exp) -&gt; DefM (DimIndexBase Info VName)
forall (f :: * -&gt; *) a b. Applicative f =&gt; f (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-operator hs-var">&lt;*&gt;</span></span><span> </span><span class="annot"><span class="annottext">Maybe Exp -&gt; DefM (Maybe Exp)
</span><a href="#local-6989586621684523414"><span class="hs-identifier hs-var">defunc'</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe Exp
</span><a href="#local-6989586621684523415"><span class="hs-identifier hs-var">me3</span></a></span><span>
</span><span id="line-748"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-749"></span><span>    </span><span id="local-6989586621684523414"><span class="annot"><span class="annottext">defunc' :: Maybe Exp -&gt; DefM (Maybe Exp)
</span><a href="#local-6989586621684523414"><span class="hs-identifier hs-var hs-var">defunc'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; DefM Exp) -&gt; Maybe Exp -&gt; DefM (Maybe Exp)
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM Exp
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp%27"><span class="hs-identifier hs-var">defuncExp'</span></a></span><span>
</span><span id="line-750"></span><span>
</span><span id="line-751"></span><span class="hs-comment">-- | Defunctionalize a let-bound function, while preserving parameters</span><span>
</span><span id="line-752"></span><span class="hs-comment">-- that have order 0 types (i.e., non-functional).</span><span>
</span><span id="line-753"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncLet"><span class="hs-identifier hs-type">defuncLet</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-754"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-755"></span><span>  </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-756"></span><span>  </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-757"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructRetType"><span class="hs-identifier hs-type">StructRetType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-758"></span><span>  </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-759"></span><span id="defuncLet"><span class="annot"><span class="annottext">defuncLet :: [VName]
-&gt; [PatBase Info VName]
-&gt; Exp
-&gt; StructRetType
-&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncLet"><span class="hs-identifier hs-var hs-var">defuncLet</span></a></span></span><span> </span><span id="local-6989586621684523410"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523410"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684523409"><span class="annot"><span class="annottext">ps :: [PatBase Info VName]
</span><a href="#local-6989586621684523409"><span class="hs-identifier hs-var">ps</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span id="local-6989586621684523408"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523408"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684523407"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523407"><span class="hs-identifier hs-var">pats</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523406"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523406"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684523405"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523405"><span class="hs-identifier hs-var">ret_dims</span></a></span></span><span> </span><span id="local-6989586621684523404"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523404"><span class="hs-identifier hs-var">rettype</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-760"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Bool
forall vn. PatBase Info vn -&gt; Bool
</span><a href="Language.Futhark.Prop.html#patternOrderZero"><span class="hs-identifier hs-var">patternOrderZero</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523408"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-761"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523401"><span class="annot"><span class="annottext">bound_by_pat :: VName -&gt; Bool
</span><a href="#local-6989586621684523401"><span class="hs-identifier hs-var hs-var">bound_by_pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Set VName
</span><a href="Language.Futhark.Prop.html#patternDimNames"><span class="hs-identifier hs-var">patternDimNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523408"><span class="hs-identifier hs-var">pat</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-762"></span><span>        </span><span class="hs-comment">-- Take care to not include more size parameters than necessary.</span><span>
</span><span id="line-763"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684523400"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523400"><span class="hs-identifier hs-var">pat_dims</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523399"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523399"><span class="hs-identifier hs-var">rest_dims</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; ([VName], [VName])
forall a. (a -&gt; Bool) -&gt; [a] -&gt; ([a], [a])
</span><span class="hs-identifier hs-var">partition</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Bool
</span><a href="#local-6989586621684523401"><span class="hs-identifier hs-var">bound_by_pat</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523410"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-764"></span><span>        </span><span id="local-6989586621684523396"><span class="annot"><span class="annottext">env :: Env
</span><a href="#local-6989586621684523396"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#envFromPat"><span class="hs-identifier hs-var">envFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523408"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Env -&gt; Env
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#envFromDimNames"><span class="hs-identifier hs-var">envFromDimNames</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523400"><span class="hs-identifier hs-var">pat_dims</span></a></span><span>
</span><span id="line-765"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684523394"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523394"><span class="hs-identifier hs-var">rest_dims'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523393"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523393"><span class="hs-identifier hs-var">pats'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523392"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523392"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523391"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523391"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-766"></span><span>      </span><span class="annot"><span class="annottext">Env
-&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal)
-&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal)
forall a. Env -&gt; DefM a -&gt; DefM a
</span><a href="Futhark.Internalise.Defunctionalise.html#localEnv"><span class="hs-identifier hs-var">localEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523396"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(DefM ([VName], [PatBase Info VName], Exp, StaticVal)
 -&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal))
-&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal)
-&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; [PatBase Info VName]
-&gt; Exp
-&gt; StructRetType
-&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncLet"><span class="hs-identifier hs-var">defuncLet</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523399"><span class="hs-identifier hs-var">rest_dims</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523407"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523406"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">(StructRetType
 -&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal))
-&gt; StructRetType
-&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523405"><span class="hs-identifier hs-var">ret_dims</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523404"><span class="hs-identifier hs-var">rettype</span></a></span><span>
</span><span id="line-767"></span><span>    </span><span id="local-6989586621684523390"><span class="annot"><span class="annottext">(Exp, StaticVal)
</span><a href="#local-6989586621684523390"><span class="hs-identifier hs-var">closure</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; [PatBase Info VName]
-&gt; Exp
-&gt; StructRetType
-&gt; SrcLoc
-&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncFun"><span class="hs-identifier hs-var">defuncFun</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523410"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523409"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523406"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523405"><span class="hs-identifier hs-var">ret_dims</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523404"><span class="hs-identifier hs-var">rettype</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-768"></span><span>    </span><span class="annot"><span class="annottext">([VName], [PatBase Info VName], Exp, StaticVal)
-&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-769"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523400"><span class="hs-identifier hs-var">pat_dims</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523394"><span class="hs-identifier hs-var">rest_dims'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-770"></span><span>        </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523408"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; [PatBase Info VName] -&gt; [PatBase Info VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523393"><span class="hs-identifier hs-var">pats'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-771"></span><span>        </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523392"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-772"></span><span>        </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; StaticVal -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-var">DynamicFun</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal)
</span><a href="#local-6989586621684523390"><span class="hs-identifier hs-var">closure</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523391"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-773"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-774"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-775"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684523389"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523389"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523388"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523388"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[VName]
-&gt; [PatBase Info VName]
-&gt; Exp
-&gt; StructRetType
-&gt; SrcLoc
-&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncFun"><span class="hs-identifier hs-var">defuncFun</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523410"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523409"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523406"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523405"><span class="hs-identifier hs-var">ret_dims</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523404"><span class="hs-identifier hs-var">rettype</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-776"></span><span>    </span><span class="annot"><span class="annottext">([VName], [PatBase Info VName], Exp, StaticVal)
-&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523389"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523388"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-777"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncLet"><span class="hs-identifier hs-var">defuncLet</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684523387"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523387"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523386"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523386"><span class="hs-identifier hs-var">rettype</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-778"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523385"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523385"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523384"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523384"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523387"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-779"></span><span>  </span><span class="annot"><span class="annottext">([VName], [PatBase Info VName], Exp, StaticVal)
-&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523385"><span class="hs-identifier hs-var">body'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; StructType -&gt; StaticVal
forall {as}. StaticVal -&gt; TypeBase (DimDecl VName) as -&gt; StaticVal
</span><a href="#local-6989586621684523383"><span class="hs-identifier hs-var">imposeType</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523384"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523386"><span class="hs-identifier hs-var">rettype</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-780"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-781"></span><span>    </span><span id="local-6989586621684523383"><span class="annot"><span class="annottext">imposeType :: StaticVal -&gt; TypeBase (DimDecl VName) as -&gt; StaticVal
</span><a href="#local-6989586621684523383"><span class="hs-identifier hs-var hs-var">imposeType</span></a></span></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span id="local-6989586621684523380"><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684523380"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-782"></span><span>      </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as -&gt; PatType
forall dim as. TypeBase dim as -&gt; TypeBase dim (Set Alias)
</span><a href="Language.Futhark.Prop.html#fromStruct"><span class="hs-identifier hs-var">fromStruct</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><a href="#local-6989586621684523380"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-783"></span><span>    </span><span class="annot"><a href="#local-6989586621684523383"><span class="hs-identifier hs-var">imposeType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-type">RecordSV</span></a></span><span> </span><span id="local-6989586621684523378"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684523378"><span class="hs-identifier hs-var">fs1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684523377"><span class="annot"><span class="annottext">Map Name (TypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684523377"><span class="hs-identifier hs-var">fs2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-784"></span><span>      </span><span class="annot"><span class="annottext">[(Name, StaticVal)] -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-var">RecordSV</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, StaticVal)] -&gt; StaticVal)
-&gt; [(Name, StaticVal)] -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Name StaticVal -&gt; [(Name, StaticVal)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">(Map Name StaticVal -&gt; [(Name, StaticVal)])
-&gt; Map Name StaticVal -&gt; [(Name, StaticVal)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; TypeBase (DimDecl VName) as -&gt; StaticVal)
-&gt; Map Name StaticVal
-&gt; Map Name (TypeBase (DimDecl VName) as)
-&gt; Map Name StaticVal
forall k a b c.
Ord k =&gt;
(a -&gt; b -&gt; c) -&gt; Map k a -&gt; Map k b -&gt; Map k c
</span><span class="hs-identifier hs-var">M.intersectionWith</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; TypeBase (DimDecl VName) as -&gt; StaticVal
</span><a href="#local-6989586621684523383"><span class="hs-identifier hs-var">imposeType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Name, StaticVal)] -&gt; Map Name StaticVal
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684523378"><span class="hs-identifier hs-var">fs1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase (DimDecl VName) as)
</span><a href="#local-6989586621684523377"><span class="hs-identifier hs-var">fs2</span></a></span><span>
</span><span id="line-785"></span><span>    </span><span class="annot"><a href="#local-6989586621684523383"><span class="hs-identifier hs-var">imposeType</span></a></span><span> </span><span id="local-6989586621684523375"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523375"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="annot"><span class="annottext">TypeBase (DimDecl VName) as
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523375"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-786"></span><span>
</span><span id="line-787"></span><span id="local-6989586621684525133"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#sizesForAll"><span class="hs-identifier hs-type">sizesForAll</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684525133"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">S.Set</span></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684525133"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span class="hs-special">]</span><span class="hs-special">)</span></span><span>
</span><span id="line-788"></span><span id="sizesForAll"><span class="annot"><span class="annottext">sizesForAll :: forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Set VName
-&gt; [PatBase Info VName] -&gt; m ([VName], [PatBase Info VName])
</span><a href="Futhark.Internalise.Defunctionalise.html#sizesForAll"><span class="hs-identifier hs-var hs-var">sizesForAll</span></a></span></span><span> </span><span id="local-6989586621684523362"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523362"><span class="hs-identifier hs-var">bound_sizes</span></a></span></span><span> </span><span id="local-6989586621684523361"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523361"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-789"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523360"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523360"><span class="hs-identifier hs-var">params'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523359"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523359"><span class="hs-identifier hs-var">sizes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StateT (Set VName) m [PatBase Info VName]
-&gt; Set VName -&gt; m ([PatBase Info VName], Set VName)
forall s (m :: * -&gt; *) a. StateT s m a -&gt; s -&gt; m (a, s)
</span><span class="hs-identifier hs-var hs-var">runStateT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; StateT (Set VName) m (PatBase Info VName))
-&gt; [PatBase Info VName]
-&gt; StateT (Set VName) m [PatBase Info VName]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ASTMapper (StateT (Set VName) m)
-&gt; PatBase Info VName -&gt; StateT (Set VName) m (PatBase Info VName)
forall x (m :: * -&gt; *).
(ASTMappable x, Monad m) =&gt;
ASTMapper m -&gt; x -&gt; m x
</span><a href="Language.Futhark.Traversals.html#astMap"><span class="hs-identifier hs-var">astMap</span></a></span><span> </span><span class="annot"><span class="annottext">ASTMapper (StateT (Set VName) m)
</span><a href="#local-6989586621684523357"><span class="hs-identifier hs-var">tv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523361"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set VName
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-790"></span><span>  </span><span class="annot"><span class="annottext">([VName], [PatBase Info VName])
-&gt; m ([VName], [PatBase Info VName])
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set VName -&gt; [VName]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523359"><span class="hs-identifier hs-var">sizes</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523360"><span class="hs-identifier hs-var">params'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-791"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-792"></span><span>    </span><span id="local-6989586621684523350"><span class="annot"><span class="annottext">bound :: Set VName
</span><a href="#local-6989586621684523350"><span class="hs-identifier hs-var hs-var">bound</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523362"><span class="hs-identifier hs-var">bound_sizes</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; Set VName)
-&gt; [PatBase Info VName] -&gt; Set VName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Set VName
forall (f :: * -&gt; *) vn.
(Functor f, Ord vn) =&gt;
PatBase f vn -&gt; Set vn
</span><a href="Language.Futhark.Prop.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523361"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-793"></span><span>    </span><span id="local-6989586621684523357"><span class="annot"><span class="annottext">tv :: ASTMapper (StateT (Set VName) m)
</span><a href="#local-6989586621684523357"><span class="hs-identifier hs-var hs-var">tv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ASTMapper (StateT (Set VName) m)
forall (m :: * -&gt; *). Monad m =&gt; ASTMapper m
</span><a href="Language.Futhark.Traversals.html#identityMapper"><span class="hs-identifier hs-var">identityMapper</span></a></span><span> </span><span class="hs-special">{</span><span class="annot"><span class="annottext">mapOnPatType :: PatType -&gt; StateT (Set VName) m PatType
</span><a href="Language.Futhark.Traversals.html#mapOnPatType"><span class="hs-identifier hs-var">mapOnPatType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; StateT (Set VName) m (DimDecl VName))
-&gt; (Set Alias -&gt; StateT (Set VName) m (Set Alias))
-&gt; PatType
-&gt; StateT (Set VName) m PatType
forall (t :: * -&gt; * -&gt; *) (f :: * -&gt; *) a c b d.
(Bitraversable t, Applicative f) =&gt;
(a -&gt; f c) -&gt; (b -&gt; f d) -&gt; t a b -&gt; f (t c d)
</span><span class="hs-identifier hs-var">bitraverse</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; StateT (Set VName) m (DimDecl VName)
forall {t :: (* -&gt; *) -&gt; * -&gt; *} {m :: * -&gt; *}.
(MonadState (Set VName) (t m), MonadTrans t, MonadFreshNames m) =&gt;
DimDecl VName -&gt; t m (DimDecl VName)
</span><a href="#local-6989586621684523338"><span class="hs-identifier hs-var">onDim</span></a></span><span> </span><span class="annot"><span class="annottext">Set Alias -&gt; StateT (Set VName) m (Set Alias)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span class="hs-special">}</span><span>
</span><span id="line-794"></span><span>    </span><span id="local-6989586621684523338"><span class="annot"><span class="annottext">onDim :: DimDecl VName -&gt; t m (DimDecl VName)
</span><a href="#local-6989586621684523338"><span class="hs-identifier hs-var hs-var">onDim</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AnyDim"><span class="hs-identifier hs-type">AnyDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684523311"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523311"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-795"></span><span>      </span><span class="annot"><span class="annottext">(Set VName -&gt; Set VName) -&gt; t m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((Set VName -&gt; Set VName) -&gt; t m ())
-&gt; (Set VName -&gt; Set VName) -&gt; t m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Set VName
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.insert</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523311"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-796"></span><span>      </span><span class="annot"><span class="annottext">DimDecl VName -&gt; t m (DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; t m (DimDecl VName))
-&gt; DimDecl VName -&gt; t m (DimDecl VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; QualName VName -&gt; DimDecl VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523311"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-797"></span><span>    </span><span class="annot"><a href="#local-6989586621684523338"><span class="hs-identifier hs-var">onDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AnyDim"><span class="hs-identifier hs-type">AnyDim</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe VName
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-798"></span><span>      </span><span id="local-6989586621684523309"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523309"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m VName -&gt; t m VName
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(m VName -&gt; t m VName) -&gt; m VName -&gt; t m VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; m VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;size&quot;</span></span><span>
</span><span id="line-799"></span><span>      </span><span class="annot"><span class="annottext">(Set VName -&gt; Set VName) -&gt; t m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((Set VName -&gt; Set VName) -&gt; t m ())
-&gt; (Set VName -&gt; Set VName) -&gt; t m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Set VName
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.insert</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523309"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-800"></span><span>      </span><span class="annot"><span class="annottext">DimDecl VName -&gt; t m (DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; t m (DimDecl VName))
-&gt; DimDecl VName -&gt; t m (DimDecl VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">(QualName VName -&gt; DimDecl VName)
-&gt; QualName VName -&gt; DimDecl VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523309"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-801"></span><span>    </span><span class="annot"><a href="#local-6989586621684523338"><span class="hs-identifier hs-var">onDim</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684523306"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523306"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-802"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; t m () -&gt; t m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523306"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523350"><span class="hs-identifier hs-var">bound</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(t m () -&gt; t m ()) -&gt; t m () -&gt; t m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-803"></span><span>        </span><span class="annot"><span class="annottext">(Set VName -&gt; Set VName) -&gt; t m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><span class="hs-identifier hs-var">modify</span></span><span> </span><span class="annot"><span class="annottext">((Set VName -&gt; Set VName) -&gt; t m ())
-&gt; (Set VName -&gt; Set VName) -&gt; t m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Set VName
forall a. Ord a =&gt; a -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.insert</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Set VName -&gt; Set VName)
-&gt; VName -&gt; Set VName -&gt; Set VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523306"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-804"></span><span>      </span><span class="annot"><span class="annottext">DimDecl VName -&gt; t m (DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; t m (DimDecl VName))
-&gt; DimDecl VName -&gt; t m (DimDecl VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; DimDecl VName
forall vn. QualName vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-var">NamedDim</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523306"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-805"></span><span>    </span><span class="annot"><a href="#local-6989586621684523338"><span class="hs-identifier hs-var">onDim</span></a></span><span> </span><span id="local-6989586621684523304"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684523304"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; t m (DimDecl VName)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684523304"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-806"></span><span>
</span><span id="line-807"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#unRetType"><span class="hs-identifier hs-type">unRetType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructRetType"><span class="hs-identifier hs-type">StructRetType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span>
</span><span id="line-808"></span><span id="unRetType"><span class="annot"><span class="annottext">unRetType :: StructRetType -&gt; StructType
</span><a href="Futhark.Internalise.Defunctionalise.html#unRetType"><span class="hs-identifier hs-var hs-var">unRetType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span id="local-6989586621684523302"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523302"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523302"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-809"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#unRetType"><span class="hs-identifier hs-var">unRetType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684523301"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523301"><span class="hs-identifier hs-var">ext</span></a></span></span><span> </span><span id="local-6989586621684523300"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523300"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; DimDecl VName) -&gt; StructType -&gt; StructType
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="annot"><span class="annottext">DimDecl VName -&gt; DimDecl VName
</span><a href="#local-6989586621684523299"><span class="hs-identifier hs-var">onDim</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523300"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-810"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-811"></span><span>    </span><span id="local-6989586621684523299"><span class="annot"><span class="annottext">onDim :: DimDecl VName -&gt; DimDecl VName
</span><a href="#local-6989586621684523299"><span class="hs-identifier hs-var hs-var">onDim</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684523296"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523296"><span class="hs-identifier hs-var">d</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523296"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523301"><span class="hs-identifier hs-var">ext</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe VName -&gt; DimDecl VName
forall vn. Maybe vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#AnyDim"><span class="hs-identifier hs-var">AnyDim</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe VName
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-812"></span><span>    </span><span class="annot"><a href="#local-6989586621684523299"><span class="hs-identifier hs-var">onDim</span></a></span><span> </span><span id="local-6989586621684523295"><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684523295"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl VName
</span><a href="#local-6989586621684523295"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-813"></span><span>
</span><span id="line-814"></span><span class="hs-comment">-- | Defunctionalize an application expression at a given depth of application.</span><span>
</span><span id="line-815"></span><span class="hs-comment">-- Calls to dynamic (first-order) functions are preserved at much as possible,</span><span>
</span><span id="line-816"></span><span class="hs-comment">-- but a new lifted function is created if a dynamic function is only partially</span><span>
</span><span id="line-817"></span><span class="hs-comment">-- applied.</span><span>
</span><span id="line-818"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncApply"><span class="hs-identifier hs-type">defuncApply</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-819"></span><span id="defuncApply"><span class="annot"><span class="annottext">defuncApply :: Int -&gt; Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncApply"><span class="hs-identifier hs-var hs-var">defuncApply</span></a></span></span><span> </span><span id="local-6989586621684523294"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523294"><span class="hs-identifier hs-var">depth</span></a></span></span><span> </span><span id="local-6989586621684523293"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684523293"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621684523292"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523292"><span class="hs-identifier hs-var">e1</span></a></span></span><span> </span><span id="local-6989586621684523291"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523291"><span class="hs-identifier hs-var">e2</span></a></span></span><span> </span><span id="local-6989586621684523290"><span class="annot"><span class="annottext">Info (Diet, Maybe VName)
</span><a href="#local-6989586621684523290"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span id="local-6989586621684523289"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523289"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523288"><span class="annot"><span class="annottext">t :: Info AppRes
</span><a href="#local-6989586621684523288"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppRes"><span class="hs-identifier hs-type">AppRes</span></a></span><span> </span><span id="local-6989586621684523287"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523287"><span class="hs-identifier hs-var">ret</span></a></span></span><span> </span><span id="local-6989586621684523286"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523286"><span class="hs-identifier hs-var">ext</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-820"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523285"><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523285"><span class="hs-identifier hs-var">argtypes</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; ([PatType], PatType)
forall dim as.
TypeBase dim as -&gt; ([TypeBase dim as], TypeBase dim as)
</span><a href="Language.Futhark.Prop.html#unfoldFunType"><span class="hs-identifier hs-var">unfoldFunType</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523287"><span class="hs-identifier hs-var">ret</span></a></span><span>
</span><span id="line-821"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523283"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523283"><span class="hs-identifier hs-var">e1'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523282"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523282"><span class="hs-identifier hs-var">sv1</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncApply"><span class="hs-identifier hs-var">defuncApply</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523294"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523292"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-822"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684523280"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523280"><span class="hs-identifier hs-var">e2'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523279"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523279"><span class="hs-identifier hs-var">sv2</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523291"><span class="hs-identifier hs-var">e2</span></a></span><span>
</span><span id="line-823"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523278"><span class="annot"><span class="annottext">e' :: Exp
</span><a href="#local-6989586621684523278"><span class="hs-identifier hs-var hs-var">e'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
-&gt; Exp
-&gt; Info (Diet, Maybe VName)
-&gt; SrcLoc
-&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
ExpBase f vn
-&gt; ExpBase f vn
-&gt; f (Diet, Maybe VName)
-&gt; SrcLoc
-&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523283"><span class="hs-identifier hs-var">e1'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523280"><span class="hs-identifier hs-var">e2'</span></a></span><span> </span><span class="annot"><span class="annottext">Info (Diet, Maybe VName)
</span><a href="#local-6989586621684523290"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523289"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Info AppRes
</span><a href="#local-6989586621684523288"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-824"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523282"><span class="hs-identifier hs-var">sv1</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-825"></span><span>    </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#LambdaSV"><span class="hs-identifier hs-type">LambdaSV</span></a></span><span> </span><span id="local-6989586621684523277"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523277"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684523276"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523276"><span class="hs-identifier hs-var">e0_t</span></a></span></span><span> </span><span id="local-6989586621684523275"><span class="annot"><span class="annottext">ExtExp
</span><a href="#local-6989586621684523275"><span class="hs-identifier hs-var">e0</span></a></span></span><span> </span><span id="local-6989586621684523274"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523274"><span class="hs-identifier hs-var">closure_env</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-826"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523273"><span class="annot"><span class="annottext">env' :: Env
</span><a href="#local-6989586621684523273"><span class="hs-identifier hs-var hs-var">env'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523277"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523279"><span class="hs-identifier hs-var">sv2</span></a></span><span>
</span><span id="line-827"></span><span>          </span><span id="local-6989586621684523271"><span class="annot"><span class="annottext">dims :: [VName]
</span><a href="#local-6989586621684523271"><span class="hs-identifier hs-var hs-var">dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-828"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684523270"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523270"><span class="hs-identifier hs-var">e0'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523269"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523269"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-829"></span><span>        </span><span class="annot"><span class="annottext">Env -&gt; DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall a. Env -&gt; DefM a -&gt; DefM a
</span><a href="Futhark.Internalise.Defunctionalise.html#localNewEnv"><span class="hs-identifier hs-var">localNewEnv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523273"><span class="hs-identifier hs-var">env'</span></a></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Env -&gt; Env
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523274"><span class="hs-identifier hs-var">closure_env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal))
-&gt; DefM (Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-830"></span><span>          </span><span class="annot"><span class="annottext">ExtExp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExtExp"><span class="hs-identifier hs-var">defuncExtExp</span></a></span><span> </span><span class="annot"><span class="annottext">ExtExp
</span><a href="#local-6989586621684523275"><span class="hs-identifier hs-var">e0</span></a></span><span>
</span><span id="line-831"></span><span>
</span><span id="line-832"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523268"><span class="annot"><span class="annottext">closure_pat :: PatBase Info VName
</span><a href="#local-6989586621684523268"><span class="hs-identifier hs-var hs-var">closure_pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Env -&gt; PatBase Info VName
</span><a href="Futhark.Internalise.Defunctionalise.html#buildEnvPat"><span class="hs-identifier hs-var">buildEnvPat</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523271"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523274"><span class="hs-identifier hs-var">closure_env</span></a></span><span>
</span><span id="line-833"></span><span>          </span><span id="local-6989586621684523266"><span class="annot"><span class="annottext">pat' :: PatBase Info VName
</span><a href="#local-6989586621684523266"><span class="hs-identifier hs-var hs-var">pat'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; PatBase Info VName
</span><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523277"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523279"><span class="hs-identifier hs-var">sv2</span></a></span><span>
</span><span id="line-834"></span><span>
</span><span id="line-835"></span><span>      </span><span id="local-6989586621684523265"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523265"><span class="hs-identifier hs-var">globals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Set VName, Env) -&gt; Set VName) -&gt; DefM (Set VName)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">(Set VName, Env) -&gt; Set VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span>
</span><span id="line-836"></span><span>
</span><span id="line-837"></span><span>      </span><span class="hs-comment">-- Lift lambda to top-level function definition.  We put in</span><span>
</span><span id="line-838"></span><span>      </span><span class="hs-comment">-- a lot of effort to try to infer the uniqueness attributes</span><span>
</span><span id="line-839"></span><span>      </span><span class="hs-comment">-- of the lifted function, but this is ultimately all a sham</span><span>
</span><span id="line-840"></span><span>      </span><span class="hs-comment">-- and a hack.  There is some piece we're missing.</span><span>
</span><span id="line-841"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523264"><span class="annot"><span class="annottext">params :: [PatBase Info VName]
</span><a href="#local-6989586621684523264"><span class="hs-identifier hs-var hs-var">params</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523268"><span class="hs-identifier hs-var">closure_pat</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523266"><span class="hs-identifier hs-var">pat'</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-842"></span><span>          </span><span id="local-6989586621684523263"><span class="annot"><span class="annottext">params_for_rettype :: [PatBase Info VName]
</span><a href="#local-6989586621684523263"><span class="hs-identifier hs-var hs-var">params_for_rettype</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523264"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
-&gt; [PatBase Info VName] -&gt; [PatBase Info VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; [PatBase Info VName]
</span><a href="#local-6989586621684523262"><span class="hs-identifier hs-var">svParams</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523282"><span class="hs-identifier hs-var">sv1</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
-&gt; [PatBase Info VName] -&gt; [PatBase Info VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; [PatBase Info VName]
</span><a href="#local-6989586621684523262"><span class="hs-identifier hs-var">svParams</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523279"><span class="hs-identifier hs-var">sv2</span></a></span><span>
</span><span id="line-843"></span><span>          </span><span id="local-6989586621684523262"><span class="annot"><span class="annottext">svParams :: StaticVal -&gt; [PatBase Info VName]
</span><a href="#local-6989586621684523262"><span class="hs-identifier hs-var hs-var">svParams</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#LambdaSV"><span class="hs-identifier hs-type">LambdaSV</span></a></span><span> </span><span id="local-6989586621684523261"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523261"><span class="hs-identifier hs-var">sv_pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExtExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523261"><span class="hs-identifier hs-var">sv_pat</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-844"></span><span>          </span><span class="annot"><a href="#local-6989586621684523262"><span class="hs-identifier hs-var">svParams</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-845"></span><span>          </span><span id="local-6989586621684523260"><span class="annot"><span class="annottext">rettype :: PatType
</span><a href="#local-6989586621684523260"><span class="hs-identifier hs-var hs-var">rettype</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env -&gt; [PatBase Info VName] -&gt; StructType -&gt; PatType -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#buildRetType"><span class="hs-identifier hs-var">buildRetType</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523274"><span class="hs-identifier hs-var">closure_env</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523263"><span class="hs-identifier hs-var">params_for_rettype</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructRetType -&gt; StructType
</span><a href="Futhark.Internalise.Defunctionalise.html#unRetType"><span class="hs-identifier hs-var">unRetType</span></a></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523276"><span class="hs-identifier hs-var">e0_t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; PatType) -&gt; PatType -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523270"><span class="hs-identifier hs-var">e0'</span></a></span><span>
</span><span id="line-846"></span><span>
</span><span id="line-847"></span><span>          </span><span id="local-6989586621684523247"><span class="annot"><span class="annottext">already_bound :: Set VName
</span><a href="#local-6989586621684523247"><span class="hs-identifier hs-var hs-var">already_bound</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-848"></span><span>            </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523265"><span class="hs-identifier hs-var">globals</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523271"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-849"></span><span>              </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(IdentBase Info VName -&gt; VName)
-&gt; Set (IdentBase Info VName) -&gt; Set VName
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName -&gt; VName
forall (f :: * -&gt; *) vn. IdentBase f vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; Set (IdentBase Info VName))
-&gt; [PatBase Info VName] -&gt; Set (IdentBase Info VName)
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Set (IdentBase Info VName)
forall (f :: * -&gt; *) vn.
(Functor f, Ord vn) =&gt;
PatBase f vn -&gt; Set (IdentBase f vn)
</span><a href="Language.Futhark.Prop.html#patIdents"><span class="hs-identifier hs-var">patIdents</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523264"><span class="hs-identifier hs-var">params</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-850"></span><span>
</span><span id="line-851"></span><span>          </span><span id="local-6989586621684523243"><span class="annot"><span class="annottext">more_dims :: [VName]
</span><a href="#local-6989586621684523243"><span class="hs-identifier hs-var hs-var">more_dims</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-852"></span><span>            </span><span class="annot"><span class="annottext">Set VName -&gt; [VName]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set VName -&gt; [VName]) -&gt; Set VName -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-853"></span><span>              </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; Set VName -&gt; Set VName
forall a. (a -&gt; Bool) -&gt; Set a -&gt; Set a
</span><span class="hs-identifier hs-var">S.filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.notMember`</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523247"><span class="hs-identifier hs-var">already_bound</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Set VName -&gt; Set VName) -&gt; Set VName -&gt; Set VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-854"></span><span>                </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; Set VName)
-&gt; [PatBase Info VName] -&gt; Set VName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Set VName
</span><a href="Futhark.Internalise.Defunctionalise.html#patternArraySizes"><span class="hs-identifier hs-var">patternArraySizes</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523264"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-855"></span><span>
</span><span id="line-856"></span><span>          </span><span class="hs-comment">-- Embed some information about the original function</span><span>
</span><span id="line-857"></span><span>          </span><span class="hs-comment">-- into the name of the lifted function, to make the</span><span>
</span><span id="line-858"></span><span>          </span><span class="hs-comment">-- result slightly more human-readable.</span><span>
</span><span id="line-859"></span><span>          </span><span id="local-6989586621684523236"><span class="annot"><span class="annottext">liftedName :: t -&gt; ExpBase f VName -&gt; String
</span><a href="#local-6989586621684523236"><span class="hs-identifier hs-var hs-var">liftedName</span></a></span></span><span> </span><span id="local-6989586621684523235"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684523235"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684523234"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523234"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="annottext">f PatType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-860"></span><span>            </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defunc_&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">t -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684523235"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;_&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523234"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-861"></span><span>          </span><span class="annot"><a href="#local-6989586621684523236"><span class="hs-identifier hs-var">liftedName</span></a></span><span> </span><span id="local-6989586621684523232"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684523232"><span class="hs-identifier hs-var">i</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-type">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Apply"><span class="hs-identifier hs-type">Apply</span></a></span><span> </span><span id="local-6989586621684523231"><span class="annot"><span class="annottext">ExpBase f VName
</span><a href="#local-6989586621684523231"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="annot"><span class="annottext">ExpBase f VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">f (Diet, Maybe VName)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">f AppRes
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-862"></span><span>            </span><span class="annot"><span class="annottext">t -&gt; ExpBase f VName -&gt; String
</span><a href="#local-6989586621684523236"><span class="hs-identifier hs-var">liftedName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621684523232"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">t -&gt; t -&gt; t
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">+</span></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">ExpBase f VName
</span><a href="#local-6989586621684523231"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-863"></span><span>          </span><span class="annot"><a href="#local-6989586621684523236"><span class="hs-identifier hs-var">liftedName</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExpBase f VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;defunc&quot;</span></span><span>
</span><span id="line-864"></span><span>
</span><span id="line-865"></span><span>      </span><span class="hs-comment">-- Ensure that no parameter sizes are AnyDim.  The internaliser</span><span>
</span><span id="line-866"></span><span>      </span><span class="hs-comment">-- expects this.  This is easy, because they are all</span><span>
</span><span id="line-867"></span><span>      </span><span class="hs-comment">-- first-order.</span><span>
</span><span id="line-868"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523226"><span class="annot"><span class="annottext">bound_sizes :: Set VName
</span><a href="#local-6989586621684523226"><span class="hs-identifier hs-var hs-var">bound_sizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523271"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523243"><span class="hs-identifier hs-var">more_dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523265"><span class="hs-identifier hs-var">globals</span></a></span><span>
</span><span id="line-869"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621684523225"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523225"><span class="hs-identifier hs-var">missing_dims</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523224"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523224"><span class="hs-identifier hs-var">params'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Set VName
-&gt; [PatBase Info VName] -&gt; DefM ([VName], [PatBase Info VName])
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Set VName
-&gt; [PatBase Info VName] -&gt; m ([VName], [PatBase Info VName])
</span><a href="Futhark.Internalise.Defunctionalise.html#sizesForAll"><span class="hs-identifier hs-var">sizesForAll</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523226"><span class="hs-identifier hs-var">bound_sizes</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523264"><span class="hs-identifier hs-var">params</span></a></span><span>
</span><span id="line-870"></span><span>
</span><span id="line-871"></span><span>      </span><span id="local-6989586621684523223"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523223"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; DefM VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newNameFromString"><span class="hs-identifier hs-var">newNameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; DefM VName) -&gt; String -&gt; DefM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Exp -&gt; String
forall {t} {f :: * -&gt; *}.
(Show t, Num t) =&gt;
t -&gt; ExpBase f VName -&gt; String
</span><a href="#local-6989586621684523236"><span class="hs-identifier hs-var">liftedName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523292"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-872"></span><span>      </span><span class="annot"><span class="annottext">VName
-&gt; StructRetType
-&gt; [VName]
-&gt; [PatBase Info VName]
-&gt; Exp
-&gt; DefM ()
</span><a href="Futhark.Internalise.Defunctionalise.html#liftValDec"><span class="hs-identifier hs-var">liftValDec</span></a></span><span>
</span><span id="line-873"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523223"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-874"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; StructRetType) -&gt; StructType -&gt; StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523260"><span class="hs-identifier hs-var">rettype</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-875"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523271"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523243"><span class="hs-identifier hs-var">more_dims</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523225"><span class="hs-identifier hs-var">missing_dims</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-876"></span><span>        </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523224"><span class="hs-identifier hs-var">params'</span></a></span><span>
</span><span id="line-877"></span><span>        </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523270"><span class="hs-identifier hs-var">e0'</span></a></span><span>
</span><span id="line-878"></span><span>
</span><span id="line-879"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523221"><span class="annot"><span class="annottext">t1 :: StructType
</span><a href="#local-6989586621684523221"><span class="hs-identifier hs-var hs-var">t1</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StructType) -&gt; PatType -&gt; StructType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523283"><span class="hs-identifier hs-var">e1'</span></a></span><span>
</span><span id="line-880"></span><span>          </span><span id="local-6989586621684523220"><span class="annot"><span class="annottext">t2 :: StructType
</span><a href="#local-6989586621684523220"><span class="hs-identifier hs-var hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StructType) -&gt; PatType -&gt; StructType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523280"><span class="hs-identifier hs-var">e2'</span></a></span><span>
</span><span id="line-881"></span><span>          </span><span id="local-6989586621684523219"><span class="annot"><span class="annottext">fname' :: QualName VName
</span><a href="#local-6989586621684523219"><span class="hs-identifier hs-var hs-var">fname'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523223"><span class="hs-identifier hs-var">fname</span></a></span><span>
</span><span id="line-882"></span><span>          </span><span id="local-6989586621684523215"><span class="annot"><span class="annottext">fname'' :: Exp
</span><a href="#local-6989586621684523215"><span class="hs-identifier hs-var hs-var">fname''</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-883"></span><span>            </span><span class="annot"><span class="annottext">QualName VName -&gt; Info PatType -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
QualName vn -&gt; f PatType -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span>
</span><span id="line-884"></span><span>              </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523219"><span class="hs-identifier hs-var">fname'</span></a></span><span>
</span><span id="line-885"></span><span>              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span>
</span><span id="line-886"></span><span>                  </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType)
-&gt; (PatType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias))
-&gt; PatType
-&gt; PatType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Set Alias
-&gt; PName
-&gt; PatType
-&gt; RetTypeBase (DimDecl VName) (Set Alias)
-&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall dim as.
as
-&gt; PName
-&gt; TypeBase dim as
-&gt; RetTypeBase dim as
-&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">Set Alias
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">PName
</span><a href="Language.Futhark.Syntax.html#Unnamed"><span class="hs-identifier hs-var">Unnamed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; PatType
forall dim as. TypeBase dim as -&gt; TypeBase dim (Set Alias)
</span><a href="Language.Futhark.Prop.html#fromStruct"><span class="hs-identifier hs-var">fromStruct</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523221"><span class="hs-identifier hs-var">t1</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) (Set Alias)
 -&gt; ScalarTypeBase (DimDecl VName) (Set Alias))
-&gt; (PatType -&gt; RetTypeBase (DimDecl VName) (Set Alias))
-&gt; PatType
-&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; PatType -&gt; RetTypeBase (DimDecl VName) (Set Alias)
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; PatType) -&gt; PatType -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-887"></span><span>                      </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType)
-&gt; (RetTypeBase (DimDecl VName) (Set Alias)
    -&gt; ScalarTypeBase (DimDecl VName) (Set Alias))
-&gt; RetTypeBase (DimDecl VName) (Set Alias)
-&gt; PatType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Set Alias
-&gt; PName
-&gt; PatType
-&gt; RetTypeBase (DimDecl VName) (Set Alias)
-&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall dim as.
as
-&gt; PName
-&gt; TypeBase dim as
-&gt; RetTypeBase dim as
-&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">Set Alias
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">PName
</span><a href="Language.Futhark.Syntax.html#Unnamed"><span class="hs-identifier hs-var">Unnamed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; PatType
forall dim as. TypeBase dim as -&gt; TypeBase dim (Set Alias)
</span><a href="Language.Futhark.Prop.html#fromStruct"><span class="hs-identifier hs-var">fromStruct</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523220"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) (Set Alias) -&gt; PatType)
-&gt; RetTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; PatType -&gt; RetTypeBase (DimDecl VName) (Set Alias)
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523260"><span class="hs-identifier hs-var">rettype</span></a></span><span>
</span><span id="line-888"></span><span>                  </span><span class="hs-special">)</span><span>
</span><span id="line-889"></span><span>              </span><span class="hs-special">)</span><span>
</span><span id="line-890"></span><span>              </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523289"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-891"></span><span>
</span><span id="line-892"></span><span>          </span><span class="hs-comment">-- FIXME: what if this application returns both a function</span><span>
</span><span id="line-893"></span><span>          </span><span class="hs-comment">-- and a value?</span><span>
</span><span id="line-894"></span><span>          </span><span id="local-6989586621684523214"><span class="annot"><span class="annottext">callret :: AppRes
</span><a href="#local-6989586621684523214"><span class="hs-identifier hs-var hs-var">callret</span></a></span></span><span>
</span><span id="line-895"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Bool
forall dim as. TypeBase dim as -&gt; Bool
</span><a href="Language.Futhark.Prop.html#orderZero"><span class="hs-identifier hs-var">orderZero</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523287"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; [VName] -&gt; AppRes
</span><a href="Language.Futhark.Syntax.html#AppRes"><span class="hs-identifier hs-var">AppRes</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523287"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523286"><span class="hs-identifier hs-var">ext</span></a></span><span>
</span><span id="line-896"></span><span>            </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; [VName] -&gt; AppRes
</span><a href="Language.Futhark.Syntax.html#AppRes"><span class="hs-identifier hs-var">AppRes</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523260"><span class="hs-identifier hs-var">rettype</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523286"><span class="hs-identifier hs-var">ext</span></a></span><span>
</span><span id="line-897"></span><span>
</span><span id="line-898"></span><span>      </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-899"></span><span>        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn. ExpBase f vn -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Parens"><span class="hs-identifier hs-var">Parens</span></a></span><span>
</span><span id="line-900"></span><span>            </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span>
</span><span id="line-901"></span><span>                </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">Exp
-&gt; Exp
-&gt; Info (Diet, Maybe VName)
-&gt; SrcLoc
-&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
ExpBase f vn
-&gt; ExpBase f vn
-&gt; f (Diet, Maybe VName)
-&gt; SrcLoc
-&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span>
</span><span id="line-902"></span><span>                    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span>
</span><span id="line-903"></span><span>                        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
-&gt; Exp
-&gt; Info (Diet, Maybe VName)
-&gt; SrcLoc
-&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
ExpBase f vn
-&gt; ExpBase f vn
-&gt; f (Diet, Maybe VName)
-&gt; SrcLoc
-&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523215"><span class="hs-identifier hs-var">fname''</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523283"><span class="hs-identifier hs-var">e1'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Diet, Maybe VName) -&gt; Info (Diet, Maybe VName)
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Diet
</span><a href="Language.Futhark.Syntax.html#Observe"><span class="hs-identifier hs-var">Observe</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe VName
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523289"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-904"></span><span>                        </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">AppRes -&gt; Info AppRes
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">(AppRes -&gt; Info AppRes) -&gt; AppRes -&gt; Info AppRes
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-905"></span><span>                            </span><span class="annot"><span class="annottext">PatType -&gt; [VName] -&gt; AppRes
</span><a href="Language.Futhark.Syntax.html#AppRes"><span class="hs-identifier hs-var">AppRes</span></a></span><span>
</span><span id="line-906"></span><span>                              </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType)
-&gt; ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-907"></span><span>                                  </span><span class="annot"><span class="annottext">Set Alias
-&gt; PName
-&gt; PatType
-&gt; RetTypeBase (DimDecl VName) (Set Alias)
-&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall dim as.
as
-&gt; PName
-&gt; TypeBase dim as
-&gt; RetTypeBase dim as
-&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-var">Arrow</span></a></span><span> </span><span class="annot"><span class="annottext">Set Alias
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">PName
</span><a href="Language.Futhark.Syntax.html#Unnamed"><span class="hs-identifier hs-var">Unnamed</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; PatType
forall dim as. TypeBase dim as -&gt; TypeBase dim (Set Alias)
</span><a href="Language.Futhark.Prop.html#fromStruct"><span class="hs-identifier hs-var">fromStruct</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523220"><span class="hs-identifier hs-var">t2</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) (Set Alias)
 -&gt; ScalarTypeBase (DimDecl VName) (Set Alias))
-&gt; RetTypeBase (DimDecl VName) (Set Alias)
-&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-908"></span><span>                                    </span><span class="annot"><span class="annottext">[VName] -&gt; PatType -&gt; RetTypeBase (DimDecl VName) (Set Alias)
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523260"><span class="hs-identifier hs-var">rettype</span></a></span><span>
</span><span id="line-909"></span><span>                              </span><span class="hs-special">)</span><span>
</span><span id="line-910"></span><span>                              </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-911"></span><span>                        </span><span class="hs-special">)</span><span>
</span><span id="line-912"></span><span>                    </span><span class="hs-special">)</span><span>
</span><span id="line-913"></span><span>                    </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523280"><span class="hs-identifier hs-var">e2'</span></a></span><span>
</span><span id="line-914"></span><span>                    </span><span class="annot"><span class="annottext">Info (Diet, Maybe VName)
</span><a href="#local-6989586621684523290"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-915"></span><span>                    </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523289"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-916"></span><span>                </span><span class="hs-special">)</span><span>
</span><span id="line-917"></span><span>                </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AppRes -&gt; Info AppRes
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">AppRes
</span><a href="#local-6989586621684523214"><span class="hs-identifier hs-var">callret</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-918"></span><span>            </span><span class="hs-special">)</span><span>
</span><span id="line-919"></span><span>            </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-920"></span><span>          </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523269"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-921"></span><span>        </span><span class="hs-special">)</span><span>
</span><span id="line-922"></span><span>
</span><span id="line-923"></span><span>    </span><span class="hs-comment">-- If e1 is a dynamic function, we just leave the application in place,</span><span>
</span><span id="line-924"></span><span>    </span><span class="hs-comment">-- but we update the types since it may be partially applied or return</span><span>
</span><span id="line-925"></span><span>    </span><span class="hs-comment">-- a higher-order term.</span><span>
</span><span id="line-926"></span><span>    </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-type">DynamicFun</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523212"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523212"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-927"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523211"><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523211"><span class="hs-identifier hs-var">argtypes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523210"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523210"><span class="hs-identifier hs-var">rettype</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; [PatType] -&gt; ([PatType], PatType)
</span><a href="Futhark.Internalise.Defunctionalise.html#dynamicFunType"><span class="hs-identifier hs-var">dynamicFunType</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523212"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523285"><span class="hs-identifier hs-var">argtypes</span></a></span><span>
</span><span id="line-928"></span><span>          </span><span id="local-6989586621684523205"><span class="annot"><span class="annottext">restype :: PatType
</span><a href="#local-6989586621684523205"><span class="hs-identifier hs-var hs-var">restype</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatType] -&gt; RetTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall as dim.
Monoid as =&gt;
[TypeBase dim as] -&gt; RetTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#foldFunType"><span class="hs-identifier hs-var">foldFunType</span></a></span><span> </span><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523211"><span class="hs-identifier hs-var">argtypes'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; PatType -&gt; RetTypeBase (DimDecl VName) (Set Alias)
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523210"><span class="hs-identifier hs-var">rettype</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Set Alias -&gt; PatType
forall dim asf ast. TypeBase dim asf -&gt; ast -&gt; TypeBase dim ast
</span><a href="Language.Futhark.Prop.html#setAliases"><span class="hs-operator hs-var">`setAliases`</span></a></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Set Alias
forall as shape. Monoid as =&gt; TypeBase shape as -&gt; as
</span><a href="Language.Futhark.Prop.html#aliases"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523287"><span class="hs-identifier hs-var">ret</span></a></span><span>
</span><span id="line-929"></span><span>          </span><span id="local-6989586621684523198"><span class="annot"><span class="annottext">callret :: AppRes
</span><a href="#local-6989586621684523198"><span class="hs-identifier hs-var hs-var">callret</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; [VName] -&gt; AppRes
</span><a href="Language.Futhark.Syntax.html#AppRes"><span class="hs-identifier hs-var">AppRes</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; PatType -&gt; PatType
forall as dim.
(Monoid as, ArrayDim dim) =&gt;
TypeBase dim as -&gt; TypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#combineTypeShapes"><span class="hs-identifier hs-var">combineTypeShapes</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523287"><span class="hs-identifier hs-var">ret</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523205"><span class="hs-identifier hs-var">restype</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523286"><span class="hs-identifier hs-var">ext</span></a></span><span>
</span><span id="line-930"></span><span>          </span><span id="local-6989586621684523196"><span class="annot"><span class="annottext">apply_e :: Exp
</span><a href="#local-6989586621684523196"><span class="hs-identifier hs-var hs-var">apply_e</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">AppExpBase Info VName -&gt; Info AppRes -&gt; Exp
forall (f :: * -&gt; *) vn.
AppExpBase f vn -&gt; f AppRes -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#AppExp"><span class="hs-identifier hs-var">AppExp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
-&gt; Exp
-&gt; Info (Diet, Maybe VName)
-&gt; SrcLoc
-&gt; AppExpBase Info VName
forall (f :: * -&gt; *) vn.
ExpBase f vn
-&gt; ExpBase f vn
-&gt; f (Diet, Maybe VName)
-&gt; SrcLoc
-&gt; AppExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Apply"><span class="hs-identifier hs-var">Apply</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523283"><span class="hs-identifier hs-var">e1'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523280"><span class="hs-identifier hs-var">e2'</span></a></span><span> </span><span class="annot"><span class="annottext">Info (Diet, Maybe VName)
</span><a href="#local-6989586621684523290"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523289"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">AppRes -&gt; Info AppRes
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">AppRes
</span><a href="#local-6989586621684523198"><span class="hs-identifier hs-var">callret</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-931"></span><span>      </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523196"><span class="hs-identifier hs-var">apply_e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523212"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-932"></span><span>    </span><span class="hs-comment">-- Propagate the 'IntrinsicsSV' until we reach the outermost application,</span><span>
</span><span id="line-933"></span><span>    </span><span class="hs-comment">-- where we construct a dynamic static value with the appropriate type.</span><span>
</span><span id="line-934"></span><span>    </span><span class="annot"><span class="annottext">StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#IntrinsicSV"><span class="hs-identifier hs-var">IntrinsicSV</span></a></span><span>
</span><span id="line-935"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523294"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-936"></span><span>        </span><span class="hs-comment">-- If the intrinsic is fully applied, then we are done.</span><span>
</span><span id="line-937"></span><span>        </span><span class="hs-comment">-- Otherwise we need to eta-expand it and recursively</span><span>
</span><span id="line-938"></span><span>        </span><span class="hs-comment">-- defunctionalise. XXX: might it be better to simply</span><span>
</span><span id="line-939"></span><span>        </span><span class="hs-comment">-- eta-expand immediately any time we encounter a</span><span>
</span><span id="line-940"></span><span>        </span><span class="hs-comment">-- non-fully-applied intrinsic?</span><span>
</span><span id="line-941"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[PatType] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523285"><span class="hs-identifier hs-var">argtypes</span></a></span><span>
</span><span id="line-942"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523278"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523293"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-943"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-944"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684523194"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523194"><span class="hs-identifier hs-var">pats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523193"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523193"><span class="hs-identifier hs-var">body</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523192"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523192"><span class="hs-identifier hs-var">tp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Exp -&gt; DefM ([PatBase Info VName], Exp, StructRetType)
</span><a href="Futhark.Internalise.Defunctionalise.html#etaExpand"><span class="hs-identifier hs-var">etaExpand</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523278"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523278"><span class="hs-identifier hs-var">e'</span></a></span><span>
</span><span id="line-945"></span><span>            </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp -&gt; DefM (Exp, StaticVal)) -&gt; Exp -&gt; DefM (Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
-&gt; Exp
-&gt; Maybe (TypeExp VName)
-&gt; Info (Set Alias, StructRetType)
-&gt; SrcLoc
-&gt; Exp
forall (f :: * -&gt; *) vn.
[PatBase f vn]
-&gt; ExpBase f vn
-&gt; Maybe (TypeExp vn)
-&gt; f (Set Alias, StructRetType)
-&gt; SrcLoc
-&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Lambda"><span class="hs-identifier hs-var">Lambda</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523194"><span class="hs-identifier hs-var">pats</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523193"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (TypeExp VName)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(Set Alias, StructRetType) -&gt; Info (Set Alias, StructRetType)
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set Alias
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523192"><span class="hs-identifier hs-var">tp</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-946"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523278"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#IntrinsicSV"><span class="hs-identifier hs-var">IntrinsicSV</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-947"></span><span>    </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-948"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; DefM (Exp, StaticVal)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; DefM (Exp, StaticVal))
-&gt; String -&gt; DefM (Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-949"></span><span>        </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Application of an expression\n&quot;</span></span><span>
</span><span id="line-950"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523292"><span class="hs-identifier hs-var">e1</span></a></span><span>
</span><span id="line-951"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;\nthat is neither a static lambda &quot;</span></span><span>
</span><span id="line-952"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;nor a dynamic function, but has static value:\n&quot;</span></span><span>
</span><span id="line-953"></span><span>          </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523282"><span class="hs-identifier hs-var">sv1</span></a></span><span>
</span><span id="line-954"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncApply"><span class="hs-identifier hs-var">defuncApply</span></a></span><span> </span><span id="local-6989586621684523191"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523191"><span class="hs-identifier hs-var">depth</span></a></span></span><span> </span><span id="local-6989586621684523190"><span class="annot"><span class="annottext">e :: Exp
</span><a href="#local-6989586621684523190"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-type">Var</span></a></span><span> </span><span id="local-6989586621684523189"><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523189"><span class="hs-identifier hs-var">qn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684523188"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523188"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523187"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523187"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-955"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523186"><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523186"><span class="hs-identifier hs-var">argtypes</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatType
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; ([PatType], PatType)
forall dim as.
TypeBase dim as -&gt; ([TypeBase dim as], TypeBase dim as)
</span><a href="Language.Futhark.Prop.html#unfoldFunType"><span class="hs-identifier hs-var">unfoldFunType</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523188"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-956"></span><span>  </span><span id="local-6989586621684523185"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523185"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StructType -&gt; VName -&gt; DefM StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#lookupVar"><span class="hs-identifier hs-var">lookupVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523188"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523189"><span class="hs-identifier hs-var">qn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-957"></span><span>
</span><span id="line-958"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523185"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-959"></span><span>    </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-type">DynamicFun</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal)
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span>
</span><span id="line-960"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; Int -&gt; Bool
</span><a href="Futhark.Internalise.Defunctionalise.html#fullyApplied"><span class="hs-identifier hs-var">fullyApplied</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523185"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523191"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-961"></span><span>        </span><span class="hs-comment">-- We still need to update the types in case the dynamic</span><span>
</span><span id="line-962"></span><span>        </span><span class="hs-comment">-- function returns a higher-order term.</span><span>
</span><span id="line-963"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523183"><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523183"><span class="hs-identifier hs-var">argtypes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523182"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523182"><span class="hs-identifier hs-var">rettype</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; [PatType] -&gt; ([PatType], PatType)
</span><a href="Futhark.Internalise.Defunctionalise.html#dynamicFunType"><span class="hs-identifier hs-var">dynamicFunType</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523185"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523186"><span class="hs-identifier hs-var">argtypes</span></a></span><span>
</span><span id="line-964"></span><span>        </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; Info PatType -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
QualName vn -&gt; f PatType -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523189"><span class="hs-identifier hs-var">qn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatType] -&gt; RetTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall as dim.
Monoid as =&gt;
[TypeBase dim as] -&gt; RetTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#foldFunType"><span class="hs-identifier hs-var">foldFunType</span></a></span><span> </span><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523183"><span class="hs-identifier hs-var">argtypes'</span></a></span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) (Set Alias) -&gt; PatType)
-&gt; RetTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; PatType -&gt; RetTypeBase (DimDecl VName) (Set Alias)
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523182"><span class="hs-identifier hs-var">rettype</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523187"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523185"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-965"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-966"></span><span>        </span><span id="local-6989586621684523181"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523181"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">String -&gt; DefM VName
forall (m :: * -&gt; *). MonadFreshNames m =&gt; String -&gt; m VName
</span><a href="Futhark.MonadFreshNames.html#newVName"><span class="hs-identifier hs-var">newVName</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; DefM VName) -&gt; String -&gt; DefM VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;dyn_&quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
</span><a href="Language.Futhark.Core.html#baseString"><span class="hs-identifier hs-var">baseString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; VName
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523189"><span class="hs-identifier hs-var">qn</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-967"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523177"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523177"><span class="hs-identifier hs-var">pats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523176"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523176"><span class="hs-identifier hs-var">e0</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523175"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523175"><span class="hs-identifier hs-var">sv'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
-&gt; StaticVal -&gt; Int -&gt; ([PatBase Info VName], Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#liftDynFun"><span class="hs-identifier hs-var">liftDynFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523189"><span class="hs-identifier hs-var">qn</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523185"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523191"><span class="hs-identifier hs-var">depth</span></a></span><span>
</span><span id="line-968"></span><span>            </span><span class="hs-special">(</span><span id="local-6989586621684523173"><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523173"><span class="hs-identifier hs-var">argtypes'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523172"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523172"><span class="hs-identifier hs-var">rettype</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; [PatType] -&gt; ([PatType], PatType)
</span><a href="Futhark.Internalise.Defunctionalise.html#dynamicFunType"><span class="hs-identifier hs-var">dynamicFunType</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523175"><span class="hs-identifier hs-var">sv'</span></a></span><span> </span><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523186"><span class="hs-identifier hs-var">argtypes</span></a></span><span>
</span><span id="line-969"></span><span>            </span><span id="local-6989586621684523170"><span class="annot"><span class="annottext">dims' :: [VName]
</span><a href="#local-6989586621684523170"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-970"></span><span>
</span><span id="line-971"></span><span>        </span><span class="hs-comment">-- Ensure that no parameter sizes are AnyDim.  The internaliser</span><span>
</span><span id="line-972"></span><span>        </span><span class="hs-comment">-- expects this.  This is easy, because they are all</span><span>
</span><span id="line-973"></span><span>        </span><span class="hs-comment">-- first-order.</span><span>
</span><span id="line-974"></span><span>        </span><span id="local-6989586621684523169"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523169"><span class="hs-identifier hs-var">globals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Set VName, Env) -&gt; Set VName) -&gt; DefM (Set VName)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">(Set VName, Env) -&gt; Set VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span>
</span><span id="line-975"></span><span>        </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523165"><span class="annot"><span class="annottext">bound_sizes :: Set VName
</span><a href="#local-6989586621684523165"><span class="hs-identifier hs-var hs-var">bound_sizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523170"><span class="hs-identifier hs-var">dims'</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523169"><span class="hs-identifier hs-var">globals</span></a></span><span>
</span><span id="line-976"></span><span>        </span><span class="hs-special">(</span><span id="local-6989586621684523164"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523164"><span class="hs-identifier hs-var">missing_dims</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523163"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523163"><span class="hs-identifier hs-var">pats'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Set VName
-&gt; [PatBase Info VName] -&gt; DefM ([VName], [PatBase Info VName])
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Set VName
-&gt; [PatBase Info VName] -&gt; m ([VName], [PatBase Info VName])
</span><a href="Futhark.Internalise.Defunctionalise.html#sizesForAll"><span class="hs-identifier hs-var">sizesForAll</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523165"><span class="hs-identifier hs-var">bound_sizes</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523177"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-977"></span><span>
</span><span id="line-978"></span><span>        </span><span class="annot"><span class="annottext">VName
-&gt; StructRetType
-&gt; [VName]
-&gt; [PatBase Info VName]
-&gt; Exp
-&gt; DefM ()
</span><a href="Futhark.Internalise.Defunctionalise.html#liftValDec"><span class="hs-identifier hs-var">liftValDec</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523181"><span class="hs-identifier hs-var">fname</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; StructRetType) -&gt; StructType -&gt; StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523172"><span class="hs-identifier hs-var">rettype</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523170"><span class="hs-identifier hs-var">dims'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523164"><span class="hs-identifier hs-var">missing_dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523163"><span class="hs-identifier hs-var">pats'</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523176"><span class="hs-identifier hs-var">e0</span></a></span><span>
</span><span id="line-979"></span><span>        </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span>
</span><span id="line-980"></span><span>          </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">QualName VName -&gt; Info PatType -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
QualName vn -&gt; f PatType -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span>
</span><span id="line-981"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; QualName VName
forall v. v -&gt; QualName v
</span><a href="Language.Futhark.Prop.html#qualName"><span class="hs-identifier hs-var">qualName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523181"><span class="hs-identifier hs-var">fname</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-982"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatType] -&gt; RetTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall as dim.
Monoid as =&gt;
[TypeBase dim as] -&gt; RetTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#foldFunType"><span class="hs-identifier hs-var">foldFunType</span></a></span><span> </span><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523173"><span class="hs-identifier hs-var">argtypes'</span></a></span><span> </span><span class="annot"><span class="annottext">(RetTypeBase (DimDecl VName) (Set Alias) -&gt; PatType)
-&gt; RetTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; PatType -&gt; RetTypeBase (DimDecl VName) (Set Alias)
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; RetTypeBase (DimDecl VName) (Set Alias))
-&gt; PatType -&gt; RetTypeBase (DimDecl VName) (Set Alias)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; PatType
forall dim as. TypeBase dim as -&gt; TypeBase dim (Set Alias)
</span><a href="Language.Futhark.Prop.html#fromStruct"><span class="hs-identifier hs-var">fromStruct</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523172"><span class="hs-identifier hs-var">rettype</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-983"></span><span>              </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523187"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-984"></span><span>            </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523175"><span class="hs-identifier hs-var">sv'</span></a></span><span>
</span><span id="line-985"></span><span>          </span><span class="hs-special">)</span><span>
</span><span id="line-986"></span><span>    </span><span class="annot"><span class="annottext">StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#IntrinsicSV"><span class="hs-identifier hs-var">IntrinsicSV</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523190"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#IntrinsicSV"><span class="hs-identifier hs-var">IntrinsicSV</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-987"></span><span>    </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; DefM (Exp, StaticVal)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">QualName VName -&gt; Info PatType -&gt; SrcLoc -&gt; Exp
forall (f :: * -&gt; *) vn.
QualName vn -&gt; f PatType -&gt; SrcLoc -&gt; ExpBase f vn
</span><a href="Language.Futhark.Syntax.html#Var"><span class="hs-identifier hs-var">Var</span></a></span><span> </span><span class="annot"><span class="annottext">QualName VName
</span><a href="#local-6989586621684523189"><span class="hs-identifier hs-var">qn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523185"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684523187"><span class="hs-identifier hs-var">loc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523185"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-988"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncApply"><span class="hs-identifier hs-var">defuncApply</span></a></span><span> </span><span id="local-6989586621684523162"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523162"><span class="hs-identifier hs-var">depth</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Parens"><span class="hs-identifier hs-type">Parens</span></a></span><span> </span><span id="local-6989586621684523161"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523161"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Int -&gt; Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncApply"><span class="hs-identifier hs-var">defuncApply</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523162"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523161"><span class="hs-identifier hs-var">e</span></a></span><span>
</span><span id="line-989"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncApply"><span class="hs-identifier hs-var">defuncApply</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523160"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523160"><span class="hs-identifier hs-var">expr</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp -&gt; DefM (Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncExp"><span class="hs-identifier hs-var">defuncExp</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523160"><span class="hs-identifier hs-var">expr</span></a></span><span>
</span><span id="line-990"></span><span>
</span><span id="line-991"></span><span class="hs-comment">-- | Check if a 'StaticVal' and a given application depth corresponds</span><span>
</span><span id="line-992"></span><span class="hs-comment">-- to a fully applied dynamic function.</span><span>
</span><span id="line-993"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#fullyApplied"><span class="hs-identifier hs-type">fullyApplied</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-994"></span><span id="fullyApplied"><span class="annot"><span class="annottext">fullyApplied :: StaticVal -&gt; Int -&gt; Bool
</span><a href="Futhark.Internalise.Defunctionalise.html#fullyApplied"><span class="hs-identifier hs-var hs-var">fullyApplied</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-type">DynamicFun</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523159"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523159"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523158"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523158"><span class="hs-identifier hs-var">depth</span></a></span></span><span>
</span><span id="line-995"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523158"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-996"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523158"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; Int -&gt; Bool
</span><a href="Futhark.Internalise.Defunctionalise.html#fullyApplied"><span class="hs-identifier hs-var">fullyApplied</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523159"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523158"><span class="hs-identifier hs-var">depth</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-997"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#fullyApplied"><span class="hs-identifier hs-var">fullyApplied</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-998"></span><span>
</span><span id="line-999"></span><span class="hs-comment">-- | Converts a dynamic function 'StaticVal' into a list of</span><span>
</span><span id="line-1000"></span><span class="hs-comment">-- dimensions, a list of parameters, a function body, and the</span><span>
</span><span id="line-1001"></span><span class="hs-comment">-- appropriate static value for applying the function at the given</span><span>
</span><span id="line-1002"></span><span class="hs-comment">-- depth of partial application.</span><span>
</span><span id="line-1003"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#liftDynFun"><span class="hs-identifier hs-type">liftDynFun</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">String</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Int</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1004"></span><span id="liftDynFun"><span class="annot"><span class="annottext">liftDynFun :: String
-&gt; StaticVal -&gt; Int -&gt; ([PatBase Info VName], Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#liftDynFun"><span class="hs-identifier hs-var hs-var">liftDynFun</span></a></span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-type">DynamicFun</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523156"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523156"><span class="hs-identifier hs-var">e</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523155"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523155"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523156"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523155"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1005"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#liftDynFun"><span class="hs-identifier hs-var">liftDynFun</span></a></span><span> </span><span id="local-6989586621684523154"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684523154"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-type">DynamicFun</span></a></span><span> </span><span id="local-6989586621684523153"><span class="annot"><span class="annottext">clsr :: (Exp, StaticVal)
</span><a href="#local-6989586621684523153"><span class="hs-identifier hs-var">clsr</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#LambdaSV"><span class="hs-identifier hs-type">LambdaSV</span></a></span><span> </span><span id="local-6989586621684523152"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523152"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExtExp
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523151"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523151"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523150"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523150"><span class="hs-identifier hs-var">d</span></a></span></span><span>
</span><span id="line-1006"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523150"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">&gt;</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">0</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1007"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523147"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523147"><span class="hs-identifier hs-var">pats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523146"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523146"><span class="hs-identifier hs-var">e'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523145"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523145"><span class="hs-identifier hs-var">sv'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">String
-&gt; StaticVal -&gt; Int -&gt; ([PatBase Info VName], Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#liftDynFun"><span class="hs-identifier hs-var">liftDynFun</span></a></span><span> </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684523154"><span class="hs-identifier hs-var">s</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523151"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523150"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Int
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><span class="hs-glyph hs-var">-</span></span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span>
</span><span id="line-1008"></span><span>     </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523152"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; [PatBase Info VName] -&gt; [PatBase Info VName]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523147"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523146"><span class="hs-identifier hs-var">e'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal) -&gt; StaticVal -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-var">DynamicFun</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal)
</span><a href="#local-6989586621684523153"><span class="hs-identifier hs-var">clsr</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523145"><span class="hs-identifier hs-var">sv'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1009"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#liftDynFun"><span class="hs-identifier hs-var">liftDynFun</span></a></span><span> </span><span id="local-6989586621684523144"><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684523144"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span id="local-6989586621684523143"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523143"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span id="local-6989586621684523142"><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523142"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1010"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; ([PatBase Info VName], Exp, StaticVal)
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; ([PatBase Info VName], Exp, StaticVal))
-&gt; String -&gt; ([PatBase Info VName], Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1011"></span><span>    </span><span class="annot"><span class="annottext">String
</span><a href="#local-6989586621684523144"><span class="hs-identifier hs-var">s</span></a></span><span>
</span><span id="line-1012"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; Tried to lift a StaticVal &quot;</span></span><span>
</span><span id="line-1013"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; ShowS
forall a. Int -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">take</span></span><span> </span><span class="annot"><span class="annottext">Int
</span><span class="hs-number">100</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticVal -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523143"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1014"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;, but expected a dynamic function.\n&quot;</span></span><span>
</span><span id="line-1015"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Int -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Int
</span><a href="#local-6989586621684523142"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-1016"></span><span>
</span><span id="line-1017"></span><span class="hs-comment">-- | Converts a pattern to an environment that binds the individual names of the</span><span>
</span><span id="line-1018"></span><span class="hs-comment">-- pattern to their corresponding types wrapped in a 'Dynamic' static value.</span><span>
</span><span id="line-1019"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#envFromPat"><span class="hs-identifier hs-type">envFromPat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span>
</span><span id="line-1020"></span><span id="envFromPat"><span class="annot"><span class="annottext">envFromPat :: PatBase Info VName -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#envFromPat"><span class="hs-identifier hs-var hs-var">envFromPat</span></a></span></span><span> </span><span id="local-6989586621684523140"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523140"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523140"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-1021"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#TuplePat"><span class="hs-identifier hs-type">TuplePat</span></a></span><span> </span><span id="local-6989586621684523138"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523138"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; Env) -&gt; [PatBase Info VName] -&gt; Env
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#envFromPat"><span class="hs-identifier hs-var">envFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523138"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-1022"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#RecordPat"><span class="hs-identifier hs-type">RecordPat</span></a></span><span> </span><span id="local-6989586621684523136"><span class="annot"><span class="annottext">[(Name, PatBase Info VName)]
</span><a href="#local-6989586621684523136"><span class="hs-identifier hs-var">fs</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">((Name, PatBase Info VName) -&gt; Env)
-&gt; [(Name, PatBase Info VName)] -&gt; Env
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#envFromPat"><span class="hs-identifier hs-var">envFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; Env)
-&gt; ((Name, PatBase Info VName) -&gt; PatBase Info VName)
-&gt; (Name, PatBase Info VName)
-&gt; Env
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, PatBase Info VName) -&gt; PatBase Info VName
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, PatBase Info VName)]
</span><a href="#local-6989586621684523136"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-1023"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatParens"><span class="hs-identifier hs-type">PatParens</span></a></span><span> </span><span id="local-6989586621684523134"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523134"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#envFromPat"><span class="hs-identifier hs-var">envFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523134"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1024"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatAttr"><span class="hs-identifier hs-type">PatAttr</span></a></span><span> </span><span class="annot"><span class="annottext">AttrInfo VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523132"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523132"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#envFromPat"><span class="hs-identifier hs-var">envFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523132"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1025"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span id="local-6989586621684523131"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523131"><span class="hs-identifier hs-var">vn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684523130"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523130"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Binding -&gt; Env
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523131"><span class="hs-identifier hs-var">vn</span></a></span><span> </span><span class="annot"><span class="annottext">(Binding -&gt; Env) -&gt; Binding -&gt; Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType) -&gt; StaticVal -&gt; Binding
</span><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; Binding) -&gt; StaticVal -&gt; Binding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523130"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1026"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#Wildcard"><span class="hs-identifier hs-type">Wildcard</span></a></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Env
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1027"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatAscription"><span class="hs-identifier hs-type">PatAscription</span></a></span><span> </span><span id="local-6989586621684523127"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523127"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#envFromPat"><span class="hs-identifier hs-var">envFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684523127"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1028"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatLit"><span class="hs-identifier hs-type">PatLit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Env
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1029"></span><span>  </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatConstr"><span class="hs-identifier hs-type">PatConstr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523124"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523124"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; Env) -&gt; [PatBase Info VName] -&gt; Env
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#envFromPat"><span class="hs-identifier hs-var">envFromPat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523124"><span class="hs-identifier hs-var">ps</span></a></span><span>
</span><span id="line-1030"></span><span>
</span><span id="line-1031"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#envFromDimNames"><span class="hs-identifier hs-type">envFromDimNames</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span>
</span><span id="line-1032"></span><span id="envFromDimNames"><span class="annot"><span class="annottext">envFromDimNames :: [VName] -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#envFromDimNames"><span class="hs-identifier hs-var hs-var">envFromDimNames</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(VName, Binding)] -&gt; Env
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Binding)] -&gt; Env)
-&gt; ([VName] -&gt; [(VName, Binding)]) -&gt; [VName] -&gt; Env
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [Binding] -&gt; [(VName, Binding)])
-&gt; [Binding] -&gt; [VName] -&gt; [(VName, Binding)]
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [Binding] -&gt; [(VName, Binding)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Binding -&gt; [Binding]
forall a. a -&gt; [a]
</span><span class="hs-identifier hs-var">repeat</span></span><span> </span><span class="annot"><span class="annottext">Binding
</span><a href="#local-6989586621684523122"><span class="hs-identifier hs-var">d</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1033"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1034"></span><span>    </span><span id="local-6989586621684523122"><span class="annot"><span class="annottext">d :: Binding
</span><a href="#local-6989586621684523122"><span class="hs-identifier hs-var hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType) -&gt; StaticVal -&gt; Binding
</span><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; Binding) -&gt; StaticVal -&gt; Binding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType)
-&gt; ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias))
-&gt; PrimType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Language.Futhark.Syntax.html#Signed"><span class="hs-identifier hs-var">Signed</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-1035"></span><span>
</span><span id="line-1036"></span><span class="hs-comment">-- | Create a new top-level value declaration with the given function name,</span><span>
</span><span id="line-1037"></span><span class="hs-comment">-- return type, list of parameters, and body expression.</span><span>
</span><span id="line-1038"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#liftValDec"><span class="hs-identifier hs-type">liftValDec</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructRetType"><span class="hs-identifier hs-type">StructRetType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.html#Exp"><span class="hs-identifier hs-type">Exp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1039"></span><span id="liftValDec"><span class="annot"><span class="annottext">liftValDec :: VName
-&gt; StructRetType
-&gt; [VName]
-&gt; [PatBase Info VName]
-&gt; Exp
-&gt; DefM ()
</span><a href="Futhark.Internalise.Defunctionalise.html#liftValDec"><span class="hs-identifier hs-var hs-var">liftValDec</span></a></span></span><span> </span><span id="local-6989586621684523121"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523121"><span class="hs-identifier hs-var">fname</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684523120"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523120"><span class="hs-identifier hs-var">ret_dims</span></a></span></span><span> </span><span id="local-6989586621684523119"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523119"><span class="hs-identifier hs-var">ret</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523118"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523118"><span class="hs-identifier hs-var">dims</span></a></span></span><span> </span><span id="local-6989586621684523117"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523117"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span id="local-6989586621684523116"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523116"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValBind -&gt; DefM ()
</span><a href="Futhark.Internalise.Defunctionalise.html#addValBind"><span class="hs-identifier hs-var">addValBind</span></a></span><span> </span><span class="annot"><span class="annottext">ValBind
</span><a href="#local-6989586621684523115"><span class="hs-identifier hs-var">dec</span></a></span><span>
</span><span id="line-1040"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1041"></span><span>    </span><span id="local-6989586621684523113"><span class="annot"><span class="annottext">dims' :: [TypeParamBase VName]
</span><a href="#local-6989586621684523113"><span class="hs-identifier hs-var hs-var">dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; TypeParamBase VName) -&gt; [VName] -&gt; [TypeParamBase VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SrcLoc -&gt; TypeParamBase VName
forall vn. vn -&gt; SrcLoc -&gt; TypeParamBase vn
</span><a href="Language.Futhark.Syntax.html#TypeParamDim"><span class="hs-operator hs-var">`TypeParamDim`</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523118"><span class="hs-identifier hs-var">dims</span></a></span><span>
</span><span id="line-1042"></span><span>    </span><span class="hs-comment">-- FIXME: this pass is still not correctly size-preserving, so</span><span>
</span><span id="line-1043"></span><span>    </span><span class="hs-comment">-- forget those return sizes that we forgot to propagate along</span><span>
</span><span id="line-1044"></span><span>    </span><span class="hs-comment">-- the way.  Hopefully the internaliser is conservative and</span><span>
</span><span id="line-1045"></span><span>    </span><span class="hs-comment">-- will insert reshapes...</span><span>
</span><span id="line-1046"></span><span>    </span><span id="local-6989586621684523102"><span class="annot"><span class="annottext">bound_here :: Set VName
</span><a href="#local-6989586621684523102"><span class="hs-identifier hs-var hs-var">bound_here</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523118"><span class="hs-identifier hs-var">dims</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(IdentBase Info VName -&gt; VName)
-&gt; Set (IdentBase Info VName) -&gt; Set VName
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName -&gt; VName
forall (f :: * -&gt; *) vn. IdentBase f vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; Set (IdentBase Info VName))
-&gt; [PatBase Info VName] -&gt; Set (IdentBase Info VName)
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Set (IdentBase Info VName)
forall (f :: * -&gt; *) vn.
(Functor f, Ord vn) =&gt;
PatBase f vn -&gt; Set (IdentBase f vn)
</span><a href="Language.Futhark.Prop.html#patIdents"><span class="hs-identifier hs-var">patIdents</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523117"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1047"></span><span>    </span><span id="local-6989586621684523100"><span class="annot"><span class="annottext">mkExt :: VName -&gt; Maybe VName
</span><a href="#local-6989586621684523100"><span class="hs-identifier hs-var hs-var">mkExt</span></a></span></span><span> </span><span id="local-6989586621684523099"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523099"><span class="hs-identifier hs-var">v</span></a></span></span><span>
</span><span id="line-1048"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523099"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523102"><span class="hs-identifier hs-var">bound_here</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe VName
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523099"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1049"></span><span>    </span><span class="annot"><a href="#local-6989586621684523100"><span class="hs-identifier hs-var">mkExt</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe VName
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1050"></span><span>    </span><span id="local-6989586621684523098"><span class="annot"><span class="annottext">rettype_st :: StructRetType
</span><a href="#local-6989586621684523098"><span class="hs-identifier hs-var hs-var">rettype_st</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; Maybe VName) -&gt; [VName] -&gt; [VName]
forall a b. (a -&gt; Maybe b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">mapMaybe</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Maybe VName
</span><a href="#local-6989586621684523100"><span class="hs-identifier hs-var">mkExt</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set VName -&gt; [VName]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; Set VName
forall als. TypeBase (DimDecl VName) als -&gt; Set VName
</span><a href="Language.Futhark.Prop.html#typeDimNames"><span class="hs-identifier hs-var">typeDimNames</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523119"><span class="hs-identifier hs-var">ret</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523120"><span class="hs-identifier hs-var">ret_dims</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684523119"><span class="hs-identifier hs-var">ret</span></a></span><span>
</span><span id="line-1051"></span><span>
</span><span id="line-1052"></span><span>    </span><span id="local-6989586621684523115"><span class="annot"><span class="annottext">dec :: ValBind
</span><a href="#local-6989586621684523115"><span class="hs-identifier hs-var hs-var">dec</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1053"></span><span>      </span><span class="annot"><span class="annottext">ValBind :: forall (f :: * -&gt; *) vn.
Maybe (f EntryPoint)
-&gt; vn
-&gt; Maybe (TypeExp vn)
-&gt; f StructRetType
-&gt; [TypeParamBase vn]
-&gt; [PatBase f vn]
-&gt; ExpBase f vn
-&gt; Maybe DocComment
-&gt; [AttrInfo vn]
-&gt; SrcLoc
-&gt; ValBindBase f vn
</span><a href="Language.Futhark.Syntax.html#ValBind"><span class="hs-identifier hs-type">ValBind</span></a></span><span>
</span><span id="line-1054"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">valBindEntryPoint :: Maybe (Info EntryPoint)
</span><a href="Language.Futhark.Syntax.html#valBindEntryPoint"><span class="hs-identifier hs-var">valBindEntryPoint</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (Info EntryPoint)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-1055"></span><span>          </span><span class="annot"><span class="annottext">valBindName :: VName
</span><a href="Language.Futhark.Syntax.html#valBindName"><span class="hs-identifier hs-var">valBindName</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523121"><span class="hs-identifier hs-var">fname</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1056"></span><span>          </span><span class="annot"><span class="annottext">valBindRetDecl :: Maybe (TypeExp VName)
</span><a href="Language.Futhark.Syntax.html#valBindRetDecl"><span class="hs-identifier hs-var">valBindRetDecl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (TypeExp VName)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-1057"></span><span>          </span><span class="annot"><span class="annottext">valBindRetType :: Info StructRetType
</span><a href="Language.Futhark.Syntax.html#valBindRetType"><span class="hs-identifier hs-var">valBindRetType</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StructRetType -&gt; Info StructRetType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684523098"><span class="hs-identifier hs-var">rettype_st</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1058"></span><span>          </span><span class="annot"><span class="annottext">valBindTypeParams :: [TypeParamBase VName]
</span><a href="Language.Futhark.Syntax.html#valBindTypeParams"><span class="hs-identifier hs-var">valBindTypeParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[TypeParamBase VName]
</span><a href="#local-6989586621684523113"><span class="hs-identifier hs-var">dims'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1059"></span><span>          </span><span class="annot"><span class="annottext">valBindParams :: [PatBase Info VName]
</span><a href="Language.Futhark.Syntax.html#valBindParams"><span class="hs-identifier hs-var">valBindParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523117"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1060"></span><span>          </span><span class="annot"><span class="annottext">valBindBody :: Exp
</span><a href="Language.Futhark.Syntax.html#valBindBody"><span class="hs-identifier hs-var">valBindBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684523116"><span class="hs-identifier hs-var">body</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1061"></span><span>          </span><span class="annot"><span class="annottext">valBindDoc :: Maybe DocComment
</span><a href="Language.Futhark.Syntax.html#valBindDoc"><span class="hs-identifier hs-var">valBindDoc</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe DocComment
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span class="hs-special">,</span><span>
</span><span id="line-1062"></span><span>          </span><span class="annot"><span class="annottext">valBindAttrs :: [AttrInfo VName]
</span><a href="Language.Futhark.Syntax.html#valBindAttrs"><span class="hs-identifier hs-var">valBindAttrs</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[AttrInfo VName]
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span>
</span><span id="line-1063"></span><span>          </span><span class="annot"><span class="annottext">valBindLocation :: SrcLoc
</span><a href="Language.Futhark.Syntax.html#valBindLocation"><span class="hs-identifier hs-var">valBindLocation</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1064"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-1065"></span><span>
</span><span id="line-1066"></span><span class="hs-comment">-- | Given a closure environment, construct a record pattern that</span><span>
</span><span id="line-1067"></span><span class="hs-comment">-- binds the closed over variables.  Insert wildcard for any patterns</span><span>
</span><span id="line-1068"></span><span class="hs-comment">-- that would otherwise clash with size parameters.</span><span>
</span><span id="line-1069"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#buildEnvPat"><span class="hs-identifier hs-type">buildEnvPat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span>
</span><span id="line-1070"></span><span id="buildEnvPat"><span class="annot"><span class="annottext">buildEnvPat :: [VName] -&gt; Env -&gt; PatBase Info VName
</span><a href="Futhark.Internalise.Defunctionalise.html#buildEnvPat"><span class="hs-identifier hs-var hs-var">buildEnvPat</span></a></span></span><span> </span><span id="local-6989586621684523082"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523082"><span class="hs-identifier hs-var">sizes</span></a></span></span><span> </span><span id="local-6989586621684523081"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523081"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, PatBase Info VName)] -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn.
[(Name, PatBase f vn)] -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#RecordPat"><span class="hs-identifier hs-var">RecordPat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((VName, Binding) -&gt; (Name, PatBase Info VName))
-&gt; [(VName, Binding)] -&gt; [(Name, PatBase Info VName)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(VName, Binding) -&gt; (Name, PatBase Info VName)
</span><a href="#local-6989586621684523080"><span class="hs-identifier hs-var">buildField</span></a></span><span> </span><span class="annot"><span class="annottext">([(VName, Binding)] -&gt; [(Name, PatBase Info VName)])
-&gt; [(VName, Binding)] -&gt; [(Name, PatBase Info VName)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Env -&gt; [(VName, Binding)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523081"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1071"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1072"></span><span>    </span><span id="local-6989586621684523080"><span class="annot"><span class="annottext">buildField :: (VName, Binding) -&gt; (Name, PatBase Info VName)
</span><a href="#local-6989586621684523080"><span class="hs-identifier hs-var hs-var">buildField</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523074"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523074"><span class="hs-identifier hs-var">vn</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-type">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523073"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523073"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1073"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523074"><span class="hs-identifier hs-var">vn</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-1074"></span><span>        </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523074"><span class="hs-identifier hs-var">vn</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; [VName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><span class="hs-operator hs-var">`elem`</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684523082"><span class="hs-identifier hs-var">sizes</span></a></span><span>
</span><span id="line-1075"></span><span>          </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Info PatType -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn. f PatType -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#Wildcard"><span class="hs-identifier hs-var">Wildcard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; Info PatType) -&gt; PatType -&gt; Info PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523073"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1076"></span><span>          </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">VName -&gt; Info PatType -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn. vn -&gt; f PatType -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#Id"><span class="hs-identifier hs-var">Id</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523074"><span class="hs-identifier hs-var">vn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; Info PatType) -&gt; PatType -&gt; Info PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523073"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1077"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-1078"></span><span>
</span><span id="line-1079"></span><span class="hs-comment">-- | Given a closure environment pattern and the type of a term,</span><span>
</span><span id="line-1080"></span><span class="hs-comment">-- construct the type of that term, where uniqueness is set to</span><span>
</span><span id="line-1081"></span><span class="hs-comment">-- `Nonunique` for those arrays that are bound in the environment or</span><span>
</span><span id="line-1082"></span><span class="hs-comment">-- pattern (except if they are unique there).  This ensures that a</span><span>
</span><span id="line-1083"></span><span class="hs-comment">-- lifted function can create unique arrays as long as they do not</span><span>
</span><span id="line-1084"></span><span class="hs-comment">-- alias any of its parameters.  XXX: it is not clear that this is a</span><span>
</span><span id="line-1085"></span><span class="hs-comment">-- sufficient property, unfortunately.</span><span>
</span><span id="line-1086"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#buildRetType"><span class="hs-identifier hs-type">buildRetType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#StructType"><span class="hs-identifier hs-type">StructType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span>
</span><span id="line-1087"></span><span id="buildRetType"><span class="annot"><span class="annottext">buildRetType :: Env -&gt; [PatBase Info VName] -&gt; StructType -&gt; PatType -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#buildRetType"><span class="hs-identifier hs-var hs-var">buildRetType</span></a></span></span><span> </span><span id="local-6989586621684523072"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523072"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621684523071"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523071"><span class="hs-identifier hs-var">pats</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StructType -&gt; PatType -&gt; PatType
forall {t :: * -&gt; *} {shape} {as}.
(Foldable t, Monoid (t Alias)) =&gt;
TypeBase shape as
-&gt; TypeBase shape (t Alias) -&gt; TypeBase shape (t Alias)
</span><a href="#local-6989586621684523070"><span class="hs-identifier hs-var">comb</span></a></span><span>
</span><span id="line-1088"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1089"></span><span>    </span><span id="local-6989586621684523060"><span class="annot"><span class="annottext">bound :: Set VName
</span><a href="#local-6989586621684523060"><span class="hs-identifier hs-var hs-var">bound</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1090"></span><span>      </span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Env -&gt; [VName]
forall k a. Map k a -&gt; [k]
</span><span class="hs-identifier hs-var">M.keys</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523072"><span class="hs-identifier hs-var">env</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">(IdentBase Info VName -&gt; VName)
-&gt; Set (IdentBase Info VName) -&gt; Set VName
forall b a. Ord b =&gt; (a -&gt; b) -&gt; Set a -&gt; Set b
</span><span class="hs-identifier hs-var">S.map</span></span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName -&gt; VName
forall (f :: * -&gt; *) vn. IdentBase f vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; Set (IdentBase Info VName))
-&gt; [PatBase Info VName] -&gt; Set (IdentBase Info VName)
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Set (IdentBase Info VName)
forall (f :: * -&gt; *) vn.
(Functor f, Ord vn) =&gt;
PatBase f vn -&gt; Set (IdentBase f vn)
</span><a href="Language.Futhark.Prop.html#patIdents"><span class="hs-identifier hs-var">patIdents</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523071"><span class="hs-identifier hs-var">pats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1091"></span><span>    </span><span id="local-6989586621684523051"><span class="annot"><span class="annottext">boundAsUnique :: VName -&gt; Bool
</span><a href="#local-6989586621684523051"><span class="hs-identifier hs-var hs-var">boundAsUnique</span></a></span></span><span> </span><span id="local-6989586621684523050"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523050"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1092"></span><span>      </span><span class="annot"><span class="annottext">Bool
-&gt; (IdentBase Info VName -&gt; Bool)
-&gt; Maybe (IdentBase Info VName)
-&gt; Bool
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><span class="hs-identifier hs-var">maybe</span></span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Bool
forall dim as. TypeBase dim as -&gt; Bool
</span><a href="Language.Futhark.Prop.html#unique"><span class="hs-identifier hs-var">unique</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; Bool)
-&gt; (IdentBase Info VName -&gt; PatType)
-&gt; IdentBase Info VName
-&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Info PatType -&gt; PatType
forall a. Info a -&gt; a
</span><a href="Language.Futhark.Syntax.html#unInfo"><span class="hs-identifier hs-var hs-var">unInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(Info PatType -&gt; PatType)
-&gt; (IdentBase Info VName -&gt; Info PatType)
-&gt; IdentBase Info VName
-&gt; PatType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName -&gt; Info PatType
forall (f :: * -&gt; *) vn. IdentBase f vn -&gt; f PatType
</span><a href="Language.Futhark.Syntax.html#identType"><span class="hs-identifier hs-var hs-var">identType</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(Maybe (IdentBase Info VName) -&gt; Bool)
-&gt; Maybe (IdentBase Info VName) -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1093"></span><span>        </span><span class="annot"><span class="annottext">(IdentBase Info VName -&gt; Bool)
-&gt; [IdentBase Info VName] -&gt; Maybe (IdentBase Info VName)
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Maybe a
</span><span class="hs-identifier hs-var">find</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; VName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523050"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool)
-&gt; (IdentBase Info VName -&gt; VName) -&gt; IdentBase Info VName -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">IdentBase Info VName -&gt; VName
forall (f :: * -&gt; *) vn. IdentBase f vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#identName"><span class="hs-identifier hs-var hs-var">identName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([IdentBase Info VName] -&gt; Maybe (IdentBase Info VName))
-&gt; [IdentBase Info VName] -&gt; Maybe (IdentBase Info VName)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set (IdentBase Info VName) -&gt; [IdentBase Info VName]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set (IdentBase Info VName) -&gt; [IdentBase Info VName])
-&gt; Set (IdentBase Info VName) -&gt; [IdentBase Info VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; Set (IdentBase Info VName))
-&gt; [PatBase Info VName] -&gt; Set (IdentBase Info VName)
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Set (IdentBase Info VName)
forall (f :: * -&gt; *) vn.
(Functor f, Ord vn) =&gt;
PatBase f vn -&gt; Set (IdentBase f vn)
</span><a href="Language.Futhark.Prop.html#patIdents"><span class="hs-identifier hs-var">patIdents</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684523071"><span class="hs-identifier hs-var">pats</span></a></span><span>
</span><span id="line-1094"></span><span>    </span><span id="local-6989586621684523045"><span class="annot"><span class="annottext">problematic :: VName -&gt; Bool
</span><a href="#local-6989586621684523045"><span class="hs-identifier hs-var hs-var">problematic</span></a></span></span><span> </span><span id="local-6989586621684523044"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523044"><span class="hs-identifier hs-var">v</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523044"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684523060"><span class="hs-identifier hs-var">bound</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><span class="hs-operator hs-var">&amp;&amp;</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><span class="hs-identifier hs-var">not</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Bool
</span><a href="#local-6989586621684523051"><span class="hs-identifier hs-var">boundAsUnique</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684523044"><span class="hs-identifier hs-var">v</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1095"></span><span>    </span><span id="local-6989586621684523070"><span class="annot"><span class="annottext">comb :: TypeBase shape as
-&gt; TypeBase shape (t Alias) -&gt; TypeBase shape (t Alias)
</span><a href="#local-6989586621684523070"><span class="hs-identifier hs-var hs-var">comb</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684523033"><span class="annot"><span class="annottext">Map Name (TypeBase shape as)
</span><a href="#local-6989586621684523033"><span class="hs-identifier hs-var">fs_annot</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684523032"><span class="annot"><span class="annottext">Map Name (TypeBase shape (t Alias))
</span><a href="#local-6989586621684523032"><span class="hs-identifier hs-var">fs_got</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1096"></span><span>      </span><span class="annot"><span class="annottext">ScalarTypeBase shape (t Alias) -&gt; TypeBase shape (t Alias)
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase shape (t Alias) -&gt; TypeBase shape (t Alias))
-&gt; ScalarTypeBase shape (t Alias) -&gt; TypeBase shape (t Alias)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase shape (t Alias))
-&gt; ScalarTypeBase shape (t Alias)
forall dim as. Map Name (TypeBase dim as) -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-var">Record</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name (TypeBase shape (t Alias))
 -&gt; ScalarTypeBase shape (t Alias))
-&gt; Map Name (TypeBase shape (t Alias))
-&gt; ScalarTypeBase shape (t Alias)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase shape as
 -&gt; TypeBase shape (t Alias) -&gt; TypeBase shape (t Alias))
-&gt; Map Name (TypeBase shape as)
-&gt; Map Name (TypeBase shape (t Alias))
-&gt; Map Name (TypeBase shape (t Alias))
forall k a b c.
Ord k =&gt;
(a -&gt; b -&gt; c) -&gt; Map k a -&gt; Map k b -&gt; Map k c
</span><span class="hs-identifier hs-var">M.intersectionWith</span></span><span> </span><span class="annot"><span class="annottext">TypeBase shape as
-&gt; TypeBase shape (t Alias) -&gt; TypeBase shape (t Alias)
</span><a href="#local-6989586621684523070"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase shape as)
</span><a href="#local-6989586621684523033"><span class="hs-identifier hs-var">fs_annot</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase shape (t Alias))
</span><a href="#local-6989586621684523032"><span class="hs-identifier hs-var">fs_got</span></a></span><span>
</span><span id="line-1097"></span><span>    </span><span class="annot"><a href="#local-6989586621684523070"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span id="local-6989586621684523031"><span class="annot"><span class="annottext">Map Name [TypeBase shape as]
</span><a href="#local-6989586621684523031"><span class="hs-identifier hs-var">cs_annot</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span id="local-6989586621684523030"><span class="annot"><span class="annottext">Map Name [TypeBase shape (t Alias)]
</span><a href="#local-6989586621684523030"><span class="hs-identifier hs-var">cs_got</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1098"></span><span>      </span><span class="annot"><span class="annottext">ScalarTypeBase shape (t Alias) -&gt; TypeBase shape (t Alias)
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase shape (t Alias) -&gt; TypeBase shape (t Alias))
-&gt; ScalarTypeBase shape (t Alias) -&gt; TypeBase shape (t Alias)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase shape (t Alias)]
-&gt; ScalarTypeBase shape (t Alias)
forall dim as. Map Name [TypeBase dim as] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-var">Sum</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name [TypeBase shape (t Alias)]
 -&gt; ScalarTypeBase shape (t Alias))
-&gt; Map Name [TypeBase shape (t Alias)]
-&gt; ScalarTypeBase shape (t Alias)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([TypeBase shape as]
 -&gt; [TypeBase shape (t Alias)] -&gt; [TypeBase shape (t Alias)])
-&gt; Map Name [TypeBase shape as]
-&gt; Map Name [TypeBase shape (t Alias)]
-&gt; Map Name [TypeBase shape (t Alias)]
forall k a b c.
Ord k =&gt;
(a -&gt; b -&gt; c) -&gt; Map k a -&gt; Map k b -&gt; Map k c
</span><span class="hs-identifier hs-var">M.intersectionWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeBase shape as
 -&gt; TypeBase shape (t Alias) -&gt; TypeBase shape (t Alias))
-&gt; [TypeBase shape as]
-&gt; [TypeBase shape (t Alias)]
-&gt; [TypeBase shape (t Alias)]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">TypeBase shape as
-&gt; TypeBase shape (t Alias) -&gt; TypeBase shape (t Alias)
</span><a href="#local-6989586621684523070"><span class="hs-identifier hs-var">comb</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase shape as]
</span><a href="#local-6989586621684523031"><span class="hs-identifier hs-var">cs_annot</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase shape (t Alias)]
</span><a href="#local-6989586621684523030"><span class="hs-identifier hs-var">cs_got</span></a></span><span>
</span><span id="line-1099"></span><span>    </span><span class="annot"><a href="#local-6989586621684523070"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684523028"><span class="annot"><span class="annottext">TypeBase shape (t Alias)
</span><a href="#local-6989586621684523028"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1100"></span><span>      </span><span class="annot"><span class="annottext">TypeBase shape (t Alias) -&gt; TypeBase shape (t Alias)
forall {t :: * -&gt; *} {dim}.
(Foldable t, Monoid (t Alias)) =&gt;
TypeBase dim (t Alias) -&gt; TypeBase dim (t Alias)
</span><a href="#local-6989586621684523027"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase shape (t Alias)
</span><a href="#local-6989586621684523028"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1101"></span><span>    </span><span class="annot"><a href="#local-6989586621684523070"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span id="local-6989586621684523026"><span class="annot"><span class="annottext">TypeBase shape as
</span><a href="#local-6989586621684523026"><span class="hs-identifier hs-var">got</span></a></span></span><span> </span><span id="local-6989586621684523025"><span class="annot"><span class="annottext">TypeBase shape (t Alias)
</span><a href="#local-6989586621684523025"><span class="hs-identifier hs-var">et</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1102"></span><span>      </span><span class="annot"><span class="annottext">TypeBase shape (t Alias) -&gt; TypeBase shape (t Alias)
forall {t :: * -&gt; *} {dim}.
(Foldable t, Monoid (t Alias)) =&gt;
TypeBase dim (t Alias) -&gt; TypeBase dim (t Alias)
</span><a href="#local-6989586621684523027"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="annot"><span class="annottext">(TypeBase shape (t Alias) -&gt; TypeBase shape (t Alias))
-&gt; TypeBase shape (t Alias) -&gt; TypeBase shape (t Alias)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeBase shape as -&gt; TypeBase shape (Set Alias)
forall dim as. TypeBase dim as -&gt; TypeBase dim (Set Alias)
</span><a href="Language.Futhark.Prop.html#fromStruct"><span class="hs-identifier hs-var">fromStruct</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase shape as
</span><a href="#local-6989586621684523026"><span class="hs-identifier hs-var">got</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase shape (Set Alias) -&gt; t Alias -&gt; TypeBase shape (t Alias)
forall dim asf ast. TypeBase dim asf -&gt; ast -&gt; TypeBase dim ast
</span><a href="Language.Futhark.Prop.html#setAliases"><span class="hs-operator hs-var">`setAliases`</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase shape (t Alias) -&gt; t Alias
forall as shape. Monoid as =&gt; TypeBase shape as -&gt; as
</span><a href="Language.Futhark.Prop.html#aliases"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase shape (t Alias)
</span><a href="#local-6989586621684523025"><span class="hs-identifier hs-var">et</span></a></span><span>
</span><span id="line-1103"></span><span>
</span><span id="line-1104"></span><span>    </span><span id="local-6989586621684523027"><span class="annot"><span class="annottext">descend :: TypeBase dim (t Alias) -&gt; TypeBase dim (t Alias)
</span><a href="#local-6989586621684523027"><span class="hs-identifier hs-var hs-var">descend</span></a></span></span><span> </span><span id="local-6989586621684523018"><span class="annot"><span class="annottext">t :: TypeBase dim (t Alias)
</span><a href="#local-6989586621684523018"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Language.Futhark.Syntax.html#Array"><span class="hs-identifier hs-type">Array</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span>
</span><span id="line-1105"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">(Alias -&gt; Bool) -&gt; t Alias -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Bool
</span><a href="#local-6989586621684523045"><span class="hs-identifier hs-var">problematic</span></a></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; (Alias -&gt; VName) -&gt; Alias -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Alias -&gt; VName
</span><a href="Language.Futhark.Syntax.html#aliasVar"><span class="hs-identifier hs-var hs-var">aliasVar</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TypeBase dim (t Alias) -&gt; t Alias
forall as shape. Monoid as =&gt; TypeBase shape as -&gt; as
</span><a href="Language.Futhark.Prop.html#aliases"><span class="hs-identifier hs-var">aliases</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim (t Alias)
</span><a href="#local-6989586621684523018"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeBase dim (t Alias)
</span><a href="#local-6989586621684523018"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">TypeBase dim (t Alias) -&gt; Uniqueness -&gt; TypeBase dim (t Alias)
forall dim as. TypeBase dim as -&gt; Uniqueness -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#setUniqueness"><span class="hs-operator hs-var">`setUniqueness`</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span>
</span><span id="line-1106"></span><span>    </span><span class="annot"><a href="#local-6989586621684523027"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684523015"><span class="annot"><span class="annottext">Map Name (TypeBase dim (t Alias))
</span><a href="#local-6989586621684523015"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase dim (t Alias) -&gt; TypeBase dim (t Alias)
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase dim (t Alias) -&gt; TypeBase dim (t Alias))
-&gt; ScalarTypeBase dim (t Alias) -&gt; TypeBase dim (t Alias)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim (t Alias)) -&gt; ScalarTypeBase dim (t Alias)
forall dim as. Map Name (TypeBase dim as) -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-var">Record</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name (TypeBase dim (t Alias)) -&gt; ScalarTypeBase dim (t Alias))
-&gt; Map Name (TypeBase dim (t Alias))
-&gt; ScalarTypeBase dim (t Alias)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase dim (t Alias) -&gt; TypeBase dim (t Alias))
-&gt; Map Name (TypeBase dim (t Alias))
-&gt; Map Name (TypeBase dim (t Alias))
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">TypeBase dim (t Alias) -&gt; TypeBase dim (t Alias)
</span><a href="#local-6989586621684523027"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim (t Alias))
</span><a href="#local-6989586621684523015"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1107"></span><span>    </span><span class="annot"><a href="#local-6989586621684523027"><span class="hs-identifier hs-var">descend</span></a></span><span> </span><span id="local-6989586621684523014"><span class="annot"><span class="annottext">TypeBase dim (t Alias)
</span><a href="#local-6989586621684523014"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeBase dim (t Alias)
</span><a href="#local-6989586621684523014"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1108"></span><span>
</span><span id="line-1109"></span><span class="hs-comment">-- | Compute the corresponding type for the *representation* of a</span><span>
</span><span id="line-1110"></span><span class="hs-comment">-- given static value (not the original possibly higher-order value).</span><span>
</span><span id="line-1111"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-type">typeFromSV</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span>
</span><span id="line-1112"></span><span id="typeFromSV"><span class="annot"><span class="annottext">typeFromSV :: StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var hs-var">typeFromSV</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a></span><span> </span><span id="local-6989586621684523013"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523013"><span class="hs-identifier hs-var">tp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1113"></span><span>  </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523013"><span class="hs-identifier hs-var">tp</span></a></span><span>
</span><span id="line-1114"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#LambdaSV"><span class="hs-identifier hs-type">LambdaSV</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">ExtExp
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523012"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523012"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1115"></span><span>  </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType)
-&gt; ([(Name, PatType)]
    -&gt; ScalarTypeBase (DimDecl VName) (Set Alias))
-&gt; [(Name, PatType)]
-&gt; PatType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map Name PatType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall dim as. Map Name (TypeBase dim as) -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-var">Record</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name PatType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias))
-&gt; ([(Name, PatType)] -&gt; Map Name PatType)
-&gt; [(Name, PatType)]
-&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">[(Name, PatType)] -&gt; Map Name PatType
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(Name, PatType)] -&gt; PatType) -&gt; [(Name, PatType)] -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1116"></span><span>    </span><span class="annot"><span class="annottext">((VName, Binding) -&gt; (Name, PatType))
-&gt; [(VName, Binding)] -&gt; [(Name, PatType)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(VName -&gt; Name)
-&gt; (Binding -&gt; PatType) -&gt; (VName, Binding) -&gt; (Name, PatType)
forall (p :: * -&gt; * -&gt; *) a b c d.
Bifunctor p =&gt;
(a -&gt; b) -&gt; (c -&gt; d) -&gt; p a c -&gt; p b d
</span><span class="hs-identifier hs-var">bimap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; Name
</span><a href="Language.Futhark.Core.html#nameFromString"><span class="hs-identifier hs-var">nameFromString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Name) -&gt; (VName -&gt; String) -&gt; VName -&gt; Name
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; PatType)
-&gt; (Binding -&gt; StaticVal) -&gt; Binding -&gt; PatType
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Binding -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#bindingSV"><span class="hs-identifier hs-var">bindingSV</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([(VName, Binding)] -&gt; [(Name, PatType)])
-&gt; [(VName, Binding)] -&gt; [(Name, PatType)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1117"></span><span>      </span><span class="annot"><span class="annottext">Env -&gt; [(VName, Binding)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684523012"><span class="hs-identifier hs-var">env</span></a></span><span>
</span><span id="line-1118"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-type">RecordSV</span></a></span><span> </span><span id="local-6989586621684523010"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684523010"><span class="hs-identifier hs-var">ls</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1119"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523008"><span class="annot"><span class="annottext">ts :: [(Name, PatType)]
</span><a href="#local-6989586621684523008"><span class="hs-identifier hs-var hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, StaticVal) -&gt; (Name, PatType))
-&gt; [(Name, StaticVal)] -&gt; [(Name, PatType)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(StaticVal -&gt; PatType) -&gt; (Name, StaticVal) -&gt; (Name, PatType)
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684523010"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-1120"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType)
-&gt; ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Name PatType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall dim as. Map Name (TypeBase dim as) -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-var">Record</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name PatType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias))
-&gt; Map Name PatType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Name, PatType)] -&gt; Map Name PatType
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, PatType)]
</span><a href="#local-6989586621684523008"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-1121"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-type">DynamicFun</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Exp
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684523007"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523007"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1122"></span><span>  </span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523007"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-1123"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SumSV"><span class="hs-identifier hs-type">SumSV</span></a></span><span> </span><span id="local-6989586621684523006"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523006"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684523005"><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684523005"><span class="hs-identifier hs-var">svs</span></a></span></span><span> </span><span id="local-6989586621684523004"><span class="annot"><span class="annottext">[(Name, [PatType])]
</span><a href="#local-6989586621684523004"><span class="hs-identifier hs-var">fields</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1124"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684523003"><span class="annot"><span class="annottext">svs' :: [PatType]
</span><a href="#local-6989586621684523003"><span class="hs-identifier hs-var hs-var">svs'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; PatType) -&gt; [StaticVal] -&gt; [PatType]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684523005"><span class="hs-identifier hs-var">svs</span></a></span><span>
</span><span id="line-1125"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType)
-&gt; ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Name [PatType] -&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall dim as. Map Name [TypeBase dim as] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-var">Sum</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name [PatType] -&gt; ScalarTypeBase (DimDecl VName) (Set Alias))
-&gt; Map Name [PatType] -&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; [PatType] -&gt; Map Name [PatType] -&gt; Map Name [PatType]
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.insert</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684523006"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523003"><span class="hs-identifier hs-var">svs'</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name [PatType] -&gt; Map Name [PatType])
-&gt; Map Name [PatType] -&gt; Map Name [PatType]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[(Name, [PatType])] -&gt; Map Name [PatType]
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">[(Name, [PatType])]
</span><a href="#local-6989586621684523004"><span class="hs-identifier hs-var">fields</span></a></span><span>
</span><span id="line-1126"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#IntrinsicSV"><span class="hs-identifier hs-var">IntrinsicSV</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1127"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; PatType
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Tried to get the type from the static value of an intrinsic.&quot;</span></span><span>
</span><span id="line-1128"></span><span>
</span><span id="line-1129"></span><span class="hs-comment">-- | Construct the type for a fully-applied dynamic function from its</span><span>
</span><span id="line-1130"></span><span class="hs-comment">-- static value and the original types of its arguments.</span><span>
</span><span id="line-1131"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#dynamicFunType"><span class="hs-identifier hs-type">dynamicFunType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1132"></span><span id="dynamicFunType"><span class="annot"><span class="annottext">dynamicFunType :: StaticVal -&gt; [PatType] -&gt; ([PatType], PatType)
</span><a href="Futhark.Internalise.Defunctionalise.html#dynamicFunType"><span class="hs-identifier hs-var hs-var">dynamicFunType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DynamicFun"><span class="hs-identifier hs-type">DynamicFun</span></a></span><span> </span><span class="annot"><span class="annottext">(Exp, StaticVal)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684523002"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523002"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684523001"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523001"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684523000"><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523000"><span class="hs-identifier hs-var">ps</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1133"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621684522999"><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684522999"><span class="hs-identifier hs-var">ps'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522998"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522998"><span class="hs-identifier hs-var">ret</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; [PatType] -&gt; ([PatType], PatType)
</span><a href="Futhark.Internalise.Defunctionalise.html#dynamicFunType"><span class="hs-identifier hs-var">dynamicFunType</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684523002"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684523000"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684523001"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; [PatType] -&gt; [PatType]
forall a. a -&gt; [a] -&gt; [a]
</span><span class="hs-glyph hs-var">:</span></span><span> </span><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684522999"><span class="hs-identifier hs-var">ps'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522998"><span class="hs-identifier hs-var">ret</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1134"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#dynamicFunType"><span class="hs-identifier hs-var">dynamicFunType</span></a></span><span> </span><span id="local-6989586621684522997"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522997"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="annot"><span class="annottext">[PatType]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522997"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1135"></span><span>
</span><span id="line-1136"></span><span class="hs-comment">-- | Match a pattern with its static value. Returns an environment with</span><span>
</span><span id="line-1137"></span><span class="hs-comment">-- the identifier components of the pattern mapped to the corresponding</span><span>
</span><span id="line-1138"></span><span class="hs-comment">-- subcomponents of the static value.</span><span>
</span><span id="line-1139"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-type">matchPatSV</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatBase"><span class="hs-identifier hs-type">PatBase</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Core.html#VName"><span class="hs-identifier hs-type">VName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span>
</span><span id="line-1140"></span><span id="matchPatSV"><span class="annot"><span class="annottext">matchPatSV :: PatBase Info VName -&gt; StaticVal -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var hs-var">matchPatSV</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TuplePat"><span class="hs-identifier hs-type">TuplePat</span></a></span><span> </span><span id="local-6989586621684522996"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522996"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-type">RecordSV</span></a></span><span> </span><span id="local-6989586621684522995"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522995"><span class="hs-identifier hs-var">ls</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1141"></span><span>  </span><span class="annot"><span class="annottext">[Env] -&gt; Env
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Env] -&gt; Env) -&gt; [Env] -&gt; Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; (Name, StaticVal) -&gt; Env)
-&gt; [PatBase Info VName] -&gt; [(Name, StaticVal)] -&gt; [Env]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621684522994"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522994"><span class="hs-identifier hs-var">p</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522993"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522993"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522994"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522993"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522996"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522995"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-1142"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RecordPat"><span class="hs-identifier hs-type">RecordPat</span></a></span><span> </span><span id="local-6989586621684522992"><span class="annot"><span class="annottext">[(Name, PatBase Info VName)]
</span><a href="#local-6989586621684522992"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-type">RecordSV</span></a></span><span> </span><span id="local-6989586621684522991"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522991"><span class="hs-identifier hs-var">ls</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1143"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684522990"><span class="annot"><span class="annottext">[(Name, PatBase Info VName)]
</span><a href="#local-6989586621684522990"><span class="hs-identifier hs-var">ps'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Name, PatBase Info VName) -&gt; Name)
-&gt; [(Name, PatBase Info VName)] -&gt; [(Name, PatBase Info VName)]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="annot"><span class="annottext">(Name, PatBase Info VName) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Name, PatBase Info VName)]
</span><a href="#local-6989586621684522992"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1144"></span><span>    </span><span id="local-6989586621684522989"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522989"><span class="hs-identifier hs-var">ls'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Name, StaticVal) -&gt; Name)
-&gt; [(Name, StaticVal)] -&gt; [(Name, StaticVal)]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="annot"><span class="annottext">(Name, StaticVal) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522991"><span class="hs-identifier hs-var">ls</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1145"></span><span>    </span><span class="annot"><span class="annottext">((Name, PatBase Info VName) -&gt; Name)
-&gt; [(Name, PatBase Info VName)] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, PatBase Info VName) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Name, PatBase Info VName)]
</span><a href="#local-6989586621684522990"><span class="hs-identifier hs-var">ps'</span></a></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Name] -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">((Name, StaticVal) -&gt; Name) -&gt; [(Name, StaticVal)] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, StaticVal) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522989"><span class="hs-identifier hs-var">ls'</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1146"></span><span>    </span><span class="annot"><span class="annottext">[Env] -&gt; Env
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Env] -&gt; Env) -&gt; [Env] -&gt; Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Name, PatBase Info VName) -&gt; (Name, StaticVal) -&gt; Env)
-&gt; [(Name, PatBase Info VName)] -&gt; [(Name, StaticVal)] -&gt; [Env]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522988"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522988"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522987"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522987"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522988"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522987"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, PatBase Info VName)]
</span><a href="#local-6989586621684522990"><span class="hs-identifier hs-var">ps'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522989"><span class="hs-identifier hs-var">ls'</span></a></span><span>
</span><span id="line-1147"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatParens"><span class="hs-identifier hs-type">PatParens</span></a></span><span> </span><span id="local-6989586621684522986"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522986"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522985"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522985"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522986"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522985"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-1148"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatAttr"><span class="hs-identifier hs-type">PatAttr</span></a></span><span> </span><span class="annot"><span class="annottext">AttrInfo VName
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684522984"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522984"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522983"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522983"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522984"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522983"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-1149"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span id="local-6989586621684522982"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522982"><span class="hs-identifier hs-var">vn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684522981"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522981"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522980"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522980"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1150"></span><span>  </span><span class="hs-comment">-- When matching a pattern with a zero-order STaticVal, the type of</span><span>
</span><span id="line-1151"></span><span>  </span><span class="hs-comment">-- the pattern wins out.  This is important when matching a</span><span>
</span><span id="line-1152"></span><span>  </span><span class="hs-comment">-- nonunique pattern with a unique value.</span><span>
</span><span id="line-1153"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; Bool
</span><a href="Futhark.Internalise.Defunctionalise.html#orderZeroSV"><span class="hs-identifier hs-var">orderZeroSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522980"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-1154"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522978"><span class="hs-identifier hs-var">dim_env</span></a></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Env -&gt; Env
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Binding -&gt; Env
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522982"><span class="hs-identifier hs-var">vn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ([VName], StructType) -&gt; StaticVal -&gt; Binding
</span><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; Binding) -&gt; StaticVal -&gt; Binding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522981"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1155"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522978"><span class="hs-identifier hs-var">dim_env</span></a></span><span> </span><span class="annot"><span class="annottext">Env -&gt; Env -&gt; Env
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">VName -&gt; Binding -&gt; Env
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522982"><span class="hs-identifier hs-var">vn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe ([VName], StructType) -&gt; StaticVal -&gt; Binding
</span><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522980"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1156"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1157"></span><span>    </span><span id="local-6989586621684522978"><span class="annot"><span class="annottext">dim_env :: Env
</span><a href="#local-6989586621684522978"><span class="hs-identifier hs-var hs-var">dim_env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1158"></span><span>      </span><span class="annot"><span class="annottext">[(VName, Binding)] -&gt; Env
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(VName, Binding)] -&gt; Env) -&gt; [(VName, Binding)] -&gt; Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(VName -&gt; (VName, Binding)) -&gt; [VName] -&gt; [(VName, Binding)]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-special">,</span></span><span class="annot"><span class="annottext">Binding
</span><a href="#local-6989586621684522976"><span class="hs-identifier hs-var">i64</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [(VName, Binding)]) -&gt; [VName] -&gt; [(VName, Binding)]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; [VName]
forall a. Set a -&gt; [a]
</span><span class="hs-identifier hs-var">S.toList</span></span><span> </span><span class="annot"><span class="annottext">(Set VName -&gt; [VName]) -&gt; Set VName -&gt; [VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Set VName
forall als. TypeBase (DimDecl VName) als -&gt; Set VName
</span><a href="Language.Futhark.Prop.html#typeDimNames"><span class="hs-identifier hs-var">typeDimNames</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522981"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1159"></span><span>    </span><span id="local-6989586621684522976"><span class="annot"><span class="annottext">i64 :: Binding
</span><a href="#local-6989586621684522976"><span class="hs-identifier hs-var hs-var">i64</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType) -&gt; StaticVal -&gt; Binding
</span><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ([VName], StructType)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; Binding) -&gt; StaticVal -&gt; Binding
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; PatType -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType)
-&gt; ScalarTypeBase (DimDecl VName) (Set Alias) -&gt; PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PrimType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall dim as. PrimType -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Prim"><span class="hs-identifier hs-var">Prim</span></a></span><span> </span><span class="annot"><span class="annottext">(PrimType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias))
-&gt; PrimType -&gt; ScalarTypeBase (DimDecl VName) (Set Alias)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">IntType -&gt; PrimType
</span><a href="Language.Futhark.Syntax.html#Signed"><span class="hs-identifier hs-var">Signed</span></a></span><span> </span><span class="annot"><span class="annottext">IntType
</span><a href="Futhark.IR.Primitive.html#Int64"><span class="hs-identifier hs-var">Int64</span></a></span><span>
</span><span id="line-1160"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Wildcard"><span class="hs-identifier hs-type">Wildcard</span></a></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1161"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatAscription"><span class="hs-identifier hs-type">PatAscription</span></a></span><span> </span><span id="local-6989586621684522975"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522975"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522974"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522974"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522975"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522974"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-1162"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatLit"><span class="hs-identifier hs-type">PatLit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span>
</span><span id="line-1163"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatConstr"><span class="hs-identifier hs-type">PatConstr</span></a></span><span> </span><span id="local-6989586621684522973"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522973"><span class="hs-identifier hs-var">c1</span></a></span></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684522972"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522972"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SumSV"><span class="hs-identifier hs-type">SumSV</span></a></span><span> </span><span id="local-6989586621684522971"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522971"><span class="hs-identifier hs-var">c2</span></a></span></span><span> </span><span id="local-6989586621684522970"><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684522970"><span class="hs-identifier hs-var">ls</span></a></span></span><span> </span><span id="local-6989586621684522969"><span class="annot"><span class="annottext">[(Name, [PatType])]
</span><a href="#local-6989586621684522969"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1164"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522973"><span class="hs-identifier hs-var">c1</span></a></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522971"><span class="hs-identifier hs-var">c2</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1165"></span><span>    </span><span class="annot"><span class="annottext">[Env] -&gt; Env
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Env] -&gt; Env) -&gt; [Env] -&gt; Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; StaticVal -&gt; Env)
-&gt; [PatBase Info VName] -&gt; [StaticVal] -&gt; [Env]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522972"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684522970"><span class="hs-identifier hs-var">ls</span></a></span><span>
</span><span id="line-1166"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684522968"><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684522968"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; [(Name, [PatType])] -&gt; Maybe [PatType]
forall a b. Eq a =&gt; a -&gt; [(a, b)] -&gt; Maybe b
</span><span class="hs-identifier hs-var">lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522973"><span class="hs-identifier hs-var">c1</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, [PatType])]
</span><a href="#local-6989586621684522969"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1167"></span><span>    </span><span class="annot"><span class="annottext">[Env] -&gt; Env
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Env] -&gt; Env) -&gt; [Env] -&gt; Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; StaticVal -&gt; Env)
-&gt; [PatBase Info VName] -&gt; [StaticVal] -&gt; [Env]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522972"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">([StaticVal] -&gt; [Env]) -&gt; [StaticVal] -&gt; [Env]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; [PatType] -&gt; [StaticVal]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#svFromType"><span class="hs-identifier hs-var">svFromType</span></a></span><span> </span><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684522968"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-1168"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1169"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Env
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Env) -&gt; String -&gt; Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;matchPatSV: missing constructor in type: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522973"><span class="hs-identifier hs-var">c1</span></a></span><span>
</span><span id="line-1170"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatConstr"><span class="hs-identifier hs-type">PatConstr</span></a></span><span> </span><span id="local-6989586621684522967"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522967"><span class="hs-identifier hs-var">c1</span></a></span></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684522966"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522966"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span id="local-6989586621684522965"><span class="annot"><span class="annottext">Map Name [PatType]
</span><a href="#local-6989586621684522965"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1171"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621684522964"><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684522964"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Name -&gt; Map Name [PatType] -&gt; Maybe [PatType]
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522967"><span class="hs-identifier hs-var">c1</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name [PatType]
</span><a href="#local-6989586621684522965"><span class="hs-identifier hs-var">fs</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1172"></span><span>    </span><span class="annot"><span class="annottext">[Env] -&gt; Env
forall a. Monoid a =&gt; [a] -&gt; a
</span><span class="hs-identifier hs-var">mconcat</span></span><span> </span><span class="annot"><span class="annottext">([Env] -&gt; Env) -&gt; [Env] -&gt; Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; StaticVal -&gt; Env)
-&gt; [PatBase Info VName] -&gt; [StaticVal] -&gt; [Env]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522966"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">([StaticVal] -&gt; [Env]) -&gt; [StaticVal] -&gt; [Env]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; [PatType] -&gt; [StaticVal]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#svFromType"><span class="hs-identifier hs-var">svFromType</span></a></span><span> </span><span class="annot"><span class="annottext">[PatType]
</span><a href="#local-6989586621684522964"><span class="hs-identifier hs-var">ts</span></a></span><span>
</span><span id="line-1173"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1174"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; Env
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Env) -&gt; String -&gt; Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;matchPatSV: missing constructor in type: &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522967"><span class="hs-identifier hs-var">c1</span></a></span><span>
</span><span id="line-1175"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span id="local-6989586621684522963"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522963"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a></span><span> </span><span id="local-6989586621684522962"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522962"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; Env
</span><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522963"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; Env) -&gt; StaticVal -&gt; Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#svFromType"><span class="hs-identifier hs-var">svFromType</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522962"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1176"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#matchPatSV"><span class="hs-identifier hs-var">matchPatSV</span></a></span><span> </span><span id="local-6989586621684522961"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522961"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684522960"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522960"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1177"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; Env
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; Env) -&gt; String -&gt; Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1178"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Tried to match pattern &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522961"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-1179"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; with static value &quot;</span></span><span>
</span><span id="line-1180"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522960"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-1181"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;.&quot;</span></span><span>
</span><span id="line-1182"></span><span>
</span><span id="line-1183"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#orderZeroSV"><span class="hs-identifier hs-type">orderZeroSV</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Bool</span></span><span>
</span><span id="line-1184"></span><span id="orderZeroSV"><span class="annot"><span class="annottext">orderZeroSV :: StaticVal -&gt; Bool
</span><a href="Futhark.Internalise.Defunctionalise.html#orderZeroSV"><span class="hs-identifier hs-var hs-var">orderZeroSV</span></a></span></span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">True</span></span><span>
</span><span id="line-1185"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#orderZeroSV"><span class="hs-identifier hs-var">orderZeroSV</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-type">RecordSV</span></a></span><span> </span><span id="local-6989586621684522959"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522959"><span class="hs-identifier hs-var">fields</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((Name, StaticVal) -&gt; Bool) -&gt; [(Name, StaticVal)] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">all</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticVal -&gt; Bool
</span><a href="Futhark.Internalise.Defunctionalise.html#orderZeroSV"><span class="hs-identifier hs-var">orderZeroSV</span></a></span><span> </span><span class="annot"><span class="annottext">(StaticVal -&gt; Bool)
-&gt; ((Name, StaticVal) -&gt; StaticVal) -&gt; (Name, StaticVal) -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">(Name, StaticVal) -&gt; StaticVal
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522959"><span class="hs-identifier hs-var">fields</span></a></span><span>
</span><span id="line-1186"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#orderZeroSV"><span class="hs-identifier hs-var">orderZeroSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">False</span></span><span>
</span><span id="line-1187"></span><span>
</span><span id="line-1188"></span><span class="hs-comment">-- | Given a pattern and the static value for the defunctionalized argument,</span><span>
</span><span id="line-1189"></span><span class="hs-comment">-- update the pattern to reflect the changes in the types.</span><span>
</span><span id="line-1190"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-type">updatePat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Language.Futhark.html#Pat"><span class="hs-identifier hs-type">Pat</span></a></span><span>
</span><span id="line-1191"></span><span id="updatePat"><span class="annot"><span class="annottext">updatePat :: PatBase Info VName -&gt; StaticVal -&gt; PatBase Info VName
</span><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var hs-var">updatePat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#TuplePat"><span class="hs-identifier hs-type">TuplePat</span></a></span><span> </span><span id="local-6989586621684522957"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522957"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621684522956"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522956"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-type">RecordSV</span></a></span><span> </span><span id="local-6989586621684522955"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522955"><span class="hs-identifier hs-var">svs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1192"></span><span>  </span><span class="annot"><span class="annottext">[PatBase Info VName] -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn. [PatBase f vn] -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#TuplePat"><span class="hs-identifier hs-var">TuplePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; StaticVal -&gt; PatBase Info VName)
-&gt; [PatBase Info VName] -&gt; [StaticVal] -&gt; [PatBase Info VName]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; PatBase Info VName
</span><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522957"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">([StaticVal] -&gt; [PatBase Info VName])
-&gt; [StaticVal] -&gt; [PatBase Info VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">((Name, StaticVal) -&gt; StaticVal)
-&gt; [(Name, StaticVal)] -&gt; [StaticVal]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">(Name, StaticVal) -&gt; StaticVal
forall a b. (a, b) -&gt; b
</span><span class="hs-identifier hs-var">snd</span></span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522955"><span class="hs-identifier hs-var">svs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522956"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1193"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RecordPat"><span class="hs-identifier hs-type">RecordPat</span></a></span><span> </span><span id="local-6989586621684522954"><span class="annot"><span class="annottext">[(Name, PatBase Info VName)]
</span><a href="#local-6989586621684522954"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621684522953"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522953"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-type">RecordSV</span></a></span><span> </span><span id="local-6989586621684522952"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522952"><span class="hs-identifier hs-var">svs</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1194"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621684522951"><span class="annot"><span class="annottext">[(Name, PatBase Info VName)]
</span><a href="#local-6989586621684522951"><span class="hs-identifier hs-var">ps'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Name, PatBase Info VName) -&gt; Name)
-&gt; [(Name, PatBase Info VName)] -&gt; [(Name, PatBase Info VName)]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="annot"><span class="annottext">(Name, PatBase Info VName) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Name, PatBase Info VName)]
</span><a href="#local-6989586621684522954"><span class="hs-identifier hs-var">ps</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1195"></span><span>    </span><span id="local-6989586621684522950"><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522950"><span class="hs-identifier hs-var">svs'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Name, StaticVal) -&gt; Name)
-&gt; [(Name, StaticVal)] -&gt; [(Name, StaticVal)]
forall b a. Ord b =&gt; (a -&gt; b) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">sortOn</span></span><span> </span><span class="annot"><span class="annottext">(Name, StaticVal) -&gt; Name
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522952"><span class="hs-identifier hs-var">svs</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1196"></span><span>    </span><span class="annot"><span class="annottext">[(Name, PatBase Info VName)] -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn.
[(Name, PatBase f vn)] -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#RecordPat"><span class="hs-identifier hs-var">RecordPat</span></a></span><span>
</span><span id="line-1197"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((Name, PatBase Info VName)
 -&gt; (Name, StaticVal) -&gt; (Name, PatBase Info VName))
-&gt; [(Name, PatBase Info VName)]
-&gt; [(Name, StaticVal)]
-&gt; [(Name, PatBase Info VName)]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621684522949"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522949"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522948"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522948"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522947"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522947"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522949"><span class="hs-identifier hs-var">n</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; PatBase Info VName
</span><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522948"><span class="hs-identifier hs-var">p</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522947"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Name, PatBase Info VName)]
</span><a href="#local-6989586621684522951"><span class="hs-identifier hs-var">ps'</span></a></span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)]
</span><a href="#local-6989586621684522950"><span class="hs-identifier hs-var">svs'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1198"></span><span>      </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522953"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1199"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatParens"><span class="hs-identifier hs-type">PatParens</span></a></span><span> </span><span id="local-6989586621684522946"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522946"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684522945"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522945"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522944"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522944"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1200"></span><span>  </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn. PatBase f vn -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#PatParens"><span class="hs-identifier hs-var">PatParens</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; PatBase Info VName
</span><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522946"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522944"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522945"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1201"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatAttr"><span class="hs-identifier hs-type">PatAttr</span></a></span><span> </span><span id="local-6989586621684522943"><span class="annot"><span class="annottext">AttrInfo VName
</span><a href="#local-6989586621684522943"><span class="hs-identifier hs-var">attr</span></a></span></span><span> </span><span id="local-6989586621684522942"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522942"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684522941"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522941"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522940"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522940"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1202"></span><span>  </span><span class="annot"><span class="annottext">AttrInfo VName
-&gt; PatBase Info VName -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn.
AttrInfo vn -&gt; PatBase f vn -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#PatAttr"><span class="hs-identifier hs-var">PatAttr</span></a></span><span> </span><span class="annot"><span class="annottext">AttrInfo VName
</span><a href="#local-6989586621684522943"><span class="hs-identifier hs-var">attr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; PatBase Info VName
</span><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522942"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522940"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522941"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1203"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Id"><span class="hs-identifier hs-type">Id</span></a></span><span> </span><span id="local-6989586621684522939"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522939"><span class="hs-identifier hs-var">vn</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684522938"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522938"><span class="hs-identifier hs-var">tp</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522937"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522937"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522936"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522936"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1204"></span><span>  </span><span class="annot"><span class="annottext">VName -&gt; Info PatType -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn. vn -&gt; f PatType -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#Id"><span class="hs-identifier hs-var">Id</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522939"><span class="hs-identifier hs-var">vn</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; Info PatType) -&gt; PatType -&gt; Info PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; PatType -&gt; PatType
forall {dim} {as}.
TypeBase dim as -&gt; TypeBase dim as -&gt; TypeBase dim as
</span><a href="#local-6989586621684522935"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522938"><span class="hs-identifier hs-var">tp</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522936"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Uniqueness -&gt; PatType
forall dim as. TypeBase dim as -&gt; Uniqueness -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#setUniqueness"><span class="hs-operator hs-var">`setUniqueness`</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522937"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1205"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1206"></span><span>    </span><span class="hs-comment">-- Preserve any original zeroth-order types.</span><span>
</span><span id="line-1207"></span><span>    </span><span id="local-6989586621684522935"><span class="annot"><span class="annottext">comb :: TypeBase dim as -&gt; TypeBase dim as -&gt; TypeBase dim as
</span><a href="#local-6989586621684522935"><span class="hs-identifier hs-var hs-var">comb</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522932"><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684522932"><span class="hs-identifier hs-var">t2</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684522932"><span class="hs-identifier hs-var">t2</span></a></span><span>
</span><span id="line-1208"></span><span>    </span><span class="annot"><a href="#local-6989586621684522935"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684522931"><span class="annot"><span class="annottext">Map Name (TypeBase dim as)
</span><a href="#local-6989586621684522931"><span class="hs-identifier hs-var">m1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684522930"><span class="annot"><span class="annottext">Map Name (TypeBase dim as)
</span><a href="#local-6989586621684522930"><span class="hs-identifier hs-var">m2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1209"></span><span>      </span><span class="annot"><span class="annottext">ScalarTypeBase dim as -&gt; TypeBase dim as
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase dim as -&gt; TypeBase dim as)
-&gt; ScalarTypeBase dim as -&gt; TypeBase dim as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim as) -&gt; ScalarTypeBase dim as
forall dim as. Map Name (TypeBase dim as) -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-var">Record</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name (TypeBase dim as) -&gt; ScalarTypeBase dim as)
-&gt; Map Name (TypeBase dim as) -&gt; ScalarTypeBase dim as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(TypeBase dim as -&gt; TypeBase dim as -&gt; TypeBase dim as)
-&gt; Map Name (TypeBase dim as)
-&gt; Map Name (TypeBase dim as)
-&gt; Map Name (TypeBase dim as)
forall k a b c.
Ord k =&gt;
(a -&gt; b -&gt; c) -&gt; Map k a -&gt; Map k b -&gt; Map k c
</span><span class="hs-identifier hs-var">M.intersectionWith</span></span><span> </span><span class="annot"><span class="annottext">TypeBase dim as -&gt; TypeBase dim as -&gt; TypeBase dim as
</span><a href="#local-6989586621684522935"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim as)
</span><a href="#local-6989586621684522931"><span class="hs-identifier hs-var">m1</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name (TypeBase dim as)
</span><a href="#local-6989586621684522930"><span class="hs-identifier hs-var">m2</span></a></span><span>
</span><span id="line-1210"></span><span>    </span><span class="annot"><a href="#local-6989586621684522935"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span id="local-6989586621684522929"><span class="annot"><span class="annottext">Map Name [TypeBase dim as]
</span><a href="#local-6989586621684522929"><span class="hs-identifier hs-var">m1</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-type">Sum</span></a></span><span> </span><span id="local-6989586621684522928"><span class="annot"><span class="annottext">Map Name [TypeBase dim as]
</span><a href="#local-6989586621684522928"><span class="hs-identifier hs-var">m2</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1211"></span><span>      </span><span class="annot"><span class="annottext">ScalarTypeBase dim as -&gt; TypeBase dim as
forall dim as. ScalarTypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-var">Scalar</span></a></span><span> </span><span class="annot"><span class="annottext">(ScalarTypeBase dim as -&gt; TypeBase dim as)
-&gt; ScalarTypeBase dim as -&gt; TypeBase dim as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase dim as] -&gt; ScalarTypeBase dim as
forall dim as. Map Name [TypeBase dim as] -&gt; ScalarTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#Sum"><span class="hs-identifier hs-var">Sum</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Name [TypeBase dim as] -&gt; ScalarTypeBase dim as)
-&gt; Map Name [TypeBase dim as] -&gt; ScalarTypeBase dim as
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">([TypeBase dim as] -&gt; [TypeBase dim as] -&gt; [TypeBase dim as])
-&gt; Map Name [TypeBase dim as]
-&gt; Map Name [TypeBase dim as]
-&gt; Map Name [TypeBase dim as]
forall k a b c.
Ord k =&gt;
(a -&gt; b -&gt; c) -&gt; Map k a -&gt; Map k b -&gt; Map k c
</span><span class="hs-identifier hs-var">M.intersectionWith</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeBase dim as -&gt; TypeBase dim as -&gt; TypeBase dim as)
-&gt; [TypeBase dim as] -&gt; [TypeBase dim as] -&gt; [TypeBase dim as]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">TypeBase dim as -&gt; TypeBase dim as -&gt; TypeBase dim as
</span><a href="#local-6989586621684522935"><span class="hs-identifier hs-var">comb</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase dim as]
</span><a href="#local-6989586621684522929"><span class="hs-identifier hs-var">m1</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name [TypeBase dim as]
</span><a href="#local-6989586621684522928"><span class="hs-identifier hs-var">m2</span></a></span><span>
</span><span id="line-1212"></span><span>    </span><span class="annot"><a href="#local-6989586621684522935"><span class="hs-identifier hs-var">comb</span></a></span><span> </span><span id="local-6989586621684522927"><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684522927"><span class="hs-identifier hs-var">t1</span></a></span></span><span> </span><span class="annot"><span class="annottext">TypeBase dim as
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">TypeBase dim as
</span><a href="#local-6989586621684522927"><span class="hs-identifier hs-var">t1</span></a></span><span> </span><span class="hs-comment">-- t1 must be array or prim.</span><span>
</span><span id="line-1213"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span id="local-6989586621684522926"><span class="annot"><span class="annottext">pat :: PatBase Info VName
</span><a href="#local-6989586621684522926"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Wildcard"><span class="hs-identifier hs-type">Wildcard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684522925"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522925"><span class="hs-identifier hs-var">tp</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522924"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522924"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522923"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522923"><span class="hs-identifier hs-var">sv</span></a></span></span><span>
</span><span id="line-1214"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Bool
forall dim as. TypeBase dim as -&gt; Bool
</span><a href="Language.Futhark.Prop.html#orderZero"><span class="hs-identifier hs-var">orderZero</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522925"><span class="hs-identifier hs-var">tp</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522926"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-1215"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Info PatType -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn. f PatType -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#Wildcard"><span class="hs-identifier hs-var">Wildcard</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; Info PatType) -&gt; PatType -&gt; Info PatType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522923"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522924"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1216"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatAscription"><span class="hs-identifier hs-type">PatAscription</span></a></span><span> </span><span id="local-6989586621684522922"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522922"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684522921"><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><a href="#local-6989586621684522921"><span class="hs-identifier hs-var">tydecl</span></a></span></span><span> </span><span id="local-6989586621684522920"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522920"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522919"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522919"><span class="hs-identifier hs-var">sv</span></a></span></span><span>
</span><span id="line-1217"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Bool
forall dim as. TypeBase dim as -&gt; Bool
</span><a href="Language.Futhark.Prop.html#orderZero"><span class="hs-identifier hs-var">orderZero</span></a></span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; Bool)
-&gt; (Info StructType -&gt; StructType) -&gt; Info StructType -&gt; Bool
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Info StructType -&gt; StructType
forall a. Info a -&gt; a
</span><a href="Language.Futhark.Syntax.html#unInfo"><span class="hs-identifier hs-var hs-var">unInfo</span></a></span><span> </span><span class="annot"><span class="annottext">(Info StructType -&gt; Bool) -&gt; Info StructType -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info VName -&gt; Info StructType
forall (f :: * -&gt; *) vn. TypeDeclBase f vn -&gt; f StructType
</span><a href="Language.Futhark.Syntax.html#expandedType"><span class="hs-identifier hs-var hs-var">expandedType</span></a></span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><a href="#local-6989586621684522921"><span class="hs-identifier hs-var">tydecl</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1218"></span><span>    </span><span class="annot"><span class="annottext">PatBase Info VName
-&gt; TypeDeclBase Info VName -&gt; SrcLoc -&gt; PatBase Info VName
forall (f :: * -&gt; *) vn.
PatBase f vn -&gt; TypeDeclBase f vn -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#PatAscription"><span class="hs-identifier hs-var">PatAscription</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; PatBase Info VName
</span><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522922"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522919"><span class="hs-identifier hs-var">sv</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">TypeDeclBase Info VName
</span><a href="#local-6989586621684522921"><span class="hs-identifier hs-var">tydecl</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522920"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1219"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; PatBase Info VName
</span><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522922"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522919"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-1220"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span id="local-6989586621684522918"><span class="annot"><span class="annottext">p :: PatBase Info VName
</span><a href="#local-6989586621684522918"><span class="hs-identifier hs-var">p</span></a></span></span><span class="hs-glyph">@</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatLit"><span class="hs-identifier hs-type">PatLit</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522918"><span class="hs-identifier hs-var">p</span></a></span><span>
</span><span id="line-1221"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span id="local-6989586621684522917"><span class="annot"><span class="annottext">pat :: PatBase Info VName
</span><a href="#local-6989586621684522917"><span class="hs-identifier hs-var">pat</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatConstr"><span class="hs-identifier hs-type">PatConstr</span></a></span><span> </span><span id="local-6989586621684522916"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522916"><span class="hs-identifier hs-var">c1</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span id="local-6989586621684522915"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522915"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522914"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522914"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621684522913"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522913"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522912"><span class="annot"><span class="annottext">sv :: StaticVal
</span><a href="#local-6989586621684522912"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#SumSV"><span class="hs-identifier hs-type">SumSV</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684522911"><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684522911"><span class="hs-identifier hs-var">svs</span></a></span></span><span> </span><span class="annot"><span class="annottext">[(Name, [PatType])]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span>
</span><span id="line-1222"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Bool
forall dim as. TypeBase dim as -&gt; Bool
</span><a href="Language.Futhark.Prop.html#orderZero"><span class="hs-identifier hs-var">orderZero</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522915"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522917"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-1223"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier hs-var">otherwise</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Name
-&gt; Info PatType
-&gt; [PatBase Info VName]
-&gt; SrcLoc
-&gt; PatBase Info VName
forall (f :: * -&gt; *) vn.
Name -&gt; f PatType -&gt; [PatBase f vn] -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#PatConstr"><span class="hs-identifier hs-var">PatConstr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522916"><span class="hs-identifier hs-var">c1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522910"><span class="hs-identifier hs-var">t'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522909"><span class="hs-identifier hs-var">ps'</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522913"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1224"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1225"></span><span>    </span><span id="local-6989586621684522910"><span class="annot"><span class="annottext">t' :: PatType
</span><a href="#local-6989586621684522910"><span class="hs-identifier hs-var hs-var">t'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; PatType
</span><a href="Futhark.Internalise.Defunctionalise.html#typeFromSV"><span class="hs-identifier hs-var">typeFromSV</span></a></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522912"><span class="hs-identifier hs-var">sv</span></a></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Uniqueness -&gt; PatType
forall dim as. TypeBase dim as -&gt; Uniqueness -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#setUniqueness"><span class="hs-operator hs-var">`setUniqueness`</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span>
</span><span id="line-1226"></span><span>    </span><span id="local-6989586621684522909"><span class="annot"><span class="annottext">ps' :: [PatBase Info VName]
</span><a href="#local-6989586621684522909"><span class="hs-identifier hs-var hs-var">ps'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; StaticVal -&gt; PatBase Info VName)
-&gt; [PatBase Info VName] -&gt; [StaticVal] -&gt; [PatBase Info VName]
forall a b c. (a -&gt; b -&gt; c) -&gt; [a] -&gt; [b] -&gt; [c]
</span><span class="hs-identifier hs-var">zipWith</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; PatBase Info VName
</span><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522914"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">[StaticVal]
</span><a href="#local-6989586621684522911"><span class="hs-identifier hs-var">svs</span></a></span><span>
</span><span id="line-1227"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#PatConstr"><span class="hs-identifier hs-type">PatConstr</span></a></span><span> </span><span id="local-6989586621684522908"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522908"><span class="hs-identifier hs-var">c1</span></a></span></span><span> </span><span class="annot"><span class="annottext">Info PatType
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684522907"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522907"><span class="hs-identifier hs-var">ps</span></a></span></span><span> </span><span id="local-6989586621684522906"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522906"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a></span><span> </span><span id="local-6989586621684522905"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522905"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1228"></span><span>  </span><span class="annot"><span class="annottext">Name
-&gt; Info PatType
-&gt; [PatBase Info VName]
-&gt; SrcLoc
-&gt; PatBase Info VName
forall (f :: * -&gt; *) vn.
Name -&gt; f PatType -&gt; [PatBase f vn] -&gt; SrcLoc -&gt; PatBase f vn
</span><a href="Language.Futhark.Syntax.html#PatConstr"><span class="hs-identifier hs-var">PatConstr</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621684522908"><span class="hs-identifier hs-var">c1</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; Info PatType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522905"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522907"><span class="hs-identifier hs-var">ps</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522906"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1229"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span id="local-6989586621684522904"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522904"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-type">Dynamic</span></a></span><span> </span><span id="local-6989586621684522903"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522903"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; StaticVal -&gt; PatBase Info VName
</span><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522904"><span class="hs-identifier hs-var">pat</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#svFromType"><span class="hs-identifier hs-var">svFromType</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522903"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1230"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#updatePat"><span class="hs-identifier hs-var">updatePat</span></a></span><span> </span><span id="local-6989586621684522902"><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522902"><span class="hs-identifier hs-var">pat</span></a></span></span><span> </span><span id="local-6989586621684522901"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522901"><span class="hs-identifier hs-var">sv</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1231"></span><span>  </span><span class="annot"><span class="annottext">String -&gt; PatBase Info VName
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; PatBase Info VName) -&gt; String -&gt; PatBase Info VName
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1232"></span><span>    </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;Tried to update pattern &quot;</span></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; String
forall a. Pretty a =&gt; a -&gt; String
</span><a href="Futhark.Util.Pretty.html#pretty"><span class="hs-identifier hs-var">pretty</span></a></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName
</span><a href="#local-6989586621684522902"><span class="hs-identifier hs-var">pat</span></a></span><span>
</span><span id="line-1233"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;to reflect the static value &quot;</span></span><span>
</span><span id="line-1234"></span><span>      </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">StaticVal -&gt; String
forall a. Show a =&gt; a -&gt; String
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522901"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-1235"></span><span>
</span><span id="line-1236"></span><span class="hs-comment">-- | Convert a record (or tuple) type to a record static value. This is used for</span><span>
</span><span id="line-1237"></span><span class="hs-comment">-- &quot;unwrapping&quot; tuples and records that are nested in 'Dynamic' static values.</span><span>
</span><span id="line-1238"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#svFromType"><span class="hs-identifier hs-type">svFromType</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#PatType"><span class="hs-identifier hs-type">PatType</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#StaticVal"><span class="hs-identifier hs-type">StaticVal</span></a></span><span>
</span><span id="line-1239"></span><span id="svFromType"><span class="annot"><span class="annottext">svFromType :: PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#svFromType"><span class="hs-identifier hs-var hs-var">svFromType</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Record"><span class="hs-identifier hs-type">Record</span></a></span><span> </span><span id="local-6989586621684522900"><span class="annot"><span class="annottext">Map Name PatType
</span><a href="#local-6989586621684522900"><span class="hs-identifier hs-var">fs</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, StaticVal)] -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#RecordSV"><span class="hs-identifier hs-var">RecordSV</span></a></span><span> </span><span class="annot"><span class="annottext">([(Name, StaticVal)] -&gt; StaticVal)
-&gt; (Map Name StaticVal -&gt; [(Name, StaticVal)])
-&gt; Map Name StaticVal
-&gt; StaticVal
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><span class="hs-operator hs-var">.</span></span><span> </span><span class="annot"><span class="annottext">Map Name StaticVal -&gt; [(Name, StaticVal)]
forall k a. Map k a -&gt; [(k, a)]
</span><span class="hs-identifier hs-var">M.toList</span></span><span> </span><span class="annot"><span class="annottext">(Map Name StaticVal -&gt; StaticVal)
-&gt; Map Name StaticVal -&gt; StaticVal
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StaticVal) -&gt; Map Name PatType -&gt; Map Name StaticVal
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><span class="hs-identifier hs-var">M.map</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#svFromType"><span class="hs-identifier hs-var">svFromType</span></a></span><span> </span><span class="annot"><span class="annottext">Map Name PatType
</span><a href="#local-6989586621684522900"><span class="hs-identifier hs-var">fs</span></a></span><span>
</span><span id="line-1240"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#svFromType"><span class="hs-identifier hs-var">svFromType</span></a></span><span> </span><span id="local-6989586621684522899"><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522899"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StaticVal
</span><a href="Futhark.Internalise.Defunctionalise.html#Dynamic"><span class="hs-identifier hs-var">Dynamic</span></a></span><span> </span><span class="annot"><span class="annottext">PatType
</span><a href="#local-6989586621684522899"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-1241"></span><span>
</span><span id="line-1242"></span><span class="hs-comment">-- | Defunctionalize a top-level value binding. Returns the</span><span>
</span><span id="line-1243"></span><span class="hs-comment">-- transformed result as well as an environment that binds the name of</span><span>
</span><span id="line-1244"></span><span class="hs-comment">-- the value binding to the static value of the transformed body.  The</span><span>
</span><span id="line-1245"></span><span class="hs-comment">-- boolean is true if the function is a 'DynamicFun'.</span><span>
</span><span id="line-1246"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncValBind"><span class="hs-identifier hs-type">defuncValBind</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Language.Futhark.html#ValBind"><span class="hs-identifier hs-type">ValBind</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.html#ValBind"><span class="hs-identifier hs-type">ValBind</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1247"></span><span class="hs-comment">-- Eta-expand entry points with a functional return type.</span><span>
</span><span id="line-1248"></span><span id="defuncValBind"><span class="annot"><span class="annottext">defuncValBind :: ValBind -&gt; DefM (ValBind, Env)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncValBind"><span class="hs-identifier hs-var hs-var">defuncValBind</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ValBind"><span class="hs-identifier hs-type">ValBind</span></a></span><span> </span><span id="local-6989586621684522897"><span class="annot"><span class="annottext">Maybe (Info EntryPoint)
</span><a href="#local-6989586621684522897"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span id="local-6989586621684522896"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522896"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (TypeExp VName)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684522895"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684522895"><span class="hs-identifier hs-var">rettype</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522894"><span class="annot"><span class="annottext">[TypeParamBase VName]
</span><a href="#local-6989586621684522894"><span class="hs-identifier hs-var">tparams</span></a></span></span><span> </span><span id="local-6989586621684522893"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522893"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684522892"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684522892"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe DocComment
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684522891"><span class="annot"><span class="annottext">[AttrInfo VName]
</span><a href="#local-6989586621684522891"><span class="hs-identifier hs-var">attrs</span></a></span></span><span> </span><span id="local-6989586621684522890"><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522890"><span class="hs-identifier hs-var">loc</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1249"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Scalar"><span class="hs-identifier hs-type">Scalar</span></a></span><span> </span><span class="annot"><a href="Language.Futhark.Syntax.html#Arrow"><span class="hs-identifier hs-type">Arrow</span></a></span><span> </span><span class="hs-special">{</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684522895"><span class="hs-identifier hs-var">rettype</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1250"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621684522889"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522889"><span class="hs-identifier hs-var">body_pats</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522888"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684522888"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522887"><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684522887"><span class="hs-identifier hs-var">rettype'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">PatType -&gt; Exp -&gt; DefM ([PatBase Info VName], Exp, StructRetType)
</span><a href="Futhark.Internalise.Defunctionalise.html#etaExpand"><span class="hs-identifier hs-var">etaExpand</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructType -&gt; PatType
forall dim as. TypeBase dim as -&gt; TypeBase dim (Set Alias)
</span><a href="Language.Futhark.Prop.html#fromStruct"><span class="hs-identifier hs-var">fromStruct</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684522895"><span class="hs-identifier hs-var">rettype</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684522892"><span class="hs-identifier hs-var">body</span></a></span><span>
</span><span id="line-1251"></span><span>    </span><span class="annot"><span class="annottext">ValBind -&gt; DefM (ValBind, Env)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncValBind"><span class="hs-identifier hs-var">defuncValBind</span></a></span><span> </span><span class="annot"><span class="annottext">(ValBind -&gt; DefM (ValBind, Env)) -&gt; ValBind -&gt; DefM (ValBind, Env)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1252"></span><span>      </span><span class="annot"><span class="annottext">Maybe (Info EntryPoint)
-&gt; VName
-&gt; Maybe (TypeExp VName)
-&gt; Info StructRetType
-&gt; [TypeParamBase VName]
-&gt; [PatBase Info VName]
-&gt; Exp
-&gt; Maybe DocComment
-&gt; [AttrInfo VName]
-&gt; SrcLoc
-&gt; ValBind
forall (f :: * -&gt; *) vn.
Maybe (f EntryPoint)
-&gt; vn
-&gt; Maybe (TypeExp vn)
-&gt; f StructRetType
-&gt; [TypeParamBase vn]
-&gt; [PatBase f vn]
-&gt; ExpBase f vn
-&gt; Maybe DocComment
-&gt; [AttrInfo vn]
-&gt; SrcLoc
-&gt; ValBindBase f vn
</span><a href="Language.Futhark.Syntax.html#ValBind"><span class="hs-identifier hs-var">ValBind</span></a></span><span>
</span><span id="line-1253"></span><span>        </span><span class="annot"><span class="annottext">Maybe (Info EntryPoint)
</span><a href="#local-6989586621684522897"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-1254"></span><span>        </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522896"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-1255"></span><span>        </span><span class="annot"><span class="annottext">Maybe (TypeExp VName)
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1256"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">StructRetType -&gt; Info StructRetType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">StructRetType
</span><a href="#local-6989586621684522887"><span class="hs-identifier hs-var">rettype'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1257"></span><span>        </span><span class="annot"><span class="annottext">[TypeParamBase VName]
</span><a href="#local-6989586621684522894"><span class="hs-identifier hs-var">tparams</span></a></span><span>
</span><span id="line-1258"></span><span>        </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522893"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
-&gt; [PatBase Info VName] -&gt; [PatBase Info VName]
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522889"><span class="hs-identifier hs-var">body_pats</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1259"></span><span>        </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684522888"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-1260"></span><span>        </span><span class="annot"><span class="annottext">Maybe DocComment
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span><span>
</span><span id="line-1261"></span><span>        </span><span class="annot"><span class="annottext">[AttrInfo VName]
</span><a href="#local-6989586621684522891"><span class="hs-identifier hs-var">attrs</span></a></span><span>
</span><span id="line-1262"></span><span>        </span><span class="annot"><span class="annottext">SrcLoc
</span><a href="#local-6989586621684522890"><span class="hs-identifier hs-var">loc</span></a></span><span>
</span><span id="line-1263"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncValBind"><span class="hs-identifier hs-var">defuncValBind</span></a></span><span> </span><span id="local-6989586621684522886"><span class="annot"><span class="annottext">valbind :: ValBind
</span><a href="#local-6989586621684522886"><span class="hs-identifier hs-var">valbind</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#ValBind"><span class="hs-identifier hs-type">ValBind</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (Info EntryPoint)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684522885"><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522885"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span id="local-6989586621684522884"><span class="annot"><span class="annottext">Maybe (TypeExp VName)
</span><a href="#local-6989586621684522884"><span class="hs-identifier hs-var">retdecl</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-type">Info</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-type">RetType</span></a></span><span> </span><span id="local-6989586621684522883"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522883"><span class="hs-identifier hs-var">ret_dims</span></a></span></span><span> </span><span id="local-6989586621684522882"><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684522882"><span class="hs-identifier hs-var">rettype</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621684522881"><span class="annot"><span class="annottext">[TypeParamBase VName]
</span><a href="#local-6989586621684522881"><span class="hs-identifier hs-var">tparams</span></a></span></span><span> </span><span id="local-6989586621684522880"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522880"><span class="hs-identifier hs-var">params</span></a></span></span><span> </span><span id="local-6989586621684522879"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684522879"><span class="hs-identifier hs-var">body</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe DocComment
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[AttrInfo VName]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">SrcLoc
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1264"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; DefM () -&gt; DefM ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">when</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeParamBase VName -&gt; Bool) -&gt; [TypeParamBase VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; (a -&gt; Bool) -&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">any</span></span><span> </span><span class="annot"><span class="annottext">TypeParamBase VName -&gt; Bool
forall vn. TypeParamBase vn -&gt; Bool
</span><a href="Language.Futhark.Prop.html#isTypeParam"><span class="hs-identifier hs-var">isTypeParam</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParamBase VName]
</span><a href="#local-6989586621684522881"><span class="hs-identifier hs-var">tparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(DefM () -&gt; DefM ()) -&gt; DefM () -&gt; DefM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1265"></span><span>    </span><span class="annot"><span class="annottext">String -&gt; DefM ()
forall a. HasCallStack =&gt; String -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">(String -&gt; DefM ()) -&gt; String -&gt; DefM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1266"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; String
forall v. IsName v =&gt; v -&gt; String
</span><a href="Language.Futhark.Pretty.html#prettyName"><span class="hs-identifier hs-var">prettyName</span></a></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522885"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot; has type parameters, &quot;</span></span><span>
</span><span id="line-1267"></span><span>        </span><span class="annot"><span class="annottext">String -&gt; ShowS
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">String
</span><span class="hs-string">&quot;but the defunctionaliser expects a monomorphic input program.&quot;</span></span><span>
</span><span id="line-1268"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684522876"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522876"><span class="hs-identifier hs-var">tparams'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522875"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522875"><span class="hs-identifier hs-var">params'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522874"><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684522874"><span class="hs-identifier hs-var">body'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522873"><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522873"><span class="hs-identifier hs-var">sv</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span>
</span><span id="line-1269"></span><span>    </span><span class="annot"><span class="annottext">[VName]
-&gt; [PatBase Info VName]
-&gt; Exp
-&gt; StructRetType
-&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncLet"><span class="hs-identifier hs-var">defuncLet</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeParamBase VName -&gt; VName) -&gt; [TypeParamBase VName] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeParamBase VName -&gt; VName
forall vn. TypeParamBase vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#typeParamName"><span class="hs-identifier hs-var">typeParamName</span></a></span><span> </span><span class="annot"><span class="annottext">[TypeParamBase VName]
</span><a href="#local-6989586621684522881"><span class="hs-identifier hs-var">tparams</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522880"><span class="hs-identifier hs-var">params</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684522879"><span class="hs-identifier hs-var">body</span></a></span><span> </span><span class="annot"><span class="annottext">(StructRetType
 -&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal))
-&gt; StructRetType
-&gt; DefM ([VName], [PatBase Info VName], Exp, StaticVal)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522883"><span class="hs-identifier hs-var">ret_dims</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684522882"><span class="hs-identifier hs-var">rettype</span></a></span><span>
</span><span id="line-1270"></span><span>  </span><span id="local-6989586621684522871"><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684522871"><span class="hs-identifier hs-var">globals</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">((Set VName, Env) -&gt; Set VName) -&gt; DefM (Set VName)
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; a) -&gt; m a
</span><span class="hs-identifier hs-var">asks</span></span><span> </span><span class="annot"><span class="annottext">(Set VName, Env) -&gt; Set VName
forall a b. (a, b) -&gt; a
</span><span class="hs-identifier hs-var">fst</span></span><span>
</span><span id="line-1271"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684522862"><span class="annot"><span class="annottext">bound_sizes :: Set VName
</span><a href="#local-6989586621684522862"><span class="hs-identifier hs-var hs-var">bound_sizes</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(PatBase Info VName -&gt; Set VName)
-&gt; [PatBase Info VName] -&gt; Set VName
forall (t :: * -&gt; *) m a.
(Foldable t, Monoid m) =&gt;
(a -&gt; m) -&gt; t a -&gt; m
</span><span class="hs-identifier hs-var">foldMap</span></span><span> </span><span class="annot"><span class="annottext">PatBase Info VName -&gt; Set VName
forall (f :: * -&gt; *) vn.
(Functor f, Ord vn) =&gt;
PatBase f vn -&gt; Set vn
</span><a href="Language.Futhark.Prop.html#patNames"><span class="hs-identifier hs-var">patNames</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522875"><span class="hs-identifier hs-var">params'</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; Set VName
forall a. Ord a =&gt; [a] -&gt; Set a
</span><span class="hs-identifier hs-var">S.fromList</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522876"><span class="hs-identifier hs-var">tparams'</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName -&gt; Set VName -&gt; Set VName
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684522871"><span class="hs-identifier hs-var">globals</span></a></span><span>
</span><span id="line-1272"></span><span>      </span><span id="local-6989586621684522857"><span class="annot"><span class="annottext">rettype' :: StructType
</span><a href="#local-6989586621684522857"><span class="hs-identifier hs-var hs-var">rettype'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1273"></span><span>        </span><span class="hs-comment">-- FIXME: dubious that we cannot assume that all sizes in the</span><span>
</span><span id="line-1274"></span><span>        </span><span class="hs-comment">-- body are in scope.  This is because when we insert</span><span>
</span><span id="line-1275"></span><span>        </span><span class="hs-comment">-- applications of lifted functions, we don't properly update</span><span>
</span><span id="line-1276"></span><span>        </span><span class="hs-comment">-- the types in the return type annotation.</span><span>
</span><span id="line-1277"></span><span>        </span><span class="annot"><span class="annottext">StructType -&gt; StructType -&gt; StructType
forall as dim.
(Monoid as, ArrayDim dim) =&gt;
TypeBase dim as -&gt; TypeBase dim as -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#combineTypeShapes"><span class="hs-identifier hs-var">combineTypeShapes</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684522882"><span class="hs-identifier hs-var">rettype</span></a></span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; StructType) -&gt; StructType -&gt; StructType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(DimDecl VName -&gt; DimDecl VName) -&gt; StructType -&gt; StructType
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set VName -&gt; DimDecl VName -&gt; DimDecl VName
forall {vn}. Ord vn =&gt; Set vn -&gt; DimDecl vn -&gt; DimDecl vn
</span><a href="#local-6989586621684522856"><span class="hs-identifier hs-var">anyDimIfNotBound</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684522862"><span class="hs-identifier hs-var">bound_sizes</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; StructType) -&gt; StructType -&gt; StructType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">PatType -&gt; StructType
forall dim as. TypeBase dim as -&gt; TypeBase dim ()
</span><a href="Language.Futhark.Prop.html#toStruct"><span class="hs-identifier hs-var">toStruct</span></a></span><span> </span><span class="annot"><span class="annottext">(PatType -&gt; StructType) -&gt; PatType -&gt; StructType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Exp -&gt; PatType
</span><a href="Language.Futhark.Prop.html#typeOf"><span class="hs-identifier hs-var">typeOf</span></a></span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684522874"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-1278"></span><span>      </span><span id="local-6989586621684522854"><span class="annot"><span class="annottext">ret_dims' :: [VName]
</span><a href="#local-6989586621684522854"><span class="hs-identifier hs-var hs-var">ret_dims'</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VName -&gt; Bool) -&gt; [VName] -&gt; [VName]
forall a. (a -&gt; Bool) -&gt; [a] -&gt; [a]
</span><span class="hs-identifier hs-var">filter</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; Set VName -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.member`</span></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Set VName
forall als. TypeBase (DimDecl VName) als -&gt; Set VName
</span><a href="Language.Futhark.Prop.html#typeDimNames"><span class="hs-identifier hs-var">typeDimNames</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684522857"><span class="hs-identifier hs-var">rettype'</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522883"><span class="hs-identifier hs-var">ret_dims</span></a></span><span>
</span><span id="line-1279"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684522853"><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522853"><span class="hs-identifier hs-var">missing_dims</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522852"><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522852"><span class="hs-identifier hs-var">params''</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Set VName
-&gt; [PatBase Info VName] -&gt; DefM ([VName], [PatBase Info VName])
forall (m :: * -&gt; *).
MonadFreshNames m =&gt;
Set VName
-&gt; [PatBase Info VName] -&gt; m ([VName], [PatBase Info VName])
</span><a href="Futhark.Internalise.Defunctionalise.html#sizesForAll"><span class="hs-identifier hs-var">sizesForAll</span></a></span><span> </span><span class="annot"><span class="annottext">Set VName
</span><a href="#local-6989586621684522862"><span class="hs-identifier hs-var">bound_sizes</span></a></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522875"><span class="hs-identifier hs-var">params'</span></a></span><span>
</span><span id="line-1280"></span><span>
</span><span id="line-1281"></span><span>  </span><span class="annot"><span class="annottext">(ValBind, Env) -&gt; DefM (ValBind, Env)
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span>
</span><span id="line-1282"></span><span>    </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="annottext">ValBind
</span><a href="#local-6989586621684522886"><span class="hs-identifier hs-var">valbind</span></a></span><span>
</span><span id="line-1283"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">valBindRetDecl :: Maybe (TypeExp VName)
</span><a href="Language.Futhark.Syntax.html#valBindRetDecl"><span class="hs-identifier hs-var">valBindRetDecl</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe (TypeExp VName)
</span><a href="#local-6989586621684522884"><span class="hs-identifier hs-var">retdecl</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1284"></span><span>          </span><span class="annot"><span class="annottext">valBindRetType :: Info StructRetType
</span><a href="Language.Futhark.Syntax.html#valBindRetType"><span class="hs-identifier hs-var">valBindRetType</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1285"></span><span>            </span><span class="annot"><span class="annottext">StructRetType -&gt; Info StructRetType
forall a. a -&gt; Info a
</span><a href="Language.Futhark.Syntax.html#Info"><span class="hs-identifier hs-var">Info</span></a></span><span> </span><span class="annot"><span class="annottext">(StructRetType -&gt; Info StructRetType)
-&gt; StructRetType -&gt; Info StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1286"></span><span>              </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><span class="hs-identifier hs-var">null</span></span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522875"><span class="hs-identifier hs-var">params'</span></a></span><span>
</span><span id="line-1287"></span><span>                </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522854"><span class="hs-identifier hs-var">ret_dims'</span></a></span><span> </span><span class="annot"><span class="annottext">(StructType -&gt; StructRetType) -&gt; StructType -&gt; StructRetType
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684522857"><span class="hs-identifier hs-var">rettype'</span></a></span><span> </span><span class="annot"><span class="annottext">StructType -&gt; Uniqueness -&gt; StructType
forall dim as. TypeBase dim as -&gt; Uniqueness -&gt; TypeBase dim as
</span><a href="Language.Futhark.Prop.html#setUniqueness"><span class="hs-operator hs-var">`setUniqueness`</span></a></span><span> </span><span class="annot"><span class="annottext">Uniqueness
</span><a href="Language.Futhark.Core.html#Nonunique"><span class="hs-identifier hs-var">Nonunique</span></a></span><span>
</span><span id="line-1288"></span><span>                </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; StructType -&gt; StructRetType
forall dim as. [VName] -&gt; TypeBase dim as -&gt; RetTypeBase dim as
</span><a href="Language.Futhark.Syntax.html#RetType"><span class="hs-identifier hs-var">RetType</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522854"><span class="hs-identifier hs-var">ret_dims'</span></a></span><span> </span><span class="annot"><span class="annottext">StructType
</span><a href="#local-6989586621684522857"><span class="hs-identifier hs-var">rettype'</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1289"></span><span>          </span><span class="annot"><span class="annottext">valBindTypeParams :: [TypeParamBase VName]
</span><a href="Language.Futhark.Syntax.html#valBindTypeParams"><span class="hs-identifier hs-var">valBindTypeParams</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-1290"></span><span>            </span><span class="annot"><span class="annottext">(VName -&gt; TypeParamBase VName) -&gt; [VName] -&gt; [TypeParamBase VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">VName -&gt; SrcLoc -&gt; TypeParamBase VName
forall vn. vn -&gt; SrcLoc -&gt; TypeParamBase vn
</span><a href="Language.Futhark.Syntax.html#TypeParamDim"><span class="hs-operator hs-var">`TypeParamDim`</span></a></span><span> </span><span class="annot"><span class="annottext">SrcLoc
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([VName] -&gt; [TypeParamBase VName])
-&gt; [VName] -&gt; [TypeParamBase VName]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522876"><span class="hs-identifier hs-var">tparams'</span></a></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; [VName] -&gt; [VName]
forall a. [a] -&gt; [a] -&gt; [a]
</span><span class="hs-operator hs-var">++</span></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522853"><span class="hs-identifier hs-var">missing_dims</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1291"></span><span>          </span><span class="annot"><span class="annottext">valBindParams :: [PatBase Info VName]
</span><a href="Language.Futhark.Syntax.html#valBindParams"><span class="hs-identifier hs-var">valBindParams</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[PatBase Info VName]
</span><a href="#local-6989586621684522852"><span class="hs-identifier hs-var">params''</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-1292"></span><span>          </span><span class="annot"><span class="annottext">valBindBody :: Exp
</span><a href="Language.Futhark.Syntax.html#valBindBody"><span class="hs-identifier hs-var">valBindBody</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Exp
</span><a href="#local-6989586621684522874"><span class="hs-identifier hs-var">body'</span></a></span><span>
</span><span id="line-1293"></span><span>        </span><span class="hs-special">}</span><span class="hs-special">,</span><span>
</span><span id="line-1294"></span><span>      </span><span class="annot"><span class="annottext">VName -&gt; Binding -&gt; Env
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">VName
</span><a href="#local-6989586621684522885"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="annot"><span class="annottext">(Binding -&gt; Env) -&gt; Binding -&gt; Env
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-1295"></span><span>        </span><span class="annot"><span class="annottext">Maybe ([VName], StructType) -&gt; StaticVal -&gt; Binding
</span><a href="Futhark.Internalise.Defunctionalise.html#Binding"><span class="hs-identifier hs-var">Binding</span></a></span><span>
</span><span id="line-1296"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([VName], StructType) -&gt; Maybe ([VName], StructType)
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">([TypeParamBase VName] -&gt; [VName])
-&gt; ([TypeParamBase VName], StructType) -&gt; ([VName], StructType)
forall (p :: * -&gt; * -&gt; *) a b c.
Bifunctor p =&gt;
(a -&gt; b) -&gt; p a c -&gt; p b c
</span><span class="hs-identifier hs-var">first</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(TypeParamBase VName -&gt; VName) -&gt; [TypeParamBase VName] -&gt; [VName]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><span class="hs-identifier hs-var">map</span></span><span> </span><span class="annot"><span class="annottext">TypeParamBase VName -&gt; VName
forall vn. TypeParamBase vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#typeParamName"><span class="hs-identifier hs-var">typeParamName</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValBind -&gt; ([TypeParamBase VName], StructType)
</span><a href="Language.Futhark.Prop.html#valBindTypeScheme"><span class="hs-identifier hs-var">valBindTypeScheme</span></a></span><span> </span><span class="annot"><span class="annottext">ValBind
</span><a href="#local-6989586621684522886"><span class="hs-identifier hs-var">valbind</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-1297"></span><span>          </span><span class="annot"><span class="annottext">StaticVal
</span><a href="#local-6989586621684522873"><span class="hs-identifier hs-var">sv</span></a></span><span>
</span><span id="line-1298"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-1299"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-1300"></span><span>    </span><span id="local-6989586621684522856"><span class="annot"><span class="annottext">anyDimIfNotBound :: Set vn -&gt; DimDecl vn -&gt; DimDecl vn
</span><a href="#local-6989586621684522856"><span class="hs-identifier hs-var hs-var">anyDimIfNotBound</span></a></span></span><span> </span><span id="local-6989586621684522848"><span class="annot"><span class="annottext">Set vn
</span><a href="#local-6989586621684522848"><span class="hs-identifier hs-var">bound_sizes</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Language.Futhark.Syntax.html#NamedDim"><span class="hs-identifier hs-type">NamedDim</span></a></span><span> </span><span id="local-6989586621684522847"><span class="annot"><span class="annottext">QualName vn
</span><a href="#local-6989586621684522847"><span class="hs-identifier hs-var">v</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-1301"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">QualName vn -&gt; vn
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName vn
</span><a href="#local-6989586621684522847"><span class="hs-identifier hs-var">v</span></a></span><span> </span><span class="annot"><span class="annottext">vn -&gt; Set vn -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><span class="hs-operator hs-var">`S.notMember`</span></span><span> </span><span class="annot"><span class="annottext">Set vn
</span><a href="#local-6989586621684522848"><span class="hs-identifier hs-var">bound_sizes</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe vn -&gt; DimDecl vn
forall vn. Maybe vn -&gt; DimDecl vn
</span><a href="Language.Futhark.Syntax.html#AnyDim"><span class="hs-identifier hs-var">AnyDim</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe vn -&gt; DimDecl vn) -&gt; Maybe vn -&gt; DimDecl vn
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">vn -&gt; Maybe vn
forall a. a -&gt; Maybe a
</span><span class="hs-identifier hs-var">Just</span></span><span> </span><span class="annot"><span class="annottext">(vn -&gt; Maybe vn) -&gt; vn -&gt; Maybe vn
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">QualName vn -&gt; vn
forall vn. QualName vn -&gt; vn
</span><a href="Language.Futhark.Syntax.html#qualLeaf"><span class="hs-identifier hs-var hs-var">qualLeaf</span></a></span><span> </span><span class="annot"><span class="annottext">QualName vn
</span><a href="#local-6989586621684522847"><span class="hs-identifier hs-var">v</span></a></span><span>
</span><span id="line-1302"></span><span>    </span><span class="annot"><a href="#local-6989586621684522856"><span class="hs-identifier hs-var">anyDimIfNotBound</span></a></span><span> </span><span class="annot"><span class="annottext">Set vn
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621684522846"><span class="annot"><span class="annottext">DimDecl vn
</span><a href="#local-6989586621684522846"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">DimDecl vn
</span><a href="#local-6989586621684522846"><span class="hs-identifier hs-var">d</span></a></span><span>
</span><span id="line-1303"></span><span>
</span><span id="line-1304"></span><span class="hs-comment">-- | Defunctionalize a list of top-level declarations.</span><span>
</span><span id="line-1305"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncVals"><span class="hs-identifier hs-type">defuncVals</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#ValBind"><span class="hs-identifier hs-type">ValBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#DefM"><span class="hs-identifier hs-type">DefM</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1306"></span><span id="defuncVals"><span class="annot"><span class="annottext">defuncVals :: [ValBind] -&gt; DefM ()
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncVals"><span class="hs-identifier hs-var hs-var">defuncVals</span></a></span></span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">() -&gt; DefM ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><span class="hs-identifier hs-var">pure</span></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-1307"></span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#defuncVals"><span class="hs-identifier hs-var">defuncVals</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621684522844"><span class="annot"><span class="annottext">ValBind
</span><a href="#local-6989586621684522844"><span class="hs-identifier hs-var">valbind</span></a></span></span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621684522843"><span class="annot"><span class="annottext">[ValBind]
</span><a href="#local-6989586621684522843"><span class="hs-identifier hs-var">ds</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-1308"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621684522842"><span class="annot"><span class="annottext">ValBind
</span><a href="#local-6989586621684522842"><span class="hs-identifier hs-var">valbind'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522841"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522841"><span class="hs-identifier hs-var">env</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ValBind -&gt; DefM (ValBind, Env)
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncValBind"><span class="hs-identifier hs-var">defuncValBind</span></a></span><span> </span><span class="annot"><span class="annottext">ValBind
</span><a href="#local-6989586621684522844"><span class="hs-identifier hs-var">valbind</span></a></span><span>
</span><span id="line-1309"></span><span>  </span><span class="annot"><span class="annottext">ValBind -&gt; DefM ()
</span><a href="Futhark.Internalise.Defunctionalise.html#addValBind"><span class="hs-identifier hs-var">addValBind</span></a></span><span> </span><span class="annot"><span class="annottext">ValBind
</span><a href="#local-6989586621684522842"><span class="hs-identifier hs-var">valbind'</span></a></span><span>
</span><span id="line-1310"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621684522840"><span class="annot"><span class="annottext">globals :: [VName]
</span><a href="#local-6989586621684522840"><span class="hs-identifier hs-var hs-var">globals</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">ValBind -&gt; [VName]
</span><a href="Language.Futhark.Prop.html#valBindBound"><span class="hs-identifier hs-var">valBindBound</span></a></span><span> </span><span class="annot"><span class="annottext">ValBind
</span><a href="#local-6989586621684522842"><span class="hs-identifier hs-var">valbind'</span></a></span><span>
</span><span id="line-1311"></span><span>  </span><span class="annot"><span class="annottext">Env -&gt; DefM () -&gt; DefM ()
forall a. Env -&gt; DefM a -&gt; DefM a
</span><a href="Futhark.Internalise.Defunctionalise.html#localEnv"><span class="hs-identifier hs-var">localEnv</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621684522841"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">(DefM () -&gt; DefM ()) -&gt; DefM () -&gt; DefM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[VName] -&gt; DefM () -&gt; DefM ()
forall a. [VName] -&gt; DefM a -&gt; DefM a
</span><a href="Futhark.Internalise.Defunctionalise.html#areGlobal"><span class="hs-identifier hs-var">areGlobal</span></a></span><span> </span><span class="annot"><span class="annottext">[VName]
</span><a href="#local-6989586621684522840"><span class="hs-identifier hs-var">globals</span></a></span><span> </span><span class="annot"><span class="annottext">(DefM () -&gt; DefM ()) -&gt; DefM () -&gt; DefM ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ValBind] -&gt; DefM ()
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncVals"><span class="hs-identifier hs-var">defuncVals</span></a></span><span> </span><span class="annot"><span class="annottext">[ValBind]
</span><a href="#local-6989586621684522843"><span class="hs-identifier hs-var">ds</span></a></span><span>
</span><span id="line-1312"></span><span>
</span><span id="line-1313"></span><span class="hs-pragma">{-# NOINLINE</span><span> </span><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#transformProg"><span class="hs-pragma hs-type">transformProg</span></a></span><span> </span><span class="hs-pragma">#-}</span><span>
</span><span id="line-1314"></span><span>
</span><span id="line-1315"></span><span class="hs-comment">-- | Transform a list of top-level value bindings. May produce new</span><span>
</span><span id="line-1316"></span><span class="hs-comment">-- lifted function definitions, which are placed in front of the</span><span>
</span><span id="line-1317"></span><span class="hs-comment">-- resulting list of declarations.</span><span>
</span><span id="line-1318"></span><span id="local-6989586621684525057"><span class="annot"><a href="Futhark.Internalise.Defunctionalise.html#transformProg"><span class="hs-identifier hs-type">transformProg</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Futhark.MonadFreshNames.html#MonadFreshNames"><span class="hs-identifier hs-type">MonadFreshNames</span></a></span><span> </span><span class="annot"><a href="#local-6989586621684525057"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#ValBind"><span class="hs-identifier hs-type">ValBind</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621684525057"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="Language.Futhark.html#ValBind"><span class="hs-identifier hs-type">ValBind</span></a></span><span class="hs-special">]</span></span><span>
</span><span id="line-1319"></span><span id="transformProg"><span class="annot"><span class="annottext">transformProg :: forall (m :: * -&gt; *). MonadFreshNames m =&gt; [ValBind] -&gt; m [ValBind]
</span><a href="Futhark.Internalise.Defunctionalise.html#transformProg"><span class="hs-identifier hs-var hs-var">transformProg</span></a></span></span><span> </span><span id="local-6989586621684522836"><span class="annot"><span class="annottext">[ValBind]
</span><a href="#local-6989586621684522836"><span class="hs-identifier hs-var">decs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(VNameSource -&gt; ([ValBind], VNameSource)) -&gt; m [ValBind]
forall (m :: * -&gt; *) a.
MonadFreshNames m =&gt;
(VNameSource -&gt; (a, VNameSource)) -&gt; m a
</span><a href="Futhark.MonadFreshNames.html#modifyNameSource"><span class="hs-identifier hs-var">modifyNameSource</span></a></span><span> </span><span class="annot"><span class="annottext">((VNameSource -&gt; ([ValBind], VNameSource)) -&gt; m [ValBind])
-&gt; (VNameSource -&gt; ([ValBind], VNameSource)) -&gt; m [ValBind]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621684522834"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684522834"><span class="hs-identifier hs-var">namesrc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-1320"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522833"><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684522833"><span class="hs-identifier hs-var">namesrc'</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621684522832"><span class="annot"><span class="annottext">[ValBind]
</span><a href="#local-6989586621684522832"><span class="hs-identifier hs-var">decs'</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">VNameSource -&gt; DefM () -&gt; ((), VNameSource, [ValBind])
forall a. VNameSource -&gt; DefM a -&gt; (a, VNameSource, [ValBind])
</span><a href="Futhark.Internalise.Defunctionalise.html#runDefM"><span class="hs-identifier hs-var">runDefM</span></a></span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684522834"><span class="hs-identifier hs-var">namesrc</span></a></span><span> </span><span class="annot"><span class="annottext">(DefM () -&gt; ((), VNameSource, [ValBind]))
-&gt; DefM () -&gt; ((), VNameSource, [ValBind])
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[ValBind] -&gt; DefM ()
</span><a href="Futhark.Internalise.Defunctionalise.html#defuncVals"><span class="hs-identifier hs-var">defuncVals</span></a></span><span> </span><span class="annot"><span class="annottext">[ValBind]
</span><a href="#local-6989586621684522836"><span class="hs-identifier hs-var">decs</span></a></span><span>
</span><span id="line-1321"></span><span>   </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[ValBind]
</span><a href="#local-6989586621684522832"><span class="hs-identifier hs-var">decs'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">VNameSource
</span><a href="#local-6989586621684522833"><span class="hs-identifier hs-var">namesrc'</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-1322"></span></pre></body></html>